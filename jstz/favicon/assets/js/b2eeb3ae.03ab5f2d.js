"use strict";(self.webpackChunkjstz_docs=self.webpackChunkjstz_docs||[]).push([[130],{1148:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>a,default:()=>d,frontMatter:()=>c,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"functions/requests","title":"Handling requests","description":"Jstz smart functions accept requests from smart functions and clients via their handler function, which they must export as their default function.","source":"@site/functions/requests.md","sourceDirName":"functions","slug":"/functions/requests","permalink":"/previews/jstz/favicon/functions/requests","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Handling requests"},"sidebar":"documentationSidebar","previous":{"title":"Deploying","permalink":"/previews/jstz/favicon/functions/deploying"},"next":{"title":"Storing data","permalink":"/previews/jstz/favicon/functions/data_storage"}}');var r=s(4848),o=s(3023);const c={title:"Handling requests"},a=void 0,i={},l=[{value:"Requests",id:"requests",level:2},{value:"Responses",id:"responses",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["Jstz smart functions accept requests from smart functions and clients via their ",(0,r.jsx)(n.code,{children:"handler"})," function, which they must export as their default function.\nSmart functions can have only this single entrypoint.\nThis function receives a Jstz ",(0,r.jsx)(n.a,{href:"/api/request",children:(0,r.jsx)(n.code,{children:"Request"})})," object and must return a promise that resolves to a Jstz ",(0,r.jsx)(n.a,{href:"/api/response",children:(0,r.jsx)(n.code,{children:"Response"})})," object."]}),"\n",(0,r.jsxs)(n.p,{children:["For an example of a ",(0,r.jsx)(n.code,{children:"handler"})," function, see ",(0,r.jsx)(n.a,{href:"/functions/overview",children:"Smart functions"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"requests",children:"Requests"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.a,{href:"/api/request",children:(0,r.jsx)(n.code,{children:"Request"})})," object is the only information that the smart function receives from the caller.\nIt can branch and respond to this data in any way.\nThe ",(0,r.jsx)(n.code,{children:"Request"})," object includes this data:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The data payload of the request as a JSON object, in the ",(0,r.jsx)(n.code,{children:"request.json()"})," promise"]}),"\n",(0,r.jsxs)(n.li,{children:["The address of the account that sent the request (which can be a ",(0,r.jsx)(n.code,{children:"tz1"})," user account of a ",(0,r.jsx)(n.code,{children:"KT1"})," smart function), in the ",(0,r.jsx)(n.code,{children:"Referer"})," header"]}),"\n",(0,r.jsxs)(n.li,{children:["The URL called, in the ",(0,r.jsx)(n.code,{children:"request.url"})," property"]}),"\n",(0,r.jsxs)(n.li,{children:["The HTTP method of the request, in the ",(0,r.jsx)(n.code,{children:"request.method"})," property"]}),"\n",(0,r.jsxs)(n.li,{children:["The query parameters from the URL, in the ",(0,r.jsx)(n.code,{children:"url.searchParams"})," object"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For example, this code prints the information from the ",(0,r.jsx)(n.code,{children:"Request"})," object:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'const handler = async (request: Request): Promise<Response> => {\n  const requestBody = await request.json();\n  console.log(JSON.stringify(requestBody, null, 2));\n\n  console.log("Caller:", request.headers.get("Referer") as Address);\n\n  const url = new URL(request.url);\n  console.log("Full URL:", url.toString());\n  console.log("URL path:", url.pathname);\n  console.log("Method:", JSON.stringify(request.method));\n  url.searchParams.forEach((value, key) =>\n    console.log(`Query param: ${value}: ${key}`),\n  );\n  // ...\n};\n'})}),"\n",(0,r.jsxs)(n.p,{children:["You can branch the code of the smart function based on any of this information.\nFor example, you can parse the URL that the request went to and allow callers to call different URLs as though they were API endpoints.\nFor example, this code parses the URL and does different things based on whether the request came to the URL ",(0,r.jsx)(n.code,{children:"jstz://<ADDRESS>/ping"})," or ",(0,r.jsx)(n.code,{children:"jstz://<ADDRESS>/marco"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'const handler = async (request: Request): Promise<Response> => {\n  const url = new URL(request.url);\n  const path = url.pathname.toLowerCase();\n  console.log(path);\n\n  switch (path) {\n    case "/ping":\n      return new Response("Pong");\n      break;\n\n    case "/marco":\n      return new Response("Polo");\n      break;\n\n    default:\n      return new Response("Default", {\n        headers: {\n          "Content-Type": "text/utf-8",\n        },\n      });\n      break;\n  }\n};\n\nexport default handler;\n'})}),"\n",(0,r.jsxs)(n.p,{children:["For more information, see the reference for the Jstz ",(0,r.jsx)(n.a,{href:"/api/request",children:(0,r.jsx)(n.code,{children:"Request"})})," object."]}),"\n",(0,r.jsx)(n.h2,{id:"responses",children:"Responses"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"handler"})," function must return a promise that resolves to a Jstz ",(0,r.jsx)(n.a,{href:"/api/response",children:(0,r.jsx)(n.code,{children:"Response"})})," object."]}),"\n",(0,r.jsx)(n.p,{children:"You can create the response object by passing a value and content type to its constructor, as in this example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'function handler(): Response {\n  return new Response("Hello world! \ud83d\udc4b", {\n    headers: {\n      "Content-Type": "text/utf-8",\n    },\n  });\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["If you want to return a JSON object, you can use the ",(0,r.jsx)(n.code,{children:"Response.json()"})," static method, as in this example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'function handler(): Response {\n  return Response.json({ message: "Hello world! \ud83d\udc4b" });\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Similarly, to return a error, use the ",(0,r.jsx)(n.code,{children:"Response.error()"})," static method, which takes no parameters:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function handler(): Response {\n  return Response.error();\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["As described in ",(0,r.jsx)(n.a,{href:"/functions/calling",children:"Calling other smart functions"}),", returning an error reverts all calls in the chain and any changes to smart function storage that the calls caused."]})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},3023:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>a});var t=s(6540);const r={},o=t.createContext(r);function c(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);