"use strict";(self.webpackChunketherlink_docs=self.webpackChunketherlink_docs||[]).push([[73904],{73904:(e,t,i)=>{i.r(t),i.d(t,{InAppWebConnector:()=>P});var a=i(88615),r=i(70211),s=i(16945),n=i(24114),o=i(25108);function l(e){return new Promise((t=>{setTimeout(t,1e3*e)}))}const c={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},d=new Map;class h{constructor({link:e,baseUrl:t,iframeId:i,container:a=document.body,onIframeInitialize:r}){Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.iframeBaseUrl=t;let s=document.getElementById(i);const n=new URL(e);if(!s||s.src!==n.href){s=document.createElement("iframe");const e={...c};Object.assign(s.style,e),s.setAttribute("id",i),s.setAttribute("fetchpriority","high"),a.appendChild(s),s.src=n.href;const t=e=>{if("ewsIframeLoaded"===e.data.eventType){if(window.removeEventListener("message",t),!s)return void o.warn("thirdweb iFrame not found");this.onIframeLoadHandler(s,r)()}};window.addEventListener("message",t)}this.iframe=s}async onIframeLoadedInitVariables(){return{}}onIframeLoadHandler(e,t){return async()=>{const i=new MessageChannel,a=new Promise(((a,r)=>{i.port1.onmessage=s=>{const{data:n}=s;i.port1.close(),n.success||r(new Error(n.error)),d.set(e.src,!0),t&&t(),a(!0)}}));e?.contentWindow?.postMessage({eventType:"initIframe",data:await this.onIframeLoadedInitVariables()},this.iframeBaseUrl,[i.port2]),await a}}async call({procedureName:e,params:t,showIframe:i=!1}){for(;!d.get(this.iframe.src);)await l(this.POLLING_INTERVAL_SECONDS);i&&(this.iframe.style.display="block",await l(.005));const a=new MessageChannel,r=new Promise(((e,t)=>{a.port1.onmessage=async r=>{const{data:s}=r;a.port1.close(),i&&(await l(.1),this.iframe.style.display="none"),s.success?e(s.data):t(new Error(s.error))}}));return this.iframe.contentWindow?.postMessage({eventType:e,data:t},this.iframeBaseUrl,[a.port2]),r}destroy(){d.delete(this.iframe.src)}}class u extends h{constructor({clientId:e,baseUrl:t,ecosystem:i}){super({iframeId:m+(i?.id||""),link:p({clientId:e,path:s.hD,ecosystem:i,baseUrl:t}).href,baseUrl:t,container:document.body}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.clientId=e,this.ecosystem=i}async onIframeLoadedInitVariables(){const e=new n.m({clientId:this.clientId,ecosystemId:this.ecosystem?.id});return{authCookie:await e.getAuthCookie(),deviceShareStored:await e.getDeviceShare(),walletUserId:await e.getWalletUserId(),clientId:this.clientId,partnerId:this.ecosystem?.partnerId,ecosystemId:this.ecosystem?.id}}}function p({clientId:e,baseUrl:t,path:i,ecosystem:a,queryParams:r}){const s=new URL(`${i}`,t);if(r)for(const n of Object.keys(r))s.searchParams.set(n,r[n]?.toString()||"");return s.searchParams.set("clientId",e),void 0!==a?.partnerId&&s.searchParams.set("partnerId",a.partnerId),void 0!==a?.id&&s.searchParams.set("ecosystemId",a.id),s}const m="thirdweb-in-app-wallet-iframe";class g{constructor({baseUrl:e,querier:t,preLogin:i,postLogin:a,client:r,ecosystem:s}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=i,this.postLogin=a,this.client=r,this.ecosystem=s}async sendEmailLoginOtp({email:e}){await this.preLogin();return await this.LoginQuerier.call({procedureName:"sendThirdwebEmailLoginOtp",params:{email:e}})}async sendSmsLoginOtp({phoneNumber:e}){await this.preLogin();return await this.LoginQuerier.call({procedureName:"sendThirdwebSmsLoginOtp",params:{phoneNumber:e}})}}var w=i(25108);class y extends g{constructor(){super(...arguments),Object.defineProperty(this,"closeWindow",{enumerable:!0,configurable:!0,writable:!0,value:({isWindowOpenedByFn:e,win:t,closeOpenedWindow:i})=>{e?t?.close():t&&i?i(t):t&&t.close()}})}async getOauthLoginUrl(e){try{return await this.LoginQuerier.call({procedureName:"getHeadlessOauthLoginLink",params:{authProvider:e}})}catch(t){throw w.error(t),t}}async loginWithModal(){await this.preLogin();const e=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:void 0,showIframe:!0});return this.postLogin(e)}async loginWithEmailOtp({email:e}){await this.preLogin();const t=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:{email:e},showIframe:!0});return this.postLogin(t)}getOauthPopUpSizing(e){return e===r.Ho.FACEBOOK?"width=715, height=555":"width=350, height=500"}async loginWithOauth(e){let t=e?.openedWindow,i=!1;if(t||(t=window.open("","Login",this.getOauthPopUpSizing(e.oauthProvider)),i=!0),!t)throw new Error("Something went wrong opening pop-up");const[{loginLink:a}]=await Promise.all([this.getOauthLoginUrl(e.oauthProvider),this.preLogin()]);t.location.href=a;const r=await new Promise(((a,r)=>{const s=window.setInterval((async()=>{t&&t.closed&&(clearInterval(s),window.removeEventListener("message",n),r(new Error("User closed login window")))}),1e3),n=async o=>{if(o.origin===this.baseUrl)if("object"==typeof o.data)switch(o.data.eventType){case"userLoginSuccess":window.removeEventListener("message",n),clearInterval(s),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),o.data.authResult&&a(o.data.authResult);break;case"userLoginFailed":window.removeEventListener("message",n),clearInterval(s),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),r(new Error(o.data.error));break;case"injectDeveloperClientId":t?.postMessage({eventType:"injectDeveloperClientIdResult",developerClientId:this.client.clientId,authOption:e.oauthProvider,partnerId:this.ecosystem?.partnerId,ecosystemId:this.ecosystem?.id},this.baseUrl)}else r(new Error("Invalid event data"))};window.addEventListener("message",n)}));return this.postLogin({storedToken:{...r.storedToken,shouldStoreCookieString:!0},walletDetails:{...r.walletDetails,isIframeStorageEnabled:!1}})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){await this.preLogin();const i=await this.LoginQuerier.call({procedureName:"loginWithCustomJwt",params:{encryptionKey:e,jwt:t}});return this.postLogin(i)}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){await this.preLogin();const i=await this.LoginQuerier.call({procedureName:"loginWithCustomAuthEndpoint",params:{encryptionKey:e,payload:t}});return this.postLogin(i)}async verifyEmailLoginOtp({email:e,otp:t,recoveryCode:i}){const a=await this.LoginQuerier.call({procedureName:"verifyThirdwebEmailLoginOtp",params:{email:e,otp:t,recoveryCode:i}});return this.postLogin(a)}async verifySmsLoginOtp({phoneNumber:e,otp:t,recoveryCode:i}){const a=await this.LoginQuerier.call({procedureName:"verifyThirdwebSmsLoginOtp",params:{phoneNumber:e,otp:t,recoveryCode:i}});return this.postLogin(a)}}class b{constructor({client:e,querier:t,onAuthSuccess:i,ecosystem:a,baseUrl:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.AuthQuerier=t,this.localStorage=new n.m({clientId:e.clientId,ecosystemId:a?.id}),this.onAuthSuccess=i,this.BaseLogin=new y({postLogin:async e=>this.postLogin(e),preLogin:async()=>{await this.preLogin()},ecosystem:a,querier:t,client:e,baseUrl:r})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString);return await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithAuthToken(e,t){await this.preLogin();const i=await this.AuthQuerier.call({procedureName:"loginWithStoredTokenDetails",params:{storedToken:e.storedToken,recoveryCode:t}});return this.postLogin(i)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async loginWithEmailOtp(e){return this.BaseLogin.loginWithEmailOtp(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async loginWithOauth(e){return this.BaseLogin.loginWithOauth(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async verifyEmailLoginOtp(e){return this.BaseLogin.verifyEmailLoginOtp(e)}async verifySmsLoginOtp(e){return this.BaseLogin.verifySmsLoginOtp(e)}async logout(){const{success:e}=await this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=await this.localStorage.removeAuthCookie(),i=await this.localStorage.removeWalletUserId();return{success:e||t||i}}}var f=i(59416),I=i(38642),L=i(95810);var v=i(98511),O=i(4159),E=i(75403),W=i(26485);class S{constructor({client:e,ecosystem:t,querier:i}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.walletManagerQuerier=i,this.localStorage=new n.m({clientId:e.clientId,ecosystemId:t?.id})}async postWalletSetUp({deviceShareStored:e,walletAddress:t,isIframeStorageEnabled:i,walletUserId:a}){return i||await this.localStorage.saveDeviceShare(e,a),{walletAddress:t}}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status===r.Nx.LOGGED_IN_WALLET_INITIALIZED?{status:r.Nx.LOGGED_IN_WALLET_INITIALIZED,...e.user,account:await this.getAccount()}:e.status===r.Nx.LOGGED_IN_NEW_DEVICE||e.status===r.Nx.LOGGED_IN_WALLET_UNINITIALIZED?{status:r.Nx.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:{status:e.status}}async getAccount(){const e=this.walletManagerQuerier,t=this.client,i=this.ecosystem?.partnerId,r=!!this.ecosystem,s=this.ecosystem?.partnerId?await(async(e,t)=>{const i=await fetch(`${(0,a.TS)("inAppWallet")}/api/2024-05-05/ecosystem-wallet/${e}/partner/${t}`,{headers:{"x-ecosystem-id":e,"x-ecosystem-partner-id":t||""}});return await i.json()})(this.ecosystem.id,this.ecosystem?.partnerId):void 0,{address:n}=await e.call({procedureName:"getAddress",params:void 0}),o=async t=>{const n={to:t.to??void 0,data:t.data,value:t.value,gasLimit:t.gas,nonce:t.nonce,chainId:t.chainId};t.maxFeePerGas?(n.accessList=t.accessList,n.maxFeePerGas=t.maxFeePerGas,n.maxPriorityFeePerGas=t.maxPriorityFeePerGas,n.type=2):(n.gasPrice=t.gasPrice,n.type=0);const o=(0,a.gc)().rpc,{signedTransaction:l}=await e.call({procedureName:"signTransaction",params:{transaction:n,chainId:t.chainId,partnerId:i,rpcEndpoint:`https://${t.chainId}.${o}`},showIframe:!s?.permissions.includes("FULL_CONTROL_V1")&&r});return l};return{address:(0,O.Kn)(n),async signTransaction(e){if(!e.chainId)throw new Error("chainId required in tx to sign");return o({...e,chainId:e.chainId})},async sendTransaction(e){const i=(0,v.getRpcClient)({client:t,chain:(0,L.XY)(e.chainId)}),a=await o(e);return{transactionHash:await async function(e,t){return await e({method:"eth_sendRawTransaction",params:[t]})}(i,a)}},async signMessage({message:t}){const a="string"==typeof t?t:t.raw instanceof Uint8Array?t.raw:(0,E.rR)(t.raw),{signedMessage:n}=await e.call({procedureName:"signMessage",params:{message:a,partnerId:i,chainId:1},showIframe:!s?.permissions.includes("FULL_CONTROL_V1")&&r});return n},async signTypedData(t){const n=(0,W.t)(t);n.types?.EIP712Domain&&(n.types.EIP712Domain=void 0);const o=n.domain,l=o?.chainId,c={verifyingContract:o?.verifyingContract,name:o?.name,version:o?.version};l&&(c.chainId=l);const d=(0,a.gc)().rpc,{signedTypedData:h}=await e.call({procedureName:"signTypedDataV4",params:{domain:c,types:n.types,message:n.message,chainId:l||1,partnerId:i,rpcEndpoint:`https://${l}.${d}`},showIframe:!s?.permissions.includes("FULL_CONTROL_V1")&&r});return h}}}}class P{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&36===e.length}constructor({client:e,onAuthSuccess:t,ecosystem:i}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const s=(0,a.TS)("inAppWallet");this.client=e,this.querier=new u({clientId:e.clientId,ecosystem:i,baseUrl:s}),this.wallet=new S({client:e,ecosystem:i,querier:this.querier}),this.auth=new b({client:e,querier:this.querier,baseUrl:s,ecosystem:i,onAuthSuccess:async e=>(t?.(e),await this.wallet.postWalletSetUp({...e.walletDetails,walletUserId:e.storedToken.authDetails.userWalletId}),await this.querier.call({procedureName:"initIframe",params:{partnerId:i?.partnerId,ecosystemId:i?.id,deviceShareStored:e.walletDetails.deviceShareStored,clientId:this.client.clientId,walletUserId:e.storedToken.authDetails.userWalletId,authCookie:e.storedToken.cookieString}}),{user:{status:r.Nx.LOGGED_IN_WALLET_INITIALIZED,authDetails:e.storedToken.authDetails,account:await this.wallet.getAccount(),walletAddress:e.walletDetails.walletAddress}})})}async getUser(){return this.wallet.getUserWalletStatus()}getAccount(){return this.wallet.getAccount()}async preAuthenticate(e){const t=e.strategy;switch(t){case"email":return this.auth.sendEmailLoginOtp({email:e.email});case"phone":return this.auth.sendSmsLoginOtp({phoneNumber:e.phoneNumber});default:N(t,`Provider: ${t} doesn't require pre-authentication`)}}authenticateWithRedirect(e){(0,f.Z)({authOption:e,client:this.wallet.client,ecosystem:this.wallet.ecosystem})}async loginWithAuthToken(e){return this.auth.loginWithAuthToken(e)}async authenticate(e){const t=e.strategy;switch(t){case"email":return await this.auth.verifyEmailLoginOtp({email:e.email,otp:e.verificationCode});case"phone":return await this.auth.verifySmsLoginOtp({otp:e.verificationCode,phoneNumber:e.phoneNumber});case"jwt":return this.auth.loginWithCustomJwt({jwt:e.jwt,encryptionKey:e.encryptionKey});case"auth_endpoint":return this.auth.loginWithCustomAuthEndpoint({payload:e.payload,encryptionKey:e.encryptionKey});case"iframe_email_verification":return this.auth.loginWithEmailOtp({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{if("sign-up"===e.type){const t=await(0,I.XP)({client:this.wallet.client,ecosystem:this.wallet.ecosystem,authenticatorType:e.authenticatorType,username:e.passkeyName});return this.loginWithAuthToken(t)}const t=await(0,I.OF)({client:this.wallet.client,ecosystem:this.wallet.ecosystem,authenticatorType:e.authenticatorType});return this.loginWithAuthToken(t)}case"apple":case"facebook":case"google":case"farcaster":case"discord":{const i=await(0,f.f)({authOption:t,client:this.wallet.client,ecosystem:this.wallet.ecosystem,closeOpenedWindow:e.closeOpenedWindow,openedWindow:e.openedWindow});return this.loginWithAuthToken(i)}default:N(t)}}async logout(){return await this.auth.logout()}}function N(e,t){throw new Error(t??`Invalid param: ${e}`)}}}]);