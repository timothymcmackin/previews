
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Michelson: the language of Smart Contracts in Tezos &#8212; Octez &amp; Protocol products documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=5cf6b051" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=7a138600"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KT3Z3X4Y82"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'alpha/michelson';</script>
    <script src="../_static/js/custom.js?v=e7f469e6"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="On-chain Views" href="views.html" />
    <link rel="prev" title="Accounts and addresses" href="accounts.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="Octez & Protocol products documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.svg" class="logo__image only-dark" alt="Octez & Protocol products documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/tezos.html">Octez &amp; Protocol overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction/howtoget.html">Installing Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/cosign-verify.html">Verifying Octez Docker Images with Cosign</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/get_troubleshooting.html">Installation troubleshooting</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtouse.html">Getting started with Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtorun.html">Running Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/services.html">Setting up Octez Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/versioning.html">Octez &amp; Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/breaking_changes.html">BREAKING CHANGES</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez User manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-client.html">Setting up the client</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/client-configuration.html">Client Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/key-management.html">Key Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sandbox.html">Sandboxed mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/mockup.html">Mockup mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy.html">Proxy mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/light.html">Light mode</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-node.html">Setting up the node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/node-configuration.html">Node Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/multinetwork.html">Connecting to a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/history_modes.html">History modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/snapshots.html">Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy-server.html">Proxy server</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../user/node-monitoring.html">Monitoring an Octez Node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/openmetrics.html">Supported Open Metrics</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../user/teztale.html">Monitoring the consensus protocol</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../user/multisig.html">Built-in multisig contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/fa12.html">FA1.2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/logging.html">Logging features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/exits.html">Exit codes and signals</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez Reference manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../shell/the_big_picture.html">Octez Software Architecture</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/shell.html">The Octez Shell</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/validation.html">The validation subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/prevalidation.html">The Prevalidator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/storage.html">The storage layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/sync.html">Synchronisation heuristic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/p2p.html">The peer-to-peer layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/protocol_environment.html">Protocol Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/micheline.html">Micheline</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/data_availability_committees.html">Data Availability Committees</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/dal.html">Data Availability Layer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_overview.html">DAL overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_node.html">The DAL node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_bakers.html">Bakers &amp; the DAL</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/smart_rollup_node.html">Smart rollup node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/p2p_api.html">P2P message format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/rpc.html">Shell RPCs - Reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Protocol Reference Manuals</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../active/index.html">Paris Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../active/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../active/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_issuance.html">Adaptive Issuance and Staking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../active/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/rpc.html">Paris RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../quebeca/index.html">Quebeca Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../quebeca/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../quebeca/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quebeca/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quebeca/rpc.html">Quebeca RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Alpha Dev Protocol Reference</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active has-children"><a class="reference internal" href="protocol.html">Economic protocol features</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="rpc.html">Alpha RPCs - Reference</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tezos developer Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../developer/rpc.html">JSON/RPC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/errors.html">RPC Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/openapi.html">RPCs - OpenAPI reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in Octez releases</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../releases/releases.html">Release System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/version-20.html">Version 20.2</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../releases/history.html">Older Versions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-19.html">Version 19.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-18.html">Version 18.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-17.html">Version 17.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-16.html">Version 16.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-15.html">Version 15.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-14.html">Version 14.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-13.html">Version 13.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-12.html">Version 12.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-11.html">Version 11.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-10.html">Version 10.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-9.html">Version 9.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-8.html">Version 8.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-7.html">Version 7.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/january-2020.html">Mainnet January 2020</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/december-2019.html">Mainnet December 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/october-2019.html">Mainnet-Staging October 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/september-2019.html">Mainnet September 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/may-2019.html">Mainnet May 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/april-2019.html">Mainnet April 2019</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in protocol versions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../protocols/naming.html">Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/019_paris.html">Protocol Paris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/021_quebeca.html">Protocol Quebeca</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/alpha.html">Protocol Alpha</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../protocols/history.html">Older Protocols</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../protocols/018_oxford.html">Protocol Oxford</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/017_nairobi.html">Protocol Nairobi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/016_mumbai.html">Protocol Mumbai</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/015_lima.html">Protocol Lima</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/014_kathmandu.html">Protocol Kathmandu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/013_jakarta.html">Protocol Jakarta</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/012_ithaca.html">Protocol Ithaca</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/011_hangzhou.html">Protocol Hangzhou</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/010_granada.html">Protocol Granada</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/009_florence.html">Protocol Florence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/008_edo.html">Protocol Edo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/007_delphi.html">Protocol Delphi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/006_carthage.html">Protocol Carthage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/005_babylon.html">Protocol Babylon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/004_Pt24m4xi.html">Protocol Athens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/003_PsddFKi3.html">Protocol 003_PsddFKi3</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/contributing_index.html">How to contribute</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/contributing.html">How to contribute to Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/contributing-adding-a-new-opam-dependency.html">How to add or update opam dependencies</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merge_team.html">Octez Merge Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/guidelines.html">Documentation and coding guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/repository_scope.html">Scope of the Octez repository</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/programming.html">Programming tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/gadt.html">Generalized Algebraic Data Types (GADTs)</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/error_monad.html">The Error Monad</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p1_result.html">Part 1: <code class="docutils literal notranslate"><span class="pre">result</span></code>, Lwt, and Lwt-<code class="docutils literal notranslate"><span class="pre">result</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p2_tzresult.html">Part 2: <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> and Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p3_advanced.html">Part 3: Advanced topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p4_appendices.html">Part 4: Appendices</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/clic.html">The <code class="docutils literal notranslate"><span class="pre">clic</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/data_encoding.html">The <code class="docutils literal notranslate"><span class="pre">data_encoding</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/event_logging_framework.html">Using The Event Logging Framework</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/testing_index.html">Testing in Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/testing.html">Overview of Testing in Octez</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/ppx_expect.html">Ppx_expect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/tezt.html">Tezt: OCaml Tezos Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/long-tezts.html">Tezt: Long Tests and Performance Regression Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/alcotezt.html">Alcotezt: An Alcotest Compatibility Wrapper for Tezt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/unit_testing_legacy_code.html">Making legacy code unit-testable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/proposal_testing.html">How to Test a Protocol Proposal</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/maintaining.html">Maintaining</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/entering_alpha.html">How to start reading protocol Alpha</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/michelson_instructions.html">Adding a new instruction to Michelson language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/protocol_release_checklist.html">Protocol Release Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/howto-freeze-protocols.html">How to Freeze Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/protocol_environment_upgrade.html">Adding a new protocol environment</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Documenting</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/tools.html">Platform Development tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/profiling.html">Profiling the Octez node</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/snoop.html">Benchmarking with Snoop</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_arch.html">Architecture of <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_tutorial.html">Snoop usage tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_example.html">In-depth usage example: more control over your benchmark</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/tezos_micheline_rewriting.html">Rewriting Micheline with <code class="docutils literal notranslate"><span class="pre">tezos-micheline-rewriting</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_interpreter.html">Snoop and the Michelson Interpreter</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/time_measurement_ppx.html">Time measurement PPX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/python_environment.html">Python Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/pre_commit_hook.html">Pre-Commit Hook</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/encodings.html">Encodings</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/merkle-proof-encoding-formats.html">Merkle Proof Encoding Formats</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v1-tree32.html">V1 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v1-tree2.html">V1 for Tree2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v2-tree32.html">V2 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v2-tree2.html">V2 for Tree2</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api-inline.html">OCaml APIs - Reference</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-gitlab"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-gitlab"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos/-/issues/new?issue[title]=Issue%20on%20page%20%2Falpha/michelson.html&issue[description]=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Michelson: the language of Smart Contracts in Tezos</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#semantics-of-smart-contracts-and-transactions">Semantics of smart contracts and transactions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smart-contract-call-semantics">Smart contract call semantics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transaction-semantics">Transaction semantics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#failures">Failures</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#language-semantics">Language semantics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rules-form-and-selection">Rules form and selection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-rules-big-step-form">Recursive rules (big step form)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format-of-patterns">Format of patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shortcuts">Shortcuts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-the-type-system-and-notations">Introduction to the type system and notations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-notations">Type notations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#meta-type-variables">Meta type variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#typing-rules">Typing rules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-normalization">Type normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#side-note">Side note</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-and-instructions">Types and instructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removed-instructions-and-types">Removed instructions and types</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#macros">Macros</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare">Compare</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fail">Fail</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-macros">Assertion macros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntactic-conveniences">Syntactic Conveniences</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concrete-syntax">Concrete syntax</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#constants">Constants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#differences-with-the-formal-notation">Differences with the formal notation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-program-structure">Main program structure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#annotations">Annotations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-annotations">Type annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variable-annotations">Variable annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#field-and-constructor-annotations">Field and constructor annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax">Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotations-and-macros">Annotations and macros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-variable-and-field-annotations-inferring">Automatic variable and field annotations inferring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#special-annotations">Special annotations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#entrypoints">Entrypoints</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-and-calling-entrypoints">Defining and calling entrypoints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-default-entrypoint">The <code class="docutils literal notranslate"><span class="pre">default</span></code> entrypoint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calling-entrypoints-from-michelson">Calling entrypoints from Michelson</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#json-syntax">JSON syntax</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#development-tools">Development tools</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#emacs-mode">Emacs mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-toplevel">Interactive toplevel</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#empty-contract">Empty contract</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-contract-with-entrypoints">Example contract with entrypoints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-contract-with-recursive-lambda">Example contract with recursive lambda</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multisig-contract">Multisig contract</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#views">Views</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#full-grammar">Full grammar</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-implementation">Reference implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tzt-a-syntax-extension-for-writing-unit-tests">TZT, a Syntax extension for writing unit tests</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mandatory-primitives">Mandatory primitives</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-primitives">Optional primitives</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-concrete-stacks">Syntax of concrete stacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#omitting-parts-of-the-output">Omitting parts of the output</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-normalization">Output normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-errors">Syntax of errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-concrete-operations">Syntax of concrete operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-other-contracts-specifications">Syntax of other contracts specifications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-extra-big-maps-specifications">Syntax of extra big maps specifications</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="michelson-the-language-of-smart-contracts-in-tezos">
<h1>Michelson: the language of Smart Contracts in Tezos<a class="headerlink" href="#michelson-the-language-of-smart-contracts-in-tezos" title="Link to this heading">#</a></h1>
<p>This specification gives a detailed formal semantics of the Michelson
language and a short explanation of how smart contracts are executed
and interact in the blockchain.</p>
<p>The language is stack-based, with high level data types and primitives,
and strict static type checking. Its design cherry-picks traits from
several language families. Vigilant readers will notice direct
references to Forth, Scheme, ML and Cat.</p>
<p>A Michelson program is a series of instructions that are run in
sequence: each instruction receives as input the stack resulting from the
previous instruction, and rewrites it for the next one. The stack
contains both immediate values and heap allocated structures. All values
are immutable and garbage collected.</p>
<p>The types of the input and output stack are fixed and monomorphic,
and the program is typechecked before being introduced into the system.
No smart contract execution can fail because an instruction has been
executed on a stack of unexpected length or contents.</p>
<p>This specification gives the complete instruction set, type system and
semantics of the language. It is meant as a precise reference manual,
not an easy introduction. Even though, some examples are provided at
the end of the document and can be read first or at the same time as
the specification. The document also starts with a less formal
explanation of the context: how Michelson code interacts with the
blockchain.</p>
<section id="semantics-of-smart-contracts-and-transactions">
<span id="transaction-semantics-alpha"></span><h2>Semantics of smart contracts and transactions<a class="headerlink" href="#semantics-of-smart-contracts-and-transactions" title="Link to this heading">#</a></h2>
<p>The Tezos ledger currently has two types of accounts that can hold
tokens. Accounts can be used in transactions as senders, to send tokens,
or as destinations, to receive tokens.</p>
<ul class="simple">
<li><p>User account: non-programmable account whose address is
the public key hash, prefixed by <code class="docutils literal notranslate"><span class="pre">tz</span></code> and one digit.
User accounts are sometimes called implicit accounts.
A transaction to such an address cannot provide data, except <a class="reference internal" href="tickets.html"><span class="doc">tickets</span></a>.</p></li>
<li><p>Smart contract: programmable account associated to some Michelson code,
whose address is a unique hash, prefixed by <code class="docutils literal notranslate"><span class="pre">KT1</span></code>.
A transaction to such
an address can provide data, and can fail for reasons detailed below.
Smart contracts are sometimes called originated accounts.</p></li>
</ul>
<p>Finally, addresses prefixed with <code class="docutils literal notranslate"><span class="pre">sr1</span></code> identify <a class="reference internal" href="smart_rollups.html"><span class="doc">Smart Rollups</span></a>, which cannot hold tokens but can be the destination of transactions.</p>
<p>See <a class="reference internal" href="accounts.html"><span class="doc">Accounts and addresses</span></a> for more details.</p>
<section id="smart-contract-call-semantics">
<h3>Smart contract call semantics<a class="headerlink" href="#smart-contract-call-semantics" title="Link to this heading">#</a></h3>
<p>The only way to call a smart contract is to perform a transaction operation whose destination is the address of the smart contract.</p>
<p>Alongside their tokens, smart contracts keep a piece of storage. Both
are ruled by a specific logic specified by a Michelson program. A
transaction to a smart contract will provide an input value and in
option some tokens, and in return, the smart contract can modify its
storage and transfer its tokens.</p>
<p>The Michelson program receives as input a stack containing a single
pair whose first element is an input value and second element the
content of the storage space. It must return a stack containing a
single pair whose first element is the list of operations
that it wants to emit, and second element is the new contents of the
storage space. Alternatively, a Michelson program can fail, explicitly
using a specific opcode, or because something went wrong that could
not be caught by the type system (e.g. gas exhaustion).</p>
<p>A bit of polymorphism can be used at contract level, with a
lightweight system of named entrypoints: instead of an input value,
the contract can be called with an entrypoint name and an argument,
and these two components are transformed automatically in a simple and
deterministic way to an input value. This feature is available both
for users and from Michelson code. See the dedicated section.</p>
</section>
<section id="transaction-semantics">
<h3>Transaction semantics<a class="headerlink" href="#transaction-semantics" title="Link to this heading">#</a></h3>
<p>On one hand, a smart call may result from an external operation of kind Transaction.
External operations are <a class="reference internal" href="blocks_ops.html"><span class="doc">blockchain operations</span></a> included in a block, signed by a user account.</p>
<p>On the other hand, a smart contract call may be emitted as an internal operation of kind Transaction, either when executing another smart contract call or when <a class="reference internal" href="../shell/smart_rollup_node.html#triggering-execution-outbox-message"><span class="std std-ref">triggering the execution of an outbox message from a smart rollup</span></a>.</p>
<p>This section explains the whole semantics of an external transaction, including the execution of the smart contract called directly by it and the others smart contracts called indirectly via emitted internal operations.</p>
<p>The subset of blockchain operations that can be emitted by Michelson programs as internal operations are of the following kinds:</p>
<ul class="simple">
<li><p>Transaction transferring:</p>
<ul>
<li><p>tokens and optionally tickets to a user account, or</p></li>
<li><p>tokens and parameters to a smart contract (or, optionally, to a specified
entrypoint of a smart contract), or</p></li>
<li><p>parameters to a smart rollup.</p></li>
</ul>
</li>
<li><p>Origination creating a new smart contract from its Michelson
source code, an initial amount of tokens transferred from the
source, and an initial storage content.</p></li>
<li><p>Delegation assigning the tokens of the sender account to the stake of
a user account (without transferring any tokens).</p></li>
<li><p><a class="reference internal" href="event.html"><span class="doc">Contract event</span></a> delivering live information from a smart
contract to external applications.</p></li>
</ul>
<p>Internal operations are not included in any block, and are not signed.</p>
<p>Internal operations are run in an atomic sequence with the external operation who generated them, right after it, in depth-first order.</p>
<p>Note that <a class="reference internal" href="blocks_ops.html#manager-operations-batches-alpha"><span class="std std-ref">manager operations batches</span></a> contain a sequence of external operations signed as a whole by a source user account, which are executed atomically.
For example, in case of a batch of two external operations, execution proceeds as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------+----------------+-------+----------------+
| op 1 | internal ops 1 |  op 2 | internal ops 2 |
+------+----------------+-------+----------------+
</pre></div>
</div>
<p>Smart contracts called by internal operations can in turn also emit
internal operations. The interpreter
uses a stack of internal operations to perform them in depth-first order, as in the following more detailed
example, corresponding to the two external operations above.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+---------------+--------------------------+
| executing | emissions     | resulting stack          |
+-----------+---------------+--------------------------+
| op 1      | 1a, 1b, 1c    | 1a, 1b, 1c               |
| op 1a     | 1ai, 1aj      | 1ai, 1aj, 1b, 1c         |
| op 1ai    |               | 1aj, 1b, 1c              |
| op 1aj    |               | 1b, 1c                   |
| op 1b     | 1bi           | 1bi, 1c                  |
| op 1bi    |               | 1c                       |
| op 1c     |               |                          |
| op 2      | 2a, 2b        | 2a, 2b                   |
| op 2a     | 2ai           | 2ai, 2b                  |
| op 2ai    | 2ai1          | 2ai1, 2b                 |
| op 2ai1   |               | 2b                       |
| op 2b     | 2bi           | 2bi                      |
| op 2bi    | 2bi1          | 2bi1                     |
| op 2bi1   | 2bi2          | 2bi2                     |
| op 2bi2   |               |                          |
+-----------+---------------+--------------------------+
</pre></div>
</div>
</section>
<section id="failures">
<h3>Failures<a class="headerlink" href="#failures" title="Link to this heading">#</a></h3>
<p>All transactions can fail for a few reasons, mostly:</p>
<ul class="simple">
<li><p>Not enough tokens in the source to spend the specified amount.</p></li>
<li><p>The script took too many execution steps.</p></li>
<li><p>The script failed programmatically using the <code class="docutils literal notranslate"><span class="pre">FAILWITH</span></code> instruction.</p></li>
</ul>
<p>External transactions can also fail for these additional reasons:</p>
<ul class="simple">
<li><p>The signature of the external operations was wrong.</p></li>
<li><p>The code or initial storage in an origination did not typecheck.</p></li>
<li><p>The parameter in a transfer did not typecheck.</p></li>
<li><p>The destination did not exist.</p></li>
<li><p>The specified entrypoint did not exist.</p></li>
</ul>
<p>All these errors cannot happen in internal transactions, as the type
system catches them at operation creation time. In particular,
Michelson has two types to talk about other addresses: <code class="docutils literal notranslate"><span class="pre">address</span></code> and
<code class="docutils literal notranslate"><span class="pre">contract</span> <span class="pre">t</span></code>. The <code class="docutils literal notranslate"><span class="pre">address</span></code> type merely gives the guarantee that
the value has the form of a Tezos address. The <code class="docutils literal notranslate"><span class="pre">contract</span> <span class="pre">t</span></code> type, on
the other hand, guarantees that the address is indeed a valid destination of
transfers whose parameter type is <code class="docutils literal notranslate"><span class="pre">t</span></code>. To make a transaction from
Michelson, a value of type <code class="docutils literal notranslate"><span class="pre">contract</span> <span class="pre">t</span></code> must be provided, and the
type system checks that the argument to the transaction is indeed of
type <code class="docutils literal notranslate"><span class="pre">t</span></code>. Hence, all transactions made from Michelson are well
formed by construction.</p>
<p>In any case, when a failure happens, either total success or total
failure is guaranteed. If a transaction (internal or external) fails,
then the whole sequence fails and all the effects up to the failure
are reverted. These transactions can still be included in blocks, and
the transaction fees are given to the user account who baked the
block.</p>
</section>
</section>
<section id="language-semantics">
<h2>Language semantics<a class="headerlink" href="#language-semantics" title="Link to this heading">#</a></h2>
<p>This specification explains in a symbolic way the computation performed by the
Michelson interpreter on a given program and initial stack to produce
the corresponding resulting stack. The Michelson interpreter is a pure
function: it only builds a result stack from the elements of an initial
one, without affecting its environment. This semantics is then naturally
given in what is called a big step form: a symbolic definition of a
recursive reference interpreter. This definition takes the form of a
list of rules that cover all the possible inputs of the interpreter
(program and stack), and describe the computation of the corresponding
resulting stacks.</p>
<section id="rules-form-and-selection">
<h3>Rules form and selection<a class="headerlink" href="#rules-form-and-selection" title="Link to this heading">#</a></h3>
<p>The rules have the main following form.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; (syntax pattern) / (initial stack pattern)  =&gt;  (result stack pattern)
    iff (conditions)
    where (recursions)
    and (more recursions)
</pre></div>
</div>
<p>The left hand side of the <code class="docutils literal notranslate"><span class="pre">=&gt;</span></code> sign is used for selecting the rule.
Given a program and an initial stack, one (and only one) rule can be
selected using the following process. First, the toplevel structure of
the program must match the syntax pattern. This is quite simple since
there are only a few non-trivial patterns to deal with instruction
sequences, and the rest is made of trivial patterns that match one
specific instruction. Then, the initial stack must match the initial
stack pattern. Finally, some rules add extra conditions over the values
in the stack that follow the <code class="docutils literal notranslate"><span class="pre">iff</span></code> keyword. Sometimes, several rules
may apply in a given context. In this case, the one that appears first
in this specification is to be selected. If no rule applies, the result
is equivalent to the one for the explicit <code class="docutils literal notranslate"><span class="pre">FAILWITH</span></code> instruction. This
case does not happen on well-typed programs, as explained in the next
section.</p>
<p>The right hand side describes the result of the interpreter if the rule
applies. It consists in a stack pattern, whose parts are either
constants, or elements of the context (program and initial stack) that
have been named on the left hand side of the <code class="docutils literal notranslate"><span class="pre">=&gt;</span></code> sign.</p>
</section>
<section id="recursive-rules-big-step-form">
<h3>Recursive rules (big step form)<a class="headerlink" href="#recursive-rules-big-step-form" title="Link to this heading">#</a></h3>
<p>Sometimes, the result of interpreting a program is derived from the
result of interpreting another one (as in conditionals or function
calls). In these cases, the rule contains a clause of the following
form.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>where (intermediate program) / (intermediate stack)  =&gt;  (partial result)
</pre></div>
</div>
<p>This means that this rule applies in case interpreting the intermediate
state on the left gives the pattern on the right.</p>
<p>The left hand sign of the <code class="docutils literal notranslate"><span class="pre">=&gt;</span></code> sign is constructed from elements of
the initial state or other partial results, and the right hand side
identify parts that can be used to build the result stack of the rule.</p>
<p>If the partial result pattern does not actually match the result of the
interpretation, then the result of the whole rule is equivalent to the
one for the explicit <code class="docutils literal notranslate"><span class="pre">FAILWITH</span></code> instruction. Again, this case does not
happen on well-typed programs, as explained in the next section.</p>
</section>
<section id="format-of-patterns">
<h3>Format of patterns<a class="headerlink" href="#format-of-patterns" title="Link to this heading">#</a></h3>
<p>Code patterns are of one of the following syntactical forms.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">INSTR</span></code> (an uppercase identifier) is a simple instruction (e.g.
<code class="docutils literal notranslate"><span class="pre">DROP</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INSTR</span> <span class="pre">(arg)</span> <span class="pre">...</span></code> is a compound instruction, whose arguments can be
code, data or type patterns (e.g. <code class="docutils literal notranslate"><span class="pre">PUSH</span> <span class="pre">nat</span> <span class="pre">3</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">(instr)</span> <span class="pre">;</span> <span class="pre">...</span> <span class="pre">}</span></code> is a possibly empty sequence of instructions,
(e.g. <code class="docutils literal notranslate"><span class="pre">IF</span> <span class="pre">{</span> <span class="pre">SWAP</span> <span class="pre">;</span> <span class="pre">DROP</span> <span class="pre">}</span> <span class="pre">{</span> <span class="pre">DROP</span> <span class="pre">}</span></code>), nested sequences can drop the
braces.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> is a pattern that matches any program and names a part of
the matched program that can be used to build the result.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_</span></code> is a pattern that matches any instruction.</p></li>
</ul>
<p>Stack patterns are of one of the following syntactical forms.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[FAILED]</span></code> is the special failed state.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[]</span></code> is the empty stack.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(top)</span> <span class="pre">:</span> <span class="pre">(rest)</span></code> is a stack whose top element is matched by the
data pattern <code class="docutils literal notranslate"><span class="pre">(top)</span></code> on the left, and whose remaining elements are
matched by the stack pattern <code class="docutils literal notranslate"><span class="pre">(rest)</span></code> on the right (e.g.
<code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">:</span> <span class="pre">y</span> <span class="pre">:</span> <span class="pre">rest</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> is a pattern that matches any stack and names it in order to
use it to build the result.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_</span></code> is a pattern that matches any stack.</p></li>
</ul>
<p>Data patterns are of one of the following syntactical forms.</p>
<ul class="simple">
<li><p>integer/natural number literals, (e.g. <code class="docutils literal notranslate"><span class="pre">3</span></code>).</p></li>
<li><p>string literals, (e.g. <code class="docutils literal notranslate"><span class="pre">&quot;contents&quot;</span></code>).</p></li>
<li><p>raw byte sequence literals (e.g. <code class="docutils literal notranslate"><span class="pre">0xABCDEF42</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Tag</span></code> (capitalized) is a symbolic constant, (e.g. <code class="docutils literal notranslate"><span class="pre">Unit</span></code>,
<code class="docutils literal notranslate"><span class="pre">True</span></code>, <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(Tag</span> <span class="pre">(arg)</span> <span class="pre">...)</span></code> tagged constructed data, (e.g. <code class="docutils literal notranslate"><span class="pre">(Pair</span> <span class="pre">3</span> <span class="pre">4)</span></code>).</p></li>
<li><p>a code pattern for first class code values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> to name a value in order to use it to build the result.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_</span></code> to match any value.</p></li>
</ul>
<p>The domain of instruction names, symbolic constants and data
constructors is fixed by this specification. Michelson does not let the
programmer introduce its own types.</p>
<p>Be aware that the syntax used in the specification may differ from
the <a class="reference internal" href="#concretesyntax-alpha"><span class="std std-ref">concrete syntax</span></a>. In particular
some instructions are annotated with types that are not present in the
concrete language because they are synthesized by the typechecker.</p>
</section>
<section id="shortcuts">
<h3>Shortcuts<a class="headerlink" href="#shortcuts" title="Link to this heading">#</a></h3>
<p>Sometimes, it is easier to think (and shorter to write) in terms of
program rewriting than in terms of big step semantics. When it is the
case, and when both are equivalents, we write rules of the form:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>p / S  =&gt;  S&#39;&#39;
where   p&#39; / S&#39;  =&gt;  S&#39;&#39;
</pre></div>
</div>
<p>using the following shortcut:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>p / S  =&gt;  p&#39; / S&#39;
</pre></div>
</div>
<p>The concrete language also has some syntax sugar to group some common
sequences of operations as one. This is described in this specification
using a simple regular expression style recursive instruction rewriting.</p>
</section>
</section>
<section id="introduction-to-the-type-system-and-notations">
<span id="michelson-type-system-alpha"></span><h2>Introduction to the type system and notations<a class="headerlink" href="#introduction-to-the-type-system-and-notations" title="Link to this heading">#</a></h2>
<p>This specification describes a type system for Michelson. To make things
clear, in particular to readers that are not accustomed to reading
formal programming language specifications, it does not give a
typechecking or inference algorithm. It only gives an intentional
definition of what we consider to be well-typed programs. For each
syntactical form, it describes the stacks that are considered well-typed
inputs, and the resulting outputs.</p>
<p>The type system is sound, meaning that if a program can be given a type,
then if run on a well-typed input stack, the interpreter will never
apply an interpretation rule on a stack of unexpected length or
contents. Also, it will never reach a state where it cannot select an
appropriate rule to continue the execution. Well-typed programs do not
block, and do not go wrong.</p>
<section id="type-notations">
<h3>Type notations<a class="headerlink" href="#type-notations" title="Link to this heading">#</a></h3>
<p>The specification introduces notations for the types of values, terms
and stacks. Apart from a subset of value types that appear in the form
of type annotations in some places throughout the language, it is
important to understand that this type language only exists in the
specification.</p>
<p>A stack type can be written:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[]</span></code> for the empty stack.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(top)</span> <span class="pre">:</span> <span class="pre">(rest)</span></code> for the stack whose first value has type <code class="docutils literal notranslate"><span class="pre">(top)</span></code>
and queue has stack type <code class="docutils literal notranslate"><span class="pre">(rest)</span></code>.</p></li>
</ul>
<p>Instructions, programs and primitives of the language are also typed,
their types are written:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(type of stack before) -&gt; (type of stack after)
</pre></div>
</div>
<p>The types of values in the stack are written:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">identifier</span></code> for a primitive data-type (e.g. <code class="docutils literal notranslate"><span class="pre">bool</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">identifier</span> <span class="pre">(arg)</span></code> for a parametric data-type with one parameter
type <code class="docutils literal notranslate"><span class="pre">(arg)</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">list</span> <span class="pre">nat</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">identifier</span> <span class="pre">(arg)</span> <span class="pre">...</span></code> for a parametric data-type with several
parameters (e.g. <code class="docutils literal notranslate"><span class="pre">map</span> <span class="pre">string</span> <span class="pre">int</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[</span> <span class="pre">(type</span> <span class="pre">of</span> <span class="pre">stack</span> <span class="pre">before)</span> <span class="pre">-&gt;</span> <span class="pre">(type</span> <span class="pre">of</span> <span class="pre">stack</span> <span class="pre">after)</span> <span class="pre">]</span></code> for a code
quotation, (e.g. <code class="docutils literal notranslate"><span class="pre">[</span> <span class="pre">int</span> <span class="pre">:</span> <span class="pre">int</span> <span class="pre">:</span> <span class="pre">[]</span> <span class="pre">-&gt;</span> <span class="pre">int</span> <span class="pre">:</span> <span class="pre">[]</span> <span class="pre">]</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">(arg)</span> <span class="pre">(ret)</span></code> is a shortcut for
<code class="docutils literal notranslate"><span class="pre">[</span> <span class="pre">(arg)</span> <span class="pre">:</span> <span class="pre">[]</span> <span class="pre">-&gt;</span> <span class="pre">(ret)</span> <span class="pre">:</span> <span class="pre">[]</span> <span class="pre">]</span></code>.</p></li>
</ul>
</section>
<section id="meta-type-variables">
<h3>Meta type variables<a class="headerlink" href="#meta-type-variables" title="Link to this heading">#</a></h3>
<p>The typing rules introduce meta type variables. To be clear, this has
nothing to do with polymorphism, which Michelson does not have. These
variables only live at the specification level, and are used to express
the consistency between the parts of the program. For instance, the
typing rule for the <code class="docutils literal notranslate"><span class="pre">IF</span></code> construct introduces meta variables to
express that both branches must have the same type.</p>
<p>Here are the notations for meta type variables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'a</span></code> for a type variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'A</span></code> for a stack type variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_</span></code> for an anonymous type or stack type variable.</p></li>
</ul>
</section>
<section id="typing-rules">
<h3>Typing rules<a class="headerlink" href="#typing-rules" title="Link to this heading">#</a></h3>
<p>The system is syntax directed, meaning that it defines a single
typing rule for each syntax construct. A typing rule restricts the type
of input stacks that are authorized for this syntax construct, links the
output type to the input type, and links both of them to the
subexpressions when needed, using meta type variables.</p>
<p>Typing rules are of the form:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(syntax pattern)
:: (type of stack before) -&gt; (type of stack after) [rule-name]
   iff (premises)
</pre></div>
</div>
<p>Where premises are typing requirements over subprograms or values in the
stack, both of the form <code class="docutils literal notranslate"><span class="pre">(x)</span> <span class="pre">::</span> <span class="pre">(type)</span></code>, meaning that value <code class="docutils literal notranslate"><span class="pre">(x)</span></code>
must have type <code class="docutils literal notranslate"><span class="pre">(type)</span></code>.</p>
<p>A program is shown well-typed if one can find an instance of a rule that
applies to the toplevel program expression, with all meta type variables
replaced by non variable type expressions, and of which all type
requirements in the premises can be proven well-typed in the same
manner. For the reader unfamiliar with formal type systems, this is
called building a typing derivation.</p>
<p>Here is an example typing derivation on a small program that computes
<code class="docutils literal notranslate"><span class="pre">(x+5)*10</span></code> for a given input <code class="docutils literal notranslate"><span class="pre">x</span></code>, obtained by instantiating the
typing rules for instructions <code class="docutils literal notranslate"><span class="pre">PUSH</span></code>, <code class="docutils literal notranslate"><span class="pre">ADD</span></code> and for the sequence, as
found in the next sections. When instantiating, we replace the <code class="docutils literal notranslate"><span class="pre">iff</span></code>
with <code class="docutils literal notranslate"><span class="pre">by</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ PUSH nat 5 ; ADD ; PUSH nat 10 ; MUL }
:: [ nat : [] -&gt; nat : [] ]
   by { PUSH nat 5 ; ADD }
      :: [ nat : [] -&gt; nat : [] ]
         by PUSH nat 5
            :: [ nat : [] -&gt; nat : nat : [] ]
               by 5 :: nat
        and ADD
            :: [ nat : nat : [] -&gt; nat : [] ]
  and { PUSH nat 10 ; MUL }
      :: [ nat : [] -&gt; nat : [] ]
         by PUSH nat 10
            :: [ nat : [] -&gt; nat : nat : [] ]
               by 10 :: nat
        and MUL
            :: [ nat : nat : [] -&gt; nat : [] ]
</pre></div>
</div>
<p>Producing such a typing derivation can be done in a number of manners,
such as unification or abstract interpretation. In the implementation of
Michelson, this is done by performing a recursive symbolic evaluation of
the program on an abstract stack representing the input type provided by
the programmer, and checking that the resulting symbolic stack is
consistent with the expected result, also provided by the programmer.</p>
</section>
<section id="type-normalization">
<span id="type-normalization-alpha"></span><h3>Type normalization<a class="headerlink" href="#type-normalization" title="Link to this heading">#</a></h3>
<p>For convenience, Michelson developers can use some compact type notations for types that do not exist in the language implementation.
These are just shorthands that are expanded into existing types during the so-called “type normalization”.</p>
<p>Currently, the only such notation concerns N-ary pairs (also called tuples), which are expanded into “right combs”, that is, nested binary pairs with right associativity.
See <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#type-pair">type pair</a> for details.</p>
<p>The node RPC <code class="docutils literal notranslate"><span class="pre">/helpers/script/normalize_type</span></code> is available to normalize a given Michelson type (see <a class="reference internal" href="../api/openapi.html"><span class="doc">RPCs - OpenAPI reference</span></a>, within the protocol-dependent RPCs).
This RPC is intended for tool developers wanting to support the type shorthands in their tools without reimplementing their normalization.
However, one side effect of this RPC is the stripping of <a class="reference internal" href="#annotations-alpha"><span class="std std-ref">annotations</span></a>.
As a consequence, a tool needing to preserve annotations on shorthand data types should implement its own type normalization instead of relying on this RPC.</p>
</section>
<section id="side-note">
<h3>Side note<a class="headerlink" href="#side-note" title="Link to this heading">#</a></h3>
<p>As with most type systems, it is incomplete. There are programs that
cannot be given a type in this type system, yet that would not go wrong
if executed. This is a necessary compromise to make the type system
usable. Also, it is important to remember that the implementation of
Michelson does not accept as many programs as the type system describes
as well-typed. This is because the implementation uses a simple single
pass typechecking algorithm, and does not handle any form of
polymorphism.</p>
</section>
</section>
<section id="types-and-instructions">
<h2>Types and instructions<a class="headerlink" href="#types-and-instructions" title="Link to this heading">#</a></h2>
<p>The complete sets of Michelson types and instructions are detailed in the
<a class="reference external" href="https://tezos.gitlab.io/michelson-reference/">interactive Michelson reference page</a>.</p>
<ul class="simple">
<li><p>Specifically, it contains synthesis tables for <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#types">types</a>
and for <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instructions">instructions</a>.</p></li>
<li><p>Instructions are also organized by <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instructions-by-category">categories</a>.</p></li>
<li><p>Each instruction is precisely defined using typing and semantic inference rules.</p></li>
</ul>
</section>
<section id="removed-instructions-and-types">
<h2>Removed instructions and types<a class="headerlink" href="#removed-instructions-and-types" title="Link to this heading">#</a></h2>
<p><a class="reference internal" href="../protocols/005_babylon.html"><span class="doc">Protocol Babylon</span></a> deprecated the following instructions. Because no smart
contract used these on Mainnet before they got deprecated, they have been
removed. The Michelson type-checker will reject any contract using them.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CREATE_CONTRACT</span> <span class="pre">{</span> <span class="pre">parameter</span> <span class="pre">'p</span> <span class="pre">;</span> <span class="pre">storage</span> <span class="pre">'g</span> <span class="pre">;</span> <span class="pre">code</span> <span class="pre">...</span> <span class="pre">}</span></code>:
Forge a new contract from a literal.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Γ ⊢ CREATE_CONTRACT { parameter &#39;p ; storage &#39;g ; code ... }
:: key_hash : option key_hash : bool : bool : mutez : &#39;g : &#39;S
⇒ operation : address : &#39;S
</pre></div>
</div>
<p>There is a new version of this instruction, see its <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-CREATE_CONTRACT">documentation</a>.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">CREATE_ACCOUNT</span></code>: Forge an account creation operation.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Γ ⊢ CREATE_ACCOUNT :: key_hash : option key_hash : bool : mutez : &#39;S
⇒ operation : address : &#39;S
</pre></div>
</div>
<p>Takes as argument the manager, optional delegate, the delegatable flag
and finally the initial amount taken from the currently executed
contract. This instruction originates a contract with two entrypoints;
<code class="docutils literal notranslate"><span class="pre">%default</span></code> of type <code class="docutils literal notranslate"><span class="pre">unit</span></code> that does nothing and <code class="docutils literal notranslate"><span class="pre">%do</span></code> of type
<code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">unit</span> <span class="pre">(list</span> <span class="pre">operation)</span></code> that executes and returns the
parameter if the sender is the contract’s manager.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">STEPS_TO_QUOTA</span></code>: Push the remaining steps before the contract
execution must terminate.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Γ ⊢ STEPS_TO_QUOTA :: &#39;S ⇒ nat : &#39;S
</pre></div>
</div>
</li>
</ul>
<p><a class="reference internal" href="../protocols/016_mumbai.html"><span class="doc">Protocol Mumbai</span></a> deprecated the following
type. Because no smart contract used it on Mainnet before it got
deprecated, it has been removed. The Michelson type-checker will
reject any contract using it.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tx_rollup_l2_address</span></code>: An address used to identify an account in
a transaction rollup ledger. It is the hash of a BLS public key,
used to authenticate layer-2 operations to transfer tickets from
this account.</p></li>
</ul>
</section>
<section id="macros">
<h2>Macros<a class="headerlink" href="#macros" title="Link to this heading">#</a></h2>
<p>In addition to the instructions listed in the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/">interactive Michelson reference manual</a>,
several extensions have been added to the language’s concrete syntax. If you are
interacting with the node via RPC, bypassing the client, which expands away
these macros, you will need to desugar them yourself.</p>
<p>These macros are designed to be unambiguous and reversible, meaning that
errors are reported in terms of desugared syntax. Below you’ll see
these macros defined in terms of other syntactic forms. That is how
these macros are seen by the node.</p>
<section id="compare">
<h3>Compare<a class="headerlink" href="#compare" title="Link to this heading">#</a></h3>
<p>Syntactic sugar exists for merging <code class="docutils literal notranslate"><span class="pre">COMPARE</span></code> and comparison
combinators, and also for branching.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CMP{EQ|NEQ|LT|GT|LE|GE}</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; CMP(\op) / S  =&gt;  COMPARE ; (\op) / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IF{EQ|NEQ|LT|GT|LE|GE}</span> <span class="pre">bt</span> <span class="pre">bf</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; IF(\op) bt bf / S  =&gt;  (\op) ; IF bt bf / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IFCMP{EQ|NEQ|LT|GT|LE|GE}</span> <span class="pre">bt</span> <span class="pre">bf</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; IFCMP(\op) / S  =&gt;  COMPARE ; (\op) ; IF bt bf / S
</pre></div>
</div>
</section>
<section id="fail">
<h3>Fail<a class="headerlink" href="#fail" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">FAIL</span></code> macros is equivalent to <code class="docutils literal notranslate"><span class="pre">UNIT;</span> <span class="pre">FAILWITH</span></code> and is callable
in any context since it does not use its input stack.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FAIL</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; FAIL / S  =&gt;  UNIT; FAILWITH / S
</pre></div>
</div>
</section>
<section id="assertion-macros">
<h3>Assertion macros<a class="headerlink" href="#assertion-macros" title="Link to this heading">#</a></h3>
<p>All assertion operations are syntactic sugar for conditionals with a
<code class="docutils literal notranslate"><span class="pre">FAIL</span></code> instruction in the appropriate branch. When possible, use them
to increase clarity about illegal states.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ASSERT</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; ASSERT  =&gt;  IF {} {FAIL}
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ASSERT_{EQ|NEQ|LT|LE|GT|GE}</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; ASSERT_(\op)  =&gt;  IF(\op) {} {FAIL}
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ASSERT_CMP{EQ|NEQ|LT|LE|GT|GE}</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; ASSERT_CMP(\op)  =&gt;  IFCMP(\op) {} {FAIL}
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ASSERT_NONE</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; ASSERT_NONE  =&gt;  IF_NONE {} {FAIL}
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ASSERT_SOME</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; ASSERT_SOME @x =&gt;  IF_NONE {FAIL} {RENAME @x}
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ASSERT_LEFT</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; ASSERT_LEFT @x =&gt;  IF_LEFT {RENAME @x} {FAIL}
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ASSERT_RIGHT</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; ASSERT_RIGHT @x =&gt;  IF_LEFT {FAIL} {RENAME @x}
</pre></div>
</div>
</section>
<section id="syntactic-conveniences">
<h3>Syntactic Conveniences<a class="headerlink" href="#syntactic-conveniences" title="Link to this heading">#</a></h3>
<p>These macros are simply more convenient syntax for various common
operations.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">P(\left=A|P(\left)(\right))(\right=I|P(\left)(\right))R</span></code>: A syntactic sugar
for building nested pairs. In the case of right combs, <code class="docutils literal notranslate"><span class="pre">PAIR</span> <span class="pre">n</span></code> is more efficient.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; PA(\right)R / S =&gt; DIP ((\right)R) ; PAIR / S
&gt; P(\left)IR / S =&gt; (\left)R ; PAIR / S
&gt; P(\left)(\right)R =&gt;  (\left)R ; DIP ((\right)R) ; PAIR / S
</pre></div>
</div>
<p>A good way to quickly figure which macro to use is to mentally parse the
macro as <code class="docutils literal notranslate"><span class="pre">P</span></code> for pair constructor, <code class="docutils literal notranslate"><span class="pre">A</span></code> for left leaf and <code class="docutils literal notranslate"><span class="pre">I</span></code> for
right leaf. The macro takes as many elements on the stack as there are
leaves and constructs a nested pair with the shape given by its name.</p>
<p>Take the macro <code class="docutils literal notranslate"><span class="pre">PAPPAIIR</span></code> for instance:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>P A  P P A  I    I R
( l, ( ( l, r ), r ))
</pre></div>
</div>
<p>A typing rule can be inferred:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PAPPAIIR
:: &#39;a : &#39;b : &#39;c : &#39;d : &#39;S  -&gt;  (pair &#39;a (pair (pair &#39;b &#39;c) &#39;d))
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UNP(\left=A|P(\left)(\right))(\right=I|P(\left)(\right))R</span></code>: A syntactic sugar
for destructing nested pairs. These macros follow the same convention
as the previous one.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; UNPA(\right)R / S =&gt; UNPAIR ; DIP (UN(\right)R) / S
&gt; UNP(\left)IR / S =&gt; UNPAIR ; UN(\left)R / S
&gt; UNP(\left)(\right)R =&gt; UNPAIR ; DIP (UN(\right)R) ; UN(\left)R / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">C[AD]+R</span></code>: A syntactic sugar for accessing fields in nested pairs. In the case of right combs, <code class="docutils literal notranslate"><span class="pre">CAR</span> <span class="pre">k</span></code> and <code class="docutils literal notranslate"><span class="pre">CDR</span> <span class="pre">k</span></code> are more efficient.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; CA(\rest=[AD]+)R / S  =&gt;  CAR ; C(\rest)R / S
&gt; CD(\rest=[AD]+)R / S  =&gt;  CDR ; C(\rest)R / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CAR</span> <span class="pre">k</span></code>: Access the <code class="docutils literal notranslate"><span class="pre">k</span></code> -th part of a right comb of size <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;</span> <span class="pre">k</span> <span class="pre">+</span> <span class="pre">1</span></code>. <code class="docutils literal notranslate"><span class="pre">CAR</span> <span class="pre">0</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">CAR</span></code> and in general <code class="docutils literal notranslate"><span class="pre">CAR</span> <span class="pre">k</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">k</span></code> times the <code class="docutils literal notranslate"><span class="pre">CDR</span></code> instruction followed by once the <code class="docutils literal notranslate"><span class="pre">CAR</span></code> instruction. Note that this instruction cannot access the last element of a right comb; <code class="docutils literal notranslate"><span class="pre">CDR</span> <span class="pre">k</span></code> should be used for that.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; CAR n / S  =&gt;  GET (2n+1) / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CDR</span> <span class="pre">k</span></code>: Access the rightmost element of a right comb of size <code class="docutils literal notranslate"><span class="pre">k</span></code>. <code class="docutils literal notranslate"><span class="pre">CDR</span> <span class="pre">0</span></code> is a no-op, <code class="docutils literal notranslate"><span class="pre">CDR</span> <span class="pre">1</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">CDR</span></code> and in general <code class="docutils literal notranslate"><span class="pre">CDR</span> <span class="pre">k</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">k</span></code> times the <code class="docutils literal notranslate"><span class="pre">CDR</span></code> instruction. Note that on a right comb of size <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;</span> <span class="pre">k</span> <span class="pre">&gt;=</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">CDR</span> <span class="pre">k</span></code> will return the right comb composed of the same elements but the <code class="docutils literal notranslate"><span class="pre">k</span></code> leftmost ones.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; CDR n / S  =&gt;  GET (2n) / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IF_SOME</span> <span class="pre">bt</span> <span class="pre">bf</span></code>: Inspect an optional value.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; IF_SOME bt bf / S  =&gt;  IF_NONE bf bt / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IF_RIGHT</span> <span class="pre">bt</span> <span class="pre">bf</span></code>: Inspect a value of a union.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; IF_RIGHT bt bf / S  =&gt;  IF_LEFT bf bt / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SET_CAR</span></code>: Set the left field of a pair. This is equivalent to <code class="docutils literal notranslate"><span class="pre">SWAP;</span> <span class="pre">UPDATE</span> <span class="pre">1</span></code>.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; SET_CAR  =&gt;  CDR ; SWAP ; PAIR
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SET_CDR</span></code>: Set the right field of a pair. This is equivalent to <code class="docutils literal notranslate"><span class="pre">SWAP;</span> <span class="pre">UPDATE</span> <span class="pre">2</span></code>.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; SET_CDR  =&gt;  CAR ; PAIR
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SET_C[AD]+R</span></code>: A syntactic sugar for setting fields in nested
pairs. In the case of right combs, <code class="docutils literal notranslate"><span class="pre">UPDATE</span> <span class="pre">n</span></code> is more efficient.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; SET_CA(\rest=[AD]+)R / S   =&gt;
    { DUP ; DIP { CAR ; SET_C(\rest)R } ; CDR ; SWAP ; PAIR } / S
&gt; SET_CD(\rest=[AD]+)R / S   =&gt;
    { DUP ; DIP { CDR ; SET_C(\rest)R } ; CAR ; PAIR } / S
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MAP_CAR</span></code> code: Transform the left field of a pair.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; MAP_CAR code  =&gt;  DUP ; CDR ; DIP { CAR ; code } ; SWAP ; PAIR
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MAP_CDR</span></code> code: Transform the right field of a pair.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; MAP_CDR code  =&gt;  DUP ; CDR ; code ; SWAP ; CAR ; PAIR
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MAP_C[AD]+R</span></code> code: A syntactic sugar for transforming fields in
nested pairs.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; MAP_CA(\rest=[AD]+)R code / S   =&gt;
    { DUP ; DIP { CAR ; MAP_C(\rest)R code } ; CDR ; SWAP ; PAIR } / S
&gt; MAP_CD(\rest=[AD]+)R code / S   =&gt;
    { DUP ; DIP { CDR ; MAP_C(\rest)R code } ; CAR ; PAIR } / S
</pre></div>
</div>
</section>
</section>
<section id="concrete-syntax">
<h2>Concrete syntax<a class="headerlink" href="#concrete-syntax" title="Link to this heading">#</a></h2>
<p id="concretesyntax-alpha">The concrete language is very close to the formal notation of the
specification. Its structure is extremely simple: an expression in the
language can only be one of the five following constructs.</p>
<ol class="arabic simple">
<li><p>An integer in decimal notation.</p></li>
<li><p>A character string.</p></li>
<li><p>A byte sequence in hexadecimal notation prefixed by <code class="docutils literal notranslate"><span class="pre">0x</span></code>.</p></li>
<li><p>The application of a primitive to a sequence of expressions.</p></li>
<li><p>A sequence of expressions.</p></li>
</ol>
<p>This simple five cases notation is called <a class="reference internal" href="../shell/micheline.html"><span class="doc">Micheline</span></a>.</p>
<p>In the Tezos protocol, the primitive <code class="docutils literal notranslate"><span class="pre">constant</span></code> with a single
character string applied has special meaning. See
<a class="reference internal" href="global_constants.html"><span class="doc">Global Constants</span></a>.</p>
<section id="constants">
<h3>Constants<a class="headerlink" href="#constants" title="Link to this heading">#</a></h3>
<p>There are three kinds of constants:</p>
<ol class="arabic simple">
<li><p>Integers or naturals in decimal notation.</p></li>
<li><p>Strings, with some usual escape sequences: <code class="docutils literal notranslate"><span class="pre">\n</span></code>, <code class="docutils literal notranslate"><span class="pre">\\</span></code>,
<code class="docutils literal notranslate"><span class="pre">\&quot;</span></code>. Unescaped line-breaks (both <code class="docutils literal notranslate"><span class="pre">\n</span></code> and <code class="docutils literal notranslate"><span class="pre">\r</span></code>) cannot
appear in a Michelson string. Moreover, the current version of
Michelson restricts strings to be the printable subset of 7-bit
ASCII, namely characters with codes from within <code class="docutils literal notranslate"><span class="pre">[32,</span> <span class="pre">126]</span></code> range,
plus the escaped characters mentioned above.</p></li>
<li><p>Byte sequences in hexadecimal notation, prefixed with <code class="docutils literal notranslate"><span class="pre">0x</span></code>.</p></li>
</ol>
</section>
<section id="differences-with-the-formal-notation">
<h3>Differences with the formal notation<a class="headerlink" href="#differences-with-the-formal-notation" title="Link to this heading">#</a></h3>
<p>The concrete syntax follows the same lexical conventions as the
specification: instructions are represented by uppercase identifiers,
type constructors by lowercase identifiers, and constant constructors
are capitalized.</p>
<p>All domain specific constants are Micheline constants with specific
formats. Some have two variants accepted by the data type checker: a
readable one in a string, and an optimized one using a more compact
encoding.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mutez</span></code> amounts are written as naturals.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code>s are written either using <code class="docutils literal notranslate"><span class="pre">RFC3339</span></code> notation
in a string (readable), or as the number of seconds since Epoch
(when positive) or before Epoch (when negative) (optimized).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">contract</span></code>s, <code class="docutils literal notranslate"><span class="pre">address</span></code>es, <code class="docutils literal notranslate"><span class="pre">key</span></code>s and <code class="docutils literal notranslate"><span class="pre">signature</span></code>s
are written as strings, in their usual Base58 encoded versions
(readable), or as their raw bytes (optimized).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bls12_381_g1</span></code>s and <code class="docutils literal notranslate"><span class="pre">bls12_381_g2</span></code>s are written as their raw bytes, using a big-endian point encoding, <a class="reference external" href="https://docs.rs/bls12_381/latest/bls12_381/notes/serialization/index.html#bls12-381-serialization">as specified here</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bls12_381_fr</span></code>s are written as their raw bytes, using a little-endian encoding.</p></li>
</ul>
<p>The optimized versions should not reach the RPCs, the protocol code
will convert to optimized by itself when forging operations, storing
to the database, and before hashing to get a canonical representation
of a datum for a given type.</p>
<p>To prevent errors, control flow primitives that take instructions as
parameters require sequences in the concrete syntax.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>IF { instr1_true ; instr2_true ; ... }
   { instr1_false ; instr2_false ; ... }
</pre></div>
</div>
</section>
<section id="main-program-structure">
<span id="syntax-of-scripts-alpha"></span><h3>Main program structure<a class="headerlink" href="#main-program-structure" title="Link to this heading">#</a></h3>
<p>The toplevel of a smart contract file must be an un-delimited sequence
of three primitive applications (in no particular order) that provide its
<code class="docutils literal notranslate"><span class="pre">code</span></code>, <code class="docutils literal notranslate"><span class="pre">parameter</span></code> and <code class="docutils literal notranslate"><span class="pre">storage</span></code> fields.</p>
<p>See the next section for a concrete example.</p>
</section>
</section>
<section id="annotations">
<span id="annotations-alpha"></span><h2>Annotations<a class="headerlink" href="#annotations" title="Link to this heading">#</a></h2>
<p>The annotation mechanism of Michelson provides ways to better track
data on the stack and to give additional type constraints. Except for
a single exception specified just after, annotations are only here to
add constraints, <em>i.e.</em> they cannot turn an otherwise rejected program
into an accepted one. The notable exception to this rule is for
entrypoints: the semantics of the <code class="docutils literal notranslate"><span class="pre">CONTRACT</span></code> and <code class="docutils literal notranslate"><span class="pre">SELF</span></code> instructions vary depending on
their constructor annotations, and some contract origination may fail due
to invalid entrypoint constructor annotations.</p>
<p>Stack visualization tools like the Michelson’s Emacs mode print
annotations associated with each type in the program, as propagated by
the typechecker as well as variable annotations on the types of elements
in the stack. This is useful as a debugging aid.</p>
<p>We distinguish three kinds of annotations:</p>
<ul class="simple">
<li><p>type annotations, written <code class="docutils literal notranslate"><span class="pre">:type_annot</span></code>,</p></li>
<li><p>variable annotations, written <code class="docutils literal notranslate"><span class="pre">&#64;var_annot</span></code>,</p></li>
<li><p>and field or constructors annotations, written <code class="docutils literal notranslate"><span class="pre">%field_annot</span></code>.</p></li>
</ul>
<p>Note that all annotations are stripped during <a class="reference internal" href="#type-normalization-alpha"><span class="std std-ref">type normalization</span></a>.</p>
<section id="type-annotations">
<h3>Type annotations<a class="headerlink" href="#type-annotations" title="Link to this heading">#</a></h3>
<p>Each type can be annotated with at most one type annotation. They are
used to give names to types. For types to be equal, their unnamed
version must be equal and their names must be the same or at least one
type must be unnamed.</p>
<p>For instance, the following Michelson program which put its integer
parameter in the storage is not well typed:</p>
<div class="highlight-michelson notranslate"><div class="highlight"><pre><span></span><span class="k">parameter</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="k k-Name">:p</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="k">storage</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="k k-Name">:s</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="k">code</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DROP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">NIL</span><span class="w"> </span><span class="kt">operation</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">PAIR</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>Whereas this one is:</p>
<div class="highlight-michelson notranslate"><div class="highlight"><pre><span></span><span class="k">parameter</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="k k-Name">:p</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="k">storage</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">;</span>
<span class="k">code</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DROP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">NIL</span><span class="w"> </span><span class="kt">operation</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">PAIR</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>Inner components of composed typed can also be named.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(pair :point (int :x_pos) (int :y_pos))
</pre></div>
</div>
<p>Push-like instructions, that act as constructors, can also be given a
type annotation. The stack type will then have on top a type with a corresponding name.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>UNIT :t
:: &#39;A -&gt; (unit :t) : &#39;A

PAIR :t
:: &#39;a : &#39;b : &#39;S -&gt; (pair :t &#39;a &#39;b) : &#39;S

SOME :t
:: &#39;a : &#39;S -&gt; (option :t &#39;a) : &#39;S

NONE :t &#39;a
:: &#39;S -&gt; (option :t &#39;a) : &#39;S

LEFT :t &#39;b
:: &#39;a : &#39;S -&gt; (or :t &#39;a &#39;b) : &#39;S

RIGHT :t &#39;a
:: &#39;b : &#39;S -&gt; (or :t &#39;a &#39;b) : &#39;S

NIL :t &#39;a
:: &#39;S -&gt; (list :t &#39;a) : &#39;S

EMPTY_SET :t &#39;elt
:: &#39;S -&gt; (set :t &#39;elt) : &#39;S

EMPTY_MAP :t &#39;key &#39;val
:: &#39;S -&gt; (map :t &#39;key &#39;val) : &#39;S

EMPTY_BIG_MAP :t &#39;key &#39;val
:: &#39;S -&gt; (big_map :t &#39;key &#39;val) : &#39;S
</pre></div>
</div>
<p>A no-op instruction <code class="docutils literal notranslate"><span class="pre">CAST</span></code> ensures the top of the stack has the
specified type, and change its type if it is compatible. In particular,
this allows to change or remove type names explicitly.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CAST &#39;b
:: &#39;a : &#39;S   -&gt;   &#39;b : &#39;S
   iff  &#39;a = &#39;b

&gt; CAST t / a : S  =&gt;  a : S
</pre></div>
</div>
</section>
<section id="variable-annotations">
<h3>Variable annotations<a class="headerlink" href="#variable-annotations" title="Link to this heading">#</a></h3>
<p>Variable annotations can only be used on instructions that produce
elements on the stack. An instruction that produces <code class="docutils literal notranslate"><span class="pre">n</span></code> elements on
the stack can be given at most <code class="docutils literal notranslate"><span class="pre">n</span></code> variable annotations.</p>
<p>The stack type contains both the types of each element in the stack, as
well as an optional variable annotation for each element. In this
sub-section we note:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[]</span></code> for the empty stack,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;annot</span> <span class="pre">(top)</span> <span class="pre">:</span> <span class="pre">(rest)</span></code> for the stack whose first value has type <code class="docutils literal notranslate"><span class="pre">(top)</span></code> and is annotated with variable annotation <code class="docutils literal notranslate"><span class="pre">&#64;annot</span></code> and whose queue has stack type <code class="docutils literal notranslate"><span class="pre">(rest)</span></code>.</p></li>
</ul>
<p>The instructions which do not accept any variable annotations are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DROP
SWAP
DIG
DUG
IF_NONE
IF_LEFT
IF_CONS
ITER
IF
LOOP
LOOP_LEFT
DIP
FAILWITH
</pre></div>
</div>
<p>The instructions which accept at most one variable annotation are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DUP
PUSH
UNIT
SOME
NONE
PAIR
CAR
CDR
LEFT
RIGHT
NIL
CONS
SIZE
MAP
MEM
EMPTY_SET
EMPTY_MAP
EMPTY_BIG_MAP
UPDATE
GET
LAMBDA
LAMBDA_REC
EXEC
ADD
SUB
CONCAT
MUL
OR
AND
XOR
NOT
ABS
ISNAT
INT
NEG
EDIV
LSL
LSR
COMPARE
EQ
NEQ
LT
GT
LE
GE
ADDRESS
CONTRACT
SET_DELEGATE
IMPLICIT_ACCOUNT
NOW
LEVEL
AMOUNT
BALANCE
HASH_KEY
CHECK_SIGNATURE
BLAKE2B
SOURCE
SENDER
SELF
SELF_ADDRESS
CAST
RENAME
CHAIN_ID
NAT
BYTES
</pre></div>
</div>
<p>The instructions which accept at most two variable annotations are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>UNPAIR
CREATE_CONTRACT
</pre></div>
</div>
<p>Annotations on instructions that produce multiple elements on the stack
will be used in order, where the first variable annotation is given to
the top-most element on the resulting stack. Instructions that produce
<code class="docutils literal notranslate"><span class="pre">n</span></code> elements on the stack but are given less than <code class="docutils literal notranslate"><span class="pre">n</span></code> variable
annotations will see only their top-most stack type elements annotated.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>UNPAIR @first @second
:: pair &#39;a &#39;b : &#39;S
   -&gt;  @first &#39;a : @second &#39;b : &#39;S

UNPAIR @first
:: pair &#39;a &#39;b : &#39;S
   -&gt;  @first &#39;a : &#39;b : &#39;S
</pre></div>
</div>
<p>A no-op instruction <code class="docutils literal notranslate"><span class="pre">RENAME</span></code> allows to rename variables in the stack
or to erase variable annotations in the stack.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RENAME @new
:: @old &#39;a ; &#39;S -&gt; @new &#39;a : &#39;S

RENAME
:: @old &#39;a ; &#39;S -&gt; &#39;a : &#39;S
</pre></div>
</div>
</section>
<section id="field-and-constructor-annotations">
<h3>Field and constructor annotations<a class="headerlink" href="#field-and-constructor-annotations" title="Link to this heading">#</a></h3>
<p>Components of pair types, option types and or types can be annotated
with a field or constructor annotation. This feature is useful to encode
records fields and constructors of sum types.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(pair :point
      (int %x)
      (int %y))
</pre></div>
</div>
<p>The previous Michelson type can be used as visual aid to represent the
record type (given in OCaml-like syntax):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type point = { x : int ; y : int }
</pre></div>
</div>
<p>Similarly,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(or :t
    (int %A)
    (or
       (bool %B)
       (pair %C
             (nat %n1)
             (nat %n2))))
</pre></div>
</div>
<p>can be used to represent the algebraic data type (in OCaml-like syntax):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type t =
  | A of int
  | B of bool
  | C of { n1 : nat ; n2 : nat }
</pre></div>
</div>
<p>Field annotations are part of the type (at the same level as type name
annotations), and so types with differing field names (if present) are
not considered equal.</p>
<p>Instructions that construct elements of composed types can also be
annotated with one or multiple field annotations (in addition to type
and variable annotations).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PAIR %fst %snd
:: &#39;a : &#39;b : &#39;S -&gt; (pair (&#39;a %fst) (&#39;b %snd)) : &#39;S

LEFT %left %right &#39;b
:: &#39;a : &#39;S -&gt; (or (&#39;a %left) (&#39;b %right)) : &#39;S

RIGHT %left %right &#39;a
:: &#39;b : &#39;S -&gt; (or (&#39;a %left) (&#39;b %right)) : &#39;S
</pre></div>
</div>
<p>To improve readability and robustness, instructions <code class="docutils literal notranslate"><span class="pre">CAR</span></code> and <code class="docutils literal notranslate"><span class="pre">CDR</span></code>
accept one field annotation. For the contract to type check, the name of
the accessed field in the destructed pair must match the one given here.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CAR %fst
:: (pair (&#39;a %fst) &#39;b) : S -&gt; &#39;a : &#39;S

CDR %snd
:: (pair &#39;a (&#39;b %snd)) : S -&gt; &#39;b : &#39;S
</pre></div>
</div>
</section>
<section id="syntax">
<h3>Syntax<a class="headerlink" href="#syntax" title="Link to this heading">#</a></h3>
<p>Primitive applications can receive one or many annotations.</p>
<p>An annotation is a sequence of characters that matches the regular
expression <code class="docutils literal notranslate"><span class="pre">&#64;%|&#64;%%|%&#64;|[&#64;:%][_0-9a-zA-Z][_0-9a-zA-Z\.%&#64;]*</span></code>.
Note however that <code class="docutils literal notranslate"><span class="pre">&#64;%</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;%%</span></code> and <code class="docutils literal notranslate"><span class="pre">%&#64;</span></code> are
<a class="reference internal" href="#specialannotations-alpha"><span class="std std-ref">special annotations</span></a> and are not allowed everywhere.</p>
<p>Annotations come after the primitive name and before its potential arguments.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(prim @v :t %x arg1 arg2 ...)
</pre></div>
</div>
<p>Ordering between different kinds of annotations is not significant, but
ordering among annotations of the same kind is. Annotations of the same
kind must be grouped together.</p>
<p>For instance these two annotated instructions are equivalent:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PAIR :t @my_pair %x %y

PAIR %x %y :t @my_pair
</pre></div>
</div>
<p>An annotation can be empty, in this case it will mean <em>no annotation</em>
and can be used as a wildcard. For instance, it is useful to annotate
only the right field of a pair instruction <code class="docutils literal notranslate"><span class="pre">PAIR</span> <span class="pre">%</span> <span class="pre">%right</span></code> or to
ignore field access constraints, <em>e.g.</em> in the macro <code class="docutils literal notranslate"><span class="pre">UNPPAIPAIR</span> <span class="pre">%x1</span> <span class="pre">%</span>
<span class="pre">%x3</span> <span class="pre">%x4</span></code>.</p>
</section>
<section id="annotations-and-macros">
<h3>Annotations and macros<a class="headerlink" href="#annotations-and-macros" title="Link to this heading">#</a></h3>
<p>Macros also support annotations, which are propagated on their expanded
forms. As with instructions, macros that produce <code class="docutils literal notranslate"><span class="pre">n</span></code> values on the
stack accept <code class="docutils literal notranslate"><span class="pre">n</span></code> variable annotations.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DUU+P @annot
&gt; DUU(\rest=U*)P @annot / S  =&gt;  DIP (DU(\rest)P @annot) ; SWAP / S

C[AD]+R @annot %field_name
&gt; CA(\rest=[AD]+)R @annot %field_name / S  =&gt;  CAR ; C(\rest)R @annot %field_name / S
&gt; CD(\rest=[AD]+)R @annot %field_name / S  =&gt;  CDR ; C(\rest)R @annot %field_name / S

CMP{EQ|NEQ|LT|GT|LE|GE} @annot
&gt; CMP(\op) @annot / S  =&gt;  COMPARE ; (\op) @annot / S
</pre></div>
</div>
<p>The variable annotation on <code class="docutils literal notranslate"><span class="pre">SET_C[AD]+R</span></code> and <code class="docutils literal notranslate"><span class="pre">MAP_C[AD]+R</span></code> annotates
the resulting toplevel pair while its field annotation is used to check
that the modified field is the expected one.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SET_C[AD]+R @var %field
&gt; SET_CAR @var %field =&gt;  CDR %field ; SWAP ; PAIR @var
&gt; SET_CDR @var %field =&gt;  CAR %field ; PAIR @var
&gt; SET_CA(\rest=[AD]+)R @var %field / S   =&gt;
  { DUP ; DIP { CAR ; SET_C(\rest)R %field } ; CDR ; SWAP ; PAIR @var } / S
&gt; SET_CD(\rest=[AD]+)R  @var %field/ S   =&gt;
  { DUP ; DIP { CDR ; SET_C(\rest)R %field } ; CAR ; PAIR @var } / S

MAP_C[AD]+R @var %field code
&gt; MAP_CAR code  =&gt;  DUP ; CDR ; DIP { CAR %field ; code } ; SWAP ; PAIR @var
&gt; MAP_CDR code  =&gt;  DUP ; CDR %field ; code ; SWAP ; CAR ; PAIR @var
&gt; MAP_CA(\rest=[AD]+)R @var %field code / S   =&gt;
  { DUP ; DIP { CAR ; MAP_C(\rest)R %field code } ; CDR ; SWAP ; PAIR @var} / S
&gt; MAP_CD(\rest=[AD]+)R @var %field code / S   =&gt;
 { DUP ; DIP { CDR ; MAP_C(\rest)R %field code } ; CAR ; PAIR @var} / S
</pre></div>
</div>
<p>Macros for nested <code class="docutils literal notranslate"><span class="pre">PAIR</span></code> accept multiple annotations. Field
annotations for <code class="docutils literal notranslate"><span class="pre">PAIR</span></code> give names to leaves of the constructed
nested pair, in order.  This next snippet gives examples instead of
generic rewrite rules for readability purposes.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PAPPAIIR @p %x1 %x2 %x3 %x4
:: &#39;a : &#39;b : &#39;c : &#39;d : &#39;S
   -&gt; @p (pair (&#39;a %x1) (pair (pair (&#39;b %x) (&#39;c %x3)) (&#39;d %x4))) : &#39;S

PAPAIR @p %x1 %x2 %x3
:: &#39;a : &#39;b : &#39;c : &#39;S  -&gt;  @p (pair (&#39;a %x1) (pair (&#39;b %x) (&#39;c %x3))) : &#39;S
</pre></div>
</div>
<p>Annotations for nested <code class="docutils literal notranslate"><span class="pre">UNPAIR</span></code> are deprecated.</p>
</section>
<section id="automatic-variable-and-field-annotations-inferring">
<h3>Automatic variable and field annotations inferring<a class="headerlink" href="#automatic-variable-and-field-annotations-inferring" title="Link to this heading">#</a></h3>
<p>When no annotation is provided by the Michelson programmer, the
typechecker infers some annotations in specific cases. This greatly
helps users track information in the stack for bare contracts.</p>
<p>For unannotated accesses with <code class="docutils literal notranslate"><span class="pre">CAR</span></code> and <code class="docutils literal notranslate"><span class="pre">CDR</span></code> to fields that are
named will be appended (with an additional <code class="docutils literal notranslate"><span class="pre">.</span></code> character) to the pair
variable annotation.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CDAR
:: @p (pair (&#39;a %foo) (pair %bar (&#39;b %x) (&#39;c %y))) : &#39;S -&gt;  @p.bar.x &#39;b : &#39;S
</pre></div>
</div>
<p>If fields are not named but the pair is still named in the stack then
<code class="docutils literal notranslate"><span class="pre">.car</span></code> or <code class="docutils literal notranslate"><span class="pre">.cdr</span></code> will be appended.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CDAR
:: @p (pair &#39;a (pair &#39;b &#39;c)) : &#39;S -&gt;  @p.cdr.car &#39;b : &#39;S
</pre></div>
</div>
<p>If the original pair is not named in the stack, but a field annotation
is present in the pair type the accessed value will be annotated with a
variable annotation corresponding to the field annotation alone.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CDAR
:: (pair (&#39;a %foo) (pair %bar (&#39;b %x) (&#39;c %y))) : &#39;S -&gt;  @bar.x &#39;b : &#39;S
</pre></div>
</div>
<p>A similar mechanism is used for context dependent instructions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ADDRESS  :: @c contract _ : &#39;S   -&gt;   @c.address address : &#39;S

CONTRACT &#39;p  :: @a address : &#39;S   -&gt;   @a.contract contract &#39;p : &#39;S

BALANCE :: &#39;S   -&gt;   @balance mutez : &#39;S

SOURCE  :: &#39;S   -&gt;   @source address : &#39;S

SENDER  :: &#39;S   -&gt;   @sender address : &#39;S

SELF  :: &#39;S   -&gt;   @self contract &#39;p : &#39;S

SELF_ADDRESS  :: &#39;S   -&gt;   @self address : &#39;S

AMOUNT  :: &#39;S   -&gt;   @amount mutez : &#39;S

NOW  :: &#39;S   -&gt;   @now timestamp : &#39;S

LEVEL :: &#39;S  -&gt;   @level nat : &#39;S
</pre></div>
</div>
<p>Inside nested code blocks, bound items on the stack will be given a
default variable name annotation depending on the instruction and stack
type (which can be changed). For instance the annotated typing rule for
<code class="docutils literal notranslate"><span class="pre">ITER</span></code> on lists is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ITER body
:: @l (list &#39;e) : &#39;A  -&gt;  &#39;A
   iff body :: [ @l.elt e&#39; : &#39;A -&gt; &#39;A ]
</pre></div>
</div>
</section>
<section id="special-annotations">
<h3>Special annotations<a class="headerlink" href="#special-annotations" title="Link to this heading">#</a></h3>
<p id="specialannotations-alpha">The special variable annotations <code class="docutils literal notranslate"><span class="pre">&#64;%</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;%%</span></code> can be used on instructions
<code class="docutils literal notranslate"><span class="pre">CAR</span></code>, <code class="docutils literal notranslate"><span class="pre">CDR</span></code>, and <code class="docutils literal notranslate"><span class="pre">UNPAIR</span></code>. It means to use the accessed field name (if any) as
a name for the value on the stack. The following typing rule
demonstrates their use for instruction <code class="docutils literal notranslate"><span class="pre">CAR</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CAR @%
:: @p (pair (&#39;a %fst) (&#39;b %snd)) : &#39;S   -&gt;   @fst &#39;a : &#39;S

CAR @%%
:: @p (pair (&#39;a %fst) (&#39;b %snd)) : &#39;S   -&gt;   @p.fst &#39;a : &#39;S
</pre></div>
</div>
<p>The special field annotation <code class="docutils literal notranslate"><span class="pre">%&#64;</span></code> can be used on instructions
<code class="docutils literal notranslate"><span class="pre">PAIR</span></code>, <code class="docutils literal notranslate"><span class="pre">LEFT</span></code> and <code class="docutils literal notranslate"><span class="pre">RIGHT</span></code>. It means to use the variable
name annotation in the stack as a field name for the constructed
element. Two examples with <code class="docutils literal notranslate"><span class="pre">PAIR</span></code> follows, notice the special
treatment of annotations with <code class="docutils literal notranslate"><span class="pre">.</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PAIR %@ %@
:: @x &#39;a : @y &#39;b : &#39;S   -&gt;   (pair (&#39;a %x) (&#39;b %y)) : &#39;S

PAIR %@ %@
:: @p.x &#39;a : @p.y &#39;b : &#39;S   -&gt;  @p (pair (&#39;a %x) (&#39;b %y)) : &#39;S
:: @p.x &#39;a : @q.y &#39;b : &#39;S   -&gt;  (pair (&#39;a %x) (&#39;b %y)) : &#39;S
</pre></div>
</div>
</section>
</section>
<section id="entrypoints">
<h2>Entrypoints<a class="headerlink" href="#entrypoints" title="Link to this heading">#</a></h2>
<p>The specification up to this point has been mostly ignoring existence
of entrypoints: a mechanism of contract level polymorphism. This
mechanism is optional, non intrusive, and transparent to smart
contracts that don’t use them. This section is to be read as a patch
over the rest of the specification, introducing rules that apply only
in presence of contracts that make use of entrypoints.</p>
<section id="defining-and-calling-entrypoints">
<h3>Defining and calling entrypoints<a class="headerlink" href="#defining-and-calling-entrypoints" title="Link to this heading">#</a></h3>
<p>Entrypoints piggyback on the constructor annotations. A contract with
entrypoints is basically a contract that takes a disjunctive type (a
nesting of <code class="docutils literal notranslate"><span class="pre">or</span></code> types) as the root of its input parameter, decorated
with constructor annotations. An extra check is performed on these
constructor annotations: a contract cannot define two entrypoints with
the same name.</p>
<p>An external transaction can include an entrypoint name alongside the
parameter value. In that case, if there is a constructor annotation
with this name at any position in the nesting of <code class="docutils literal notranslate"><span class="pre">or</span></code> types, the
value is automatically wrapped into the according constructors. If the
transaction specifies an entrypoint, but there is no such constructor
annotation, the transaction fails.</p>
<p>For instance, suppose the following input type.</p>
<p><code class="docutils literal notranslate"><span class="pre">parameter</span> <span class="pre">(or</span> <span class="pre">(or</span> <span class="pre">(nat</span> <span class="pre">%A)</span> <span class="pre">(bool</span> <span class="pre">%B))</span> <span class="pre">(or</span> <span class="pre">%maybe_C</span> <span class="pre">(unit</span> <span class="pre">%Z)</span> <span class="pre">(string</span> <span class="pre">%C)))</span></code></p>
<p>The input values will be wrapped as in the following examples.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------------+-----------+---------------------------------+
| entrypoint | input     | wrapped input                   |
+------------+-----------+---------------------------------+
| %A         | 3         | Left (Left 3)                   |
| %B         | False     | Left (Right False)              |
| %C         | &quot;bob&quot;     | Right (Right &quot;bob&quot;)             |
| %Z         | Unit      | Right (Left Unit)               |
| %maybe_C   | Right &quot;x&quot; | Right (Right &quot;x&quot;)               |
| %maybe_C   | Left Unit | Right (Left Unit)               |
+------------+-----------+---------------------------------+
| not given  | value     | value (untouched)               |
| %BAD       | _         | failure, contract not called    |
+------------+-----------+---------------------------------+
</pre></div>
</div>
</section>
<section id="the-default-entrypoint">
<h3>The <code class="docutils literal notranslate"><span class="pre">default</span></code> entrypoint<a class="headerlink" href="#the-default-entrypoint" title="Link to this heading">#</a></h3>
<p>A special semantics is assigned to the <code class="docutils literal notranslate"><span class="pre">default</span></code> entrypoint. If the
contract does not explicitly declare a <code class="docutils literal notranslate"><span class="pre">default</span></code> entrypoint, then it
is automatically assigned to the root of the parameter
type. Conversely, if the contract is called without specifying an
entrypoint, then it is assumed to be called with the <code class="docutils literal notranslate"><span class="pre">default</span></code>
entrypoint. This behaviour makes the entrypoint system completely
transparent to contracts that do not use it.</p>
<p>This is the case for the previous example, for instance. If a value is
passed to such a contract specifying entrypoint <code class="docutils literal notranslate"><span class="pre">default</span></code>, then the
value is fed to the contract untouched, exactly as if no entrypoint
was given.</p>
<p>A non enforced convention is to make the entrypoint <code class="docutils literal notranslate"><span class="pre">default</span></code> of
type unit, and to implement the crediting operation (just receive the
transferred tokens).</p>
<p>A consequence of this semantics is that if the contract uses the
entrypoint system and defines a <code class="docutils literal notranslate"><span class="pre">default</span></code> entrypoint somewhere else
than at the root of the parameter type, then it must provide an
entrypoint for all the paths in the toplevel disjunction. Otherwise,
some parts of the contracts would be dead code.</p>
<p>Another consequence of setting the entrypoint somewhere else than at
the root is that it makes it impossible to send the raw values of the
full parameter type to a contract. A trivial solution for that is to
name the root of the type. The conventional name for that is <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<p>Let us recapitulate this by tweaking the names of the previous example.</p>
<p><code class="docutils literal notranslate"><span class="pre">parameter</span> <span class="pre">(or</span> <span class="pre">%root</span> <span class="pre">(or</span> <span class="pre">(nat</span> <span class="pre">%A)</span> <span class="pre">(bool</span> <span class="pre">%B))</span> <span class="pre">(or</span> <span class="pre">(unit</span> <span class="pre">%default)</span> <span class="pre">string))</span></code></p>
<p>The input values will be wrapped as in the following examples.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------------+---------------------+-----------------------+
| entrypoint | input               | wrapped input         |
+------------+---------------------+-----------------------+
| %A         | 3                   | Left (Left 3)         |
| %B         | False               | Left (Right False)    |
| %default   | Unit                | Right (Left Unit)     |
| %root      | Right (Right &quot;bob&quot;) | Right (Right &quot;bob&quot;)   |
+------------+---------------------+-----------------------+
| not given  | Unit                | Right (Left Unit)     |
| %BAD       | _                   | failure, contract not |
+------------+---------------------+-----------------------+
</pre></div>
</div>
</section>
<section id="calling-entrypoints-from-michelson">
<h3>Calling entrypoints from Michelson<a class="headerlink" href="#calling-entrypoints-from-michelson" title="Link to this heading">#</a></h3>
<p>Michelson code can also produce transactions to a specific entrypoint.</p>
<p>For this, both types <code class="docutils literal notranslate"><span class="pre">address</span></code> and <code class="docutils literal notranslate"><span class="pre">contract</span></code> have the ability to
denote not just an address, but a pair of an address and an
entrypoint. The concrete notation is <code class="docutils literal notranslate"><span class="pre">&quot;address%entrypoint&quot;</span></code>.
Note that <code class="docutils literal notranslate"><span class="pre">&quot;address&quot;</span></code> is strictly equivalent to <code class="docutils literal notranslate"><span class="pre">&quot;address%default&quot;</span></code>,
and for clarity, the second variant is forbidden in the concrete syntax.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">TRANSFER_TOKENS</span></code> instruction is called, it places the
entrypoint provided in the contract handle in the transaction.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CONTRACT</span> <span class="pre">t</span></code> instruction has a variant <code class="docutils literal notranslate"><span class="pre">CONTRACT</span> <span class="pre">%entrypoint</span>
<span class="pre">t</span></code>, that works as follows. Note that <code class="docutils literal notranslate"><span class="pre">CONTRACT</span> <span class="pre">t</span></code> is strictly
equivalent to <code class="docutils literal notranslate"><span class="pre">CONTRACT</span> <span class="pre">%default</span> <span class="pre">t</span></code>, and for clarity, the second
variant is forbidden in the concrete syntax.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------+---------------------+------------------------------------------+
| input address | instruction         | output contract                          |
+---------------+---------------------+------------------------------------------+
| &quot;addr&quot;        | CONTRACT t          | (Some &quot;addr&quot;) if contract exists, has a  |
|               |                     | default entrypoint of type t, or has no  |
|               |                     | default entrypoint and parameter type t  |
+---------------+---------------------+------------------------------------------+
| &quot;addr%name&quot;   | CONTRACT t          | (Some &quot;addr%name&quot;) if addr exists and    |
+---------------+---------------------+ has an entrypoint %name of type t        |
| &quot;addr&quot;        | CONTRACT %name t    |                                          |
+---------------+---------------------+------------------------------------------+
| &quot;addr%_&quot;      | CONTRACT %_ t       | None                                     |
+---------------+---------------------+------------------------------------------+
</pre></div>
</div>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">SELF</span></code> instruction has a variant <code class="docutils literal notranslate"><span class="pre">SELF</span> <span class="pre">%entrypoint</span></code>,
that is only well-typed if the current contract has an entrypoint named <code class="docutils literal notranslate"><span class="pre">%entrypoint</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SELF</span> <span class="pre">%entrypoint</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>:: &#39;S   -&gt;   contract &#39;p : &#39;S
   where   contract &#39;p is the type of the entrypoint %entrypoint of the current contract
</pre></div>
</div>
<p>User accounts are considered to have a single <code class="docutils literal notranslate"><span class="pre">default</span></code>
entrypoint of type <code class="docutils literal notranslate"><span class="pre">Unit</span></code>.</p>
</section>
</section>
<section id="json-syntax">
<h2>JSON syntax<a class="headerlink" href="#json-syntax" title="Link to this heading">#</a></h2>
<p>Micheline expressions are encoded in JSON like this:</p>
<ul>
<li><p>An integer <code class="docutils literal notranslate"><span class="pre">N</span></code> is an object with a single field <code class="docutils literal notranslate"><span class="pre">&quot;int&quot;</span></code> whose
value is the decimal representation as a string.</p>
<p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">&quot;int&quot;:</span> <span class="pre">&quot;N&quot;</span> <span class="pre">}</span></code></p>
</li>
<li><p>A string <code class="docutils literal notranslate"><span class="pre">&quot;contents&quot;</span></code> is an object with a single field <code class="docutils literal notranslate"><span class="pre">&quot;string&quot;</span></code>
whose value is the decimal representation as a string.</p>
<p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">&quot;string&quot;:</span> <span class="pre">&quot;contents&quot;</span> <span class="pre">}</span></code></p>
</li>
<li><p>A sequence is a JSON array.</p>
<p><code class="docutils literal notranslate"><span class="pre">[</span> <span class="pre">expr,</span> <span class="pre">...</span> <span class="pre">]</span></code></p>
</li>
<li><p>A primitive application is an object with two fields <code class="docutils literal notranslate"><span class="pre">&quot;prim&quot;</span></code> for
the primitive name and <code class="docutils literal notranslate"><span class="pre">&quot;args&quot;</span></code> for the arguments (that must
contain an array). A third optional field <code class="docutils literal notranslate"><span class="pre">&quot;annots&quot;</span></code> contains a
list of annotations, including their leading <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, <code class="docutils literal notranslate"><span class="pre">%</span></code> or <code class="docutils literal notranslate"><span class="pre">:</span></code>
sign.</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">&quot;prim&quot;:</span> <span class="pre">&quot;pair&quot;,</span> <span class="pre">&quot;args&quot;:</span> <span class="pre">[</span> <span class="pre">{</span> <span class="pre">&quot;prim&quot;:</span> <span class="pre">&quot;nat&quot;,</span> <span class="pre">&quot;args&quot;:</span> <span class="pre">[]</span> <span class="pre">},</span> <span class="pre">{</span> <span class="pre">&quot;prim&quot;:</span> <span class="pre">&quot;nat&quot;,</span> <span class="pre">&quot;args&quot;:</span> <span class="pre">[]</span> <span class="pre">}</span> <span class="pre">],</span> <span class="pre">&quot;annots&quot;:</span> <span class="pre">[&quot;:t&quot;]</span> <span class="pre">}</span></code></p>
</div></blockquote>
</li>
</ul>
<p>As in the concrete syntax, all domain specific constants are encoded as
strings.</p>
</section>
<section id="development-tools">
<h2>Development tools<a class="headerlink" href="#development-tools" title="Link to this heading">#</a></h2>
<p>To ease the development of Michelson scripts, some tools are provided
to Michelson developers.</p>
<section id="emacs-mode">
<h3>Emacs mode<a class="headerlink" href="#emacs-mode" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://www.gnu.org/software/emacs/">Emacs</a> can be used as a practical environment for writing,
editing and debugging Michelson programs. <a class="reference external" href="https://www.gnu.org/software/emacs/">Install it</a> and follow the
configuration instructions in the Michelson Emacs README <a class="reference external" href="https://gitlab.com/tezos/tezos/-/tree/master/emacs">here</a>.</p>
</section>
<section id="interactive-toplevel">
<h3>Interactive toplevel<a class="headerlink" href="#interactive-toplevel" title="Link to this heading">#</a></h3>
<p>An interactive Michelson toplevel (also known as a <a class="reference external" href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL</a>)
built on the <a class="reference internal" href="../user/mockup.html"><span class="doc">Mockup mode</span></a> mode of Octez client is available in
<code class="docutils literal notranslate"><span class="pre">scripts/michelson_repl.sh</span></code>, the typical usage is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ octez-client --mode mockup --base-dir /tmp/mockup create mockup
$ rlwrap scripts/michelson_repl.sh
&gt; UNIT
  { Stack_elt unit Unit }
&gt; UNIT
  { Stack_elt unit Unit ; Stack_elt unit Unit }
&gt; COMPARE
  { Stack_elt int 0 }
</pre></div>
</div>
</section>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h2>
<p>Contracts in the system are stored as a piece of code and a global data
storage. The type of the global data of the storage is fixed for each
contract at origination time. This is ensured statically by checking on
origination that the code preserves the type of the global data. For
this, the code of the contract is checked to be of  type
<code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">(pair</span> <span class="pre">'arg</span> <span class="pre">'global)</span> <span class="pre">-&gt;</span> <span class="pre">(pair</span> <span class="pre">(list</span> <span class="pre">operation)</span> <span class="pre">'global)</span></code> where
<code class="docutils literal notranslate"><span class="pre">'global</span></code> is the type of the original global store given on origination.
The contract also takes a parameter and returns a list of internal operations,
hence the complete calling convention above. The internal operations are
queued for execution when the contract returns.</p>
<section id="empty-contract">
<h3>Empty contract<a class="headerlink" href="#empty-contract" title="Link to this heading">#</a></h3>
<p>The simplest contract is the contract for which the <code class="docutils literal notranslate"><span class="pre">parameter</span></code> and
<code class="docutils literal notranslate"><span class="pre">storage</span></code> are all of type <code class="docutils literal notranslate"><span class="pre">unit</span></code>. This contract is as follows:</p>
<div class="highlight-michelson notranslate"><div class="highlight"><pre><span></span><span class="k">code</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">CDR</span><span class="w"> </span><span class="p">;</span><span class="w">           </span><span class="c1"># keep the storage</span>
<span class="w">       </span><span class="kr">NIL</span><span class="w"> </span><span class="kt">operation</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="c1"># return no internal operation</span>
<span class="w">       </span><span class="kr">PAIR</span><span class="w"> </span><span class="p">};</span><span class="w">         </span><span class="c1"># respect the calling convention</span>
<span class="k">storage</span><span class="w"> </span><span class="kt">unit</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="kt">unit</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="example-contract-with-entrypoints">
<h3>Example contract with entrypoints<a class="headerlink" href="#example-contract-with-entrypoints" title="Link to this heading">#</a></h3>
<p>The following contract maintains a number in its storage. It has two
entrypoints <code class="docutils literal notranslate"><span class="pre">add</span></code> and <code class="docutils literal notranslate"><span class="pre">sub</span></code> to modify it, and the default
entrypoint, of type <code class="docutils literal notranslate"><span class="pre">unit</span></code> will reset it to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ parameter (or (or (nat %add) (nat %sub)) (unit %default)) ;
  storage int ;
  code { AMOUNT ; PUSH mutez 0 ; ASSERT_CMPEQ ; UNPAIR ;
         IF_LEFT
           { IF_LEFT { ADD } { SWAP ; SUB } }
           { DROP ; DROP ; PUSH int 0 } ;
         NIL operation ; PAIR } }
</pre></div>
</div>
</section>
<section id="example-contract-with-recursive-lambda">
<h3>Example contract with recursive lambda<a class="headerlink" href="#example-contract-with-recursive-lambda" title="Link to this heading">#</a></h3>
<p>The following contract computes the factorial of the given parameter
using a recursive function and then saves the result in the storage.</p>
<p>In Michelson regular functions start with a stack containing a single
value, the function argument. If the function is of type <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">int</span>
<span class="pre">int</span></code>, when calling the function the stack will have just an
<code class="docutils literal notranslate"><span class="pre">int</span></code>. Recursive functions start with two values, the argument and
the function itself. Therefore, if the recursive function is of type
<code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">int</span> <span class="pre">int</span></code> then, when it is being called, the stack will have
an <code class="docutils literal notranslate"><span class="pre">int</span></code> at the top and a <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">int</span> <span class="pre">int</span></code> at the bottom.</p>
<p>In this recursive factorial we can see the first branch of the <code class="docutils literal notranslate"><span class="pre">IF</span></code>,
this is the base case. The second one performs the recursive call. To
do that, we need to access the function. This is what the <code class="docutils literal notranslate"><span class="pre">DUP</span> <span class="pre">3</span></code>
instruction does. Then we decrement the argument and finally make the
recursive call with <code class="docutils literal notranslate"><span class="pre">EXEC</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ parameter int;
  storage int;
  code { CAR ;
         LAMBDA_REC  int int
                     { DUP;
                       EQ;
                       IF { PUSH int 1 }
                          { DUP;
                            DUP 3;
                            PUSH int 1;
                            DUP 4;
                            SUB;
                            EXEC;
                            MUL};
                       DIP { DROP 2 }};
         SWAP;
         EXEC;
         NIL operation;
         PAIR}}
</pre></div>
</div>
</section>
<section id="multisig-contract">
<h3>Multisig contract<a class="headerlink" href="#multisig-contract" title="Link to this heading">#</a></h3>
<p>The multisig is a typical access control contract. The ownership of
the multisig contract is shared between <code class="docutils literal notranslate"><span class="pre">N</span></code> participants represented
by their public keys in the contract’s storage. Any action on the
multisig contract needs to be signed by <code class="docutils literal notranslate"><span class="pre">K</span></code> participants where the
threshold <code class="docutils literal notranslate"><span class="pre">K</span></code> is also stored in the storage.</p>
<p>To avoid replay of the signatures sent to the contract, the signed
data include not only a description of the action to perform but also
the address of the multisig contract and a counter that gets
incremented at each successful call to the contract.</p>
<p>The multisig commands of <a class="reference internal" href="cli-commands.html#client-manual-alpha"><span class="std std-ref">Octez command line client</span></a>
use this
smart contract. Moreover, <a class="reference external" href="https://gitlab.com/nomadic-labs/mi-cho-coq/blob/master/src/contracts_coq/multisig.v">functional correctness of this contract has
been verified</a>
using the Coq proof assistant.</p>
<div class="highlight-michelson notranslate"><div class="highlight"><pre><span></span><span class="k">parameter</span><span class="w"> </span><span class="p">(</span><span class="kt">pair</span>
<span class="w">             </span><span class="p">(</span><span class="kt">pair</span><span class="w"> </span><span class="k k-Name">:payload</span>
<span class="w">                </span><span class="p">(</span><span class="kt">nat</span><span class="w"> </span><span class="k k-Name">%counter</span><span class="p">)</span><span class="w"> </span><span class="c1"># counter, used to prevent replay attacks</span>
<span class="w">                </span><span class="p">(</span><span class="kt">or</span><span class="w"> </span><span class="k k-Name">:action</span><span class="w">    </span><span class="c1"># payload to sign, represents the requested action</span>
<span class="w">                   </span><span class="p">(</span><span class="kt">pair</span><span class="w"> </span><span class="k k-Name">:transfer</span><span class="w">    </span><span class="c1"># transfer tokens</span>
<span class="w">                      </span><span class="p">(</span><span class="kt">mutez</span><span class="w"> </span><span class="k k-Name">%amount</span><span class="p">)</span><span class="w"> </span><span class="c1"># amount to transfer</span>
<span class="w">                      </span><span class="p">(</span><span class="kt">contract</span><span class="w"> </span><span class="k k-Name">%dest</span><span class="w"> </span><span class="kt">unit</span><span class="p">))</span><span class="w"> </span><span class="c1"># destination to transfer to</span>
<span class="w">                   </span><span class="p">(</span><span class="kt">or</span>
<span class="w">                      </span><span class="p">(</span><span class="kt">option</span><span class="w"> </span><span class="k k-Name">%delegate</span><span class="w"> </span><span class="kt">key_hash</span><span class="p">)</span><span class="w"> </span><span class="c1"># change the delegate to this address</span>
<span class="w">                      </span><span class="p">(</span><span class="kt">pair</span><span class="w"> </span><span class="k k-Name">%change_keys</span><span class="w">          </span><span class="c1"># change the keys controlling the multisig</span>
<span class="w">                         </span><span class="p">(</span><span class="kt">nat</span><span class="w"> </span><span class="k k-Name">%threshold</span><span class="p">)</span><span class="w">         </span><span class="c1"># new threshold</span>
<span class="w">                         </span><span class="p">(</span><span class="kt">list</span><span class="w"> </span><span class="k k-Name">%keys</span><span class="w"> </span><span class="kt">key</span><span class="p">)))))</span><span class="w">     </span><span class="c1"># new list of keys</span>
<span class="w">             </span><span class="p">(</span><span class="kt">list</span><span class="w"> </span><span class="k k-Name">%sigs</span><span class="w"> </span><span class="p">(</span><span class="kt">option</span><span class="w"> </span><span class="kt">signature</span><span class="p">)));</span><span class="w">    </span><span class="c1"># signatures</span>

<span class="k">storage</span><span class="w"> </span><span class="p">(</span><span class="kt">pair</span><span class="w"> </span><span class="p">(</span><span class="kt">nat</span><span class="w"> </span><span class="k k-Name">%stored_counter</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">pair</span><span class="w"> </span><span class="p">(</span><span class="kt">nat</span><span class="w"> </span><span class="k k-Name">%threshold</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">list</span><span class="w"> </span><span class="k k-Name">%keys</span><span class="w"> </span><span class="kt">key</span><span class="p">)))</span><span class="w"> </span><span class="p">;</span>

<span class="k">code</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DUP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="kr">DIP</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="p">;</span>
<span class="w">        </span><span class="c1"># pair the payload with the current contract address, to ensure signatures</span>
<span class="w">        </span><span class="c1"># can&#39;t be replayed across different contracts if a key is reused.</span>
<span class="w">        </span><span class="kr">DUP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SELF</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">ADDRESS</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">CHAIN_ID</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">PAIR</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">PAIR</span><span class="w"> </span><span class="p">;</span>
<span class="w">        </span><span class="kr">PACK</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="c1"># form the binary payload that we expect to be signed</span>
<span class="w">        </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="k k-Name">@counter</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Check that the counters match</span>
<span class="w">    </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="k k-Name">@stored_counter</span><span class="p">;</span><span class="w"> </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kr">ASSERT_CMPEQ</span><span class="w"> </span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Compute the number of valid signatures</span>
<span class="w">    </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="k k-Name">@threshold</span><span class="w"> </span><span class="k k-Name">@keys</span><span class="p">;</span>
<span class="w">    </span><span class="kr">DIP</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="c1"># Running count of valid signatures</span>
<span class="w">        </span><span class="kr">PUSH</span><span class="w"> </span><span class="k k-Name">@valid</span><span class="w"> </span><span class="kt">nat</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span>
<span class="w">        </span><span class="kr">ITER</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span>
<span class="w">            </span><span class="kr">IF_CONS</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="kr">IF_SOME</span>
<span class="w">                  </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span>
<span class="w">                    </span><span class="kr">DIP</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DIIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">DUP</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">;</span>
<span class="w">                        </span><span class="c1"># Checks signatures, fails if invalid</span>
<span class="w">                        </span><span class="kr">CHECK_SIGNATURE</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">ASSERT</span><span class="w"> </span><span class="p">;</span>
<span class="w">                        </span><span class="kr">PUSH</span><span class="w"> </span><span class="kt">nat</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">ADD</span><span class="w"> </span><span class="k k-Name">@valid</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">                  </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DROP</span><span class="w"> </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="c1"># There were fewer signatures in the list</span>
<span class="w">                </span><span class="c1"># than keys. Not all signatures must be present, but</span>
<span class="w">                </span><span class="c1"># they should be marked as absent using the option type.</span>
<span class="w">                </span><span class="kr">FAIL</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="p">;</span>
<span class="w">            </span><span class="kr">SWAP</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="c1"># Assert that the threshold is less than or equal to the</span>
<span class="w">    </span><span class="c1"># number of valid signatures.</span>
<span class="w">    </span><span class="kr">ASSERT_CMPLE</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="kr">DROP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">DROP</span><span class="w"> </span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Increment counter and place in storage</span>
<span class="w">    </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">PUSH</span><span class="w"> </span><span class="kt">nat</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">ADD</span><span class="w"> </span><span class="k k-Name">@new_counter</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">PAIR</span><span class="p">}</span><span class="w"> </span><span class="p">;</span>

<span class="w">    </span><span class="c1"># We have now handled the signature verification part,</span>
<span class="w">    </span><span class="c1"># produce the operation requested by the signers.</span>
<span class="w">    </span><span class="kr">NIL</span><span class="w"> </span><span class="kt">operation</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="kr">IF_LEFT</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="c1"># Transfer tokens</span>
<span class="w">        </span><span class="kr">UNPAIR</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">UNIT</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">TRANSFER_TOKENS</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">CONS</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="kr">IF_LEFT</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1"># Change delegate</span>
<span class="w">                  </span><span class="kr">SET_DELEGATE</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">CONS</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="c1"># Change set of signatures</span>
<span class="w">                  </span><span class="kr">DIP</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">CAR</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">PAIR</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="kr">SWAP</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="kr">PAIR</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="views">
<h3>Views<a class="headerlink" href="#views" title="Link to this heading">#</a></h3>
<p>Here is an example using views, consisting of two contracts.
The first contract defines two views at toplevel that are named <code class="docutils literal notranslate"><span class="pre">add_v</span></code> and <code class="docutils literal notranslate"><span class="pre">mul_v</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ parameter nat;
  storage nat;
  code { CAR; NIL operation ; PAIR };
  view &quot;add_v&quot; nat nat { UNPAIR; ADD };
  view &quot;mul_v&quot; nat nat { UNPAIR; MUL };
}
</pre></div>
</div>
<p>The second contract calls the <code class="docutils literal notranslate"><span class="pre">add_v</span></code> view of the above contract and obtains a result immediately.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ parameter (pair nat address) ;
  storage nat ;
  code { CAR ; UNPAIR; VIEW &quot;add_v&quot; nat ;
         IF_SOME { } { FAIL }; NIL operation; PAIR }; }
</pre></div>
</div>
</section>
</section>
<section id="full-grammar">
<h2>Full grammar<a class="headerlink" href="#full-grammar" title="Link to this heading">#</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;data&gt; ::=
  | &lt;int constant&gt;
  | &lt;string constant&gt;
  | &lt;byte sequence constant&gt;
  | Unit
  | True
  | False
  | Pair &lt;data&gt; &lt;data&gt; ...
  | Left &lt;data&gt;
  | Right &lt;data&gt;
  | Some &lt;data&gt;
  | None
  | Lambda_rec &lt;instruction&gt;
  | { &lt;data&gt; ; ... }
  | { Elt &lt;data&gt; &lt;data&gt; ; ... }
  | instruction
&lt;natural number constant&gt; ::=
  | [0-9]+
&lt;int constant&gt; ::=
  | &lt;natural number constant&gt;
  | -&lt;natural number constant&gt;
&lt;string constant&gt; ::=
  | &quot;&lt;string content&gt;*&quot;
&lt;string content&gt; ::=
  | \&quot;
  | \r
  | \n
  | \t
  | \b
  | \\
  | [^&quot;\]
&lt;byte sequence constant&gt; ::=
  | 0x[0-9a-fA-F]+
&lt;instruction&gt; ::=
  | { &lt;instruction&gt; ... }
  | DROP
  | DROP &lt;natural number constant&gt;
  | DUP
  | DUP &lt;natural number constant&gt;
  | SWAP
  | DIG &lt;natural number constant&gt;
  | DUG &lt;natural number constant&gt;
  | PUSH &lt;type&gt; &lt;data&gt;
  | SOME
  | NONE &lt;type&gt;
  | UNIT
  | NEVER
  | IF_NONE { &lt;instruction&gt; ... } { &lt;instruction&gt; ... }
  | PAIR
  | PAIR &lt;natural number constant&gt;
  | CAR
  | CDR
  | UNPAIR
  | UNPAIR &lt;natural number constant&gt;
  | LEFT &lt;type&gt;
  | RIGHT &lt;type&gt;
  | IF_LEFT { &lt;instruction&gt; ... } { &lt;instruction&gt; ... }
  | NIL &lt;type&gt;
  | CONS
  | IF_CONS { &lt;instruction&gt; ... } { &lt;instruction&gt; ... }
  | SIZE
  | EMPTY_SET &lt;comparable type&gt;
  | EMPTY_MAP &lt;comparable type&gt; &lt;type&gt;
  | EMPTY_BIG_MAP &lt;comparable type&gt; &lt;type&gt;
  | MAP { &lt;instruction&gt; ... }
  | ITER { &lt;instruction&gt; ... }
  | MEM
  | GET
  | GET &lt;natural number constant&gt;
  | UPDATE
  | UPDATE &lt;natural number constant&gt;
  | IF { &lt;instruction&gt; ... } { &lt;instruction&gt; ... }
  | LOOP { &lt;instruction&gt; ... }
  | LOOP_LEFT { &lt;instruction&gt; ... }
  | LAMBDA &lt;type&gt; &lt;type&gt; { &lt;instruction&gt; ... }
  | LAMBDA_REC &lt;type&gt; &lt;type&gt; { &lt;instruction&gt; ... }
  | EXEC
  | APPLY
  | DIP { &lt;instruction&gt; ... }
  | DIP &lt;natural number constant&gt; { &lt;instruction&gt; ... }
  | FAILWITH
  | CAST
  | RENAME
  | CONCAT
  | SLICE
  | PACK
  | UNPACK &lt;type&gt;
  | ADD
  | SUB
  | MUL
  | EDIV
  | ABS
  | ISNAT
  | INT
  | NEG
  | LSL
  | LSR
  | OR
  | AND
  | XOR
  | NOT
  | COMPARE
  | EQ
  | NEQ
  | LT
  | GT
  | LE
  | GE
  | SELF
  | SELF_ADDRESS
  | CONTRACT &lt;type&gt;
  | TRANSFER_TOKENS
  | SET_DELEGATE
  | CREATE_CONTRACT { &lt;instruction&gt; ... }
  | IMPLICIT_ACCOUNT
  | VOTING_POWER
  | NOW
  | LEVEL
  | AMOUNT
  | BALANCE
  | CHECK_SIGNATURE
  | BLAKE2B
  | KECCAK
  | SHA3
  | SHA256
  | SHA512
  | HASH_KEY
  | SOURCE
  | SENDER
  | ADDRESS
  | CHAIN_ID
  | TOTAL_VOTING_POWER
  | PAIRING_CHECK
  | SAPLING_EMPTY_STATE &lt;natural number constant&gt;
  | SAPLING_VERIFY_UPDATE
  | TICKET
  | READ_TICKET
  | SPLIT_TICKET
  | JOIN_TICKETS
  | OPEN_CHEST
  | BYTES
  | NAT
&lt;type&gt; ::=
  | &lt;comparable type&gt;
  | option &lt;type&gt;
  | list &lt;type&gt;
  | set &lt;comparable type&gt;
  | operation
  | contract &lt;type&gt;
  | ticket &lt;comparable type&gt;
  | pair &lt;type&gt; &lt;type&gt; ...
  | or &lt;type&gt; &lt;type&gt;
  | lambda &lt;type&gt; &lt;type&gt;
  | map &lt;comparable type&gt; &lt;type&gt;
  | big_map &lt;comparable type&gt; &lt;type&gt;
  | bls12_381_g1
  | bls12_381_g2
  | bls12_381_fr
  | sapling_transaction &lt;natural number constant&gt;
  | sapling_state &lt;natural number constant&gt;
  | chest
  | chest_key
&lt;comparable type&gt; ::=
  | unit
  | never
  | bool
  | int
  | nat
  | string
  | chain_id
  | bytes
  | mutez
  | key_hash
  | key
  | signature
  | timestamp
  | address
  | option &lt;comparable type&gt;
  | or &lt;comparable type&gt; &lt;comparable type&gt;
  | pair &lt;comparable type&gt; &lt;comparable type&gt; ...
</pre></div>
</div>
</section>
<section id="reference-implementation">
<h2>Reference implementation<a class="headerlink" href="#reference-implementation" title="Link to this heading">#</a></h2>
<p>The language is implemented in OCaml as follows:</p>
<ul>
<li><p>The lower internal representation is written as a GADT whose type
parameters encode exactly the typing rules given in this
specification. In other words, if a program written in this
representation is accepted by OCaml’s typechecker, it is guaranteed
type-safe. This is of course also valid for programs not
handwritten but generated by OCaml code, so we are sure that any
manipulated code is type-safe.</p>
<p>In the end, what remains to be checked is the encoding of the typing
rules as OCaml types, which boils down to half a line of code for
each instruction. Everything else is left to the venerable and well
trusted OCaml.</p>
</li>
<li><p>The interpreter is basically the direct transcription of the
rewriting rules presented above. It takes an instruction, a stack and
transforms it. OCaml’s typechecker ensures that the transformation
respects the pre and post stack types declared by the GADT case for
each instruction.</p>
<p>The only things that remain to be reviewed are value dependent
choices, such as we did not swap true and false when
interpreting the IF instruction.</p>
</li>
<li><p>The input, untyped internal representation is an OCaml ADT with
only 5 grammar constructions: <code class="docutils literal notranslate"><span class="pre">String</span></code>, <code class="docutils literal notranslate"><span class="pre">Int</span></code>, <code class="docutils literal notranslate"><span class="pre">Bytes</span></code>, <code class="docutils literal notranslate"><span class="pre">Seq</span></code> and
<code class="docutils literal notranslate"><span class="pre">Prim</span></code>. It is the target language for the parser, since not all
parsable programs are well typed, and thus could simply not be
constructed using the GADT.</p></li>
<li><p>The typechecker is a simple function that recognizes the abstract
grammar described in section X by pattern matching, producing the
well-typed, corresponding GADT expressions. It is mostly a checker,
not a full inferrer, and thus takes some annotations (basically the
input and output of the program, of lambdas and of uninitialized maps
and sets). It works by performing a symbolic evaluation of the
program, transforming a symbolic stack. It only needs one pass over
the whole program.</p>
<p>Here again, OCaml does most of the checking, the structure of the
function is very simple, what we have to check is that we transform a
<code class="docutils literal notranslate"><span class="pre">Prim</span> <span class="pre">(&quot;If&quot;,</span> <span class="pre">...)</span></code> into an <code class="docutils literal notranslate"><span class="pre">If</span></code>, a <code class="docutils literal notranslate"><span class="pre">Prim</span> <span class="pre">(&quot;Dup&quot;,</span> <span class="pre">...)</span></code> into a
<code class="docutils literal notranslate"><span class="pre">Dup</span></code>, etc.</p>
</li>
</ul>
</section>
<section id="tzt-a-syntax-extension-for-writing-unit-tests">
<span id="michelson-tzt-alpha"></span><h2>TZT, a Syntax extension for writing unit tests<a class="headerlink" href="#tzt-a-syntax-extension-for-writing-unit-tests" title="Link to this heading">#</a></h2>
<p>This section describes the TZT format, an extension of the Michelson
language allowing to run Michelson unit tests at a finer level than a
full smart contract script. This extension adds syntax to specify an
instruction (or sequence of instructions) to test, a concrete input
stack and the expected output stack.</p>
<p>These unit tests can be useful for both smart contract developers who
need to independently test various parts of the smart contracts they
develop and to the developers of new implementations of the Michelson
interpreter who need to check that their new implementations behave as
the reference implementation by passing <a class="reference external" href="https://gitlab.com/tezos/tzt-reference-test-suite">a conformance test suite</a>.</p>
<p>Similarly to Michelson scripts, the concrete syntax of TZT unit tests
is <a class="reference internal" href="../shell/micheline.html"><span class="doc">Micheline</span></a>.</p>
<p>TZT unit test files usually have the extension <code class="docutils literal notranslate"><span class="pre">.tzt</span></code>. A unit test
file describes a single unit test. It consists of a Micheline sequence
of primitive applications (see <a class="reference internal" href="../shell/micheline.html"><span class="doc">Micheline</span></a>), in no particular order. This is
<a class="reference internal" href="#syntax-of-scripts-alpha"><span class="std std-ref">similar to Michelson scripts</span></a> but
the set of primitives allowed at the toplevel differ; in Michelson
scripts, the allowed toplevel primitives are <code class="docutils literal notranslate"><span class="pre">parameter</span></code>
(mandatory), <code class="docutils literal notranslate"><span class="pre">storage</span></code> (mandatory), <code class="docutils literal notranslate"><span class="pre">code</span></code> (mandatory), and
<code class="docutils literal notranslate"><span class="pre">view</span></code> (optional and repeated). For TZT unit tests, the toplevel
primitives which can be used are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">input</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">code</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">now</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sender</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chain_id</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parameter</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">amount</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">balance</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">other_contracts</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">big_maps</span></code>.</p></li>
</ul>
<section id="mandatory-primitives">
<h3>Mandatory primitives<a class="headerlink" href="#mandatory-primitives" title="Link to this heading">#</a></h3>
<p>Each of the mandatory primitives <code class="docutils literal notranslate"><span class="pre">input</span></code>, <code class="docutils literal notranslate"><span class="pre">code</span></code>, and <code class="docutils literal notranslate"><span class="pre">output</span></code>
must occur exactly once in a unit test file in no particular order.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">input</span></code> primitive is used to declare the input stack (see the
<a class="reference internal" href="#syntax-of-concrete-stacks-alpha"><span class="std std-ref">syntax of concrete stacks</span></a>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">code</span></code> primitive is used to declare the instruction or sequence
of instructions to execute.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">output</span></code> primitive is used to declare if the execution is
expected to succeed or fail and what result is expected from the
execution. For executions expected to succeed, the argument of the
<code class="docutils literal notranslate"><span class="pre">output</span></code> primitive is simply the expected output stack (see the
<a class="reference internal" href="#syntax-of-errors-alpha"><span class="std std-ref">syntax of errors</span></a>). For executions
expected to fail, the argument is the expected error. In both cases,
the <a class="reference internal" href="#omitting-parts-of-the-output-alpha"><span class="std std-ref">wildcard pattern</span></a> can
be used to omit part of the expected output.</p>
<p>The simplest test which can be written asserts that executing no
instruction on the empty stack successfully returns the empty stack:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {};
code {};
output {}
</pre></div>
</div>
<p>Here is a slightly more involved test which demonstrates the effect of the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-SWAP">SWAP</a> instruction:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input
  {
    Stack_elt nat 8 ;
    Stack_elt bool False
  };
code SWAP;
output
  {
    Stack_elt bool False ;
    Stack_elt nat 8
  }
</pre></div>
</div>
<p>It is possible to test the effect of several instructions by wrapping them in a sequence:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input
  {
    Stack_elt nat 8 ;
    Stack_elt bool False
  };
code { SWAP ; SWAP };
output
  {
    Stack_elt nat 8 ;
    Stack_elt bool False
  }
</pre></div>
</div>
<p>Here is an example showing how to test the <code class="docutils literal notranslate"><span class="pre">FAILWITH</span></code> instruction:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt nat 2};
code FAILWITH;
output (Failed 2)
</pre></div>
</div>
</section>
<section id="optional-primitives">
<h3>Optional primitives<a class="headerlink" href="#optional-primitives" title="Link to this heading">#</a></h3>
<p>Optional primitives are used to set the execution context for the
test. Each of the optional primitives can be used at most once, in no
particular order.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">amount</span></code> (optional, defaults to 0): the amount, expressed in
mutez, that should be pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-AMOUNT">AMOUNT</a>
instruction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">balance</span></code> (optional, defaults to 0): the balance, expressed in
mutez, that should be pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-BALANCE">BALANCE</a>
instruction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">now</span></code> (optional, defaults to <code class="docutils literal notranslate"><span class="pre">&quot;1970-01-01T00:00:00Z&quot;</span></code>): the
timestamp that should be pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-NOW">NOW</a>
instruction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sender</span></code> (optional, defaults to
<code class="docutils literal notranslate"><span class="pre">&quot;tz1KqTpEZ7Yob7QbPE4Hy4Wo8fHG8LhKxZSx&quot;</span></code>): the sender address
that should be pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-SENDER">SENDER</a>
instruction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span></code> (optional, defaults to
<code class="docutils literal notranslate"><span class="pre">&quot;tz1KqTpEZ7Yob7QbPE4Hy4Wo8fHG8LhKxZSx&quot;</span></code>): the source address
that should be pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-SOURCE">SOURCE</a>
instruction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chain_id</span></code> (optional, defaults to <code class="docutils literal notranslate"><span class="pre">&quot;NetXdQprcVkpaWU&quot;</span></code>): the
chain identifier that should be pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-CHAIN_ID">CHAIN_ID</a>
instruction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self</span></code> (optional, defaults to
<code class="docutils literal notranslate"><span class="pre">&quot;KT1BEqzn5Wx8uJrZNvuS9DVHmLvG9td3fDLi&quot;</span></code>): the address that
should be pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-SELF">SELF</a> and
<a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-SELF_ADDRESS">SELF_ADDRESS</a>
instructions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parameter</span></code> (optional, defaults to <code class="docutils literal notranslate"><span class="pre">unit</span></code>): the type of the
parameter of the contract pushed by the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-SELF">SELF</a>
instruction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">other_contracts</span></code> (optional, defaults to <code class="docutils literal notranslate"><span class="pre">{}</span></code>): mapping between
the contract addresses that are assumed to exist and their
parameter types (see the <a class="reference internal" href="#syntax-of-other-contracts-alpha"><span class="std std-ref">syntax of other contracts
specifications</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">big_maps</span></code> (optional, defaults to <code class="docutils literal notranslate"><span class="pre">{}</span></code>): mapping between
integers representing <code class="docutils literal notranslate"><span class="pre">big_map</span></code> indices and descriptions of big
maps (see the <a class="reference internal" href="#syntax-of-extra-big-maps-alpha"><span class="std std-ref">syntax of extra big maps specifications</span></a>)</p></li>
</ul>
<p>The following test example asserts that the default value for the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-NOW">NOW</a>
instruction is the unix epoch:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {};
code NOW;
output { Stack_elt timestamp &quot;1970-01-01T00:00:00Z&quot; }
</pre></div>
</div>
<p>The following example shows how to use the <code class="docutils literal notranslate"><span class="pre">now</span></code> toplevel primitive
to make the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-NOW">NOW</a>
instruction return a chosen timestamp:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {};
now &quot;2020-01-08T07:13:51Z&quot;;
code NOW;
output { Stack_elt timestamp &quot;2020-01-08T07:13:51Z&quot; }
</pre></div>
</div>
</section>
<section id="syntax-of-concrete-stacks">
<span id="syntax-of-concrete-stacks-alpha"></span><h3>Syntax of concrete stacks<a class="headerlink" href="#syntax-of-concrete-stacks" title="Link to this heading">#</a></h3>
<p>A concrete stack is written as a Micheline sequence whose elements are
of the form <code class="docutils literal notranslate"><span class="pre">Stack_elt</span> <span class="pre">&lt;ty&gt;</span> <span class="pre">&lt;x&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;x&gt;</span></code> is a Michelson value
and <code class="docutils literal notranslate"><span class="pre">&lt;ty&gt;</span></code> is its type. For example, <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">Stack_elt</span> <span class="pre">bool</span> <span class="pre">True</span> <span class="pre">;</span>
<span class="pre">Stack_elt</span> <span class="pre">nat</span> <span class="pre">42</span> <span class="pre">}</span></code> is a concrete stack of length 2 whose top element
is the boolean <code class="docutils literal notranslate"><span class="pre">True</span></code> and the bottom element is the natural number
<code class="docutils literal notranslate"><span class="pre">42</span></code>.</p>
</section>
<section id="omitting-parts-of-the-output">
<span id="omitting-parts-of-the-output-alpha"></span><h3>Omitting parts of the output<a class="headerlink" href="#omitting-parts-of-the-output" title="Link to this heading">#</a></h3>
<p>Any part of the <code class="docutils literal notranslate"><span class="pre">output</span></code> specification can be replaced with the
wildcard pattern <code class="docutils literal notranslate"><span class="pre">_</span></code>.</p>
<p>For example, let’s consider the following test of the <code class="docutils literal notranslate"><span class="pre">PAIR</span></code> instruction:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt bool True; Stack_elt string &quot;foo&quot;};
code PAIR;
output {Stack_elt (pair bool string) (Pair True &quot;foo&quot;)}
</pre></div>
</div>
<p>Omitting the <code class="docutils literal notranslate"><span class="pre">True</span></code> argument to the <code class="docutils literal notranslate"><span class="pre">Pair</span></code> primitive can be done as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt bool True; Stack_elt string &quot;foo&quot;};
code PAIR;
output {Stack_elt (pair bool string) (Pair _ &quot;foo&quot;)}
</pre></div>
</div>
<p>Omitting the <code class="docutils literal notranslate"><span class="pre">Pair</span></code> primitive:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt bool True; Stack_elt string &quot;foo&quot;};
code PAIR;
output {Stack_elt (pair bool string) (_ True &quot;foo&quot;)}
</pre></div>
</div>
<p>Omitting the <code class="docutils literal notranslate"><span class="pre">pair</span> <span class="pre">bool</span> <span class="pre">string</span></code> type:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt bool True; Stack_elt string &quot;foo&quot;};
code PAIR;
output {Stack_elt _ (Pair True &quot;foo&quot;)}
</pre></div>
</div>
<p>Omitting the resulting stack element:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt bool True; Stack_elt string &quot;foo&quot;};
code PAIR;
output {_}
</pre></div>
</div>
<p>Omitting all of the output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt bool True; Stack_elt string &quot;foo&quot;};
code PAIR;
output _
</pre></div>
</div>
<p>The difference between the last two examples is that <code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">{_}</span></code>
means that the instruction is expected to successfully return a stack
of length 1 while <code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">_</span></code> means that nothing in particular is
expected from the execution of the instruction, not even being
successful.</p>
<p>The wildcard pattern is typically used to omit unspecified aspects of
the Michelson language when writing portable tests; in particular the
cryptographic nonces in values of type <code class="docutils literal notranslate"><span class="pre">operation</span></code> (see the
<a class="reference internal" href="#syntax-of-concrete-operations-alpha"><span class="std std-ref">syntax of concrete operations</span></a>) or implementation-specific
parts of error outputs (see the <a class="reference internal" href="#syntax-of-errors-alpha"><span class="std std-ref">syntax of errors</span></a>).</p>
</section>
<section id="output-normalization">
<span id="output-normalization-alpha"></span><h3>Output normalization<a class="headerlink" href="#output-normalization" title="Link to this heading">#</a></h3>
<p>The input and output stacks can use the readable and optimized formats
for Michelson values and even mix the formats; for a test to pass, the
expected output does not need to syntactically match the result of the
execution but only to match up to conversion between optimized and
readable formats; the TZT test runner is responsible for normalizing
the actual output and the expected one to common format. This means in
particular that conversion between readable and optimized formats can
be tested by using <code class="docutils literal notranslate"><span class="pre">{}</span></code> as the <code class="docutils literal notranslate"><span class="pre">code</span></code> instruction sequence to
test; for example these two tests pass:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt address 0x0000e7670f32038107a59a2b9cfefae36ea21f5aa63c};
code {};
output {Stack_elt address &quot;tz1gjaF81ZRRvdzjobyfVNsAeSC6PScjfQwN&quot;}
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt address &quot;tz1gjaF81ZRRvdzjobyfVNsAeSC6PScjfQwN&quot;};
code {};
output {Stack_elt address 0x0000e7670f32038107a59a2b9cfefae36ea21f5aa63c}
</pre></div>
</div>
<p>This normalization feature is however incompatible with using the
<a class="reference internal" href="#omitting-parts-of-the-output-alpha"><span class="std std-ref">wildcard pattern</span></a> in the
output; when using wildcards the output must be formatted using the
readable format so the following test does not pass:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt address &quot;tz1gjaF81ZRRvdzjobyfVNsAeSC6PScjfQwN&quot;};
code {};
output {Stack_elt _ 0x0000e7670f32038107a59a2b9cfefae36ea21f5aa63c}
</pre></div>
</div>
<p>but the following test does pass:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {Stack_elt address 0x0000e7670f32038107a59a2b9cfefae36ea21f5aa63c};
code {};
output {Stack_elt _ &quot;tz1gjaF81ZRRvdzjobyfVNsAeSC6PScjfQwN&quot;}
</pre></div>
</div>
</section>
<section id="syntax-of-errors">
<span id="syntax-of-errors-alpha"></span><h3>Syntax of errors<a class="headerlink" href="#syntax-of-errors" title="Link to this heading">#</a></h3>
<p>To test that the execution of an instruction fails, the following
syntaxes can be used instead of the output stack as the argument of the
<code class="docutils literal notranslate"><span class="pre">output</span></code> toplevel primitive to specify which error the instruction is expected to
raise:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(StaticError</span> <span class="pre">&lt;error</span> <span class="pre">description&gt;)</span></code>: an error occurred before the
instruction was executed; the error description format is
unspecified so consider using a <a class="reference internal" href="#omitting-parts-of-the-output-alpha"><span class="std std-ref">wildcard</span></a> such as <code class="docutils literal notranslate"><span class="pre">(StaticError</span> <span class="pre">_)</span></code>
to write portable tests;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(Failed</span> <span class="pre">&lt;value&gt;)</span></code>: the execution reached a <code class="docutils literal notranslate"><span class="pre">FAILWITH</span></code>
instruction and the topmost element of the stack at this point was
<code class="docutils literal notranslate"><span class="pre">&lt;value&gt;</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MutezUnderflow</span></code>: a mutez subtraction resulted in a negative
value. This should only happen in the case of the deprecated
<code class="docutils literal notranslate"><span class="pre">mutez</span></code> case of the <code class="docutils literal notranslate"><span class="pre">SUB</span></code> instruction;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Overflow</span></code>: an overflow was detected. This can happen when an
addition or multiplication on type <code class="docutils literal notranslate"><span class="pre">mutez</span></code> produces a result
which is too large to be represented as a value of type <code class="docutils literal notranslate"><span class="pre">mutez</span></code>,
or when the number of bits to shift using the <code class="docutils literal notranslate"><span class="pre">LSL</span></code> or <code class="docutils literal notranslate"><span class="pre">LSR</span></code>
instruction is too large.</p></li>
</ul>
<p>The following example shows how to test a runtime failure; it asserts
that the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-FAILWITH">FAILWITH</a>
instruction produces a runtime error containing the top of the stack.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input { Stack_elt nat 4 ; Stack_elt bytes 0x };
code FAILWITH;
output (Failed 4)
</pre></div>
</div>
<p>The following example shows how to test type checking failure; it
asserts that the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-DUP">DUP</a>
instruction cannot be used on an empty stack.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input {};
code DUP;
output (StaticError _)
</pre></div>
</div>
<p>The following example shows another kind of static failure: a string
cannot be passed as argument to the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-DUP">DUP</a>
instruction.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input { Stack_elt nat 8 };
code { DUP &quot;foo&quot; };
output (StaticError _)
</pre></div>
</div>
</section>
<section id="syntax-of-concrete-operations">
<span id="syntax-of-concrete-operations-alpha"></span><h3>Syntax of concrete operations<a class="headerlink" href="#syntax-of-concrete-operations" title="Link to this heading">#</a></h3>
<p>The <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#type-operation">operation type</a> has
no concrete syntax in Michelson. In order to specify the result of the
operation forging instructions <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-TRANSFER_TOKENS">TRANSFER_TOKENS</a>,
<a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-CREATE_CONTRACT">CREATE_CONTRACT</a>,
and <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-SET_DELEGATE">SET_DELEGATE</a> ,
the following data constructors are added:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Transfer_tokens</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Create_contract</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Set_delegate</span></code>.</p></li>
</ul>
<p>They take as arguments the inputs of the corresponding operation
forging instructions plus a cryptographic nonce represented as a byte
sequence. The result of <code class="docutils literal notranslate"><span class="pre">TRANSFER_TOKENS</span></code>, <code class="docutils literal notranslate"><span class="pre">CREATE_CONTRACT</span></code>,
and <code class="docutils literal notranslate"><span class="pre">SET_DELEGATE</span></code> have respectively the following shapes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Transfer_tokens</span> <span class="pre">&lt;argument&gt;</span> <span class="pre">&lt;amount</span> <span class="pre">in</span> <span class="pre">mutez&gt;</span> <span class="pre">&lt;address</span> <span class="pre">of</span> <span class="pre">destination&gt;</span> <span class="pre">&lt;nonce&gt;</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Create_contract</span> <span class="pre">{</span> <span class="pre">&lt;script&gt;</span> <span class="pre">}</span> <span class="pre">&lt;optional</span> <span class="pre">delegate&gt;</span> <span class="pre">&lt;initial</span> <span class="pre">balance</span> <span class="pre">in</span> <span class="pre">mutez&gt;</span> <span class="pre">&lt;initial</span> <span class="pre">storage&gt;</span> <span class="pre">&lt;nonce&gt;</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Set_delegate</span> <span class="pre">&lt;optional</span> <span class="pre">delegate&gt;</span> <span class="pre">&lt;nonce&gt;</span></code>.</p></li>
</ul>
<p>The computation of the cryptographic nonce is not specified. To write
portable tests, the nonces appearing in output stack expectations
should be replaced by <a class="reference internal" href="#omitting-parts-of-the-output-alpha"><span class="std std-ref">a wildcard pattern</span></a>.</p>
<p>Here is an example unit test for the <code class="docutils literal notranslate"><span class="pre">SET_DELEGATE</span></code> instruction used
to set the delegate of the current contract to the account at address
<code class="docutils literal notranslate"><span class="pre">tz1NwQ6hkenkn6aYYio8VnJvjtb4K1pfeU1Z</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input { Stack_elt (option key_hash) (Some &quot;tz1NwQ6hkenkn6aYYio8VnJvjtb4K1pfeU1Z&quot;) } ;
code SET_DELEGATE ;
output { Stack_elt operation (Set_delegate (Some &quot;tz1NwQ6hkenkn6aYYio8VnJvjtb4K1pfeU1Z&quot;) _) }
</pre></div>
</div>
</section>
<section id="syntax-of-other-contracts-specifications">
<span id="syntax-of-other-contracts-alpha"></span><h3>Syntax of other contracts specifications<a class="headerlink" href="#syntax-of-other-contracts-specifications" title="Link to this heading">#</a></h3>
<p>The behaviour of the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-CONTRACT">CONTRACT</a>
instruction depends on whether or not its input is the address of a
smart contract accepting the expected type as parameter. To test
it, the <code class="docutils literal notranslate"><span class="pre">other_contract</span></code> toplevel primitive can be used to specify
which contracts are assumed to be originated and which type they
accept as parameter.</p>
<p>The mapping given to the <code class="docutils literal notranslate"><span class="pre">other_contract</span></code> toplevel primitive is a
Micheline sequence whose elements have the form <code class="docutils literal notranslate"><span class="pre">Contract</span> <span class="pre">&quot;KT1...&quot;</span>
<span class="pre">&lt;ty&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&quot;KT1...&quot;</span></code> is a valid smart contract address and
<code class="docutils literal notranslate"><span class="pre">&lt;ty&gt;</span></code> is the type of its parameter. Each address should appear at
most once and the order is irrelevant.</p>
</section>
<section id="syntax-of-extra-big-maps-specifications">
<span id="syntax-of-extra-big-maps-alpha"></span><h3>Syntax of extra big maps specifications<a class="headerlink" href="#syntax-of-extra-big-maps-specifications" title="Link to this heading">#</a></h3>
<p>The behaviour of the instructions operating on type <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#type-big_map">big_map</a> depend
on the contents of big maps stored in the context. To test them, the
<code class="docutils literal notranslate"><span class="pre">big_maps</span></code> toplevel primitive can be used to specify the types and
contents of the big maps which are assumed to be present.</p>
<p>The mapping given to the <code class="docutils literal notranslate"><span class="pre">big_maps</span></code> toplevel primitive is a
Micheline sequence whose elements have the form <code class="docutils literal notranslate"><span class="pre">Big_map</span> <span class="pre">&lt;i&gt;</span> <span class="pre">&lt;kty&gt;</span>
<span class="pre">&lt;vty&gt;</span> <span class="pre">{</span> <span class="pre">Elt</span> <span class="pre">&lt;k1&gt;</span> <span class="pre">&lt;v1&gt;;</span> <span class="pre">Elt</span> <span class="pre">&lt;k2&gt;</span> <span class="pre">&lt;v2&gt;;</span> <span class="pre">...}</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;i&gt;</span></code> is an
integer (the identifier of the big map), <code class="docutils literal notranslate"><span class="pre">&lt;kty&gt;</span></code> is the comparable
type of keys, <code class="docutils literal notranslate"><span class="pre">&lt;vty&gt;</span></code> is the type of values, each <code class="docutils literal notranslate"><span class="pre">&lt;ki&gt;</span></code> is of
type <code class="docutils literal notranslate"><span class="pre">&lt;kty&gt;</span></code> and each <code class="docutils literal notranslate"><span class="pre">&lt;vi&gt;</span></code> is of type <code class="docutils literal notranslate"><span class="pre">&lt;vty&gt;</span></code>. Each identifier
should appear at most once and the order in which big maps are
specified is irrelevant but each <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">Elt</span> <span class="pre">&lt;k1&gt;</span> <span class="pre">&lt;v1&gt;;</span> <span class="pre">Elt</span> <span class="pre">&lt;k2&gt;</span> <span class="pre">&lt;v2&gt;;</span>
<span class="pre">...}</span></code> description of big map contents should be given in increasing
order of keys.</p>
<p>The following example tests the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#instr-GET">GET</a>
instruction in the <a class="reference external" href="https://tezos.gitlab.io/michelson-reference/#type-big_map">big_map</a> case:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>big_maps { Big_map 4 string nat { Elt &quot;bar&quot; 42 } };
input { Stack_elt (big_map string nat) 4 };
code { PUSH string &quot;foo&quot;; GET };
output { Stack_elt (option nat) None }
</pre></div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="accounts.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Accounts and addresses</p>
      </div>
    </a>
    <a class="right-next"
       href="views.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">On-chain Views</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#semantics-of-smart-contracts-and-transactions">Semantics of smart contracts and transactions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smart-contract-call-semantics">Smart contract call semantics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transaction-semantics">Transaction semantics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#failures">Failures</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#language-semantics">Language semantics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rules-form-and-selection">Rules form and selection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-rules-big-step-form">Recursive rules (big step form)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format-of-patterns">Format of patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shortcuts">Shortcuts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-the-type-system-and-notations">Introduction to the type system and notations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-notations">Type notations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#meta-type-variables">Meta type variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#typing-rules">Typing rules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-normalization">Type normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#side-note">Side note</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-and-instructions">Types and instructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removed-instructions-and-types">Removed instructions and types</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#macros">Macros</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare">Compare</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fail">Fail</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-macros">Assertion macros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntactic-conveniences">Syntactic Conveniences</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concrete-syntax">Concrete syntax</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#constants">Constants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#differences-with-the-formal-notation">Differences with the formal notation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-program-structure">Main program structure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#annotations">Annotations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-annotations">Type annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variable-annotations">Variable annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#field-and-constructor-annotations">Field and constructor annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax">Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotations-and-macros">Annotations and macros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-variable-and-field-annotations-inferring">Automatic variable and field annotations inferring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#special-annotations">Special annotations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#entrypoints">Entrypoints</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-and-calling-entrypoints">Defining and calling entrypoints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-default-entrypoint">The <code class="docutils literal notranslate"><span class="pre">default</span></code> entrypoint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calling-entrypoints-from-michelson">Calling entrypoints from Michelson</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#json-syntax">JSON syntax</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#development-tools">Development tools</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#emacs-mode">Emacs mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-toplevel">Interactive toplevel</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#empty-contract">Empty contract</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-contract-with-entrypoints">Example contract with entrypoints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-contract-with-recursive-lambda">Example contract with recursive lambda</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multisig-contract">Multisig contract</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#views">Views</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#full-grammar">Full grammar</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-implementation">Reference implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tzt-a-syntax-extension-for-writing-unit-tests">TZT, a Syntax extension for writing unit tests</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mandatory-primitives">Mandatory primitives</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-primitives">Optional primitives</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-concrete-stacks">Syntax of concrete stacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#omitting-parts-of-the-output">Omitting parts of the output</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-normalization">Output normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-errors">Syntax of errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-concrete-operations">Syntax of concrete operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-other-contracts-specifications">Syntax of other contracts specifications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax-of-extra-big-maps-specifications">Syntax of extra big maps specifications</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nomadic Labs <contact@nomadic-labs.com>
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2018-2023, Nomadic Labs &lt;contact@nomadic-labs.com&gt;.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>