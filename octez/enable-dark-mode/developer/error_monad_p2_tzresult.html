
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Part 2: tzresult and Lwt-tzresult &#8212; Octez &amp; Protocol products documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=3301396a" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=eee15179"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KT3Z3X4Y82"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'developer/error_monad_p2_tzresult';</script>
    <script src="../_static/js/custom.js?v=e7f469e6"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Part 3: Advanced topics" href="error_monad_p3_advanced.html" />
    <link rel="prev" title="Part 1: result, Lwt, and Lwt-result" href="error_monad_p1_result.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="Octez & Protocol products documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.svg" class="logo__image only-dark" alt="Octez & Protocol products documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/tezos.html">Octez &amp; Protocol overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction/howtoget.html">Installing Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/cosign-verify.html">Verifying Octez Docker Images with Cosign</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/get_troubleshooting.html">Installation troubleshooting</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtouse.html">Getting started with Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtorun.html">Running Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/services.html">Setting up Octez Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/versioning.html">Octez &amp; Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/breaking_changes.html">BREAKING CHANGES</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez User manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-client.html">Setting up the client</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/client-configuration.html">Client Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/key-management.html">Key Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sandbox.html">Sandboxed mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/mockup.html">Mockup mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy.html">Proxy mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/light.html">Light mode</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-node.html">Setting up the node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/node-configuration.html">Node Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/multinetwork.html">Connecting to a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/history_modes.html">History modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/snapshots.html">Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy-server.html">Proxy server</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../user/node-monitoring.html">Monitoring an Octez Node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="openmetrics.html">Supported Open Metrics</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../user/teztale.html">Monitoring the consensus protocol</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../user/multisig.html">Built-in multisig contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/fa12.html">FA1.2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/logging.html">Logging features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/exits.html">Exit codes and signals</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez Reference manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../shell/the_big_picture.html">Octez Software Architecture</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/shell.html">The Octez Shell</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/validation.html">The validation subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/prevalidation.html">The Prevalidator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/storage.html">The storage layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/sync.html">Synchronisation heuristic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/p2p.html">The peer-to-peer layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/protocol_environment.html">Protocol Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/micheline.html">Micheline</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/data_availability_committees.html">Data Availability Committees</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/dal.html">Data Availability Layer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_overview.html">DAL overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_node.html">The DAL node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_bakers.html">Bakers &amp; the DAL</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/smart_rollup_node.html">Smart rollup node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/p2p_api.html">P2P message format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/rpc.html">Shell RPCs - Reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Protocol Reference Manuals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../active/index.html">Paris Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../active/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../active/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_issuance.html">Adaptive Issuance and Staking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../active/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/rpc.html">Paris RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../quebeca/index.html">Quebeca Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../quebeca/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebeca/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../quebeca/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quebeca/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quebeca/rpc.html">Quebeca RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../alpha/index.html">Alpha Dev Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../alpha/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../alpha/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/rpc.html">Alpha RPCs - Reference</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tezos developer Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="rpc.html">JSON/RPC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/errors.html">RPC Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/openapi.html">RPCs - OpenAPI reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in Octez releases</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../releases/releases.html">Release System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/version-20.html">Version 20.2</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../releases/history.html">Older Versions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-19.html">Version 19.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-18.html">Version 18.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-17.html">Version 17.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-16.html">Version 16.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-15.html">Version 15.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-14.html">Version 14.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-13.html">Version 13.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-12.html">Version 12.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-11.html">Version 11.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-10.html">Version 10.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-9.html">Version 9.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-8.html">Version 8.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-7.html">Version 7.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/january-2020.html">Mainnet January 2020</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/december-2019.html">Mainnet December 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/october-2019.html">Mainnet-Staging October 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/september-2019.html">Mainnet September 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/may-2019.html">Mainnet May 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/april-2019.html">Mainnet April 2019</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in protocol versions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../protocols/naming.html">Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/019_paris.html">Protocol Paris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/021_quebeca.html">Protocol Quebeca</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/alpha.html">Protocol Alpha</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../protocols/history.html">Older Protocols</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../protocols/018_oxford.html">Protocol Oxford</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/017_nairobi.html">Protocol Nairobi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/016_mumbai.html">Protocol Mumbai</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/015_lima.html">Protocol Lima</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/014_kathmandu.html">Protocol Kathmandu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/013_jakarta.html">Protocol Jakarta</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/012_ithaca.html">Protocol Ithaca</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/011_hangzhou.html">Protocol Hangzhou</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/010_granada.html">Protocol Granada</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/009_florence.html">Protocol Florence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/008_edo.html">Protocol Edo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/007_delphi.html">Protocol Delphi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/006_carthage.html">Protocol Carthage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/005_babylon.html">Protocol Babylon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/004_Pt24m4xi.html">Protocol Athens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/003_PsddFKi3.html">Protocol 003_PsddFKi3</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="contributing_index.html">How to contribute</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="contributing.html">How to contribute to Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing-adding-a-new-opam-dependency.html">How to add or update opam dependencies</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="merge_team.html">Octez Merge Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="guidelines.html">Documentation and coding guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="repository_scope.html">Scope of the Octez repository</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="programming.html">Programming tutorials</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gadt.html">Generalized Algebraic Data Types (GADTs)</a></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="error_monad.html">The Error Monad</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="error_monad_p1_result.html">Part 1: <code class="docutils literal notranslate"><span class="pre">result</span></code>, Lwt, and Lwt-<code class="docutils literal notranslate"><span class="pre">result</span></code></a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Part 2: <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> and Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="error_monad_p3_advanced.html">Part 3: Advanced topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="error_monad_p4_appendices.html">Part 4: Appendices</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="clic.html">The <code class="docutils literal notranslate"><span class="pre">clic</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_encoding.html">The <code class="docutils literal notranslate"><span class="pre">data_encoding</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_logging_framework.html">Using The Event Logging Framework</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="testing_index.html">Testing in Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Overview of Testing in Octez</a></li>
<li class="toctree-l2"><a class="reference internal" href="ppx_expect.html">Ppx_expect</a></li>
<li class="toctree-l2"><a class="reference internal" href="tezt.html">Tezt: OCaml Tezos Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="long-tezts.html">Tezt: Long Tests and Performance Regression Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="alcotezt.html">Alcotezt: An Alcotest Compatibility Wrapper for Tezt</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_testing_legacy_code.html">Making legacy code unit-testable</a></li>
<li class="toctree-l2"><a class="reference internal" href="proposal_testing.html">How to Test a Protocol Proposal</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="maintaining.html">Maintaining</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="entering_alpha.html">How to start reading protocol Alpha</a></li>
<li class="toctree-l2"><a class="reference internal" href="michelson_instructions.html">Adding a new instruction to Michelson language</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol_release_checklist.html">Protocol Release Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto-freeze-protocols.html">How to Freeze Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol_environment_upgrade.html">Adding a new protocol environment</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Documenting</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="tools.html">Platform Development tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="profiling.html">Profiling the Octez node</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="snoop.html">Benchmarking with Snoop</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="snoop_arch.html">Architecture of <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="snoop_tutorial.html">Snoop usage tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="snoop_example.html">In-depth usage example: more control over your benchmark</a></li>
<li class="toctree-l3"><a class="reference internal" href="tezos_micheline_rewriting.html">Rewriting Micheline with <code class="docutils literal notranslate"><span class="pre">tezos-micheline-rewriting</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="snoop_interpreter.html">Snoop and the Michelson Interpreter</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="time_measurement_ppx.html">Time measurement PPX</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_environment.html">Python Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="pre_commit_hook.html">Pre-Commit Hook</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="encodings.html">Encodings</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="merkle-proof-encoding-formats.html">Merkle Proof Encoding Formats</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v1-tree32.html">V1 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v1-tree2.html">V1 for Tree2</a></li>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v2-tree32.html">V2 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v2-tree2.html">V2 for Tree2</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api-inline.html">OCaml APIs - Reference</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-gitlab"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-gitlab"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos/-/issues/new?issue[title]=Issue%20on%20page%20%2Fdeveloper/error_monad_p2_tzresult.html&issue[description]=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Part 2: tzresult and Lwt-tzresult</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#error-trace-and-tzresult"><code class="docutils literal notranslate"><span class="pre">error</span></code>, <code class="docutils literal notranslate"><span class="pre">trace</span></code>, and <code class="docutils literal notranslate"><span class="pre">tzresult</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generic-failing">Generic failing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#declaring-and-registering-errors">Declaring and registering <code class="docutils literal notranslate"><span class="pre">error</span></code>s</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-6">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-result-syntax-s-tz-extensions">The <code class="docutils literal notranslate"><span class="pre">Result_syntax</span></code>’s <code class="docutils literal notranslate"><span class="pre">tz</span></code> extensions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-7">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-lwt-result-syntax-s-tz-extensions">The <code class="docutils literal notranslate"><span class="pre">Lwt_result_syntax</span></code>’s <code class="docutils literal notranslate"><span class="pre">tz</span></code> extensions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-8">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lifting">Lifting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing">Tracing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#meta-commentary">META COMMENTARY</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="part-2-tzresult-and-lwt-tzresult">
<h1>Part 2: <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> and Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code><a class="headerlink" href="#part-2-tzresult-and-lwt-tzresult" title="Link to this heading">#</a></h1>
<p>This is Part 2 of 4 of the <a class="reference internal" href="error_monad.html"><span class="doc">The Error Monad</span></a> tutorial.</p>
<section id="error-trace-and-tzresult">
<h2><code class="docutils literal notranslate"><span class="pre">error</span></code>, <code class="docutils literal notranslate"><span class="pre">trace</span></code>, and <code class="docutils literal notranslate"><span class="pre">tzresult</span></code><a class="headerlink" href="#error-trace-and-tzresult" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">error</span></code> type is an <a class="reference external" href="https://ocaml.org/manual/extensiblevariants.html">extensible variant
type</a> defined in
the <code class="docutils literal notranslate"><span class="pre">Error_monad</span></code> module.</p>
<p>Each part of the Octez source code can extend it to include some errors
relevant to that part. E.g., the p2p layer adds
<code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">error</span> <span class="pre">+=</span> <span class="pre">Connection_refused</span></code> whilst the store layer adds
<code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">error</span> <span class="pre">+=</span> <span class="pre">Snapshot_file_not_found</span> <span class="pre">of</span> <span class="pre">string</span></code>. More information on
errors is presented later.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">'error</span> <span class="pre">trace</span></code> type is a data structure dedicated to holding
<code class="docutils literal notranslate"><span class="pre">error</span></code>s. It is exported by the <code class="docutils literal notranslate"><span class="pre">Error_monad</span></code> module. It is only
ever instantiated as <code class="docutils literal notranslate"><span class="pre">error</span> <span class="pre">trace</span></code>. It can accumulate multiple errors,
which helps present information about the context in which an error
occurs. More information on traces is presented later.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">tzresult</span></code> type is an alias for <code class="docutils literal notranslate"><span class="pre">('a,</span> <span class="pre">error</span> <span class="pre">trace)</span> <span class="pre">result</span></code>.
It is used in Octez to represent the possibility of failure in a generic
way. Using <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> is a trade-off. You should only use it in
situations where the pros outweigh the cons.</p>
<p>Pros:</p>
<ul class="simple">
<li><p>A generic error that is the same everywhere means that the
binding operator <code class="docutils literal notranslate"><span class="pre">let*</span></code> can be used everywhere without having to
convert errors to a common type.</p></li>
<li><p>Traces allow you to easily add
context to an existing error (see how later).</p></li>
</ul>
<p>Cons:</p>
<ul class="simple">
<li><p>A generic wrapper around generic errors that cannot be
meaningfully matched against (although the pattern exists in legacy
code).</p></li>
<li><p>Type information about errors is coarse-grained to the point of
being meaningless (e.g., there is no exhaustiveness check when
matching).</p></li>
<li><p>Registration is syntactically heavy and requires care (see
below).</p></li>
</ul>
<p>In general, the type <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> is mostly useful at a high-enough
level of abstraction and in the outermost interface of a module or even
package (i.e., when exposing errors to callers that do not have access
to internal implementation details).</p>
</section>
<section id="generic-failing">
<h2>Generic failing<a class="headerlink" href="#generic-failing" title="Link to this heading">#</a></h2>
<p>The easiest way to return a <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> is via functions provided by
the <code class="docutils literal notranslate"><span class="pre">Error_monad</span></code>. These functions are located at the top-level of the
module, as such they are available, unqualified, everywhere in the code.
They do not even require the syntax modules to be open.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">error_with</span></code> is for formatting a string and wrapping it inside an
<code class="docutils literal notranslate"><span class="pre">error</span></code> inside a <code class="docutils literal notranslate"><span class="pre">trace</span></code> inside an <code class="docutils literal notranslate"><span class="pre">Error</span></code>. E.g.,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let retry original_limit (f : unit -&gt; unit tzresult) =
  let rec retry limit f
    if limit &lt; 0 then
      error_with &quot;retried %d times&quot; original_limit
    else
      match f () with
      | Error _ -&gt; retry (limit - 1) f
      | Ok () -&gt; Ok ()
  in
  retry original_limit f
</pre></div>
</div>
<p>You can use all the formatting percent-escapes from the <a class="reference external" href="https://ocaml.org/api/Format.html">Format
module</a>. However, you should
generally keep the message on a single line so that it can be printed
nicely in logs.</p>
<p>Formally, <code class="docutils literal notranslate"><span class="pre">error_with</span></code> has type
<code class="docutils literal notranslate"><span class="pre">('a,</span> <span class="pre">Format.formatter,</span> <span class="pre">unit,</span> <span class="pre">'b</span> <span class="pre">tzresult)</span> <span class="pre">format4</span> <span class="pre">-&gt;</span> <span class="pre">'a</span></code>. This is
somewhat inscrutable. Suffice to say: it is used with a format string
and returns an <code class="docutils literal notranslate"><span class="pre">Error</span></code>.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">error_with_exn</span> <span class="pre">:</span> <span class="pre">exn</span> <span class="pre">-&gt;</span> <span class="pre">'a</span> <span class="pre">tzresult</span></code> is for wrapping an exception
inside an <code class="docutils literal notranslate"><span class="pre">error</span></code> inside a <code class="docutils literal notranslate"><span class="pre">trace</span></code> inside an <code class="docutils literal notranslate"><span class="pre">Error</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let media_type_kind s =
  match s with
  | &quot;json&quot; | &quot;bson&quot; -&gt; Ok `Json
  | &quot;octet-stream&quot; -&gt; Ok `Binary
  | _ -&gt; error_with_exn Not_found
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">failwith</span></code> is for formatting a string and wrapping it inside an
<code class="docutils literal notranslate"><span class="pre">error</span></code> inside a <code class="docutils literal notranslate"><span class="pre">trace</span></code> inside an <code class="docutils literal notranslate"><span class="pre">Error</span></code> inside a promise.
E.g.,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>failwith &quot;Cannot read file %s (ot %s)&quot; file_name (Unix.error_message error)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">failwith</span></code> is similar to <code class="docutils literal notranslate"><span class="pre">error_with</span></code> but for the combined
Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code> monad. Again the type
(<code class="docutils literal notranslate"><span class="pre">('a,</span> <span class="pre">Format.formatter,</span> <span class="pre">unit,</span> <span class="pre">'b</span> <span class="pre">tzresult</span> <span class="pre">Lwt.t)</span> <span class="pre">format4</span> <span class="pre">-&gt;</span> <span class="pre">'a</span></code>)
is inscrutable, but again usage is as simple as a formatting.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">fail_with_exn</span></code> is for wrapping an exception inside an <code class="docutils literal notranslate"><span class="pre">error</span></code>
inside a <code class="docutils literal notranslate"><span class="pre">trace</span></code> inside an <code class="docutils literal notranslate"><span class="pre">Error</span></code> inside a promise. E.g.,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>fail_with_exn Not_found
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">fail_with_exn</span></code> is similar to <code class="docutils literal notranslate"><span class="pre">error_with_exn</span></code> but for the
combined Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code> monad.</p>
</li>
</ul>
<p>These functions are useful as a way to fail with generic errors that
carry a simple payload. The next section is about using custom errors
with more content.</p>
<section id="exercises">
<span id="exercises-5"></span><h3>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Write a function <code class="docutils literal notranslate"><span class="pre">tzresult_of_option</span> <span class="pre">:</span> <span class="pre">'a</span> <span class="pre">option</span> <span class="pre">-&gt;</span> <span class="pre">'a</span> <span class="pre">tzresult</span></code>
which replaces <code class="docutils literal notranslate"><span class="pre">None</span></code> with a generic failure of your choosing.</p></li>
<li><p>Write a function <code class="docutils literal notranslate"><span class="pre">catch</span> <span class="pre">:</span> <span class="pre">(unit</span> <span class="pre">-&gt;</span> <span class="pre">'a)</span> <span class="pre">-&gt;</span> <span class="pre">'a</span> <span class="pre">tzresult</span></code> which wraps
any exception raised during the evaluation of the function call.</p></li>
</ul>
</section>
</section>
<section id="declaring-and-registering-errors">
<h2>Declaring and registering <code class="docutils literal notranslate"><span class="pre">error</span></code>s<a class="headerlink" href="#declaring-and-registering-errors" title="Link to this heading">#</a></h2>
<p>On many occasions, <code class="docutils literal notranslate"><span class="pre">error_with</span></code> and friends (see above) are not
sufficient: you may want your error to carry more information than can
be conveyed in a simple string or a simple exception. When you do, you
need a custom error. You must first <em>declare</em> and then <em>register</em> an
<code class="docutils literal notranslate"><span class="pre">error</span></code>.</p>
<p>To declare a new error you simply extend the <code class="docutils literal notranslate"><span class="pre">error</span></code> type. Remember
that the <code class="docutils literal notranslate"><span class="pre">error</span></code> type is defined and exported to the rest of the code
by the <code class="docutils literal notranslate"><span class="pre">Error_monad</span></code> module. You extend it with the <code class="docutils literal notranslate"><span class="pre">+=</span></code> syntax:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type error +=
  Invalid_configuration of { expected: string; got: string; line: int }
</pre></div>
</div>
<p>The registration function <code class="docutils literal notranslate"><span class="pre">register_error_kind</span></code> is also part of the
<code class="docutils literal notranslate"><span class="pre">Error_monad</span></code> module. You <em>register</em> a new error by calling this
function.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let () =
  register_error_kind
    `Temporary
    ~id:&quot;invalid_configuration&quot;
    ~title:&quot;Invalid configuration&quot;
    ~description:&quot;The configuration is invalid.&quot;
    ~pp:(fun f (expected, got, line) -&gt;
      Format.fprintf f
        &quot;When parsing configuration expected %s but got %s (at line %d)&quot;
        expected got line
    )
    Data_encoding.(
      obj3
        (req &quot;expected&quot; string)
        (req &quot;got&quot; string)
        (req &quot;line&quot; int31))
    (function
      | Invalid_configuration {expected; got; line} -&gt;
        Some (expected, got, line)
      | _ -&gt; None)
    (fun (expected, got, line) -&gt; Invalid_configuration {expected; got; line})
</pre></div>
</div>
<p>Note that you <strong>MUST</strong> register the errors you declare. Failure to do so
can lead to serious issues.</p>
<p>The arguments for the <code class="docutils literal notranslate"><span class="pre">register_error_kind</span></code> function are as follows: -
category (<code class="docutils literal notranslate"><span class="pre">`Temporary</span></code>): the category argument is meaningless
in the shell, just use <code class="docutils literal notranslate"><span class="pre">`Temporary</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code>: a short string containing only characters that do not need escaping
(<code class="docutils literal notranslate"><span class="pre">[a-zA-Z0-9._-]</span></code>), must be unique across the whole program.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">title</span></code>: a short human readable string.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">description</span></code>: a longer human readable string.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pp</span></code>: a pretty-printing function carrying enough information for a full
error message for the user. Note that the function does not receive the error,
instead it receives the <em>projected payload of the error</em> (here a 3-tuple
<code class="docutils literal notranslate"><span class="pre">(expected,</span> <span class="pre">got,</span> <span class="pre">line)</span></code>.</p></li>
<li><p>encoding: an encoding for the projected payload of the error.</p></li>
<li><p>projection: a partial function that matches the specific error
(out of all of them) and return its projected payload. This function always
has the form
<code class="docutils literal notranslate"><span class="pre">function</span> <span class="pre">|</span> <span class="pre">&lt;the</span> <span class="pre">error</span> <span class="pre">you</span> <span class="pre">are</span> <span class="pre">returning&gt;</span> <span class="pre">-&gt;</span> <span class="pre">Some</span> <span class="pre">&lt;projected</span> <span class="pre">payload&gt;</span> <span class="pre">|</span> <span class="pre">_</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code>.</p></li>
<li><p>injection: a function that takes the projected payload and constructs
the error out of it.</p></li>
</ul>
<p>For errors that do not carry information (e.g.,
<code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">error</span> <span class="pre">+=</span> <span class="pre">Size_limit_exceeded</span></code>), the projected payload of the
error is unit.</p>
<p>It is customary to either register the error immediately after the error
is declared or to register multiple errors immediately after declaring
them all. In some cases, the registration happens in a separate module.
Either way, registration of declared error is compulsory.</p>
<section id="exercises-6">
<span id="id1"></span><h3>Exercises<a class="headerlink" href="#exercises-6" title="Link to this heading">#</a></h3>
<ul>
<li><p>Register the following error</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(** [Size_limit_exceeded {limit; current_size; attempted_insertion}] is used
    when an insertion into the global table of known blocks would cause the
    size of the table to exceed the limit. The field [limit] holds the
    maximum allowed size, the field [current_size] holds the current size of
    the table and [attempted_insertion] holds the size of the element that
    was passed to the insertion function. *)
type error += Size_limit_exceeded {
  limit: int;
  current_size: int;
  attempted_insertion: int
}
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="the-result-syntax-s-tz-extensions">
<h2>The <code class="docutils literal notranslate"><span class="pre">Result_syntax</span></code>’s <code class="docutils literal notranslate"><span class="pre">tz</span></code> extensions<a class="headerlink" href="#the-result-syntax-s-tz-extensions" title="Link to this heading">#</a></h2>
<p>Remember that <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">tzresult</span></code> is a special case of <code class="docutils literal notranslate"><span class="pre">('a,</span> <span class="pre">'e)</span> <span class="pre">result</span></code>.
Specifically, a special case where <code class="docutils literal notranslate"><span class="pre">'e</span></code> is <code class="docutils literal notranslate"><span class="pre">error</span> <span class="pre">trace</span></code>.
Consequently, you can handle <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> values using the
<code class="docutils literal notranslate"><span class="pre">Result_syntax</span></code> module.</p>
<p>The module <code class="docutils literal notranslate"><span class="pre">Result_syntax</span></code> exports a few functions dedicated to handling
<code class="docutils literal notranslate"><span class="pre">tzresult</span></code>. These functions were omitted from Part 1.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tzfail:</span> <span class="pre">'e</span> <span class="pre">-&gt;</span> <span class="pre">('a,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span></code>: the expression <code class="docutils literal notranslate"><span class="pre">tzfail</span> <span class="pre">e</span></code>
wraps <code class="docutils literal notranslate"><span class="pre">e</span></code> in a <code class="docutils literal notranslate"><span class="pre">trace</span></code> inside an <code class="docutils literal notranslate"><span class="pre">Error</span></code>. When <code class="docutils literal notranslate"><span class="pre">e</span></code> is of type
<code class="docutils literal notranslate"><span class="pre">error</span></code> as is the case throughout Octez, <code class="docutils literal notranslate"><span class="pre">tzfail</span> <span class="pre">e</span></code> is of type
<code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">tzresult</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">and*</span></code>: a binding operator alias for <code class="docutils literal notranslate"><span class="pre">tzboth</span></code> (see below). You can
use it with <code class="docutils literal notranslate"><span class="pre">let*</span></code> the same way you use <code class="docutils literal notranslate"><span class="pre">and</span></code> with <code class="docutils literal notranslate"><span class="pre">let</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let apply_triple f (x, y, z) =
  let open Result_syntax in
  let* u = f x
  and* v = f y
  and* w = f z
  in
  return (u, v, w)
</pre></div>
</div>
<p>When you use <code class="docutils literal notranslate"><span class="pre">and*</span></code>, the bound results (<code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">y</span></code>, and
<code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">z</span></code>) are all evaluated fully, regardless of the success/failure
of the others. The expression which follows the <code class="docutils literal notranslate"><span class="pre">in</span></code>
(<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">..</span></code>) is evaluated if all the bound results are successful.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">tzboth</span> <span class="pre">:</span> <span class="pre">('a,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">-&gt;</span> <span class="pre">('b,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">-&gt;</span> <span class="pre">('a</span> <span class="pre">*</span> <span class="pre">'b,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span></code>:
the expression <code class="docutils literal notranslate"><span class="pre">both</span> <span class="pre">a</span> <span class="pre">b</span></code> is <code class="docutils literal notranslate"><span class="pre">Ok</span></code> if both <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are
<code class="docutils literal notranslate"><span class="pre">Ok</span></code> and <code class="docutils literal notranslate"><span class="pre">Error</span></code> otherwise`.</p>
<p>Note that unlike <code class="docutils literal notranslate"><span class="pre">both</span></code>, the type of errors
(<code class="docutils literal notranslate"><span class="pre">error</span> <span class="pre">trace</span></code>) is the same on both the argument and return side of
this function: the traces are combined automatically. This remark
applies to the <code class="docutils literal notranslate"><span class="pre">tzall</span></code> and <code class="docutils literal notranslate"><span class="pre">tzjoin</span></code> (see below) as well.</p>
<p>The stability of the return type is what allows this syntax module to
include an <code class="docutils literal notranslate"><span class="pre">and*</span></code> binding operator.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">tzall</span> <span class="pre">:</span> <span class="pre">('a,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">list</span> <span class="pre">-&gt;</span> <span class="pre">('a</span> <span class="pre">list,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span></code>:
the function <code class="docutils literal notranslate"><span class="pre">tzall</span></code> is a generalisation of <code class="docutils literal notranslate"><span class="pre">tzboth</span></code> from tuples to
lists.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tzjoin</span> <span class="pre">:</span> <span class="pre">(unit,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">list</span> <span class="pre">-&gt;</span> <span class="pre">(unit,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span></code>:
the function <code class="docutils literal notranslate"><span class="pre">tzjoin</span></code> is a specialisation of <code class="docutils literal notranslate"><span class="pre">tzall</span></code> for list of
unit-typed expressions (typically, for side-effects).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">and+</span></code> is a binding operator similar to <code class="docutils literal notranslate"><span class="pre">and*</span></code> but for use with
<code class="docutils literal notranslate"><span class="pre">let+</span></code> rather than <code class="docutils literal notranslate"><span class="pre">let*</span></code>.</p></li>
</ul>
<section id="exercises-7">
<span id="id2"></span><h3>Exercises<a class="headerlink" href="#exercises-7" title="Link to this heading">#</a></h3>
<ul>
<li><p>What is the difference between the two following functions?</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let twice f =
  let open Result_syntax in
  let* () = f () in
  let* () = f () in
  return_unit
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let twice f =
  let open Result_syntax in
  let* () = f ()
  and* () = f ()
  in
  return_unit
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="the-lwt-result-syntax-s-tz-extensions">
<h2>The <code class="docutils literal notranslate"><span class="pre">Lwt_result_syntax</span></code>’s <code class="docutils literal notranslate"><span class="pre">tz</span></code> extensions<a class="headerlink" href="#the-lwt-result-syntax-s-tz-extensions" title="Link to this heading">#</a></h2>
<p>In the same way <code class="docutils literal notranslate"><span class="pre">result</span></code> can be combined with Lwt, <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> can
also be combined with Lwt. And in the same way that <code class="docutils literal notranslate"><span class="pre">Result_syntax</span></code> exports a
few <code class="docutils literal notranslate"><span class="pre">tz</span></code>-specific extensions, <code class="docutils literal notranslate"><span class="pre">Lwt_result_syntax</span></code> exports a few Lwt+``tz``
specific extensions.</p>
<p>There are possibly too many parallels to keep track of, so the diagram
below might help.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;a  -----------&gt; (&#39;a, &#39;e) result ------------&gt; &#39;a tzresult
 |                        |                         |
 |                        |                         |
 V                        V                         V
&#39;a Lwt.t ------&gt; (&#39;a, &#39;e) result Lwt.t ------&gt; &#39;a tzresult Lwt.t
</pre></div>
</div>
<p>Anyway, the <code class="docutils literal notranslate"><span class="pre">Lwt_result_syntax</span></code> module exports a few functions dedicated to
handling Lwt+``tzresult``. These functions were omitted from Part 1.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tzfail:</span> <span class="pre">'e</span> <span class="pre">-&gt;</span> <span class="pre">('a,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span></code>: the expression
<code class="docutils literal notranslate"><span class="pre">tzfail</span> <span class="pre">e</span></code> wraps <code class="docutils literal notranslate"><span class="pre">e</span></code> in a <code class="docutils literal notranslate"><span class="pre">trace</span></code> inside an <code class="docutils literal notranslate"><span class="pre">Error</span></code> inside a
promise. When <code class="docutils literal notranslate"><span class="pre">e</span></code> is of type <code class="docutils literal notranslate"><span class="pre">error</span></code> as is the case throughout
Octez, <code class="docutils literal notranslate"><span class="pre">tzfail</span> <span class="pre">e</span></code> is of type <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">tzresult</span> <span class="pre">Lwt.t</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">and*</span></code>: a binding operator alias for <code class="docutils literal notranslate"><span class="pre">tzboth</span></code>. You can use it with
<code class="docutils literal notranslate"><span class="pre">let*</span></code> the same way you use <code class="docutils literal notranslate"><span class="pre">and</span></code> with <code class="docutils literal notranslate"><span class="pre">let</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let apply_triple f (x, y, z) =
  let open Lwt_result_syntax in
  let* u = f x
  and* v = f y
  and* w = f z
  in
  return (u, v, w)
</pre></div>
</div>
<p>When you use <code class="docutils literal notranslate"><span class="pre">and*</span></code>, the bound promises (<code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">y</span></code>, and
<code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">z</span></code>) are evaluated concurrently, and the expression which follows
the <code class="docutils literal notranslate"><span class="pre">in</span></code> (<code class="docutils literal notranslate"><span class="pre">return</span>&#160;&#160; <span class="pre">..</span></code>) is evaluated once all the bound promises
have all resolved but only if all of them resolve successfully.</p>
<p>Note how this <code class="docutils literal notranslate"><span class="pre">and*</span></code> binding operator inherits the properties of
both <code class="docutils literal notranslate"><span class="pre">Lwt_syntax.(</span> <span class="pre">and*</span> <span class="pre">)</span></code> and <code class="docutils literal notranslate"><span class="pre">Result_syntax.(</span> <span class="pre">and*</span> <span class="pre">)</span></code>.
Specifically, the promises are evaluated concurrently and the
expression which follows the <code class="docutils literal notranslate"><span class="pre">in</span></code> is evaluated only if all the
bound promises have successfully resolved. These two orthogonal
properties are combined. This remark also applies to <code class="docutils literal notranslate"><span class="pre">tzboth</span></code>,
<code class="docutils literal notranslate"><span class="pre">tzall</span></code>, <code class="docutils literal notranslate"><span class="pre">tzjoin</span></code> and <code class="docutils literal notranslate"><span class="pre">and+</span></code> below.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">tzboth</span> <span class="pre">:</span> <span class="pre">('a,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span> <span class="pre">-&gt;</span> <span class="pre">('b,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span> <span class="pre">-&gt;</span> <span class="pre">('a</span> <span class="pre">*</span> <span class="pre">'b,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span></code>:
the expression <code class="docutils literal notranslate"><span class="pre">tzboth</span> <span class="pre">p</span> <span class="pre">q</span></code> is a promise that resolves once both
<code class="docutils literal notranslate"><span class="pre">p</span></code> and <code class="docutils literal notranslate"><span class="pre">q</span></code> have resolved. It resolves to <code class="docutils literal notranslate"><span class="pre">Ok</span></code> if both <code class="docutils literal notranslate"><span class="pre">p</span></code>
and <code class="docutils literal notranslate"><span class="pre">q</span></code> do, and to <code class="docutils literal notranslate"><span class="pre">Error</span></code> otherwise`.</p>
<p>Note that unlike <code class="docutils literal notranslate"><span class="pre">Lwt_result_syntax.both</span></code>, the type of errors
(<code class="docutils literal notranslate"><span class="pre">error</span> <span class="pre">trace</span></code>) is the same on both the argument and return side of
this function: the trace are combined automatically. This remark
applies to the <code class="docutils literal notranslate"><span class="pre">tzall</span></code> and <code class="docutils literal notranslate"><span class="pre">tzjoin</span></code> (see below) as well.</p>
<p>The stability of the return type is what allows this syntax module to
include an <code class="docutils literal notranslate"><span class="pre">and*</span></code> binding operator.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">tzall</span> <span class="pre">:</span> <span class="pre">('a,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span> <span class="pre">list</span> <span class="pre">-&gt;</span> <span class="pre">('a</span> <span class="pre">list,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span></code>:
the function <code class="docutils literal notranslate"><span class="pre">tzall</span></code> is a generalisation of <code class="docutils literal notranslate"><span class="pre">tzboth</span></code> from tuples to
lists.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">join</span> <span class="pre">:</span> <span class="pre">(unit,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span> <span class="pre">list</span> <span class="pre">-&gt;</span> <span class="pre">(unit,</span> <span class="pre">'e</span> <span class="pre">trace)</span> <span class="pre">result</span> <span class="pre">Lwt.t</span></code>:
the function <code class="docutils literal notranslate"><span class="pre">tzjoin</span></code> is a specialisation of <code class="docutils literal notranslate"><span class="pre">tzall</span></code> for lists of
unit-typed expressions (typically, for side-effects).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">and+</span></code> is a binding operator similar to <code class="docutils literal notranslate"><span class="pre">and*</span></code> but for use with
<code class="docutils literal notranslate"><span class="pre">let+</span></code> rather than <code class="docutils literal notranslate"><span class="pre">let*</span></code>.</p></li>
</ul>
<section id="exercises-8">
<span id="id3"></span><h3>Exercises<a class="headerlink" href="#exercises-8" title="Link to this heading">#</a></h3>
<ul>
<li><p>Rewrite this function to use the <code class="docutils literal notranslate"><span class="pre">Lwt_result_syntax</span></code> module and
no other syntax module.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let apply_tuple (f, g) (x, y) =
  let open Lwt_syntax in
  let* u = f x
  and* v = g y
  in
  let r = Result_syntax.tzboth u v in
  return r
</pre></div>
</div>
</li>
<li><p>Write the implementation for</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(** [map f [x1; x2; ..]] is [[y1; y2; ..]] where [y1] is the successful
    result of [f x1], [y2] is the successful result of [f x2], etc. If [f]
    fails on any of the inputs, returns an [Error] instead. Either way, all
    the calls to [f] on all the inputs are evaluated concurrently and all
    the calls to [f] have resolved before the whole promise resolves. *)
val map : (&#39;a -&gt; &#39;b tzresult Lwt.t) -&gt; &#39;a list -&gt; &#39;b list tzresult
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="lifting">
<span id="lifting-1"></span><h2>Lifting<a class="headerlink" href="#lifting" title="Link to this heading">#</a></h2>
<p>When you are working with promises of <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> (i.e., within
Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code>), you may occasionally need to call functions that
return a simple promise (i.e., within Lwt-only) or a simple <code class="docutils literal notranslate"><span class="pre">tzresult</span></code>
(i.e., within <code class="docutils literal notranslate"><span class="pre">tzresult</span></code>-only).</p>
<p>Because <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> is a special case of <code class="docutils literal notranslate"><span class="pre">result</span></code>, you can use the same
operators <code class="docutils literal notranslate"><span class="pre">let*!</span></code> and <code class="docutils literal notranslate"><span class="pre">let*?</span></code> as presented in Part 1.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let*! x = plain_lwt_function foo bar in
let*? x = plain_result_function foo bar in
..
</pre></div>
</div>
</section>
<section id="tracing">
<h2>Tracing<a class="headerlink" href="#tracing" title="Link to this heading">#</a></h2>
<p>Remember that a trace is a data structure specifically designed for
errors.</p>
<p>Traces have two roles:</p>
<ul class="simple">
<li><p>As a programmer you benefit from the traces’ ability to combine
automatically. Indeed, this feature of traces makes the <code class="docutils literal notranslate"><span class="pre">and*</span></code> binding
operators possible which can simplify some tasks such as concurrent
evaluation of multiple <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> promises.</p></li>
<li><p>For the user, traces combine multiple errors, allowing for high-level
errors (e.g., <code class="docutils literal notranslate"><span class="pre">Cannot_bootstrap_node</span></code>) to be paired with low-level
errors (e.g., <code class="docutils literal notranslate"><span class="pre">Unix_error</span> <span class="pre">EADDRINUSE</span></code>). When used correctly, this
can help create more informative error messages which, in turn, can
help debugging.</p></li>
</ul>
<p>Tracing primitives are declared in the <code class="docutils literal notranslate"><span class="pre">Error_monad</span></code> module. As such,
they are available almost everywhere in the code. They should be used
whenever an error passes from one component (say the p2p layer, or the
storage layer) into another (say the shell).</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">record_trace</span> <span class="pre">err</span> <span class="pre">r</span></code> leaves <code class="docutils literal notranslate"><span class="pre">r</span></code> untouched if it evaluates to
<code class="docutils literal notranslate"><span class="pre">Ok</span></code>. Otherwise, it adds the error <code class="docutils literal notranslate"><span class="pre">err</span></code> to the trace carried in
<code class="docutils literal notranslate"><span class="pre">Error</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let check_hashes head block operation =
  let open Result_syntax in
  let* () =
    record_trace (Invalid_hash { kind: &quot;head&quot;; hash: head}) @@
    check_hash chain
  in
  let* () =
    record_trace (Invalid_hash { kind: &quot;block&quot;; hash: block}) @@
    check_hash block
  in
  let* () =
    record_trace (Invalid_hash { kind: &quot;operation&quot;; hash: operation}) @@
    check_hash operation
  in
  return_unit
</pre></div>
</div>
<p>In this example a failure from any of the calls to <code class="docutils literal notranslate"><span class="pre">check_hash</span></code>
will be given context that helps with understanding the source of the
error.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">record_trace_eval</span></code> is a lazy version of <code class="docutils literal notranslate"><span class="pre">record_trace</span></code> in that
the error added to the trace is only evaluated if needed. More
formally <code class="docutils literal notranslate"><span class="pre">record_trace_eval</span> <span class="pre">make_err</span> <span class="pre">r</span></code> leaves <code class="docutils literal notranslate"><span class="pre">r</span></code> untouched if
it evaluates to <code class="docutils literal notranslate"><span class="pre">Ok</span></code>. Otherwise it calls <code class="docutils literal notranslate"><span class="pre">make_err</span></code> and adds the
returned error onto the trace.</p>
<p>You should use the strict <code class="docutils literal notranslate"><span class="pre">record_trace</span></code> version when the error you
are adding to the trace is an immediate value (e.g., <code class="docutils literal notranslate"><span class="pre">Overflow</span></code>) or
a constructor with immediate values (e.g., <code class="docutils literal notranslate"><span class="pre">Invalid_file</span> <span class="pre">name</span></code>).
You should use the lazy <code class="docutils literal notranslate"><span class="pre">record_trace_eval</span></code> version when the error
you are adding to the trace requires computation to generate (e.g.,
if it requires formatting or querying).</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">trace</span></code> is the Lwt-aware variant of <code class="docutils literal notranslate"><span class="pre">record_trace</span></code>. More
formally, <code class="docutils literal notranslate"><span class="pre">trace</span> <span class="pre">err</span> <span class="pre">p</span></code> leaves <code class="docutils literal notranslate"><span class="pre">p</span></code> untouched if it resolves
successfully, otherwise it adds the error <code class="docutils literal notranslate"><span class="pre">err</span></code> to the trace
carried by the unsuccessful resolve.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>let get_data_and_gossip_it () =
  let open Lwt_result_syntax in
  let* data =
    trace Cannot_get_random_data_from_storage @@
    Storage.get_random_data ()
  in
  let* number_of_peers =
    trace Cannot_gossip_data @@
    P2p.gossip data
  in
  return (data, number_of_peers)
</pre></div>
</div>
<p>In this example, low-level storage errors are given more context by
the <code class="docutils literal notranslate"><span class="pre">Cannot_get_random_data_from_storage</span></code> error. Similarly,
low-level p2p errors are given more context by the
<code class="docutils literal notranslate"><span class="pre">Cannot_gossip_data</span></code> error. This is important because both the
storage and the p2p layer may suffer from similar system issues (such
as file-descriptor exhaustion).</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">trace_eval</span></code> is the lazy version of <code class="docutils literal notranslate"><span class="pre">trace</span></code>, or, equivalently,
the Lwt-aware version of <code class="docutils literal notranslate"><span class="pre">record_trace_eval</span></code>.</p>
<p>You should use the strict <code class="docutils literal notranslate"><span class="pre">trace</span></code> version when the error you are
adding is immediate or a constructor with immediate values. You
should use the lazy <code class="docutils literal notranslate"><span class="pre">trace_eval</span></code> version when the error you are
adding requires computation to generate.</p>
</li>
</ul>
<p>Do not hesitate to use the tracing primitives. Too much context is
better than too little context. Think of <code class="docutils literal notranslate"><span class="pre">trace</span></code> (and variants) as a
way to document Octez. Specifically, as making the error messages of
Octez more informative.</p>
</section>
<section id="meta-commentary">
<span id="meta-commentary-1"></span><h2>META COMMENTARY<a class="headerlink" href="#meta-commentary" title="Link to this heading">#</a></h2>
<p>The previous sections had a practical focus: how to handle errors? how
to mix different syntaxes? how?! By contrast, the following sections are
in-depth discussions of advanced or tangential topics which you should
feel free to skim or even to skip.</p>
<div class="line-block">
<div class="line">You should take this opportunity to take a break.</div>
<div class="line">Come back in a few minutes.</div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="error_monad_p1_result.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Part 1: <code class="docutils literal notranslate"><span class="pre">result</span></code>, Lwt, and Lwt-<code class="docutils literal notranslate"><span class="pre">result</span></code></p>
      </div>
    </a>
    <a class="right-next"
       href="error_monad_p3_advanced.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Part 3: Advanced topics</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#error-trace-and-tzresult"><code class="docutils literal notranslate"><span class="pre">error</span></code>, <code class="docutils literal notranslate"><span class="pre">trace</span></code>, and <code class="docutils literal notranslate"><span class="pre">tzresult</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generic-failing">Generic failing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#declaring-and-registering-errors">Declaring and registering <code class="docutils literal notranslate"><span class="pre">error</span></code>s</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-6">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-result-syntax-s-tz-extensions">The <code class="docutils literal notranslate"><span class="pre">Result_syntax</span></code>’s <code class="docutils literal notranslate"><span class="pre">tz</span></code> extensions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-7">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-lwt-result-syntax-s-tz-extensions">The <code class="docutils literal notranslate"><span class="pre">Lwt_result_syntax</span></code>’s <code class="docutils literal notranslate"><span class="pre">tz</span></code> extensions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-8">Exercises</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lifting">Lifting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing">Tracing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#meta-commentary">META COMMENTARY</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nomadic Labs <contact@nomadic-labs.com>
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2018-2023, Nomadic Labs &lt;contact@nomadic-labs.com&gt;.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>