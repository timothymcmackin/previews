
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Smart rollup node &#8212; Octez &amp; Protocol products documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/biel-search@latest/dist/biel-search/biel-search.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=e44384e2" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=70b85459"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KT3Z3X4Y82"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'shell/smart_rollup_node';</script>
    <script src="../_static/js/custom.js?v=e7f469e6"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Supported Open Metrics" href="../developer/rollup_metrics.html" />
    <link rel="prev" title="Bakers &amp; the DAL" href="dal_bakers.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="Octez & Protocol products documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.svg" class="logo__image only-dark" alt="Octez & Protocol products documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/tezos.html">Octez &amp; Protocol overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction/howtoget.html">Installing Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/cosign-verify.html">Verifying Octez Docker Images with Cosign</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/get_troubleshooting.html">Installation troubleshooting</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtouse.html">Getting started with Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtorun.html">Running Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/services.html">Setting up Octez Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/serokell.html">Migrating from Serokell’s to Nomadic Labs’ packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/versioning.html">Octez &amp; Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/breaking_changes.html">BREAKING CHANGES</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez User manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-client.html">Setting up the client</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/client-configuration.html">Client Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/key-management.html">Key Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sandbox.html">Sandboxed mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/mockup.html">Mockup mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy.html">Proxy mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/light.html">Light mode</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-node.html">Setting up the node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/node-configuration.html">Node Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/multinetwork.html">Connecting to a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/history_modes.html">History modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/snapshots.html">Snapshots</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../user/node-monitoring.html">Monitoring an Octez Node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/openmetrics.html">Supported Open Metrics</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../user/teztale.html">Monitoring the consensus protocol</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../user/multisig.html">Built-in multisig contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/fa12.html">FA1.2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/logging.html">Logging features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/exits.html">Exit codes and signals</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez Reference manual</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="the_big_picture.html">Octez Software Architecture</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="shell.html">The Octez Shell</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="validation.html">The validation subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="prevalidation.html">The Prevalidator</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage.html">The storage layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sync.html">Synchronisation heuristic</a></li>
<li class="toctree-l2"><a class="reference internal" href="p2p.html">The peer-to-peer layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol_environment.html">Protocol Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="micheline.html">Micheline</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="dal.html">Data Availability Layer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="dal_overview.html">DAL overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="dal_node.html">The DAL node</a></li>
<li class="toctree-l2"><a class="reference internal" href="dal_run.html">Running a DAL attester node</a></li>
<li class="toctree-l2"><a class="reference internal" href="dal_bakers.html">Bakers &amp; the DAL</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="current reference internal" href="#">Smart rollup node</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/rollup_metrics.html">Supported Open Metrics</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="p2p_api.html">P2P message format</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpc.html">Shell RPCs - Reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Protocol Reference Manuals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../active/index.html">Quebec Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../active/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../active/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../active/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/rpc.html">Quebec RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../alpha/index.html">Alpha Dev Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../alpha/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../alpha/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/mempool.html">Mempool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/rpc.html">Alpha RPCs - Reference</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tezos developer Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../developer/rpc.html">JSON/RPC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/errors.html">RPC Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/openapi.html">RPCs - OpenAPI reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in Octez releases</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../releases/releases.html">Release System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/version-21.html">Version 21.2</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../releases/history.html">Older Versions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-20.html">Version 20.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-19.html">Version 19.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-18.html">Version 18.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-17.html">Version 17.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-16.html">Version 16.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-15.html">Version 15.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-14.html">Version 14.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-13.html">Version 13.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-12.html">Version 12.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-11.html">Version 11.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-10.html">Version 10.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-9.html">Version 9.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-8.html">Version 8.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-7.html">Version 7.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/january-2020.html">Mainnet January 2020</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/december-2019.html">Mainnet December 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/october-2019.html">Mainnet-Staging October 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/september-2019.html">Mainnet September 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/may-2019.html">Mainnet May 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/april-2019.html">Mainnet April 2019</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in protocol versions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../protocols/naming.html">Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/021_quebec.html">Protocol Quebec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/alpha.html">Protocol Alpha</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../protocols/history.html">Older Protocols</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../protocols/020_paris.html">Protocol Paris</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/018_oxford.html">Protocol Oxford</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/017_nairobi.html">Protocol Nairobi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/016_mumbai.html">Protocol Mumbai</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/015_lima.html">Protocol Lima</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/014_kathmandu.html">Protocol Kathmandu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/013_jakarta.html">Protocol Jakarta</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/012_ithaca.html">Protocol Ithaca</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/011_hangzhou.html">Protocol Hangzhou</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/010_granada.html">Protocol Granada</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/009_florence.html">Protocol Florence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/008_edo.html">Protocol Edo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/007_delphi.html">Protocol Delphi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/006_carthage.html">Protocol Carthage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/005_babylon.html">Protocol Babylon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/004_Pt24m4xi.html">Protocol Athens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/003_PsddFKi3.html">Protocol 003_PsddFKi3</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/contributing_index.html">How to contribute</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/contributing.html">How to contribute to Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/contributing-adding-a-new-opam-dependency.html">How to add or update opam dependencies</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merge_team.html">Octez Merge Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/guidelines.html">Documentation and coding guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/repository_scope.html">Scope of the Octez repository</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/programming.html">Programming tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/gadt.html">Generalized Algebraic Data Types (GADTs)</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/error_monad.html">The Error Monad</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p1_result.html">Part 1: <code class="docutils literal notranslate"><span class="pre">result</span></code>, Lwt, and Lwt-<code class="docutils literal notranslate"><span class="pre">result</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p2_tzresult.html">Part 2: <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> and Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p3_advanced.html">Part 3: Advanced topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p4_appendices.html">Part 4: Appendices</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/clic.html">The <code class="docutils literal notranslate"><span class="pre">clic</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/data_encoding.html">The <code class="docutils literal notranslate"><span class="pre">data_encoding</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/event_logging_framework.html">Using The Event Logging Framework</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/octez_architecture.html">Octez Architecture Details</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/baker.html">Baker application’s architecture</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/testing_index.html">Testing in Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/testing.html">Overview of Testing in Octez</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/ppx_expect.html">Ppx_expect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/tezt.html">Tezt: OCaml Tezos Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/long-tezts.html">Tezt: Long Tests and Performance Regression Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/alcotezt.html">Alcotezt: An Alcotest Compatibility Wrapper for Tezt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/unit_testing_legacy_code.html">Making legacy code unit-testable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/proposal_testing.html">How to Test a Protocol Proposal</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/maintaining.html">Maintaining</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/entering_alpha.html">How to start reading protocol Alpha</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/michelson_instructions.html">Adding a new instruction to Michelson language</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/protocol_playbook.html">Protocol Proposals</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/protocol_release_checklist.html">Protocol Release Checklist</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/howto-freeze-protocols.html">How to Freeze Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/protocol_environment_upgrade.html">Adding a new protocol environment</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Documenting</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/tools.html">Platform Development tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/profiling.html">Profiling the Octez node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/profiler_heap.html">Memory profiling the OCaml heap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/profiler_valgrind.html">Memory profiling the C heap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/profiler_perf.html">Performance profiling</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../developer/profiler_module.html">The Profiler module</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer/ppx_profiler.html">Profiler PPX</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/snoop.html">Benchmarking with Snoop</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_arch.html">Architecture of <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_tutorial.html">Snoop usage tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_example.html">In-depth usage example: more control over your benchmark</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/tezos_micheline_rewriting.html">Rewriting Micheline with <code class="docutils literal notranslate"><span class="pre">tezos-micheline-rewriting</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_interpreter.html">Snoop and the Michelson Interpreter</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/time_measurement_ppx.html">Time measurement PPX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/python_environment.html">Python Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/pre_commit_hook.html">Pre-Commit Hook</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/encodings.html">Encodings</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/merkle-proof-encoding-formats.html">Merkle Proof Encoding Formats</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v1-tree32.html">V1 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v1-tree2.html">V1 for Tree2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v2-tree32.html">V2 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v2-tree2.html">V2 for Tree2</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api-inline.html">OCaml APIs - Reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Grafazos</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../grafazos-doc/index.html">Grafazos: Grafana dashboards for Octez node monitoring.</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-gitlab"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-gitlab"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos/-/issues/new?issue[title]=Issue%20on%20page%20%2Fshell/smart_rollup_node.html&issue[description]=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Smart rollup node</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#origination">Origination</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deploying-a-rollup-node">Deploying a rollup node</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-file">Configuration file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monitoring-a-smart-rollup-node">Monitoring a smart-rollup node</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rollup-node-in-a-sandbox">Rollup node in a sandbox</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#history-modes">History modes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-mode">Full mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#archive-mode">Archive mode</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#snapshots">Snapshots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format-of-snapshots">Format of snapshots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-a-snapshot">Importing a snapshot</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#list-of-checks-performed-for-import">List of checks performed for import</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#snapshot-information">Snapshot information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exporting-a-snapshot">Exporting a snapshot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workflows">Workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-an-external-inbox-message">Sending an external inbox message</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#triggering-the-execution-of-an-outbox-message">Triggering the execution of an outbox message</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-outbox-messages-automatically">Executing outbox messages automatically</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-outbox-messages-manually">Executing outbox messages manually</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-an-internal-inbox-message">Sending an internal inbox message</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#populating-the-reveal-channel">Populating the reveal channel</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-webassembly-fast-execution">Configure WebAssembly fast execution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developing-wasm-kernels">Developing WASM Kernels</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#execution-environment">Execution Environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state">State</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wasm-pvm-versioning">WASM PVM Versioning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-flow">Control Flow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#host-functions">Host Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-a-wasm-kernel-in-rust">Implementing a WASM Kernel in Rust</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-rust">Setting-up Rust</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#host-functions-in-rust">Host Functions in Rust</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-your-kernel">Testing your Kernel</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="smart-rollup-node">
<h1>Smart rollup node<a class="headerlink" href="#smart-rollup-node" title="Link to this heading">#</a></h1>
<p>This page describes the Octez rollup node, the main executable supporting
<a class="reference internal" href="../active/smart_rollups.html"><span class="doc">Smart Optimistic Rollups</span></a>.</p>
<p>The Octez rollup node is used by a rollup operator to deploy a
rollup. The rollup node is responsible for making the rollup progress
by publishing commitments and by playing refutation games.</p>
<p>Just like the Octez node, the Octez rollup node provides an <a class="reference internal" href="../api/openapi.html"><span class="doc">RPC
interface</span></a>. The services of this interface can be
called directly with HTTP requests.</p>
<p>We first cover the operation of the rollup node and the corresponding workflow,
using some predefined rollup logic (called kernel), and then we explain how the
logic of a rollup can be defined by developing a custom rollup kernel.</p>
<section id="prerequisites">
<span id="smart-rollup-node-prerequisites"></span><h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h2>
<p>To experiment with the commands described in this section, we use
the <a class="reference external" href="https://teztnets.com/weeklynet-about">Weeklynet</a>.
In this section, we assume that <code class="docutils literal notranslate"><span class="pre">${OPERATOR_ADDR}</span></code> is a valid
user account on Weeklynet owned by the reader.</p>
<p>Notice that you need a specific development version of Octez to
participate to Weeklynet. This version is either available from
docker images or can be compiled from sources. Please refer to the
<a class="reference external" href="https://teztnets.com/weeklynet-about">Weeklynet</a> website
for installation details.</p>
<p>An Octez rollup node needs an Octez node to run. It is recommended that the two
nodes run on the same machine. If this is the case, there is no additional
configuration required of the Octez node. If they are on different network
interfaces, the Octez node needs to allow the rollup node to make specific
RPCs. To achieve this, one can add the following to the <a class="reference internal" href="../user/node-configuration.html"><span class="doc">Octez node
configuration file</span></a>, where <code class="docutils literal notranslate"><span class="pre">&lt;ip.address:port&gt;</span></code> is
the address at which the rollup node can contact the Octez node.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;rpc&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nt">&quot;acl&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;address&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;ip.address:port&gt;&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;blacklist&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">     </span><span class="p">]</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Configuring a public facing Octez node this way exposes it to DoS
attacks. However one can allow all RPCs on the Octez node to be accessed
locally while still keeping sane defaults for outside accesses by specifying
an additional RPC server with, <em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">--rpc-addr</span> <span class="pre">127.0.0.1</span> <span class="pre">--rpc-addr</span>
<span class="pre">0.0.0.0</span></code>.</p>
</div>
<p>We assume that an Octez node has been launched locally, typically by issuing:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-node<span class="w"> </span>config<span class="w"> </span>init<span class="w"> </span>--data-dir<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ONODE_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>--network<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NETWORK</span><span class="si">}</span><span class="s2">&quot;</span>
octez-node<span class="w"> </span>run<span class="w"> </span>--data-dir<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ONODE_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>--network<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NETWORK</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>--rpc-addr<span class="w"> </span><span class="m">127</span>.0.0.1
</pre></div>
</div>
<p>in a terminal where <code class="docutils literal notranslate"><span class="pre">${NETWORK}</span></code> is of the
form <code class="docutils literal notranslate"><span class="pre">https://teztnets.com/weeklynet-YYYY-MM-DD</span></code>
and <code class="docutils literal notranslate"><span class="pre">${ONODE_DIR}</span></code> is a path for the Octez node store, by default <code class="docutils literal notranslate"><span class="pre">~/.tezos-node</span></code>.</p>
<p>The commands will only work when the node is completely bootstrapped, and therefore the current protocol on the target network is activated.
This can be checked by:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-client<span class="w"> </span>bootstrapped
octez-client<span class="w"> </span>rpc<span class="w"> </span>get<span class="w"> </span>/chains/main/blocks/head/protocols
</pre></div>
</div>
<p>In case you do not already have a user account, you can generate one with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-client<span class="w"> </span>gen<span class="w"> </span>keys<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACCOUNT_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
octez-client<span class="w"> </span>show<span class="w"> </span>address<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACCOUNT_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Then, the <code class="docutils literal notranslate"><span class="pre">${OPERATOR_ADDR}</span></code> can be set to the hash value (<code class="docutils literal notranslate"><span class="pre">tz1...</span></code>) returned.</p>
<p>Finally, you need to check that your balance is greater than 10,000
tez to make sure that staking is possible. In case your balance is not
sufficient, you can get test tokens for the <code class="docutils literal notranslate"><span class="pre">tz1</span></code> address from <a class="reference internal" href="../user/multinetwork.html#faucet"><span class="std std-ref">a faucet</span></a>,
after your node gets synchronized with Weeklynet.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-client<span class="w"> </span>get<span class="w"> </span>balance<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</section>
<section id="origination">
<h2>Origination<a class="headerlink" href="#origination" title="Link to this heading">#</a></h2>
<p>Anyone can originate a smart rollup with the following invocation of
the Octez client:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-client<span class="w"> </span>originate<span class="w"> </span>smart<span class="w"> </span>rollup<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SR_ALIAS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>from<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>of<span class="w"> </span>kind<span class="w"> </span>wasm_2_0_0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>of<span class="w"> </span><span class="nb">type</span><span class="w"> </span>bytes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>with<span class="w"> </span>kernel<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">KERNEL</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--burn-cap<span class="w"> </span><span class="m">999</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">${SR_ALIAS}</span></code> is an alias to memorize the smart rollup
address in the client. This alias can be used in any command where a
smart rollup address is expected. <code class="docutils literal notranslate"><span class="pre">${KERNEL}</span></code> is a hex
representation of a WebAssembly bytecode serving as an initial program
to boot on. From a WASM bytecode file named <code class="docutils literal notranslate"><span class="pre">kernel.wasm</span></code>, such
representation can be obtained through</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>xxd<span class="w"> </span>-ps<span class="w"> </span>-c<span class="w"> </span><span class="m">0</span><span class="w"> </span>&lt;kernel.wasm&gt;<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\n&#39;</span>
</pre></div>
</div>
<p>To experiment, we propose that you use the value <code class="docutils literal notranslate"><span class="pre">${KERNEL}</span></code>
defined in the <a class="reference download internal" download="" href="../_downloads/1a9fe0df723edf647c4758e2b14b69e7/sr_boot_kernel.sh"><code class="xref download docutils literal notranslate"><span class="pre">given</span> <span class="pre">file</span></code></a>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>sr_boot_kernel.sh<span class="w"> </span><span class="c1"># defines shell variable KERNEL</span>
</pre></div>
</div>
<p>If everything went well, the origination command results in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This sequence of operations was run:
  Manager signed operations:
    From: tz1fp5ncDmqYwYC568fREYz9iwQTgGQuKZqX
    Fee to the baker: ꜩ0.000357
    Expected counter: 36
    Gas limit: 1000
    Storage limit: 0 bytes
    Balance updates:
      tz1fp5ncDmqYwYC568fREYz9iwQTgGQuKZqX ... -ꜩ0.000357
      payload fees(the block proposer) ....... +ꜩ0.000357
    Revelation of manager public key:
      Contract: tz1fp5ncDmqYwYC568fREYz9iwQTgGQuKZqX
      Key: edpkukxtw4fHmffj4wtZohVKwNwUZvYm6HMog5QMe9EyYK3QwRwBjp
      This revelation was successfully applied
      Consumed gas: 1000
  Manager signed operations:
    From: tz1fp5ncDmqYwYC568fREYz9iwQTgGQuKZqX
    Fee to the baker: ꜩ0.000956
    Expected counter: 37
    Gas limit: 2849
    Storage limit: 6572 bytes
    Balance updates:
      tz1fp5ncDmqYwYC568fREYz9iwQTgGQuKZqX ... -ꜩ0.000956
      payload fees(the block proposer) ....... +ꜩ0.000956
    Smart rollup origination:
      Kind: wasm_2_0_0
      Parameter type: bytes
      Kernel Blake2B hash: &#39;24df9e3c520dd9a9c49b447766e8a604d31138c1aacb4a67532499c6a8b348cc&#39;
      This smart rollup origination was successfully applied
      Consumed gas: 2748.269
      Storage size: 6552 bytes
      Address: sr1RYurGZtN8KNSpkMcCt9CgWeUaNkzsAfXf
      Genesis commitment hash: src13wCGc2nMVfN7rD1rgeG3g1q7oXYX2m5MJY5ZRooVhLt7JwKXwX
      Balance updates:
        tz1fp5ncDmqYwYC568fREYz9iwQTgGQuKZqX ... -ꜩ1.638
        storage fees ........................... +ꜩ1.638
</pre></div>
</div>
<p>The address <code class="docutils literal notranslate"><span class="pre">sr1RYurGZtN8KNSpkMcCt9CgWeUaNkzsAfXf</span></code> is the smart rollup address.
Let’s write it <code class="docutils literal notranslate"><span class="pre">${SR_ADDR}</span></code> from now on.</p>
</section>
<section id="deploying-a-rollup-node">
<span id="id2"></span><h2>Deploying a rollup node<a class="headerlink" href="#deploying-a-rollup-node" title="Link to this heading">#</a></h2>
<p>Now that the rollup is originated, anyone can make it progress by deploying a
rollup node.</p>
<p>First, we need to decide on a mode the rollup node will run:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">operator</span></code> activates a full-fledged rollup node. This means that
the rollup node will do everything needed to make the rollup
progress. This includes following the Layer 1 chain, reconstructing
inboxes, updating the states, publishing and cementing commitments
regularly, and playing the refutation games. In this mode, the
rollup node will accept transactions in its queue and batch them on
the Layer 1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batcher</span></code> means that the rollup node will accept transactions in
its queue and batch them on the Layer 1. In this mode, the rollup
node follows the Layer 1 chain, but it does not update its state
and does not reconstruct inboxes. Consequently, it does not publish
commitments nor play refutation games.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">observer</span></code> means that the rollup node follows the Layer 1 chain
to reconstruct inboxes, to update its state. However, it will
neither publish commitments, nor play a refutation game.
It does not include the message batching service either.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maintenance</span></code> is the same as the operator mode except that it does not
include the message batching service.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accuser</span></code> follows the layer1-chain and computes commitments but does not
publish them. Only when a conflicting commitment (published by another
committer) is detected will the “accuser node” publish a commitment and
participate in the subsequent refutation game.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bailout</span></code> mode is designed to assist committers in recovering their bonds.
It functions as a slightly modified version of “Accuser”, differing in that it does not post any new
commitments but instead focuses on defending the ones that have been previously
submitted. When operating in bailout mode, the expectation is to initiate a recover bond
operation when the operator is no longer staking on any commitment. If the node detects that this
operation has been successful, it can gratefully exit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">custom</span></code> mode refers to a mode where the users individually select which
kinds of operations the rollup node injects. It provides tailored control and
flexibility customized to specific requirements, and is mostly used for tests.</p></li>
</ol>
<p>To each mode corresponds a set of purposes where each purpose is a set
of L1 operations which are injected by the rollup node.</p>
<p>The following table links each purpose to its corresponding L1 operations.</p>
<div class="pst-scrollable-table-container"><table class="table">
<tbody>
<tr class="row-odd"><td><p>Operating</p></td>
<td><p>smart_rollup_publish, smart_rollup_refute, smart_rollup_timeout</p></td>
</tr>
<tr class="row-even"><td><p>Batching</p></td>
<td><p>smart_rollup_add_messages</p></td>
</tr>
<tr class="row-odd"><td><p>Cementing</p></td>
<td><p>smart_rollup_cement</p></td>
</tr>
<tr class="row-even"><td><p>Recovering</p></td>
<td><p>smart_rollup_recover</p></td>
</tr>
<tr class="row-odd"><td><p>Executing_outbox</p></td>
<td><p>smart_rollup_execute_outbox_message</p></td>
</tr>
</tbody>
</table>
</div>
<p>The table below summarises the modes and their associated purposes:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Operating</p></th>
<th class="head"><p>Batching</p></th>
<th class="head"><p>Cementing</p></th>
<th class="head"><p>Recovering</p></th>
<th class="head"><p>Executing_outbox</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Operator</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#f1" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>Maintenance</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#f1" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>Bailout</p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#f2" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>Accuser</p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#f3" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>Batcher</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>Observer</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
</div>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="f1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id3">1</a>,<a role="doc-backlink" href="#id4">2</a>)</span>
<p>If and only it’s a private rollup. In that case, only the
whitelist update outbox message are injected.</p>
</aside>
<aside class="footnote brackets" id="f2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">2</a><span class="fn-bracket">]</span></span>
<p>A rollup node in bailout mode won’t publish any new commitments but only
defends the one published by the operator if they are refuted.</p>
</aside>
<aside class="footnote brackets" id="f3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">3</a><span class="fn-bracket">]</span></span>
<p>An accuser node will publish commitments only when it detects
conflicts; for such cases it must make a deposit of 10,000 tez.</p>
</aside>
</aside>
<p>Then to run the rollup node, use the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-smart-rollup-node<span class="w"> </span>--base-dir<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCLIENT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>run<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROLLUP_NODE_MODE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span><span class="k">for</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SR_ALIAS_OR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>with<span class="w"> </span>operators<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>--data-dir<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROLLUP_NODE_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">${OCLIENT_DIR}</span></code> is the data directory of the Octez client, by
default <code class="docutils literal notranslate"><span class="pre">~/.tezos-client</span></code>, and <code class="docutils literal notranslate"><span class="pre">${ROLLUP_NODE_DIR}</span></code> is the data
directory of the Octez smart rollup node, by default
<code class="docutils literal notranslate"><span class="pre">~/.tezos-smart-rollup-node</span></code>.</p>
<p>The log should show that the rollup node follows the Layer 1 chain and
processes the inbox of each level.</p>
<p>Distinct Layer 1 signers can be used for each purpose of the mode by
either editing the <a class="reference internal" href="#rollup-node-config-file"><span class="std std-ref">configuration file</span></a>
or by listing multiple operators on the command line.</p>
<p>For example for the <code class="docutils literal notranslate"><span class="pre">operator</span></code> mode we can replace
<code class="docutils literal notranslate"><span class="pre">${OPERATOR_ADDR}</span></code> by <code class="docutils literal notranslate"><span class="pre">default:${OPERATOR_ADDR1}</span>
<span class="pre">batching:${OPERATOR_ADDR2}</span></code>.  Where the rollup node will use
<code class="docutils literal notranslate"><span class="pre">${OPERATOR_ADDR2}</span></code> for the batching purpose and
<code class="docutils literal notranslate"><span class="pre">${OPERATOR_ADDR1}</span></code> for everything else.</p>
<p>The L1 chain has a limitation of one manager operation per key per
block (see <a class="reference internal" href="../active/precheck.html"><span class="doc">Prechecking of manager operations</span></a>). In the case of a high
throughput rollup, this limitation could slow down the rollup by
capping the number of L2 messages that the rollup node’s batcher
purpose can inject per block to the maximum size of one L1 operation’s
maximal size (e.g., 32kb on mainnet).</p>
<p id="rollup-batcher-keys">To bypass that limitation and inject multiple
<code class="docutils literal notranslate"><span class="pre">smart_rollup_add_messages</span></code> L1 operations within a single L1 block,
it is possible to provide multiple keys for the batcher purpose of a
rollup node. At each block, the rollup node will use as many keys as
possible to inject a corresponding number of queued L2 messages into
the L1 rollup inbox.
The order of the batches of L2 messages is not guaranteed to be
preserved by the rollup node nor by the octez node mempool.</p>
<p>The way to provide multiple batcher keys on the command line is:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-smart-rollup-node<span class="w"> </span>run<span class="w"> </span><span class="si">${</span><span class="nv">ROLLUP_NODE_MODE</span><span class="si">}</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SR_ALIAS_OR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>with<span class="w"> </span>operators<span class="w"> </span>default:<span class="si">${</span><span class="nv">DEFAULT_ADDR</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>batching:<span class="si">${</span><span class="nv">BATCHER_ADDR1</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>batching:<span class="si">${</span><span class="nv">BATCHER_ADDR2</span><span class="si">}</span><span class="w"> </span>...
</pre></div>
</div>
<section id="configuration-file">
<span id="rollup-node-config-file"></span><h3>Configuration file<a class="headerlink" href="#configuration-file" title="Link to this heading">#</a></h3>
<p>The rollup node can also be configured via one configuration file stored in its own data directory, with the following command that
uses the same arguments as the <code class="docutils literal notranslate"><span class="pre">run</span></code> command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-smart-rollup-node<span class="w"> </span>--base-dir<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCLIENT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>init<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROLLUP_NODE_MODE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>config<span class="w"> </span><span class="se">\</span>
<span class="w">                 </span><span class="k">for</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SR_ALIAS_OR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>with<span class="w"> </span>operators<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                 </span>--data-dir<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROLLUP_NODE_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">${OCLIENT_DIR}</span></code> must be the directory of the client, containing all the keys used by the rollup node, i.e. <code class="docutils literal notranslate"><span class="pre">${OPERATOR_ADDR}</span></code>.</p>
<p>This creates a smart rollup node configuration file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Smart rollup node configuration written in ${ROLLUP_NODE_DIR}/config.json
</pre></div>
</div>
<p>Here is the content of the file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
  &quot;smart-rollup-address&quot;: &quot;${SR_ALIAS_OR_ADDR}&quot;,
  &quot;smart-rollup-node-operator&quot;:
  {
    &quot;operating&quot;: &quot;${OPERATOR_ADDR}&quot;,
    &quot;batching&quot;: [ &quot;${OPERATOR_ADDR}&quot; ],
    &quot;cementing&quot;: &quot;${OPERATOR_ADDR}&quot;,
    &quot;executing_outbox&quot;: &quot;${OPERATOR_ADDR}&quot;
  },
  &quot;fee-parameters&quot;: {},
  &quot;mode&quot;: &quot;operator&quot;
}
</pre></div>
</div>
<p>The rollup node can now be run with just:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-smart-rollup-node<span class="w"> </span>--base-dir<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCLIENT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>run<span class="w"> </span>--data-dir<span class="w"> </span><span class="si">${</span><span class="nv">ROLLUP_NODE_DIR</span><span class="si">}</span>
</pre></div>
</div>
<p>The configuration will be read from <code class="docutils literal notranslate"><span class="pre">${ROLLUP_NODE_DIR}/config.json</span></code>.</p>
</section>
<section id="monitoring-a-smart-rollup-node">
<h3>Monitoring a smart-rollup node<a class="headerlink" href="#monitoring-a-smart-rollup-node" title="Link to this heading">#</a></h3>
<p>The smart-rollup node offers the same <a class="reference internal" href="../user/node-monitoring.html"><span class="doc">monitoring features</span></a> as the Octez node.</p>
<p>For the list of metrics provided by the rollup node see the following page:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer/rollup_metrics.html">Supported Open Metrics</a></li>
</ul>
</div>
</section>
<section id="rollup-node-in-a-sandbox">
<h3>Rollup node in a sandbox<a class="headerlink" href="#rollup-node-in-a-sandbox" title="Link to this heading">#</a></h3>
<p>The node can also be tested locally with a sandbox environment. (See <a class="reference internal" href="../user/sandbox.html"><span class="doc">sandbox documentation</span></a>.)</p>
<p>Once you initialized the “sandboxed” client data with <code class="docutils literal notranslate"><span class="pre">./src/bin_client/octez-init-sandboxed-client.sh</span></code>, you can run a sandboxed rollup node with <code class="docutils literal notranslate"><span class="pre">octez-smart-rollup-node</span> <span class="pre">run</span></code>.</p>
<p>A temporary directory <code class="docutils literal notranslate"><span class="pre">/tmp/tezos-smart-rollup-node.xxxxxxxx</span></code> will be used. However, a specific data directory can be set with the environment variable <code class="docutils literal notranslate"><span class="pre">SCORU_DATA_DIR</span></code>.</p>
</section>
</section>
<section id="history-modes">
<span id="rollup-history-mode"></span><h2>History modes<a class="headerlink" href="#history-modes" title="Link to this heading">#</a></h2>
<p>The rollup node can be configured (1) to remove data on disk that is not needed
anymore for the correct operation of a rollup node (i.e. to still be able to
play all refutation games that could occur) or (2) to keep the full history of the
rollup and the L2 chain since the rollup genesis.</p>
<p>The history mode can be set on the command line with <code class="docutils literal notranslate"><span class="pre">--history-mode</span> <span class="pre">&lt;mode&gt;</span></code> or
in the configuration file with:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;history-mode&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;mode&gt;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="full-mode">
<h3>Full mode<a class="headerlink" href="#full-mode" title="Link to this heading">#</a></h3>
<p>The <em>full</em> history mode makes the rollup node keep its history since the last
cemented commitment (LCC). Everything before the LCC (both the context containing the PVM state
and the rollup node store containing the L2 chain) is
automatically deleted periodically by a <em>garbage collection</em> phase.</p>
</section>
<section id="archive-mode">
<h3>Archive mode<a class="headerlink" href="#archive-mode" title="Link to this heading">#</a></h3>
<p>When configured in <em>archive</em> mode, a rollup node will keep all history since the
origination of the rollup. This mode can be useful for
applications that require to regularly access historical data before the LCC,
i.e. for applications that need more than two weeks of history.</p>
<p>This mode can be chosen e.g. on the command line with <code class="docutils literal notranslate"><span class="pre">--history-mode</span>
<span class="pre">archive</span></code>.</p>
<p>Note that an archive node can be converted to a full node but not the other way
around. The conversion will happen automatically if the history mode is changed
in the configuration file or command line.</p>
<p>This is the default history mode.</p>
</section>
</section>
<section id="snapshots">
<span id="rollup-snapshots"></span><h2>Snapshots<a class="headerlink" href="#snapshots" title="Link to this heading">#</a></h2>
<p>Smart rollup node snapshots are a way to bootstrap a rollup node without having
to replay the whole L2 chain since the rollup genesis. Without this snapshot mechanism, one would need
an archive L1 node to bootstrap a rollup node or to catch up (if the rollup node
data is more than a few days old) because it needs access to metadata about L1
operations on the chain.</p>
<p>Snapshots for a particular rollup must be obtained from an off-chain source (for
instance a rollup snapshot provider service which regularly publishes snapshots
online) and imported into an existing, or empty, rollup node to get started
quickly.</p>
<section id="format-of-snapshots">
<span id="format-rollup-snapshot"></span><h3>Format of snapshots<a class="headerlink" href="#format-of-snapshots" title="Link to this heading">#</a></h3>
<p>A smart rollup node snapshot is a binary file which contains a header part and a
data part. The data part is a tar archive of the non-local storage files of the
rollup node while the metadata header exposes information to quickly validate or
discard a snapshot.</p>
<div class="pst-scrollable-table-container"><table class="table" id="id8">
<caption><span class="caption-text">Snapshot format</span><a class="headerlink" href="#id8" title="Link to this table">#</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Contents</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Snapshot version</p></td>
<td><p>1 byte</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0</span></code> (the only version so far)</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#rollup-history-mode"><span class="std std-ref">History mode</span></a></p></td>
<td><p>1 byte</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0</span></code> for archive, <code class="docutils literal notranslate"><span class="pre">1</span></code> for full</p></td>
</tr>
<tr class="row-even"><td><p>Address</p></td>
<td><p>20 bytes</p></td>
<td><p>Address of the smart rollup</p></td>
</tr>
<tr class="row-odd"><td><p>Head level</p></td>
<td><p>4 bytes</p></td>
<td><p>Level of the last seen L1 block of the rollup (int32)</p></td>
</tr>
<tr class="row-even"><td><p>Last commitment hash</p></td>
<td><p>32 bytes</p></td>
<td><p>Hash of last commitment in the L2 chain</p></td>
</tr>
<tr class="row-odd"><td><p>Data</p></td>
<td><p>Variable</p></td>
<td><p>Tar archive of rollup node data</p></td>
</tr>
</tbody>
</table>
</div>
<p>The snapshots can be imported (and exported) as either compressed (with gzip) or
uncompressed files.</p>
</section>
<section id="importing-a-snapshot">
<span id="importing-a-rollup-snapshot"></span><h3>Importing a snapshot<a class="headerlink" href="#importing-a-snapshot" title="Link to this heading">#</a></h3>
<p>A snapshot <code class="docutils literal notranslate"><span class="pre">${SNAPSHOT_FILE}</span></code> can be imported by issuing the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">octez-smart-rollup-node -E ${L1_NODE_ENDPOINT} \</span>
<span class="go">  snapshot import ${SNAPSHOT_FILE} \</span>
<span class="go">  [--data-dir ${ROLLUP_NODE_DIR}] \</span>
<span class="go">  [--force]</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">${ROLLUP_NODE_DIR}</span></code> is the data directory of the rollup node in which
we want to import the snapshot, and <code class="docutils literal notranslate"><span class="pre">${L1_NODE_ENDPOINT}</span></code> is the RPC endpoint
of an L1 node, needed to verify the snapshot.</p>
<p>Option <code class="docutils literal notranslate"><span class="pre">--force</span></code> allows to import a snapshot in an already
populated data directory of a rollup node.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When using the <code class="docutils literal notranslate"><span class="pre">--force</span></code> option, it is recommended to run the
<a class="reference internal" href="#rollup-snapshot-info"><span class="std std-ref">snapshot info command</span></a> and to first import the
snapshot in an empty directory to run all the checks.</p>
</div>
<p>While importing a snapshot, many checks are performed to ensure the consistency
of the imported data. In order to speed up the process, but only if the
snapshot’s source is highly trusted (or exported by yourself), it is possible to
disable some checks. Some rudimentary checks will still be performed. However,
most of the data will be copied directly, without additional consistency
checks. To do so, use the <code class="docutils literal notranslate"><span class="pre">--no-check</span></code> option.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The snapshot importing mechanism checks that the chain of commitments from
the LCC (last cemented commitment) to the last commitment is published on the
L1 chain but this does not prevent a malicious provider of snapshots from
providing snapshots with inaccurate data about the L2 state, as soon as she or
he is willing to also forfeit her/his deposit (these commitments were exposed
on L1 to eventual refutation games). The check described above gives some
acceptable level of assurance without having to recompute the whole chain
from the LCC (which can be costly depending on the rollup).</p>
</div>
<section id="list-of-checks-performed-for-import">
<h4>List of checks performed for import<a class="headerlink" href="#list-of-checks-performed-for-import" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Metadata checks:</p>
<ul>
<li><p>Rollup address matches (*)</p></li>
<li><p>History mode matches (*)</p></li>
<li><p>Snapshot head is fresher than the one on disk (*)</p></li>
<li><p>Last commitment is published on L1</p></li>
</ul>
</li>
<li><p>Metadata commitment matches the snapshot one</p></li>
<li><p>LCC on L1 is a valid commitment in the snapshot</p></li>
<li><p>Ensure the chain of commitments goes back to LCC</p></li>
<li><p>For each L2 block:</p>
<ul>
<li><p>The commitment, if any, must be for the PVM state of this block</p></li>
<li><p>Hashes are for the correct content (for state hash, commitment hash, inbox
hash)</p></li>
</ul>
</li>
</ul>
<p>(*) Marks the rudimentary checks that are performed on import with option
<code class="docutils literal notranslate"><span class="pre">--no-checks</span></code>.</p>
</section>
</section>
<section id="snapshot-information">
<span id="rollup-snapshot-info"></span><h3>Snapshot information<a class="headerlink" href="#snapshot-information" title="Link to this heading">#</a></h3>
<p>When retrieving a snapshot, it can be useful to check its actual content, such
as:</p>
<ul class="simple">
<li><p>snapshot format</p></li>
<li><p>history mode</p></li>
<li><p>smart rollup address</p></li>
<li><p>head level</p></li>
<li><p>last commitment</p></li>
</ul>
<p>This information is displayed by the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">octez-smart-rollup-node snapshot info ${SNAPSHOT_FILE}</span>
</pre></div>
</div>
<p>which will essentially decode and display the metadata header of the snapshot
file.</p>
</section>
<section id="exporting-a-snapshot">
<span id="exporting-a-rollup-snapshot"></span><h3>Exporting a snapshot<a class="headerlink" href="#exporting-a-snapshot" title="Link to this heading">#</a></h3>
<p>Exporting a snapshot for a currently running rollup node will temporarily stop
its progression (during the time the data is initially copied). The export
creates a file with a chosen name <code class="docutils literal notranslate"><span class="pre">${SNAPSHOT_FILE}</span></code> or one which is
automatically generated of the form
<code class="docutils literal notranslate"><span class="pre">snapshot-&lt;address&gt;-&lt;level&gt;.&lt;history_mode&gt;</span></code> and is achieved by running the
following command (the rollup node does not need to be stopped):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">octez-smart-rollup-node snapshot export [${SNAPSHOT_FILE}] \</span>
<span class="go">  [--data-dir ${ROLLUP_NODE_DIR}] \</span>
<span class="go">  [--dest ${DEST_DIR}]</span>
</pre></div>
</div>
<p>The export has three phases:</p>
<ol class="arabic simple">
<li><p>Initial export of the data (blocking)</p></li>
<li><p>Compression of snapshot (non-blocking)</p></li>
<li><p>Integrity check of snapshot (non-blocking)</p></li>
</ol>
<p>The checks for the export are less thorough than the ones for an import but
ensure that the snapshot is not corrupted and can be imported by other users.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is also possible to use the <code class="docutils literal notranslate"><span class="pre">--no-check</span></code> option to disable the integrity
checks during the export (i.e., phase 3), which will speed up the process.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Snapshots produced with the <code class="docutils literal notranslate"><span class="pre">--compact</span></code> option will be significantly
smaller (by a factor of 3) than otherwise as they contain a single commit of
the context for the first available block (instead of the full context
history). They take a comparable amount of time to be exported but take
longer to be imported because the context needs to be reconstructed.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Snapshots exported with <code class="docutils literal notranslate"><span class="pre">--compact</span></code> for <em>archive</em> rollup nodes will need a
significant time to import because the context will need to be reconstructed
from the rollup genesis.</p>
</div>
</section>
</section>
<section id="workflows">
<h2>Workflows<a class="headerlink" href="#workflows" title="Link to this heading">#</a></h2>
<section id="sending-an-external-inbox-message">
<span id="sending-external-inbox-message"></span><h3>Sending an external inbox message<a class="headerlink" href="#sending-an-external-inbox-message" title="Link to this heading">#</a></h3>
<p>The Octez client can be used to send an external message into the
rollup inbox. Assuming that <code class="docutils literal notranslate"><span class="pre">${EMESSAGE}</span></code> is the hexadecimal
representation of the message payload, one can do:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-client<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCLIENT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">PROTO_HASH</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>send<span class="w"> </span>smart<span class="w"> </span>rollup<span class="w"> </span>message<span class="w"> </span><span class="s2">&quot;hex:[ \&quot;</span><span class="si">${</span><span class="nv">EMESSAGE</span><span class="si">}</span><span class="s2">\&quot; ]&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>from<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>to inject such an external message,  where <code class="docutils literal notranslate"><span class="pre">${PROTO_HASH}</span></code> is the hash of your
protocol (e.g. <code class="docutils literal notranslate"><span class="pre">ProtoALphaAL</span></code> for Alpha; see <a class="reference internal" href="../introduction/howtouse.html#octez-client-protocol"><span class="std std-ref">how to obtain it</span></a>).
So let us focus now on producing viable content for <code class="docutils literal notranslate"><span class="pre">${EMESSAGE}</span></code>.</p>
<p>The kernel used previously in our running example is a simple “echo”
kernel that copies its input as a new message to its outbox.
Therefore, the input must be a valid binary encoding of an outbox
message to make this work. Specifically, assuming that we have
originated a Layer 1 smart contract as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-client<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCLIENT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">PROTO_HASH</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>originate<span class="w"> </span>contract<span class="w"> </span>go<span class="w"> </span>transferring<span class="w"> </span><span class="m">1</span><span class="w"> </span>from<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>running<span class="w"> </span><span class="s1">&#39;parameter string; storage string; code {CAR; NIL operation; PAIR};&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--init<span class="w"> </span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="w"> </span>--burn-cap<span class="w"> </span><span class="m">0</span>.4
</pre></div>
</div>
<p>and that this contract is identified by an address <code class="docutils literal notranslate"><span class="pre">${CONTRACT}</span></code>
(a <code class="docutils literal notranslate"><span class="pre">KT1...</span></code> address), then one can encode an
outbox transaction using the <code class="docutils literal notranslate"><span class="pre">octez-codec</span></code> as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">MESSAGE</span><span class="o">=</span><span class="s1">&#39;{</span>
<span class="s1">    &quot;transactions&quot;: [</span>
<span class="s1">      {</span>
<span class="s1">        &quot;parameters&quot;: {&quot;int&quot;: &quot;37&quot;},</span>
<span class="s1">        &quot;destination&quot;: &quot;KT1VD4SdQF2ruNNTCE1aTWErmGz9tN4Mg8F5&quot;,</span>
<span class="s1">        &quot;entrypoint&quot;: &quot;%default&quot;</span>
<span class="s1">      }</span>
<span class="s1">    ],</span>
<span class="s1">    &quot;kind&quot;: &quot;untyped&quot;</span>
<span class="s1">  }&#39;</span>

<span class="nv">EMESSAGE</span><span class="o">=</span><span class="k">$(</span>octez-codec<span class="w"> </span>encode<span class="w"> </span>alpha.smart_rollup.outbox.message<span class="w"> </span>from<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MESSAGE</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>
</pre></div>
</div>
</section>
<section id="triggering-the-execution-of-an-outbox-message">
<span id="triggering-execution-outbox-message"></span><h3>Triggering the execution of an outbox message<a class="headerlink" href="#triggering-the-execution-of-an-outbox-message" title="Link to this heading">#</a></h3>
<p>Once an outbox message has been pushed to the outbox by the kernel at
some level <code class="docutils literal notranslate"><span class="pre">${L}</span></code>, it becomes executable when the commitment that
includes this level is cemented. On Weeklynet, the cementation
process of a non-disputed commitment is 40 blocks long while on
Mainnet, it is 2 weeks long.</p>
<section id="executing-outbox-messages-automatically">
<h4>Executing outbox messages automatically<a class="headerlink" href="#executing-outbox-messages-automatically" title="Link to this heading">#</a></h4>
<p>The rollup node can be configured to execute outbox messages automatically as
soon as they become executable (it will not do so by default). For this, it is
strongly recommended to declare a distinct signing key for this purpose (see
<a class="reference internal" href="#deploying-a-rollup-node"><span class="std std-ref">operators and purposes</span></a>).</p>
<p>The configuration file must contain a key for the purpose <code class="docutils literal notranslate"><span class="pre">executing_outbox</span></code>
and potentially some “fee parameters” to control what the rollup node accepts to
pay as fees for injecting these operations on L1.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;smart-rollup-node-operator&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;executing_outbox&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tz1fp5ncDmqYwYC568fREYz9iwQTgGQuKZqX&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;fee-parameters&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;execute_outbox_message&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;fee-cap&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000000&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;burn-cap&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000000&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this snippet, the rollup node will accept to inject outbox message execution
operations which do not consume more than 1 tez in fees and 1 tez in storage
burn (these are the default values). They can be tweaked depending on the use
case (e.g. increased if the outbox messages call smart contracts on L1 which are
known to be costly, or decreased to limit abuse and better control funds
allocated for this purpose).</p>
<p>To decide which outbox messages the rollup node should execute, the
configuration file must contain a filter. An example is given below:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;execute-outbox-messages-filter&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">     </span><span class="p">{</span>
<span class="w">       </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;destination&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;KT1Wj8SUGmnEPFqyahHAcjcNQwe6YGhEXJb5&quot;</span><span class="p">],</span>
<span class="w">         </span><span class="nt">&quot;entrypoint&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;mint&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;burn&quot;</span><span class="p">]</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">     </span><span class="p">},</span>
<span class="w">     </span><span class="p">{</span>
<span class="w">       </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;destination&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">           </span><span class="s2">&quot;tz1QQAPf4v6ApPx9AteMa3ZV2kTiBT6x16Ps&quot;</span><span class="p">,</span>
<span class="w">           </span><span class="s2">&quot;tz2WtKth6KCGDT79gQkVovQiDFDa5wFPzmYq&quot;</span>
<span class="w">         </span><span class="p">],</span>
<span class="w">         </span><span class="nt">&quot;entrypoint&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;any&quot;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">     </span><span class="p">},</span>
<span class="w">     </span><span class="p">{</span>
<span class="w">       </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;destination&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;any&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;entrypoint&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this case, the rollup node will execute outbox messages which are transactions
that either:</p>
<ol class="arabic simple">
<li><p>Call the entry points <code class="docutils literal notranslate"><span class="pre">mint</span></code> or <code class="docutils literal notranslate"><span class="pre">burn</span></code> on the smart contract
<code class="docutils literal notranslate"><span class="pre">KT1Wj8SUGmnEPFqyahHAcjcNQwe6YGhEXJb5</span></code>.</p></li>
<li><p>Call any entry point on the destinations
<code class="docutils literal notranslate"><span class="pre">tz1QQAPf4v6ApPx9AteMa3ZV2kTiBT6x16Ps</span></code> or
<code class="docutils literal notranslate"><span class="pre">tz2WtKth6KCGDT79gQkVovQiDFDa5wFPzmYq</span></code></p></li>
<li><p>Call the entry point <code class="docutils literal notranslate"><span class="pre">default</span></code> on any destination.</p></li>
</ol>
<p>It is advised to define filters with both restricted sets of entry points and
destinations to prevent misuse of this feature. In some cases (in test
sandboxes, or if outbox messages are restricted/controlled by the kernel), it
may be desirable to allow the rollup node to execute every outbox messages it
sees.</p>
<p>The following entry in the configuration file makes the rollup node execute all
outbox messages for its rollup indiscriminately.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;execute-outbox-messages-filter&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">     </span><span class="p">{</span>
<span class="w">       </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;destination&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;any&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;entrypoint&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;any&quot;</span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="executing-outbox-messages-manually">
<h4>Executing outbox messages manually<a class="headerlink" href="#executing-outbox-messages-manually" title="Link to this heading">#</a></h4>
<p>If the rollup node is not configured to execute outbox messages automatically,
messages have to be executed manually by users (anyone can execute an outbox
message once it becomes executable).</p>
<p>When the commitment that includes level <code class="docutils literal notranslate"><span class="pre">${L}</span></code> is cemented, one can observe
that the outbox is populated as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROLLUP_NODE_ENDPOINT</span><span class="si">}</span><span class="s2">/global/block/cemented/outbox/</span><span class="si">${</span><span class="nv">L</span><span class="si">}</span><span class="s2">/messages&quot;</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p>${ROLLUP_NODE_ENDPOINT} represents the address of the Rollup node server.
It can be set to a specific server address such as “<a class="reference external" href="http://localhost:36149">http://localhost:36149</a>”.</p></li>
<li><p>${L} denotes the block level for which one wants to retrieve information
from the Rollup node.</p></li>
</ul>
<p>Here is the output for this command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[ { &quot;outbox_level&quot;: ${L}, &quot;message_index&quot;: &quot;0&quot;,
 &quot;message&quot;:
   { &quot;transactions&quot;:
       [ { &quot;parameters&quot;: { &quot;int&quot;: &quot;37&quot; },
           &quot;destination&quot;: &quot;${CONTRACT}&quot;,
           &quot;entrypoint&quot;: &quot;%default&quot; } ] } } ]
</pre></div>
</div>
<p>At this point, the actual execution of a given outbox message can be
triggered. This requires precomputing a proof that this outbox message
is indeed in the outbox. In the case of our running example, this
proof is retrieved as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">PROOF</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROLLUP_NODE_ENDPOINT</span><span class="si">}</span><span class="s2">/global/block/head/helpers/\</span>
<span class="s2">           proofs/outbox/</span><span class="si">${</span><span class="nv">L</span><span class="si">}</span><span class="s2">/messages?index=0)&quot;</span>
</pre></div>
</div>
<p>Finally, the execution of the outbox message is done as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">TEZOS_PATH</span><span class="si">}</span><span class="s2">/octez-client&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCLIENT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">PROTO_HASH</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>execute<span class="w"> </span>outbox<span class="w"> </span>message<span class="w"> </span>of<span class="w"> </span>smart<span class="w"> </span>rollup<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SR_ALIAS_OR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>from<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>commitment<span class="w"> </span><span class="nb">hash</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">LCC</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>and<span class="w"> </span>output<span class="w"> </span>proof<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROOF</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">${LCC}</span></code> is the hash of the latest cemented commitment.
Notice that anyone can trigger the execution of an outbox message
(not only an operator as in this example).</p>
<p>One can check in the receipt that the contract has indeed been called
with the parameter <code class="docutils literal notranslate"><span class="pre">&quot;37&quot;</span></code> through an internal operation. More complex
parameters, typically containing assets represented as tickets, can be
used as long as they match the type of the entrypoint of the destination
smart contract.</p>
</section>
</section>
<section id="sending-an-internal-inbox-message">
<span id="sending-internal-inbox-message"></span><h3>Sending an internal inbox message<a class="headerlink" href="#sending-an-internal-inbox-message" title="Link to this heading">#</a></h3>
<p>A smart contract can push an internal message in the rollup inbox
using the Michelson <code class="docutils literal notranslate"><span class="pre">TRANSFER_TOKENS</span></code> instruction targeting a
specific rollup address. The parameter of this transfer must be a
value of the Michelson type declared at the origination of this
rollup.</p>
<p>Remember that our running example rollup has been originated with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-client<span class="w"> </span>originate<span class="w"> </span>smart<span class="w"> </span>rollup<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SR_ALIAS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>from<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OPERATOR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>of<span class="w"> </span>kind<span class="w"> </span>wasm_2_0_0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>of<span class="w"> </span><span class="nb">type</span><span class="w"> </span>bytes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>booting<span class="w"> </span>with<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">KERNEL</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-burn-cap<span class="w"> </span><span class="m">999</span>
</pre></div>
</div>
<p>The fragment <code class="docutils literal notranslate"><span class="pre">of</span> <span class="pre">type</span> <span class="pre">bytes</span></code> of this command declares that the
rollup is expecting values of type <code class="docutils literal notranslate"><span class="pre">bytes</span></code>. (Notice any Michelson type
could have been used instead. To transfer tickets to a rollup, this
type must mention tickets.)</p>
<p>Here is an example of a Michelson script that sends an internal
message to the rollup of our running example. The payload of the
internal message is the value passed as parameter of type <code class="docutils literal notranslate"><span class="pre">bytes</span></code>
to the rollup.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>parameter bytes;
storage unit;
code
  {
    UNPAIR;
    PUSH address &quot;${SR_ADDR}&quot;;
    CONTRACT bytes;
    IF_NONE { PUSH string &quot;Invalid address&quot;; FAILWITH } {};
    PUSH mutez 0;
    DIG 2;
    TRANSFER_TOKENS;
    NIL operation;
    SWAP;
    CONS;
    PAIR;
  }
</pre></div>
</div>
</section>
<section id="populating-the-reveal-channel">
<span id="id7"></span><h3>Populating the reveal channel<a class="headerlink" href="#populating-the-reveal-channel" title="Link to this heading">#</a></h3>
<p>It is the responsibility of rollup node operators to get the data
passed through the reveal data channel when the rollup requests it.</p>
<p>To answer a request for a page of hash <code class="docutils literal notranslate"><span class="pre">H</span></code>, the rollup node tries to
read the content of a file <code class="docutils literal notranslate"><span class="pre">H</span></code> named
<code class="docutils literal notranslate"><span class="pre">${ROLLUP_NODE_DIR}/wasm_2_0_0</span></code>.</p>
<p>Notice that a page cannot exceed 4KB. Hence, larger pieces of data
must be represented with multiple pages that reference each other
through hashes. It is up to the kernel to decide how to implement
this. For instance, one can classify pages into two categories: index
pages that are hashes for other pages and leaf pages that contain
actual payloads.</p>
<p>In addition to data stored locally on disk in the data directory, the rollup
node can also fetch missing pages to be revealed from an external source.
Data fetched from a remote pre-images service will be cached on disk (in the
<code class="docutils literal notranslate"><span class="pre">${ROLLUP_NODE_DIR}/wasm_2_0_0</span></code>).</p>
<p>To configure a remote source (whose server can be contacted over HTTP at
<code class="docutils literal notranslate"><span class="pre">${PRE_IMAGES_URL}</span></code>) for pre-images, one can either pass the option
<code class="docutils literal notranslate"><span class="pre">--pre-images-endpoint</span> <span class="pre">${PRE_IMAGES_URL}</span></code>
to the <code class="docutils literal notranslate"><span class="pre">run</span></code> command or add the following in the configuration file
<code class="docutils literal notranslate"><span class="pre">${ROLLUP_NODE_DIR}/config.json</span></code>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;pre-images-endpoint&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${PRE_IMAGES_URL}&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One does not need to trust the provider service for pre-images because the
rollup node will ensure that the content matches the requested hash before using
it.</p>
</div>
</section>
</section>
<section id="configure-webassembly-fast-execution">
<span id="configure-fast-exec"></span><h2>Configure WebAssembly fast execution<a class="headerlink" href="#configure-webassembly-fast-execution" title="Link to this heading">#</a></h2>
<p>When the rollup node advances its internal rollup state under normal
operation, it does so using the fast execution engine.</p>
<p>This engine uses Wasmer for running WebAssembly code. You may configure the compiler used for compiling
WebAssembly code, via the <code class="docutils literal notranslate"><span class="pre">OCTEZ_WASMER_COMPILER</span></code> environment variable.</p>
<p>The choice of a compiler primarily affects the performance of the
WebAssembly code execution <em>vs</em> the compilation time. Some compilers offer certain security
guarantees in a blockchain context, such as compiling in linear time to avoid JIT bombs.</p>
<p>The available options are:</p>
<div class="pst-scrollable-table-container"><table class="table" id="id9">
<caption><span class="caption-text">Wasmer compiler options</span><a class="headerlink" href="#id9" title="Link to this table">#</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Compiler</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">OCTEZ_WASMER_COMPILER</span></code> value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Singlepass</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">singlepass</span></code></p></td>
<td><p><a class="reference external" href="https://github.com/wasmerio/wasmer/tree/main/lib/compiler-singlepass#when-to-use-singlepass">When to use Singlepass</a></p></td>
</tr>
<tr class="row-odd"><td><p>Cranelift</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cranelift</span></code></p></td>
<td><p><a class="reference external" href="https://github.com/wasmerio/wasmer/tree/main/lib/compiler-cranelift#when-to-use-cranelift">When to use Cranelift</a></p></td>
</tr>
</tbody>
</table>
</div>
<p>Note that while the rollup node is generally capable of using Wasmer’s
LLVM-based compiler, Octez does not currently ship with it.</p>
<p>When the environment variable is undefined, Cranelift is used by default.</p>
</section>
<section id="developing-wasm-kernels">
<h2>Developing WASM Kernels<a class="headerlink" href="#developing-wasm-kernels" title="Link to this heading">#</a></h2>
<p>This page provides a first overview on writing a Wasm kernel for a smart rollup.
(See <a class="reference internal" href="../alpha/smart_rollups.html"><span class="doc">smart optimistic rollup</span></a>)</p>
<p>A rollup is primarily characterized by the semantics it gives to the
input messages it processes. This semantics is provided at origination
time as a WASM program (in the case of the <code class="docutils literal notranslate"><span class="pre">wasm_2_0_0</span></code> kind) called
a <em>kernel</em>. More concretely, the kernel is a WASM module encoded in the
binary format defined by the WASM standard.</p>
<p>Except for necessary restrictions to ensure determinism (a key
requirement for any web3 technology), we support the full WASM
language.  More precisely, determinism is ensured by the following
restrictions:</p>
<ol class="arabic simple">
<li><p>Instructions and types related to floating-point arithmetic are not
supported. This is because IEEE floats are not deterministic, as
the standard includes undefined behavior operations.</p></li>
<li><p>The length of the call stack of the WASM kernel is bounded.</p></li>
</ol>
<p>Modulo the limitations above, a valid kernel is a WASM module that
satisfies the following constraints:</p>
<ol class="arabic simple">
<li><p>It exports a function <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> that takes no argument and
returns nothing.</p></li>
<li><p>It declares and exports exactly one memory.</p></li>
<li><p>It only imports the host functions exported by the (virtual)
module <code class="docutils literal notranslate"><span class="pre">smart_rollup_core</span></code>.</p></li>
</ol>
<p>For instance, the mandatory example of a <code class="docutils literal notranslate"><span class="pre">hello,</span> <span class="pre">world!</span></code> kernel is
the following WASM program in text format.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(module
  (import &quot;smart_rollup_core&quot; &quot;write_debug&quot;
     (func $write_debug (param i32 i32) (result i32)))
  (memory 1)
  (export &quot;mem&quot; (memory 0))
  (data (i32.const 100) &quot;hello, world!&quot;)
  (func (export &quot;kernel_run&quot;)
    (local $hello_address i32)
    (local $hello_length i32)
    (local.set $hello_address (i32.const 100))
    (local.set $hello_length (i32.const 13))
    (drop (call $write_debug (local.get $hello_address)
                             (local.get $hello_length)))))
</pre></div>
</div>
<p>This program can be compiled to the WASM binary format with
general-purpose tool like
<a class="reference external" href="https://github.com/WebAssembly/wabt">WABT</a>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>wat2wasm hello.wat -o hello.wasm
</pre></div>
</div>
<p>The contents of the resulting <code class="docutils literal notranslate"><span class="pre">hello.wasm</span></code> file is a valid WASM
kernel, though its relevance as a decentralized application is
debatable.</p>
<p>One of the benefits of choosing WASM as the programming language for
smart rollups is that WASM has gradually become a ubiquitous
compilation target over the years. Its popularity has grown to the point where mainstream,
industrial languages like Go or Rust now natively compile to
WASM. Thus, <code class="docutils literal notranslate"><span class="pre">cargo</span></code> —the official Rust package manager— provides an
official target to compile Rust to <code class="docutils literal notranslate"><span class="pre">.wasm</span></code> binary files, which are
valid WASM kernels. This means that, for this particular example, one
can build a WASM kernel while enjoying the strengths and convenience
of the Rust language and the Rust ecosystem.</p>
<p>The rest of the section proceeds as follows.</p>
<ol class="arabic simple">
<li><p>First, we explain the execution environment of a WASM kernel: when
it is parsed, executed, etc.</p></li>
<li><p>Then, we explain in more detail the API at the disposal of WASM
kernel developers.</p></li>
<li><p>Finally, we demonstrate how Rust in particular can be used to
implement a WASM kernel.</p></li>
</ol>
<p>Though Rust has become the primary language whose WASM backend has
been tested in the context of smart rollups, the WASM VM has not been
modified in any way to favor this language. We fully expect that other
mainstream languages such as Go are also good candidates for
implementing WASM kernels.</p>
<section id="execution-environment">
<h3>Execution Environment<a class="headerlink" href="#execution-environment" title="Link to this heading">#</a></h3>
<p>In a nutshell, the life cycle of a smart rollup is a never-ending
loop of fetching inputs from the Layer 1, and executing the
<code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> function exposed by the WASM kernel.</p>
</section>
<section id="state">
<h3>State<a class="headerlink" href="#state" title="Link to this heading">#</a></h3>
<p>The smart rollup carries two states:</p>
<ol class="arabic simple">
<li><p>A transient state, that is reset after each call to the
<code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> function and is akin to RAM.</p></li>
<li><p>A persistent state, that is preserved across <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> calls.
The persistent state consists in an <em>inbox</em> that is regularly
populated with the inputs coming from the Layer 1, the <em>outbox</em>
which the kernel can populate with contract calls targeting smart
contracts in the Layer 1, and a durable storage which is akin to a
file system.</p></li>
</ol>
<p>The durable storage is a persistent tree, whose contents are addressed
by path-like keys. A path in the storage may contain: a value (also
called file) consisting of a sequence of raw bytes, and/or any number
of subtrees (also called directories), that is, the paths in the
storage prefixed by the current path. Thus, unlike most file systems,
a path in the durable storage may be at the same time a file and a
directory (a set of sub-paths).</p>
<p>The WASM kernel can write and read the raw bytes stored under a given
path (the file), but can also interact (delete, copy, move, etc.) with
subtrees (directories).</p>
<p>The values and subtrees under the key <code class="docutils literal notranslate"><span class="pre">/readonly</span></code> are not writable
by a kernel, but can be used by the PVM to give information to the
kernel.</p>
</section>
<section id="wasm-pvm-versioning">
<h3>WASM PVM Versioning<a class="headerlink" href="#wasm-pvm-versioning" title="Link to this heading">#</a></h3>
<p>One of Tezos distinguishing features is its native support for
upgrades. At its core, Tezos is a Layer 1 designed to evolve via a
self-updating mechanism, subject to an on-line governance process. The
self-updating mechanism is also implemented by the smart rollup
infrastructure.</p>
<p>The WASM PVM is versioned. Kernels can read the version of the
underlying WASM PVM (which is currently interpreting them) by reading
the contents of the file stored under the key
<code class="docutils literal notranslate"><span class="pre">/readonly/wasm_version</span></code> in their durable storage.</p>
<p>New WASM PVM versions are introduced by new Layer 1’s protocol
upgrades. The WASM PVM will upgrade itself when it reads the
<code class="docutils literal notranslate"><span class="pre">Protocol_migration</span></code> internal message.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Protocol</p></th>
<th class="head"><p>Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Mumbai</p></td>
<td><p>2.0.0</p></td>
</tr>
<tr class="row-odd"><td><p>Nairobi</p></td>
<td><p>2.0.0-r1</p></td>
</tr>
<tr class="row-even"><td><p>Oxford2</p></td>
<td><p>2.0.0-r2</p></td>
</tr>
<tr class="row-odd"><td><p>Paris</p></td>
<td><p>2.0.0-r4</p></td>
</tr>
<tr class="row-even"><td><p>Quebec</p></td>
<td><p>2.0.0-r5</p></td>
</tr>
<tr class="row-odd"><td><p>Alpha</p></td>
<td><p>2.0.0-r5</p></td>
</tr>
</tbody>
</table>
</div>
<p>The changes in each WASM PVM version can be found by searching for string “PVM” in the corresponding protocol’s changelog, section <code class="docutils literal notranslate"><span class="pre">Smart</span> <span class="pre">Rollups</span></code> (e.g. <a class="reference external" href="../protocols/alpha.html#smart-rollups">this section</a> for protocol Alpha).</p>
</section>
<section id="control-flow">
<h3>Control Flow<a class="headerlink" href="#control-flow" title="Link to this heading">#</a></h3>
<p>When a new block is published on Tezos, the inbox exposed to the smart
rollup is populated with all the inputs published on Tezos in this
block. It is important to keep in mind that all the smart rollups
which are originated on Tezos share the same inbox. As a consequence,
a WASM kernel has to filter the inputs that are relevant to its
purpose from the ones it does not need to process.</p>
<p>Once the inbox has been populated with the inputs of the Tezos block,
the <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> function is called, from a clean “transient”
state. More precisely, the WASM kernel is re-initialized,
then <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> is called.</p>
<p>By default, the WASM kernel yields when <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> returns. In
this case, the WASM kernel execution is put on hold while the inputs of
the next inbox are being loaded. The inputs that were not consumed by
<code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> are dropped. <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> can prevent the WASM
kernel from yielding by writing arbitrary data under the path
<code class="docutils literal notranslate"><span class="pre">/kernel/env/reboot</span></code> in its durable storage. In such a case (known
as reboot), <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> is called again, without dropping unread
inputs. The value at <code class="docutils literal notranslate"><span class="pre">/kernel/env/reboot</span></code> is removed between each call of <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code>,
and the <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> function can postpone yielding at most 1,000
reboots for each Tezos level.</p>
<p>A call to <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> cannot take an arbitrary amount of time to
complete, because diverging computations are not compatible with the
optimistic rollup infrastructure of Tezos.
It is the responsibility of the kernel developers to ensure the computation
time necessary to track their rollup is bounded and reasonable, for two
reasons:</p>
<ol class="arabic simple">
<li><p>If a kernel requires more time than the time between two Tezos blocks, then
a rollup node is doomed to lag behind the Layer 1 chain it is tracking.</p></li>
<li><p>If a single <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> takes too much time to compute, then it becomes
difficult to protect the resulting commitment. This is because the WASM PVM
interpreter has not been optimized for speed but for producing small
execution step proofs.</p></li>
</ol>
<p>Kernel developers are expected to design their kernel such that it addresses
these two constraints.</p>
<p>The WASM PVM does enforce a limit on the number of ticks available per
<code class="docutils literal notranslate"><span class="pre">kernel_run</span></code>, but it is arbitrary high enough (50 trillion) that it becomes
virtually impossible to exceed it.
<code class="docutils literal notranslate"><span class="pre">octez-smart-rollup-wasm-debugger</span></code> is probably the best tool available to
verify the <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> function does not take more ticks than authorized.</p>
<p>The direct consequence of this setup is that it might be necessary for
a WASM kernel to span a long computation across several calls to
<code class="docutils literal notranslate"><span class="pre">kernel_run</span></code>, and therefore to serialize any data it needs in the
durable storage to avoid losing them.</p>
<p>Finally, the kernel can verify if the previous <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code>
invocation was trapped by verifying if some data are stored under the
path <code class="docutils literal notranslate"><span class="pre">/kernel/env/stuck</span></code>.</p>
</section>
<section id="host-functions">
<h3>Host Functions<a class="headerlink" href="#host-functions" title="Link to this heading">#</a></h3>
<p>At its core, the WASM machine defined in the WASM standard is just a
very evolved arithmetic machine. It needs to be enriched with
so-called host functions in order to be used for greater purposes. The
host functions provide an API to the WASM program to interact with an
“outer world”.</p>
<p>As for smart rollups, the host functions exposed to a WASM kernel
allow it to interact with the components of persistent state:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">read_input</span></code></dt><dd><p>Loads the oldest input still present in the inbox of the smart
rollup in the transient memory of the WASM kernel. This means that
the input is lost at the next invocation of <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> if it is
not written in the durable storage. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of
the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">write_output</span></code></dt><dd><p>Writes an in-memory buffer to the outbox of the smart rollup. If the
content of the buffer follows the expected encoding, it can be
interpreted in the Layer 1 as a smart contract call, once a
commitment acknowledging the call to this host function is cemented.
Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">write_debug</span></code></dt><dd><p>Can be used by the WASM kernel to log
events which can potentially be interpreted by an instrumented
rollup node. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_has</span></code></dt><dd><p>Returns the kind of data (if any) stored in the durable storage under a given
path: a directory, a file, neither or both. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_delete</span></code></dt><dd><p>Cuts both the value (if any) and any subdirectory under a given path out of
the durable storage. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_delete_value</span></code></dt><dd><p>Cuts the value under a given path out of the durable storage, but leaves the
rest of the subtree untouched. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0-r1</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_copy</span></code></dt><dd><p>Copies the subtree under a given path to another key. Since the
<code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> version of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_move</span></code></dt><dd><p>Behaves as <code class="docutils literal notranslate"><span class="pre">store_copy</span></code>, but also cuts the original subtree out of
the tree. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_read</span></code></dt><dd><p>Loads at most 4,096 bytes from a file of the durable storage to a buffer
in the memory of the WASM kernel. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of
the WASM PVM.*</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_write</span></code></dt><dd><p>Writes at most 2048 bytes from a buffer in the memory of the WASM
kernel to a file of the durable storage, increasing its size if
necessary. Note that files in the durable storage cannot exceed
<span class="math notranslate nohighlight">\(2^{31} - 1\)</span> bytes (i.e. 2GB - 1). Since the <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code>
version of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_create</span></code></dt><dd><p>Allocates a new file in the durable storage under a given key. Similarly to
<code class="docutils literal notranslate"><span class="pre">store_write</span></code>, <code class="docutils literal notranslate"><span class="pre">store_create</span></code> cannot create files larger than the durable
storage limits, that is 2GB - 1. Since the <code class="docutils literal notranslate"><span class="pre">2.0.0-r1</span></code> of
the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_value_size</span></code></dt><dd><p>Returns the size (in bytes) of a file under a given key in the durable
storage. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">store_list_size</span></code></dt><dd><p>Returns the number of child objects (either directories or files)
under a given key. Since version <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">reveal_preimage</span></code></dt><dd><p>Loads in memory the preimage of a hash. The size of the hash in
bytes must be specified as an input to the function. Since the
<code class="docutils literal notranslate"><span class="pre">2.0.0</span></code> version of the WASM PVM.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">reveal_metadata</span></code></dt><dd><p>Loads in memory the address of the smart rollup (20 bytes), and the
Tezos level of its origination (4 bytes). Since the <code class="docutils literal notranslate"><span class="pre">2.0.0</span></code>
version of the WASM PVM.</p>
</dd>
</dl>
<p>These host functions use a “C-like” API. In particular, most of them
return a signed 32bit integer, where negative values are reserved for
conveying errors, as shown in the next table.</p>
<div class="pst-scrollable-table-container"><table class="table">
<tbody>
<tr class="row-odd"><td><p>Code</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>-1</p></td>
<td><p>Input is too large to be a valid key of the durable storage</p></td>
</tr>
<tr class="row-odd"><td><p>-2</p></td>
<td><p>Input cannot be parsed as a valid key of the durable storage</p></td>
</tr>
<tr class="row-even"><td><p>-3</p></td>
<td><p>There is no file under the requested key</p></td>
</tr>
<tr class="row-odd"><td><p>-4</p></td>
<td><p>The host functions tried to read or write an invalid section (determined by an offset and a length) of the value stored under a given key</p></td>
</tr>
<tr class="row-even"><td><p>-5</p></td>
<td><p>Cannot write a value beyond the 2GB size limit</p></td>
</tr>
<tr class="row-odd"><td><p>-6</p></td>
<td><p>Invalid memory access (segmentation fault)</p></td>
</tr>
<tr class="row-even"><td><p>-7</p></td>
<td><p>Tried to read from the inbox or write to the outbox more than 4,096 bytes</p></td>
</tr>
<tr class="row-odd"><td><p>-8</p></td>
<td><p>Unknown error due to an invalid access</p></td>
</tr>
<tr class="row-even"><td><p>-9</p></td>
<td><p>Attempt to modify a readonly value</p></td>
</tr>
<tr class="row-odd"><td><p>-10</p></td>
<td><p>Key has no tree in the storage</p></td>
</tr>
<tr class="row-even"><td><p>-11</p></td>
<td><p>Outbox is full, no new message can be appended</p></td>
</tr>
<tr class="row-odd"><td><p>-13</p></td>
<td><p>Key has already a value in the storage</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="implementing-a-wasm-kernel-in-rust">
<h3>Implementing a WASM Kernel in Rust<a class="headerlink" href="#implementing-a-wasm-kernel-in-rust" title="Link to this heading">#</a></h3>
<p>Though WASM is a good fit for efficiently executing computation-intensive, arbitrary
programs, it is a low-level, stack-based, memory unsafe language.
Fortunately, it was designed to be a compilation target, not a
language in which developers would directly write their programs.</p>
<p>Rust has several advantages that make it a good candidate for writing
the kernel of a smart rollup. Not only does the Rust compiler treat
WASM as a first class citizen when it comes to compilation targets,
but its approach to memory safety eliminates large classes of bugs and
vulnerabilities that arbitrary WASM programs may suffer from.</p>
<p>Additionally there is support for implementing kernels in Rust, in the form of the <a class="reference external" href="https://crates.io/crates/tezos-smart-rollup">Smart Rollup Kernel SDK</a>.</p>
<section id="setting-up-rust">
<h4>Setting-up Rust<a class="headerlink" href="#setting-up-rust" title="Link to this heading">#</a></h4>
<p><a class="reference external" href="https://rustup.rs">rustup</a> is the standard way to get Rust. Once
<code class="docutils literal notranslate"><span class="pre">rustup</span></code> is installed, enabling WASM as a compilation target is as
simple as running the following command.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rustup target add wasm32-unknown-unknown
</pre></div>
</div>
<p>Rust also proposes the <code class="docutils literal notranslate"><span class="pre">wasm64-unknown-unknown</span></code> compilation
target. This target is <strong>not</strong> compatible with Tezos smart rollups,
which only provide a 32bit address space.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This document is not a tutorial about Rust, and familiarity with
the language and its ecosystem (<em>e.g.</em>, how Rust crates are
structured in particular) is assumed.</p>
</div>
<p>The simplest kernel one can implement in Rust (the one that returns
directly after being called, without doing anything particular) is the
following Rust file (by convention named <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code> in Rust).</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">kernel_run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code can be easily computed with <code class="docutils literal notranslate"><span class="pre">cargo</span></code> with the following
<code class="docutils literal notranslate"><span class="pre">Cargo.toml</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[package]
name = &#39;noop&#39;
version = &#39;0.1.0&#39;
edition = &#39;2021&#39;

[lib]
crate-type = [&quot;cdylib&quot;]
</pre></div>
</div>
<p>The key line to spot is the <code class="docutils literal notranslate"><span class="pre">crate-type</span></code> definition to
<code class="docutils literal notranslate"><span class="pre">cdylib</span></code>. As a side note, when writing a library that will
eventually be consumed by a Kernel WASM crate, this line must be
modified to</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">crate-type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;cdylib&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;rlib&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Compiling our “noop” kernel is done by calling <code class="docutils literal notranslate"><span class="pre">cargo</span></code> with the
correct argument.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cargo build --target wasm32-unknown-unknown
</pre></div>
</div>
<p>It is also possible to use the <code class="docutils literal notranslate"><span class="pre">--release</span></code> CLI flag to tell
<code class="docutils literal notranslate"><span class="pre">cargo</span></code> to optimize the kernel.</p>
<p>To make the use of the <code class="docutils literal notranslate"><span class="pre">target</span></code> optional, it is possible to create
a <code class="docutils literal notranslate"><span class="pre">.cargo/config.toml</span></code> file, containing the following line.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[build]
target = &quot;wasm32-unknown-unknown&quot;

[rust]
lld = true
</pre></div>
</div>
<p>The resulting project looks as follows.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.
├── .cargo
│   └── config.toml
├── Cargo.toml
└── src
    └── lib.rs
</pre></div>
</div>
<p>and the kernel can be found in the <code class="docutils literal notranslate"><span class="pre">target/</span></code> directory, <em>e.g.</em>,
<code class="docutils literal notranslate"><span class="pre">./target/wasm32-unknown-unknown/release/noop.wasm</span></code>.</p>
<p>By default, Rust binaries (including WASM binaries) contain a lot of
debugging information and possibly unused code that we do not want to
deploy in our rollup. For instance, our “noop” kernel weighs
1.7MBytes. We can use <a class="reference external" href="https://github.com/WebAssembly/wabt">wasm-strip</a> to reduce the size of the
kernel (down to 115 bytes in our case).</p>
</section>
<section id="host-functions-in-rust">
<h4>Host Functions in Rust<a class="headerlink" href="#host-functions-in-rust" title="Link to this heading">#</a></h4>
<p>The host functions exported by the WASM runtime to Rust programs
are exposed by the following API. The <code class="docutils literal notranslate"><span class="pre">link</span></code> pragma is used to specify the
module that exports them (in our case, <code class="docutils literal notranslate"><span class="pre">smart_rollup_core</span></code>). Define these functions
in the <code class="docutils literal notranslate"><span class="pre">host.rs</span></code> as follows:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ReadInputMessageInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">level</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[link(wasm_import_module = </span><span class="s">&quot;smart_rollup_core&quot;</span><span class="cp">)]</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// Returns the number of bytes written to `dst`, or an error code.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">read_input</span><span class="p">(</span>
<span class="w">        </span><span class="n">message_info</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">ReadInputMessageInfo</span><span class="p">,</span>
<span class="w">        </span><span class="n">dst</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_bytes</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns 0 in case of success, or an error code.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">write_output</span><span class="p">(</span><span class="n">src</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">num_bytes</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Does nothing. Does not check the correctness of its argument.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">write_debug</span><span class="p">(</span><span class="n">src</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">num_bytes</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span>

<span class="w">    </span><span class="sd">/// Returns</span>
<span class="w">    </span><span class="sd">/// - 0 the key is missing</span>
<span class="w">    </span><span class="sd">/// - 1 only a file is stored under the path</span>
<span class="w">    </span><span class="sd">/// - 2 only directories under the path</span>
<span class="w">    </span><span class="sd">/// - 3 both a file and directories</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">store_has</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns 0 in case of success, or an error code</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">store_delete</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns the number of children (file and directories) under a</span>
<span class="w">    </span><span class="sd">/// given key.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">store_list_size</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns 0 in case of success, or an error code.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">store_copy</span><span class="p">(</span>
<span class="w">        </span><span class="n">src_path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">scr_path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">dst_path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">dst_path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns 0 in case of success, or an error code.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">store_move</span><span class="p">(</span>
<span class="w">        </span><span class="n">src_path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">scr_path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">dst_path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">dst_path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns the number of bytes written to the durable storage</span>
<span class="w">    </span><span class="sd">/// (should be equal to `num_bytes`, or an error code).</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">store_read</span><span class="p">(</span>
<span class="w">        </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">dst</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">num_bytes</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns 0 in case of success, or an error code.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">store_write</span><span class="p">(</span>
<span class="w">        </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">path_len</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">src</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">num_bytes</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns the number of bytes written at `dst`, or an error</span>
<span class="w">    </span><span class="sd">/// code.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">reveal_metadata</span><span class="p">(</span>
<span class="w">        </span><span class="n">dst</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_bytes</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>

<span class="w">    </span><span class="sd">/// Returns the number of bytes written at `dst`, or an error</span>
<span class="w">    </span><span class="sd">/// code.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">reveal_preimage</span><span class="p">(</span>
<span class="w">        </span><span class="n">hash_addr</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">hash_size</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">dst</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_bytes</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These functions are marked as <code class="docutils literal notranslate"><span class="pre">unsafe</span></code> for Rust. It is possible to
provide a safe API on top of them. For instance, the <code class="docutils literal notranslate"><span class="pre">read_input</span></code> host
function can be used to declare a safe function which allocates a
fresh Rust Vector to receive the input.</p>
<p>Define these functions in the <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code> as follows:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assuming the host functions are defined in a module `host`.</span>

<span class="k">mod</span><span class="w"> </span><span class="nn">host</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">host</span><span class="p">::</span><span class="n">read_input</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">host</span><span class="p">:</span><span class="nc">ReadInputMessageInfo</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">MAX_MESSAGE_SIZE</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="k">u32</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Input</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">level</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">payload</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">next_input</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Input</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">MAX_MESSAGE_SIZE</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Placeholder values</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">message_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadInputMessageInfo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">level</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">read_input</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">message_info</span><span class="p">,</span>
<span class="w">            </span><span class="n">payload</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
<span class="w">            </span><span class="n">MAX_MESSAGE_SIZE</span><span class="p">.</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">(),</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">payload</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">payload</span><span class="p">.</span><span class="n">set_len</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">Input</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">level</span><span class="p">:</span><span class="w"> </span><span class="nc">message_info</span><span class="p">.</span><span class="n">level</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">            </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="nc">message_info</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">            </span><span class="n">payload</span><span class="p">,</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">None</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Coupling <code class="docutils literal notranslate"><span class="pre">Vec::with_capacity</span></code> along with the <code class="docutils literal notranslate"><span class="pre">set_len</span></code> unsafe
function is a good approach to avoid initializing the 4,096 bytes of
memory every time you want to load data of arbitrary size into the
WASM memory.</p>
</section>
</section>
<section id="testing-your-kernel">
<h3>Testing your Kernel<a class="headerlink" href="#testing-your-kernel" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">octez-smart-rollup-wasm-debugger</span></code> is available in the Octez
distribution starting with <a class="reference internal" href="../releases/version-16.html"><span class="doc">Version 16.1</span></a>.</p>
</div>
<p>Testing a kernel without having to start a rollup node on a test
network is very convenient. We provide a debugger as a means to
evaluate the WASM PVM without relying on any node and network:
<code class="docutils literal notranslate"><span class="pre">octez-smart-rollup-wasm-debugger</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>octez-smart-rollup-wasm-debugger<span class="w"> </span>--kernel<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WASM_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>--inputs<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">JSON_INPUTS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>--rollup<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SR_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">octez-smart-rollup-wasm-debugger</span></code> takes the target WASM kernel to be debugged as argument, either as a <code class="docutils literal notranslate"><span class="pre">.wasm</span></code> file (the binary
representation of WebAssembly modules) or as a <code class="docutils literal notranslate"><span class="pre">.wast</span></code> file (its textual
representation), and actually parses and typechecks the kernel before
giving it to the PVM.</p>
<p>Beside the kernel file, the debugger can optionally take an input file containing inboxes and a
rollup address. The expected contents of the inboxes is a JSON value,
with the following schema:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;payload&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">Michelson</span><span class="w"> </span><span class="nx">data</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sender&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">Smart</span><span class="w"> </span><span class="nx">contract</span><span class="w"> </span><span class="nx">sending</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">rollup</span><span class="p">,</span><span class="w"> </span><span class="nx">optional</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;source&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">User</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">sending</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">optional</span><span class="o">&gt;</span>
<span class="w">      </span><span class="s2">&quot;destination&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">Smart</span><span class="w"> </span><span class="nx">rollup</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">optional</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">..</span>
<span class="w">    </span><span class="c1">// or</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">hexadecimal</span><span class="w"> </span><span class="nx">payload</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">..</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The contents of the input file is a JSON array of arrays of inputs,
which encodes a sequence of inboxes, where an inbox is a set of
messages. These inboxes are read in the same order as they appear in
the JSON file. For example, here is a valid input file that defines
two inboxes: the first array encodes an inbox containing only an
external message, while the second array encodes an inbox containing
two messages:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;external&quot;</span><span class="o">:</span>
<span class="w">      </span><span class="s2">&quot;0000000023030b01d1a37c088a1221b636bb5fccb35e05181038ba7c000000000764656661756c74&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;payload&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sender&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;KT1ThEdxfUcWUwqsdergy3QnbCWGHSUHeHJq&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;source&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tz1RjtZUVeLhADFHDL8UwDZA6vjWWhojpu5w&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;destination&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;sr1RYurGZtN8KNSpkMcCt9CgWeUaNkzsAfXf&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;payload&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Pair Unit False&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">sender</span></code>, <code class="docutils literal notranslate"><span class="pre">source</span></code> and <code class="docutils literal notranslate"><span class="pre">destination</span></code> fields are optional
and will be given default values by the debugger, respectively
<code class="docutils literal notranslate"><span class="pre">KT18amZmM5W7qDWVt2pH6uj7sCEd3kbzLrHT</span></code>,
<code class="docutils literal notranslate"><span class="pre">tz1Ke2h7sDdakHJQh8WX4Z372du1KChsksyU</span></code> and
<code class="docutils literal notranslate"><span class="pre">sr163Lv22CdE8QagCwf48PWDTquk6isQwv57</span></code>. If no input file is given, the
inbox will be assumed empty. If the option <code class="docutils literal notranslate"><span class="pre">--rollup</span></code> is given, it
replaces the default value for the rollup address.</p>
<p><code class="docutils literal notranslate"><span class="pre">octez-smart-rollup-wasm-debugger</span></code> is a debugger, as such it waits for user
inputs to continue its execution. Its initial state is exactly the same as right
after its origination. Its current state can be inspected with the command
<code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">status</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; show status
Status: Waiting for input
Internal state: Collect
</pre></div>
</div>
<p>When started, the kernel is in collection mode internally. This means that it is
not executing any WASM code, and is waiting for inputs in order to
proceed. The command
<code class="docutils literal notranslate"><span class="pre">load</span> <span class="pre">inputs</span></code> will load the first inbox from the file given with the
option <code class="docutils literal notranslate"><span class="pre">--inputs</span></code>, putting <code class="docutils literal notranslate"><span class="pre">Start_of_level</span></code> and <code class="docutils literal notranslate"><span class="pre">Info_per_level</span></code> before
these inputs and <code class="docutils literal notranslate"><span class="pre">End_of_level</span></code> after the inputs.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; load inputs
Loaded 1 inputs at level 0

&gt; show status
Status: Evaluating
Internal state: Snapshot
</pre></div>
</div>
<p>At this point, the internal input buffer can be inspected with the
command <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">inbox</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; show inbox
Inbox has 4 messages:
{ raw_level: 0;
  counter: 0
  payload: Start_of_level }
{ raw_level: 0;
  counter: 1
  payload: Info_per_level {predecessor_timestamp = 1970-01-01T00:00:00-00:00; predecessor = BKiHLREqU3JkXfzEDYAkmmfX48gBDtYhMrpA98s7Aq4SzbUAB6M} }
{ raw_level: 0;
  counter: 2
  payload: 0000000023030b01d1a37c088a1221b636bb5fccb35e05181038ba7c000000000764656661756c74 }
{ raw_level: 0;
  counter: 3
  payload: End_of_level }
</pre></div>
</div>
<p>The first input of an inbox at the beginning of a level is
<code class="docutils literal notranslate"><span class="pre">Start_of_level</span></code>, and is represented by the message <code class="docutils literal notranslate"><span class="pre">\000\001</span></code> on
the kernel side. We can now start a <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> evaluation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; step kernel_run
Evaluation took 11000000000 ticks so far
Status: Waiting for input
Internal state: Collect
</pre></div>
</div>
<p>The memory of the interpreter is flushed between two <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code>
calls (at the <code class="docutils literal notranslate"><span class="pre">Snapshot</span></code> and <code class="docutils literal notranslate"><span class="pre">Collect</span></code> internal states), however the
durable storage can be used as a persistent memory. Let’s assume this
kernel wrote data at key <code class="docutils literal notranslate"><span class="pre">/store/key</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; show key /store/key
`&lt;hexadecimal value of the key&gt;`
</pre></div>
</div>
<p>Since the representation of values is decided by the kernel, the debugger can
only return its raw value. Please note that the command <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">keys</span> <span class="pre">&lt;path&gt;</span></code>
will return the keys under the given path. This can help navigate in the durable
storage.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; show keys /store
/key
/another_key
...
</pre></div>
</div>
<p>It is also possible to inspect the memory by stopping the PVM before its
snapshot internal state, with <code class="docutils literal notranslate"><span class="pre">step</span> <span class="pre">result</span></code>, and inspect the memory at pointer
<code class="docutils literal notranslate"><span class="pre">n</span></code> and length <code class="docutils literal notranslate"><span class="pre">l</span></code>, and finally evaluate until the next <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; step result
Evaluation took 2500 ticks so far
Status: Evaluating
Internal state: Evaluation succeeded

&gt; show memory at p for l bytes
`&lt;hexadecimal value&gt;`

&gt; step kernel_run
Evaluation took 7500 ticks so far
Status: Evaluating
Internal state: Snapshot
</pre></div>
</div>
<p>Once again, note that values from the memory are output as is,
since the representation is internal to WASM.</p>
<p>Finally, it is possible to evaluate the whole inbox with <code class="docutils literal notranslate"><span class="pre">step</span> <span class="pre">inbox</span></code>. It will
take care of the possible reboots asked by the kernel (through the usage of the
<code class="docutils literal notranslate"><span class="pre">/kernel/env/reboot_flag</span></code> flag) and stop at the next collection phase.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; step inbox
Evaluation took 44000000000 ticks
Status: Waiting for input
Internal state: Collect
</pre></div>
</div>
<p>To obtain more information on the execution, the command <code class="docutils literal notranslate"><span class="pre">profile</span></code> will also run
the kernel on a full inbox, consume all inputs, run until more inputs are
required, and output some information about the run.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; profile
Starting the profiling until new messages are expected. Please note that it will take some time and does not reflect a real computation time.
Profiling result can be found in /tmp/wasm-debugger-profiling-2023-09-26T09:10:09.860-00:00.out
----------------------
Detailed results for a `kernel_run`:
%interpreter(decode): 35948 ticks (277ms)
%interpreter(link): 6 ticks (3.605us)
%interpreter(init): 201823 ticks (62.246ms)
kernel_run: 22962 ticks (20.280ms)

Full execution: 260739 ticks (359ms)
----------------------
Detailed results for a `kernel_run`:
%interpreter(decode): 35948 ticks (273ms)
%interpreter(link): 6 ticks (7.287us)
%interpreter(init): 201823 ticks (63.946ms)
kernel_run: 29388 ticks (9.275ms)

Full execution: 267165 ticks (346ms)
----------------------
Full execution with padding: 22000000000 ticks
</pre></div>
</div>
<p>Each cycle is a call of the <code class="docutils literal notranslate"><span class="pre">kernel_run</span></code> function.
For each cycle, the number of <em>effective</em> ticks used is shown (ticks corresponding
to execution, and not used for padding), along with the duration in seconds.</p>
<p>It is also possible to show the outbox for any given level (<code class="docutils literal notranslate"><span class="pre">show</span>
<span class="pre">outbox</span> <span class="pre">at</span> <span class="pre">level</span> <span class="pre">0</span></code>)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; show outbox at level 0
Outbox has N messages:
{ unparsed_parameters: ..;
  destination: ..;
  entrypoint: ..; }
..
</pre></div>
</div>
<p>The reveal channel described previously is available in the
debugger, either automatically or through specific commands. The
debugger can fill automatically preimages from files in a specific
directory on the disk, by default in the <code class="docutils literal notranslate"><span class="pre">preimage</span></code> subdirectory of the
working directory. It can be configured with the option
<code class="docutils literal notranslate"><span class="pre">--preimage-dir</span> <span class="pre">&lt;directory&gt;</span></code>. In case there is no corresponding file
found for the requested preimage, the debugger will ask for the
hexadecimal value of the preimage:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; step inbox
Preimage for hash 0000[..] not found.
&gt; 48656c6c6f207468657265210a
Hello there!
...
</pre></div>
</div>
<p>Metadata are automatically filled with level <code class="docutils literal notranslate"><span class="pre">0</span></code> as origination level
and the configured smart rollup address (or the default one).</p>
<p>Note that when stepping tick by tick (using the <code class="docutils literal notranslate"><span class="pre">step</span> <span class="pre">tick</span></code> command), it is
possible to end up in a situation where the evaluation stops on <code class="docutils literal notranslate"><span class="pre">Waiting</span> <span class="pre">for</span>
<span class="pre">reveal</span></code>. If the expected value is a metadata, the command <code class="docutils literal notranslate"><span class="pre">reveal</span> <span class="pre">metadata</span></code>
will give the default metadata to the kernel. If the value expected is the
preimage of a given hash, there are two possible solutions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reveal</span> <span class="pre">preimage</span></code> to read the value from the disk. In that case, the
debugger will look for a file of the same name as the expected hash in the
<code class="docutils literal notranslate"><span class="pre">preimage</span></code> subdirectory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reveal</span> <span class="pre">preimage</span> <span class="pre">of</span> <span class="pre">&lt;hex</span> <span class="pre">encoded</span> <span class="pre">value&gt;</span></code> can be used to feed a custom
preimage hash.</p></li>
</ul>
</section>
</section>
</section>

            <script type="module" src="https://cdn.jsdelivr.net/npm/biel-search@latest/dist/biel-search/biel-search.esm.js"></script>
        
                <script>
                    window.addEventListener('DOMContentLoaded', (event) => {
                        let bielBtn = document.createElement("biel-button");
                        bielBtn.innerHTML = "Ask AI";
                        bielBtn.setAttribute("project", "w30c27l8fg");
                    bielBtn.setAttribute("button-text", "Ask AI");
                    bielBtn.setAttribute("header-title", "Tezos chatbot");
                    bielBtn.setAttribute("button-style", "dark");
                    bielBtn.setAttribute("button-position", "bottom-right");
                    bielBtn.setAttribute("version", "latest");
                        document.body.appendChild(bielBtn);
                    });
                </script>
            

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="dal_bakers.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Bakers &amp; the DAL</p>
      </div>
    </a>
    <a class="right-next"
       href="../developer/rollup_metrics.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Supported Open Metrics</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#origination">Origination</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deploying-a-rollup-node">Deploying a rollup node</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-file">Configuration file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monitoring-a-smart-rollup-node">Monitoring a smart-rollup node</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rollup-node-in-a-sandbox">Rollup node in a sandbox</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#history-modes">History modes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-mode">Full mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#archive-mode">Archive mode</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#snapshots">Snapshots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format-of-snapshots">Format of snapshots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-a-snapshot">Importing a snapshot</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#list-of-checks-performed-for-import">List of checks performed for import</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#snapshot-information">Snapshot information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exporting-a-snapshot">Exporting a snapshot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workflows">Workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-an-external-inbox-message">Sending an external inbox message</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#triggering-the-execution-of-an-outbox-message">Triggering the execution of an outbox message</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-outbox-messages-automatically">Executing outbox messages automatically</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-outbox-messages-manually">Executing outbox messages manually</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-an-internal-inbox-message">Sending an internal inbox message</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#populating-the-reveal-channel">Populating the reveal channel</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-webassembly-fast-execution">Configure WebAssembly fast execution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developing-wasm-kernels">Developing WASM Kernels</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#execution-environment">Execution Environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state">State</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wasm-pvm-versioning">WASM PVM Versioning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-flow">Control Flow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#host-functions">Host Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-a-wasm-kernel-in-rust">Implementing a WASM Kernel in Rust</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-rust">Setting-up Rust</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#host-functions-in-rust">Host Functions in Rust</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-your-kernel">Testing your Kernel</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Contributors to the Octez & Tezos protocol documentation
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2018-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>