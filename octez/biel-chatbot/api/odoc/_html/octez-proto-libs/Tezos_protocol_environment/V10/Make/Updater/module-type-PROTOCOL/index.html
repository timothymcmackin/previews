<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>PROTOCOL (octez-proto-libs.Tezos_protocol_environment.V10.Make.Updater.PROTOCOL)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../index.html">octez-proto-libs</a> &#x00BB; <a href="../../../../index.html">Tezos_protocol_environment</a> &#x00BB; <a href="../../../index.html">V10</a> &#x00BB; <a href="../../index.html">Make</a> &#x00BB; <a href="../index.html">Updater</a> &#x00BB; PROTOCOL</nav><header class="odoc-preamble"><h1>Module type <code><span>Updater.PROTOCOL</span></code></h1><p>This is the signature of a Tezos protocol implementation. It has access to the standard library and the Environment module.</p></header><nav class="odoc-toc"><ul><li><a href="#block-(and-operation)-validation-and-application">Block (and operation) validation and application</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-max_block_length"><a href="#val-max_block_length" class="anchor"></a><code><span><span class="keyword">val</span> max_block_length : int</span></code></div><div class="spec-doc"><p>The maximum size of a block header in bytes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-max_operation_data_length"><a href="#val-max_operation_data_length" class="anchor"></a><code><span><span class="keyword">val</span> max_operation_data_length : int</span></code></div><div class="spec-doc"><p>The maximum size of an <a href="#type-operation"><code>operation</code></a> in bytes. This value is bigger than the size of the bytes required for <a href="#type-operation_data"><code>operation_data</code></a>, because this value accounts for the shell header.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validation_passes"><a href="#val-validation_passes" class="anchor"></a><code><span><span class="keyword">val</span> validation_passes : <span><a href="../index.html#type-quota">quota</a> list</span></span></code></div><div class="spec-doc"><p>Operations quota for each validation pass. The length of the list denotes the number of validation passes.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_header_data"><a href="#type-block_header_data" class="anchor"></a><code><span><span class="keyword">type</span> block_header_data</span></code></div><div class="spec-doc"><p>The economic protocol-specific type of blocks.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_header_data_encoding"><a href="#val-block_header_data_encoding" class="anchor"></a><code><span><span class="keyword">val</span> block_header_data_encoding : <span><a href="#type-block_header_data">block_header_data</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for economic protocol-specific part of block headers.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_header"><a href="#type-block_header" class="anchor"></a><code><span><span class="keyword">type</span> block_header</span><span> = </span><span>{</span></code><ol><li id="type-block_header.shell" class="def record field anchored"><a href="#type-block_header.shell" class="anchor"></a><code><span>shell : <a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a>;</span></code></li><li id="type-block_header.protocol_data" class="def record field anchored"><a href="#type-block_header.protocol_data" class="anchor"></a><code><span>protocol_data : <a href="#type-block_header_data">block_header_data</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A fully parsed block header.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_header_metadata"><a href="#type-block_header_metadata" class="anchor"></a><code><span><span class="keyword">type</span> block_header_metadata</span></code></div><div class="spec-doc"><p>Economic protocol-specific side information computed by the protocol during the validation of a block. Should not include information about the evaluation of operations which is handled separately by <code>operation_metadata</code>. To be used as an execution trace by tools (client, indexer). Not necessary for validation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_header_metadata_encoding_with_legacy_attestation_name"><a href="#val-block_header_metadata_encoding_with_legacy_attestation_name" class="anchor"></a><code><span><span class="keyword">val</span> block_header_metadata_encoding_with_legacy_attestation_name : 
  <span><a href="#type-block_header_metadata">block_header_metadata</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for economic protocol-specific block metadata. This encoding uses the attestation legacy name: endorsement.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_header_metadata_encoding"><a href="#val-block_header_metadata_encoding" class="anchor"></a><code><span><span class="keyword">val</span> block_header_metadata_encoding : <span><a href="#type-block_header_metadata">block_header_metadata</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for economic protocol-specific block metadata.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-operation_data"><a href="#type-operation_data" class="anchor"></a><code><span><span class="keyword">type</span> operation_data</span></code></div><div class="spec-doc"><p>The economic protocol-specific type of operations.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-operation_receipt"><a href="#type-operation_receipt" class="anchor"></a><code><span><span class="keyword">type</span> operation_receipt</span></code></div><div class="spec-doc"><p>Economic protocol-specific side information computed by the protocol during the validation of each operation, to be used conjointly with <a href="#type-block_header_metadata"><code>block_header_metadata</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-operation"><a href="#type-operation" class="anchor"></a><code><span><span class="keyword">type</span> operation</span><span> = </span><span>{</span></code><ol><li id="type-operation.shell" class="def record field anchored"><a href="#type-operation.shell" class="anchor"></a><code><span>shell : <a href="../../Operation/index.html#type-shell_header">Operation.shell_header</a>;</span></code></li><li id="type-operation.protocol_data" class="def record field anchored"><a href="#type-operation.protocol_data" class="anchor"></a><code><span>protocol_data : <a href="#type-operation_data">operation_data</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A fully parsed operation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_data_encoding"><a href="#val-operation_data_encoding" class="anchor"></a><code><span><span class="keyword">val</span> operation_data_encoding : <span><a href="#type-operation_data">operation_data</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for protocol-specific operation data.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_data_encoding_with_legacy_attestation_name"><a href="#val-operation_data_encoding_with_legacy_attestation_name" class="anchor"></a><code><span><span class="keyword">val</span> operation_data_encoding_with_legacy_attestation_name : 
  <span><a href="#type-operation_data">operation_data</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for protocol-specific operation data. This encoding uses the attestation legacy name: endorsement.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_receipt_encoding"><a href="#val-operation_receipt_encoding" class="anchor"></a><code><span><span class="keyword">val</span> operation_receipt_encoding : <span><a href="#type-operation_receipt">operation_receipt</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for protocol-specific operation receipts.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_receipt_encoding_with_legacy_attestation_name"><a href="#val-operation_receipt_encoding_with_legacy_attestation_name" class="anchor"></a><code><span><span class="keyword">val</span> operation_receipt_encoding_with_legacy_attestation_name : 
  <span><a href="#type-operation_receipt">operation_receipt</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for protocol-specific operation receipts. This encoding uses the attestation legacy name: endorsement.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_data_and_receipt_encoding"><a href="#val-operation_data_and_receipt_encoding" class="anchor"></a><code><span><span class="keyword">val</span> operation_data_and_receipt_encoding : 
  <span><span>(<a href="#type-operation_data">operation_data</a> * <a href="#type-operation_receipt">operation_receipt</a>)</span> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding that mixes an operation data and its receipt.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_data_and_receipt_encoding_with_legacy_attestation_name"><a href="#val-operation_data_and_receipt_encoding_with_legacy_attestation_name" class="anchor"></a><code><span><span class="keyword">val</span> operation_data_and_receipt_encoding_with_legacy_attestation_name : 
  <span><span>(<a href="#type-operation_data">operation_data</a> * <a href="#type-operation_receipt">operation_receipt</a>)</span> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding that mixes an operation data and its receipt. This encoding uses the attestation legacy name: endorsement.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-acceptable_pass"><a href="#val-acceptable_pass" class="anchor"></a><code><span><span class="keyword">val</span> acceptable_pass : <span><a href="#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>acceptable_pass op</code> gives the validation pass in which the input operation <code>op</code> can appear. For instance, it results in <code>Some 0</code> if <code>op</code> only belongs to the first pass. When <code>op</code> is ill-formed, <code>acceptable_pass op</code> returns <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compare_operations"><a href="#val-compare_operations" class="anchor"></a><code><span><span class="keyword">val</span> compare_operations : 
  <span><span>(<a href="../../Operation_hash/index.html#type-t">Operation_hash.t</a> * <a href="#type-operation">operation</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../Operation_hash/index.html#type-t">Operation_hash.t</a> * <a href="#type-operation">operation</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  int</span></code></div><div class="spec-doc"><p><code>compare_operations (oph1,op1) (oph2,op2)</code> defines a total ordering relation on valid operations.</p><p>The following requirements must be satisfied: <code>oph1</code> is the <code>Operation.hash.p1</code>, <code>oph2</code> is <code>Operation.hash op2</code> and that <code>op1</code> and <code>op2</code> are valid in the same context.</p><p><code>compare_operations (oph1,op1) (oph2,op2) = 0</code> happens only if <code>Operation_hash.compare oph1 oph2 = 0</code>, meaning <code>op1 = op2</code> only when <code>op1</code> and <code>op2</code> are structurally identical.</p><p>Two operations of different validation_passes are compared in the reverse order of their <code>validation_pass</code>: the one with the smaller <code>validation_pass</code> is compared as being the greater.</p><p>When belonging to the same validation_pass, two operations comparison depends on their static parameters. An abstract weight is computed for each operation based on its static parameters. When two operations' weights are compared as equal, <code>compare_operation (oph1,op1) (oph2,op2)</code> is <code>Operation_hash.compare oph1 oph2</code>.</p><p><code>compare_operations</code> can be used as a <code>compare</code> component of an <code>Stdlib.Map.OrderedType</code>, or any such collection which relies on a total comparison function.</p></div></div><h3 id="block-(and-operation)-validation-and-application"><a href="#block-(and-operation)-validation-and-application" class="anchor"></a>Block (and operation) validation and application</h3><p>The following functions may be used when an existing block is received through the network, when a new block is created, or when operations are considered on their own e.g. in a mempool or during an RPC call.</p><p>Validation aims at deciding quickly whether a block or an operation is valid, with minimal computations and without writing anything in the storage. A block is valid if it can be applied without failure. An operation is valid if it can be safely included in a block without causing it to fail.</p><p>The application of an operation updates the <a href="../../Context/index.html#type-t"><code>Context.t</code></a> with regards to its semantics (e.g. updating balances after a transaction). The application of a block updates the context with all its operations and some additional global effects. Isolated operations may be applied as part of an RPC call to simulate their effects.</p><p>Blocks and operations must always be validated before they are applied. Indeed, the application assumes their validity as a precondition, meaning that the application of an invalid block might yield incorrect results instead of failing cleanly.</p><p>Note that in protocol versions &lt;= K, where the validation functions do not yet exist, the validation of existing blocks is done by trying to apply it using the <code>Partial_validation</code> mode below. Therefore, the application of a validated block may still fail in these protocols.</p><div class="odoc-spec"><div class="spec type anchored" id="type-mode"><a href="#type-mode" class="anchor"></a><code><span><span class="keyword">type</span> mode</span><span> = </span></code><ol><li id="type-mode.Application" class="def variant constructor anchored"><a href="#type-mode.Application" class="anchor"></a><code><span>| </span><span><span class="constructor">Application</span> <span class="keyword">of</span> <a href="#type-block_header">block_header</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Standard validation or application of a preexisting block.</p><span class="comment-delim">*)</span></div></li><li id="type-mode.Partial_validation" class="def variant constructor anchored"><a href="#type-mode.Partial_validation" class="anchor"></a><code><span>| </span><span><span class="constructor">Partial_validation</span> <span class="keyword">of</span> <a href="#type-block_header">block_header</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Partial validation of a preexisting block. This mode is meant to quickly reject obviously invalid alternate branches by only performing a subset of checks. Therefore, application of blocks or operations makes no sense in this mode: calling <code>begin_application</code> with this mode returns an error.</p><span class="comment-delim">*)</span></div></li><li id="type-mode.Construction" class="def variant constructor anchored"><a href="#type-mode.Construction" class="anchor"></a><code><span>| </span><span><span class="constructor">Construction</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-mode.predecessor_hash" class="def record field anchored"><a href="#type-mode.predecessor_hash" class="anchor"></a><code><span>predecessor_hash : <a href="../../Block_hash/index.html#type-t">Block_hash.t</a>;</span></code></li><li id="type-mode.timestamp" class="def record field anchored"><a href="#type-mode.timestamp" class="anchor"></a><code><span>timestamp : <a href="../../Time/index.html#type-t">Time.t</a>;</span></code></li><li id="type-mode.block_header_data" class="def record field anchored"><a href="#type-mode.block_header_data" class="anchor"></a><code><span>block_header_data : <a href="#type-block_header_data">block_header_data</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Construction of a new block. The main difference with the previous modes is that we cannot provide the block header to the <code>begin_</code> functions, since the block does not exist yet. Note that the <code>begin_</code> functions may be called in this mode without knowing yet which operations will be included in the future block.</p><p>The provided <code>block_header_data</code> is not expected to be the final value of the field of the same type in the <a href="#type-block_header"><code>block_header</code></a> of the constructed block. Instead, it should be a protocol-specific, good enough, &quot;prototype&quot; of the final value. E.g. if the <a href="#type-block_header_data"><code>block_header_data</code></a> type for the current economic protocol includes a signature, then the provided <code>block_header_data</code> should contain a fake signature (since providing a correct signature is not possible at this stage).</p><span class="comment-delim">*)</span></div></li><li id="type-mode.Partial_construction" class="def variant constructor anchored"><a href="#type-mode.Partial_construction" class="anchor"></a><code><span>| </span><span><span class="constructor">Partial_construction</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-mode.predecessor_hash" class="def record field anchored"><a href="#type-mode.predecessor_hash" class="anchor"></a><code><span>predecessor_hash : <a href="../../Block_hash/index.html#type-t">Block_hash.t</a>;</span></code></li><li id="type-mode.timestamp" class="def record field anchored"><a href="#type-mode.timestamp" class="anchor"></a><code><span>timestamp : <a href="../../Time/index.html#type-t">Time.t</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Minimal construction of a new virtual block, with the purpose of being able to validate/apply operations of interest. This mode may be used by the mempool (though the <code>Mempool</code> module below is better suited for this) or by some RPCs e.g. <code>preapply/operations</code>. Calling the <code>finalize_</code> functions makes no sense in this mode.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>The mode indicates the circumstances in which a block and/or operations are validated or applied, and contains specific information. It must be provided as an argument to <code>begin_validation</code> and <code>begin_application</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-validation_state"><a href="#type-validation_state" class="anchor"></a><code><span><span class="keyword">type</span> validation_state</span></code></div><div class="spec-doc"><p>A functional state that is transmitted throughout the validation of a block (or during the lifetime of a mempool or RPC). It is created by <code>begin_validation</code> below, updated by <code>validate_operation</code>, and required by <code>finalize_validation</code>. This state is immutable thus validator or baker implementations are allowed to pause, replay or backtrack throughout validation steps.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-application_state"><a href="#type-application_state" class="anchor"></a><code><span><span class="keyword">type</span> application_state</span></code></div><div class="spec-doc"><p>Similar to <a href="#type-validation_state"><code>validation_state</code></a>, but for the application process.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_validation"><a href="#val-begin_validation" class="anchor"></a><code><span><span class="keyword">val</span> begin_validation : 
  <span><a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-mode">mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>begin_validation predecessor_context chain_id mode
      ~predecessor</code> initializes the <a href="#type-validation_state"><code>validation_state</code></a> for the validation process of an existing or new block.</p><p><code>predecessor_context</code> and <code>predecessor</code> are the resulting context and shell header of the predecessor block. Exceptionally in <a href="#type-mode.Partial_validation"><code>Partial_validation</code></a> mode, they may instead come from any ancestor block that is more recent (i.e. has a greater level) than the current head's &quot;last_allowed_fork_level&quot;.</p><p><code>mode</code> specifies the circumstances of validation and also carries additional information: see <a href="#type-mode"><code>mode</code></a>.</p><p>Note that for protocol versions &lt;= K where <code>begin_validation</code> does not exist yet, this calls the old <code>begin_application</code> by necessity. However, in <code>Application</code> mode, this calls the old <code>begin_application</code> in <code>Partial_validation</code> mode in order to run more quickly. This preserves the behavior of <code>precheck</code> in <code>lib_validation/block_validation.ml</code> for old protocols. It does mean that the application of a validated block may fail in these protocols.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_operation"><a href="#val-validate_operation" class="anchor"></a><code><span><span class="keyword">val</span> validate_operation : 
  <span><span class="optlabel">?check_signature</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-validation_state">validation_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Operation_hash/index.html#type-t">Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Validate an operation. If successful, return the updated <a href="#type-validation_state"><code>validation_state</code></a>.</p><p><code>check_signature</code> indicates whether the signature should be checked. It defaults to <code>true</code> because the signature needs to be correct for the operation to be valid. This argument exists for special cases where it is acceptable to bypass this check, e.g. if we know that the operation has already been successfully validated in another context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_validation"><a href="#val-finalize_validation" class="anchor"></a><code><span><span class="keyword">val</span> finalize_validation : <span><a href="#type-validation_state">validation_state</a> <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Run final and global checks on the block that must come after the validation of all its operations to establish its validity.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_application"><a href="#val-begin_application" class="anchor"></a><code><span><span class="keyword">val</span> begin_application : 
  <span><a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-mode">mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-application_state">application_state</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialize the <a href="#type-application_state"><code>application_state</code></a> for the application process of an existing or new block. See <a href="#val-begin_validation"><code>begin_validation</code></a> for details on the arguments.</p><p>In protocol versions &gt; K, calling this function with the <a href="#type-mode.Partial_validation"><code>Partial_validation</code></a> mode returns an error.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_operation"><a href="#val-apply_operation" class="anchor"></a><code><span><span class="keyword">val</span> apply_operation : 
  <span><a href="#type-application_state">application_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Operation_hash/index.html#type-t">Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-application_state">application_state</a> * <a href="#type-operation_receipt">operation_receipt</a>)</span> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Apply an operation. If successful, return the updated <a href="#type-application_state"><code>application_state</code></a> and the corresponding <a href="#type-operation_receipt"><code>operation_receipt</code></a>.</p><p>This should be called for all operations in a block, after <a href="#val-begin_application"><code>begin_application</code></a> and before <a href="#val-finalize_application"><code>finalize_application</code></a>. Moreover, the operation should have already been validated by <a href="#val-validate_operation"><code>validate_operation</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_application"><a href="#val-finalize_application" class="anchor"></a><code><span><span class="keyword">val</span> finalize_application : 
  <span><a href="#type-application_state">application_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../index.html#type-validation_result">validation_result</a> * <a href="#type-block_header_metadata">block_header_metadata</a>)</span> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Finalize the context resulting from the application of the contents of the block.</p><p>If there is no protocol migration, i.e. if the block being applied is not the last block of the current economic protocol, then the resulting context can be used in the future as input for the validation and application of its successor blocks.</p><p>In <a href="#type-mode.Construction"><code>Construction</code></a> mode, the <code>Block_header.shell_header option</code> argument must contain a value, which will be used to compute the <code>cache_nonce</code>. In other modes, it can as well be <code>None</code> since it will not be used.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_services"><a href="#val-rpc_services" class="anchor"></a><code><span><span class="keyword">val</span> rpc_services : <span><a href="../index.html#type-rpc_context">rpc_context</a> <a href="../../RPC_directory/index.html#type-t">RPC_directory.t</a></span></span></code></div><div class="spec-doc"><p><code>rpc_services</code> provides the list of remote procedures exported by this protocol implementation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../index.html#type-validation_result">validation_result</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>init chain_id ctxt hd</code> initializes the context, or upgrades the context after a protocol amendment. This function receives as arguments the <code>chain_id</code> of the current chain and the context <code>ctxt</code> resulting from the application of the block that triggered the amendment, as well as its header <code>hd</code>. This function should fail if the &quot;protocol stitching&quot;, i.e., the transition from a valid previous protocol to the one being activated, has not been implemented.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-value_of_key"><a href="#val-value_of_key" class="anchor"></a><code><span><span class="keyword">val</span> value_of_key : 
  <span><span class="label">chain_id</span>:<a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_context</span>:<a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../../Int32/index.html#type-t">Int32.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_fitness</span>:<a href="../../Fitness/index.html#type-t">Fitness.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Block_hash/index.html#type-t">Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../../Context/Cache/index.html#type-key">Context.Cache.key</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span><a href="../../Context/Cache/index.html#type-value">Context.Cache.value</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span>)</span>
    <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span>
    <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>value_of_key chain_id predecessor_context
      predecessor_timestamp predecessor_level predecessor_fitness
      predecessor timestamp</code> returns a function to build one value of the cache from its key.</p><p>This function is used to restore all or part of the cache, for instance when booting a validator to preheat the cache, or when a reorganization happens. This function should never fail, returned errors are fatal.</p><p>The generated function is passed to <code>Context.Cache.load_caches</code> which will use it either immediately a cache-loading time or on-demand, when a given cached value is accessed.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Mempool"><a href="#module-Mempool" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Mempool/index.html">Mempool</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
