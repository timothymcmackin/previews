<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Cache (octez-proto-libs.Tezos_protocol_environment.V9.Make.Context.Cache)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../index.html">octez-proto-libs</a> &#x00BB; <a href="../../../../index.html">Tezos_protocol_environment</a> &#x00BB; <a href="../../../index.html">V9</a> &#x00BB; <a href="../../index.html">Make</a> &#x00BB; <a href="../index.html">Context</a> &#x00BB; Cache</nav><header class="odoc-preamble"><h1>Module <code><span>Context.Cache</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#cache-introspection">Cache introspection</a></li><li><a href="#cache-helpers-for-rpcs">Cache helpers for RPCs</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-key"><a href="#type-key" class="anchor"></a><code><span><span class="keyword">type</span> key</span><span> = <a href="../index.html#type-cache_key">cache_key</a></span></code></div><div class="spec-doc"><p>A key uniquely identifies a cached <code>value</code> in some subcache.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-value"><a href="#type-value" class="anchor"></a><code><span><span class="keyword">type</span> value</span><span> = <a href="../index.html#type-cache_value">cache_value</a></span><span> = </span><span>..</span></code></div><div class="spec-doc"><p>Cached values inhabit an extensible type.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-key_of_identifier"><a href="#val-key_of_identifier" class="anchor"></a><code><span><span class="keyword">val</span> key_of_identifier : <span><span class="label">cache_index</span>:int <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-key">key</a></span></code></div><div class="spec-doc"><p><code>key_of_identifier ~cache_index identifier</code> builds a key from the <code>cache_index</code> and the <code>identifier</code>.</p><p>No check are made to ensure the validity of the index.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-identifier_of_key"><a href="#val-identifier_of_key" class="anchor"></a><code><span><span class="keyword">val</span> identifier_of_key : <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>identifier_of_key key</code> returns the identifier associated to the <code>key</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><a href="../../Format/index.html#type-formatter">Format.formatter</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>pp fmt cache</code> is a pretty printer for a <code>cache</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find"><a href="#val-find" class="anchor"></a><code><span><span class="keyword">val</span> find : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-value">value</a> option</span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>find ctxt k = Some v</code> if <code>v</code> is the value associated to <code>k</code> in in the cache where <code>k</code> is. Returns <code>None</code> if there is no such value in the cache of <code>k</code>. This function is in the Lwt monad because if the value has not been constructed, it is constructed on the fly.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_cache_layout"><a href="#val-set_cache_layout" class="anchor"></a><code><span><span class="keyword">val</span> set_cache_layout : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-t">t</a> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>set_cache_layout ctxt layout</code> sets the caches of <code>ctxt</code> to comply with given <code>layout</code>. If there was already a cache in <code>ctxt</code>, it is erased by the new layout.</p><p>Otherwise, a fresh collection of empty caches is reconstructed from the new <code>layout</code>. Notice that cache <code>key</code>s are invalidated in that case, i.e., <code>get t k</code> will return <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update"><a href="#val-update" class="anchor"></a><code><span><span class="keyword">val</span> update : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-value">value</a> * int)</span> option</span> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-t">t</a></span></code></div><div class="spec-doc"><p><code>update ctxt k (Some (e, size))</code> returns a cache where the value <code>e</code> of <code>size</code> is associated to key <code>k</code>. If <code>k</code> is already in the cache, the cache entry is updated.</p><p><code>update ctxt k None</code> removes <code>k</code> from the cache.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sync"><a href="#val-sync" class="anchor"></a><code><span><span class="keyword">val</span> sync : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">cache_nonce</span>:<a href="../../Bytes/index.html#type-t">Bytes.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-t">t</a> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>sync ctxt ~cache_nonce</code> updates the context with the domain of the cache computed so far. Such function is expected to be called at the end of the validation of a block, when there is no more accesses to the cache.</p><p><code>cache_nonce</code> identifies the block that introduced new cache entries. The nonce should identify uniquely the block which modifies this value. It cannot be the block hash for circularity reasons: The value of the nonce is stored onto the context and consequently influences the context hash of the very same block. Such nonce cannot be determined by the shell and its computation is delegated to the economic protocol.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear"><a href="#val-clear" class="anchor"></a><code><span><span class="keyword">val</span> clear : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-t">t</a></span></code></div><div class="spec-doc"><p><code>clear ctxt</code> removes all cache entries.</p></div></div><h4 id="cache-introspection"><a href="#cache-introspection" class="anchor"></a>Cache introspection</h4><div class="odoc-spec"><div class="spec value anchored" id="val-list_keys"><a href="#val-list_keys" class="anchor"></a><code><span><span class="keyword">val</span> list_keys : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">cache_index</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-key">key</a> * int)</span> list</span> option</span></span></code></div><div class="spec-doc"><p><code>list_keys ctxt ~cache_index</code> returns the list of cached keys in cache numbered <code>cache_index</code> along with their respective <code>size</code>. The returned list is sorted in terms of their age in the cache, the oldest coming first. If <code>cache_index</code> is invalid, then this function returns <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-key_rank"><a href="#val-key_rank" class="anchor"></a><code><span><span class="keyword">val</span> key_rank : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>key_rank index ctxt key</code> returns the number of cached value older than the given <code>key</code>; or, <code>None</code> if the <code>key</code> is not a cache key.</p></div></div><h4 id="cache-helpers-for-rpcs"><a href="#cache-helpers-for-rpcs" class="anchor"></a>Cache helpers for RPCs</h4><div class="odoc-spec"><div class="spec value anchored" id="val-future_cache_expectation"><a href="#val-future_cache_expectation" class="anchor"></a><code><span><span class="keyword">val</span> future_cache_expectation : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">time_in_blocks</span>:int <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-t">t</a></span></code></div><div class="spec-doc"><p><code>future_cache_expectation ctxt ~time_in_blocks</code> returns <code>ctxt</code> except that the entries of the caches that are presumably too old to still be in the caches in <code>n_blocks</code> are removed.</p><p>This function is based on a heuristic. The context maintains the median of the number of removed entries: this number is multiplied by `n_blocks` to determine the entries that are likely to be removed in `n_blocks`.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cache_size"><a href="#val-cache_size" class="anchor"></a><code><span><span class="keyword">val</span> cache_size : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">cache_index</span>:int <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>cache_size ctxt ~cache_index</code> returns an overapproximation of the size of the cache. Returns <code>None</code> if <code>cache_index</code> is not a valid cache index.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cache_size_limit"><a href="#val-cache_size_limit" class="anchor"></a><code><span><span class="keyword">val</span> cache_size_limit : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">cache_index</span>:int <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>cache_size_limit ctxt ~cache_index</code> returns the maximal size of the cache indexed by <code>cache_index</code>. Returns <code>None</code> if <code>cache_index</code> is not a valid cache index.</p></div></div></div></body></html>
