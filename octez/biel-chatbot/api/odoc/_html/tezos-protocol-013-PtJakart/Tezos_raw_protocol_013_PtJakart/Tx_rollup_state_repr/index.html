<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tx_rollup_state_repr (tezos-protocol-013-PtJakart.Tezos_raw_protocol_013_PtJakart.Tx_rollup_state_repr)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-013-PtJakart</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_013_PtJakart</a> &#x00BB; Tx_rollup_state_repr</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_013_PtJakart.Tx_rollup_state_repr</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The state of a transaction rollup is a set of variables whose values vary in time, as the rollup progresses.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-initial_state"><a href="#val-initial_state" class="anchor"></a><code><span><span class="keyword">val</span> initial_state : 
  <span><span class="label">pre_allocated_storage</span>:<a href="../../Tezos_protocol_environment_013_PtJakart/Z/index.html#type-t">Tezos_protocol_environment_013_PtJakart.Z.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>initial_state pre_allocated_storage</code> returns the initial state of a transaction rollup (after its origination) with <code>pre_allocated_storage</code> bytes of storage already paid for.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_013_PtJakart/Data_encoding/index.html#type-t">Tezos_protocol_environment_013_PtJakart.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><a href="../../Tezos_protocol_environment_013_PtJakart/Format/index.html#type-formatter">Tezos_protocol_environment_013_PtJakart.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update_burn_per_byte"><a href="#val-update_burn_per_byte" class="anchor"></a><code><span><span class="keyword">val</span> update_burn_per_byte : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">elapsed</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">factor</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">final_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">hard_limit</span>:int <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>update_burn_per_byte state ~elapsed ~factor ~final_size
    ~hard_limit</code> updates the cost per byte to be paid for each message submitted to the rollup. This is done by computing a moving average for <code>factor</code> snapshots. Each snapshot being the size of the total messages for the rollup. Hence each snapshot contributes to <code>1/(1 + factor)</code> to the average.</p><p>It may happen that the rollup does not receive any message for some period of time. The parameter <code>elapsed</code> allows that to be taken into account. If <code>elapsed=n</code> with <code>n&gt;=1</code> it is similar as if <code>update_burn_per_byte</code> was called <code>n</code> times with <code>final_size=0</code>.</p><p>Once the exponential moving average <code>ema</code> is computed, we use the <code>hard limit</code> to know whether the cost per byte should be updated:</p><p>1. If <code>ema &lt;= 80</code> then the cost per byte is decreased</p><p>2. If <code>80 &lt; ema &lt;= 90</code> then the cost per byte is stable</p><p>3. If <code>90 &lt; ema</code> then the cost ber byte is increased</p><p>The rationale behind this mechanics is to adapt the cost of a transactional rollup depending on its activity. This can be used to prevent from some spamming attacks.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-burn_cost"><a href="#val-burn_cost" class="anchor"></a><code><span><span class="keyword">val</span> burn_cost : 
  <span><span class="label">limit</span>:<span><a href="../Tez_repr/index.html#type-t">Tez_repr.t</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tez_repr/index.html#type-t">Tez_repr.t</a> <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>burn_cost ~limit state size</code> computes the burn to be paid to submit <code>size</code> bytes in the inbox of the transactional rollup.</p><p>Returns <code>Tx_rollup_submit_batch_burn_exceeded</code> if the (computed) burn exceeds <code>limit</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-has_valid_commitment_at"><a href="#val-has_valid_commitment_at" class="anchor"></a><code><span><span class="keyword">val</span> has_valid_commitment_at : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>has_valid_commitment_at state level</code> returns <code>true</code> iff there is a valid commitment for <code>level</code> in the layer-1 storage.</p><p>On the contrary, if there is not commitment for <code>level</code> in the layer-1 storage, or if there exists an orphan commitment (that is, a commitment which has been rejected, or with one of its ancestors that has been rejected) at <code>level</code>, this function returns <code>false</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-uncommitted_inboxes_count"><a href="#val-uncommitted_inboxes_count" class="anchor"></a><code><span><span class="keyword">val</span> uncommitted_inboxes_count : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>uncommitted_inboxes_count state</code> returns the number of inboxes the rollup current has in the storage which did not receive a commitment yet.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-commitments_count"><a href="#val-commitments_count" class="anchor"></a><code><span><span class="keyword">val</span> commitments_count : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>commitments_count t</code> returns the number of commitment still in the layer-1 context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inboxes_count"><a href="#val-inboxes_count" class="anchor"></a><code><span><span class="keyword">val</span> inboxes_count : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>inboxes_count state</code> returns the number of inboxes the rollup current has in the storage.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-next_commitment_to_finalize"><a href="#val-next_commitment_to_finalize" class="anchor"></a><code><span><span class="keyword">val</span> next_commitment_to_finalize : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> option</span></span></code></div><div class="spec-doc"><p><code>next_commitment_to_finalize state</code> returns the rollup level of the next commitment to be finalized.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-next_commitment_to_remove"><a href="#val-next_commitment_to_remove" class="anchor"></a><code><span><span class="keyword">val</span> next_commitment_to_remove : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> option</span></span></code></div><div class="spec-doc"><p><code>next_commitment_to_remove state</code> returns the rollup level of the next commitment to be removed from the layer-1 context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalized_commitment_oldest_level"><a href="#val-finalized_commitment_oldest_level" class="anchor"></a><code><span><span class="keyword">val</span> finalized_commitment_oldest_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> option</span></span></code></div><div class="spec-doc"><p><code>finalized_commitment_oldest_level state</code> returns the rollup level of the oldest finalized commitment.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-next_commitment_level"><a href="#val-next_commitment_level" class="anchor"></a><code><span><span class="keyword">val</span> next_commitment_level : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a>
    <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>next_commitment_level current_level state</code> returns the expected level of the next valid commitment.</p><p>This function can return the error <code>No_uncommitted_inbox</code> if there is no inbox awaiting a commitment.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-next_commitment_predecessor"><a href="#val-next_commitment_predecessor" class="anchor"></a><code><span><span class="keyword">val</span> next_commitment_predecessor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Tx_rollup_commitment_repr/Hash/index.html#type-t">Tx_rollup_commitment_repr.Hash.t</a> option</span></span></code></div><div class="spec-doc"><p><code>next_commitment_predecessor state</code> returns the expected predecessor hash of the next valid commitment.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-record_inbox_creation"><a href="#val-record_inbox_creation" class="anchor"></a><code><span><span class="keyword">val</span> record_inbox_creation : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-t">t</a> * <a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> * <a href="../../Tezos_protocol_environment_013_PtJakart/Z/index.html#type-t">Tezos_protocol_environment_013_PtJakart.Z.t</a>)</span>
    <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>record_inbox_creation state level</code> updates the state of a rollup to take into account the creation of of a new inbox at the given Tezos <code>level</code>, and returns the rollup level to associate to this inbox and the number of bytes allocated for the inbox.</p><p>This function may return an <code>Internal_error</code> iff an inbox has already been created at a level greater (or equal) than <code>level</code>. It is the responsibility of the caller to avoid that.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-record_inbox_deletion"><a href="#val-record_inbox_deletion" class="anchor"></a><code><span><span class="keyword">val</span> record_inbox_deletion : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>record_inbox_deletion state level</code> updates <code>state</code> to take into account the deletion of the inbox stored at Tezos <code>level</code> from the storage.</p><p>This function returns an <code>Internal_error</code> iff there is no inbox in the storage of the layer-1, or if <code>level</code> is not the oldest level of rollup.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-record_commitment_creation"><a href="#val-record_commitment_creation" class="anchor"></a><code><span><span class="keyword">val</span> record_commitment_creation : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_commitment_repr/Hash/index.html#type-t">Tx_rollup_commitment_repr.Hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>record_commitment_creation state level</code> updates <code>state</code> to take into account the creation of a commitment at a given Tezos <code>level</code>.</p><p>This function returns an <code>Internal_error</code> if <code>level</code> is not the successor level of the current commitment head, or if <code>level</code> is greater than the inbox head.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-record_commitment_rejection"><a href="#val-record_commitment_rejection" class="anchor"></a><code><span><span class="keyword">val</span> record_commitment_rejection : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Tx_rollup_commitment_repr/Hash/index.html#type-t">Tx_rollup_commitment_repr.Hash.t</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>record_commitment_rejection state level pred_hash</code> updates <code>state</code> to take into account the fact that the commitment for the inbox at <code>level</code> has been rejected.</p><p>The caller is expected to provide the predecessor hash the next valid commitment needs to use. It can be omitted under two circumstances: if <code>level = root</code>, or if the commitment identified by <code>pred_hash</code> is no longer in the layer-1 context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-record_commitment_deletion"><a href="#val-record_commitment_deletion" class="anchor"></a><code><span><span class="keyword">val</span> record_commitment_deletion : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_commitment_repr/Hash/index.html#type-t">Tx_rollup_commitment_repr.Hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_message_result_hash_repr/index.html#type-t">Tx_rollup_message_result_hash_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>record_commitment_deletion state level msg_hash commitment_hash</code> updates <code>state</code> to take into account the deletion of a commitment at a given rollup <code>level</code>, and of given <code>commitment_hash</code> and whose last message commitment is <code>msg_hash</code>.</p><p>This function returns an <code>Internal_error</code> if <code>level</code> is not the commitment tail, that is the oldest finalized commitment.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalized_commitments_range"><a href="#val-finalized_commitments_range" class="anchor"></a><code><span><span class="keyword">val</span> finalized_commitments_range : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> * <a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a>)</span> option</span></span></code></div><div class="spec-doc"><p><code>finalized_commitments_range state</code> returns the window of finalized commitments that have not yet been cleaned out</p><p>This function returns an <code>Internal_error</code> if the state is inconsistent, which should not be possible.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_level_can_be_rejected"><a href="#val-check_level_can_be_rejected" class="anchor"></a><code><span><span class="keyword">val</span> check_level_can_be_rejected : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>check_level_can_be_rejected state level</code> raises <code>Cannot_reject_level</code> iff there does not exist a commitment at <code>level</code> that is not yet finalized.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-last_removed_commitment_hashes"><a href="#val-last_removed_commitment_hashes" class="anchor"></a><code><span><span class="keyword">val</span> last_removed_commitment_hashes : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Tx_rollup_message_result_hash_repr/index.html#type-t">Tx_rollup_message_result_hash_repr.t</a> * <a href="../Tx_rollup_commitment_repr/Hash/index.html#type-t">Tx_rollup_commitment_repr.Hash.t</a>)</span>
    option</span></span></code></div><div class="spec-doc"><p><code>last_removed_commitment_hashes state</code> returns two hashes associated to the last removed commitment: the message result hash and the last commitment hash.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-head_levels"><a href="#val-head_levels" class="anchor"></a><code><span><span class="keyword">val</span> head_levels : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> * <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>)</span> option</span></span></code></div><div class="spec-doc"><p><code>head_levels state</code> returns the level of the last inbox which has been created in the layer-1 context, along with the Tezos level at which said inbox has been created.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-adjust_storage_allocation"><a href="#val-adjust_storage_allocation" class="anchor"></a><code><span><span class="keyword">val</span> adjust_storage_allocation : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">delta</span>:<a href="../../Tezos_protocol_environment_013_PtJakart/Z/index.html#type-t">Tezos_protocol_environment_013_PtJakart.Z.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-t">t</a> * <a href="../../Tezos_protocol_environment_013_PtJakart/Z/index.html#type-t">Tezos_protocol_environment_013_PtJakart.Z.t</a>)</span>
    <a href="../../Tezos_protocol_environment_013_PtJakart/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_013_PtJakart.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>adjust_storage_allocation state ~delta</code> accounts for a change in <code>delta</code> number of bytes used storage space by a transaction rollup.</p><p>A positive <code>delta</code> indicates that the occupied storage of the rollup increased. A negative <code>delta</code> indicates that the occupied storage of the rollup decreased.</p><p>Along with an updated state, a diff of storage space is returned. The diff is <code>max(0, allocated_storage - (occupied_storage + delta))</code>. That is, 0 if no new storage was allocated, and the number of bytes allocated otherwise.</p><p>This function returns <code>Tx_rollup_errors.Internal_error</code> if submitted <code>delta</code> would make <code>occupied_storage</code> negative.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
