<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Batch_V1 (tezos-protocol-013-PtJakart.Tezos_raw_protocol_013_PtJakart.Tx_rollup_l2_apply.Make.Batch_V1)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../index.html">tezos-protocol-013-PtJakart</a> &#x00BB; <a href="../../../index.html">Tezos_raw_protocol_013_PtJakart</a> &#x00BB; <a href="../../index.html">Tx_rollup_l2_apply</a> &#x00BB; <a href="../index.html">Make</a> &#x00BB; Batch_V1</nav><header class="odoc-preamble"><h1>Module <code><span>Make.Batch_V1</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-apply_batch"><a href="#val-apply_batch" class="anchor"></a><code><span><span class="keyword">val</span> apply_batch : 
  <span><a href="../index.html#type-ctxt">ctxt</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../index.html#type-parameters">parameters</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../Indexable/index.html#type-unknown">Indexable.unknown</a>, <a href="../../../Indexable/index.html#type-unknown">Indexable.unknown</a>)</span> <a href="../../../Tx_rollup_l2_batch/V1/index.html#type-t">Tx_rollup_l2_batch.V1.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../index.html#type-ctxt">ctxt</a> * <a href="../../Message_result/Batch_V1/index.html#type-t">Message_result.Batch_V1.t</a> * <span><a href="../../../Alpha_context/Tx_rollup_withdraw/index.html#type-t">Alpha_context.Tx_rollup_withdraw.t</a> list</span>)</span>
    <a href="../argument-1-Context/index.html#type-m">Context.m</a></span></span></code></div><div class="spec-doc"><p><code>apply_batch ctxt parameters batch</code> interprets the batch <a href="../../../Tx_rollup_l2_batch/V1/index.html#type-t"><code>Tx_rollup_l2_batch.V1.t</code></a>.</p><p>By construction, a failing transaction will not affect the <code>ctxt</code> and other transactions will still be interpreted. That is, this function can only fail because of internals errors. Otherwise, the errors that caused the transactions to fail can be observed in the result (see <a href="../../Message_result/Batch_V1/index.html#type-t"><code>Message_result.Batch_V1.t</code></a>).</p><p>The counters are incremented when the operation is part of a transaction that is correctly signed and whose every operations have the expected counter. In particular, the result of the application is not important (i.e. the counters are updated even if the transaction failed).</p><p>In addition, the list of withdrawals resulting from each layer2-to-layer1 transfer message in the batch is returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_signature"><a href="#val-check_signature" class="anchor"></a><code><span><span class="keyword">val</span> check_signature : 
  <span><a href="../index.html#type-ctxt">ctxt</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../Indexable/index.html#type-unknown">Indexable.unknown</a>, <a href="../../../Indexable/index.html#type-unknown">Indexable.unknown</a>)</span> <a href="../../../Tx_rollup_l2_batch/V1/index.html#type-t">Tx_rollup_l2_batch.V1.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../index.html#type-ctxt">ctxt</a>
   * <a href="../../index.html#type-indexes">indexes</a>
   * <span><span>(<a href="../../../Indexable/index.html#type-index_only">Indexable.index_only</a>, <a href="../../../Indexable/index.html#type-unknown">Indexable.unknown</a>)</span> <a href="../../../Tx_rollup_l2_batch/V1/index.html#type-t">Tx_rollup_l2_batch.V1.t</a></span>)</span>
    <a href="../argument-1-Context/index.html#type-m">Context.m</a></span></span></code></div><div class="spec-doc"><p><code>check_signature ctxt batch</code> asserts that <code>batch</code> is correctly signed.</p><p>We recall that <code>batch</code> may contain indexes, that is integers which replace larger values. The <code>signer</code> field of the <code>Tx_rollup_l2_batch.operation</code> type is concerned. This field is either the public key to be used to check the signature, or an index. In case of the public key, <code>check_signature</code> will check whether or not the related <a href="../../../Tx_rollup_l2_address/index.html#type-t"><code>Tx_rollup_l2_address.t</code></a> has already an index assigned, and allocate one if not.</p><p>Overall, <code>check_signature</code> returns the revised context, the list of newly allocated indexes, and an updated version of the batches where all <code>signer</code> field have been replaced by valid indexes.</p><p><b>Note:</b> What a user is expected to sign is the version of the operation it sends to the network. This is potentially unsafe, because it means the user signs indexes, not addresses nor ticket hashes. This poses two threats: Tezos reorganization, and malicious provider of indexes. A Tezos reorganization may imply that an index allocated to one address in a given branch is allocated to another address in another branch. We deal with this issue by making the rollup node aware of the Tezos level at each time an index is allocated. This allows to implement a RPC that can safely tell a client to use either the full value or the index, thanks to Tenderbake finality. To prevent the rollup node to lie, we will make the rollup node provide Merkle proofs that allows the client to verify that the index is correct.</p></div></div></div></body></html>
