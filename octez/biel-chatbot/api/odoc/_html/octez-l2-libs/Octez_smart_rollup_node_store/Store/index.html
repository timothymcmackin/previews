<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Store (octez-l2-libs.Octez_smart_rollup_node_store.Store)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-l2-libs</a> &#x00BB; <a href="../index.html">Octez_smart_rollup_node_store</a> &#x00BB; Store</nav><header class="odoc-preamble"><h1>Module <code><span>Octez_smart_rollup_node_store.Store</span></code></h1><p>The store module is a pointer to the latest version. However, in order to run long migrations in the background, this module allows to have a store which is a hybrid version of the last two versions.</p></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="../Store_v5/index.html">Store_v5</a> <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec value anchored" id="val-version"><a href="#val-version" class="anchor"></a><code><span><span class="keyword">val</span> version : <a href="../Store_version/index.html#type-t">Store_version.t</a></span></code></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="../Sql_store/index.html">Sql_store</a> <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec value anchored" id="val-sqlite_file_name"><a href="#val-sqlite_file_name" class="anchor"></a><code><span><span class="keyword">val</span> sqlite_file_name : string</span></code></div><div class="spec-doc"><p>Name of SQLite file in data directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-extra_sqlite_files"><a href="#val-extra_sqlite_files" class="anchor"></a><code><span><span class="keyword">val</span> extra_sqlite_files : <span>string list</span></span></code></div><div class="spec-doc"><p>Other files that make up the store.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><span><span class="type-var">'a</span> <a href="../../Tezos_layer2_store/Store_sigs/index.html#type-mode">Tezos_layer2_store.Store_sigs.mode</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span class="type-var">'a</span> <a href="../Sql_store/index.html#type-t">Sql_store.t</a></span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init mode ~data_dir</code> initializes the store and returns it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-export_store"><a href="#val-export_store" class="anchor"></a><code><span><span class="keyword">val</span> export_store : 
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">output_db_file</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>export_store ~data_dir ~output_db_file</code> exports the store database with data from the <code>data_dir</code> into the <code>output_db_file</code>. This function also removes data that is specific to the operator. This function is meant to be used to produce snapshots.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_transaction"><a href="#val-with_transaction" class="anchor"></a><code><span><span class="keyword">val</span> with_transaction : 
  <span><span><span class="type-var">_</span> <a href="../Sql_store/index.html#type-t">Sql_store.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../Octez_sqlite/Sqlite/index.html#type-conn">Octez_sqlite.Sqlite.conn</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_transaction store f</code> executes <code>f</code> with a single connection to the database in a transaction. I.e., if <code>f</code> returns an error or raises an exception, the store will not be modified.</p></div></div><h3 id="modules-for-storing-data-in-the-store"><a href="#modules-for-storing-data-in-the-store" class="anchor"></a>Modules for storing data in the store</h3><p>Each module maps to a table in the database. Every read and write function has two parameters: <code>store</code> and an optional <code>?conn</code>.</p><p>When <code>~conn</code> is provided, the database connection is used directly to execute the queries. If not, a new (or old) connection is taken from the pool of <code>store</code>.</p></details></div></details></div><div class="odoc-spec"><div class="spec type anchored" id="type-hybrid"><a href="#type-hybrid" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a hybrid</span></span><span> = </span><span>{</span></code><ol><li id="type-hybrid.v4" class="def record field anchored"><a href="#type-hybrid.v4" class="anchor"></a><code><span>v4 : <a href="../Store_v4/index.html#type-ro">Store_v4.ro</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>A read-only old V4 store.</p><span class="comment-delim">*)</span></div></li><li id="type-hybrid.v5" class="def record field anchored"><a href="#type-hybrid.v5" class="anchor"></a><code><span>v5 : <span><span class="type-var">'a</span> <a href="../Store_v5/index.html#type-t">Store_v5.t</a></span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>A read-write V5 store to which we migrate data and which we use to store new data.</p><span class="comment-delim">*)</span></div></li><li id="type-hybrid.migration_done" class="def record field anchored"><a href="#type-hybrid.migration_done" class="anchor"></a><code><span>migration_done : <span>bool <span class="xref-unresolved">Stdlib</span>.ref</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>A flag to indicate when the migration has terminated. When this is the case we only query the v5 store.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The hybrid store.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span class="keyword">nonrec</span> <span>'a t</span></span><span> = </span></code><ol><li id="type-t.Hybrid" class="def variant constructor anchored"><a href="#type-t.Hybrid" class="anchor"></a><code><span>| </span><span><span class="constructor">Hybrid</span> <span class="keyword">of</span> <span><span class="type-var">'a</span> <a href="#type-hybrid">hybrid</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Either a hybrid store when a bacground migration is running.</p><span class="comment-delim">*)</span></div></li><li id="type-t.Normal" class="def variant constructor anchored"><a href="#type-t.Normal" class="anchor"></a><code><span>| </span><span><span class="constructor">Normal</span> <span class="keyword">of</span> <span><span class="type-var">'a</span> <span class="xref-unresolved">{t}1</span></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Or a &quot;normal&quot; store, for the nominal case.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>The type of stores.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-rw"><a href="#type-rw" class="anchor"></a><code><span><span class="keyword">type</span> rw</span><span> = <span><a href="../../Tezos_layer2_store/Store_sigs/index.html#type-rw">Tezos_layer2_store.Store_sigs.rw</a> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ro"><a href="#type-ro" class="anchor"></a><code><span><span class="keyword">type</span> ro</span><span> = <span><a href="../../Tezos_layer2_store/Store_sigs/index.html#type-ro">Tezos_layer2_store.Store_sigs.ro</a> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_rw"><a href="#val-with_rw" class="anchor"></a><code><span><span class="keyword">val</span> with_rw : 
  <span><span><span class="type-var">'a</span> <a href="../../Tezos_layer2_store/Store_sigs/index.html#type-mode">Tezos_layer2_store.Store_sigs.mode</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-rw">rw</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_with_migration"><a href="#val-init_with_migration" class="anchor"></a><code><span><span class="keyword">val</span> init_with_migration : 
  <span><span><span class="type-var">'a</span> <a href="../../Tezos_layer2_store/Store_sigs/index.html#type-mode">Tezos_layer2_store.Store_sigs.mode</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Octez_smart_rollup/Metadata/index.html#type-t">Octez_smart_rollup.Metadata.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Initialize a store and run the corresponding migrations if needed. For the v4 -&gt; v5 transition, the migration is run in the background.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-readonly"><a href="#val-readonly" class="anchor"></a><code><span><span class="keyword">val</span> readonly : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Tezos_layer2_store/Store_sigs/index.html#type-ro">Tezos_layer2_store.Store_sigs.ro</a> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gc"><a href="#val-gc" class="anchor"></a><code><span><span class="keyword">val</span> gc : 
  <span><span><a href="../../Tezos_layer2_store/Store_sigs/index.html#type-rw">Tezos_layer2_store.Store_sigs.rw</a> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">level</span>:int32 <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_from"><a href="#val-read_from" class="anchor"></a><code><span><span class="keyword">val</span> read_from : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_to"><a href="#val-write_to" class="anchor"></a><code><span><span class="keyword">val</span> write_to : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">{t}1</span></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(@?~~&gt;)"><a href="#val-(@?~~&gt;)" class="anchor"></a><code><span><span class="keyword">val</span> (@?~~&gt;) : 
  <span><span><span><span>(<span><span class="type-var">'a</span> option</span>, <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<span><span class="type-var">'a</span> option</span>, <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><span class="type-var">'a</span> option</span>, <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>x @?~~&gt; y</code> executes <code>x</code> first and then <code>y</code> if <code>x</code> resolves to <code>None</code> (where <code>x</code> is an access to the V5 store and <code>y</code> to the V4 store).</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Commitments"><a href="#module-Commitments" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Commitments/index.html">Commitments</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Commitments_published_at_levels"><a href="#module-Commitments_published_at_levels" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Commitments_published_at_levels/index.html">Commitments_published_at_levels</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Inboxes"><a href="#module-Inboxes" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Inboxes/index.html">Inboxes</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Messages"><a href="#module-Messages" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Messages/index.html">Messages</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Outbox_messages"><a href="#module-Outbox_messages" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Outbox_messages/index.html">Outbox_messages</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Protocols"><a href="#module-Protocols" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Protocols/index.html">Protocols</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Dal_slots_headers"><a href="#module-Dal_slots_headers" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Dal_slots_headers/index.html">Dal_slots_headers</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Dal_slots_statuses"><a href="#module-Dal_slots_statuses" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Dal_slots_statuses/index.html">Dal_slots_statuses</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-L2_levels"><a href="#module-L2_levels" class="anchor"></a><code><span><span class="keyword">module</span> <a href="L2_levels/index.html">L2_levels</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-L2_blocks"><a href="#module-L2_blocks" class="anchor"></a><code><span><span class="keyword">module</span> <a href="L2_blocks/index.html">L2_blocks</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-State"><a href="#module-State" class="anchor"></a><code><span><span class="keyword">module</span> <a href="State/index.html">State</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
