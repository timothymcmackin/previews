<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (octez-injector.Octez_injector.Injector_functor.Make)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">octez-injector</a> &#x00BB; <a href="../../index.html">Octez_injector</a> &#x00BB; <a href="../index.html">Injector_functor</a> &#x00BB; Make</nav><header class="odoc-preamble"><h1>Module <code><span>Injector_functor.Make</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#parameters">Parameters</a></li><li><a href="#signature">Signature</a></li></ul></nav><div class="odoc-content"><h2 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h2><div class="odoc-spec"><div class="spec parameter anchored" id="argument-1-P"><a href="#argument-1-P" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="argument-1-P/index.html">P</a></span><span> : <a href="../../Injector_sigs/module-type-PARAMETERS/index.html">Injector_sigs.PARAMETERS</a></span></code></div></div><h2 id="signature"><a href="#signature" class="anchor"></a>Signature</h2><div class="odoc-spec"><div class="spec module anchored" id="module-Inj_operation"><a href="#module-Inj_operation" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Inj_operation/index.html">Inj_operation</a></span><span> : 
  <a href="../../Injector_sigs/module-type-INJECTOR_OPERATION/index.html">Injector_sigs.INJECTOR_OPERATION</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../Injector_sigs/module-type-INJECTOR_OPERATION/index.html#type-operation">operation</a> = <a href="argument-1-P/Operation/index.html#type-t">P.Operation.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-injected_info"><a href="#type-injected_info" class="anchor"></a><code><span><span class="keyword">type</span> injected_info</span><span> = </span><span>{</span></code><ol><li id="type-injected_info.op" class="def record field anchored"><a href="#type-injected_info.op" class="anchor"></a><code><span>op : <a href="Inj_operation/index.html#type-t">Inj_operation.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The injector operation.</p><span class="comment-delim">*)</span></div></li><li id="type-injected_info.oph" class="def record field anchored"><a href="#type-injected_info.oph" class="anchor"></a><code><span>oph : <a href="../../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The hash of the operation which contains <code>op</code> (this can be an L1 batch of several manager operations).</p><span class="comment-delim">*)</span></div></li><li id="type-injected_info.op_index" class="def record field anchored"><a href="#type-injected_info.op_index" class="anchor"></a><code><span>op_index : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The index of the operation <code>op</code> in the L1 batch corresponding to <code>oph</code>.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Information stored about an L1 operation that was injected on a Tezos node.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-included_info"><a href="#type-included_info" class="anchor"></a><code><span><span class="keyword">type</span> included_info</span><span> = </span><span>{</span></code><ol><li id="type-included_info.op" class="def record field anchored"><a href="#type-included_info.op" class="anchor"></a><code><span>op : <a href="Inj_operation/index.html#type-t">Inj_operation.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The injector operation.</p><span class="comment-delim">*)</span></div></li><li id="type-included_info.oph" class="def record field anchored"><a href="#type-included_info.oph" class="anchor"></a><code><span>oph : <a href="../../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The hash of the operation which contains <code>op</code> (this can be an L1 batch of several manager operations).</p><span class="comment-delim">*)</span></div></li><li id="type-included_info.op_index" class="def record field anchored"><a href="#type-included_info.op_index" class="anchor"></a><code><span>op_index : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The index of the operation <code>op</code> in the L1 batch corresponding to <code>oph</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-included_info.l1_block" class="def record field anchored"><a href="#type-included_info.l1_block" class="anchor"></a><code><span>l1_block : <a href="../../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The hash of the L1 block in which the operation was included.</p><span class="comment-delim">*)</span></div></li><li id="type-included_info.l1_level" class="def record field anchored"><a href="#type-included_info.l1_level" class="anchor"></a><code><span>l1_level : int32;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The level of <code>l1_block</code>.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Information stored about an L1 operation that was included in a Tezos block.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-status"><a href="#type-status" class="anchor"></a><code><span><span class="keyword">type</span> status</span><span> = </span></code><ol><li id="type-status.Pending" class="def variant constructor anchored"><a href="#type-status.Pending" class="anchor"></a><code><span>| </span><span><span class="constructor">Pending</span> <span class="keyword">of</span> <a href="argument-1-P/Operation/index.html#type-t">P.Operation.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The operation is pending injection.</p><span class="comment-delim">*)</span></div></li><li id="type-status.Injected" class="def variant constructor anchored"><a href="#type-status.Injected" class="anchor"></a><code><span>| </span><span><span class="constructor">Injected</span> <span class="keyword">of</span> <a href="#type-injected_info">injected_info</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The operation has been injected successfully in the node.</p><span class="comment-delim">*)</span></div></li><li id="type-status.Included" class="def variant constructor anchored"><a href="#type-status.Included" class="anchor"></a><code><span>| </span><span><span class="constructor">Included</span> <span class="keyword">of</span> <a href="#type-included_info">included_info</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The operation has been included in a L1 block.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Status of an operation in the injector.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><a href="../../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-full/index.html">Tezos_client_base.Client_context.full</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?retention_period</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?allowed_attempts</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?injection_ttl</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?collect_metrics</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../../octez-crawler/Octez_crawler/Layer_1/index.html#type-t">Octez_crawler.Layer_1.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="argument-1-P/index.html#type-state">P.state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">signers</span>:
    <span><span>(<span><a href="../../../../octez-libs/Tezos_crypto/Signature/index.html#type-public_key_hash">Tezos_base.TzPervasives.Signature.public_key_hash</a> list</span>
     * <a href="../../Injector_sigs/index.html#type-injection_strategy">Injector_sigs.injection_strategy</a>
     * <span><a href="argument-1-P/Tag/index.html#type-t">P.Tag.t</a> list</span>)</span>
      list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Initializes the injector with the rollup node state, for a list of signers, and start the workers. Each signer's list has its own worker with a queue of operations to inject.</p><p><code>retention_period</code> is the number of blocks for which the injector keeps the included information for, must be positive or zero. By default (when <code>0</code>), the injector will not keep information longer than necessary. It can be useful to set this value to something <code>&gt; 0</code> if we want to retrieve information about operations included on L1 for a given period.</p><p><code>allowed_attempts</code> is the number of attempts that will be made to inject an operation. Operations whose injection fails a number of times greater than this value will be discarded from the queue.</p><p><code>injection_ttl</code> is the number of blocks after which an operation that is injected but never include is retried.</p><p><code>collect_metrics</code> will allow the prometheus to register metrics for the injector.</p><p>Each pkh's list and tag list of <code>signers</code> must be disjoint.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_pending_operation"><a href="#val-add_pending_operation" class="anchor"></a><code><span><span class="keyword">val</span> add_pending_operation : 
  <span><span class="optlabel">?order</span>:<span class="xref-unresolved">Z</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><a href="argument-1-P/Operation/index.html#type-t">P.Operation.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../../octez-libs/Tezos_crypto/Hashed/Injector_operations_hash/index.html#type-t">Octez_injector.Injector_sigs.Id.t</a> <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Add an operation as pending injection in the injector. It returns the id of the operation in the injector queue.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inject"><a href="#val-inject" class="anchor"></a><code><span><span class="keyword">val</span> inject : 
  <span><span class="optlabel">?tags</span>:<span><a href="argument-1-P/Tag/index.html#type-t">P.Tag.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?header</span>:<a href="../../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Trigger an injection of the pending operations for all workers. If <code>tags</code> is given, only the workers which have a tag in <code>tags</code> inject their pending operations. <code>header</code> must be provided for the <code>`Delay_block</code> strategy to compute the next block timestamp.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Shutdown the injectors, waiting for the ongoing request to be processed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-running_worker_tags"><a href="#val-running_worker_tags" class="anchor"></a><code><span><span class="keyword">val</span> running_worker_tags : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><a href="argument-1-P/Tag/index.html#type-t">P.Tag.t</a> list</span> list</span></span></code></div><div class="spec-doc"><p>List of currently running injectors with their respective tags.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_status"><a href="#val-operation_status" class="anchor"></a><code><span><span class="keyword">val</span> operation_status : <span><a href="../../../../octez-libs/Tezos_crypto/Hashed/Injector_operations_hash/index.html#type-t">Octez_injector.Injector_sigs.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-status">status</a> option</span></span></code></div><div class="spec-doc"><p>The status of an operation in the injector.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-total_queued_operations"><a href="#val-total_queued_operations" class="anchor"></a><code><span><span class="keyword">val</span> total_queued_operations : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="argument-1-P/Tag/index.html#type-t">P.Tag.t</a> list</span> * int)</span> list</span> * int</span></code></div><div class="spec-doc"><p>Returns the total operations per worker queue and in total. This function is constant time excepted for the injectors iteration.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_queues"><a href="#val-get_queues" class="anchor"></a><code><span><span class="keyword">val</span> get_queues : 
  <span><span class="optlabel">?tag</span>:<a href="argument-1-P/Tag/index.html#type-t">P.Tag.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="argument-1-P/Tag/index.html#type-t">P.Tag.t</a> list</span> * <span><a href="Inj_operation/index.html#type-t">Inj_operation.t</a> list</span>)</span> list</span></span></code></div><div class="spec-doc"><p>Returns the queues of the injectors, with the oldest elements first. If <code>tag</code> is provided, returns the queue for the injector which handles this tag.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_queues"><a href="#val-clear_queues" class="anchor"></a><code><span><span class="keyword">val</span> clear_queues : 
  <span><span class="optlabel">?drop_no_order</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?order_below</span>:<span class="xref-unresolved">Z</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tag</span>:<a href="argument-1-P/Tag/index.html#type-t">P.Tag.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Clears the injectors queues completely. If <code>tag</code> is provided, only queues for the injector which handles this tag is cleared. If <code>order_below</code>, only operation with order below that value are cleared, and if <code>drop_no_order</code> is true, clear all operation that has no order specified.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-register_proto_client"><a href="#val-register_proto_client" class="anchor"></a><code><span><span class="keyword">val</span> register_proto_client : 
  <span><a href="../../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="../../Injector_sigs/module-type-PROTOCOL_CLIENT/index.html">Injector_sigs.PROTOCOL_CLIENT</a>
    <span class="keyword">with</span> <span class="keyword">type</span> <a href="../../Injector_sigs/module-type-PROTOCOL_CLIENT/index.html#type-operation">operation</a> = <a href="argument-1-P/Operation/index.html#type-t">P.Operation.t</a>
     <span class="keyword">and</span> <span class="keyword">type</span> <a href="../../Injector_sigs/module-type-PROTOCOL_CLIENT/index.html#type-state">state</a> = <a href="argument-1-P/index.html#type-state">P.state</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Register a protocol client for a specific protocol to be used by the injector. This function <b>must</b> be called for all protocols that the injector is meant support.</p></div></div></div></body></html>
