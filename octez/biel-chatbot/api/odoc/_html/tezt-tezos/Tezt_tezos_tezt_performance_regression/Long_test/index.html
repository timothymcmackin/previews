<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Long_test (tezt-tezos.Tezt_tezos_tezt_performance_regression.Long_test)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezt-tezos</a> &#x00BB; <a href="../index.html">Tezt_tezos_tezt_performance_regression</a> &#x00BB; Long_test</nav><header class="odoc-preamble"><h1>Module <code><span>Tezt_tezos_tezt_performance_regression.Long_test</span></code></h1><p>Long test registration and helpers.</p></header><nav class="odoc-toc"><ul><li><a href="#registering-tests">Registering Tests</a></li><li><a href="#alerts">Alerts</a></li><li><a href="#emitting-and-retrieving-data-points">Emitting And Retrieving Data Points</a></li><li><a href="#regression-testing">Regression Testing</a></li><li><a href="#graphs">Graphs</a></li><li><a href="#configuration">Configuration</a></li><li><a href="#internal-functions-for-debugging">Internal Functions for Debugging</a></li></ul></nav><div class="odoc-content"><h3 id="registering-tests"><a href="#registering-tests" class="anchor"></a>Registering Tests</h3><div class="odoc-spec"><div class="spec type anchored" id="type-timeout"><a href="#type-timeout" class="anchor"></a><code><span><span class="keyword">type</span> timeout</span><span> = </span></code><ol><li id="type-timeout.Seconds" class="def variant constructor anchored"><a href="#type-timeout.Seconds" class="anchor"></a><code><span>| </span><span><span class="constructor">Seconds</span> <span class="keyword">of</span> int</span></code></li><li id="type-timeout.Minutes" class="def variant constructor anchored"><a href="#type-timeout.Minutes" class="anchor"></a><code><span>| </span><span><span class="constructor">Minutes</span> <span class="keyword">of</span> int</span></code></li><li id="type-timeout.Hours" class="def variant constructor anchored"><a href="#type-timeout.Hours" class="anchor"></a><code><span>| </span><span><span class="constructor">Hours</span> <span class="keyword">of</span> int</span></code></li><li id="type-timeout.Days" class="def variant constructor anchored"><a href="#type-timeout.Days" class="anchor"></a><code><span>| </span><span><span class="constructor">Days</span> <span class="keyword">of</span> int</span></code></li></ol></div><div class="spec-doc"><p>Timeout specifications.</p><p>Contrary to regular tests, long tests must have a timeout. Indeed, as long tests can run for days, there is no global timeout. So if a test got stuck and never finished, the whole process would get stuck forever.</p><p>For instance, <code>Hours 10</code> means that your test should fail if it has been running for more than 10 hours.</p><p>Timeouts are only a safety measure to prevent a test from blocking forever. They are not meant to be used as a way to check that a test runs in a given amount of time. They should thus significantly be over-estimated. A good rule of thumb is to:</p><ul><li>multiply by 10 for tests that take minutes to run;</li><li>multiply by 5 for tests that take hours to run;</li><li>multiply by 2 for tests that take days to run. For instance, a test that usually takes between 10 to 20 hours to run could have a timeout of about 3 days.</li></ul><p>You should still try to avoid waiting for events that may not happen, and if you have to, try to also wait for another event that indicates that the first event will never happen. In other words, try to detect failures early.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-executor"><a href="#type-executor" class="anchor"></a><code><span><span class="keyword">type</span> executor</span></code></div><div class="spec-doc"><p>Machines on which to run a given test.</p><p>Tests that are very long (days) should run on their own executor, otherwise shorter tests will not be run very often.</p><p>Values of type <code>executor</code> are just tags that are added to tests. Executors will execute tests which have the tag that correspond to themselves (e.g. the x86 executor 1 will execute tests tagged with <code>x86_executor1</code>). If you specify an empty list of executors, the test will not run on any executor.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-x86_executor1"><a href="#val-x86_executor1" class="anchor"></a><code><span><span class="keyword">val</span> x86_executor1 : <a href="#type-executor">executor</a></span></code></div><div class="spec-doc"><p>AMD64 executor number 1.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-x86_executor2"><a href="#val-x86_executor2" class="anchor"></a><code><span><span class="keyword">val</span> x86_executor2 : <a href="#type-executor">executor</a></span></code></div><div class="spec-doc"><p>AMD64 executor number 2.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_replay_executor"><a href="#val-block_replay_executor" class="anchor"></a><code><span><span class="keyword">val</span> block_replay_executor : <a href="#type-executor">executor</a></span></code></div><div class="spec-doc"><p>Executor for the block-replay semantic regression tests</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-register"><a href="#val-register" class="anchor"></a><code><span><span class="keyword">val</span> register : 
  <span><span class="label">__FILE__</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">title</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">tags</span>:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?uses</span>:<span><a href="../../../octez-libs/Tezt_wrapper/Uses/index.html#type-t">Tezt_wrapper.Uses.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?uses_node</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?uses_client</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?uses_admin_client</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">team</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">executors</span>:<span><a href="#type-executor">executor</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timeout</span>:<a href="#type-timeout">timeout</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Wrapper over <code>Test.register</code> to register a performance regression test.</p><p>Differences with <code>Test.register</code> are:</p><ul><li>the <code>timeout</code> parameter;</li><li>if the test fails, an alert is emitted;</li><li>tag <code>&quot;long&quot;</code> is added;</li><li><code>team</code> is added to tags and is used to decide where to send alerts;</li><li><code>executors</code> specifies which machines shall run the test;</li><li>data points created with <code>add_data_point</code> and <code>measure</code> are pushed at the end of the test (whether it succeeds or not).</li></ul><p>Because an alert is emitted in case of failure, such tests are meant to be run not on the CI (which already sends e-mails in case a job fails) but on custom architectures. Although it can also make sense to emit alerts from the CI for a scheduled pipeline if nobody receives (or read) its alerts.</p><p>Alerts are only sent if the relevant configuration is set (see <a href="#val-alert"><code>alert</code></a>). <code>team</code> specifies which Slack webhook to use to send alerts. If <code>team</code> doesn't have a corresponding entry in the configuration file, the default Slack webhook is used.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_arg</code> <p>if <code>title</code> contains a newline character.</p></li></ul></div></div><h3 id="alerts"><a href="#alerts" class="anchor"></a>Alerts</h3><div class="odoc-spec"><div class="spec type anchored" id="type-category"><a href="#type-category" class="anchor"></a><code><span><span class="keyword">type</span> category</span><span> = string</span></code></div><div class="spec-doc"><p>category of an alert message</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-alert"><a href="#val-alert" class="anchor"></a><code><span><span class="keyword">val</span> alert : <span><span class="optlabel">?category</span>:<a href="#type-category">category</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, unit, string, unit)</span> <span class="xref-unresolved">Stdlib</span>.format4</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Emit an alert.</p><p>The alert is sent to a Slack channel. It is also written in logs with <code>Log.error</code>, prefixed with <code>&quot;Alert: &quot;</code>.</p><p>Be careful with alert fatigue: only send alerts that really need to be acted on. Each test can only send a maximum of 2 alerts, and the total number of alerts for all tests cannot exceed 100. Alerts can be sent outside of tests, in which case only the global limit applies.</p><p>If an alert for the pair <code>(category, team)</code> (where <code>team</code> is the argument given to <code>register</code>) was already sent less than <code>rate_limit_per_category</code> seconds ago, the alert will not be sent. See the Configuration section for documentation about <code>rate_limit_per_category</code>.</p><p>Default <code>category</code> is <code>&quot;&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-alert_exn"><a href="#val-alert_exn" class="anchor"></a><code><span><span class="keyword">val</span> alert_exn : <span>exn <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, unit, string, unit)</span> <span class="xref-unresolved">Stdlib</span>.format4</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Same as <code>alert</code>, but also log an exception.</p><p>The alert itself does not contain the exception, as it could contain sensitive data.</p></div></div><h3 id="emitting-and-retrieving-data-points"><a href="#emitting-and-retrieving-data-points" class="anchor"></a>Emitting And Retrieving Data Points</h3><div class="odoc-spec"><div class="spec value anchored" id="val-add_data_point"><a href="#val-add_data_point" class="anchor"></a><code><span><span class="keyword">val</span> add_data_point : <span><a href="../InfluxDB/index.html#type-data_point">InfluxDB.data_point</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Add a data point to be sent at the end of the current test.</p><p>If data points cannot be pushed at the end of the test, an alert is emitted.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_arg</code> <p>if no test is currently running, or if it was not registered with <code>Long_test.register</code> or <code>Long_test.register_with_protocol</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-query"><a href="#val-query" class="anchor"></a><code><span><span class="keyword">val</span> query : 
  <span><a href="../InfluxDB/index.html#type-select">InfluxDB.select</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span><a href="../InfluxDB/index.html#type-result_data_point">InfluxDB.result_data_point</a> list</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wrapper over <code>InfluxDB.query</code>.</p><p>This wrapper takes care of:</p><ul><li>providing the configuration;</li><li>emitting alerts in case something goes wrong;</li><li>adding a <code>test = &quot;test title&quot;</code> clause to the innermost SELECT of the query.</li></ul><p>This wrapper passes the query result to a function. The intended behavior of this function is to extract the results, e.g. check that they contain the expected number of series and the expected columns. If this function raises an exception, an alert is emitted and <code>query</code> returns <code>None</code>. <code>query</code> also returns returns <code>None</code> if InfluxDB is not configured or if it failed to perform the query.</p><p>If <code>log</code> is <code>true</code>, log the results using <code>Log.debug</code>. Default is <code>false</code>.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Stats"><a href="#module-Stats" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Stats/index.html">Stats</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Statistics to retrieve with <code>get_previous_stats</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_previous_stats"><a href="#val-get_previous_stats" class="anchor"></a><code><span><span class="keyword">val</span> get_previous_stats : 
  <span><span class="optlabel">?limit</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?minimum_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(<a href="../InfluxDB/index.html#type-tag">InfluxDB.tag</a> * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-field">InfluxDB.field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="Stats/index.html#type-t">Stats.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(int * <span class="type-var">'a</span>)</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Retrieve statistics about measurements made in previous test runs.</p><p>Usage: <code>get_previous_stats measurement field stats</code></p><p>Example: <code>get_previous_stats &quot;rpc&quot; &quot;duration&quot; Stats.(_3 mean median stddev)</code></p><p>This retrieves statistics specified by <code>stats</code> for the field named <code>field</code> of measurement named <code>measurement</code>. Only the <code>limit</code> most recent data points are considered in the statistics.</p><p><code>tags</code> is a list of <code>(tag, value)</code> pairs. If <code>tags</code> is specified, only data points that are tagged with <code>tag</code> equal to <code>value</code> for all <code>tags</code> are returned.</p><p>This returns <code>None</code> if:</p><ul><li>InfluxDB is not configured;</li><li>the data points cannot be retrieved (in which case an alert is also emitted);</li><li>less than <code>minimum_count</code> data points exist (default value is <code>3</code>).</li></ul><p>Otherwise it returns <code>Some (count, average)</code> where <code>count</code> is the number of data points which were used (with <code>minimum_count &lt;= count &lt;= limit</code>).</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_arg</code> <p>if no test is currently running, or if it was not registered with <code>Long_test.register</code> or <code>Long_test.register_with_protocol</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_pending_data_points"><a href="#val-get_pending_data_points" class="anchor"></a><code><span><span class="keyword">val</span> get_pending_data_points : 
  <span><span class="optlabel">?tags</span>:<span><span>(<a href="../InfluxDB/index.html#type-tag">InfluxDB.tag</a> * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-data_point">InfluxDB.data_point</a> list</span></span></code></div><div class="spec-doc"><p>Get the list of data points that were added for a given measurement but not sent yet.</p><p>Those data points are pending: they have not been sent to InfluxDB yet. Those data points will be sent at the end of the current test. The order of the resulting list is unspecified.</p><p><code>tags</code> is a list of <code>(tag, value)</code> pairs. If <code>tags</code> is specified, only data points that are tagged with <code>tag</code> equal to <code>value</code> for all <code>tags</code> are returned.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_arg</code> <p>if no test is currently running, or if it was not registered with <code>Long_test.register</code> or <code>Long_test.register_with_protocol</code>.</p></li></ul></div></div><h3 id="regression-testing"><a href="#regression-testing" class="anchor"></a>Regression Testing</h3><div class="odoc-spec"><div class="spec type anchored" id="type-check"><a href="#type-check" class="anchor"></a><code><span><span class="keyword">type</span> check</span><span> = </span></code><ol><li id="type-check.Mean" class="def variant constructor anchored"><a href="#type-check.Mean" class="anchor"></a><code><span>| </span><span><span class="constructor">Mean</span></span></code></li><li id="type-check.Median" class="def variant constructor anchored"><a href="#type-check.Median" class="anchor"></a><code><span>| </span><span><span class="constructor">Median</span></span></code></li></ol></div><div class="spec-doc"><p>Which statistics to compare with previous data points.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_regression"><a href="#val-check_regression" class="anchor"></a><code><span><span class="keyword">val</span> check_regression : 
  <span><span class="optlabel">?previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?minimum_previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?margin</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?check</span>:<a href="#type-check">check</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?stddev</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?data_points</span>:<span><a href="../InfluxDB/index.html#type-data_point">InfluxDB.data_point</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(<a href="../InfluxDB/index.html#type-tag">InfluxDB.tag</a> * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-field">InfluxDB.field</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Compare data points from the current test with previous tests.</p><p>Usage: <code>check_regression measurement field</code></p><p>This compare two sets of data points:</p><ul><li>the set of current data points;</li><li>the set of previous data points.</li></ul><p>The set of current data points is <code>data_points</code>, which defaults to the current pending data points. Only data points for <code>measurement</code> are used, and only if they have a field <code>field</code> with a float value.</p><p><code>tags</code> is a list of <code>(tag, value)</code> pairs. If <code>tags</code> is specified, only data points that are tagged with <code>tag</code> equal to <code>value</code> for all <code>tags</code> are used.</p><p>If the set of data points to use is empty, the function returns immediately without doing anything.</p><p>The set of previous data points is obtained by querying InfluxDB. If InfluxDB is not configured, or if less than <code>minimum_previous_count</code> previous data points exist, the function returns without doing anything else. If more than <code>minimum_previous_count</code> previous data points are available, the last <code>previous_count</code> points are used.</p><p>The mean or median (depending on <code>check</code>) of those two sets is compared. If the value for the current data points is more than the value for the previous data points multiplied by <code>1. +. margin</code>, an alert is emitted.</p><p>If <code>stddev</code> is <code>true</code>, this also logs the standard deviation of the previous data points.</p><p>Default values:</p><ul><li><code>previous_count = 10</code></li><li><code>minimum_previous_count = 3</code></li><li><code>margin = 0.2</code></li><li><code>check = Mean</code></li><li><code>stddev = false</code></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_arg</code> <p>if no test is currently running, or if it was not registered with <code>Long_test.register</code> or <code>Long_test.register_with_protocol</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-time"><a href="#val-time" class="anchor"></a><code><span><span class="keyword">val</span> time : 
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Do something and measure how long it takes.</p><p>Usage: <code>time measurement f</code></p><p>This executes <code>f</code>, measures the <code>time</code> it takes to run, and adds a data point for <code>measurement</code> with field <code>&quot;duration&quot;</code> equal to <code>time</code>. If <code>f</code> raises an exception, data points are not pushed and the exception is propagated.</p><p>If <code>repeat</code> is specified, call <code>f</code> <code>repeat</code> times to obtain as many data points.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_arg</code> <p>if no test is currently running, or if it was not registered with <code>Long_test.register</code> or <code>Long_test.register_with_protocol</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-time_and_check_regression"><a href="#val-time_and_check_regression" class="anchor"></a><code><span><span class="keyword">val</span> time_and_check_regression : 
  <span><span class="optlabel">?previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?minimum_previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?margin</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?check</span>:<a href="#type-check">check</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?stddev</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-time"><code>time</code></a> followed by <a href="#val-check_regression"><code>check_regression</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-measure"><a href="#val-measure" class="anchor"></a><code><span><span class="keyword">val</span> measure : 
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?field</span>:<a href="../InfluxDB/index.html#type-field">InfluxDB.field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> float)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Same as <a href="#val-time"><code>time</code></a>, but let the function choose how it measures time.</p><p><a href="#val-time"><code>time</code></a> measures time using <code>Unix.gettimeofday</code> around the whole execution of the function. If you only want to measure parts of the execution, or if you want to use something more precise than <code>Unix.gettimeofday</code>, or if you want to measure something which is not time, use <code>measure</code> instead.</p><p><code>?field</code> specifies the field name for the InfluxDB data point (see <a href="../InfluxDB/index.html#val-data_point"><code>InfluxDB.data_point</code></a>). It defaults to <code>&quot;duration&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-measure_and_check_regression"><a href="#val-measure_and_check_regression" class="anchor"></a><code><span><span class="keyword">val</span> measure_and_check_regression : 
  <span><span class="optlabel">?previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?minimum_previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?margin</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?check</span>:<a href="#type-check">check</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?stddev</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?field</span>:<a href="../InfluxDB/index.html#type-field">InfluxDB.field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> float)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-measure"><code>measure</code></a> followed by <a href="#val-check_regression"><code>check_regression</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-time_lwt"><a href="#val-time_lwt" class="anchor"></a><code><span><span class="keyword">val</span> time_lwt : 
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-time"><code>time</code></a>, but for functions that return promises.</p><p>Note that other concurrent promises may slow down the measured function and result in inaccurate measurements.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-time_and_check_regression_lwt"><a href="#val-time_and_check_regression_lwt" class="anchor"></a><code><span><span class="keyword">val</span> time_and_check_regression_lwt : 
  <span><span class="optlabel">?previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?minimum_previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?margin</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?check</span>:<a href="#type-check">check</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?stddev</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-time_and_check_regression"><code>time_and_check_regression</code></a>, but for functions that return promises.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-measure_lwt"><a href="#val-measure_lwt" class="anchor"></a><code><span><span class="keyword">val</span> measure_lwt : 
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?field</span>:<a href="../InfluxDB/index.html#type-field">InfluxDB.field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>float <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-measure"><code>measure</code></a>, but for functions that return promises.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-measure_and_check_regression_lwt"><a href="#val-measure_and_check_regression_lwt" class="anchor"></a><code><span><span class="keyword">val</span> measure_and_check_regression_lwt : 
  <span><span class="optlabel">?previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?minimum_previous_count</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?margin</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?check</span>:<a href="#type-check">check</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?stddev</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?repeat</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?tags</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?field</span>:<a href="../InfluxDB/index.html#type-field">InfluxDB.field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../InfluxDB/index.html#type-measurement">InfluxDB.measurement</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>float <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-measure_and_check_regression"><code>measure_and_check_regression</code></a>, but for functions that return promises.</p></div></div><h3 id="graphs"><a href="#graphs" class="anchor"></a>Graphs</h3><div class="odoc-spec"><div class="spec value anchored" id="val-update_grafana_dashboard"><a href="#val-update_grafana_dashboard" class="anchor"></a><code><span><span class="keyword">val</span> update_grafana_dashboard : <span><a href="../Grafana/index.html#type-dashboard">Grafana.dashboard</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Wrapper over <code>Grafana.update_dashboard</code>.</p><p>This wrapper takes care of:</p><ul><li>providing the configuration;</li><li>prepending the measurement prefix configured for InfluxDB;</li><li>running <code>Lwt_main.run</code> for you.</li></ul><p>Does nothing if Grafana or InfluxDB are not configured.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_arg</code> <p>if the dashboard UID is invalid.</p></li></ul></div></div><h3 id="configuration"><a href="#configuration" class="anchor"></a>Configuration</h3><p>This module should be initialized with <code>init</code> to read the configuration file. If not, default values are used.</p><p>If you don't need to send alerts, send data points, and retrieve data points, you do not need to write a configuration file. If you do intend to run the tests yourself, you should store data points in your own database though. Indeed, time measurements only make sense when they are compared with other measurements that have been run on the same hardware.</p><p>This module sends data points to an InfluxDB database, queries data points from this database, and sends alerts to a Slack webhook. To configure this integration, write a configuration file in one of the following locations:</p><ul><li>$TEZT_CONFIG</li><li>./tezt_config.json</li><li>$HOME/.tezt_config.json</li></ul><p>More precisely, if environment variable TEZT_CONFIG is set to a non-empty value, the location is read from the file located at this value. If this variable does not denote a valid configuration file, the program exits. If this variable is empty or not set, other configuration files are tried: the first one which exists is read. If the first one that exists is not a valid configuration file, the program exits. If no configuration file exists, default configuration values are used.</p><p>The contents of this file should look like:</p><pre>    {
        &quot;alerts&quot;: {
            &quot;slack_webhook_urls&quot;: {
                &quot;default&quot;: &quot;https://hooks.slack.com/services/XXX/XXX/XXX&quot;,
                &quot;p2p&quot;: &quot;https://hooks.slack.com/services/XXX/XXX/XXX&quot;,
                &quot;shell&quot;: &quot;https://hooks.slack.com/services/XXX/XXX/XXX&quot;
            },
            &quot;max_total&quot;: 100,
            &quot;max_by_test&quot;: 2,
            &quot;gitlab_project_url&quot;: &quot;https://gitlab.com/org/repo&quot;,
            &quot;timeout&quot;: 20,
            &quot;rate_limit_per_category&quot;: 84600,
            &quot;last_alerts_filename&quot;, &quot;last_alerts.json&quot;,
            &quot;max_alert_size&quot;: 1000,
            &quot;max_alert_lines&quot;: 20
        },
        &quot;influxdb&quot;: {
            &quot;url&quot;: &quot;https://localhost:8086&quot;,
            &quot;database&quot;: &quot;db&quot;,
            &quot;credentials&quot;: {
                &quot;username&quot;: &quot;user&quot;,
                &quot;password&quot;: &quot;password&quot;
            },
            &quot;measurement_prefix&quot;: &quot;tezt_&quot;,
            &quot;tags&quot;: { &quot;commit_hash&quot;: &quot;12345678&quot; },
            &quot;timeout&quot;: 20
        },
        &quot;grafana&quot;: {
            &quot;url&quot;: &quot;https://localhost/api&quot;,
            &quot;api_token&quot;: &quot;123456789&quot;,
            &quot;data_source&quot;: &quot;InfluxDB&quot;,
            &quot;timeout&quot;: 20
        },
        &quot;test_data_path&quot; : &quot;/path/to/the/test_data_path&quot;
    }</pre><p>where:</p><ul><li><code>alerts</code> configures how to send alerts (optional, alerts are not sent if not specified);</li><li><code>slack_webhook_urls</code> maps team names to Slack webhook URLs (it must contain at least a team named <code>&quot;default&quot;</code>, see the <code>?team</code> argument of <a href="#val-register"><code>register</code></a>);</li><li><code>max_total</code> is the maximum number of alerts that the process may send, after which alerts are not sent to Slack (optional, default value is 100);</li><li><code>max_by_test</code> is the maximum number of alerts that a given test may send, after which alerts are not sent to Slack (optional, default value is 2);</li><li><code>gitlab_project_url</code>, is used to add, in Slack alerts, a link to create a GitLab issue to fix the alert (optional, links are not added if not specified);</li><li><code>timeout</code> is how long, in seconds, to wait when sending alerts before giving up (optional, default value is 20);</li><li><code>rate_limit_per_category</code> is the minimum delay between two alerts for the same category, in seconds (optional, default value is one day);</li><li><code>last_alerts_filename</code> is the name of the file where to store the last time an alert was sent for each category (optional, default value is <code>&quot;last_alerts.json&quot;</code>);</li><li><code>max_alert_size</code> is the maximum length of alert messages, in bytes: messages which are longer are truncated to this size and an ellipsis (<code>&quot;[...]&quot;</code>) is appended (optional, default value is 1000);</li><li><code>max_alert_lines</code> is the maximum number of lines of alert messages: messages with more lines are truncated and an ellipsis is appended (optional, default value is 20);</li></ul><ul><li><code>influxdb</code> configures how to send and query data points (optional, data points are not sent nor queried if not specified);</li><li><code>url</code> is the base URL of the InfuxDB API;</li><li><code>database</code> is the name of the InfluxDB database;</li><li><code>credentials</code> contains the credentials needed to authenticate to the database. (optional, can be omitted for test databases that don't need authentication);</li><li><code>username</code> is the username used to log in the InfluxDB database;</li><li><code>password</code> is the password used to log in the InfluxDB database;</li><li><code>measurement_prefix</code> is a prefix which is prepended to all measurement names to prevent accidentally polluting other data of the database - it is automatically prepended both when sending data points and in SELECT queries; (optional, default value is <code>&quot;tezt_&quot;</code>);</li><li><code>tags</code> is a list of tags to add to all data points that are sent, such as the commit hash or the current version number (optional, default is no tags);</li><li><code>timeout</code> is how long, in seconds, to wait when sending and querying data points before giving up (optional, default value is 20);</li></ul><ul><li><code>grafana</code> configures how to update graph dashboards (optional, dashboards are not updated if not specified);</li><li><code>url</code> is the base URL of the Grafana API (ending with <code>/api</code>);</li><li><code>api_token</code> is an API token the Grafana admin can create in the Grafana interface (optional, If the grafana instance is run in insecure mode (no authentication required), it can be ommited. This is particularly useful to connect to a Grafana test instance);</li><li><code>data_source</code> is the name of the InfluxDB data source configured by the Grafana admin;</li><li><code>timeout</code> is how long, in seconds, to wait when updating dashboards before giving up (optional, default value is 20).</li></ul><ul><li><code>test_data_path</code> configures the folder in which large data are stored (optional, default value is &quot;/s3data&quot; which is the folder used by the default executor).</li></ul><p>Note that for Grafana dashboards to be updated, InfluxDB also needs to be configured, because measurements in Grafana queries are prefixed with the measurement prefix configured for InfluxDB.</p><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Read configuration file.</p><p>Please, be sure this function is called at first before using any function from <code>Long_test</code> to avoid undesired behaviour regarding the loading of the configuration.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-test_data_path"><a href="#val-test_data_path" class="anchor"></a><code><span><span class="keyword">val</span> test_data_path : <span>unit <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the <code>test_data_path</code> field from the configuration.</p></div></div><h3 id="internal-functions-for-debugging"><a href="#internal-functions-for-debugging" class="anchor"></a>Internal Functions for Debugging</h3><div class="odoc-spec"><div class="spec value anchored" id="val-unsafe_query"><a href="#val-unsafe_query" class="anchor"></a><code><span><span class="keyword">val</span> unsafe_query : 
  <span><a href="../InfluxDB/index.html#type-select">InfluxDB.select</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span><a href="../InfluxDB/index.html#type-result_data_point">InfluxDB.result_data_point</a> list</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-query"><code>query</code></a>, but without modifying the query.</p><p>Warning: contrary to <a href="#val-query"><code>query</code></a> this doesn't automatically add the <code>test = &quot;test title&quot;</code> clause, so you may get results from other tests.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-log_unsafe_query"><a href="#val-log_unsafe_query" class="anchor"></a><code><span><span class="keyword">val</span> log_unsafe_query : <span><a href="../InfluxDB/index.html#type-select">InfluxDB.select</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Perform a query with <a href="#val-unsafe_query"><code>unsafe_query</code></a> and log the query and its result.</p></div></div></div></body></html>
