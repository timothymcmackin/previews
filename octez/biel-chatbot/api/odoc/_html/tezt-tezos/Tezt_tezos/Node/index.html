<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Node (tezt-tezos.Tezt_tezos.Node)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezt-tezos</a> &#x00BB; <a href="../index.html">Tezt_tezos</a> &#x00BB; Node</nav><header class="odoc-preamble"><h1>Module <code><span>Tezt_tezos.Node</span></code></h1><p>Spawn Tezos nodes and control them.</p></header><nav class="odoc-toc"><ul><li><a href="#commands">Commands</a></li><li><a href="#events">Events</a></li><li><a href="#high-level-functions">High-Level Functions</a></li></ul></nav><div class="odoc-content"><p>Convention: in this module, some functions implement node commands; those functions are named after those commands. For instance, <code>Node.config_init</code> corresponds to <code>octez-node config init</code>, and <code>Node.run</code> corresponds to <code>octez-node run</code>.</p><p>The arguments of those functions are also named after the actual arguments. For instance, <code>?network</code> is named after <code>--network</code>, to make <code>Node.config_init ~network:&quot;carthagenet&quot;</code> look as close as possible to <code>octez-node config init --network carthagenet</code>.</p><p>Most options have default values which are not necessarily the default values of <code>octez-node</code>. Indeed, the latter are tailored for Mainnet, but here we use defaults which are tailored for the sandbox. In particular, the default value for <code>?network</code> is <code>&quot;sandbox&quot;</code>. However, if you specify an option such as <code>~network</code> or <code>~history_mode</code>, they are passed to the node unchanged, to reduce surprises.</p><p>These conventions are also followed in the <code>Client</code> module.</p><p>History modes for the node.</p><div class="odoc-spec"><div class="spec type anchored" id="type-history_mode"><a href="#type-history_mode" class="anchor"></a><code><span><span class="keyword">type</span> history_mode</span><span> = </span></code><ol><li id="type-history_mode.Archive" class="def variant constructor anchored"><a href="#type-history_mode.Archive" class="anchor"></a><code><span>| </span><span><span class="constructor">Archive</span></span></code></li><li id="type-history_mode.Full" class="def variant constructor anchored"><a href="#type-history_mode.Full" class="anchor"></a><code><span>| </span><span><span class="constructor">Full</span> <span class="keyword">of</span> <span>int option</span></span></code></li><li id="type-history_mode.Rolling" class="def variant constructor anchored"><a href="#type-history_mode.Rolling" class="anchor"></a><code><span>| </span><span><span class="constructor">Rolling</span> <span class="keyword">of</span> <span>int option</span></span></code></li></ol></div><div class="spec-doc"><p>The parameter for <code>Full</code> And <code>Rolling</code> mode is called <code>additional_cycles</code>.</p><p>For the <code>Full</code> (resp. <code>Rolling</code>) mode it controls the number of contexts (resp. blocks) we preserved behind the <code>checkpoint</code> (aka the no fork point). Default in sandbox mode is <code>2</code> and <code>5</code> for mainnet parameters (see <code>preserved_cycles</code> in the protocol parameters).</p></div></div><p>Default values for <code>Full</code> and <code>Rolling</code> history modes</p><div class="odoc-spec"><div class="spec value anchored" id="val-default_full"><a href="#val-default_full" class="anchor"></a><code><span><span class="keyword">val</span> default_full : <a href="#type-history_mode">history_mode</a></span></code></div><div class="spec-doc"><p>The default value for the <code>Full</code> history mode</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_rolling"><a href="#val-default_rolling" class="anchor"></a><code><span><span class="keyword">val</span> default_rolling : <a href="#type-history_mode">history_mode</a></span></code></div><div class="spec-doc"><p>The default value for the <code>Rolling</code> history mode</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-media_type"><a href="#type-media_type" class="anchor"></a><code><span><span class="keyword">type</span> media_type</span><span> = </span></code><ol><li id="type-media_type.Json" class="def variant constructor anchored"><a href="#type-media_type.Json" class="anchor"></a><code><span>| </span><span><span class="constructor">Json</span></span></code></li><li id="type-media_type.Binary" class="def variant constructor anchored"><a href="#type-media_type.Binary" class="anchor"></a><code><span>| </span><span><span class="constructor">Binary</span></span></code></li><li id="type-media_type.Any" class="def variant constructor anchored"><a href="#type-media_type.Any" class="anchor"></a><code><span>| </span><span><span class="constructor">Any</span></span></code></li></ol></div><div class="spec-doc"><p>Values that can be passed to the node's <code>--media-type</code> argument</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-argument"><a href="#type-argument" class="anchor"></a><code><span><span class="keyword">type</span> argument</span><span> = </span></code><ol><li id="type-argument.Network" class="def variant constructor anchored"><a href="#type-argument.Network" class="anchor"></a><code><span>| </span><span><span class="constructor">Network</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--network</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.History_mode" class="def variant constructor anchored"><a href="#type-argument.History_mode" class="anchor"></a><code><span>| </span><span><span class="constructor">History_mode</span> <span class="keyword">of</span> <a href="#type-history_mode">history_mode</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--history-mode</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Expected_pow" class="def variant constructor anchored"><a href="#type-argument.Expected_pow" class="anchor"></a><code><span>| </span><span><span class="constructor">Expected_pow</span> <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--expected-pow</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Singleprocess" class="def variant constructor anchored"><a href="#type-argument.Singleprocess" class="anchor"></a><code><span>| </span><span><span class="constructor">Singleprocess</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--singleprocess</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Bootstrap_threshold" class="def variant constructor anchored"><a href="#type-argument.Bootstrap_threshold" class="anchor"></a><code><span>| </span><span><span class="constructor">Bootstrap_threshold</span> <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--bootstrap-threshold</code> (deprecated)</p><span class="comment-delim">*)</span></div></li><li id="type-argument.Synchronisation_threshold" class="def variant constructor anchored"><a href="#type-argument.Synchronisation_threshold" class="anchor"></a><code><span>| </span><span><span class="constructor">Synchronisation_threshold</span> <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--synchronisation-threshold</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Sync_latency" class="def variant constructor anchored"><a href="#type-argument.Sync_latency" class="anchor"></a><code><span>| </span><span><span class="constructor">Sync_latency</span> <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--sync-latency</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Connections" class="def variant constructor anchored"><a href="#type-argument.Connections" class="anchor"></a><code><span>| </span><span><span class="constructor">Connections</span> <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--connections</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Private_mode" class="def variant constructor anchored"><a href="#type-argument.Private_mode" class="anchor"></a><code><span>| </span><span><span class="constructor">Private_mode</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--private-mode</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Disable_p2p_maintenance" class="def variant constructor anchored"><a href="#type-argument.Disable_p2p_maintenance" class="anchor"></a><code><span>| </span><span><span class="constructor">Disable_p2p_maintenance</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--disable-p2p-maintenance</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Disable_p2p_swap" class="def variant constructor anchored"><a href="#type-argument.Disable_p2p_swap" class="anchor"></a><code><span>| </span><span><span class="constructor">Disable_p2p_swap</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--disable-p2p-swap</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Peer" class="def variant constructor anchored"><a href="#type-argument.Peer" class="anchor"></a><code><span>| </span><span><span class="constructor">Peer</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--peer</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.No_bootstrap_peers" class="def variant constructor anchored"><a href="#type-argument.No_bootstrap_peers" class="anchor"></a><code><span>| </span><span><span class="constructor">No_bootstrap_peers</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--no-bootstrap-peers</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Media_type" class="def variant constructor anchored"><a href="#type-argument.Media_type" class="anchor"></a><code><span>| </span><span><span class="constructor">Media_type</span> <span class="keyword">of</span> <a href="#type-media_type">media_type</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--media-type</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Metadata_size_limit" class="def variant constructor anchored"><a href="#type-argument.Metadata_size_limit" class="anchor"></a><code><span>| </span><span><span class="constructor">Metadata_size_limit</span> <span class="keyword">of</span> <span>int option</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>--metadata-size-limit</p><span class="comment-delim">*)</span></div></li><li id="type-argument.Metrics_addr" class="def variant constructor anchored"><a href="#type-argument.Metrics_addr" class="anchor"></a><code><span>| </span><span><span class="constructor">Metrics_addr</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--metrics-addr</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Cors_origin" class="def variant constructor anchored"><a href="#type-argument.Cors_origin" class="anchor"></a><code><span>| </span><span><span class="constructor">Cors_origin</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--cors-origin</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Disable_mempool" class="def variant constructor anchored"><a href="#type-argument.Disable_mempool" class="anchor"></a><code><span>| </span><span><span class="constructor">Disable_mempool</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--disable-mempool</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Version" class="def variant constructor anchored"><a href="#type-argument.Version" class="anchor"></a><code><span>| </span><span><span class="constructor">Version</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--version</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.RPC_additional_addr" class="def variant constructor anchored"><a href="#type-argument.RPC_additional_addr" class="anchor"></a><code><span>| </span><span><span class="constructor">RPC_additional_addr</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--rpc-addr</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.RPC_additional_addr_external" class="def variant constructor anchored"><a href="#type-argument.RPC_additional_addr_external" class="anchor"></a><code><span>| </span><span><span class="constructor">RPC_additional_addr_external</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--external-rpc-addr</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Max_active_rpc_connections" class="def variant constructor anchored"><a href="#type-argument.Max_active_rpc_connections" class="anchor"></a><code><span>| </span><span><span class="constructor">Max_active_rpc_connections</span> <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--max-active-rpc-connections</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Enable_http_cache_headers" class="def variant constructor anchored"><a href="#type-argument.Enable_http_cache_headers" class="anchor"></a><code><span>| </span><span><span class="constructor">Enable_http_cache_headers</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--enable-http-cache-headers</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Disable_context_pruning" class="def variant constructor anchored"><a href="#type-argument.Disable_context_pruning" class="anchor"></a><code><span>| </span><span><span class="constructor">Disable_context_pruning</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--disable_context-pruning</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Storage_maintenance_delay" class="def variant constructor anchored"><a href="#type-argument.Storage_maintenance_delay" class="anchor"></a><code><span>| </span><span><span class="constructor">Storage_maintenance_delay</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--storage-maintenance-delay</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Force_history_mode_switch" class="def variant constructor anchored"><a href="#type-argument.Force_history_mode_switch" class="anchor"></a><code><span>| </span><span><span class="constructor">Force_history_mode_switch</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--force-history-mode-switch</code></p><span class="comment-delim">*)</span></div></li><li id="type-argument.Allow_yes_crypto" class="def variant constructor anchored"><a href="#type-argument.Allow_yes_crypto" class="anchor"></a><code><span>| </span><span><span class="constructor">Allow_yes_crypto</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>--allow-yes-crypto</code></p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Tezos node command-line arguments.</p><p>Not all arguments are available here. Some are simply not implemented, and some are handled separately because they need special care. The latter are implemented as optional labeled arguments (e.g. <code>?net_port</code> and <code>?data_dir</code>).</p><p>About <code>RPC_additional_addr</code>, at least one RPC port is always passed by <code>Node.run</code>, which causes the RPC ports from the configuration file to be ignored. So these arguments are not written in the config file when using <code>Node.init</code> and kept in the list of arguments of the persistent state to make sure <code>Node.run</code> passes them too.</p><p><code>Singleprocess</code> argument does not exist in the configuration file of the node. It is only known as a command-line option. <code>Node.init</code> will neither pass it to <code>Node.config</code> nor register it into node's arguments, but only use it for <code>Node.run</code> function.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-tls_config"><a href="#type-tls_config" class="anchor"></a><code><span><span class="keyword">type</span> tls_config</span><span> = </span><span>{</span></code><ol><li id="type-tls_config.certificate_path" class="def record field anchored"><a href="#type-tls_config.certificate_path" class="anchor"></a><code><span>certificate_path : string;</span></code></li><li id="type-tls_config.key_path" class="def record field anchored"><a href="#type-tls_config.key_path" class="anchor"></a><code><span>key_path : string;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A TLS configuration for the node: paths to a <code>.crt</code> and a <code>.key</code> file.</p><p>Passed to <code>run</code> like commands through the <code>--rpc-tls</code> argument.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Tezos node states.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-enable_external_rpc_process"><a href="#val-enable_external_rpc_process" class="anchor"></a><code><span><span class="keyword">val</span> enable_external_rpc_process : bool</span></code></div><div class="spec-doc"><p>This placeholder aims to handle the activation of the external RPC process for the Tezt nodes. Indeed, the external RPC process is an important feature that is not activated by default in the node and thus not tested on the CI. The tests on master are thus not testing the feature. To test the external RPC process anyway, a scheduled pipeline is launched every week, with the feature enabled, running all tests. When the scheduled pipeline is launched, the TZ_SCHEDULE_KIND environment variable is set to &quot;EXTENDED_RPC_TESTS&quot; to turn on the external RPC process. Look for the <code>ci/bin/custom_extended_test_pipeline.ml</code> file for more details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-enable_singleprocess"><a href="#val-enable_singleprocess" class="anchor"></a><code><span><span class="keyword">val</span> enable_singleprocess : bool</span></code></div><div class="spec-doc"><p>This placeholder aims to handle the activation of the singleprocess validation for the Tezt nodes. Indeed, the singleprocess validation is an alternative way of validating blocks that is not activated by default in the node and thus not tested by the CI. The tests on master are thus not testing the feature. To test the singleprocess validation anyway, a scheduled pipeline is launched every week, with the feature enabled, running all tests. When the scheduled pipeline is launched, the TZ_SCHEDULE_KIND environment variable is set to &quot;EXTENDED_VALIDATION_TESTS&quot; to turn on the singleprocess validation. Look for the <code>ci/bin/singleprocess_validation_pipeline.ml</code> file for more details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?runner</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Runner.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?path</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?color</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Log.Color.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_pipe</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?net_addr</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?net_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?advertised_net_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?metrics_addr</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?metrics_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_external</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_host</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_tls</span>:<a href="#type-tls_config">tls_config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?allow_all_rpc</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_active_rpc_connections</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Create a node.</p><p>This function just creates the <code>t</code> value, it does not call <code>identity_generate</code> nor <code>config_init</code> nor <code>run</code>.</p><p>The standard output and standard error output of the node will be logged with prefix <code>name</code> and color <code>color</code>.</p><p>Default <code>data_dir</code> is a temporary directory which is always the same for each <code>name</code>.</p><p>Default <code>event_pipe</code> is a temporary file whose name is derived from <code>name</code>. It will be created as a named pipe so that node events can be received.</p><p>Default value for <code>net_addr</code> is either <code>Constant.default_host</code> if no <code>runner</code> is provided, or a value allowing the local Tezt program to connect to it if it is.</p><p>Default <code>rpc_external</code> is <code>false</code>. If <code>rpc_external</code> is <code>true</code>, the node will spawn a process for non-blocking RPCs.</p><p>Default values for <code>net_port</code> or <code>rpc_port</code> are chosen automatically with values starting from 16384 (configurable with `--starting-port`). They are used by <code>config_init</code> and by functions from the <code>Client</code> module. They are not used by <code>run</code>, so if you do not call <code>config_init</code> or generate the configuration file through some other means, your node will not listen.</p><p>Default value for <code>allow_all_rpc</code> is <code>true</code>.</p><p>Default value for <code>max_active_rpc_connections</code> is <code>500</code>.</p><p><code>local_rpc_server</code> specify whether or not the RPC server must be run locally, if true (default), or on a external process. It is not allowed yet to run both server kinds at the same time.</p><p>The argument list is a list of configuration options that the node should run with. It is passed to the first run of <code>octez-node config init</code>. It is also passed to all runs of <code>octez-node run</code> that occur before <code>octez-node config init</code>. If <code>Expected_pow</code> is given, it is also used as the default value for <a href="#val-identity_generate"><code>identity_generate</code></a>.</p><p>If <code>runner</code> is specified, the node will be spawned on this runner using SSH.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_argument"><a href="#val-add_argument" class="anchor"></a><code><span><span class="keyword">val</span> add_argument : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-argument">argument</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Add an argument to a node as if it was passed to <a href="#val-create"><code>create</code></a>.</p><p>The argument is passed to the next run of <code>octez-node config init</code>. It is also passed to all runs of <code>octez-node run</code> that occur before the next <code>octez-node config init</code>.</p><p>There are some exceptions, see definition of type <code>argument</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_peer"><a href="#val-add_peer" class="anchor"></a><code><span><span class="keyword">val</span> add_peer : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Add a <code>--peer</code> argument to a node.</p><p>Usage: <code>add_peer node peer</code></p><p>Same as <code>add_argument node (Peer &quot;&lt;HOST&gt;:&lt;PORT&gt;&quot;)</code> where <code>&lt;HOST&gt;</code> is given by <code>Runner.address</code> and <code>&lt;PORT&gt;</code> is the P2P port of <code>peer</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_peers"><a href="#val-get_peers" class="anchor"></a><code><span><span class="keyword">val</span> get_peers : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string list</span></span></code></div><div class="spec-doc"><p>Returns the list of address of all <code>Peer &lt;addr&gt;</code> arguments.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_peer_with_id"><a href="#val-add_peer_with_id" class="anchor"></a><code><span><span class="keyword">val</span> add_peer_with_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Add a <code>--peer</code> argument to a node.</p><p>Usage: <code>add_peer node peer</code></p><p>Same as <code>add_argument node (Peer &quot;&lt;HOST&gt;:&lt;PORT&gt;#&lt;ID&gt;&quot;)</code> where <code>&lt;HOST&gt;</code> is given by <code>Runner.address</code>, <code>&lt;PORT&gt;</code> is the P2P port and <code>&lt;ID&gt;</code> is the identity of <code>peer</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_peers_json_file"><a href="#val-remove_peers_json_file" class="anchor"></a><code><span><span class="keyword">val</span> remove_peers_json_file : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Removes the file peers.json that is at the root of data-dir. This file contains the list of peers known by the node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-point_and_id"><a href="#val-point_and_id" class="anchor"></a><code><span><span class="keyword">val</span> point_and_id : <span><span class="optlabel">?from</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Get the P2P point and id for a node.</p><p>Return <code>&quot;&lt;ADDRESS&gt;:&lt;PORT&gt;#&lt;ID&gt;&quot;</code> where <code>&lt;PORT&gt;</code> is the P2P port and <code>&lt;ID&gt;</code> is the identity of the node.</p><p><code>&lt;ADDRESS&gt;</code> is obtained using <code>Runner.address runner</code> with <code>?from</code> being the runner of <code>from</code> and <code>runner</code> is the runner of the node. In other words it is the address where <code>from</code> can contact <code>node</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-point"><a href="#val-point" class="anchor"></a><code><span><span class="keyword">val</span> point : <span><span class="optlabel">?from</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string * int</span></code></div><div class="spec-doc"><p>Get the P2P point of a node.</p><p>Return <code>(&lt;ADDRESS&gt;,&lt;PORT&gt;)</code> where <code>&lt;PORT&gt;</code> is the P2P port and <code>&lt;ADDRESS&gt;</code> is the reachable address of the node.</p><p><code>&lt;ADDRESS&gt;</code> is obtained using <code>Runner.address runner</code> with <code>?from</code> being the runner of <code>from</code> and <code>runner</code> is the runner of the node. In other words it is the address where <code>from</code> can contact <code>node</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-point_str"><a href="#val-point_str" class="anchor"></a><code><span><span class="keyword">val</span> point_str : <span><span class="optlabel">?from</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Same as <code>point</code> but returns a string representation of the point <code>&quot;&lt;ADDRESS&gt;:&lt;PORT&gt;&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-name"><a href="#val-name" class="anchor"></a><code><span><span class="keyword">val</span> name : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.name</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-net_port"><a href="#val-net_port" class="anchor"></a><code><span><span class="keyword">val</span> net_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Get the network port given as <code>--net-addr</code> to a node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-advertised_net_port"><a href="#val-advertised_net_port" class="anchor"></a><code><span><span class="keyword">val</span> advertised_net_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p>Get the network port given as <code>--advertised-net-port</code> to a node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-metrics_port"><a href="#val-metrics_port" class="anchor"></a><code><span><span class="keyword">val</span> metrics_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_scheme"><a href="#val-rpc_scheme" class="anchor"></a><code><span><span class="keyword">val</span> rpc_scheme : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the RPC scheme of a node.</p><p>Returns <code>https</code> if node is started with <code>--rpc-tls</code>, otherwise <code>http</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_external"><a href="#val-rpc_external" class="anchor"></a><code><span><span class="keyword">val</span> rpc_external : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Returns <code>True</code> if RPCs are handled by a dedicated process.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_host"><a href="#val-rpc_host" class="anchor"></a><code><span><span class="keyword">val</span> rpc_host : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the RPC host given as <code>--rpc-addr</code> to a node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_port"><a href="#val-rpc_port" class="anchor"></a><code><span><span class="keyword">val</span> rpc_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Get the RPC port given as <code>--rpc-port</code> to a node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_endpoint"><a href="#val-rpc_endpoint" class="anchor"></a><code><span><span class="keyword">val</span> rpc_endpoint : <span><span class="optlabel">?local</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the node's RPC endpoint URI.</p><p>These are composed of the node's <code>--rpc-tls</code>, <code>--rpc-addr</code> and <code>--rpc-port</code> arguments. If <code>local</code> is given (<code>false</code> by default), then <code>Constant.default_host</code> is used (it overrides <code>rpc-addr</code> or the <code>runner</code> argument).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-data_dir"><a href="#val-data_dir" class="anchor"></a><code><span><span class="keyword">val</span> data_dir : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the data-dir of a node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-identity_file"><a href="#val-identity_file" class="anchor"></a><code><span><span class="keyword">val</span> identity_file : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the identity file of a node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-runner"><a href="#val-runner" class="anchor"></a><code><span><span class="keyword">val</span> runner : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Tezt_wrapper</span>.Runner.t option</span></span></code></div><div class="spec-doc"><p>Get the runner associated to a node.</p><p>Return <code>None</code> if the node runs on the local machine.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_error"><a href="#val-check_error" class="anchor"></a><code><span><span class="keyword">val</span> check_error : 
  <span><span class="optlabel">?exit_code</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?msg</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Base.rex <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until a node terminates and check its status.</p><p>If the node is not running, or if the process returns an exit code which is not <code>exit_code</code>, or if <code>msg</code> does not match the stderr output, fail the test.</p><p>If <code>exit_code</code> is not specified, any non-zero code is accepted. If no <code>msg</code> is given, the stderr is ignored.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait"><a href="#val-wait" class="anchor"></a><code><span><span class="keyword">val</span> wait : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Unix</span>.process_status <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until a node terminates and return its status. If the node is not running, make the test fail.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-terminate"><a href="#val-terminate" class="anchor"></a><code><span><span class="keyword">val</span> terminate : <span><span class="optlabel">?timeout</span>:float <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send SIGTERM and wait for the process to terminate.</p><p>Default <code>timeout</code> is 30 seconds, after which SIGKILL is sent.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kill"><a href="#val-kill" class="anchor"></a><code><span><span class="keyword">val</span> kill : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send SIGKILL and wait for the process to terminate.</p></div></div><h3 id="commands"><a href="#commands" class="anchor"></a>Commands</h3><div class="odoc-spec"><div class="spec value anchored" id="val-identity_generate"><a href="#val-identity_generate" class="anchor"></a><code><span><span class="keyword">val</span> identity_generate : <span><span class="optlabel">?expected_pow</span>:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node identity generate</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_identity_generate"><a href="#val-spawn_identity_generate" class="anchor"></a><code><span><span class="keyword">val</span> spawn_identity_generate : <span><span class="optlabel">?expected_pow</span>:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>identity_generate</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_history_mode"><a href="#val-show_history_mode" class="anchor"></a><code><span><span class="keyword">val</span> show_history_mode : <span><a href="#type-history_mode">history_mode</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Convert an history mode into a string.</p><p>The result is suitable to be passed to the node on the command-line.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-config_init"><a href="#val-config_init" class="anchor"></a><code><span><span class="keyword">val</span> config_init : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node config init</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-config_update"><a href="#val-config_update" class="anchor"></a><code><span><span class="keyword">val</span> config_update : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node config update</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-config_reset"><a href="#val-config_reset" class="anchor"></a><code><span><span class="keyword">val</span> config_reset : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node config reset</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-config_show"><a href="#val-config_show" class="anchor"></a><code><span><span class="keyword">val</span> config_show : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Tezt_wrapper</span>.JSON.t <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node config show</code>. Returns the node configuration.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Config_file"><a href="#module-Config_file" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Config_file/index.html">Config_file</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Node configuration files.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_config_init"><a href="#val-spawn_config_init" class="anchor"></a><code><span><span class="keyword">val</span> spawn_config_init : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>config_init</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_config_update"><a href="#val-spawn_config_update" class="anchor"></a><code><span><span class="keyword">val</span> spawn_config_update : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>config_update</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_config_reset"><a href="#val-spawn_config_reset" class="anchor"></a><code><span><span class="keyword">val</span> spawn_config_reset : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>config_reset</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-snapshot_history_mode"><a href="#type-snapshot_history_mode" class="anchor"></a><code><span><span class="keyword">type</span> snapshot_history_mode</span><span> = </span></code><ol><li id="type-snapshot_history_mode.Rolling_history" class="def variant constructor anchored"><a href="#type-snapshot_history_mode.Rolling_history" class="anchor"></a><code><span>| </span><span><span class="constructor">Rolling_history</span></span></code></li><li id="type-snapshot_history_mode.Full_history" class="def variant constructor anchored"><a href="#type-snapshot_history_mode.Full_history" class="anchor"></a><code><span>| </span><span><span class="constructor">Full_history</span></span></code></li></ol></div><div class="spec-doc"><p>A snapshot history mode for exports</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-export_format"><a href="#type-export_format" class="anchor"></a><code><span><span class="keyword">type</span> export_format</span><span> = </span></code><ol><li id="type-export_format.Tar" class="def variant constructor anchored"><a href="#type-export_format.Tar" class="anchor"></a><code><span>| </span><span><span class="constructor">Tar</span></span></code></li><li id="type-export_format.Raw" class="def variant constructor anchored"><a href="#type-export_format.Raw" class="anchor"></a><code><span>| </span><span><span class="constructor">Raw</span></span></code></li></ol></div><div class="spec-doc"><p>A snapshot file format for exports</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-snapshot_export"><a href="#val-snapshot_export" class="anchor"></a><code><span><span class="keyword">val</span> snapshot_export : 
  <span><span class="optlabel">?history_mode</span>:<a href="#type-snapshot_history_mode">snapshot_history_mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?export_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?export_format</span>:<a href="#type-export_format">export_format</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node snapshot export</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_snapshot_export"><a href="#val-spawn_snapshot_export" class="anchor"></a><code><span><span class="keyword">val</span> spawn_snapshot_export : 
  <span><span class="optlabel">?history_mode</span>:<a href="#type-snapshot_history_mode">snapshot_history_mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?export_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?export_format</span>:<a href="#type-export_format">export_format</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>snapshot_export</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-snapshot_info"><a href="#val-snapshot_info" class="anchor"></a><code><span><span class="keyword">val</span> snapshot_info : <span><span class="optlabel">?json</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node snapshot info</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_snapshot_info"><a href="#val-spawn_snapshot_info" class="anchor"></a><code><span><span class="keyword">val</span> spawn_snapshot_info : <span><span class="optlabel">?json</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>snapshot_info</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-snapshot_import"><a href="#val-snapshot_import" class="anchor"></a><code><span><span class="keyword">val</span> snapshot_import : 
  <span><span class="optlabel">?no_check</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?reconstruct</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node snapshot import</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_snapshot_import"><a href="#val-spawn_snapshot_import" class="anchor"></a><code><span><span class="keyword">val</span> spawn_snapshot_import : 
  <span><span class="optlabel">?no_check</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?reconstruct</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>snapshot_import</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reconstruct"><a href="#val-reconstruct" class="anchor"></a><code><span><span class="keyword">val</span> reconstruct : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node reconstruct</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_reconstruct"><a href="#val-spawn_reconstruct" class="anchor"></a><code><span><span class="keyword">val</span> spawn_reconstruct : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.Process.t</span></code></div><div class="spec-doc"><p>Same as <code>reconstruct</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : 
  <span><span class="optlabel">?env</span>:<span>string <span class="xref-unresolved">Tezt_wrapper</span>.Base.String_map.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?patch_config</span>:<span>(<span><span class="xref-unresolved">Tezt_wrapper</span>.JSON.t <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.JSON.t)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?on_terminate</span>:<span>(<span><span class="xref-unresolved">Unix</span>.process_status <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_level</span>:<a href="../Daemon/Level/index.html#type-default_level">Daemon.Level.default_level</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_sections_levels</span>:<span><span>(string * <a href="../Daemon/Level/index.html#type-level">Daemon.Level.level</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Spawn <code>octez-node run</code>.</p><p>The resulting promise is fulfilled as soon as the node has been spawned. It continues running in the background.</p><p><code>event_level</code> specifies the verbosity of the file descriptor sink. This must be at least <code>`Notice</code>, which is the level of event <code>&quot;node_is_ready.v0&quot;</code>, needed for <a href="#val-wait_for_ready"><code>wait_for_ready</code></a>. The default value is <code>`Info</code> which is also the default event level of the node.</p><p><code>event_sections_levels</code> specifies the verbosity for events in sections whose prefix is in the list. For instance <code>~event_sections_levels:[(&quot;prevalidator&quot;, `Debug); (&quot;validator.block&quot;, `Debug)]</code> will activate the logs at debug level for events whose section starts with <code>&quot;prevalidator&quot;</code> or <code>&quot;validator.block&quot;</code>. See <code>Tezos_stdlib_unix.File_descriptor_sink</code> and <a href="https://tezos.gitlab.io/user/logging.html#file-descriptor-sinks">the logging documentation</a> for a more precise semantic.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-replay"><a href="#val-replay" class="anchor"></a><code><span><span class="keyword">val</span> replay : 
  <span><span class="optlabel">?on_terminate</span>:<span>(<span><span class="xref-unresolved">Unix</span>.process_status <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_level</span>:<a href="../Daemon/Level/index.html#type-default_level">Daemon.Level.default_level</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_sections_levels</span>:<span><span>(string * <a href="../Daemon/Level/index.html#type-level">Daemon.Level.level</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?strict</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?blocks</span>:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Spawn <code>octez-node replay</code>.</p><p>Same as <a href="#val-run"><code>run</code></a> but for the <code>replay</code> command. In particular it also supports events. One key difference is that the node will eventually stop.</p><p>Note that the `--network` argument is infered by the `node replay` command itself, thanks to the configuration value.</p><p>See <a href="#val-run"><code>run</code></a> for a description of the arguments.</p></div></div><h3 id="events"><a href="#events" class="anchor"></a>Events</h3><div class="odoc-spec"><div class="spec exception anchored" id="exception-Terminated_before_event"><a href="#exception-Terminated_before_event" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Terminated_before_event</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Node.daemon" class="def record field anchored"><a href="#module-Node.daemon" class="anchor"></a><code><span>daemon : string;</span></code></li><li id="module-Node.event" class="def record field anchored"><a href="#module-Node.event" class="anchor"></a><code><span>event : string;</span></code></li><li id="module-Node.where" class="def record field anchored"><a href="#module-Node.where" class="anchor"></a><code><span>where : <span>string option</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_synchronisation"><a href="#val-wait_for_synchronisation" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_synchronisation : <span><span class="label">statuses</span>:<span>string list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for synchronisation status changes</p><p>More precisely, wait until a <code>synchronisation_status</code> event occurs with a status change listed in <code>statuses</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_ready"><a href="#val-wait_for_ready" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_ready : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until the node is ready.</p><p>More precisely, wait until a <code>node_is_ready</code> event occurs. If such an event already occurred, return immediately.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_level"><a href="#val-wait_for_level" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a given chain level.</p><p>More precisely, wait until a <code>head_increment</code> or <code>branch_switch</code> (or <code>store_synchronized_on_head</code> when the node is running with <code>rpc_external</code> set to true) with a <code>level</code> greater or equal to the requested level occurs. If such an event already occurred, return immediately.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_last_seen_level"><a href="#val-get_last_seen_level" class="anchor"></a><code><span><span class="keyword">val</span> get_last_seen_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Get the current known level of the node.</p><p>Returns <code>0</code> if the node is not running or if no <code>head_increment</code> or <code>branch_switch</code> event was received yet. This makes this function equivalent to <code>wait_for_level node 0</code> except that it does not actually wait for the level to be known.</p><p>Note that, as the node's status is updated only on head increments, this value is wrong for instance right after a node restart or snapshot import. Therefore it is recommended to use the function <a href="#val-get_level"><code>get_level</code></a> instead, which does not have this problem. A use case for this function is to check for a level increase, when the exact level does not matter, and <a href="#val-get_level"><code>get_level</code></a>'s promise may not resolve.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_level"><a href="#val-get_level" class="anchor"></a><code><span><span class="keyword">val</span> get_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Return a promise that is fulfilled as soon as the node is running and its level is known, which is then the value of the promise.</p><p>If the node is not running or if no <code>head_increment</code> or <code>branch_switch</code> event was received yet, then wait until one of these events occur. It is equivalent to <code>wait_for_level node 0</code>, and thus avoids the pitfalls of getting a misleading 0 value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_identity"><a href="#val-wait_for_identity" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_identity : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for the node to read its identity.</p><p>More precisely, wait until a <code>read_identity</code> event occurs. If such an event already occurred, return immediately.</p><p>Return the identity.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_request"><a href="#val-wait_for_request" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_request : 
  <span><span class="label">request</span>:<span>[&lt; `Flush <span>| `Inject</span> <span>| `Notify</span> <span>| `Arrived</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>wait_for_request ?level ~request node</code> waits for <code>request</code> event on the <code>node</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_full"><a href="#val-wait_for_full" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_full : 
  <span><span class="optlabel">?where</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="xref-unresolved">Tezt_wrapper</span>.JSON.t <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.wait_for_full</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for"><a href="#val-wait_for" class="anchor"></a><code><span><span class="keyword">val</span> wait_for : 
  <span><span class="optlabel">?where</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="xref-unresolved">Tezt_wrapper</span>.JSON.t <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.wait_for</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_connections"><a href="#val-wait_for_connections" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_connections : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a node to receive a given number of connections.</p><p><code>wait_for_connections node n</code> waits until <code>node</code> receives <code>n</code> <code>&quot;connection&quot;</code> Chain validator events.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_disconnections"><a href="#val-wait_for_disconnections" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_disconnections : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a node to receive a given number of disconnections.</p><p><code>wait_for_disconnections node n</code> waits until <code>node</code> receives <code>n</code> <code>&quot;disconnection&quot;</code> Chain validator events.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-event"><a href="#type-event" class="anchor"></a><code><span><span class="keyword">type</span> event</span><span> = </span><span>{</span></code><ol><li id="type-event.name" class="def record field anchored"><a href="#type-event.name" class="anchor"></a><code><span>name : string;</span></code></li><li id="type-event.value" class="def record field anchored"><a href="#type-event.value" class="anchor"></a><code><span>value : <span class="xref-unresolved">Tezt_wrapper</span>.JSON.t;</span></code></li><li id="type-event.timestamp" class="def record field anchored"><a href="#type-event.timestamp" class="anchor"></a><code><span>timestamp : float;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Raw events.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-on_event"><a href="#val-on_event" class="anchor"></a><code><span><span class="keyword">val</span> on_event : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="#type-event">event</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.on_event</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-log_events"><a href="#val-log_events" class="anchor"></a><code><span><span class="keyword">val</span> log_events : <span><span class="optlabel">?max_length</span>:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.log_events</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-observe_memory_consumption"><a href="#type-observe_memory_consumption" class="anchor"></a><code><span><span class="keyword">type</span> observe_memory_consumption</span><span> = </span></code><ol><li id="type-observe_memory_consumption.Observe" class="def variant constructor anchored"><a href="#type-observe_memory_consumption.Observe" class="anchor"></a><code><span>| </span><span><span class="constructor">Observe</span> <span class="keyword">of</span> <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>int option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-memory_consumption"><a href="#val-memory_consumption" class="anchor"></a><code><span><span class="keyword">val</span> memory_consumption : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-observe_memory_consumption">observe_memory_consumption</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.memory_consumption</code>.</p></div></div><h3 id="high-level-functions"><a href="#high-level-functions" class="anchor"></a>High-Level Functions</h3><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><span class="optlabel">?runner</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Runner.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?path</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?env</span>:<span>string <span class="xref-unresolved">Tezt_wrapper</span>.Base.String_map.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?color</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Log.Color.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_pipe</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?net_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?advertised_net_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?metrics_addr</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?metrics_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_external</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_host</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?rpc_tls</span>:<a href="#type-tls_config">tls_config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_level</span>:<a href="../Daemon/Level/index.html#type-default_level">Daemon.Level.default_level</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_sections_levels</span>:<span><span>(string * <a href="../Daemon/Level/index.html#type-level">Daemon.Level.level</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?patch_config</span>:<span>(<span><span class="xref-unresolved">Tezt_wrapper</span>.JSON.t <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Tezt_wrapper</span>.JSON.t)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?snapshot</span>:<span>(string * bool)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Initialize a node.</p><p>This <a href="#val-create"><code>create</code></a>s a node, runs <a href="#val-identity_generate"><code>identity_generate</code></a>, <a href="#val-config_init"><code>config_init</code></a> and <a href="#val-run"><code>run</code></a>, then waits for the node to be ready, and finally returns the node.</p><p>Arguments are passed to <a href="#val-config_init"><code>config_init</code></a>. If you specified <code>Expected_pow</code>, it is also passed to <a href="#val-identity_generate"><code>identity_generate</code></a>. Arguments are not passed to <a href="#val-run"><code>run</code></a>. If you do not wish the arguments to be stored in the configuration file (which will affect future runs too), do not use <code>init</code>.</p><p>When <code>patch_config</code> is provided, the function is used to patch the configuration file generated by <a href="#val-config_init"><code>config_init</code></a> before the call to <a href="#val-run"><code>run</code></a>. This argument should only be used to test configuration options that cannot be set with command-line <a href="#type-argument"><code>argument</code></a>s.</p><p>To import a snapshot before calling <a href="#val-run"><code>run</code></a>, specify <code>~snapshot:(file, do_reconstruct)</code>, where file is the path to the snapshot. If <code>reconstruct</code> is <code>true</code>, then <code>--reconstruct</code> is passed to the import command.</p><p>The <code>env</code> argument, if specified, allows adding new environment variables when executing the <code>run</code> command of the octez-node. If any environment variable is already defined internally they will overwrite the ones provided via <code>env</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-send_raw_data"><a href="#val-send_raw_data" class="anchor"></a><code><span><span class="keyword">val</span> send_raw_data : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">data</span>:string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>send_raw_data node ~data</code> writes <code>~data</code> using an IP socket on the net port of <code>node</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-upgrade_storage"><a href="#val-upgrade_storage" class="anchor"></a><code><span><span class="keyword">val</span> upgrade_storage : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>upgrade_storage node</code> upgrades the given <code>node</code> storage.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_version"><a href="#val-get_version" class="anchor"></a><code><span><span class="keyword">val</span> get_version : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>octez-node --version</code> and return the node's version.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-as_rpc_endpoint"><a href="#val-as_rpc_endpoint" class="anchor"></a><code><span><span class="keyword">val</span> as_rpc_endpoint : <span><span class="optlabel">?local</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Endpoint/index.html#type-t">Endpoint.t</a></span></code></div><div class="spec-doc"><p>Expose the RPC server address of this node as a foreign endpoint. See <code>rpc_endpoint</code> for a description of the <code>local</code> argument.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-RPC"><a href="#module-RPC" class="anchor"></a><code><span><span class="keyword">module</span> <a href="RPC/index.html">RPC</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
