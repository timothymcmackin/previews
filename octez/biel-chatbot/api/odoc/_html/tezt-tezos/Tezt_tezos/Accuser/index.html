<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Accuser (tezt-tezos.Tezt_tezos.Accuser)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezt-tezos</a> &#x00BB; <a href="../index.html">Tezt_tezos</a> &#x00BB; Accuser</nav><header class="odoc-preamble"><h1>Module <code><span>Tezt_tezos.Accuser</span></code></h1><p>Spawn Tezos accuser and control them.</p></header><nav class="odoc-toc"><ul><li><a href="#commands">Commands</a></li><li><a href="#events">Events</a></li><li><a href="#high-level-functions">High-Level Functions</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Tezos accuser states.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-event"><a href="#type-event" class="anchor"></a><code><span><span class="keyword">type</span> event</span><span> = </span><span>{</span></code><ol><li id="type-event.name" class="def record field anchored"><a href="#type-event.name" class="anchor"></a><code><span>name : string;</span></code></li><li id="type-event.value" class="def record field anchored"><a href="#type-event.value" class="anchor"></a><code><span>value : <span class="xref-unresolved">Tezt_wrapper</span>.JSON.t;</span></code></li><li id="type-event.timestamp" class="def record field anchored"><a href="#type-event.timestamp" class="anchor"></a><code><span>timestamp : float;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Raw events.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">protocol</span>:<a href="../Protocol/index.html#type-t">Protocol.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?path</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?color</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Log.Color.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_pipe</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?base_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?runner</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Runner.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?preserved_levels</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Node/index.html#type-t">Node.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Create an accuser.</p><p>This function just creates the <code>t</code> value, it does not call <code>run</code>.</p><p><code>path</code> provides the path to the accuser binary, the default being the one derived from the <code>protocol</code>.</p><p>The standard output and standard error output of the accuser will be logged with prefix <code>name</code> and color <code>color</code>.</p><p>Default <code>event_pipe</code> is a temporary file whose name is derived from <code>name</code>. It will be created as a named pipe so that accuser events can be received.</p><p><code>base_dir</code> corresponds to the (useless) &quot;--base-dir&quot; argument of the octez-accuser command.</p><p>The <code>Node.t</code> parameter is the accuser's node target. The accuser will be configured to be synchronised with the given node, and will communicate with it.</p><p>If <code>runner</code> is specified, the accuser will be spawned on this runner using SSH.</p><p><code>preserved_levels</code> is the number of effective levels kept in the accuser's memory</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-name"><a href="#val-name" class="anchor"></a><code><span><span class="keyword">val</span> name : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.name</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-node_rpc_port"><a href="#val-node_rpc_port" class="anchor"></a><code><span><span class="keyword">val</span> node_rpc_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Get the RPC port of the associated node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-terminate"><a href="#val-terminate" class="anchor"></a><code><span><span class="keyword">val</span> terminate : <span><span class="optlabel">?timeout</span>:float <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send SIGTERM and wait for the process to terminate.</p><p>Default <code>timeout</code> is 30 seconds, after which SIGKILL is sent.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kill"><a href="#val-kill" class="anchor"></a><code><span><span class="keyword">val</span> kill : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send SIGKILL and wait for the process to terminate.</p></div></div><h3 id="commands"><a href="#commands" class="anchor"></a>Commands</h3><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : <span><span class="optlabel">?event_level</span>:<a href="../Daemon/Level/index.html#type-default_level">Daemon.Level.default_level</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Spawn <code>octez-accuser run</code>.</p><p>The resulting promise is fulfilled as soon as the accuser has been spawned. It continues running in the background.</p></div></div><h3 id="events"><a href="#events" class="anchor"></a>Events</h3><div class="odoc-spec"><div class="spec exception anchored" id="exception-Terminated_before_event"><a href="#exception-Terminated_before_event" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Terminated_before_event</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Accuser.daemon" class="def record field anchored"><a href="#module-Accuser.daemon" class="anchor"></a><code><span>daemon : string;</span></code></li><li id="module-Accuser.event" class="def record field anchored"><a href="#module-Accuser.event" class="anchor"></a><code><span>event : string;</span></code></li><li id="module-Accuser.where" class="def record field anchored"><a href="#module-Accuser.where" class="anchor"></a><code><span>where : <span>string option</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Exception raised by <code>wait_for</code> functions if the node terminates before the event.</p><p>You may catch or let it propagate to cause the test to fail. <code>daemon</code> is the name of the accuser. <code>event</code> is the name of the event. <code>where</code> is an additional optional constraint, such as <code>&quot;level &gt;= 10&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_ready"><a href="#val-wait_for_ready" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_ready : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until the accuser is ready.</p><p>More precisely, wait until the node on which the accuser is connected to is bootstrapped, and then, the accuser is ready.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for"><a href="#val-wait_for" class="anchor"></a><code><span><span class="keyword">val</span> wait_for : 
  <span><span class="optlabel">?where</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="xref-unresolved">Tezt_wrapper</span>.JSON.t <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.wait_for</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-on_event"><a href="#val-on_event" class="anchor"></a><code><span><span class="keyword">val</span> on_event : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="#type-event">event</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.on_event</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-log_events"><a href="#val-log_events" class="anchor"></a><code><span><span class="keyword">val</span> log_events : <span><span class="optlabel">?max_length</span>:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>See <code>Daemon.Make.log_events</code>.</p></div></div><h3 id="high-level-functions"><a href="#high-level-functions" class="anchor"></a>High-Level Functions</h3><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><span class="label">protocol</span>:<a href="../Protocol/index.html#type-t">Protocol.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?path</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?color</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Log.Color.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_pipe</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?event_level</span>:<a href="../Daemon/Level/index.html#type-default_level">Daemon.Level.default_level</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?base_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?runner</span>:<span class="xref-unresolved">Tezt_wrapper</span>.Runner.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?preserved_levels</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Node/index.html#type-t">Node.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Initialize an accuser.</p><p>This <a href="#val-create"><code>create</code></a>s an accuser and <a href="#val-run"><code>run</code></a>, then waits for the accuser to be ready, and finally returns the accuser.</p><p>As the accuser usually needs to be connected to a node, we first wait for the node to be ready and then, run the accuser. If one does not want to wait for the node to be ready, it is necessary to use <code>create</code> and then <code>run</code>.</p><p><code>path</code> is the path to accuser binary. By default, it is chosen from the <code>protocol</code> and is assumed to be at the root.</p><p>The standard output and standard error output of the accuser will be logged with prefix <code>name</code> and color <code>color</code>.</p><p>Default <code>event_pipe</code> is a temporary file whose name is derived from <code>name</code>. It will be created as a named pipe so that accuser events can be received.</p><p><code>event_level</code> specifies the verbosity of the file descriptor sink. The default value is <code>`Info</code>.</p><p><code>base_dir</code> corresponds to the (useless) &quot;--base-dir&quot; argument of the octez-accuser command.</p><p>The <code>Node.t</code> parameter is the accuser's node target. The accuser will be configured to be synchronised with the given node, and will communicate with it.</p><p>If <code>runner</code> is specified, the accuser will be spawned on this runner using SSH.</p><p><code>preserved_levels</code> is the number of effective levels kept in the accuser's memory</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-restart"><a href="#val-restart" class="anchor"></a><code><span><span class="keyword">val</span> restart : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Restart an accuser.</p><p>This <a href="#val-terminate"><code>terminate</code></a>s an accuser, then <a href="#val-run"><code>run</code></a>s it again and waits for it to be ready.</p></div></div></div></body></html>
