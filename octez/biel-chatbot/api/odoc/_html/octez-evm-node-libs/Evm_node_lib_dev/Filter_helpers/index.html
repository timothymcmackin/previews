<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Filter_helpers (octez-evm-node-libs.Evm_node_lib_dev.Filter_helpers)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-evm-node-libs</a> &#x00BB; <a href="../index.html">Evm_node_lib_dev</a> &#x00BB; Filter_helpers</nav><header class="odoc-preamble"><h1>Module <code><span>Evm_node_lib_dev.Filter_helpers</span></code></h1><p>A bloom filter can be seen as a probabilistic set. As such, the order of its elements is not important.</p><p>Blocks contain a bloom filter with the union of all topics in their logs, together with the address of the contract that produced them. The <code>getLogs</code> RPC defines a filter (not to be confused with bloom filter) which may contain a pattern of topics to be matched with a log.</p><p>A pattern is defined as: <code>pattern := TOPIC | NULL | TOPIC list</code></p><p>Where <code>NULL</code> is a wildcard, and a list of topics matches against any of the elements in the list (<code>Or</code>).</p><p>To speed up the filtering, we compute a bloom filter corresponding to the filter's pattern. The goal is to check if this bloom is contained in the block's bloom, and only fetching the block in that case. Therefore, our filter must always be included in filters corresponding to blocks that have at least a log that matches with the pattern. For this reason, we decide to ignore <code>Or</code> patterns in the bloom filter &quot;heuristic&quot; (including all topics would break the previous property). The same is done for addresses, as a filter can match against a list of them. If this becomes a serious bottleneck, we could keep a collection of bloom filters to represent the disjunction.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-valid_filter"><a href="#type-valid_filter" class="anchor"></a><code><span><span class="keyword">type</span> valid_filter</span><span> = </span><span>{</span></code><ol><li id="type-valid_filter.from_block" class="def record field anchored"><a href="#type-valid_filter.from_block" class="anchor"></a><code><span>from_block : <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>;</span></code></li><li id="type-valid_filter.to_block" class="def record field anchored"><a href="#type-valid_filter.to_block" class="anchor"></a><code><span>to_block : <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>;</span></code></li><li id="type-valid_filter.bloom" class="def record field anchored"><a href="#type-valid_filter.bloom" class="anchor"></a><code><span>bloom : <a href="../Ethbloom/index.html#type-t">Ethbloom.t</a>;</span></code></li><li id="type-valid_filter.topics" class="def record field anchored"><a href="#type-valid_filter.topics" class="anchor"></a><code><span>topics : <span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-topic">Evm_node_lib_dev_encoding.Ethereum_types.Filter.topic</a> option</span> list</span>;</span></code></li><li id="type-valid_filter.address" class="def record field anchored"><a href="#type-valid_filter.address" class="anchor"></a><code><span>address : <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-address">Evm_node_lib_dev_encoding.Ethereum_types.address</a> list</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Saner representation of an input filter: <code>from_block</code> and <code>to_block</code> are defined by: A filter's <code>from_block</code> and <code>to_block</code> if provided, or a filter's <code>block_hash</code> if provided (<code>from_block = to_block = block_n</code>), or <code>from_block = to_block = latest block's number</code>.</p><p>A <code>bloom</code> filter is computed using the topics and address.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-bloom_filter"><a href="#type-bloom_filter" class="anchor"></a><code><span><span class="keyword">type</span> bloom_filter</span><span> = </span><span>{</span></code><ol><li id="type-bloom_filter.bloom" class="def record field anchored"><a href="#type-bloom_filter.bloom" class="anchor"></a><code><span>bloom : <a href="../Ethbloom/index.html#type-t">Ethbloom.t</a>;</span></code></li><li id="type-bloom_filter.topics" class="def record field anchored"><a href="#type-bloom_filter.topics" class="anchor"></a><code><span>topics : <span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-topic">Evm_node_lib_dev_encoding.Ethereum_types.Filter.topic</a> option</span> list</span>;</span></code></li><li id="type-bloom_filter.address" class="def record field anchored"><a href="#type-bloom_filter.address" class="anchor"></a><code><span>address : <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-address">Evm_node_lib_dev_encoding.Ethereum_types.address</a> list</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Incompatible_block_params"><a href="#extension-decl-Incompatible_block_params" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> += </span></code><ol><li id="extension-Incompatible_block_params" class="def variant extension anchored"><a href="#extension-Incompatible_block_params" class="anchor"></a><code><span>| </span><span><span class="extension">Incompatible_block_params</span></span></code></li><li id="extension-Block_range_too_large" class="def variant extension anchored"><a href="#extension-Block_range_too_large" class="anchor"></a><code><span>| </span><span><span class="extension">Block_range_too_large</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Filter_helpers.limit" class="def record field anchored"><a href="#module-Filter_helpers.limit" class="anchor"></a><code><span>limit : int;</span></code></li></ol><code><span>}</span></code></li><li id="extension-Topic_list_too_large" class="def variant extension anchored"><a href="#extension-Topic_list_too_large" class="anchor"></a><code><span>| </span><span><span class="extension">Topic_list_too_large</span></span></code></li><li id="extension-Receipt_not_found" class="def variant extension anchored"><a href="#extension-Receipt_not_found" class="anchor"></a><code><span>| </span><span><span class="extension">Receipt_not_found</span> <span class="keyword">of</span> <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-hash">Evm_node_lib_dev_encoding.Ethereum_types.hash</a></span></code></li><li id="extension-Too_many_logs" class="def variant extension anchored"><a href="#extension-Too_many_logs" class="anchor"></a><code><span>| </span><span><span class="extension">Too_many_logs</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Filter_helpers.limit" class="def record field anchored"><a href="#module-Filter_helpers.limit" class="anchor"></a><code><span>limit : int;</span></code></li></ol><code><span>}</span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-height_from_param"><a href="#val-height_from_param" class="anchor"></a><code><span><span class="keyword">val</span> height_from_param : 
  <span><span>(<span class="keyword">module</span> <a href="../Services_backend_sig/module-type-S/index.html">Services_backend_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Block_parameter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Block_parameter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Block_parameter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Block_parameter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>
   * <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>,
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>height_from_param (module Rollup_node_rpc) from to_</code> returns the block height for params <code>from</code> and <code>to_</code> as a tuple.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-valid_range"><a href="#val-valid_range" class="anchor"></a><code><span><span class="keyword">val</span> valid_range : 
  <span><a href="../../Evm_node_config/Configuration/index.html#type-log_filter_config">Evm_node_config.Configuration.log_filter_config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-emit_and_return_none"><a href="#val-emit_and_return_none" class="anchor"></a><code><span><span class="keyword">val</span> emit_and_return_none : 
  <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_event_logging/Internal_event/Simple/index.html#type-t">Tezos_base.TzPervasives.Internal_event.Simple.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><span class="type-var">'b</span> option</span>, <span class="type-var">'c</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_range"><a href="#val-validate_range" class="anchor"></a><code><span><span class="keyword">val</span> validate_range : 
  <span><a href="../../Evm_node_config/Configuration/index.html#type-log_filter_config">Evm_node_config.Configuration.log_filter_config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="../Services_backend_sig/module-type-S/index.html">Services_backend_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Filter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>
   * <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>,
    <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> list</span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make_bloom"><a href="#val-make_bloom" class="anchor"></a><code><span><span class="keyword">val</span> make_bloom : 
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Filter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Ethbloom/index.html#type-t">Ethbloom.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_topics"><a href="#val-validate_topics" class="anchor"></a><code><span><span class="keyword">val</span> validate_topics : 
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Filter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_bloom_filter"><a href="#val-validate_bloom_filter" class="anchor"></a><code><span><span class="keyword">val</span> validate_bloom_filter : 
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Filter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-bloom_filter">bloom_filter</a>, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_filter"><a href="#val-validate_filter" class="anchor"></a><code><span><span class="keyword">val</span> validate_filter : 
  <span><a href="../../Evm_node_config/Configuration/index.html#type-log_filter_config">Evm_node_config.Configuration.log_filter_config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="../Services_backend_sig/module-type-S/index.html">Services_backend_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Filter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-valid_filter">valid_filter</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hex_to_bytes"><a href="#val-hex_to_bytes" class="anchor"></a><code><span><span class="keyword">val</span> hex_to_bytes : <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-hex">Evm_node_lib_dev_encoding.Ethereum_types.hex</a> <span class="arrow">&#45;&gt;</span></span> bytes</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-match_filter_topics"><a href="#val-match_filter_topics" class="anchor"></a><code><span><span class="keyword">val</span> match_filter_topics : 
  <span><a href="#type-bloom_filter">bloom_filter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-hash">Evm_node_lib_dev_encoding.Ethereum_types.hash</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-match_filter_address"><a href="#val-match_filter_address" class="anchor"></a><code><span><span class="keyword">val</span> match_filter_address : 
  <span><a href="#type-bloom_filter">bloom_filter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-address">Evm_node_lib_dev_encoding.Ethereum_types.address</a> <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-filter_one_log"><a href="#val-filter_one_log" class="anchor"></a><code><span><span class="keyword">val</span> filter_one_log : 
  <span><a href="#type-bloom_filter">bloom_filter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-transaction_log">Evm_node_lib_dev_encoding.Ethereum_types.transaction_log</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-changes">Evm_node_lib_dev_encoding.Ethereum_types.Filter.changes</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-filter_receipt"><a href="#val-filter_receipt" class="anchor"></a><code><span><span class="keyword">val</span> filter_receipt : 
  <span><a href="#type-bloom_filter">bloom_filter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Transaction_receipt/index.html#type-t">Evm_node_lib_dev_encoding.Transaction_receipt.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-changes">Evm_node_lib_dev_encoding.Ethereum_types.Filter.changes</a> list</span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-filter_one_tx"><a href="#val-filter_one_tx" class="anchor"></a><code><span><span class="keyword">val</span> filter_one_tx : 
  <span><span>(<span class="keyword">module</span> <a href="../Services_backend_sig/module-type-S/index.html">Services_backend_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-bloom_filter">bloom_filter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-hash">Evm_node_lib_dev_encoding.Ethereum_types.hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-changes">Evm_node_lib_dev_encoding.Ethereum_types.Filter.changes</a> list</span> option</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-filter_one_block"><a href="#val-filter_one_block" class="anchor"></a><code><span><span class="keyword">val</span> filter_one_block : 
  <span><span>(<span class="keyword">module</span> <a href="../Services_backend_sig/module-type-S/index.html">Services_backend_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-valid_filter">valid_filter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Z</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-changes">Evm_node_lib_dev_encoding.Ethereum_types.Filter.changes</a> list</span> option</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-split_in_chunks"><a href="#val-split_in_chunks" class="anchor"></a><code><span><span class="keyword">val</span> split_in_chunks : <span><span class="label">chunk_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="label">base</span>:<span class="xref-unresolved">Z</span>.t <span class="arrow">&#45;&gt;</span></span> <span><span class="label">length</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span><span class="xref-unresolved">Z</span>.t list</span> list</span></span></code></div><div class="spec-doc"><p><code>split_in_chunks ~chunk_size ~base ~length</code> returns a list of lists (chunks) containing the consecutive numbers from <code>base</code> to <code>base + length - 1</code>. Each chunk is at most of length <code>chunk_size</code>. Only the last chunk can be shorter than <code>chunk_size</code>.</p><p>Example <code>split_in_chunks ~chunk_size:2 ~base:1 ~length:5</code> is &lt;&lt;1, 2&gt;, &lt;3,4&gt;, &lt;5&gt;&gt;.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_logs"><a href="#val-get_logs" class="anchor"></a><code><span><span class="keyword">val</span> get_logs : 
  <span><a href="../../Evm_node_config/Configuration/index.html#type-log_filter_config">Evm_node_config.Configuration.log_filter_config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="../Services_backend_sig/module-type-S/index.html">Services_backend_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-t">Evm_node_lib_dev_encoding.Ethereum_types.Filter.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Filter/index.html#type-changes">Evm_node_lib_dev_encoding.Ethereum_types.Filter.changes</a> list</span>,
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></div></body></html>
