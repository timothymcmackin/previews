<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Evm_state (octez-evm-node-libs.Evm_node_lib_dev.Evm_state)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">octez-evm-node-libs</a> &#x00BB; <a href="../index.html">Evm_node_lib_dev</a> &#x00BB; Evm_state</nav><header class="odoc-preamble"><h1>Module <code><span>Evm_node_lib_dev.Evm_state</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="../../../octez-l2-libs/Tezos_layer2_irmin_context/Irmin_context/PVMState/index.html#type-value">Tezos_layer2_irmin_context.Irmin_context.PVMState.value</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kernel_logs_directory"><a href="#val-kernel_logs_directory" class="anchor"></a><code><span><span class="keyword">val</span> kernel_logs_directory : <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Directory where the kernel logs are stored. The function <a href="#val-execute"><code>execute</code></a> below expect the directory to exist.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-execute"><a href="#val-execute" class="anchor"></a><code><span><span class="keyword">val</span> execute : 
  <span><span class="optlabel">?wasm_pvm_fallback</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?profile</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?kind</span>:<a href="../Events/index.html#type-kernel_log_kind">Events.kernel_log_kind</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?log_file</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?wasm_entrypoint</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">config</span>:<a href="../../../octez-smart-rollup-wasm-debugger-lib/Octez_smart_rollup_wasm_debugger_lib/Config/index.html#type-config">Octez_smart_rollup_wasm_debugger_lib.Config.config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">native_execution</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&lt; <span>`Input of string</span> ]</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-t">t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>execute ?simulation ~data_dir ?log_file ~wasm_entrypoint ~config
    evm_state messages</code> executes the <code>wasm_entrypoint</code> function (default to <code>kernel_run</code>) with <code>messages</code> within the inbox of <code>evm_state</code>.</p><p>Kernel logs are stored under the <a href="#val-kernel_logs_directory"><code>kernel_logs_directory</code></a> in <code>log_file</code>. <code>simulation</code> adds a prefix to the event to differenciate the logs.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><span class="label">kernel</span>:<a href="../Wasm_debugger/index.html#type-kernel">Wasm_debugger.kernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-t">t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init ~kernel</code> initializes the local <code>evm_state</code> with <code>kernel</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-modify"><a href="#val-modify" class="anchor"></a><code><span><span class="keyword">val</span> modify : <span><span class="optlabel">?edit_readonly</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span class="label">key</span>:string <span class="arrow">&#45;&gt;</span></span> <span><span class="label">value</span>:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>modify ~key ~value evm_state</code> sets <code>value</code> at <code>key</code> in the local EVM state.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-delete"><a href="#val-delete" class="anchor"></a><code><span><span class="keyword">val</span> delete : <span><span class="label">kind</span>:<a href="../../../octez-libs/Tezos_scoru_wasm/Durable/index.html#type-kind">Tezos_scoru_wasm.Durable.kind</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>delete ~kind evm_state key</code> delete the value/directory at <code>key</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-exists"><a href="#val-exists" class="anchor"></a><code><span><span class="keyword">val</span> exists : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>exists evm_state key</code> returns <code>true</code> if a value or a tree/subtree exists under <code>key</code> in <code>evm_state</code>, <code>false</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inspect"><a href="#val-inspect" class="anchor"></a><code><span><span class="keyword">val</span> inspect : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>bytes option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>inspect evm_state key</code> returns the value stored under <code>key</code> in <code>evm_state</code>, if any.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-subkeys"><a href="#val-subkeys" class="anchor"></a><code><span><span class="keyword">val</span> subkeys : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>string <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>subkeys evm_state key</code> returns the list of keys stored under <code>key</code> in <code>evm_state</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-execute_and_inspect"><a href="#val-execute_and_inspect" class="anchor"></a><code><span><span class="keyword">val</span> execute_and_inspect : 
  <span><span class="optlabel">?wasm_pvm_fallback</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?wasm_entrypoint</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">config</span>:<a href="../../../octez-smart-rollup-wasm-debugger-lib/Octez_smart_rollup_wasm_debugger_lib/Config/index.html#type-config">Octez_smart_rollup_wasm_debugger_lib.Config.config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">native_execution_policy</span>:<a href="../../Evm_node_config/Configuration/index.html#type-native_execution_policy">Evm_node_config.Configuration.native_execution_policy</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">input</span>:<a href="../Simulation/Encodings/index.html#type-simulate_input">Simulation.Encodings.simulate_input</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>bytes option</span> list</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>execute_and_inspect ~data_dir ?wasm_entrypoint ~config ~input
    evm_state</code> executes the <code>wasm_entrypoint</code> function (default to <code>kernel_run</code>) with <code>input</code> within the inbox of <code>evm_state</code>, and returns <code>input.insights_requests</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current_block_height"><a href="#val-current_block_height" class="anchor"></a><code><span><span class="keyword">val</span> current_block_height : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>current_block_height evm_state</code> returns the height of the latest block produced by the kernel.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current_block_hash"><a href="#val-current_block_hash" class="anchor"></a><code><span><span class="keyword">val</span> current_block_hash : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-block_hash">Evm_node_lib_dev_encoding.Ethereum_types.block_hash</a>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-current_block_height"><code>current_block_height</code></a> for the block hash.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-apply_result"><a href="#type-apply_result" class="anchor"></a><code><span><span class="keyword">type</span> apply_result</span><span> = </span></code><ol><li id="type-apply_result.Apply_success" class="def variant constructor anchored"><a href="#type-apply_result.Apply_success" class="anchor"></a><code><span>| </span><span><span class="constructor">Apply_success</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-apply_result.evm_state" class="def record field anchored"><a href="#type-apply_result.evm_state" class="anchor"></a><code><span>evm_state : <a href="#type-t">t</a>;</span></code></li><li id="type-apply_result.block" class="def record field anchored"><a href="#type-apply_result.block" class="anchor"></a><code><span>block : <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-block">Evm_node_lib_dev_encoding.Ethereum_types.block</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-apply_result.Apply_failure" class="def variant constructor anchored"><a href="#type-apply_result.Apply_failure" class="anchor"></a><code><span>| </span><span><span class="constructor">Apply_failure</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_blueprint"><a href="#val-apply_blueprint" class="anchor"></a><code><span><span class="keyword">val</span> apply_blueprint : 
  <span><span class="optlabel">?wasm_pvm_fallback</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?log_file</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?profile</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">config</span>:<a href="../../../octez-smart-rollup-wasm-debugger-lib/Octez_smart_rollup_wasm_debugger_lib/Config/index.html#type-config">Octez_smart_rollup_wasm_debugger_lib.Config.config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">native_execution_policy</span>:<a href="../../Evm_node_config/Configuration/index.html#type-native_execution_policy">Evm_node_config.Configuration.native_execution_policy</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Blueprint_types/index.html#type-payload">Blueprint_types.payload</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-apply_result">apply_result</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>apply_blueprint ~data-dir ~config state payload</code> applies the blueprint <code>payload</code> on top of <code>evm_state</code>. If the payload produces a block, the new updated EVM state is returned along with the new block’s height.</p><p>The <code>data-dir</code> is used to store the kernel logs in the <a href="#val-kernel_logs_directory"><code>kernel_logs_directory</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flag_local_exec"><a href="#val-flag_local_exec" class="anchor"></a><code><span><span class="keyword">val</span> flag_local_exec : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>flag_local_exec evm_state</code> adds a flag telling the kernel it is executed by an EVM node, not a rollup node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_delayed_inbox"><a href="#val-clear_delayed_inbox" class="anchor"></a><code><span><span class="keyword">val</span> clear_delayed_inbox : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>clear_delayed_inbox evm_state</code> removes the delayed inbox from the current EVM state.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wasm_pvm_version"><a href="#val-wasm_pvm_version" class="anchor"></a><code><span><span class="keyword">val</span> wasm_pvm_version : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../octez-libs/Tezos_scoru_wasm/Wasm_pvm_state/index.html#type-version">Tezos_scoru_wasm.Wasm_pvm_state.version</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-irmin_store_path"><a href="#val-irmin_store_path" class="anchor"></a><code><span><span class="keyword">val</span> irmin_store_path : <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>irmin_store_path ~data_dir</code> returns the path wherein the Irmin store is expected to be located, relatively to the data directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-preload_kernel"><a href="#val-preload_kernel" class="anchor"></a><code><span><span class="keyword">val</span> preload_kernel : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>preload_kernel evm_state</code> ensures the kernel of <code>evm_state</code> is added to the kernel cache of the execution runtime in use. This will speed-up the execution time for the first call of this kernel (typically in the context of a RPC call).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_delayed_inbox_item"><a href="#val-get_delayed_inbox_item" class="anchor"></a><code><span><span class="keyword">val</span> get_delayed_inbox_item : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-hash">Evm_node_lib_dev_encoding.Ethereum_types.hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Evm_node_lib_dev_encoding/Evm_events/Delayed_transaction/index.html#type-t">Evm_node_lib_dev_encoding.Evm_events.Delayed_transaction.t</a>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_delayed_inbox_item state hash</code> returns the delayed inbox content behind the hash <code>hash</code>. It fails if the hash does not exist or if the value cannot be decoded.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clear_block_storage"><a href="#val-clear_block_storage" class="anchor"></a><code><span><span class="keyword">val</span> clear_block_storage : 
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-block">Evm_node_lib_dev_encoding.Ethereum_types.block</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>clear_block_storage block state</code> removes the parent of <code>block</code>, and all durable storage information stored for <code>block</code>, if this function is called they need to be store elsewhere, mainly it consists in transactions.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-storage_version"><a href="#val-storage_version" class="anchor"></a><code><span><span class="keyword">val</span> storage_version : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>int <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>storage_version tree</code> returns the current storage version set by the kernel. This storage version is used by the EVM node to determine whether a given feature is implemented by the kernel or not.</p></div></div></div></body></html>
