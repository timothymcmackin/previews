<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Evm_context (octez-evm-node-libs.Evm_node_lib_dev.Evm_context)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-evm-node-libs</a> &#x00BB; <a href="../index.html">Evm_node_lib_dev</a> &#x00BB; Evm_context</nav><header class="odoc-preamble"><h1>Module <code><span>Evm_node_lib_dev.Evm_context</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-init_status"><a href="#type-init_status" class="anchor"></a><code><span><span class="keyword">type</span> init_status</span><span> = </span></code><ol><li id="type-init_status.Loaded" class="def variant constructor anchored"><a href="#type-init_status.Loaded" class="anchor"></a><code><span>| </span><span><span class="constructor">Loaded</span></span></code></li><li id="type-init_status.Created" class="def variant constructor anchored"><a href="#type-init_status.Created" class="anchor"></a><code><span>| </span><span><span class="constructor">Created</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-head"><a href="#type-head" class="anchor"></a><code><span><span class="keyword">type</span> head</span><span> = </span><span>{</span></code><ol><li id="type-head.current_block_hash" class="def record field anchored"><a href="#type-head.current_block_hash" class="anchor"></a><code><span>current_block_hash : <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-block_hash">Evm_node_lib_dev_encoding.Ethereum_types.block_hash</a>;</span></code></li><li id="type-head.finalized_number" class="def record field anchored"><a href="#type-head.finalized_number" class="anchor"></a><code><span>finalized_number : <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>;</span></code></li><li id="type-head.next_blueprint_number" class="def record field anchored"><a href="#type-head.next_blueprint_number" class="anchor"></a><code><span>next_blueprint_number : <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>;</span></code></li><li id="type-head.evm_state" class="def record field anchored"><a href="#type-head.evm_state" class="anchor"></a><code><span>evm_state : <a href="../Evm_state/index.html#type-t">Evm_state.t</a>;</span></code></li><li id="type-head.pending_upgrade" class="def record field anchored"><a href="#type-head.pending_upgrade" class="anchor"></a><code><span>pending_upgrade : <span><a href="../../Evm_node_lib_dev_encoding/Evm_events/Upgrade/index.html#type-t">Evm_node_lib_dev_encoding.Evm_events.Upgrade.t</a> option</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Cannot_apply_blueprint"><a href="#extension-decl-Cannot_apply_blueprint" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> += </span></code><ol><li id="extension-Cannot_apply_blueprint" class="def variant extension anchored"><a href="#extension-Cannot_apply_blueprint" class="anchor"></a><code><span>| </span><span><span class="extension">Cannot_apply_blueprint</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Evm_context.local_state_level" class="def record field anchored"><a href="#module-Evm_context.local_state_level" class="anchor"></a><code><span>local_state_level : <span class="xref-unresolved">Z</span>.t;</span></code></li></ol><code><span>}</span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-start"><a href="#val-start" class="anchor"></a><code><span><span class="keyword">val</span> start : 
  <span><span class="label">configuration</span>:<a href="../../Evm_node_config/Configuration/index.html#type-t">Evm_node_config.Configuration.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?kernel_path</span>:<a href="../Wasm_debugger/index.html#type-kernel">Wasm_debugger.kernel</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?smart_rollup_address</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">store_perm</span>:<span>[ `Read_only <span>| `Read_write</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?sequencer_wallet</span>:
    <span>(<a href="../../../octez-shell-libs/Tezos_client_base/Client_keys/index.html#type-sk_uri">Tezos_client_base.Client_keys.sk_uri</a>
     * <a href="../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-wallet/index.html">Tezos_client_base.Client_context.wallet</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?snapshot_url</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-init_status">init_status</a> * <a href="../../../octez-l2-libs/Octez_smart_rollup/Address/index.html#type-t">Octez_smart_rollup.Address.t</a>)</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>start</code> creates a new worker to manage a local EVM context where it initializes the <code>index</code>, and use a checkpoint mechanism to load the latest <code>store</code> if any. Returns a value telling if the context was loaded from disk (<code>Loaded</code>) or was initialized from scratch (<code>Created</code>). Returns also the smart rollup address.</p><p><code>kernel_path</code> can be provided to cover the case where the context does not exist yet, and is ignored otherwise.</p><p><code>data_dir</code> is the path to the data-dir of the node, notably containing the SQLite store and the Irmin context.</p><p><code>smart_rollup_address</code> can be provided either when starting from a non-existing data-dir, or when starting a sandbox.</p><p><code>store_perm</code> decides whether or not the worker can modify the Irmin context (it is most certainly an artifact of the past, made outdated by the <code>Evm_ro_context</code> module. Clearly, <code>~store_perm:`Read_only</code> menas you want to use <code>Evm_ro_context</code> instead.</p><p><code>snapshot_url</code> can be provided to automatically fetch and import the snapshot if the <code>data_dir</code> was not initialized before.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_from_rollup_node"><a href="#val-init_from_rollup_node" class="anchor"></a><code><span><span class="keyword">val</span> init_from_rollup_node : 
  <span><span class="label">configuration</span>:<a href="../../Evm_node_config/Configuration/index.html#type-t">Evm_node_config.Configuration.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">omit_delayed_tx_events</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">rollup_node_data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init_from_rollup_node ~omit_delayed_tx_events ~data_dir
    ~rollup_node_data_dir ()</code> initialises the irmin context and metadata of the evm using the latest known evm state of the given rollup node. if <code>omit_delayed_tx_events</code> dont populate the delayed tx event from the state into the db.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reset"><a href="#val-reset" class="anchor"></a><code><span><span class="keyword">val</span> reset : 
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">l2_level</span>:<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>reset ~data_dir ~l2_level</code> reset the sequencer storage to <code>l2_level</code>. <b>Warning: b</b> Data will be lost !</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_evm_events"><a href="#val-apply_evm_events" class="anchor"></a><code><span><span class="keyword">val</span> apply_evm_events : 
  <span><span class="optlabel">?finalized_level</span>:int32 <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Evm_node_lib_dev_encoding/Evm_events/index.html#type-t">Evm_node_lib_dev_encoding.Evm_events.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>apply_evm_events ~finalized_level events</code> applies all the events <code>events</code> on the local context. The events are performed in a transactional context.</p><p>Stores <code>finalized_level</code> with <code>new_last_known_l1_level</code> if provided.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_blueprint"><a href="#val-apply_blueprint" class="anchor"></a><code><span><span class="keyword">val</span> apply_blueprint : 
  <span><span class="optlabel">?events</span>:<span><a href="../../Evm_node_lib_dev_encoding/Evm_events/index.html#type-t">Evm_node_lib_dev_encoding.Evm_events.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Time/Protocol/index.html#type-t">Tezos_base.TzPervasives.Time.Protocol.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Blueprint_types/index.html#type-payload">Blueprint_types.payload</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Evm_node_lib_dev_encoding/Evm_events/Delayed_transaction/index.html#type-t">Evm_node_lib_dev_encoding.Evm_events.Delayed_transaction.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>apply_blueprint ?events timestamp payload delayed_transactions</code> applies <code>payload</code> in the freshest EVM state stored under <code>ctxt</code> at timestamp <code>timestamp</code>, forwards the <a href="../Blueprint_types/index.html#type-with_events"><code>Blueprint_types.with_events</code></a>. It commits the result if the blueprint produces the expected block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-head_info"><a href="#val-head_info" class="anchor"></a><code><span><span class="keyword">val</span> head_info : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-head">head</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-next_blueprint_number"><a href="#val-next_blueprint_number" class="anchor"></a><code><span><span class="keyword">val</span> next_blueprint_number : 
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-last_known_l1_level"><a href="#val-last_known_l1_level" class="anchor"></a><code><span><span class="keyword">val</span> last_known_l1_level : 
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>int32 option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-delayed_inbox_hashes"><a href="#val-delayed_inbox_hashes" class="anchor"></a><code><span><span class="keyword">val</span> delayed_inbox_hashes : 
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-hash">Evm_node_lib_dev_encoding.Ethereum_types.hash</a> list</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>delayed_inbox_hashes ctxt</code> returns the hashes in the delayed inbox.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-patch_kernel"><a href="#val-patch_kernel" class="anchor"></a><code><span><span class="keyword">val</span> patch_kernel : 
  <span><span class="optlabel">?block_number</span>:<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>patch_kernel path</code> modifies the state of the current head of the EVM node to replace its kernel with the kernel file <code>path</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-patch_sequencer_key"><a href="#val-patch_sequencer_key" class="anchor"></a><code><span><span class="keyword">val</span> patch_sequencer_key : 
  <span><span class="optlabel">?block_number</span>:<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Signature/index.html#type-public_key">Tezos_base.TzPervasives.Signature.public_key</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>patch_sequencer_key public_key</code> modifies the in memory state of the EVM node to replace the sequencer key with <code>public_key</code>. It does not modify the current head.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-patch_state"><a href="#val-patch_state" class="anchor"></a><code><span><span class="keyword">val</span> patch_state : 
  <span><span class="optlabel">?block_number</span>:<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">key</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">value</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>patch_state ~key ~value ()</code> writes <code>value</code> at <code>key</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-potential_observer_reorg"><a href="#val-potential_observer_reorg" class="anchor"></a><code><span><span class="keyword">val</span> potential_observer_reorg : 
  <span><span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Blueprint_types/index.html#type-with_events">Blueprint_types.with_events</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> option</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>potential_observer_reorg evm_node_endpoint blueprint_with_events</code> checks with the <code>evm_node_endpoint</code> if a reorganization happened, and return the reorganization level if it exists.</p><p>A reorganization can happen typically if the kernel flushed its delayed inbox in a blueprint.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-head_watcher"><a href="#val-head_watcher" class="anchor"></a><code><span><span class="keyword">val</span> head_watcher : 
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/Subscription/index.html#type-output">Evm_node_lib_dev_encoding.Ethereum_types.Subscription.output</a>
    <span class="xref-unresolved">Lwt_watcher</span>.input</span></span></code></div><div class="spec-doc"><p>Watcher that gets notified each time a new block is produced.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-receipt_watcher"><a href="#val-receipt_watcher" class="anchor"></a><code><span><span class="keyword">val</span> receipt_watcher : 
  <span><a href="../../Evm_node_lib_dev_encoding/Transaction_receipt/index.html#type-t">Evm_node_lib_dev_encoding.Transaction_receipt.t</a> <span class="xref-unresolved">Lwt_watcher</span>.input</span></span></code></div><div class="spec-doc"><p>Watcher that gets notified each time a new receipt is produced.</p></div></div></div></body></html>
