<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Evm_store (octez-evm-node-libs.Evm_node_lib_dev.Evm_store)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">octez-evm-node-libs</a> &#x00BB; <a href="../index.html">Evm_node_lib_dev</a> &#x00BB; Evm_store</nav><header class="odoc-preamble"><h1>Module <code><span>Evm_node_lib_dev.Evm_store</span></code></h1></header><div class="odoc-content"><div class="odoc-include"><div class="spec-doc"><p>The EVM node’s store is built around and SQLite database.</p></div><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <a href="../../../octez-l2-libs/Octez_sqlite/Sqlite/index.html">Octez_sqlite.Sqlite</a></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>A handler to the database.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-conn"><a href="#type-conn" class="anchor"></a><code><span><span class="keyword">type</span> conn</span></code></div><div class="spec-doc"><p>A direct connection to the database, allowing to interact with it.</p></div></div><h3 id="initialization-and-backup"><a href="#initialization-and-backup" class="anchor"></a>Initialization and backup</h3><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-vacuum"><a href="#val-vacuum" class="anchor"></a><code><span><span class="keyword">val</span> vacuum : 
  <span><span class="label">conn</span>:<a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">output_db_file</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Rebuild the database in <code>output_db_file</code> using the <a href="https://www.sqlite.org/lang_vacuum.html"><code>VACUUM</code> sqlite command</a>. This function is useful to backup the database.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-vacuum_self"><a href="#val-vacuum_self" class="anchor"></a><code><span><span class="keyword">val</span> vacuum_self : 
  <span><span class="label">conn</span>:<a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Vacuums the database itself after removing lot of data <a href="https://www.sqlite.org/lang_vacuum.html"><code>VACUUM</code> sqlite command</a>.</p></div></div><h3 id="database-connections"><a href="#database-connections" class="anchor"></a>Database connections</h3><div class="odoc-spec"><div class="spec value anchored" id="val-use"><a href="#val-use" class="anchor"></a><code><span><span class="keyword">val</span> use : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>use db k</code> executes <code>k</code> with a fresh connection to <code>db</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_transaction"><a href="#val-with_transaction" class="anchor"></a><code><span><span class="keyword">val</span> with_transaction : 
  <span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_transaction conn k</code> wraps the accesses to the database from <code>conn</code> made in the continuation <code>k</code> within <a href="https://www.sqlite.org/lang_transaction.html">a SQL transaction</a>. If <code>k</code> fails, the transaction is rollbacked. Otherwise, the transaction is committed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-assert_in_transaction"><a href="#val-assert_in_transaction" class="anchor"></a><code><span><span class="keyword">val</span> assert_in_transaction : <span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>assert_in_transaction conn</code> raises an exception if a transaction has not been started with <code>conn</code>.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Assert_failure</code> </li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_connection"><a href="#val-with_connection" class="anchor"></a><code><span><span class="keyword">val</span> with_connection : <span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span>(<span class="keyword">module</span> <span class="xref-unresolved">Caqti_lwt</span>.CONNECTION)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>with_connection conn k</code> allows to wraps atomic low level accesses to the database from <code>conn</code>. <code>with_connection</code> can be used in the continuation of <a href="#val-with_transaction"><code>with_transaction</code></a>.</p></div></div><h3 id="database-low-level-queries"><a href="#database-low-level-queries" class="anchor"></a>Database low level queries</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Db"><a href="#module-Db" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Db/index.html">Db</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Caqti convenience functions wrapped in the Tezos error monad. See <code>Caqti_connection_sig.Convenience</code>.</p></div></div></details></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">perm</span>:<span>[ `Read_only <span>| `Read_write</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-t">t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init ~data_dir ()</code> returns a handler to the EVM node store located under <code>data_dir</code>. If no store is located in <code>data_dir</code>, an empty store is created. Also returns if the store was created (<code>true</code>) or was already existing (<code>false</code>).</p><p>If <code>perm</code> is <code>`Read_only</code>, then SQL requests requiring write access will fail. With <code>`Read_write</code>, they will succeed as expected.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sqlite_file_name"><a href="#val-sqlite_file_name" class="anchor"></a><code><span><span class="keyword">val</span> sqlite_file_name : string</span></code></div><div class="spec-doc"><p>name of the sqlite file</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Schemas"><a href="#module-Schemas" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Schemas/index.html">Schemas</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Blueprints"><a href="#module-Blueprints" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Blueprints/index.html">Blueprints</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Context_hashes"><a href="#module-Context_hashes" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Context_hashes/index.html">Context_hashes</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-pending_kernel_upgrade"><a href="#type-pending_kernel_upgrade" class="anchor"></a><code><span><span class="keyword">type</span> pending_kernel_upgrade</span><span> = </span><span>{</span></code><ol><li id="type-pending_kernel_upgrade.kernel_upgrade" class="def record field anchored"><a href="#type-pending_kernel_upgrade.kernel_upgrade" class="anchor"></a><code><span>kernel_upgrade : <a href="../../Evm_node_lib_dev_encoding/Evm_events/Upgrade/index.html#type-t">Evm_node_lib_dev_encoding.Evm_events.Upgrade.t</a>;</span></code></li><li id="type-pending_kernel_upgrade.injected_before" class="def record field anchored"><a href="#type-pending_kernel_upgrade.injected_before" class="anchor"></a><code><span>injected_before : <a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Kernel_upgrades"><a href="#module-Kernel_upgrades" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Kernel_upgrades/index.html">Kernel_upgrades</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Delayed_transactions"><a href="#module-Delayed_transactions" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Delayed_transactions/index.html">Delayed_transactions</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Blocks"><a href="#module-Blocks" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Blocks/index.html">Blocks</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-context_hash_of_block_hash"><a href="#val-context_hash_of_block_hash" class="anchor"></a><code><span><span class="keyword">val</span> context_hash_of_block_hash : 
  <span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-block_hash">Evm_node_lib_dev_encoding.Ethereum_types.block_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../../octez-l2-libs/Tezos_layer2_irmin_context/Irmin_context/index.html#type-hash">Tezos_layer2_irmin_context.Irmin_context.hash</a> option</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Transactions"><a href="#module-Transactions" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Transactions/index.html">Transactions</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Irmin_chunks"><a href="#module-Irmin_chunks" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Irmin_chunks/index.html">Irmin_chunks</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Pending_confirmations"><a href="#module-Pending_confirmations" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Pending_confirmations/index.html">Pending_confirmations</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-L1_l2_levels_relationships"><a href="#module-L1_l2_levels_relationships" class="anchor"></a><code><span><span class="keyword">module</span> <a href="L1_l2_levels_relationships/index.html">L1_l2_levels_relationships</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-metadata"><a href="#type-metadata" class="anchor"></a><code><span><span class="keyword">type</span> metadata</span><span> = </span><span>{</span></code><ol><li id="type-metadata.smart_rollup_address" class="def record field anchored"><a href="#type-metadata.smart_rollup_address" class="anchor"></a><code><span>smart_rollup_address : <a href="../../../octez-l2-libs/Octez_smart_rollup/Address/index.html#type-t">Octez_smart_rollup.Address.t</a>;</span></code></li><li id="type-metadata.history_mode" class="def record field anchored"><a href="#type-metadata.history_mode" class="anchor"></a><code><span>history_mode : <a href="../../Evm_node_config/Configuration/index.html#type-history_mode">Evm_node_config.Configuration.history_mode</a>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Metadata"><a href="#module-Metadata" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Metadata/index.html">Metadata</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reset_after"><a href="#val-reset_after" class="anchor"></a><code><span><span class="keyword">val</span> reset_after : 
  <span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">l2_level</span>:<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>reset_after conn ~l2_level</code> clear the table that has information related to l2 level after <code>l2_level</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reset_before"><a href="#val-reset_before" class="anchor"></a><code><span><span class="keyword">val</span> reset_before : 
  <span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">l2_level</span>:<a href="../../Evm_node_lib_dev_encoding/Ethereum_types/index.html#type-quantity">Evm_node_lib_dev_encoding.Ethereum_types.quantity</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>reset_before conn ~l2_level</code> clear the table that has information related to l2 level before <code>l2_level</code></p></div></div></div></body></html>
