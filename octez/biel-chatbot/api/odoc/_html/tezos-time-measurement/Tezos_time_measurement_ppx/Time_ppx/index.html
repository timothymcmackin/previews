<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Time_ppx (tezos-time-measurement.Tezos_time_measurement_ppx.Time_ppx)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-time-measurement</a> &#x00BB; <a href="../index.html">Tezos_time_measurement_ppx</a> &#x00BB; Time_ppx</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_time_measurement_ppx.Time_ppx</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#ppx-for-embedded-time-measurement-tooling-generation">Ppx for embedded time measurement tooling generation</a><ul><li><a href="#expressions-recursivity">Expressions recursivity</a></li><li><a href="#validity">Validity</a></li></ul></li></ul></nav><div class="odoc-content"><h2 id="ppx-for-embedded-time-measurement-tooling-generation"><a href="#ppx-for-embedded-time-measurement-tooling-generation" class="anchor"></a>Ppx for embedded time measurement tooling generation</h2><p>This PPX is used to handle the rewriting of Ocaml expressions annotated with the following attributes: <code>[@time.duration]</code>, <code>[@time.duration_lwt]</code>, <code>[@time.timestamp_pre]</code> and <code>[@time.flush]</code>.</p><p>If one of these annotations is detected on an expression, this last one will be wrapped in a thunk that will be given respectively to <code>duration</code>, <code>duration_lwt</code>, <code>timestamp_pre</code> or <code>flush</code> functions from <code>Tezos_time_measurement_runtime.Default.Time_measurement</code> module along with the label extracted from the attribute payload if needed.</p><p>Example:</p><pre class="language-ocaml"><code>let x = 40 + 2 [@time.duration label42] in x

(* ==&gt; *)

let x =
  Tezos_time_measurement_runtime.Default.Time_measurement.duration
    &quot;label42&quot;
    (fun () -&gt; 40 + 2)</code></pre><h3 id="expressions-recursivity"><a href="#expressions-recursivity" class="anchor"></a>Expressions recursivity</h3><p>The PPX handles cases where sub-expressions are annotated.</p><p>For example, the following program will be valid and both <code>@time.duration</code> attributes will be effective:</p><pre class="language-ocaml"><code>(let x =
   &quot;Hi there!&quot; [@time.duration sub_expr]
 in x) [@time.duration expr]</code></pre><p>It however needs to be handled with care: When tagging nested expressions, the outer time measurement will include the time spent to measure the sub-expression.</p><h3 id="validity"><a href="#validity" class="anchor"></a>Validity</h3><p>All dedicated attributes must follow the following rules in order to be semantically correct:</p><ul><li>A same expression can not be annotated twice with the same annotation.</li><li><code>@time.duration</code>, <code>@time.duration_lwt</code> and <code>@time.timestamp_pre</code> must contain a payload.</li><li><code>@time.duration</code>, <code>@time.duration_lwt</code> and <code>@time.timestamp_pre</code>'s payload should be a valid Ocaml identifier (as described here: https://ocaml.org/manual/lex.html) optionally followed by an expression that evaluates to a string.</li></ul><div class="odoc-spec"><div class="spec type anchored" id="type-measurement_key"><a href="#type-measurement_key" class="anchor"></a><code><span><span class="keyword">type</span> measurement_key</span><span> = </span><span>{</span></code><ol><li id="type-measurement_key.label" class="def record field anchored"><a href="#type-measurement_key.label" class="anchor"></a><code><span>label : string;</span></code></li><li id="type-measurement_key.metadata" class="def record field anchored"><a href="#type-measurement_key.metadata" class="anchor"></a><code><span>metadata : <span><span class="xref-unresolved">Ppxlib</span>.expression <span class="xref-unresolved">Stdlib</span>.Option.t</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-rewriter"><a href="#type-rewriter" class="anchor"></a><code><span><span class="keyword">type</span> rewriter</span><span> = </span></code><ol><li id="type-rewriter.Duration" class="def variant constructor anchored"><a href="#type-rewriter.Duration" class="anchor"></a><code><span>| </span><span><span class="constructor">Duration</span> <span class="keyword">of</span> <a href="#type-measurement_key">measurement_key</a> * <span class="xref-unresolved">Ppxlib</span>.location</span></code></li><li id="type-rewriter.Duration_lwt" class="def variant constructor anchored"><a href="#type-rewriter.Duration_lwt" class="anchor"></a><code><span>| </span><span><span class="constructor">Duration_lwt</span> <span class="keyword">of</span> <a href="#type-measurement_key">measurement_key</a> * <span class="xref-unresolved">Ppxlib</span>.location</span></code></li><li id="type-rewriter.Timestamp_pre" class="def variant constructor anchored"><a href="#type-rewriter.Timestamp_pre" class="anchor"></a><code><span>| </span><span><span class="constructor">Timestamp_pre</span> <span class="keyword">of</span> <a href="#type-measurement_key">measurement_key</a> * <span class="xref-unresolved">Ppxlib</span>.location</span></code></li><li id="type-rewriter.Flush" class="def variant constructor anchored"><a href="#type-rewriter.Flush" class="anchor"></a><code><span>| </span><span><span class="constructor">Flush</span> <span class="keyword">of</span> <span class="xref-unresolved">Ppxlib</span>.location</span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-rewriter_constants"><a href="#type-rewriter_constants" class="anchor"></a><code><span><span class="keyword">type</span> rewriter_constants</span><span> = </span><span>{</span></code><ol><li id="type-rewriter_constants.fn_name" class="def record field anchored"><a href="#type-rewriter_constants.fn_name" class="anchor"></a><code><span>fn_name : string;</span></code></li><li id="type-rewriter_constants.attribute_name" class="def record field anchored"><a href="#type-rewriter_constants.attribute_name" class="anchor"></a><code><span>attribute_name : string;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-duration"><a href="#val-duration" class="anchor"></a><code><span><span class="keyword">val</span> duration : <span><a href="#type-measurement_key">measurement_key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <a href="#type-rewriter">rewriter</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-duration_lwt"><a href="#val-duration_lwt" class="anchor"></a><code><span><span class="keyword">val</span> duration_lwt : <span><a href="#type-measurement_key">measurement_key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <a href="#type-rewriter">rewriter</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-timestamp_pre"><a href="#val-timestamp_pre" class="anchor"></a><code><span><span class="keyword">val</span> timestamp_pre : <span><a href="#type-measurement_key">measurement_key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <a href="#type-rewriter">rewriter</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <a href="#type-rewriter">rewriter</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_rewriter_constants"><a href="#val-create_rewriter_constants" class="anchor"></a><code><span><span class="keyword">val</span> create_rewriter_constants : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-rewriter_constants">rewriter_constants</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-duration_constants"><a href="#val-duration_constants" class="anchor"></a><code><span><span class="keyword">val</span> duration_constants : <a href="#type-rewriter_constants">rewriter_constants</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-duration_lwt_constants"><a href="#val-duration_lwt_constants" class="anchor"></a><code><span><span class="keyword">val</span> duration_lwt_constants : <a href="#type-rewriter_constants">rewriter_constants</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-timestamp_pre_constants"><a href="#val-timestamp_pre_constants" class="anchor"></a><code><span><span class="keyword">val</span> timestamp_pre_constants : <a href="#type-rewriter_constants">rewriter_constants</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flush_constants"><a href="#val-flush_constants" class="anchor"></a><code><span><span class="keyword">val</span> flush_constants : <a href="#type-rewriter_constants">rewriter_constants</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-attribute_names"><a href="#val-attribute_names" class="anchor"></a><code><span><span class="keyword">val</span> attribute_names : <span>string list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-constants_of_rewriter"><a href="#val-constants_of_rewriter" class="anchor"></a><code><span><span class="keyword">val</span> constants_of_rewriter : <span><a href="#type-rewriter">rewriter</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-rewriter_constants">rewriter_constants</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-labeled_rewriter_of_attr_name"><a href="#val-labeled_rewriter_of_attr_name" class="anchor"></a><code><span><span class="keyword">val</span> labeled_rewriter_of_attr_name : 
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="#type-measurement_key">measurement_key</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span> <a href="#type-rewriter">rewriter</a>)</span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-locaction_of_rewriter"><a href="#val-locaction_of_rewriter" class="anchor"></a><code><span><span class="keyword">val</span> locaction_of_rewriter : <span><a href="#type-rewriter">rewriter</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib</span>.location</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error"><a href="#val-error" class="anchor"></a><code><span><span class="keyword">val</span> error : 
  <span><span class="xref-unresolved">Ppxlib</span>.Location.t <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&lt; `Invalid_payload <span>| `Non_empty_payload</span> <span><span>| `Too_many_Detection</span> of string</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_attribute_name"><a href="#val-get_attribute_name" class="anchor"></a><code><span><span class="keyword">val</span> get_attribute_name : <span><span class="xref-unresolved">Ppxlib</span>.attribute <span class="arrow">&#45;&gt;</span></span> string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-has_attribute_name"><a href="#val-has_attribute_name" class="anchor"></a><code><span><span class="keyword">val</span> has_attribute_name : <span><span class="xref-unresolved">Ppxlib</span>.attribute <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>has_attribute_name attribute name</code> evaluates if the name of the given <code>attribute</code> is equal to the given <code>name</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-filter_attribute_with_name"><a href="#val-filter_attribute_with_name" class="anchor"></a><code><span><span class="keyword">val</span> filter_attribute_with_name : 
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="xref-unresolved">Ppxlib</span>.attribute list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.attribute list</span></span></code></div><div class="spec-doc"><p><code>filter_attribute_with_name name attributes</code> evaluates in the list of <code>attributes</code> whose elements having the given <code>name</code> have been filtered out.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-filter_attribute_with_names"><a href="#val-filter_attribute_with_names" class="anchor"></a><code><span><span class="keyword">val</span> filter_attribute_with_names : 
  <span><span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="xref-unresolved">Ppxlib</span>.attribute list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.attribute list</span></span></code></div><div class="spec-doc"><p><code>filter_attribute_with_names names attributes</code> evaluates in the list of <code>attributes</code> whose elements having one of the given <code>names</code> have been filtered out.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fresh_identifier"><a href="#val-fresh_identifier" class="anchor"></a><code><span><span class="keyword">val</span> fresh_identifier : <span>string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>fresh_identifier prefix</code> evaluates in a new identifier prefixed by <code>prefix</code> at each call. The function guarantees that it never returns the same identifier twice.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-key_of_payload"><a href="#val-key_of_payload" class="anchor"></a><code><span><span class="keyword">val</span> key_of_payload : <span><span class="xref-unresolved">Ppxlib</span>.Location.t <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ppxlib</span>.payload <span class="arrow">&#45;&gt;</span></span> <a href="#type-measurement_key">measurement_key</a></span></code></div><div class="spec-doc"><p><code>key_of_payload location payload</code> extracts a <code>measurement_key</code> from the given <code>payload</code> if possible. The payload can be:</p><ul><li>An ocaml identifier as described here: https://ocaml.org/manual/lex.html. In this case, this identifier will be used as key label.</li><li>An apply of expression where the first element should be an ocaml identifier an the second one an expression that should evaluate in a list of string. In this case, the first element will be used as key label and the second one as key metadata. Note that this preprocessing step will not enforce this expression to evaluate to a list of string. It will rather accept every expression and let the compilation check the typing during typing analysis afterward.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_empty_payload"><a href="#val-check_empty_payload" class="anchor"></a><code><span><span class="keyword">val</span> check_empty_payload : <span><span class="xref-unresolved">Ppxlib</span>.Location.t <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ppxlib</span>.payload <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rewriter_of_attribute"><a href="#val-rewriter_of_attribute" class="anchor"></a><code><span><span class="keyword">val</span> rewriter_of_attribute : <span><span class="xref-unresolved">Ppxlib</span>.attribute <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-rewriter">rewriter</a> option</span></span></code></div><div class="spec-doc"><p><code>rewriter_of_attribute attribute</code> inspects the given <code>attribute</code> name and tries to recognise if it is related to this PPX. In this case, it will evaluate in the corresponding rewriter.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-extract_rewriters"><a href="#val-extract_rewriters" class="anchor"></a><code><span><span class="keyword">val</span> extract_rewriters : <span><span><span class="xref-unresolved">Ppxlib</span>.attribute list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-rewriter">rewriter</a> list</span></span></code></div><div class="spec-doc"><p><code>extract_rewriters attributes</code> inspects the given list of <code>attributes</code> and evaluates in the list of rewriters that have been identified with it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_rewriters"><a href="#val-validate_rewriters" class="anchor"></a><code><span><span class="keyword">val</span> validate_rewriters : <span><span><a href="#type-rewriter">rewriter</a> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>validate_rewriters rewriters</code> inspects the given list of <code>rewriters</code> and ensures that it is semantically correct.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-argument_of_key"><a href="#val-argument_of_key" class="anchor"></a><code><span><span class="keyword">val</span> argument_of_key : 
  <span><a href="#type-measurement_key">measurement_key</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression</span></code></div><div class="spec-doc"><p><code>argument_of_key key loc</code> transforms the given measurement <code>key</code> into a labeled argument that intends be used in an expression application at the given <code>loc</code>ation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ldot_of_non_empty_list"><a href="#val-ldot_of_non_empty_list" class="anchor"></a><code><span><span class="keyword">val</span> ldot_of_non_empty_list : <span><span>(string * <span>string list</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib</span>.longident</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-time_measurement_longident"><a href="#val-time_measurement_longident" class="anchor"></a><code><span><span class="keyword">val</span> time_measurement_longident : <span>string <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib</span>.longident</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wrap_with_labelled_call"><a href="#val-wrap_with_labelled_call" class="anchor"></a><code><span><span class="keyword">val</span> wrap_with_labelled_call : 
  <span><span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-measurement_key">measurement_key</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Astlib</span>.Ast_500.Parsetree.expression</span></code></div><div class="spec-doc"><p><code>wrap_with_labelled_call expr loc key fn</code> wraps the given <code>expr</code>ession into a thunk and gives it as an argument to a call of the function <code>fn</code> of module <code>Time_measurement</code>. It will use the given measurement <code>key</code> to compute subsidiary arguments.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bind_with_flush_call"><a href="#val-bind_with_flush_call" class="anchor"></a><code><span><span class="keyword">val</span> bind_with_flush_call : 
  <span><span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ppxlib</span>.location <span class="arrow">&#45;&gt;</span></span>
  <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression</span></code></div><div class="spec-doc"><p><code>bind_with_flush_call expr loc</code> binds the given <code>expr</code>ession with a <code>Lwt</code> promise that memoizes the results of <code>expr</code> and then call <code>Time_measurement.flush</code>. It then binds to a new <code>Lwt</code> promise that returns the memoized result of <code>expr</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rewrite"><a href="#val-rewrite" class="anchor"></a><code><span><span class="keyword">val</span> rewrite : <span><span><a href="#type-rewriter">rewriter</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ppxlib</span>.expression <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib_ast</span>.Ast.expression</span></code></div><div class="spec-doc"><p><code>rewrite rewriters initial_expr</code> sequentially interpretes the given rewriters in order to rewrite the given expression <code>initial_expr</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_attributes"><a href="#val-remove_attributes" class="anchor"></a><code><span><span class="keyword">val</span> remove_attributes : <span><span class="xref-unresolved">Ppxlib</span>.expression <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Ppxlib</span>.expression</span></code></div><div class="spec-doc"><p><code>remove_attributes expr</code> removes the attributes of the given <code>expr</code>ession if they match attributes handled by this PPX.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mapper"><a href="#val-mapper" class="anchor"></a><code><span><span class="keyword">val</span> mapper : <span class="xref-unresolved">Ppxlib</span>.Ast_traverse.map</span></code></div></div></div></body></html>
