<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Zk_rollup_apply (tezos-protocol-020-PsParisC.Tezos_raw_protocol_020_PsParisC.Zk_rollup_apply)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-020-PsParisC</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_020_PsParisC</a> &#x00BB; Zk_rollup_apply</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_020_PsParisC.Zk_rollup_apply</span></code></h1><p>This module handles all the validation/application of any operation related to the ZK Rollup. All of the functions defined in this module require that the ZKRU feature flag is enabled.</p></header><div class="odoc-content"><p>In the ZK Rollup, L2 operations are validated in two steps:</p><ol><li>The Protocol does the first pass of (light) validation and appends the L2 operation to a pending list.</li><li>The ZKRU Operator does the second pass of validation for a prefix of the pending list and posts a proof on chain of the validity of each of them. Based on this proof, the Protocol is going to remove the prefix from the pending list, and apply their effect on the ZKRU L2 state and on the L1 balances.</li></ol><p>The first step of validation is split into two cases, depending on the type of L2 operation that is being submitted:</p><ul><li>If the application of said L2 operation results in a transfer of a ticket from L1 to L2 (i.e. it is a ZKRU <i>deposit</i>), the L2 operation has to be submitted through a call to the ZKRU <code>%deposit</code> entrypoint from a smart contract. This constraint is imposed by the fact that implicit accounts cannot transfer tickets. Then, the validation of these L2 operations will be performed when applying the internal Tezos operation emitted by the call to the ZKRU's deposit entrypoint. This is implemented by the <code>transaction_to_zk_rollup</code> function in this module.</li><li>If its application results in a ticket transfer from L2 to L1 (i.e. it is a ZKRU <i>withdrawal</i>) or it has no transfer between layers, the L2 operation has to be submitted through a <code>Zk_rollup_publish</code> external Tezos operation. The checks for these L2 operations will be perform upon application of said external Tezos operation, whose logic is implemented by the <code>publish</code> function in this module.</li></ul><p>Although L2 operations are mostly opaque, they expose a header that is transparent to the Protocol (see <a href="../Zk_rollup_operation_repr/index.html#type-t"><code>Zk_rollup_operation_repr.t</code></a>). In this header there's a field for the <code>price</code> of an L2 operation, which will expose its kind. Concretely, the <code>price</code> encodes the net ticket transfer from L1 to L2 caused by an L2 operation. Then, deposits have a positive price, withdrawals a negative one, and pure L2 operations must have a price of zero.</p><p>An L2 operation's price also encodes which ticket is being transferred, by storing the ticket's hash (see <a href="../Ticket_hash_repr/index.html"><code>Ticket_hash_repr</code></a>). These hashes are used as token identifiers inside the ZKRU. In both cases, the L2 operations with a non-zero price (i.e. deposits and withdrawals) will be submitted alongside the values describing the ticket being transferred (see <a href="../Zk_rollup_ticket_repr/index.html"><code>Zk_rollup_ticket_repr</code></a>). These values have to be consistent with the token identifier used in the L2 operation's price.</p><p>NB: if ticket transfers by implicit accounts was supported, these two cases could be unified into the application of the <code>Zk_rollup_publish</code> operation.</p><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Zk_rollup_feature_disabled"><a href="#extension-decl-Zk_rollup_feature_disabled" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_protocol_environment_020_PsParisC/Error_monad/index.html#type-error">Tezos_protocol_environment_020_PsParisC.Error_monad.error</a> += </span></code><ol><li id="extension-Zk_rollup_feature_disabled" class="def variant extension anchored"><a href="#extension-Zk_rollup_feature_disabled" class="anchor"></a><code><span>| </span><span><span class="extension">Zk_rollup_feature_disabled</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Emitted when trying to apply a ZK Rollup operation while the ZKRU feature flag is not active.</p><span class="comment-delim">*)</span></div></li><li id="extension-Zk_rollup_negative_nb_ops" class="def variant extension anchored"><a href="#extension-Zk_rollup_negative_nb_ops" class="anchor"></a><code><span>| </span><span><span class="extension">Zk_rollup_negative_nb_ops</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Emitted when originating a ZK Rollup with a negative <code>nb_ops</code>.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>These errors are only to be matched in tests.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-assert_feature_enabled"><a href="#val-assert_feature_enabled" class="anchor"></a><code><span><span class="keyword">val</span> assert_feature_enabled : 
  <span><a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <a href="../../Tezos_protocol_environment_020_PsParisC/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_020_PsParisC.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>assert_feature_enabled ctxt</code> asserts that the ZK Rollup feature flag is activated.</p><p>May fail with:</p><ul><li><code>Zk_rollup_feature_disabled</code> if the ZKRU feature flag is not activated.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-originate"><a href="#val-originate" class="anchor"></a><code><span><span class="keyword">val</span> originate : 
  <span><span class="label">ctxt_before_op</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctxt</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">public_parameters</span>:
    <a href="../../Tezos_protocol_environment_020_PsParisC/Plonk/index.html#type-public_parameters">Tezos_protocol_environment_020_PsParisC.Plonk.public_parameters</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">circuits_info</span>:
    <span><span>[ `Public <span>| `Private</span> <span>| `Fee</span> ]</span> <a href="../Alpha_context/Zk_rollup/Account/SMap/index.html#type-t">Alpha_context.Zk_rollup.Account.SMap.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">init_state</span>:<a href="../Alpha_context/Zk_rollup/State/index.html#type-t">Alpha_context.Zk_rollup.State.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">nb_ops</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a>
   * <span><a href="../Alpha_context/Kind/index.html#type-zk_rollup_origination">Alpha_context.Kind.zk_rollup_origination</a>
       <a href="../Apply_results/index.html#type-successful_manager_operation_result">Apply_results.successful_manager_operation_result</a></span>
   * <span><a href="../Script_typed_ir/index.html#type-packed_internal_operation">Script_typed_ir.packed_internal_operation</a> list</span>)</span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_020_PsParisC.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Lwt/index.html#type-t">Tezos_protocol_environment_020_PsParisC.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>originate ~ctxt_before_op ~ctxt ~public_parameters ~transcript
               ~circuits_info ~init_state ~nb_ops</code> applies the origination operation for a ZK rollup. See <a href="../Zk_rollup_storage/index.html#val-originate"><code>Zk_rollup_storage.originate</code></a>.</p><p>May fail with:</p><ul><li><code>Zk_rollup_feature_disabled</code> if the ZKRU feature flag is not activated.</li><li><code>Zk_rollup_negative_nb_ops</code> if <code>nb_ops</code> is negative.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-publish"><a href="#val-publish" class="anchor"></a><code><span><span class="keyword">val</span> publish : 
  <span><span class="label">ctxt_before_op</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctxt</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">zk_rollup</span>:<a href="../Alpha_context/Zk_rollup/index.html#type-t">Alpha_context.Zk_rollup.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">l2_ops</span>:
    <span><span>(<a href="../Alpha_context/Zk_rollup/Operation/index.html#type-t">Alpha_context.Zk_rollup.Operation.t</a>
     * <span><a href="../Alpha_context/Zk_rollup/Ticket/index.html#type-t">Alpha_context.Zk_rollup.Ticket.t</a> option</span>)</span>
      list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a>
   * <span><a href="../Alpha_context/Kind/index.html#type-zk_rollup_publish">Alpha_context.Kind.zk_rollup_publish</a>
       <a href="../Apply_results/index.html#type-successful_manager_operation_result">Apply_results.successful_manager_operation_result</a></span>
   * <span><a href="../Script_typed_ir/index.html#type-packed_internal_operation">Script_typed_ir.packed_internal_operation</a> list</span>)</span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_020_PsParisC.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Lwt/index.html#type-t">Tezos_protocol_environment_020_PsParisC.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>publish ~ctxt_before_op ~ctxt ~zk_rollup ~l2_ops</code> applies a publish operation to <code>zk_rollup</code> by adding <code>l2_ops</code> to its pending list.</p><p>All L2 operations in <code>l2_ops</code> must claim a non-positive <code>price</code> (see <a href="../Zk_rollup_operation_repr/index.html"><code>Zk_rollup_operation_repr</code></a>). In other words, no deposit is allowed in this operation, as those must go through an internal transaction.</p><p>This function will first perform a series of validation checks over the L2 operations in <code>l2_ops</code>. If all of them are successful, these L2 operations will be added to <code>dst_rollup</code>'s pending list.</p><p>May fail with:</p><ul><li><code>Zk_rollup_feature_disabled</code> if the ZKRU feature flag is not activated.</li><li><code>Zk_rollup.Errors.Deposit_as_external</code> if the price of an L2 operation from <code>ops</code> is positive.</li><li><code>Zk_rollup.Errors.Invalid_deposit_amount</code> if an L2 operation declares no ticket but has a non-zero price or if it declares a ticket with a price of zero.</li><li><code>Zk_rollup.Errors.Invalid_deposit_ticket</code> if an L2 operation's ticket identifier (see <code>Zk_rollup_operation_repr</code>) is different from the hash of its corresponding ticket and <code>l1_dst</code>.</li><li><code>Zk_rollup_storage.Zk_rollup_invalid_op_code op_code</code> if the <code>op_code</code> of one of the <code>operations</code> is greater or equal to the number of declared operations for this <code>zk_rollup</code>.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transaction_to_zk_rollup"><a href="#val-transaction_to_zk_rollup" class="anchor"></a><code><span><span class="keyword">val</span> transaction_to_zk_rollup : 
  <span><span class="label">ctxt</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parameters_ty</span>:
    <span><span>(<span><span>(<span><span class="type-var">'a</span> <a href="../Script_typed_ir/index.html#type-ticket">Script_typed_ir.ticket</a></span>, bytes)</span> <a href="../Script_typed_ir/index.html#type-pair">Script_typed_ir.pair</a></span>, <span class="type-var">'b</span>)</span>
      <a href="../Script_typed_ir/index.html#type-ty">Script_typed_ir.ty</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parameters</span>:<span><span>(<span><span class="type-var">'a</span> <a href="../Script_typed_ir/index.html#type-ticket">Script_typed_ir.ticket</a></span>, bytes)</span> <a href="../Script_typed_ir/index.html#type-pair">Script_typed_ir.pair</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dst_rollup</span>:<a href="../Alpha_context/Zk_rollup/index.html#type-t">Alpha_context.Zk_rollup.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">since</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a>
   * <span><a href="../Alpha_context/Kind/index.html#type-transaction">Alpha_context.Kind.transaction</a>
       <a href="../Apply_internal_results/index.html#type-successful_internal_operation_result">Apply_internal_results.successful_internal_operation_result</a></span>
   * <span><a href="../Script_typed_ir/index.html#type-packed_internal_operation">Script_typed_ir.packed_internal_operation</a> list</span>)</span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_020_PsParisC.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Lwt/index.html#type-t">Tezos_protocol_environment_020_PsParisC.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>transaction_to_zk_rollup
      ~ctxt ~parameters_ty ~parameters ~payer ~dst_rollup ~since</code> applies an internal transaction to a ZK <code>dst_rollup</code>.</p><p>Internal transactions are used for deposits into ZK rollups, which can be seen as a special case of the publish ZK rollup operation. The <code>parameters</code> should include a ticket and a ZKRU L2 operation, as explained in the <a href="../Zk_rollup_parameters/index.html"><code>Zk_rollup_parameters</code></a> module's documentation.</p><p>This function will first perform a series of validation checks. If successful, the L2 operation from the <code>parameters</code> will be added to <code>dst_rollup</code>'s pending list, and <code>payer</code> will pay for the added storage.</p><p>May fail with:</p><ul><li><code>Zk_rollup_feature_disabled</code> if the ZKRU feature flag is not activated.</li><li><code>Zk_rollup.Errors.Ticket_payload_size_limit_exceeded</code> if the ticket found in the <code>parameters</code> exceeds the maximum ticket size.</li><li><code>Script_tc_errors.Forbidden_zero_ticket_quantity</code> if the ticket amount is zero.</li><li><code>Zk_rollup.Errors.Invalid_deposit_amount</code> if the amount of the ticket transferred to the <code>dst_rollup</code> is different from the <code>price</code> (see <a href="../Zk_rollup_operation_repr/index.html"><code>Zk_rollup_operation_repr</code></a>) claimed by the L2 operation.</li><li><code>Zk_rollup.Errors.Invalid_deposit_ticket</code> if the L2 operation's ticket identifier (see <a href="../Zk_rollup_operation_repr/index.html"><code>Zk_rollup_operation_repr</code></a>) is different to the hash of the transferred ticket and <code>dst_rollup</code>.</li><li><code>Zk_rollup_storage.Zk_rollup_invalid_op_code op_code</code> if the <code>op_code</code> of the operation from the <code>parameters</code> is greater or equal to the number of declared operations for this rollup.</li><li><code>Zk_rollup.Errors.Wrong_deposit_parameters</code> if the <code>parameters</code> are not of the expected type. See <a href="../Zk_rollup_parameters/index.html"><code>Zk_rollup_parameters</code></a>.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update"><a href="#val-update" class="anchor"></a><code><span><span class="keyword">val</span> update : 
  <span><span class="label">ctxt_before_op</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ctxt</span>:<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">zk_rollup</span>:<a href="../Alpha_context/Zk_rollup/index.html#type-t">Alpha_context.Zk_rollup.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">update</span>:<a href="../Alpha_context/Zk_rollup/Update/index.html#type-t">Alpha_context.Zk_rollup.Update.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Alpha_context/index.html#type-t">Alpha_context.t</a>
   * <span><a href="../Alpha_context/Kind/index.html#type-zk_rollup_update">Alpha_context.Kind.zk_rollup_update</a>
       <a href="../Apply_results/index.html#type-successful_manager_operation_result">Apply_results.successful_manager_operation_result</a></span>
   * <span><a href="../Script_typed_ir/index.html#type-packed_internal_operation">Script_typed_ir.packed_internal_operation</a> list</span>)</span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_020_PsParisC.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_020_PsParisC/Lwt/index.html#type-t">Tezos_protocol_environment_020_PsParisC.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>update ~ctxt_before_op ~ctxt ~zk_rollup ~update ~source_contract</code> applies an <code>update</code> to <code>zk_rollup</code>.</p><p>A ZKRU update will verify three sorts of ZK circuits:</p><ul><li>Public operation circuits, that handle a single L2 operation from the pending list.</li><li>Private batch circuits, that handle a batch of private L2 operations.</li><li>Fee circuit, which credits the ZKRU operator with all the aggregated fees from the update.</li></ul><p>The <code>update</code> provides some inputs required to perform this verification, alongside the proof. See <a href="../Zk_rollup_update_repr/index.html"><code>Zk_rollup_update_repr</code></a>.</p><p>If the verification is successful, the <code>zk_rollup</code>'s state is updated, a prefix of its pending list is dropped and the exits from the ZKRU are performed.</p><p>May fail with:</p><ul><li><code>Zk_rollup_feature_disabled</code> if the ZKRU feature flag is not activated.</li><li><code>Zk_rollup.Errors.Pending_bound</code> if the <code>update</code> processes fewer public operation than allowed.</li><li><code>Zk_rollup.Errors.Inconsistent_state_update</code> if the <code>update</code> declares a new state of incorrect length.</li><li><code>Zk_rollup.Errors.Invalid_circuit</code> if a public operation circuit is ran as private.</li><li><code>Zk_rollup.Errors.Invalid_verification</code> if the PlonK verification fails.</li><li><code>Zk_rollup.Errors.Invalid_deposit_amount</code> if an L2 operation without a corresponding ticket in the pending list has a non-zero price.</li><li><code>Zk_rollup_storage.Zk_rollup_pending_list_too_short</code> if the <code>update</code> tries to process more public operations than those in the pending list.</li></ul></div></div></div></body></html>
