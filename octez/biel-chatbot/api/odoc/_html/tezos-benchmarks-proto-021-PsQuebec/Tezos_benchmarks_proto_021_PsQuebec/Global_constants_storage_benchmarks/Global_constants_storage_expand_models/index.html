<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Global_constants_storage_expand_models (tezos-benchmarks-proto-021-PsQuebec.Tezos_benchmarks_proto_021_PsQuebec.Global_constants_storage_benchmarks.Global_constants_storage_expand_models)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">tezos-benchmarks-proto-021-PsQuebec</a> &#x00BB; <a href="../../index.html">Tezos_benchmarks_proto_021_PsQuebec</a> &#x00BB; <a href="../index.html">Global_constants_storage_benchmarks</a> &#x00BB; Global_constants_storage_expand_models</nav><header class="odoc-preamble"><h1>Module <code><span>Global_constants_storage_benchmarks.Global_constants_storage_expand_models</span></code></h1><p><code>Global_constants_storage.expand</code> traverses a Micheline node, searching for constants and replacing them with their values retrieved from storage.</p><p>There are three branches in the iterations of <code>Global_constants_storage.expand</code> can take, each with different costs:</p><ul><li>Branch 1: The first time a particular constant is found, the hash is parsed with <code>Script_expr_hash.of_b58check_opt</code>, and its value is retrieved from storage. This storage call (implemented <code>Global_constants_storage.get</code>) is already carbonated and dominates the cost in this case, so do not need to benchmark Branch 1 - the benchmarks for storage access are sufficient.</li><li>Branch 2: If the same constant is found a subsequent time, its value is looked up in a map. On testing we determined that the cost of <code>Script_expr_hash.of_b58check_opt</code> dominates the cost of this branch - the cost of an OCaml map lookup is O(log 2 n), and n has to be unreasonably large to catch up to the constant time cost of validating the hash.</li><li>Branch 3: When no constant is found, the cost is merely that of pattern matching and calling the continuation (similar to that of <code>Micheline.strip_locations</code>).</li></ul><p>Because we don't know the full size of node being traversed ahead of time (because they are retrieved from storage), it is impossible to calculate the full gas cost upfront. However, each time we find a new expression to traverse, we can calculate its size upfront and charge the cost of all Branch 3 cases. We can then do an additional charge for Branch 2 each time we find a constant, and let storage handle charging for Branch 1.</p><p>Below are models for Branch 2 and 3 respectively.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Global_constants_storage_expand_constant_branch"><a href="#module-Global_constants_storage_expand_constant_branch" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Global_constants_storage_expand_constant_branch/index.html">Global_constants_storage_expand_constant_branch</a></span><span> : 
  <a href="../../Benchmarks_proto/Benchmark/module-type-S/index.html">Benchmarks_proto.Benchmark.S</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Global_constants_storage_expand_no_constant_branch"><a href="#module-Global_constants_storage_expand_no_constant_branch" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Global_constants_storage_expand_no_constant_branch/index.html">Global_constants_storage_expand_no_constant_branch</a></span><span> : 
  <a href="../../Benchmarks_proto/Benchmark/module-type-S/index.html">Benchmarks_proto.Benchmark.S</a></span></code></div></div></div></body></html>
