<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sc_rollup_commitment_storage (tezos-protocol-alpha.Tezos_raw_protocol_alpha.Sc_rollup_commitment_storage)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tezos-protocol-alpha</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_alpha</a> &#x00BB; Sc_rollup_commitment_storage</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_alpha.Sc_rollup_commitment_storage</span></code></h1><p>Defines storage for Smart Contract Optimistic Rollups.</p></header><nav class="odoc-toc"><ul><li><a href="#commitments">Commitments</a><ul><li><a href="#predecessors-and-boot-state">Predecessors and Boot state</a></li><li><a href="#cemented-and-disputable-commitments">Cemented and Disputable commitments</a></li><li><a href="#stakers">Stakers</a></li><li><a href="#dispute">Dispute</a></li><li><a href="#dispute-resolution">Dispute resolution</a></li><li><a href="#conflicts">Conflicts</a></li></ul></li></ul></nav><div class="odoc-content"><h3 id="commitments"><a href="#commitments" class="anchor"></a>Commitments</h3><p><code>Commitment</code>s are stored directly in the L1 context. Commitments are immutable and content-addressed, and can be indexed by a <code>Commitment_hash</code>.</p><p>A commitment represents a claim about the state of a PVM.</p><p>We also keep auxiliary state about each commitment, namely:</p><ul><li>When it was first added.</li><li>Its current number of stakers.</li></ul><p>This auxiliary data is not part of the commitment itself. They represent information that the L1 knows about the claim, not the claim itself.</p><h4 id="predecessors-and-boot-state"><a href="#predecessors-and-boot-state" class="anchor"></a>Predecessors and Boot state</h4><p>Each commitment contains the hash of its <i>predecessor</i>. Multiple commitments can have the same predecessor. Therefore, commitments form a Merkle tree.</p><p>Conceptually the root of this tree is the <code>Commitment_hash.zero</code>. This commitment claims that the PVM (Proof-generating Virtual Machine) is in a pre-boot state and waiting to start booting by interpreting the boot sector with respect to the Machine semantics.</p><h4 id="cemented-and-disputable-commitments"><a href="#cemented-and-disputable-commitments" class="anchor"></a>Cemented and Disputable commitments</h4><p>Commitments accepted as true by the protocol are referred to as Cemented. A commitment that is not cemented is said to be disputable.</p><h4 id="stakers"><a href="#stakers" class="anchor"></a>Stakers</h4><p>The Stakers table maps Stakers (implicit accounts) to commitments hashes.</p><p>Let <code>Stakers(S)</code> mean &quot;looking up the key S in <code>Stakers</code>&quot;.</p><p>A staker <code>S</code> is directly staked on <code>C</code> if <code>Stakers(S) = C</code>. A staker <code>S</code> is indirectly staked on <code>C</code> if <code>C</code> is an ancestor of <code>Stakers(S)</code> in the commitment tree.</p><h4 id="dispute"><a href="#dispute" class="anchor"></a>Dispute</h4><p>Commitments that have at least one sibling are referred to as Disputed. More formally, a commitment C is disputed if at least one staker is not (directly or indirectly) staked on C.</p><h4 id="dispute-resolution"><a href="#dispute-resolution" class="anchor"></a>Dispute resolution</h4><p>The rollup protocol ensures that all disputes are resolved before cementing a commitment. Therefore, cemented commitments form a list rather than a tree.</p><p>In the context we only store the Last Cemented Commitment (LCC), which is by definition a descendant of <code>zero</code>. We also store all Disputable commitments that have at least one Staker.</p><p>For example, assuming the full set of commitments for a rollup looks like this:</p><pre class="language-ocaml"><code>           LCC  staker1  staker2
            |      |        |
            |      V        |
            V   --c3        |
zero--c1 --c2--/            |
               \            V
                --c4------ c5</code></pre><p>then commitments <code>c2..c5</code> will be stored in the context.</p><h4 id="conflicts"><a href="#conflicts" class="anchor"></a>Conflicts</h4><p>Let Commitments(S) be the set of commitments directly staked on by staker S.</p><p>Two stakers A and B are:</p><ul><li>In total agreement iff Commitments(A) = Commitments(B).</li><li>In partial agreement iff either Commitments(A) ⊂ Commitments(B), or Commitments(B) ⊂ Commitments(A).</li><li>In conflict iff they are neither in total or partial agreement.</li></ul><p>We can further refine a conflict to note what they are in conflict about, e.g. they may be in conflict about the inbox, about execution, or both. We can resolve conflicts by first resolving the conflict about inbox, then about execution (since execution is irrelevant if the inbox is not correct).</p><div class="odoc-spec"><div class="spec module anchored" id="module-Commitment"><a href="#module-Commitment" class="anchor"></a><code><span><span class="keyword">module</span> Commitment</span><span> = <a href="../Sc_rollup_commitment_repr/index.html">Sc_rollup_commitment_repr</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Commitment_hash"><a href="#module-Commitment_hash" class="anchor"></a><code><span><span class="keyword">module</span> Commitment_hash</span><span> = <a href="../Sc_rollup_commitment_repr/Hash/index.html">Commitment.Hash</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-last_cemented_commitment"><a href="#val-last_cemented_commitment" class="anchor"></a><code><span><span class="keyword">val</span> last_cemented_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>last_cemented_commitment context rollup</code> returns the last cemented commitment of the rollup.</p><p>If no commitments have been cemented, the rollup is said to be in a pre-boot state, and <code>last_cemented_commitment = Commitment_hash.zero</code>.</p><p>May fail with:</p><ul><li><code>Sc_rollup_does_not_exist</code> if <code>rollup</code> does not exist</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-last_cemented_commitment_hash_with_level"><a href="#val-last_cemented_commitment_hash_with_level" class="anchor"></a><code><span><span class="keyword">val</span> last_cemented_commitment_hash_with_level : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> * <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>last_cemented_commitment_hash_with_level ctxt sc_rollup</code> returns the hash and level of the last cemented commitment (lcc) for <code>sc_rollup</code>. If the rollup exists but no lcc exists, the initial commitment <code>Sc_rollup.Commitment.zero</code> together with the rollup origination level is returned.</p><p>May fail with:</p><ul><li><code>Sc_rollup_does_not_exist</code> if <code>rollup</code> does not exist</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_commitment"><a href="#val-get_commitment" class="anchor"></a><code><span><span class="keyword">val</span> get_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Sc_rollup_commitment_repr/index.html#type-t">Commitment.t</a> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>get_commitment context rollup commitment_hash</code> returns the commitment with the given hash.</p><p>May fail with:</p><ul><li><code>Sc_rollup_does_not_exist</code> if <code>rollup</code> does not exist</li><li><code>Sc_rollup_unknown_commitment</code> if <code>commitment</code> does not exist</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_commitment_opt_unsafe"><a href="#val-get_commitment_opt_unsafe" class="anchor"></a><code><span><span class="keyword">val</span> get_commitment_opt_unsafe : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../Sc_rollup_commitment_repr/index.html#type-t">Commitment.t</a> <a href="../../Tezos_protocol_environment_alpha/Option/index.html#type-t">Tezos_protocol_environment_alpha.Option.t</a></span> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>get_commitment_opt_unsafe context rollup commitment_hash</code> returns an <code>Option.t</code> which is either a defined value containing the commitment with the given hash, or `None` if such a commitment does not exist. This function *must* be called only after they have checked for the existence of the rollup, and therefore it is not necessary for it to check for the existence of the rollup again. Otherwise, use the safe function <a href="#val-get_commitment"><code>get_commitment</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_commitment_unsafe"><a href="#val-get_commitment_unsafe" class="anchor"></a><code><span><span class="keyword">val</span> get_commitment_unsafe : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Sc_rollup_commitment_repr/index.html#type-t">Commitment.t</a> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>get_commitment_unsafe context rollup commitment_hash</code> returns the commitment with the given hash. This function *must* be called only after they have checked for the existence of the rollup, and therefore it is not necessary for it to check for the existence of the rollup again. Otherwise, use the safe function <a href="#val-get_commitment"><code>get_commitment</code></a>.</p><p>May fail with:</p><ul><li><code>Sc_rollup_unknown_commitment</code> if <code>commitment</code> does not exist</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_commitment_added"><a href="#val-set_commitment_added" class="anchor"></a><code><span><span class="keyword">val</span> set_commitment_added : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(int * <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>set_commitment_added ctxt rollup node current</code> sets the commitment addition time of <code>node</code> to <code>current</code> iff the commitment time was not previously set, and leaves it unchanged otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_predecessor_opt_unsafe"><a href="#val-get_predecessor_opt_unsafe" class="anchor"></a><code><span><span class="keyword">val</span> get_predecessor_opt_unsafe : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <a href="../../Tezos_protocol_environment_alpha/Option/index.html#type-t">Tezos_protocol_environment_alpha.Option.t</a></span> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>get_predecessor_opt_unsafe ctxt rollup commitment_hash</code> returns an <code>Option.t</code> value containing the <code>rollup</code> commitment predecessor of <code>commitment_hash</code> in the <code>ctxt</code>, if any. It does not check for the existence of the <code>rollup</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_if_commitments_are_related"><a href="#val-check_if_commitments_are_related" class="anchor"></a><code><span><span class="keyword">val</span> check_if_commitments_are_related : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">descendant</span>:<a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ancestor</span>:<a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(bool * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span> <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_alpha/Lwt/index.html#type-t">Tezos_protocol_environment_alpha.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>check_if_commitments_are_related ~descendant ~ancestor</code> checks whether a commitment with hash <code>~ancestor</code> exists as a predecessor of <code>~descendant</code>, among the list of commitments stored for <code>rollup</code> in <code>ctxt</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/index.html#type-t">Commitment.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Commitment_hash.t</a>)</span>
    <a href="../../Tezos_protocol_environment_alpha/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_alpha.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p>Hash a commitment and account for gas spent.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
