<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Mempool (octez-protocol-alpha-libs.Tezos_protocol_plugin_alpha.Mempool)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-protocol-alpha-libs</a> &#x00BB; <a href="../index.html">Tezos_protocol_plugin_alpha</a> &#x00BB; Mempool</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_protocol_plugin_alpha.Mempool</span></code></h1><p>Plugin for the shell mempool. It must include the signature <code>FILTER.Mempool</code> from <code>lib_shell/shell_plugin.mli</code>.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-config"><a href="#type-config" class="anchor"></a><code><span><span class="keyword">type</span> config</span></code></div><div class="spec-doc"><p>Settings for the <a href="#val-pre_filter"><code>pre_filter</code></a>:</p><ul><li>minimal fees to accept an operation (absolute, relative to the gas limit, and relative to the byte size)</li><li>clock drift for the prefiltering of consensus operations</li></ul><p>and for the <a href="#val-conflict_handler"><code>conflict_handler</code></a>:</p><ul><li>replacement factor, that is, how much better a new manager operation needs to be, in terms of both absolute fees and fee/gas ratios, in order to replace an old conflicting manager operation.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_config"><a href="#val-default_config" class="anchor"></a><code><span><span class="keyword">val</span> default_config : <a href="#type-config">config</a></span></code></div><div class="spec-doc"><p>Default parameters.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-config_encoding"><a href="#val-config_encoding" class="anchor"></a><code><span><span class="keyword">val</span> config_encoding : <span><a href="#type-config">config</a> <a href="../../../octez-libs/Data_encoding/index.html#type-t">Tezos_base.TzPervasives.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-config"><code>config</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-info"><a href="#type-info" class="anchor"></a><code><span><span class="keyword">type</span> info</span></code></div><div class="spec-doc"><p>Static information needed by <a href="#val-pre_filter"><code>pre_filter</code></a>.</p><p>It depends on the <code>head</code> block upon which a mempool is built.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><a href="../../../tezos-protocol-alpha/Tezos_protocol_environment_alpha/Context/index.html#type-t">Tezos_protocol_alpha.Environment.Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.TzPervasives.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-info">info</a>, <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Create an <a href="#type-info"><code>info</code></a> based on the <code>head</code> block and the current context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : 
  <span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.TzPervasives.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-info">info</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Create a new <a href="#type-info"><code>info</code></a> based on the <code>head</code> block.</p><p>Parts of the old <a href="#type-info"><code>info</code></a> (which may have been built on a different block) are recycled, so that this function is more efficient than <a href="#val-init"><code>init</code></a> and does not need an <code>Environment.Context.t</code> argument.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-syntactic_check"><a href="#val-syntactic_check" class="anchor"></a><code><span><span class="keyword">val</span> syntactic_check : 
  <span><a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/index.html#type-packed_operation">Tezos_protocol_alpha.Protocol.Alpha_context.packed_operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[ `Well_formed <span>| `Ill_formed</span> ]</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Perform some syntactic checks on the operation.</p><p>To be used mostly as an exceptional mechanism to prevent ill-formed operations to block block application.</p><p>Should be called before the <a href="#val-pre_filter"><code>pre_filter</code></a>, does not need a context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pre_filter"><a href="#val-pre_filter" class="anchor"></a><code><span><span class="keyword">val</span> pre_filter : 
  <span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-config">config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/index.html#type-packed_operation">Tezos_protocol_alpha.Protocol.Alpha_context.packed_operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[ <span>`Passed_prefilter of <span>[ `High <span>| `Medium</span> <span><span>| `Low</span> of <span><span class="xref-unresolved">Q</span>.t list</span></span> ]</span></span>
  <span><span>| `Branch_delayed</span> of <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span>
  <span><span>| `Branch_refused</span> of <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span>
  <span><span>| `Refused</span> of <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span>
  <span><span>| `Outdated</span> of <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span> ]</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Perform some preliminary checks on an operation.</p><p>For manager operations, check that its fee, fee/gas ratio, and fee/size ratio all meet the minimal requirements specified in the <a href="#type-config"><code>config</code></a>.</p><p>For consensus operations, check that it is possible for the operation to have been produced before now (plus additional time equal to the <code>clock_drift</code> from <a href="#type-config"><code>config</code></a>, as a safety margin). Indeed, without this check, a baker could flood the network with consensus operations for any future rounds or levels. The ml file contains more detailled explanations with diagrams.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-conflict_handler"><a href="#val-conflict_handler" class="anchor"></a><code><span><span class="keyword">val</span> conflict_handler : 
  <span><a href="#type-config">config</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Main/Mempool/index.html#type-conflict_handler">Tezos_protocol_alpha.Protocol.Mempool.conflict_handler</a></span></code></div><div class="spec-doc"><p>Return a conflict handler for <code>Protocol.Mempool.add_operation</code> (see <code>Protocol.Mempool.conflict_handler</code>).</p><p>For non-manager operations, select the greater operation according to <code>Protocol.Alpha_context.Operation.compare</code>.</p><p>A manager operation is replaced only when the new operation's fee and fee/gas ratio both exceed (or match) the old operation's metrics multiplied by the <code>replace_by_fee</code> factor specified in the <a href="#type-config"><code>config</code></a>.</p><p>Precondition: both operations must be individually valid (to be able to call <code>Protocol.Alpha_context.Operation.compare</code>).</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Conflict_map"><a href="#module-Conflict_map" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Conflict_map/index.html">Conflict_map</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The purpose of this module is to provide the <code>fee_needed_to_replace_by_fee</code> function. For this function to be correct, the caller must maintain the state of type <code>t</code> by calling <code>update</code> on each successfully validated operation and its induced replacements.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fee_needed_to_overtake"><a href="#val-fee_needed_to_overtake" class="anchor"></a><code><span><span class="keyword">val</span> fee_needed_to_overtake : 
  <span><span class="label">op_to_overtake</span>:<a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/index.html#type-packed_operation">Tezos_protocol_alpha.Protocol.Alpha_context.packed_operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">candidate_op</span>:<a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/index.html#type-packed_operation">Tezos_protocol_alpha.Protocol.Alpha_context.packed_operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int64 option</span></span></code></div><div class="spec-doc"><p>Compute the minimal fee (expressed in mutez) that <code>candidate_op</code> would need to have in order to be strictly greater than <code>op_to_overtake</code> according to <code>Protocol.Alpha_context.Operation.compare</code>, when both operations are manager operations.</p><p>Return <code>None</code> when at least one operation is not a manager operation.</p><p>Also return <code>None</code> if both operations are manager operations but there was an error while computing the needed fee. However, note that this cannot happen when both manager operations have been successfully validated by the protocol.</p></div></div><p>The following type, encoding, and default values are exported for <code>bin_sc_rollup_node/configuration.ml</code>.</p><div class="odoc-spec"><div class="spec type anchored" id="type-nanotez"><a href="#type-nanotez" class="anchor"></a><code><span><span class="keyword">type</span> nanotez</span><span> = <span class="xref-unresolved">Q</span>.t</span></code></div><div class="spec-doc"><p>An amount of fees in nanotez.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-nanotez_enc"><a href="#val-nanotez_enc" class="anchor"></a><code><span><span class="keyword">val</span> nanotez_enc : <span><a href="#type-nanotez">nanotez</a> <a href="../../../octez-libs/Data_encoding/index.html#type-t">Tezos_base.TzPervasives.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-nanotez"><code>nanotez</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_minimal_fees"><a href="#val-default_minimal_fees" class="anchor"></a><code><span><span class="keyword">val</span> default_minimal_fees : <a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/Tez/index.html#type-t">Tezos_protocol_alpha.Protocol.Alpha_context.Tez.t</a></span></code></div><div class="spec-doc"><p>Minimal absolute fees in <a href="#val-default_config"><code>default_config</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_minimal_nanotez_per_gas_unit"><a href="#val-default_minimal_nanotez_per_gas_unit" class="anchor"></a><code><span><span class="keyword">val</span> default_minimal_nanotez_per_gas_unit : <a href="#type-nanotez">nanotez</a></span></code></div><div class="spec-doc"><p>Minimal fee over gas_limit ratio in <a href="#val-default_config"><code>default_config</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_minimal_nanotez_per_byte"><a href="#val-default_minimal_nanotez_per_byte" class="anchor"></a><code><span><span class="keyword">val</span> default_minimal_nanotez_per_byte : <a href="#type-nanotez">nanotez</a></span></code></div><div class="spec-doc"><p>Minimal fee over byte size ratio in <a href="#val-default_config"><code>default_config</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ctxt"><a href="#type-ctxt" class="anchor"></a><code><span><span class="keyword">type</span> ctxt</span></code></div><div class="spec-doc"><p>Protocol context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_context"><a href="#val-get_context" class="anchor"></a><code><span><span class="keyword">val</span> get_context : 
  <span><a href="../../../tezos-protocol-alpha/Tezos_protocol_environment_alpha/Context/index.html#type-t">Tezos_protocol_alpha.Environment.Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.TzPervasives.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-ctxt">ctxt</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Return the protocol context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sources_from_operation"><a href="#val-sources_from_operation" class="anchor"></a><code><span><span class="keyword">val</span> sources_from_operation : 
  <span><a href="#type-ctxt">ctxt</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/index.html#type-packed_operation">Tezos_protocol_alpha.Protocol.Alpha_context.packed_operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../octez-libs/Tezos_crypto/Signature/index.html#type-public_key_hash">Tezos_base.TzPervasives.Signature.public_key_hash</a> list</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Return the sources from the operation</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
