<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Liquidity_baking_machine (octez-protocol-alpha-libs.Tezos_alpha_test_helpers.Liquidity_baking_machine)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">octez-protocol-alpha-libs</a> &#x00BB; <a href="../index.html">Tezos_alpha_test_helpers</a> &#x00BB; Liquidity_baking_machine</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_alpha_test_helpers.Liquidity_baking_machine</span></code></h1><p>This module provides the means to test extensively the Liquidity Baking (LB) feature. We recall that this feature is built upon three smart contracts: (1) a CPMM contract initially based on Dexter 2, and (2) two tokens contracts. Our objective is to run “scenarios” consisting in interleaved, realistic calls to these contracts, and to assert these scenarios do not yield any undesirable behaviors.</p><p>To that end, three “machines” are provided.</p><ul><li>The <a href="SymbolicMachine/index.html"><code>SymbolicMachine</code></a> allows to simulate scenarios involving the LB feature completely off-chain. It can be seen as an abstraction of the concrete implementation provided by the Tezos node.</li><li>The <a href="ConcreteMachine/index.html"><code>ConcreteMachine</code></a> allows to execute scenarios on-chain.</li><li>The <a href="ValidationMachine/index.html"><code>ValidationMachine</code></a> combines the two previously mentioned machines. In other words, the <a href="ValidationMachine/index.html"><code>ValidationMachine</code></a> makes the <code>
SymbolicMachine</code> and the <code>ConcreteMachine</code> execute the same scenarios, and asserts they remain synchronized after each baked block.</li></ul><p>The <a href="ValidationMachine/index.html"><code>ValidationMachine</code></a> allows to (1) validate the <code>
SymbolicMachine</code> (<i>i.e.,</i> the reimplementation of the LB contracts logic) against the real implementation provided by Tezos, <b>and</b> the contracts originated by the protocol correctly implement the LB logic, as implemented by the <a href="SymbolicMachine/index.html"><code>SymbolicMachine</code></a>. That is, the <a href="ValidationMachine/index.html"><code>ValidationMachine</code></a> reports desynchronization of the two machines, but cannot explain this desynchronization.</p></header><nav class="odoc-toc"><ul><li><a href="#machine-state-characterization">Machine State Characterization</a></li><li><a href="#the-symbolic-machine">The Symbolic Machine</a></li></ul></nav><div class="odoc-content"><h2 id="machine-state-characterization"><a href="#machine-state-characterization" class="anchor"></a>Machine State Characterization</h2><div class="odoc-spec"><div class="spec type anchored" id="type-xtz"><a href="#type-xtz" class="anchor"></a><code><span><span class="keyword">type</span> xtz</span><span> = int64</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-tzbtc"><a href="#type-tzbtc" class="anchor"></a><code><span><span class="keyword">type</span> tzbtc</span><span> = int</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-liquidity"><a href="#type-liquidity" class="anchor"></a><code><span><span class="keyword">type</span> liquidity</span><span> = int</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-balances"><a href="#type-balances" class="anchor"></a><code><span><span class="keyword">type</span> balances</span><span> = </span><span>{</span></code><ol><li id="type-balances.xtz" class="def record field anchored"><a href="#type-balances.xtz" class="anchor"></a><code><span>xtz : <a href="#type-xtz">xtz</a>;</span></code></li><li id="type-balances.tzbtc" class="def record field anchored"><a href="#type-balances.tzbtc" class="anchor"></a><code><span>tzbtc : <a href="#type-tzbtc">tzbtc</a>;</span></code></li><li id="type-balances.liquidity" class="def record field anchored"><a href="#type-balances.liquidity" class="anchor"></a><code><span>liquidity : <a href="#type-liquidity">liquidity</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>As far as liquidity baking is concerned, an account can hold three kinds of tokens: <code>xtz</code>, <code>tzbtc</code>, and <code>liquidity</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_balances"><a href="#val-pp_balances" class="anchor"></a><code><span><span class="keyword">val</span> pp_balances : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-balances">balances</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-specs"><a href="#type-specs" class="anchor"></a><code><span><span class="keyword">type</span> specs</span><span> = </span><span>{</span></code><ol><li id="type-specs.cpmm_min_xtz_balance" class="def record field anchored"><a href="#type-specs.cpmm_min_xtz_balance" class="anchor"></a><code><span>cpmm_min_xtz_balance : <a href="#type-xtz">xtz</a>;</span></code></li><li id="type-specs.cpmm_min_tzbtc_balance" class="def record field anchored"><a href="#type-specs.cpmm_min_tzbtc_balance" class="anchor"></a><code><span>cpmm_min_tzbtc_balance : <a href="#type-tzbtc">tzbtc</a>;</span></code></li><li id="type-specs.accounts_balances" class="def record field anchored"><a href="#type-specs.accounts_balances" class="anchor"></a><code><span>accounts_balances : <span><a href="#type-balances">balances</a> list</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A value of type <code>specs</code> allows to specify an initial state of a “machine”.</p><p>In a nutshell, it consists in specifying the minimal balances of the CPMM contracts and a set of implicit contracts. The two machines provided by this module has a <code>build</code> function which turns a <code>specs</code> into a consistent initial state for this machine.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_specs"><a href="#val-pp_specs" class="anchor"></a><code><span><span class="keyword">val</span> pp_specs : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-specs">specs</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-env"><a href="#type-env" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a env</span></span><span> = <span class="keyword">private</span> </span><span>{</span></code><ol><li id="type-env.cpmm_contract" class="def record field anchored"><a href="#type-env.cpmm_contract" class="anchor"></a><code><span>cpmm_contract : <span class="type-var">'a</span>;</span></code></li><li id="type-env.tzbtc_contract" class="def record field anchored"><a href="#type-env.tzbtc_contract" class="anchor"></a><code><span>tzbtc_contract : <span class="type-var">'a</span>;</span></code></li><li id="type-env.tzbtc_admin" class="def record field anchored"><a href="#type-env.tzbtc_admin" class="anchor"></a><code><span>tzbtc_admin : <span class="type-var">'a</span>;</span></code></li><li id="type-env.liquidity_contract" class="def record field anchored"><a href="#type-env.liquidity_contract" class="anchor"></a><code><span>liquidity_contract : <span class="type-var">'a</span>;</span></code></li><li id="type-env.liquidity_admin" class="def record field anchored"><a href="#type-env.liquidity_admin" class="anchor"></a><code><span>liquidity_admin : <span class="type-var">'a</span>;</span></code></li><li id="type-env.implicit_accounts" class="def record field anchored"><a href="#type-env.implicit_accounts" class="anchor"></a><code><span>implicit_accounts : <span><span class="type-var">'a</span> list</span>;</span></code></li><li id="type-env.holder" class="def record field anchored"><a href="#type-env.holder" class="anchor"></a><code><span>holder : <span class="type-var">'a</span>;</span></code></li><li id="type-env.subsidy" class="def record field anchored"><a href="#type-env.subsidy" class="anchor"></a><code><span>subsidy : <a href="#type-xtz">xtz</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A value of type <code>'a env</code> (where <code>'a</code> is the type of contract identifiers) summarizes the different contracts involved in the LB feature.</p><p>Values of type <code>env</code> are constructed by the <code>build</code> function of the machines.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-step"><a href="#type-step" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a step</span></span><span> = </span></code><ol><li id="type-step.SellTzBTC" class="def variant constructor anchored"><a href="#type-step.SellTzBTC" class="anchor"></a><code><span>| </span><span><span class="constructor">SellTzBTC</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-step.source" class="def record field anchored"><a href="#type-step.source" class="anchor"></a><code><span>source : <span class="type-var">'a</span>;</span></code></li><li id="type-step.destination" class="def record field anchored"><a href="#type-step.destination" class="anchor"></a><code><span>destination : <span class="type-var">'a</span>;</span></code></li><li id="type-step.tzbtc_deposit" class="def record field anchored"><a href="#type-step.tzbtc_deposit" class="anchor"></a><code><span>tzbtc_deposit : <a href="#type-tzbtc">tzbtc</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-step.BuyTzBTC" class="def variant constructor anchored"><a href="#type-step.BuyTzBTC" class="anchor"></a><code><span>| </span><span><span class="constructor">BuyTzBTC</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-step.source" class="def record field anchored"><a href="#type-step.source" class="anchor"></a><code><span>source : <span class="type-var">'a</span>;</span></code></li><li id="type-step.destination" class="def record field anchored"><a href="#type-step.destination" class="anchor"></a><code><span>destination : <span class="type-var">'a</span>;</span></code></li><li id="type-step.xtz_deposit" class="def record field anchored"><a href="#type-step.xtz_deposit" class="anchor"></a><code><span>xtz_deposit : <a href="#type-xtz">xtz</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-step.AddLiquidity" class="def variant constructor anchored"><a href="#type-step.AddLiquidity" class="anchor"></a><code><span>| </span><span><span class="constructor">AddLiquidity</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-step.source" class="def record field anchored"><a href="#type-step.source" class="anchor"></a><code><span>source : <span class="type-var">'a</span>;</span></code></li><li id="type-step.destination" class="def record field anchored"><a href="#type-step.destination" class="anchor"></a><code><span>destination : <span class="type-var">'a</span>;</span></code></li><li id="type-step.xtz_deposit" class="def record field anchored"><a href="#type-step.xtz_deposit" class="anchor"></a><code><span>xtz_deposit : <a href="#type-xtz">xtz</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-step.RemoveLiquidity" class="def variant constructor anchored"><a href="#type-step.RemoveLiquidity" class="anchor"></a><code><span>| </span><span><span class="constructor">RemoveLiquidity</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-step.source" class="def record field anchored"><a href="#type-step.source" class="anchor"></a><code><span>source : <span class="type-var">'a</span>;</span></code></li><li id="type-step.destination" class="def record field anchored"><a href="#type-step.destination" class="anchor"></a><code><span>destination : <span class="type-var">'a</span>;</span></code></li><li id="type-step.lqt_burned" class="def record field anchored"><a href="#type-step.lqt_burned" class="anchor"></a><code><span>lqt_burned : <a href="#type-liquidity">liquidity</a>;</span></code></li></ol><code><span>}</span></code></li></ol></div><div class="spec-doc"><p>A value of type <code>'a step</code> (where <code>'a</code> is the type used to identify contracts) describes a consistent sequence of LB smart contract calls.</p><p>For instance, <code>SellTzBTC</code> consists in approving an allowance in the <code>TzBTC</code> contract, then calling the <code>token_to_xtz</code> entry point of the <code>CPMM</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_step"><a href="#val-pp_step" class="anchor"></a><code><span><span class="keyword">val</span> pp_step : 
  <span><span>(<span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-step">step</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-state"><a href="#type-state" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a state</span></span><span> = </span><span>{</span></code><ol><li id="type-state.cpmm_total_liquidity" class="def record field anchored"><a href="#type-state.cpmm_total_liquidity" class="anchor"></a><code><span>cpmm_total_liquidity : <a href="#type-liquidity">liquidity</a>;</span></code></li><li id="type-state.accounts_balances" class="def record field anchored"><a href="#type-state.accounts_balances" class="anchor"></a><code><span>accounts_balances : <span><span>(<span class="type-var">'a</span> * <a href="#type-balances">balances</a>)</span> list</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A summary of the state of a machine, parameterized by the type of contract identifier.</p></div></div><h2 id="the-symbolic-machine"><a href="#the-symbolic-machine" class="anchor"></a>The Symbolic Machine</h2><div class="odoc-spec"><div class="spec type anchored" id="type-contract_id"><a href="#type-contract_id" class="anchor"></a><code><span><span class="keyword">type</span> contract_id</span><span> = </span></code><ol><li id="type-contract_id.Cpmm" class="def variant constructor anchored"><a href="#type-contract_id.Cpmm" class="anchor"></a><code><span>| </span><span><span class="constructor">Cpmm</span></span></code></li><li id="type-contract_id.Holder" class="def variant constructor anchored"><a href="#type-contract_id.Holder" class="anchor"></a><code><span>| </span><span><span class="constructor">Holder</span></span></code></li><li id="type-contract_id.TzBTC" class="def variant constructor anchored"><a href="#type-contract_id.TzBTC" class="anchor"></a><code><span>| </span><span><span class="constructor">TzBTC</span></span></code></li><li id="type-contract_id.TzBTCAdmin" class="def variant constructor anchored"><a href="#type-contract_id.TzBTCAdmin" class="anchor"></a><code><span>| </span><span><span class="constructor">TzBTCAdmin</span></span></code></li><li id="type-contract_id.Liquidity" class="def variant constructor anchored"><a href="#type-contract_id.Liquidity" class="anchor"></a><code><span>| </span><span><span class="constructor">Liquidity</span></span></code></li><li id="type-contract_id.LiquidityAdmin" class="def variant constructor anchored"><a href="#type-contract_id.LiquidityAdmin" class="anchor"></a><code><span>| </span><span><span class="constructor">LiquidityAdmin</span></span></code></li><li id="type-contract_id.ImplicitAccount" class="def variant constructor anchored"><a href="#type-contract_id.ImplicitAccount" class="anchor"></a><code><span>| </span><span><span class="constructor">ImplicitAccount</span> <span class="keyword">of</span> int</span></code></li></ol></div><div class="spec-doc"><p>In the <a href="SymbolicMachine/index.html"><code>SymbolicMachine</code></a>, a contract is identified by a symbolic value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_contract_id"><a href="#val-pp_contract_id" class="anchor"></a><code><span><span class="keyword">val</span> pp_contract_id : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-contract_id">contract_id</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-SymbolicMachine"><a href="#module-SymbolicMachine" class="anchor"></a><code><span><span class="keyword">module</span> <a href="SymbolicMachine/index.html">SymbolicMachine</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-ConcreteMachine"><a href="#module-ConcreteMachine" class="anchor"></a><code><span><span class="keyword">module</span> <a href="ConcreteMachine/index.html">ConcreteMachine</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>A machine that can execute scenarios onchain.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-ValidationMachine"><a href="#module-ValidationMachine" class="anchor"></a><code><span><span class="keyword">module</span> <a href="ValidationMachine/index.html">ValidationMachine</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
