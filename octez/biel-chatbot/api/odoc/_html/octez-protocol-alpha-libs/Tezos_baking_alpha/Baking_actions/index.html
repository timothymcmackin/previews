<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Baking_actions (octez-protocol-alpha-libs.Tezos_baking_alpha.Baking_actions)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-protocol-alpha-libs</a> &#x00BB; <a href="../index.html">Tezos_baking_alpha</a> &#x00BB; Baking_actions</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_baking_alpha.Baking_actions</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#action-types">Action types</a></li><li><a href="#functions-used-by-the-baker">Functions used by the baker</a></li><li><a href="#functions-only-needed-for-the-baking_lib">Functions only needed for the baking_lib</a></li></ul></nav><div class="odoc-content"><h3 id="action-types"><a href="#action-types" class="anchor"></a>Action types</h3><div class="odoc-spec"><div class="spec type anchored" id="type-action"><a href="#type-action" class="anchor"></a><code><span><span class="keyword">type</span> action</span><span> = </span></code><ol><li id="type-action.Do_nothing" class="def variant constructor anchored"><a href="#type-action.Do_nothing" class="anchor"></a><code><span>| </span><span><span class="constructor">Do_nothing</span></span></code></li><li id="type-action.Prepare_block" class="def variant constructor anchored"><a href="#type-action.Prepare_block" class="anchor"></a><code><span>| </span><span><span class="constructor">Prepare_block</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-action.block_to_bake" class="def record field anchored"><a href="#type-action.block_to_bake" class="anchor"></a><code><span>block_to_bake : <a href="../Baking_state/index.html#type-block_to_bake">Baking_state.block_to_bake</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-action.Prepare_preattestations" class="def variant constructor anchored"><a href="#type-action.Prepare_preattestations" class="anchor"></a><code><span>| </span><span><span class="constructor">Prepare_preattestations</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-action.preattestations" class="def record field anchored"><a href="#type-action.preattestations" class="anchor"></a><code><span>preattestations : <a href="../Baking_state/index.html#type-unsigned_consensus_vote_batch">Baking_state.unsigned_consensus_vote_batch</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-action.Prepare_attestations" class="def variant constructor anchored"><a href="#type-action.Prepare_attestations" class="anchor"></a><code><span>| </span><span><span class="constructor">Prepare_attestations</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-action.attestations" class="def record field anchored"><a href="#type-action.attestations" class="anchor"></a><code><span>attestations : <a href="../Baking_state/index.html#type-unsigned_consensus_vote_batch">Baking_state.unsigned_consensus_vote_batch</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-action.Prepare_consensus_votes" class="def variant constructor anchored"><a href="#type-action.Prepare_consensus_votes" class="anchor"></a><code><span>| </span><span><span class="constructor">Prepare_consensus_votes</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-action.preattestations" class="def record field anchored"><a href="#type-action.preattestations" class="anchor"></a><code><span>preattestations : <a href="../Baking_state/index.html#type-unsigned_consensus_vote_batch">Baking_state.unsigned_consensus_vote_batch</a>;</span></code></li><li id="type-action.attestations" class="def record field anchored"><a href="#type-action.attestations" class="anchor"></a><code><span>attestations : <a href="../Baking_state/index.html#type-unsigned_consensus_vote_batch">Baking_state.unsigned_consensus_vote_batch</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-action.Inject_block" class="def variant constructor anchored"><a href="#type-action.Inject_block" class="anchor"></a><code><span>| </span><span><span class="constructor">Inject_block</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-action.prepared_block" class="def record field anchored"><a href="#type-action.prepared_block" class="anchor"></a><code><span>prepared_block : <a href="../Baking_state/index.html#type-prepared_block">Baking_state.prepared_block</a>;</span></code></li><li id="type-action.force_injection" class="def record field anchored"><a href="#type-action.force_injection" class="anchor"></a><code><span>force_injection : bool;</span></code></li><li id="type-action.asynchronous" class="def record field anchored"><a href="#type-action.asynchronous" class="anchor"></a><code><span>asynchronous : bool;</span></code></li></ol><code><span>}</span></code></li><li id="type-action.Inject_preattestation" class="def variant constructor anchored"><a href="#type-action.Inject_preattestation" class="anchor"></a><code><span>| </span><span><span class="constructor">Inject_preattestation</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-action.signed_preattestation" class="def record field anchored"><a href="#type-action.signed_preattestation" class="anchor"></a><code><span>signed_preattestation : <a href="../Baking_state/index.html#type-signed_consensus_vote">Baking_state.signed_consensus_vote</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-action.Inject_attestations" class="def variant constructor anchored"><a href="#type-action.Inject_attestations" class="anchor"></a><code><span>| </span><span><span class="constructor">Inject_attestations</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-action.signed_attestations" class="def record field anchored"><a href="#type-action.signed_attestations" class="anchor"></a><code><span>signed_attestations : <a href="../Baking_state/index.html#type-signed_consensus_vote_batch">Baking_state.signed_consensus_vote_batch</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-action.Update_to_level" class="def variant constructor anchored"><a href="#type-action.Update_to_level" class="anchor"></a><code><span>| </span><span><span class="constructor">Update_to_level</span> <span class="keyword">of</span> <a href="#type-level_update">level_update</a></span></code></li><li id="type-action.Synchronize_round" class="def variant constructor anchored"><a href="#type-action.Synchronize_round" class="anchor"></a><code><span>| </span><span><span class="constructor">Synchronize_round</span> <span class="keyword">of</span> <a href="#type-round_update">round_update</a></span></code></li><li id="type-action.Watch_prequorum" class="def variant constructor anchored"><a href="#type-action.Watch_prequorum" class="anchor"></a><code><span>| </span><span><span class="constructor">Watch_prequorum</span></span></code></li><li id="type-action.Watch_quorum" class="def variant constructor anchored"><a href="#type-action.Watch_quorum" class="anchor"></a><code><span>| </span><span><span class="constructor">Watch_quorum</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-level_update"><a href="#type-level_update" class="anchor"></a><code><span><span class="keyword">and</span> level_update</span><span> = </span><span>{</span></code><ol><li id="type-level_update.new_level_proposal" class="def record field anchored"><a href="#type-level_update.new_level_proposal" class="anchor"></a><code><span>new_level_proposal : <a href="../Baking_state/index.html#type-proposal">Baking_state.proposal</a>;</span></code></li><li id="type-level_update.compute_new_state" class="def record field anchored"><a href="#type-level_update.compute_new_state" class="anchor"></a><code><span>compute_new_state : <span><span class="label">current_round</span>:
                      <a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/Round/index.html#type-t">Tezos_protocol_alpha.Protocol.Alpha_context.Round.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">delegate_slots</span>:<a href="../Baking_state/index.html#type-delegate_slots">Baking_state.delegate_slots</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">next_level_delegate_slots</span>:<a href="../Baking_state/index.html#type-delegate_slots">Baking_state.delegate_slots</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dal_attestable_slots</span>:<a href="../Baking_state/index.html#type-dal_attestable_slots">Baking_state.dal_attestable_slots</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">next_level_dal_attestable_slots</span>:<a href="../Baking_state/index.html#type-dal_attestable_slots">Baking_state.dal_attestable_slots</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Baking_state/index.html#type-state">Baking_state.state</a> * <a href="#type-action">action</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-round_update"><a href="#type-round_update" class="anchor"></a><code><span><span class="keyword">and</span> round_update</span><span> = </span><span>{</span></code><ol><li id="type-round_update.new_round_proposal" class="def record field anchored"><a href="#type-round_update.new_round_proposal" class="anchor"></a><code><span>new_round_proposal : <a href="../Baking_state/index.html#type-proposal">Baking_state.proposal</a>;</span></code></li><li id="type-round_update.handle_proposal" class="def record field anchored"><a href="#type-round_update.handle_proposal" class="anchor"></a><code><span>handle_proposal : <span><a href="../Baking_state/index.html#type-state">Baking_state.state</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../Baking_state/index.html#type-state">Baking_state.state</a> * <a href="#type-action">action</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="#type-action">action</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_action"><a href="#val-pp_action" class="anchor"></a><code><span><span class="keyword">val</span> pp_action : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-action">action</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><h3 id="functions-used-by-the-baker"><a href="#functions-used-by-the-baker" class="anchor"></a>Functions used by the baker</h3><div class="odoc-spec"><div class="spec value anchored" id="val-prepare_block"><a href="#val-prepare_block" class="anchor"></a><code><span><span class="keyword">val</span> prepare_block : 
  <span><a href="../Baking_state/index.html#type-global_state">Baking_state.global_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Baking_state/index.html#type-block_to_bake">Baking_state.block_to_bake</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Baking_state/index.html#type-prepared_block">Baking_state.prepared_block</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>prepare_block global_state block_to_bake</code> prepares a block by:</p><ul><li>inferring the block timestamp</li></ul><ul><li>recovering the operations from the mempool if the block is a new proposal, or reusing the operations from <code>block_to_bake</code>'s payload if the block is a reproposal</li></ul><ul><li>generating the seed nonce hash if needed</li></ul><ul><li>setting the votes for liquidity baking and adaptive issuance according to the per_block_vote_file</li></ul><ul><li>calling <code>Block_forge.forge</code> to forge the block</li></ul><ul><li>signing the block header</li></ul><ul><li>registering the seed nonce if needed</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-authorized_consensus_votes"><a href="#val-authorized_consensus_votes" class="anchor"></a><code><span><span class="keyword">val</span> authorized_consensus_votes : 
  <span><a href="../Baking_state/index.html#type-global_state">Baking_state.global_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Baking_state/index.html#type-unsigned_consensus_vote_batch">Baking_state.unsigned_consensus_vote_batch</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../Baking_state/index.html#type-unsigned_consensus_vote">Baking_state.unsigned_consensus_vote</a> list</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>authorized_consensus_votes global_state unsigned_consensus_vote_batch</code> records and returns the list of unsigned_consensus_vote authorized according to the <code>Baking_highwatermarks</code>. This function emits an event for each unauthorized consensus vote.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-forge_and_sign_consensus_vote"><a href="#val-forge_and_sign_consensus_vote" class="anchor"></a><code><span><span class="keyword">val</span> forge_and_sign_consensus_vote : 
  <span><a href="../Baking_state/index.html#type-global_state">Baking_state.global_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">branch</span>:<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Baking_state/index.html#type-unsigned_consensus_vote">Baking_state.unsigned_consensus_vote</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Baking_state/index.html#type-signed_consensus_vote">Baking_state.signed_consensus_vote</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>forge_and_sign_consensus_vote global_state branch unsigned_consensus_vote</code> forges a consensus operation by encoding the operation consensus content from <code>unsigned_consensus_vote</code> with the <code>branch</code> and then sign it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compute_round"><a href="#val-compute_round" class="anchor"></a><code><span><span class="keyword">val</span> compute_round : 
  <span><a href="../Baking_state/index.html#type-proposal">Baking_state.proposal</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/Round/index.html#type-round_durations">Tezos_protocol_alpha.Protocol.Alpha_context.Round.round_durations</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/Round/index.html#type-t">Tezos_protocol_alpha.Protocol.Alpha_context.Round.t</a>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>compute_round proposal round_durations</code> computes the round from the current timestamp, the <code>proposal</code>'s timestamp and the <code>round_durations</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-perform_action"><a href="#val-perform_action" class="anchor"></a><code><span><span class="keyword">val</span> perform_action : 
  <span><a href="../Baking_state/index.html#type-state">Baking_state.state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Baking_state/index.html#type-state">Baking_state.state</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>perform_action state action</code> performs the given <code>action</code> using the <code>state</code></p></div></div><h3 id="functions-only-needed-for-the-baking_lib"><a href="#functions-only-needed-for-the-baking_lib" class="anchor"></a>Functions only needed for the baking_lib</h3><div class="odoc-spec"><div class="spec value anchored" id="val-sign_consensus_votes"><a href="#val-sign_consensus_votes" class="anchor"></a><code><span><span class="keyword">val</span> sign_consensus_votes : 
  <span><a href="../Baking_state/index.html#type-global_state">Baking_state.global_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Baking_state/index.html#type-unsigned_consensus_vote_batch">Baking_state.unsigned_consensus_vote_batch</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Baking_state/index.html#type-signed_consensus_vote_batch">Baking_state.signed_consensus_vote_batch</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>sign_consensus_votes global_state unsigned_consensus_vote_batch</code> recovers the authorized consensus votes by calling <code>authorized_consensus_votes</code>, then signs these operation by calling <code>forge_and_sign_consensus_vote</code>, and then creates a batch with <code>Baking_state.make_signed_consensus_vote_batch</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inject_consensus_votes"><a href="#val-inject_consensus_votes" class="anchor"></a><code><span><span class="keyword">val</span> inject_consensus_votes : 
  <span><a href="../Baking_state/index.html#type-state">Baking_state.state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Baking_state/index.html#type-signed_consensus_vote_batch">Baking_state.signed_consensus_vote_batch</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>inject_consensus_votes state signed_consensus_vote_batch</code> injects consensus votes from <code>signed_consensus_vote_batch</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update_to_level"><a href="#val-update_to_level" class="anchor"></a><code><span><span class="keyword">val</span> update_to_level : 
  <span><a href="../Baking_state/index.html#type-state">Baking_state.state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-level_update">level_update</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Baking_state/index.html#type-state">Baking_state.state</a> * <a href="#type-t">t</a>)</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>update_to_level state level_update</code> computes the delegate slots for the given level and the next one, computes round information by calling <code>compute_round</code> and updates the state accordingly.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-may_get_dal_content"><a href="#val-may_get_dal_content" class="anchor"></a><code><span><span class="keyword">val</span> may_get_dal_content : 
  <span><a href="../Baking_state/index.html#type-state">Baking_state.state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Baking_state/index.html#type-unsigned_consensus_vote">Baking_state.unsigned_consensus_vote</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../../tezos-protocol-alpha/Tezos_raw_protocol_alpha/Alpha_context/index.html#type-dal_content">Tezos_protocol_alpha.Protocol.Alpha_context.dal_content</a> option</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>may_get_dal_content state unsigned_consensus_vote</code>, if the DAL feature is enabled, recovers the attestable slots by calling <code>Node_rpc.get_attestable_slots</code> and computes the corresponding <code>dal_content</code>.</p></div></div></div></body></html>
