<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Ticket_accounting (tezos-protocol-021-PsQuebec.Tezos_raw_protocol_021_PsQuebec.Ticket_accounting)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-021-PsQuebec</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_021_PsQuebec</a> &#x00BB; Ticket_accounting</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_021_PsQuebec.Ticket_accounting</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-ticket_diffs"><a href="#val-ticket_diffs" class="anchor"></a><code><span><span class="keyword">val</span> ticket_diffs : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">self_contract</span>:<a href="../Alpha_context/Contract/index.html#type-t">Alpha_context.Contract.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">arg_type_has_tickets</span>:<span><span class="type-var">'arg</span> <a href="../Ticket_scanner/index.html#type-has_tickets">Ticket_scanner.has_tickets</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">storage_type_has_tickets</span>:<span><span class="type-var">'storage</span> <a href="../Ticket_scanner/index.html#type-has_tickets">Ticket_scanner.has_tickets</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">arg</span>:<span class="type-var">'arg</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">old_storage</span>:<span class="type-var">'storage</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">new_storage</span>:<span class="type-var">'storage</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">lazy_storage_diff</span>:<span><a href="../Alpha_context/Lazy_storage/index.html#type-diffs_item">Alpha_context.Lazy_storage.diffs_item</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../../Tezos_protocol_environment_021_PsQuebec/Z/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Z.t</a> <a href="../Ticket_token_map/index.html#type-t">Ticket_token_map.t</a></span>
   * <a href="../Ticket_receipt/index.html#type-t">Ticket_receipt.t</a>
   * <a href="../Alpha_context/index.html#type-context">Alpha_context.context</a>)</span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_021_PsQuebec.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Lwt/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>ticket_diffs ctxt ~arg_type_has_tickets ~storage_type_has_tickets arg
       old_storage new_storage lazy_storage_diff</code> returns a map from ticket-tokens to balance-differences that represents the change in balance for a contract due to changes of tickets in the storage. The assumption is that before calling <code>ticket_diffs</code>, all tickets that are owned by a contract exist either in the <code>old_storage</code> or the <code>arg</code>. After execution, only tickets in <code>new_storage</code> are owned by the contract. Note that this function avoids traversing the lazy part of the storage.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ticket_balances_of_value"><a href="#val-ticket_balances_of_value" class="anchor"></a><code><span><span class="keyword">val</span> ticket_balances_of_value : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">include_lazy</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../Ticket_scanner/index.html#type-has_tickets">Ticket_scanner.has_tickets</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../../Tezos_protocol_environment_021_PsQuebec/Z/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Z.t</a> <a href="../Ticket_token_map/index.html#type-t">Ticket_token_map.t</a></span>
   * <a href="../Alpha_context/index.html#type-context">Alpha_context.context</a>)</span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_021_PsQuebec.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Lwt/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>ticket_balances_of_value ctxt ~include_lazy has_tickets value</code> scans all tickets in the given <code>value</code> using the type-witness <code>has_tickets</code> and returns a map from ticket-tokens to the amount.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update_ticket_balances"><a href="#val-update_ticket_balances" class="anchor"></a><code><span><span class="keyword">val</span> update_ticket_balances : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">self_contract</span>:<a href="../Alpha_context/Contract/index.html#type-t">Alpha_context.Contract.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ticket_diffs</span>:<span><a href="../../Tezos_protocol_environment_021_PsQuebec/Z/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Z.t</a> <a href="../Ticket_token_map/index.html#type-t">Ticket_token_map.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Script_typed_ir/index.html#type-packed_internal_operation">Script_typed_ir.packed_internal_operation</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../Tezos_protocol_environment_021_PsQuebec/Z/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Z.t</a> * <a href="../Alpha_context/index.html#type-context">Alpha_context.context</a>)</span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_021_PsQuebec.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Lwt/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>update_ticket_balances ctxt ~self_contract ~ticket_diffs operations</code> updates the ticket balances according to the <code>ticket_diffs</code> map and the set of operations. The function also returns the storage size diff resulting from updating the ticket-balance table in the context.</p><p>Invariant: this function must be called after applying the lazy-storage diffs affecting any contracts in the given operations.</p><p>The function fails in case an invalid ticket-token-balance update is detected. The <code>ticket_diffs</code> argument represents the change of ticket-tokens for the <code>self</code> contract. It also specifies a &quot;budget&quot; for outgoing ticket-tokens.</p></div></div></div></body></html>
