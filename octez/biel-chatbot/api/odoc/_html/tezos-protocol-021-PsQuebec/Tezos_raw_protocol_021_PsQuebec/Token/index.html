<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Token (tezos-protocol-021-PsQuebec.Tezos_raw_protocol_021_PsQuebec.Token)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-021-PsQuebec</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_021_PsQuebec</a> &#x00BB; Token</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_021_PsQuebec.Token</span></code></h1><p>The aim of this module is to manage operations involving tokens such as minting, transferring, and burning. Every constructor of the types <code>giver</code>, <code>container</code>, or <code>receiver</code> represents a kind of account that holds a given (or possibly infinite) amount of tokens.</p><p>Tokens can be transferred from a <code>giver</code> to a <code>receiver</code>. To uniformly handle all cases, special constructors of givers and receivers may be used. For example, the giver <code>`Minted</code> is used to express a transfer of minted tokens to a receiver, and the receiver <code>`Burned</code> is used to express the action of burning a given amount of tokens taken from a giver. Thanks to uniformity, it is easier to track transfers of tokens throughout the protocol by running <code>grep -R &quot;Token.transfer&quot; src/proto_alpha</code>.</p><p>For backward compatibility purpose, an ANTI-PATTERN is used to redistribute slashing to denunciator; this redistribution technic should not be mimicked if it can be avoided (see https://gitlab.com/tezos/tezos/-/issues/4787). The anti-pattern works as follows: The part of slashed amounts that goes to the author of the denunciation are not directly distributed to him. Tokens are transferred to a burning sink, then minted from an infinite source ( see `Double_signing_punishments, and `Sc_rollup_refutation_rewards ). Again, this is an ANTI-PATTERN that should not be mimicked.</p></header><div class="odoc-content"><p><code>container</code> is the type of token holders with finite capacity, and whose assets are contained in the context. An account may have several token holders, that can serve as sources and/or sinks. For example, an implicit account <code>d</code> serving as a delegate has a token holder for its own spendable balance, and another token holder for its frozen deposits.</p><div class="odoc-spec"><div class="spec type anchored" id="type-container"><a href="#type-container" class="anchor"></a><code><span><span class="keyword">type</span> container</span><span> = </span><span>[ </span></code><ol><li id="type-container.Contract" class="def variant constructor anchored"><a href="#type-container.Contract" class="anchor"></a><code><span>| </span><span>`Contract <span class="keyword">of</span> <a href="../Contract_repr/index.html#type-t">Contract_repr.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Implicit account's or Originated contract's spendable balance</p><span class="comment-delim">*)</span></div></li><li id="type-container.Collected_commitments" class="def variant constructor anchored"><a href="#type-container.Collected_commitments" class="anchor"></a><code><span>| </span><span>`Collected_commitments <span class="keyword">of</span> <a href="../Blinded_public_key_hash/index.html#type-t">Blinded_public_key_hash.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Pre-funded account waiting for the commited pkh and activation code to be revealed to unlock the funds</p><span class="comment-delim">*)</span></div></li><li id="type-container.Frozen_deposits" class="def variant constructor anchored"><a href="#type-container.Frozen_deposits" class="anchor"></a><code><span>| </span><span>`Frozen_deposits <span class="keyword">of</span> <a href="../Frozen_staker_repr/index.html#type-t">Frozen_staker_repr.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Frozen tokens of a staker for consensus security deposits.</p><span class="comment-delim">*)</span></div></li><li id="type-container.Unstaked_frozen_deposits" class="def variant constructor anchored"><a href="#type-container.Unstaked_frozen_deposits" class="anchor"></a><code><span>| </span><span>`Unstaked_frozen_deposits <span class="keyword">of</span> <a href="../Unstaked_frozen_staker_repr/index.html#type-t">Unstaked_frozen_staker_repr.t</a> * <a href="../Cycle_repr/index.html#type-t">Cycle_repr.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Frozen tokens of a contract that have been unstaked at the given cycle.</p><span class="comment-delim">*)</span></div></li><li id="type-container.Block_fees" class="def variant constructor anchored"><a href="#type-container.Block_fees" class="anchor"></a><code><span>| </span><span>`Block_fees</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Current block's fees collection</p><span class="comment-delim">*)</span></div></li><li id="type-container.Frozen_bonds" class="def variant constructor anchored"><a href="#type-container.Frozen_bonds" class="anchor"></a><code><span>| </span><span>`Frozen_bonds <span class="keyword">of</span> <a href="../Contract_repr/index.html#type-t">Contract_repr.t</a> * <a href="../Bond_id_repr/index.html#type-t">Bond_id_repr.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Frozen tokens of a contract for bond deposits (currently used by rollups)</p><span class="comment-delim">*)</span></div></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-infinite_source"><a href="#type-infinite_source" class="anchor"></a><code><span><span class="keyword">type</span> infinite_source</span><span> = </span><span>[ </span></code><ol><li id="type-infinite_source.Invoice" class="def variant constructor anchored"><a href="#type-infinite_source.Invoice" class="anchor"></a><code><span>| </span><span>`Invoice</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Tokens minted during a protocol upgrade, typically to fund the development of some part of the amendment.</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Bootstrap" class="def variant constructor anchored"><a href="#type-infinite_source.Bootstrap" class="anchor"></a><code><span>| </span><span>`Bootstrap</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Bootstrap accounts funding</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Initial_commitments" class="def variant constructor anchored"><a href="#type-infinite_source.Initial_commitments" class="anchor"></a><code><span>| </span><span>`Initial_commitments</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Funding of Genesis' prefunded accounts requiring an activation</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Revelation_rewards" class="def variant constructor anchored"><a href="#type-infinite_source.Revelation_rewards" class="anchor"></a><code><span>| </span><span>`Revelation_rewards</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Seed nonce revelation rewards</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Attesting_rewards" class="def variant constructor anchored"><a href="#type-infinite_source.Attesting_rewards" class="anchor"></a><code><span>| </span><span>`Attesting_rewards</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Consensus attesting rewards</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Baking_rewards" class="def variant constructor anchored"><a href="#type-infinite_source.Baking_rewards" class="anchor"></a><code><span>| </span><span>`Baking_rewards</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Consensus baking fixed rewards</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Baking_bonuses" class="def variant constructor anchored"><a href="#type-infinite_source.Baking_bonuses" class="anchor"></a><code><span>| </span><span>`Baking_bonuses</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Consensus baking variable bonus</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Minted" class="def variant constructor anchored"><a href="#type-infinite_source.Minted" class="anchor"></a><code><span>| </span><span>`Minted</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Generic source for test purpose</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Liquidity_baking_subsidies" class="def variant constructor anchored"><a href="#type-infinite_source.Liquidity_baking_subsidies" class="anchor"></a><code><span>| </span><span>`Liquidity_baking_subsidies</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Subsidy for liquidity-baking contract</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_source.Sc_rollup_refutation_rewards" class="def variant constructor anchored"><a href="#type-infinite_source.Sc_rollup_refutation_rewards" class="anchor"></a><code><span>| </span><span>`Sc_rollup_refutation_rewards</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Sc_rollup refutation rewards (slashing redistribution)</p><span class="comment-delim">*)</span></div></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p><code>infinite_source</code> defines types of tokens providers which are considered to be ** of infinite capacity.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-giver"><a href="#type-giver" class="anchor"></a><code><span><span class="keyword">type</span> giver</span><span> = </span><span>[ </span></code><ol><li id="type-giver.infinite_source" class="def variant type anchored"><a href="#type-giver.infinite_source" class="anchor"></a><code><span>| </span><span><a href="#type-infinite_source">infinite_source</a></span></code></li><li id="type-giver.container" class="def variant type anchored"><a href="#type-giver.container" class="anchor"></a><code><span>| </span><span><a href="#type-container">container</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p><code>giver</code> is the type of token providers. Token providers that are not containers are considered to have infinite capacity.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-infinite_sink"><a href="#type-infinite_sink" class="anchor"></a><code><span><span class="keyword">type</span> infinite_sink</span><span> = </span><span>[ </span></code><ol><li id="type-infinite_sink.Storage_fees" class="def variant constructor anchored"><a href="#type-infinite_sink.Storage_fees" class="anchor"></a><code><span>| </span><span>`Storage_fees</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Fees burnt to compensate storage usage</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_sink.Double_signing_punishments" class="def variant constructor anchored"><a href="#type-infinite_sink.Double_signing_punishments" class="anchor"></a><code><span>| </span><span>`Double_signing_punishments</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Consensus slashing</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_sink.Lost_attesting_rewards" class="def variant constructor anchored"><a href="#type-infinite_sink.Lost_attesting_rewards" class="anchor"></a><code><span>| </span><span>`Lost_attesting_rewards <span class="keyword">of</span>
  <a href="../../Tezos_protocol_environment_021_PsQuebec/Signature/Public_key_hash/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Signature.Public_key_hash.t</a>
  * bool
  * bool</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Consensus rewards not distributed because the participation of the delegate was too low.</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_sink.Sc_rollup_refutation_punishments" class="def variant constructor anchored"><a href="#type-infinite_sink.Sc_rollup_refutation_punishments" class="anchor"></a><code><span>| </span><span>`Sc_rollup_refutation_punishments</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Smart rollups refutation slashing</p><span class="comment-delim">*)</span></div></li><li id="type-infinite_sink.Burned" class="def variant constructor anchored"><a href="#type-infinite_sink.Burned" class="anchor"></a><code><span>| </span><span>`Burned</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Generic sink mainly for test purpose</p><span class="comment-delim">*)</span></div></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-receiver"><a href="#type-receiver" class="anchor"></a><code><span><span class="keyword">type</span> receiver</span><span> = </span><span>[ </span></code><ol><li id="type-receiver.infinite_sink" class="def variant type anchored"><a href="#type-receiver.infinite_sink" class="anchor"></a><code><span>| </span><span><a href="#type-infinite_sink">infinite_sink</a></span></code></li><li id="type-receiver.container" class="def variant type anchored"><a href="#type-receiver.container" class="anchor"></a><code><span>| </span><span><a href="#type-container">container</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p><code>receiver</code> is the type of token receivers. Token receivers that are not containers are considered to have infinite capacity.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-balance"><a href="#val-balance" class="anchor"></a><code><span><span class="keyword">val</span> balance : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&lt; `Block_fees <span><span>| `Collected_commitments</span> of <a href="../Blinded_public_key_hash/index.html#type-t">Blinded_public_key_hash.t</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Tez_repr/index.html#type-t">Tez_repr.t</a>)</span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_021_PsQuebec.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Lwt/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>balance ctxt container</code> returns a new context because of an access to carbonated data, and the balance associated to the token holder. This function may fail if <code>allocated ctxt container</code> returns <code>false</code>. Returns an error with the message &quot;get_balance&quot; if <code>container</code> refers to an originated contract that is not allocated.</p><p>This function is only defined on the few cases for which it is actually needed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transfer_n"><a href="#val-transfer_n" class="anchor"></a><code><span><span class="keyword">val</span> transfer_n : 
  <span><span class="optlabel">?origin</span>:<a href="../Receipt_repr/index.html#type-update_origin">Receipt_repr.update_origin</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span>[&lt; <a href="#type-giver">giver</a> ]</span> * <a href="../Tez_repr/index.html#type-t">Tez_repr.t</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&lt; <a href="#type-receiver">receiver</a> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Receipt_repr/index.html#type-balance_updates">Receipt_repr.balance_updates</a>)</span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_021_PsQuebec.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Lwt/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>transfer_n ?origin ctxt givers receiver</code> transfers <code>amount</code> Tez from <code>giver</code> to <code>receiver</code> for each <code>(giver, amount)</code> pair in <code>givers</code>, and returns a new context, and the list of corresponding balance updates. The function behaves as though <code>transfer ?origin ctxt giver receiver amount</code> was invoked for each pair <code>(giver, amount)</code> in <code>givers</code>, however a single balance update is generated for the total amount transferred to <code>receiver</code>. When <code>givers</code> is an empty list, the function does nothing to the context, and returns an empty list of balance updates.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-transfer"><a href="#val-transfer" class="anchor"></a><code><span><span class="keyword">val</span> transfer : 
  <span><span class="optlabel">?origin</span>:<a href="../Receipt_repr/index.html#type-update_origin">Receipt_repr.update_origin</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&lt; <a href="#type-giver">giver</a> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[&lt; <a href="#type-receiver">receiver</a> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tez_repr/index.html#type-t">Tez_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Receipt_repr/index.html#type-balance_updates">Receipt_repr.balance_updates</a>)</span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_021_PsQuebec.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_021_PsQuebec/Lwt/index.html#type-t">Tezos_protocol_environment_021_PsQuebec.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>transfer ?origin ctxt giver receiver amount</code> transfers <code>amount</code> Tez from giver <code>giver</code> to receiver <code>receiver</code>, and returns a new context, and the list of corresponding balance updates tagged with <code>origin</code>. By default, <code>~origin</code> is set to <code>Receipt_repr.Block_application</code>. Returns <code>Storage_ErrorMissing_key</code> if <code>giver</code> refers to a contract that is not allocated. Returns a <code>Balance_too_low</code> error if <code>giver</code> refers to a contract whose balance is less than <code>amount</code>. Returns a <code>Subtraction_underflow</code> error if <code>giver</code> is not a contract and its balance is less than <code>amount</code>. Returns a <code>Empty_implicit_delegated_contract</code> error if <code>giver</code> is an implicit contract that delegates to a different contract, and whose balance is equal to <code>amount</code>. Returns a <code>Non_existing_contract</code> error if <code>receiver</code> refers to an originated contract that is not allocated. Returns a <code>Non_existing_contract</code> error if <code>amount &lt;&gt; Tez_repr.zero</code>, and <code>receiver</code> refers to an originated contract that is not allocated. Returns a <code>Addition_overflow</code> error if <code>receiver</code> refers to a receiver whose balance is greater than <code>Int64.max - amount</code>. Returns a <code>Wrong_level</code> error if <code>src</code> or <code>receiver</code> refer to a level that is not the current level.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
