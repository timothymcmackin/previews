<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sapling_storage (tezos-protocol-019-PtParisB.Tezos_raw_protocol_019_PtParisB.Sapling_storage)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-019-PtParisB</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_019_PtParisB</a> &#x00BB; Sapling_storage</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_019_PtParisB.Sapling_storage</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-COMMITMENTS"><a href="#module-type-COMMITMENTS" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-COMMITMENTS/index.html">COMMITMENTS</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Commitments"><a href="#module-Commitments" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Commitments/index.html">Commitments</a></span><span> : <a href="module-type-COMMITMENTS/index.html">COMMITMENTS</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Ciphertexts"><a href="#module-Ciphertexts" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Ciphertexts/index.html">Ciphertexts</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Nullifiers"><a href="#module-Nullifiers" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Nullifiers/index.html">Nullifiers</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Roots"><a href="#module-Roots" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Roots/index.html">Roots</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Bounded queue of roots. The full size is initialized with the default uncommitted root, that's why roots storage doesn't need to be carbonated. A maximum of one new root is added per protocol level. If multiple transactions for the same shielded pool are processed during the same contract call or several calls in the same block, only the last root will be stored. This property prevents transactions in the same block from depending on each other and guarantees that a transaction will be valid for a least two hours (hence the 120 size) after being forged.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-state"><a href="#type-state" class="anchor"></a><code><span><span class="keyword">type</span> state</span><span> = </span><span>{</span></code><ol><li id="type-state.id" class="def record field anchored"><a href="#type-state.id" class="anchor"></a><code><span>id : <span><a href="../Lazy_storage_kind/Sapling_state/Id/index.html#type-t">Lazy_storage_kind.Sapling_state.Id.t</a> option</span>;</span></code></li><li id="type-state.diff" class="def record field anchored"><a href="#type-state.diff" class="anchor"></a><code><span>diff : <a href="../Sapling_repr/index.html#type-diff">Sapling_repr.diff</a>;</span></code></li><li id="type-state.memo_size" class="def record field anchored"><a href="#type-state.memo_size" class="anchor"></a><code><span>memo_size : <a href="../Sapling_repr/Memo_size/index.html#type-t">Sapling_repr.Memo_size.t</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>This type links the permanent state stored in the context at the specified id together with the ephemeral diff managed by the Michelson interpreter. After a successful execution the diff can be applied to update the state at id. The first time a state is created its id is None, one will be assigned after the first application.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-empty_diff"><a href="#val-empty_diff" class="anchor"></a><code><span><span class="keyword">val</span> empty_diff : <a href="../Sapling_repr/index.html#type-diff">Sapling_repr.diff</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-empty_state"><a href="#val-empty_state" class="anchor"></a><code><span><span class="keyword">val</span> empty_state : 
  <span><span class="optlabel">?id</span>:<a href="../Lazy_storage_kind/Sapling_state/Id/index.html#type-t">Lazy_storage_kind.Sapling_state.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">memo_size</span>:<a href="../Sapling_repr/Memo_size/index.html#type-t">Sapling_repr.Memo_size.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-state">state</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-state_from_id"><a href="#val-state_from_id" class="anchor"></a><code><span><span class="keyword">val</span> state_from_id : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Tezos_raw_protocol_019_PtParisB__Storage.Sapling.id</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-state">state</a> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>,
    <span><a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-error">Tezos_protocol_environment_019_PtParisB.Error_monad.error</a>
      <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-trace">Tezos_protocol_environment_019_PtParisB.Error_monad.trace</a></span>)</span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Pervasives/index.html#type-result">Tezos_protocol_environment_019_PtParisB.Pervasives.result</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Returns a state from an existing id.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_arg"><a href="#val-rpc_arg" class="anchor"></a><code><span><span class="keyword">val</span> rpc_arg : 
  <span><a href="../Storage/Sapling/index.html#type-id">Storage.Sapling.id</a> <a href="../../Tezos_protocol_environment_019_PtParisB/RPC_arg/index.html#type-t">Tezos_protocol_environment_019_PtParisB.RPC_arg.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_memo_size"><a href="#val-get_memo_size" class="anchor"></a><code><span><span class="keyword">val</span> get_memo_size : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Tezos_raw_protocol_019_PtParisB__Storage.Sapling.id</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Storage/Sapling/Memo_size/index.html#type-value">Storage.Sapling.Memo_size.value</a>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_019_PtParisB.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Tezos_raw_protocol_019_PtParisB__Storage.Sapling.id</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">memo_size</span>:<a href="../Storage/Sapling/Memo_size/index.html#type-value">Storage.Sapling.Memo_size.value</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a>,
    <span><a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-error">Tezos_protocol_environment_019_PtParisB.Error_monad.error</a>
      <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-trace">Tezos_protocol_environment_019_PtParisB.Error_monad.trace</a></span>)</span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Pervasives/index.html#type-result">Tezos_protocol_environment_019_PtParisB.Pervasives.result</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_diff"><a href="#val-apply_diff" class="anchor"></a><code><span><span class="keyword">val</span> apply_diff : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Tezos_raw_protocol_019_PtParisB__Storage.Sapling.id</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sapling_repr/index.html#type-diff">Sapling_repr.diff</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../../Tezos_protocol_environment_019_PtParisB/Z/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Z.t</a>,
    <span><a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-error">Tezos_protocol_environment_019_PtParisB.Error_monad.error</a>
      <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-trace">Tezos_protocol_environment_019_PtParisB.Error_monad.trace</a></span>)</span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Pervasives/index.html#type-result">Tezos_protocol_environment_019_PtParisB.Pervasives.result</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Applies a diff to a state id stored in the context. Updates Commitments, Ciphertexts and Nullifiers using the diff and updates the Roots using the new Commitments tree.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add"><a href="#val-add" class="anchor"></a><code><span><span class="keyword">val</span> add : 
  <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../Tezos_protocol_environment_019_PtParisB/Sapling/Commitment/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Sapling.Commitment.t</a>
   * <a href="../../Tezos_protocol_environment_019_PtParisB/Sapling/Ciphertext/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Sapling.Ciphertext.t</a>)</span>
    list</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-state">state</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-root_mem"><a href="#val-root_mem" class="anchor"></a><code><span><span class="keyword">val</span> root_mem : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Sapling/Hash/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Sapling.Hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(bool,
    <span><a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-error">Tezos_protocol_environment_019_PtParisB.Error_monad.error</a>
      <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-trace">Tezos_protocol_environment_019_PtParisB.Error_monad.trace</a></span>)</span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Pervasives/index.html#type-result">Tezos_protocol_environment_019_PtParisB.Pervasives.result</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-nullifiers_mem"><a href="#val-nullifiers_mem" class="anchor"></a><code><span><span class="keyword">val</span> nullifiers_mem : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Sapling/Nullifier/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Sapling.Nullifier.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * bool,
    <span><a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-error">Tezos_protocol_environment_019_PtParisB.Error_monad.error</a>
      <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-trace">Tezos_protocol_environment_019_PtParisB.Error_monad.trace</a></span>)</span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Pervasives/index.html#type-result">Tezos_protocol_environment_019_PtParisB.Pervasives.result</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-nullifiers_add"><a href="#val-nullifiers_add" class="anchor"></a><code><span><span class="keyword">val</span> nullifiers_add : 
  <span><a href="#type-state">state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Sapling/Nullifier/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Sapling.Nullifier.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-state">state</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-root"><a href="#type-root" class="anchor"></a><code><span><span class="keyword">type</span> root</span><span> = <a href="../../Tezos_protocol_environment_019_PtParisB/Sapling/Hash/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Sapling.Hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-root_encoding"><a href="#val-root_encoding" class="anchor"></a><code><span><span class="keyword">val</span> root_encoding : 
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Sapling/Hash/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Sapling.Hash.t</a> <a href="../../../octez-libs/Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_diff"><a href="#val-get_diff" class="anchor"></a><code><span><span class="keyword">val</span> get_diff : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Storage/Sapling/index.html#type-id">Storage.Sapling.id</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?offset_commitment</span>:<a href="../Storage/Sapling/Ciphertexts/index.html#type-key">Storage.Sapling.Ciphertexts.key</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?offset_nullifier</span>:<a href="../Storage/Sapling/Nullifiers_ordered/index.html#type-key">Storage.Sapling.Nullifiers_ordered.key</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Storage/Sapling/Roots/index.html#type-value">Storage.Sapling.Roots.value</a> * <a href="../Sapling_repr/index.html#type-diff">Sapling_repr.diff</a>,
    <span><a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-error">Tezos_protocol_environment_019_PtParisB.Error_monad.error</a>
      <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-trace">Tezos_protocol_environment_019_PtParisB.Error_monad.trace</a></span>)</span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Pervasives/index.html#type-result">Tezos_protocol_environment_019_PtParisB.Pervasives.result</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div></div></div></body></html>
