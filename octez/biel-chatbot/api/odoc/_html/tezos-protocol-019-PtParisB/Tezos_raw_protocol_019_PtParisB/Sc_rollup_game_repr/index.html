<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sc_rollup_game_repr (tezos-protocol-019-PtParisB.Tezos_raw_protocol_019_PtParisB.Sc_rollup_game_repr)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-019-PtParisB</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_019_PtParisB</a> &#x00BB; Sc_rollup_game_repr</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_019_PtParisB.Sc_rollup_game_repr</span></code></h1><p>The smart contract rollup refutation game types are defined here, as well as the basic pure logic for:</p><ul><li>how to create a new game from a pair of commits in the commit tree;</li></ul><ul><li>how to update a game or complete a game when a move is played.</li></ul><p>This game logic is used by the protocol when two commitments are in conflict to determine which one of the commitments is wrong.</p><p>Game state and moves ====================</p><p>The first step consists of dissecting the commitment's number of ticks. The game stores a list <code>dissection</code> of state hashes and tick counts. These are the claims about the PVM history made by the player who has just moved.</p><p>The next player to move will specify a tick count which appears in the <code>dissection</code>; this is the last of the state hashes which she agrees with. She will then either:</p><ul><li>provide a new <code>dissection</code> by giving a list of state hashes and tick counts that starts at the chosen tick count and ends at the next tick count in the previous <code>dissection</code>. It must agree at the start but disagree with the final state.</li></ul><ul><li>if the tick difference between this state and the next is one, there is no 'room' for a new <code>dissection</code>. In this case she must provide a Merkle proof that shows the step in the current <code>dissection</code> is invalid.</li></ul><p>If a player failed to prove that the current <code>dissection</code> is valid. We reach the final move of the game. The other player will have a chance to prove that the <code>dissection</code> is valid. If both player fails to invalidate each other, the game ends in a draw.</p><p>Initializing a game ===================</p><p>In order to trigger the start of a game, one player must publish a first move.</p><p>The <code>initial</code> function is called at this point. It converts a parent-child pair of commitments (belonging to the other player) into an initial <code>dissection</code>. The first move is immediately applied to this to give the first state of the game.</p><p>Note: it is quite possible for the game to end immediately after this first move, either if the commitment has a tick count of one or more probably if the refutation proves that the commitment was 'premature' (the state is not blocked---there are further computation steps to do or more inbox messages to read).</p><p>Expected properties ===================</p><p>P1 - If <code>dissection</code> is honest, the next move must be dishonest:</p><p>There is only one honest state hash for a given tick count. The next player must provide a different hash to the honest hash in the <code>dissection</code>.</p><p>P2 - If <code>dissection</code> is dishonest, there is a strategy for a player equipped with a perfect PVM to play an honest next move:</p><p>The player with a perfect PVM can calculate honest hashes until one disagrees with the <code>dissection</code>, and challenges the dissection at that point, publishing either an honest <code>dissection</code> or an honest <code>Proof</code>.</p><p>Each <code>dissection</code> has a maximum tick count step shorter than the last, so by induction using P1 and P2 we have</p><p>P1' - If <code>dissection</code> is honest, the last player has a winning strategy.</p><p>P2' - If <code>dissection</code> is dishonest, the next player has a winning strategy.</p><p>This allows us to see the following. (We use <code>refuter</code> to mean the first player to move, and <code>defender</code> to mean the other player.)</p><p>Honest refuter wins: An honest refuter will be refuting a dishonest commitment, because there is only one honest state possible per level. Therefore the initial <code>dissection</code> will be dishonest. By P2' the refuter has a winning strategy.</p><p>Honest defender wins: An honest defender will have made an honest commitment which will be translated into an honest initial <code>dissection</code>. By P1' the defender has a winning strategy.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Dissection_choice_not_found"><a href="#extension-decl-Dissection_choice_not_found" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-error">Tezos_protocol_environment_019_PtParisB.Error_monad.error</a> += </span></code><ol><li id="extension-Dissection_choice_not_found" class="def variant extension anchored"><a href="#extension-Dissection_choice_not_found" class="anchor"></a><code><span>| </span><span><span class="extension">Dissection_choice_not_found</span> <span class="keyword">of</span> <a href="../Sc_rollup_tick_repr/index.html#type-t">Sc_rollup_tick_repr.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The given choice in a refutation is not a starting tick of any of the sections in the current dissection.</p><span class="comment-delim">*)</span></div></li><li id="extension-Proof_unexpected_section_size" class="def variant extension anchored"><a href="#extension-Proof_unexpected_section_size" class="anchor"></a><code><span>| </span><span><span class="extension">Proof_unexpected_section_size</span> <span class="keyword">of</span> <a href="../../Tezos_protocol_environment_019_PtParisB/Z/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Z.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Invalid proof step because there is more than one tick.</p><span class="comment-delim">*)</span></div></li><li id="extension-Proof_start_state_hash_mismatch" class="def variant extension anchored"><a href="#extension-Proof_start_state_hash_mismatch" class="anchor"></a><code><span>| </span><span><span class="extension">Proof_start_state_hash_mismatch</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Sc_rollup_game_repr.start_state_hash" class="def record field anchored"><a href="#module-Sc_rollup_game_repr.start_state_hash" class="anchor"></a><code><span>start_state_hash : <span><a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a> option</span>;</span></code></li><li id="module-Sc_rollup_game_repr.start_proof" class="def record field anchored"><a href="#module-Sc_rollup_game_repr.start_proof" class="anchor"></a><code><span>start_proof : <a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The given proof's starting state doesn't match the expected one.</p><span class="comment-delim">*)</span></div></li><li id="extension-Proof_stop_state_hash_failed_to_refute" class="def variant extension anchored"><a href="#extension-Proof_stop_state_hash_failed_to_refute" class="anchor"></a><code><span>| </span><span><span class="extension">Proof_stop_state_hash_failed_to_refute</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Sc_rollup_game_repr.stop_state_hash" class="def record field anchored"><a href="#module-Sc_rollup_game_repr.stop_state_hash" class="anchor"></a><code><span>stop_state_hash : <span><a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a> option</span>;</span></code></li><li id="module-Sc_rollup_game_repr.stop_proof" class="def record field anchored"><a href="#module-Sc_rollup_game_repr.stop_proof" class="anchor"></a><code><span>stop_proof : <span><a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a> option</span>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The given proof's ending state should not match the state being refuted.</p><span class="comment-delim">*)</span></div></li><li id="extension-Proof_stop_state_hash_failed_to_validate" class="def variant extension anchored"><a href="#extension-Proof_stop_state_hash_failed_to_validate" class="anchor"></a><code><span>| </span><span><span class="extension">Proof_stop_state_hash_failed_to_validate</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Sc_rollup_game_repr.stop_state_hash" class="def record field anchored"><a href="#module-Sc_rollup_game_repr.stop_state_hash" class="anchor"></a><code><span>stop_state_hash : <span><a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a> option</span>;</span></code></li><li id="module-Sc_rollup_game_repr.stop_proof" class="def record field anchored"><a href="#module-Sc_rollup_game_repr.stop_proof" class="anchor"></a><code><span>stop_proof : <span><a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a> option</span>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The given proof's ending state should match the state being refuted.</p><span class="comment-delim">*)</span></div></li><li id="extension-Dissecting_during_final_move" class="def variant extension anchored"><a href="#extension-Dissecting_during_final_move" class="anchor"></a><code><span>| </span><span><span class="extension">Dissecting_during_final_move</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The step move is a dissecting where the final move has started already.</p><span class="comment-delim">*)</span></div></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-player"><a href="#type-player" class="anchor"></a><code><span><span class="keyword">type</span> player</span><span> = </span></code><ol><li id="type-player.Alice" class="def variant constructor anchored"><a href="#type-player.Alice" class="anchor"></a><code><span>| </span><span><span class="constructor">Alice</span></span></code></li><li id="type-player.Bob" class="def variant constructor anchored"><a href="#type-player.Bob" class="anchor"></a><code><span>| </span><span><span class="constructor">Bob</span></span></code></li></ol></div><div class="spec-doc"><p>The two stakers index the game in the storage as a pair of public key hashes which is in lexical order. We use <code>Alice</code> and <code>Bob</code> to represent the first and second player in the pair respectively.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-V1"><a href="#module-V1" class="anchor"></a><code><span><span class="keyword">module</span> <a href="V1/index.html">V1</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-include"><div class="spec-doc"><p>Versioning, see <a href="../Sc_rollup_data_version_sig/module-type-S/index.html"><code>Sc_rollup_data_version_sig.S</code></a> for more information.</p></div><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../Sc_rollup_data_version_sig/module-type-S/index.html">Sc_rollup_data_version_sig.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../Sc_rollup_data_version_sig/module-type-S/index.html#type-t">t</a> = <a href="V1/index.html#type-t">V1.t</a></span></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-versioned"><a href="#type-versioned" class="anchor"></a><code><span><span class="keyword">type</span> versioned</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-versioned_encoding"><a href="#val-versioned_encoding" class="anchor"></a><code><span><span class="keyword">val</span> versioned_encoding : 
  <span><a href="#type-versioned">versioned</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_versioned"><a href="#val-of_versioned" class="anchor"></a><code><span><span class="keyword">val</span> of_versioned : <span><a href="#type-versioned">versioned</a> <span class="arrow">&#45;&gt;</span></span> <a href="V1/index.html#type-t">V1.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_versioned"><a href="#val-to_versioned" class="anchor"></a><code><span><span class="keyword">val</span> to_versioned : <span><a href="V1/index.html#type-t">V1.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-versioned">versioned</a></span></code></div></div></details></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <a href="V1/index.html">V1</a>
  <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="V1/index.html#type-dissection_chunk">dissection_chunk</a> = <a href="V1/index.html#type-dissection_chunk">V1.dissection_chunk</a></span>
   <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="V1/index.html#type-game_state">game_state</a> = <a href="V1/index.html#type-game_state">V1.game_state</a></span>
   <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="V1/index.html#type-t">t</a> = <a href="V1/index.html#type-t">V1.t</a></span></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-dissection_chunk"><a href="#type-dissection_chunk" class="anchor"></a><code><span><span class="keyword">type</span> dissection_chunk</span><span> = <a href="V1/index.html#type-dissection_chunk">V1.dissection_chunk</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-game_state"><a href="#type-game_state" class="anchor"></a><code><span><span class="keyword">type</span> game_state</span><span> = <a href="V1/index.html#type-game_state">V1.game_state</a></span><span> = </span></code><ol><li id="type-game_state.Dissecting" class="def variant constructor anchored"><a href="#type-game_state.Dissecting" class="anchor"></a><code><span>| </span><span><span class="constructor">Dissecting</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-game_state.dissection" class="def record field anchored"><a href="#type-game_state.dissection" class="anchor"></a><code><span>dissection : <span><a href="#type-dissection_chunk">dissection_chunk</a> list</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>dissection</code>, a list of states with tick counts. The current player will specify, in the next move, a tick count that indicates the last of these states that she agrees with.</p><span class="comment-delim">*)</span></div></li><li id="type-game_state.default_number_of_sections" class="def record field anchored"><a href="#type-game_state.default_number_of_sections" class="anchor"></a><code><span>default_number_of_sections : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>default_number_of_sections</code> is the number of sections a disection should contain in the more general case where we still have a high enough number of disputed ticks.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>When the state is <code>Dissecting</code>, both player are still dissecting the commitment to find the tick to refute.</p><span class="comment-delim">*)</span></div></li><li id="type-game_state.Final_move" class="def variant constructor anchored"><a href="#type-game_state.Final_move" class="anchor"></a><code><span>| </span><span><span class="constructor">Final_move</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-game_state.agreed_start_chunk" class="def record field anchored"><a href="#type-game_state.agreed_start_chunk" class="anchor"></a><code><span>agreed_start_chunk : <a href="#type-dissection_chunk">dissection_chunk</a>;</span></code></li><li id="type-game_state.refuted_stop_chunk" class="def record field anchored"><a href="#type-game_state.refuted_stop_chunk" class="anchor"></a><code><span>refuted_stop_chunk : <a href="#type-dissection_chunk">dissection_chunk</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>When the state is <code>Final_move</code>, either <code>Alice</code> or <code>Bob</code> already played an invalid proof.</p><p>The other player will have a chance to prove that the <code>refuted_stop_state</code> is valid. If both players fail to either validate or refute the stop state, the current game state describes a draw situation. In the same way, the draw can be described by the situation where the two players manage to validate or refute the stop state.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Describes the current state of a game.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-game_state_encoding"><a href="#val-game_state_encoding" class="anchor"></a><code><span><span class="keyword">val</span> game_state_encoding : 
  <span><a href="#type-game_state">game_state</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-game_state_equal"><a href="#val-game_state_equal" class="anchor"></a><code><span><span class="keyword">val</span> game_state_equal : <span><a href="#type-game_state">game_state</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-game_state">game_state</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="V1/index.html#type-t">V1.t</a></span><span> = </span><span>{</span></code><ol><li id="type-t.turn" class="def record field anchored"><a href="#type-t.turn" class="anchor"></a><code><span>turn : <a href="#type-player">player</a>;</span></code></li><li id="type-t.inbox_snapshot" class="def record field anchored"><a href="#type-t.inbox_snapshot" class="anchor"></a><code><span>inbox_snapshot : <a href="../Sc_rollup_inbox_repr/index.html#type-history_proof">Sc_rollup_inbox_repr.history_proof</a>;</span></code></li><li id="type-t.dal_snapshot" class="def record field anchored"><a href="#type-t.dal_snapshot" class="anchor"></a><code><span>dal_snapshot : <a href="../Dal_slot_repr/History/index.html#type-t">Dal_slot_repr.History.t</a>;</span></code></li><li id="type-t.start_level" class="def record field anchored"><a href="#type-t.start_level" class="anchor"></a><code><span>start_level : <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>;</span></code></li><li id="type-t.inbox_level" class="def record field anchored"><a href="#type-t.inbox_level" class="anchor"></a><code><span>inbox_level : <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>;</span></code></li><li id="type-t.game_state" class="def record field anchored"><a href="#type-t.game_state" class="anchor"></a><code><span>game_state : <a href="#type-game_state">game_state</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A game is characterized by:</p><ul><li><code>refuter_commitment_hash</code>, the hash of the commitment of the player that has initiated the game.</li></ul><ul><li><code>defender_commitment_hash</code>, the hash of the commitment of the player that is tentatively refuted.</li></ul><ul><li><code>turn</code>, the player that must provide the next move.</li></ul><ul><li><code>inbox_snapshot</code>, a snapshot of the inbox state at the moment the game is created. This is only used when checking <code>Input_step</code> and <code>Blocked_step</code> proofs; it makes the proofs easier to create--- otherwise they would have a 'moving target' because the actual inbox may be updated continuously.</li></ul><ul><li><code>dal_snapshot</code>, a snapshot of the DAL's confirmed slots history at the moment the game is created. In fact, since the confirmed slots history at initialization would likely evolve during the game, we need a (fixed) reference w.r.t. which Dal input proofs would be produced and verified if needed.</li></ul><ul><li><code>level</code>, the inbox level of the commitment the game is refuting. This is only used when checking <code>Blocked_step</code> proofs---the proof will show that the next message available in <code>inbox_snapshot</code> is at <code>level</code>, so shouldn't be included in this commitment.</li></ul><ul><li><code>game_state</code>, the current state of the game, see <a href="#type-game_state"><code>game_state</code></a> for more information.</li></ul><p>Invariants: -----------</p><ul><li><code>dissection</code> must contain at least 2 values (normally it will be 32 values, but smaller if there isn't enough space for a dissection that size. The initial game dissection will be 3 values except in the case of a zero-tick commit when it will have 2 values.)</li><li>the first state hash value in <code>dissection</code> must not be <code>None</code></li><li><code>inbox_snapshot</code> and <code>dal_snapshot</code> never change once the game is created</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>equal g1 g2</code> returns <code>true</code> iff <code>g1</code> is equal to <code>g2</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-opponent"><a href="#val-opponent" class="anchor"></a><code><span><span class="keyword">val</span> opponent : <span><a href="#type-player">player</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-player">player</a></span></code></div><div class="spec-doc"><p>Return the other player</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_dissection"><a href="#val-pp_dissection" class="anchor"></a><code><span><span class="keyword">val</span> pp_dissection : 
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Format/index.html#type-formatter">Tezos_protocol_environment_019_PtParisB.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-dissection_chunk">dissection_chunk</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-player_equal"><a href="#val-player_equal" class="anchor"></a><code><span><span class="keyword">val</span> player_equal : <span><a href="#type-player">player</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-player">player</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-player_encoding"><a href="#val-player_encoding" class="anchor"></a><code><span><span class="keyword">val</span> player_encoding : 
  <span><a href="#type-player">player</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><a href="../../Tezos_protocol_environment_019_PtParisB/Format/index.html#type-formatter">Tezos_protocol_environment_019_PtParisB.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div></details></div><div class="odoc-spec"><div class="spec module anchored" id="module-Index"><a href="#module-Index" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Index/index.html">Index</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-initial"><a href="#val-initial" class="anchor"></a><code><span><span class="keyword">val</span> initial : 
  <span><a href="../Sc_rollup_inbox_repr/index.html#type-history_proof">Sc_rollup_inbox_repr.history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Dal_slot_repr/History/index.html#type-t">Dal_slot_repr.History.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">start_level</span>:<a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parent_commitment</span>:<a href="../Sc_rollup_commitment_repr/index.html#type-t">Sc_rollup_commitment_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">defender_commitment</span>:<a href="../Sc_rollup_commitment_repr/index.html#type-t">Sc_rollup_commitment_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">refuter</span>:<a href="../../Tezos_protocol_environment_019_PtParisB/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_019_PtParisB.Signature.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">defender</span>:<a href="../../Tezos_protocol_environment_019_PtParisB/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_019_PtParisB.Signature.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">default_number_of_sections</span>:int <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>To begin a game, first the conflict point in the commit tree is found, and then this function is applied.</p><p><code>initial inbox dal_slots_history ~start_level ~parent_commitment
    ~defender_commitment ~refuter ~defender ~default_number_of_sections</code> will construct an initial game where <code>refuter</code> is next to play. The game has <code>dissection</code> with three states:</p><ul><li>firstly, the state (with tick zero) of <code>parent_commitment</code>, the commitment that both stakers agree on.</li></ul><ul><li>secondly, the state and tick count of <code>defender_commitment</code>, the commitment that <code>defender</code> has staked on.</li></ul><ul><li>thirdly, a <code>None</code> state which is a single tick after the <code>defender_commitment</code> commitment. This represents the claim, implicit in the commitment, that the state given is blocked.</li></ul><p>This gives <code>refuter</code> a binary choice: she can refute the commit itself by providing a new dissection between the two committed states, or she can refute the claim that the <code>child</code> commit is a blocked state by immediately providing a proof of a single tick increment from that state to its successor.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-step"><a href="#type-step" class="anchor"></a><code><span><span class="keyword">type</span> step</span><span> = </span></code><ol><li id="type-step.Dissection" class="def variant constructor anchored"><a href="#type-step.Dissection" class="anchor"></a><code><span>| </span><span><span class="constructor">Dissection</span> <span class="keyword">of</span> <span><a href="#type-dissection_chunk">dissection_chunk</a> list</span></span></code></li><li id="type-step.Proof" class="def variant constructor anchored"><a href="#type-step.Proof" class="anchor"></a><code><span>| </span><span><span class="constructor">Proof</span> <span class="keyword">of</span> <span><a href="../Sc_rollup_proof_repr/index.html#type-serialized">Sc_rollup_proof_repr.serialized</a> <a href="../Sc_rollup_proof_repr/index.html#type-t">Sc_rollup_proof_repr.t</a></span></span></code></li></ol></div><div class="spec-doc"><p>A <code>step</code> in the game is either a new dissection (if there are intermediate ticks remaining to put in it) or a proof.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-refutation"><a href="#type-refutation" class="anchor"></a><code><span><span class="keyword">type</span> refutation</span><span> = </span></code><ol><li id="type-refutation.Start" class="def variant constructor anchored"><a href="#type-refutation.Start" class="anchor"></a><code><span>| </span><span><span class="constructor">Start</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-refutation.player_commitment_hash" class="def record field anchored"><a href="#type-refutation.player_commitment_hash" class="anchor"></a><code><span>player_commitment_hash : <a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Sc_rollup_commitment_repr.Hash.t</a>;</span></code></li><li id="type-refutation.opponent_commitment_hash" class="def record field anchored"><a href="#type-refutation.opponent_commitment_hash" class="anchor"></a><code><span>opponent_commitment_hash : <a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Sc_rollup_commitment_repr.Hash.t</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-refutation.Move" class="def variant constructor anchored"><a href="#type-refutation.Move" class="anchor"></a><code><span>| </span><span><span class="constructor">Move</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-refutation.choice" class="def record field anchored"><a href="#type-refutation.choice" class="anchor"></a><code><span>choice : <a href="../Sc_rollup_tick_repr/index.html#type-t">Sc_rollup_tick_repr.t</a>;</span></code></li><li id="type-refutation.step" class="def record field anchored"><a href="#type-refutation.step" class="anchor"></a><code><span>step : <a href="#type-step">step</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>choice</code> is the final tick in the current dissection at which the two players agree.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>A <code>refutation</code> is a move in the game.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_refutation"><a href="#val-pp_refutation" class="anchor"></a><code><span><span class="keyword">val</span> pp_refutation : 
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Format/index.html#type-formatter">Tezos_protocol_environment_019_PtParisB.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-refutation">refutation</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-refutation_encoding"><a href="#val-refutation_encoding" class="anchor"></a><code><span><span class="keyword">val</span> refutation_encoding : 
  <span><a href="#type-refutation">refutation</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-reason"><a href="#type-reason" class="anchor"></a><code><span><span class="keyword">type</span> reason</span><span> = </span></code><ol><li id="type-reason.Conflict_resolved" class="def variant constructor anchored"><a href="#type-reason.Conflict_resolved" class="anchor"></a><code><span>| </span><span><span class="constructor">Conflict_resolved</span></span></code></li><li id="type-reason.Timeout" class="def variant constructor anchored"><a href="#type-reason.Timeout" class="anchor"></a><code><span>| </span><span><span class="constructor">Timeout</span></span></code></li></ol></div><div class="spec-doc"><p>A game ends for one of two reasons: the conflict has been resolved via a proof or a player has been timed out.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_reason"><a href="#val-pp_reason" class="anchor"></a><code><span><span class="keyword">val</span> pp_reason : 
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Format/index.html#type-formatter">Tezos_protocol_environment_019_PtParisB.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-reason">reason</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reason_encoding"><a href="#val-reason_encoding" class="anchor"></a><code><span><span class="keyword">val</span> reason_encoding : 
  <span><a href="#type-reason">reason</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-game_result"><a href="#type-game_result" class="anchor"></a><code><span><span class="keyword">type</span> game_result</span><span> = </span></code><ol><li id="type-game_result.Loser" class="def variant constructor anchored"><a href="#type-game_result.Loser" class="anchor"></a><code><span>| </span><span><span class="constructor">Loser</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-game_result.reason" class="def record field anchored"><a href="#type-game_result.reason" class="anchor"></a><code><span>reason : <a href="#type-reason">reason</a>;</span></code></li><li id="type-game_result.loser" class="def record field anchored"><a href="#type-game_result.loser" class="anchor"></a><code><span>loser : <a href="../Sc_rollup_repr/Staker/index.html#type-t">Sc_rollup_repr.Staker.t</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>One player lost.</p><span class="comment-delim">*)</span></div></li><li id="type-game_result.Draw" class="def variant constructor anchored"><a href="#type-game_result.Draw" class="anchor"></a><code><span>| </span><span><span class="constructor">Draw</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The game ended in a draw</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>The game result.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_game_result"><a href="#val-pp_game_result" class="anchor"></a><code><span><span class="keyword">val</span> pp_game_result : 
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Format/index.html#type-formatter">Tezos_protocol_environment_019_PtParisB.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-game_result">game_result</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-game_result_encoding"><a href="#val-game_result_encoding" class="anchor"></a><code><span><span class="keyword">val</span> game_result_encoding : 
  <span><a href="#type-game_result">game_result</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-status"><a href="#type-status" class="anchor"></a><code><span><span class="keyword">type</span> status</span><span> = </span></code><ol><li id="type-status.Ongoing" class="def variant constructor anchored"><a href="#type-status.Ongoing" class="anchor"></a><code><span>| </span><span><span class="constructor">Ongoing</span></span></code></li><li id="type-status.Ended" class="def variant constructor anchored"><a href="#type-status.Ended" class="anchor"></a><code><span>| </span><span><span class="constructor">Ended</span> <span class="keyword">of</span> <a href="#type-game_result">game_result</a></span></code></li></ol></div><div class="spec-doc"><p>A type that represents the current game status in a way that is useful to the outside world (using actual <code>Staker.t</code> values instead of the internal <code>player</code> type).</p><p>The <code>Staker.t</code> in the <code>Ended</code> case is the loser of the game: the staker who will have their stake slashed.</p><p>Used in operation result types.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_status"><a href="#val-pp_status" class="anchor"></a><code><span><span class="keyword">val</span> pp_status : 
  <span><a href="../../Tezos_protocol_environment_019_PtParisB/Format/index.html#type-formatter">Tezos_protocol_environment_019_PtParisB.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-status">status</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-status_encoding"><a href="#val-status_encoding" class="anchor"></a><code><span><span class="keyword">val</span> status_encoding : 
  <span><a href="#type-status">status</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-play"><a href="#val-play" class="anchor"></a><code><span><span class="keyword">val</span> play : 
  <span><a href="../Sc_rollups/Kind/index.html#type-t">Sc_rollups.Kind.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Dal_slot_repr/index.html#type-parameters">Dal_slot_repr.parameters</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dal_activation_level</span>:<span><a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dal_attestation_lag</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dal_number_of_slots</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">stakers</span>:<a href="Index/index.html#type-t">Index.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_metadata_repr/index.html#type-t">Sc_rollup_metadata_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">step</span>:<a href="#type-step">step</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">choice</span>:<a href="../Sc_rollup_tick_repr/index.html#type-t">Sc_rollup_tick_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">is_reveal_enabled</span>:<a href="../Sc_rollup_PVM_sig/index.html#type-is_reveal_enabled">Sc_rollup_PVM_sig.is_reveal_enabled</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dal_attested_slots_validity_lag</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<a href="#type-game_result">game_result</a>, <a href="#type-t">t</a>)</span> <a href="../../Tezos_protocol_environment_019_PtParisB/Either/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Either.t</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_019_PtParisB.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_019_PtParisB/Lwt/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Applies the move <code>refutation</code> to the game. Returns the game <a href="#type-status"><code>status</code></a> after applying the move.</p><p>In the case of the game continuing, this swaps the current player and returns a <code>Ongoing</code> status. Otherwise, it returns a <code>Ended &lt;game_result&gt;</code> status.</p><p>The provided DAL related parameters are used in case the game needs to:</p><ul><li>Check that a page's content is part of a slot (using the slot's commitment) when refuting a DAL page reveal.</li><li>Check that the parameters are correct when refuting a DAL parameter reveal.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cost_play"><a href="#val-cost_play" class="anchor"></a><code><span><span class="keyword">val</span> cost_play : 
  <span><span class="label">step</span>:<a href="#type-step">step</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">choice</span>:<a href="../Sc_rollup_tick_repr/index.html#type-t">Sc_rollup_tick_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Gas_limit_repr/index.html#type-cost">Gas_limit_repr.cost</a></span></code></div><div class="spec-doc"><p><code>cost_play ~step ~choice</code> returns the gas cost of <code>play</code> applied with<code>step</code>, and <code>choice</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-timeout"><a href="#type-timeout" class="anchor"></a><code><span><span class="keyword">type</span> timeout</span><span> = </span><span>{</span></code><ol><li id="type-timeout.alice" class="def record field anchored"><a href="#type-timeout.alice" class="anchor"></a><code><span>alice : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Timeout of <code>Alice</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-timeout.bob" class="def record field anchored"><a href="#type-timeout.bob" class="anchor"></a><code><span>bob : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Timeout of <code>Bob</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-timeout.last_turn_level" class="def record field anchored"><a href="#type-timeout.last_turn_level" class="anchor"></a><code><span>last_turn_level : <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Block level of the last turn move.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A type that represents the number of blocks left for players to play. Each player has her timeout value. `timeout` is expressed in the number of blocks.</p><p>Timeout logic is similar to a chess clock. Each player starts with the same timeout. Each game move updates the timeout of the current player by decreasing it by the amount of time she took to play, i.e. number of blocks since the opponent last move. See <a href="../Sc_rollup_refutation_storage/index.html#val-game_move"><code>Sc_rollup_refutation_storage.game_move</code></a> to see the implementation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-timeout_encoding"><a href="#val-timeout_encoding" class="anchor"></a><code><span><span class="keyword">val</span> timeout_encoding : 
  <span><a href="#type-timeout">timeout</a> <a href="../../Tezos_protocol_environment_019_PtParisB/Data_encoding/index.html#type-t">Tezos_protocol_environment_019_PtParisB.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
