<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sc_rollup_proof_repr (tezos-protocol-016-PtMumbai.Tezos_raw_protocol_016_PtMumbai.Sc_rollup_proof_repr)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-016-PtMumbai</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_016_PtMumbai</a> &#x00BB; Sc_rollup_proof_repr</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_016_PtMumbai.Sc_rollup_proof_repr</span></code></h1><p>A refutation game proof is required as part of the final move in a game.</p><p>This proof is basically a combination of a PVM proof (provided by each implementation of the PVM signature) and an input proof. To check the proof we must check each part separately and then also check that they match on the two points where they touch:</p><ul><li>the <code>input_requested</code> of the PVM proof should match the starting point of the input proof ;</li></ul><ul><li>the <code>input_given</code> of the PVM proof should match the output message of the input proof.</li></ul><p>It is also often the case that the PVM proof has <code>No_input_required</code> for its <code>input_requested</code> and <code>None</code> for its <code>input_given</code>. If this is the case, we don't need the input proof at all and the <code>input_proof</code> parameter in our proof should be <code>None</code>.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-reveal_proof"><a href="#type-reveal_proof" class="anchor"></a><code><span><span class="keyword">type</span> reveal_proof</span><span> = </span></code><ol><li id="type-reveal_proof.Raw_data_proof" class="def variant constructor anchored"><a href="#type-reveal_proof.Raw_data_proof" class="anchor"></a><code><span>| </span><span><span class="constructor">Raw_data_proof</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The existence of reveal for a given hash when the <code>input_requested</code> is the <code>Needs_reveal Reveal_raw_data</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-reveal_proof.Metadata_proof" class="def variant constructor anchored"><a href="#type-reveal_proof.Metadata_proof" class="anchor"></a><code><span>| </span><span><span class="constructor">Metadata_proof</span></span></code></li><li id="type-reveal_proof.Dal_page_proof" class="def variant constructor anchored"><a href="#type-reveal_proof.Dal_page_proof" class="anchor"></a><code><span>| </span><span><span class="constructor">Dal_page_proof</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-reveal_proof.page_id" class="def record field anchored"><a href="#type-reveal_proof.page_id" class="anchor"></a><code><span>page_id : <a href="../Dal_slot_repr/Page/index.html#type-t">Dal_slot_repr.Page.t</a>;</span></code></li><li id="type-reveal_proof.proof" class="def record field anchored"><a href="#type-reveal_proof.proof" class="anchor"></a><code><span>proof : <a href="../Dal_slot_repr/History/index.html#type-proof">Dal_slot_repr.History.proof</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The existence or not of a confirmed slot for a given page ID when the <code>input_requested</code> is the <code>Needs_reveal Request_dal_page</code>.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>The proof that a reveal is valid.</p></div></div><p>A PVM proof <code>pvm_step</code> is combined with an <code>input_proof</code> to provide the proof necessary to validate a single step in the refutation game.</p><p>If the step doesn't involve any input, <code>proof_input_requested
    pvm_step</code> and <code>proof_input_given pvm_step</code> will be <code>No_input_required</code> and <code>None</code> respectively, and in this case <code>inbox</code> should also be <code>None</code>.</p><p>In the case that input is involved, <code>input_proof</code> is either:</p><ul><li>a proof of the next inbox message available from the inbox after a given location; this must match up with <code>pvm_step</code> to give a valid refutation proof ; or</li></ul><ul><li>a proof of a reveal satisfiability.</li></ul><ul><li>a claim that the input involved is the first input of the inbox, which does not need to be proved as we know by construction what is the input (i.e. the <code>Start_of_level</code> of the level after the rollup's origination level).</li></ul><div class="odoc-spec"><div class="spec type anchored" id="type-input_proof"><a href="#type-input_proof" class="anchor"></a><code><span><span class="keyword">type</span> input_proof</span><span> = </span></code><ol><li id="type-input_proof.Inbox_proof" class="def variant constructor anchored"><a href="#type-input_proof.Inbox_proof" class="anchor"></a><code><span>| </span><span><span class="constructor">Inbox_proof</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-input_proof.level" class="def record field anchored"><a href="#type-input_proof.level" class="anchor"></a><code><span>level : <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>;</span></code></li><li id="type-input_proof.message_counter" class="def record field anchored"><a href="#type-input_proof.message_counter" class="anchor"></a><code><span>message_counter : <a href="../../Tezos_protocol_environment_016_PtMumbai/Z/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Z.t</a>;</span></code></li><li id="type-input_proof.proof" class="def record field anchored"><a href="#type-input_proof.proof" class="anchor"></a><code><span>proof : <a href="../Sc_rollup_inbox_repr/index.html#type-serialized_proof">Sc_rollup_inbox_repr.serialized_proof</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-input_proof.Reveal_proof" class="def variant constructor anchored"><a href="#type-input_proof.Reveal_proof" class="anchor"></a><code><span>| </span><span><span class="constructor">Reveal_proof</span> <span class="keyword">of</span> <a href="#type-reveal_proof">reveal_proof</a></span></code></li><li id="type-input_proof.First_inbox_message" class="def variant constructor anchored"><a href="#type-input_proof.First_inbox_message" class="anchor"></a><code><span>| </span><span><span class="constructor">First_inbox_message</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'proof t</span></span><span> = </span><span>{</span></code><ol><li id="type-t.pvm_step" class="def record field anchored"><a href="#type-t.pvm_step" class="anchor"></a><code><span>pvm_step : <span class="type-var">'proof</span>;</span></code></li><li id="type-t.input_proof" class="def record field anchored"><a href="#type-t.input_proof" class="anchor"></a><code><span>input_proof : <span><a href="#type-input_proof">input_proof</a> option</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-serialized"><a href="#type-serialized" class="anchor"></a><code><span><span class="keyword">type</span> serialized</span><span> = <span class="keyword">private</span> string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-serialize_pvm_step"><a href="#val-serialize_pvm_step" class="anchor"></a><code><span><span class="keyword">val</span> serialize_pvm_step : 
  <span><span class="label">pvm</span>:<span><span>(<span class="type-var">'state</span>, <span class="type-var">'proof</span>, <span class="type-var">'output</span>)</span> <a href="../Sc_rollups/PVM/index.html#type-implementation">Sc_rollups.PVM.implementation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'proof</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-serialized">serialized</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>serialize_pvm_step ~pvm proof</code> turns a structured representation of a step proof of <code>pvm</code> into its serialized representation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-unserialize_pvm_step"><a href="#val-unserialize_pvm_step" class="anchor"></a><code><span><span class="keyword">val</span> unserialize_pvm_step : 
  <span><span class="label">pvm</span>:<span><span>(<span class="type-var">'state</span>, <span class="type-var">'proof</span>, <span class="type-var">'output</span>)</span> <a href="../Sc_rollups/PVM/index.html#type-implementation">Sc_rollups.PVM.implementation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-serialized">serialized</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'proof</span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>unserialize_pvm_step ~pvm proof</code> turns a serialized representation of a step proof of <code>pvm</code> into its structured representation.</p></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Sc_rollup_proof_check"><a href="#extension-decl-Sc_rollup_proof_check" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-error">Tezos_protocol_environment_016_PtMumbai.Error_monad.error</a> += </span></code><ol><li id="extension-Sc_rollup_proof_check" class="def variant extension anchored"><a href="#extension-Sc_rollup_proof_check" class="anchor"></a><code><span>| </span><span><span class="extension">Sc_rollup_proof_check</span> <span class="keyword">of</span> string</span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Sc_rollup_invalid_serialized_inbox_proof"><a href="#extension-decl-Sc_rollup_invalid_serialized_inbox_proof" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-error">Tezos_protocol_environment_016_PtMumbai.Error_monad.error</a> += </span></code><ol><li id="extension-Sc_rollup_invalid_serialized_inbox_proof" class="def variant extension anchored"><a href="#extension-Sc_rollup_invalid_serialized_inbox_proof" class="anchor"></a><code><span>| </span><span><span class="extension">Sc_rollup_invalid_serialized_inbox_proof</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-serialized_encoding"><a href="#val-serialized_encoding" class="anchor"></a><code><span><span class="keyword">val</span> serialized_encoding : 
  <span><a href="#type-serialized">serialized</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Data_encoding/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : 
  <span><span><a href="#type-serialized">serialized</a> <a href="#type-t">t</a></span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Data_encoding/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : 
  <span><a href="../../Tezos_protocol_environment_016_PtMumbai/Format/index.html#type-formatter">Tezos_protocol_environment_016_PtMumbai.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-start_of_pvm_step"><a href="#val-start_of_pvm_step" class="anchor"></a><code><span><span class="keyword">val</span> start_of_pvm_step : 
  <span><span class="label">pvm</span>:<span><span>(<span class="type-var">'state</span>, <span class="type-var">'proof</span>, <span class="type-var">'output</span>)</span> <a href="../Sc_rollups/PVM/index.html#type-implementation">Sc_rollups.PVM.implementation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'proof</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a></span></code></div><div class="spec-doc"><p>The state hash of the machine before the step. This must be checked against the value in the refutation game as well as checking the proof is valid.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-stop_of_pvm_step"><a href="#val-stop_of_pvm_step" class="anchor"></a><code><span><span class="keyword">val</span> stop_of_pvm_step : 
  <span><span class="label">pvm</span>:<span><span>(<span class="type-var">'state</span>, <span class="type-var">'proof</span>, <span class="type-var">'output</span>)</span> <a href="../Sc_rollups/PVM/index.html#type-implementation">Sc_rollups.PVM.implementation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'proof</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Sc_rollup_repr/State_hash/index.html#type-t">Sc_rollup_repr.State_hash.t</a></span></code></div><div class="spec-doc"><p>The state hash of the machine after the step. This must be checked against the value in the refutation game as well as checking the proof is valid.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-valid"><a href="#val-valid" class="anchor"></a><code><span><span class="keyword">val</span> valid : 
  <span><span class="label">pvm</span>:<span><span>(<span class="type-var">'state</span>, <span class="type-var">'proof</span>, <span class="type-var">'output</span>)</span> <a href="../Sc_rollups/PVM/index.html#type-implementation">Sc_rollups.PVM.implementation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">metadata</span>:<a href="../Sc_rollup_metadata_repr/index.html#type-t">Sc_rollup_metadata_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_inbox_repr/index.html#type-history_proof">Sc_rollup_inbox_repr.history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Dal_slot_repr/History/index.html#type-t">Dal_slot_repr.History.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Dal_slot_repr/index.html#type-parameters">Dal_slot_repr.parameters</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dal_attestation_lag</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'proof</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../Sc_rollup_PVM_sig/index.html#type-input">Sc_rollup_PVM_sig.input</a> option</span> * <a href="../Sc_rollup_PVM_sig/index.html#type-input_request">Sc_rollup_PVM_sig.input_request</a>)</span>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Lwt/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Check the validity of a proof.</p><p>This function requires a few bits of data (available from the refutation game record in the storage):</p><ul><li>a snapshot of the inbox, that may be used by the <code>input</code> proof in case it's an inbox message ;</li></ul><ul><li>a snapshot of the DAL confirmed slots structure, that may be used by the <code>input</code> proof in case the input is a DAL page ;</li></ul><ul><li>the inbox level of the commitment, used to determine if an output from the <code>input</code> proof is too recent to be allowed into the PVM proof ;</li></ul><ul><li>DAL parameters and <code>dal_attestation_lag</code>, to be able to check the page content membership to a slot if needed ;</li></ul><ul><li>the <code>pvm_name</code>, used to check that the proof given has the right PVM kind.</li></ul><p>It also returns the optional input executed during the proof and the input_request for the state at the beginning of the proof.</p></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-PVM_with_context_and_state"><a href="#module-type-PVM_with_context_and_state" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-PVM_with_context_and_state/index.html">PVM_with_context_and_state</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-produce"><a href="#val-produce" class="anchor"></a><code><span><span class="keyword">val</span> produce : 
  <span><span class="label">metadata</span>:<a href="../Sc_rollup_metadata_repr/index.html#type-t">Sc_rollup_metadata_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="module-type-PVM_with_context_and_state/index.html">PVM_with_context_and_state</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="#type-serialized">serialized</a> <a href="#type-t">t</a></span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Lwt/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>produce ~metadata pvm_and_state inbox_context inbox_history
    commit_inbox_level</code> will construct a full refutation game proof out of the <code>state</code> given in <code>pvm_and_state</code>. It uses the <code>inbox</code> if necessary to provide input in the proof. If the input is above or at <code>commit_level</code> it will block it, and produce a proof that the PVM is blocked. If the input requested is a reveal the proof production will also fail.</p><p>This will fail if any of the <code>context</code>, <code>inbox_context</code>, <code>inbox_history</code> or <code>dal_slots_history_cache</code> given doesn't have enough data to make the proof. For example, the 'protocol implementation' version of each PVM won't be able to run this function. Similarly, the version of the inbox stored in the L1 won't be enough because it forgets old levels.</p><p>This uses the <code>name</code> in the <code>pvm_and_state</code> module to produce an encodable <code>wrapped_proof</code> if possible. See the <code>wrap_proof</code> function in <code>Sc_rollups</code>.</p><p>It also need the <code>metadata</code> if it produces a proof for the <code>Needs_metadata</code> state.</p></div></div></div></body></html>
