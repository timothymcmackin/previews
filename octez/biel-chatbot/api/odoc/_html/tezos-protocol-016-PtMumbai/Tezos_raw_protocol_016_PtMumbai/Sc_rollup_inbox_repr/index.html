<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sc_rollup_inbox_repr (tezos-protocol-016-PtMumbai.Tezos_raw_protocol_016_PtMumbai.Sc_rollup_inbox_repr)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-016-PtMumbai</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_016_PtMumbai</a> &#x00BB; Sc_rollup_inbox_repr</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_016_PtMumbai.Sc_rollup_inbox_repr</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#overview">Overview</a></li><li><a href="#inbox-messages">Inbox messages</a></li><li><a href="#merkelization-of-the-inbox">Merkelization of the inbox</a></li><li><a href="#a-level-indexed-chain-of-inboxes">A level-indexed chain of inboxes</a></li><li><a href="#clients">Clients</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Inbox_proof_error"><a href="#extension-decl-Inbox_proof_error" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-error">Tezos_protocol_environment_016_PtMumbai.Error_monad.error</a> += </span></code><ol><li id="extension-Inbox_proof_error" class="def variant extension anchored"><a href="#extension-Inbox_proof_error" class="anchor"></a><code><span>| </span><span><span class="extension">Inbox_proof_error</span> <span class="keyword">of</span> string</span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Inbox_level_reached_messages_limit"><a href="#extension-decl-Inbox_level_reached_messages_limit" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-error">Tezos_protocol_environment_016_PtMumbai.Error_monad.error</a> += </span></code><ol><li id="extension-Inbox_level_reached_messages_limit" class="def variant extension anchored"><a href="#extension-Inbox_level_reached_messages_limit" class="anchor"></a><code><span>| </span><span><span class="extension">Inbox_level_reached_messages_limit</span></span></code></li></ol></div></div><p>Merkelizing inbox for smart-contract rollups.</p><h2 id="overview"><a href="#overview" class="anchor"></a>Overview</h2><p>The inbox of a smart-contract rollup denotes the incoming messages of the rollup. This inbox is the source of truth about what operations are being published and have an effect on the rollup state. As such, the inbox completely determines the state of the rollup. Hence, if two claims disagree about the state of the rollup, there are only two possibilities: either these two claims correspond to two distinct interpretations of the same inbox ; or, these two claims differ on their views about the contents of the inbox itself. <a href="../Sc_rollup_PVM_sig/index.html"><code>Sc_rollup_PVM_sig</code></a> is meant to arbitrate the first kind of conflicts while <code>Sc_rollup_inbox</code> focuses on the second kind of conflicts.</p><h2 id="inbox-messages"><a href="#inbox-messages" class="anchor"></a>Inbox messages</h2><p>A message is a chunk of bytes. Messages are indexed using natural numbers and the level they are introduced.</p><p>A message is said to be *consumed* when its processing has been cemented, that is, when no refutation about its insertion can happen anymore because the commitment that describes the effect of this message on the state is cemented. A message is said to be *available* (for dispute) if it is not consumed.</p><p>A message processed by the rollup can be consumed or available. A message unprocessed by the rollup is always available.</p><p>The number of messages in an inbox level is bounded by <a href="../Constants_repr/index.html#val-sc_rollup_max_number_of_messages_per_level"><code>Constants_repr.sc_rollup_max_number_of_messages_per_level</code></a> When a level inbox reaches the maximum number of messages in the inbox level, the inbox is said to be full and cannot accept more messages at this level. This limitation is meant to ensure that Merkle proofs about the inbox contents have a bounded size. (See next section.)</p><h2 id="merkelization-of-the-inbox"><a href="#merkelization-of-the-inbox" class="anchor"></a>Merkelization of the inbox</h2><p>As for the state of the <a href="../Sc_rollup_PVM_sig/index.html"><code>Sc_rollup_PVM_sig</code></a>, the layer 1 does not have to store the entire inbox but only a compressed form (typically a low number of hashes) that witnesses its contents, so that the protocol can check the validity of a proof about its contents. This saves space in the context of the layer 1 and is sufficient for the layer 1 to provide a source of truth about the contents of the inbox at the current level.</p><h2 id="a-level-indexed-chain-of-inboxes"><a href="#a-level-indexed-chain-of-inboxes" class="anchor"></a>A level-indexed chain of inboxes</h2><p>By design, inboxes are logically indexed by Tezos levels. This is required to have a simple way to decide if two commitments are in conflict. (See <a href="../Sc_rollup_storage/index.html"><code>Sc_rollup_storage</code></a>.)</p><p>A commitment included in the block at level L describes the effect of the messages of the inboxes with a level between a starting level L_0 and a stopping level L_1, both strictly inferior to L. The level L_0 must be the inbox level of its parent commitment.</p><p>To be valid, a commitment needs to prove that it is reading messages from an inbox which is consistent with the inbox at level L stored in the layer 1 context. So, it should be possible at any time to build a proof that a given inbox is a previous version at level L_1 of the inbox found at level L: these are called inclusion proofs.</p><h2 id="clients"><a href="#clients" class="anchor"></a>Clients</h2><p>This module is meant to be used both by the protocol and by the rollup node in order to maintain consistent inboxes on both sides. These two clients slightly differ on the amount of information they store about the inbox.</p><p>On the one hand, to reduce the space consumption of rollups on the chain storage, the protocol only stores metadata about the inbox. The messages' hash of the current level are kept in memory during block validation only (See <a href="../Raw_context/Sc_rollup_in_memory_inbox/index.html"><code>Raw_context.Sc_rollup_in_memory_inbox</code></a>). By contrast, the messages of the previous levels are not kept in the context at all. They can be retrieved from the chain history though. However, being absent from the context, they are not accessible to the protocol.</p><p>On the other hand, the rollup node must keep a more precise inbox to be able to produce Merkle proofs about the content of specific messages, at least during the refutation period.</p><p>To cope with the discrepancy of requirements in terms of inbox storage while preserving a consistent Merkelization between the protocol and the rollup node, this module exposes the functions used to merkelize the inbox with an history (See <code>History_bounded_repr.t</code>) as parameters to remember.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Hash"><a href="#module-Hash" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Hash/index.html">Hash</a></span><span> : <a href="../../Tezos_protocol_environment_016_PtMumbai/S/module-type-HASH/index.html">Tezos_protocol_environment_016_PtMumbai.S.HASH</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Skip_list"><a href="#module-Skip_list" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Skip_list/index.html">Skip_list</a></span><span> : <a href="../Skip_list_repr/module-type-S/index.html">Skip_list_repr.S</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-V1"><a href="#module-V1" class="anchor"></a><code><span><span class="keyword">module</span> <a href="V1/index.html">V1</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-include"><div class="spec-doc"><p>Versioning, see <a href="../Sc_rollup_data_version_sig/module-type-S/index.html"><code>Sc_rollup_data_version_sig.S</code></a> for more information.</p></div><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../Sc_rollup_data_version_sig/module-type-S/index.html">Sc_rollup_data_version_sig.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../Sc_rollup_data_version_sig/module-type-S/index.html#type-t">t</a> = <a href="V1/index.html#type-t">V1.t</a></span></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-versioned"><a href="#type-versioned" class="anchor"></a><code><span><span class="keyword">type</span> versioned</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-versioned_encoding"><a href="#val-versioned_encoding" class="anchor"></a><code><span><span class="keyword">val</span> versioned_encoding : 
  <span><a href="#type-versioned">versioned</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Data_encoding/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_versioned"><a href="#val-of_versioned" class="anchor"></a><code><span><span class="keyword">val</span> of_versioned : <span><a href="#type-versioned">versioned</a> <span class="arrow">&#45;&gt;</span></span> <a href="V1/index.html#type-t">V1.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_versioned"><a href="#val-to_versioned" class="anchor"></a><code><span><span class="keyword">val</span> to_versioned : <span><a href="V1/index.html#type-t">V1.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-versioned">versioned</a></span></code></div></div></details></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <a href="V1/index.html">V1</a>
  <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="V1/index.html#type-level_proof">level_proof</a> = <a href="V1/index.html#type-level_proof">V1.level_proof</a></span>
   <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="V1/index.html#type-history_proof">history_proof</a> = <a href="V1/index.html#type-history_proof">V1.history_proof</a></span>
   <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="V1/index.html#type-t">t</a> = <a href="V1/index.html#type-t">V1.t</a></span></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-level_proof"><a href="#type-level_proof" class="anchor"></a><code><span><span class="keyword">type</span> level_proof</span><span> = <a href="V1/index.html#type-level_proof">V1.level_proof</a></span><span> = </span><span>{</span></code><ol><li id="type-level_proof.hash" class="def record field anchored"><a href="#type-level_proof.hash" class="anchor"></a><code><span>hash : <a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/Hash/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.Hash.t</a>;</span></code></li><li id="type-level_proof.level" class="def record field anchored"><a href="#type-level_proof.level" class="anchor"></a><code><span>level : <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-history_proof"><a href="#type-history_proof" class="anchor"></a><code><span><span class="keyword">type</span> history_proof</span><span> = <a href="V1/index.html#type-history_proof">V1.history_proof</a></span></code></div><div class="spec-doc"><p>A <code>history_proof</code> is a <code>Skip_list.cell</code> that stores multiple hashes. <code>Skip_list.content history_proof</code> gives the hash of this cell, while <code>Skip_list.back_pointers history_proof</code> is an array of hashes of earlier <code>history_proof</code>s in the inbox.</p><p>On the one hand, we think of this type as representing the whole Merkle structure of an inbox at a given level---it is the part of <a href="#type-t"><code>t</code></a> above that can actually be used to prove things (it cannot be forged by a malicious node because it much match the hash stored by the L1).</p><p>On the other hand, we think of this type as representing a single proof-step back through the history of the inbox; given a hash that appears at some point later in the inbox this type proves that that hash points to this particular combination of a level tree and further back-pointers.</p><p>In terms of size, this type is a small set of hashes; one for the current level tree and `O(log2(ix))` in the back-pointers, where <code>ix</code> is the index of the cell in the skip list. That is, <code>ix</code> is the number of non-empty levels between now and the origination level of the rollup.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="V1/index.html#type-t">V1.t</a></span><span> = </span><span>{</span></code><ol><li id="type-t.level" class="def record field anchored"><a href="#type-t.level" class="anchor"></a><code><span>level : <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>;</span></code></li><li id="type-t.old_levels_messages" class="def record field anchored"><a href="#type-t.old_levels_messages" class="anchor"></a><code><span>old_levels_messages : <a href="#type-history_proof">history_proof</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The type of the inbox for a smart-contract rollup as stored by the protocol in the context. Values that inhabit this type only act as fingerprint for inboxes and contain:</p><ul><li><code>level</code> : the inbox level ;</li><li><code>old_levels_messages</code> : a witness of the inbox history.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><a href="../../Tezos_protocol_environment_016_PtMumbai/Format/index.html#type-formatter">Tezos_protocol_environment_016_PtMumbai.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="Hash/index.html#type-t">Hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Data_encoding/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inbox_level"><a href="#val-inbox_level" class="anchor"></a><code><span><span class="keyword">val</span> inbox_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a></span></code></div><div class="spec-doc"><p><code>inbox_level inbox</code> returns the maximum level of message insertion in <code>inbox</code> or its initial level.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-History"><a href="#module-History" class="anchor"></a><code><span><span class="keyword">module</span> <a href="History/index.html">History</a></span><span> : 
  <a href="../Bounded_history_repr/module-type-S/index.html">Bounded_history_repr.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../Bounded_history_repr/module-type-S/index.html#type-key">key</a> = <a href="Hash/index.html#type-t">Hash.t</a></span> <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../Bounded_history_repr/module-type-S/index.html#type-value">value</a> = <a href="#type-history_proof">history_proof</a></span></span></code></div><div class="spec-doc"><p>A <code>History.t</code> is basically a lookup table of <a href="#type-history_proof"><code>history_proof</code></a>s. We need this if we want to produce inbox proofs because it allows us to dereference the 'pointer' hashes in any of the <code>history_proof</code>s. This <code>deref</code> function is passed to <code>Skip_list.back_path</code> or <code>Skip_list.search</code> to allow these functions to construct valid paths back through the skip list.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_history_proof"><a href="#val-pp_history_proof" class="anchor"></a><code><span><span class="keyword">val</span> pp_history_proof : 
  <span><a href="../../Tezos_protocol_environment_016_PtMumbai/Format/index.html#type-formatter">Tezos_protocol_environment_016_PtMumbai.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-history_proof_encoding"><a href="#val-history_proof_encoding" class="anchor"></a><code><span><span class="keyword">val</span> history_proof_encoding : 
  <span><a href="#type-history_proof">history_proof</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Data_encoding/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal_history_proof"><a href="#val-equal_history_proof" class="anchor"></a><code><span><span class="keyword">val</span> equal_history_proof : <span><a href="#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-old_levels_messages"><a href="#val-old_levels_messages" class="anchor"></a><code><span><span class="keyword">val</span> old_levels_messages : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-history_proof">history_proof</a></span></code></div><div class="spec-doc"><p><code>old_levels_messages inbox</code> returns the latest skip list cell of the inbox history that is not up to change (i.e. not the current level tree).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current_witness"><a href="#val-current_witness" class="anchor"></a><code><span><span class="keyword">val</span> current_witness : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/Hash/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.Hash.t</a></span></code></div><div class="spec-doc"><p><code>current_witness inbox</code> returns the current witness of the inbox, i.e. the merkelized payload hash.</p></div></div></details></div><div class="odoc-spec"><div class="spec type anchored" id="type-serialized_proof"><a href="#type-serialized_proof" class="anchor"></a><code><span><span class="keyword">type</span> serialized_proof</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-serialized_proof_encoding"><a href="#val-serialized_proof_encoding" class="anchor"></a><code><span><span class="keyword">val</span> serialized_proof_encoding : 
  <span><a href="#type-serialized_proof">serialized_proof</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Data_encoding/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_all_messages"><a href="#val-add_all_messages" class="anchor"></a><code><span><span class="keyword">val</span> add_all_messages : 
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Tezos_protocol_environment_016_PtMumbai/Time/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Tezos_protocol_environment_016_PtMumbai/Block_hash/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="History/index.html#type-t">History.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Sc_rollup_inbox_message_repr/index.html#type-t">Sc_rollup_inbox_message_repr.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/History/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.History.t</a>
   * <a href="History/index.html#type-t">History.t</a>
   * <a href="#type-t">t</a>
   * <a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.t</a>
   * <span><a href="../Sc_rollup_inbox_message_repr/index.html#type-t">Sc_rollup_inbox_message_repr.t</a> list</span>)</span>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>add_all_messages history inbox messages</code> starts a new inbox level, adds all the <code>messages</code>, then ends the inbox level. It can be called even if <code>payloads</code> is empty.</p><p>Remembers everything needed in a created <code>payloads_history</code> and <code>history</code>. It is meant to be used by the rollup-node to reduce the risk of de-synchronisation between the protocol and the node.</p><p>Adds the messages pushed by the protocol and returns a list of messages including them. The caller will need to execute this list of messages, otherwise, it might miss some internal inputs.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_messages_no_history"><a href="#val-add_messages_no_history" class="anchor"></a><code><span><span class="keyword">val</span> add_messages_no_history : 
  <span><span><a href="../Sc_rollup_inbox_message_repr/index.html#type-serialized">Sc_rollup_inbox_message_repr.serialized</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.t</a>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>add_messages_no_history payloads witness</code> updates the <code>witness</code> by inserting the <code>payloads</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-take_snapshot"><a href="#val-take_snapshot" class="anchor"></a><code><span><span class="keyword">val</span> take_snapshot : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-history_proof">history_proof</a></span></code></div><div class="spec-doc"><p>Used at the beginning of a refutation game to create the snapshot against which proofs in that game must be valid.</p><p>One important note: It takes the snapshot of the inbox for the current level. The snapshot points to the inbox at the *beginning* of the current block level. This prevents to create a mid-level snapshot for a refutation game if new messages are added before and/or after in the same block.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-inclusion_proof"><a href="#type-inclusion_proof" class="anchor"></a><code><span><span class="keyword">type</span> inclusion_proof</span></code></div><div class="spec-doc"><p>Given a inbox <code>A</code> at some level <code>L</code> and another inbox <code>B</code> at some level <code>L'
    &gt;= L</code>, an <code>inclusion_proof</code> guarantees that <code>A</code> is an older version of <code>B</code>.</p><p>To be more precise, an <code>inclusion_proof</code> guarantees that the previous levels <code>level_tree</code>s of <code>A</code> are included in the previous levels <code>level_tree</code>s of <code>B</code>. The current <code>level_tree</code> of <code>A</code> and <code>B</code> are not considered.</p><p>The size of this proof is O(log2 (L' - L)).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inclusion_proof_encoding"><a href="#val-inclusion_proof_encoding" class="anchor"></a><code><span><span class="keyword">val</span> inclusion_proof_encoding : 
  <span><a href="#type-inclusion_proof">inclusion_proof</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Data_encoding/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_inclusion_proof"><a href="#val-pp_inclusion_proof" class="anchor"></a><code><span><span class="keyword">val</span> pp_inclusion_proof : 
  <span><a href="../../Tezos_protocol_environment_016_PtMumbai/Format/index.html#type-formatter">Tezos_protocol_environment_016_PtMumbai.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-inclusion_proof">inclusion_proof</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-number_of_proof_steps"><a href="#val-number_of_proof_steps" class="anchor"></a><code><span><span class="keyword">val</span> number_of_proof_steps : <span><a href="#type-inclusion_proof">inclusion_proof</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>number_of_proof_steps proof</code> returns the length of <code>proof</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-verify_inclusion_proof"><a href="#val-verify_inclusion_proof" class="anchor"></a><code><span><span class="keyword">val</span> verify_inclusion_proof : 
  <span><a href="#type-inclusion_proof">inclusion_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-history_proof">history_proof</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>verify_inclusion_proof proof snapshot</code> returns <code>A</code> iff <code>proof</code> is a minimal and valid proof that <code>A</code> is included in <code>snapshot</code>, fails otherwise. <code>A</code> is part of the proof.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-proof"><a href="#type-proof" class="anchor"></a><code><span><span class="keyword">type</span> proof</span></code></div><div class="spec-doc"><p>An inbox proof has three parameters:</p><ul><li>the <code>starting_point</code>, of type <code>Raw_level_repr.t * Z.t</code>, specifying a location in the inbox ;</li></ul><ul><li>the <code>message</code>, of type <code>Sc_rollup_PVM_sig.input option</code> ;</li></ul><ul><li>and a reference <code>snapshot</code> inbox.</li></ul><p>A valid inbox proof implies the following semantics: beginning at <code>starting_point</code> and reading forward through <code>snapshot</code>, the first message you reach will be <code>message</code>.</p><p>Usually this is fairly simple because there will actually be a message at the location specified by <code>starting_point</code>. But in some cases <code>starting_point</code> is past the last message within a level, and then the inbox proof's verification assumes that the next input is the SOL of the next level, if not beyond the snapshot.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_proof"><a href="#val-pp_proof" class="anchor"></a><code><span><span class="keyword">val</span> pp_proof : 
  <span><a href="../../Tezos_protocol_environment_016_PtMumbai/Format/index.html#type-formatter">Tezos_protocol_environment_016_PtMumbai.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_serialized_proof"><a href="#val-to_serialized_proof" class="anchor"></a><code><span><span class="keyword">val</span> to_serialized_proof : <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-serialized_proof">serialized_proof</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_serialized_proof"><a href="#val-of_serialized_proof" class="anchor"></a><code><span><span class="keyword">val</span> of_serialized_proof : <span><a href="#type-serialized_proof">serialized_proof</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-proof">proof</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-verify_proof"><a href="#val-verify_proof" class="anchor"></a><code><span><span class="keyword">val</span> verify_proof : 
  <span><span>(<a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> * <a href="../../Tezos_protocol_environment_016_PtMumbai/Z/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Z.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Sc_rollup_PVM_sig/index.html#type-inbox_message">Sc_rollup_PVM_sig.inbox_message</a> option</span>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p>See the docstring for the <code>proof</code> type for details of proof semantics.</p><p><code>verify_proof starting_point inbox_snapshot proof</code> will return the third parameter of the proof, <code>message</code>, iff the proof is valid.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-produce_proof"><a href="#val-produce_proof" class="anchor"></a><code><span><span class="keyword">val</span> produce_proof : 
  <span><span class="label">get_payloads_history</span>:
    <span>(<span><a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/Hash/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.Hash.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/History/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.History.t</a>
        <a href="../../Tezos_protocol_environment_016_PtMumbai/Lwt/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Lwt.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">get_history</span>:
    <span>(<span><a href="Hash/index.html#type-t">Hash.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="#type-history_proof">history_proof</a> option</span> <a href="../../Tezos_protocol_environment_016_PtMumbai/Lwt/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Lwt.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> * <a href="../../Tezos_protocol_environment_016_PtMumbai/Z/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Z.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-proof">proof</a> * <span><a href="../Sc_rollup_PVM_sig/index.html#type-inbox_message">Sc_rollup_PVM_sig.inbox_message</a> option</span>)</span>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Lwt/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>produce_proof ~get_payloads_history ~get_history inbox (level, counter)</code> creates an inbox proof proving the first message after the index <code>counter</code> at location <code>level</code>. This will fail if the <code>get_payloads_history</code> given doesn't have sufficient data (it needs to be run on an with a full history).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_witness_no_history"><a href="#val-init_witness_no_history" class="anchor"></a><code><span><span class="keyword">val</span> init_witness_no_history : <a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.t</a></span></code></div><div class="spec-doc"><p><code>init_witness_no_history</code> initializes the witness for a new inbox level by adding the first input, i.e. <code>Start_of_level</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_info_per_level_no_history"><a href="#val-add_info_per_level_no_history" class="anchor"></a><code><span><span class="keyword">val</span> add_info_per_level_no_history : 
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Tezos_protocol_environment_016_PtMumbai/Time/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Tezos_protocol_environment_016_PtMumbai/Block_hash/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.t</a>
    <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>add_info_per_level_no_history</code> adds the input <code>Info_per_level</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_inbox_level_no_history"><a href="#val-finalize_inbox_level_no_history" class="anchor"></a><code><span><span class="keyword">val</span> finalize_inbox_level_no_history : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_inbox_merkelized_payload_hashes_repr/index.html#type-t">Sc_rollup_inbox_merkelized_payload_hashes_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>finalize_inbox_level payloads_history history inbox level_witness</code> updates the current inbox's level witness by adding <code>EOL</code>, and archives the current level.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-genesis"><a href="#val-genesis" class="anchor"></a><code><span><span class="keyword">val</span> genesis : 
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Tezos_protocol_environment_016_PtMumbai/Time/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Tezos_protocol_environment_016_PtMumbai/Block_hash/index.html#type-t">Tezos_protocol_environment_016_PtMumbai.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../Tezos_protocol_environment_016_PtMumbai/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_016_PtMumbai.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>genesis ~timestamp ~predecessor level</code> initializes the inbox at some given <code>level</code> with: SOL, Info_per_level </p><table class="odoc-table"><tr><td><p>imestamp; predecessor</p></td></tr></table><p>and EOL inside.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-inbox"><a href="#type-inbox" class="anchor"></a><code><span><span class="keyword">type</span> inbox</span><span> = <a href="#type-t">t</a></span></code></div></div></div></body></html>
