<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>History (tezos-protocol-018-Proxford.Tezos_raw_protocol_018_Proxford.Dal_slot_repr.History)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">tezos-protocol-018-Proxford</a> &#x00BB; <a href="../../index.html">Tezos_raw_protocol_018_Proxford</a> &#x00BB; <a href="../index.html">Dal_slot_repr</a> &#x00BB; History</nav><header class="odoc-preamble"><h1>Module <code><span>Dal_slot_repr.History</span></code></h1><p>This module provides an abstract data structure (type <a href="#type-t"><code>History.t</code></a>) that represents a skip list used to store successive DAL slots confirmed/attested on L1. There is one slot per cell in the skip list. The slots are sorted in increasing order by level, and by slot index, for the slots of the same level.</p><p>This module also defines a bounded history cache (type <code>History.History_cache.t</code>) that allows to remember recent values of a skip list of type <a href="#type-t"><code>History.t</code></a> (indexed by the skip lists' hashes). This structure is meant to be maintained and used by the rollup node to produce refutation proofs involving DAL slot inputs.</p><p>Note on terminology: &quot;confirmed slot&quot; is another name for &quot;attested slot&quot;.</p></header><nav class="odoc-toc"><ul><li><a href="#dal-slots/pages-proofs">Dal slots/pages proofs</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Abstract representation of a skip list specialized for confirmed slot headers.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Pointer_hash"><a href="#module-Pointer_hash" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Pointer_hash/index.html">Pointer_hash</a></span><span> : <a href="../../../Tezos_protocol_environment_018_Proxford/S/module-type-HASH/index.html">Tezos_protocol_environment_018_Proxford.S.HASH</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-hash"><a href="#type-hash" class="anchor"></a><code><span><span class="keyword">type</span> hash</span><span> = <a href="Pointer_hash/index.html#type-t">Pointer_hash.t</a></span></code></div><div class="spec-doc"><p>Type of hashes of history.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : <span><a href="#type-t">t</a> <a href="../../../Tezos_protocol_environment_018_Proxford/Data_encoding/index.html#type-t">Tezos_protocol_environment_018_Proxford.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding of the datatype.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-genesis"><a href="#val-genesis" class="anchor"></a><code><span><span class="keyword">val</span> genesis : <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>First cell of this skip list.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-hash">hash</a></span></code></div><div class="spec-doc"><p>Returns the hash of an history.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-History_cache"><a href="#module-History_cache" class="anchor"></a><code><span><span class="keyword">module</span> <a href="History_cache/index.html">History_cache</a></span><span> : 
  <a href="../../Bounded_history_repr/module-type-S/index.html">Bounded_history_repr.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../Bounded_history_repr/module-type-S/index.html#type-key">key</a> = <a href="#type-hash">hash</a></span> <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../Bounded_history_repr/module-type-S/index.html#type-value">value</a> = <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p>The <code>History_cache.t</code> structure is basically a bounded lookup table of <a href="#type-t"><code>t</code></a> skip lists. (See <a href="../../Bounded_history_repr/module-type-S/index.html"><code>Bounded_history_repr.S</code></a>). In the L1 layer, the capacity (bound) is set to zero (nothing is remembered). By contrast, the rollup node uses a history cache with a (sufficiently) large capacity to participate in all potential refutation games occurring during the challenge period. Indeed, the successive recent skip-lists stored in the cache are needed to produce proofs involving slots' pages.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_confirmed_slot_headers"><a href="#val-add_confirmed_slot_headers" class="anchor"></a><code><span><span class="keyword">val</span> add_confirmed_slot_headers : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="History_cache/index.html#type-t">History_cache.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Header/index.html#type-t">Header.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-t">t</a> * <a href="History_cache/index.html#type-t">History_cache.t</a>)</span>
    <a href="../../../Tezos_protocol_environment_018_Proxford/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_018_Proxford.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>add_confirmed_slots hist cache slot_headers</code> updates the given structure <code>hist</code> with the list of <code>slot_headers</code>. The given <code>cache</code> is also updated to add successive values of <code>cell</code> to it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_confirmed_slot_headers_no_cache"><a href="#val-add_confirmed_slot_headers_no_cache" class="anchor"></a><code><span><span class="keyword">val</span> add_confirmed_slot_headers_no_cache : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Header/index.html#type-t">Header.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <a href="../../../Tezos_protocol_environment_018_Proxford/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_018_Proxford.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>add_confirmed_slot_headers_no_cache cell slot_headers</code> same as <a href="#val-add_confirmed_slot_headers"><code>add_confirmed_slot_headers</code></a>, but no cache is updated.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>equal a b</code> returns true iff a is equal to b.</p></div></div><h2 id="dal-slots/pages-proofs"><a href="#dal-slots/pages-proofs" class="anchor"></a>Dal slots/pages proofs</h2><div class="odoc-spec"><div class="spec type anchored" id="type-proof"><a href="#type-proof" class="anchor"></a><code><span><span class="keyword">type</span> proof</span></code></div><div class="spec-doc"><p>When a SCORU kernel's inputs come from the DAL, they are provided as pages' content for confirmed slots, or None in case the slot doesn't exist or is not confirmed.</p><p>In a refutation game involving an import tick of a Dal page input, a honest user should be able to provide:</p><ul><li>When the PVM is requesting a page of a confirmed slot: a proof that the slot is confirmed, in addition to needed information to check that the page (whose id and content are given) is part of the slot;</li></ul><ul><li>When the opponent pretends that the PVM is requesting a page of some unconfirmed slot, but that slot is not published or not confirmed on L1: a proof that the slot (whose id is given via the page's id) cannot be confirmed on L1.</li></ul><p>See the documentation in the ml file for more technical details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-proof_encoding"><a href="#val-proof_encoding" class="anchor"></a><code><span><span class="keyword">val</span> proof_encoding : 
  <span><a href="#type-proof">proof</a> <a href="../../../Tezos_protocol_environment_018_Proxford/Data_encoding/index.html#type-t">Tezos_protocol_environment_018_Proxford.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-proof"><code>proof</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_proof"><a href="#val-pp_proof" class="anchor"></a><code><span><span class="keyword">val</span> pp_proof : 
  <span><span class="label">serialized</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_protocol_environment_018_Proxford/Format/index.html#type-formatter">Tezos_protocol_environment_018_Proxford.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Pretty-printer for <a href="#type-proof"><code>proof</code></a>. If <code>serialized</code> is <code>false</code> it will print the abstracted proof representation, otherwise if it's <code>true</code> it will print the serialized version of the proof (i.e. a sequence of bytes).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-produce_proof"><a href="#val-produce_proof" class="anchor"></a><code><span><span class="keyword">val</span> produce_proof : 
  <span><a href="../index.html#type-parameters">parameters</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Page/index.html#type-t">Page.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">page_info</span>:<span><span>(<a href="../Page/index.html#type-content">Page.content</a> * <a href="../Page/index.html#type-proof">Page.proof</a>)</span> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">get_history</span>:<span>(<span><a href="#type-hash">hash</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-t">t</a> option</span> <a href="../../../Tezos_protocol_environment_018_Proxford/Lwt/index.html#type-t">Tezos_protocol_environment_018_Proxford.Lwt.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-proof">proof</a> * <span><a href="../Page/index.html#type-content">Page.content</a> option</span>)</span>
    <a href="../../../Tezos_protocol_environment_018_Proxford/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_018_Proxford.Error_monad.tzresult</a></span>
    <a href="../../../Tezos_protocol_environment_018_Proxford/Lwt/index.html#type-t">Tezos_protocol_environment_018_Proxford.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>produce_proof dal_parameters page_id page_info ~get_history slots_hist</code> produces a proof that either:</p><ul><li>there exists a confirmed slot in the skip list that contains the page identified by <code>page_id</code> whose data and slot inclusion proof are given by <code>page_info</code>, or</li><li>there cannot exist a confirmed slot in the skip list (whose head is given by <code>slots_hist</code>) containing the page identified by <code>page_id</code>.</li></ul><p>In the first case above, <code>page_info</code> should contain the page's content and the proof that the page is part of the (confirmed) slot whose id is given in <code>page_id</code>. In the second case, no page content or proof should be provided, as they are not needed to construct a non-confirmation proof.</p><p><code>dal_parameters</code> is used when verifying that/if the page is part of the candidate slot (if any).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-verify_proof"><a href="#val-verify_proof" class="anchor"></a><code><span><span class="keyword">val</span> verify_proof : 
  <span><a href="../index.html#type-parameters">parameters</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Page/index.html#type-t">Page.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Page/index.html#type-content">Page.content</a> option</span>
    <a href="../../../Tezos_protocol_environment_018_Proxford/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_018_Proxford.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>verify_proof dal_params page_id snapshot proof</code> verifies that the given <code>proof</code> is a valid proof to show that either:</p><ul><li>the page identified by <code>page_id</code> belongs to a confirmed slot stored in the skip list whose head is <code>snapshot</code>, or</li><li>there is not confirmed slot in the skip list (whose head is) <code>snapshot</code> that could contain the page identified by <code>page_id</code>.</li></ul><p><code>dal_parameters</code> is used when verifying that/if the page is part of the candidate slot (if any).</p></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Add_element_in_slots_skip_list_violates_ordering"><a href="#extension-decl-Add_element_in_slots_skip_list_violates_ordering" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../Tezos_protocol_environment_018_Proxford/Error_monad/index.html#type-error">Tezos_protocol_environment_018_Proxford.Error_monad.error</a> += </span></code><ol><li id="extension-Add_element_in_slots_skip_list_violates_ordering" class="def variant extension anchored"><a href="#extension-Add_element_in_slots_skip_list_violates_ordering" class="anchor"></a><code><span>| </span><span><span class="extension">Add_element_in_slots_skip_list_violates_ordering</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Dal_proof_error"><a href="#extension-decl-Dal_proof_error" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../Tezos_protocol_environment_018_Proxford/Error_monad/index.html#type-error">Tezos_protocol_environment_018_Proxford.Error_monad.error</a> += </span></code><ol><li id="extension-Dal_proof_error" class="def variant extension anchored"><a href="#extension-Dal_proof_error" class="anchor"></a><code><span>| </span><span><span class="extension">Dal_proof_error</span> <span class="keyword">of</span> string</span></code></li><li id="extension-Unexpected_page_size" class="def variant extension anchored"><a href="#extension-Unexpected_page_size" class="anchor"></a><code><span>| </span><span><span class="extension">Unexpected_page_size</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-History.expected_size" class="def record field anchored"><a href="#module-History.expected_size" class="anchor"></a><code><span>expected_size : int;</span></code></li><li id="module-History.page_size" class="def record field anchored"><a href="#module-History.page_size" class="anchor"></a><code><span>page_size : int;</span></code></li></ol><code><span>}</span></code></li></ol></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
