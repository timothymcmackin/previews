<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Validate_operation (tezos-protocol-014-PtKathma.Tezos_raw_protocol_014_PtKathma.Validate_operation)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-014-PtKathma</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_014_PtKathma</a> &#x00BB; Validate_operation</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_014_PtKathma.Validate_operation</span></code></h1><p>The purpose of this module is to provide the <a href="#val-validate_operation"><code>validate_operation</code></a> function, that decides quickly whether an operation may safely be included in a block. See the function's description for further information.</p><p>Most elements in this module are either used or wrapped in the <a href="../Main/index.html"><code>Main</code></a> module.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-validate_operation_info"><a href="#type-validate_operation_info" class="anchor"></a><code><span><span class="keyword">type</span> validate_operation_info</span></code></div><div class="spec-doc"><p>Static information needed in <a href="#val-validate_operation"><code>validate_operation</code></a>.</p><p>It lives in memory, not in the storage.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-validate_operation_state"><a href="#type-validate_operation_state" class="anchor"></a><code><span><span class="keyword">type</span> validate_operation_state</span></code></div><div class="spec-doc"><p>State used and modified by <a href="#val-validate_operation"><code>validate_operation</code></a>.</p><p>It lives in memory, not in the storage.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-mode"><a href="#type-mode" class="anchor"></a><code><span><span class="keyword">type</span> mode</span><span> = </span></code><ol><li id="type-mode.Block" class="def variant constructor anchored"><a href="#type-mode.Block" class="anchor"></a><code><span>| </span><span><span class="constructor">Block</span></span></code></li><li id="type-mode.Mempool" class="def variant constructor anchored"><a href="#type-mode.Mempool" class="anchor"></a><code><span>| </span><span><span class="constructor">Mempool</span></span></code></li></ol></div><div class="spec-doc"><p>Circumstances of the call to <a href="#val-validate_operation"><code>validate_operation</code></a>:</p><ul><li><code>Block</code>: called during the validation or application of a block (received from a peer of freshly constructed). Corresponds to <code>Application</code>, <code>Partial_application</code>, and <code>Full_construction</code> modes of <code>Main.validation_mode</code>.</li></ul><ul><li><code>Mempool</code>: called by the mempool (either directly or through the plugin). Corresponds to <code>Partial_construction</code> of <code>Main.validation_mode</code>.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_info_and_state"><a href="#val-init_info_and_state" class="anchor"></a><code><span><span class="keyword">val</span> init_info_and_state : 
  <span><a href="../Alpha_context/index.html#type-t">Alpha_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-mode">mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Chain_id/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-validate_operation_info">validate_operation_info</a> * <a href="#type-validate_operation_state">validate_operation_state</a></span></code></div><div class="spec-doc"><p>Initialize the <a href="#type-validate_operation_info"><code>validate_operation_info</code></a> and <a href="#type-validate_operation_state"><code>validate_operation_state</code></a> that are needed in <a href="#val-validate_operation"><code>validate_operation</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-stamp"><a href="#type-stamp" class="anchor"></a><code><span><span class="keyword">type</span> stamp</span></code></div><div class="spec-doc"><p>A receipt to guarantee that an operation is always validated before it is applied.</p><p>Indeed, some functions in <a href="../Apply/index.html"><code>Apply</code></a> require a value of this type, which may only be created by calling <a href="#val-validate_operation"><code>validate_operation</code></a> (or a function in <a href="TMP_for_plugin/index.html"><code>TMP_for_plugin</code></a>).</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Manager"><a href="#module-Manager" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Manager/index.html">Manager</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Errors that may arise while validating a manager operation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_operation"><a href="#val-validate_operation" class="anchor"></a><code><span><span class="keyword">val</span> validate_operation : 
  <span><a href="#type-validate_operation_info">validate_operation_info</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-validate_operation_state">validate_operation_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Operation_hash/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'kind</span> <a href="../Alpha_context/index.html#type-operation">Alpha_context.operation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-validate_operation_state">validate_operation_state</a> * <a href="#type-stamp">stamp</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Check the validity of the given operation; return an updated <a href="#type-validate_operation_state"><code>validate_operation_state</code></a>, and a <a href="#type-stamp"><code>stamp</code></a> attesting that the operation has been validated.</p><p>An operation is valid if it may be included in a block without causing the block's application to fail. The purpose of this function is to decide validity quickly, that is, without trying to actually apply the operation (ie. compute modifications to the context: see <a href="../Apply/index.html#val-apply_operation"><code>Apply.apply_operation</code></a>) and see whether it causes an error.</p><p>An operation's validity may be checked in different situations: when we receive a block from a peer or we are constructing a fresh block, we validate each operation in the block right before trying to apply it; when a mempool receives an operation, it validates it to decide whether the operation should be propagated (note that for now, this only holds for manager operations, since <code>validate_operation</code> is not impleted yet for other operations: see below). See <a href="#type-mode"><code>mode</code></a>.</p><p>The <code>validate_operation_info</code> contains every information we need about the status of the chain to validate an operation, notably the context (of type <code>Alpha_context.t</code>) at the end of the previous block. This context is never updated by the validation of operations, since validation is separate from application. Yet sometimes, the presence of some previous operations in a block or a mempool may render the current operation invalid. E.g. the one-operation-per-manager-per-block restriction (1M) states that a block is invalid if it contains two separate operations from the same manager; therefore the validation of an operation will return <code>Error Manager_restriction</code> if another operation by the same manager has already been validated in the same block or mempool. In order to track this kind of operation incompatibilities, we use a <code>validate_operation_state</code> with minimal information that gets updated during validation.</p><p>For a manager operation, validity is solvability, ie. it must be well-formed, and we need to be able to take its fees. Indeed, this is sufficient for the safe inclusion of the operation in a block: even if there is an error during the subsequent application of the manager operation, this will cause the operation to have no further effects, but won't impact the success of the block's application. The solvability of a manager operation notably includes it being correctly signed: indeed, we can't take anything from a manager without having checked their signature.</p><p>TODO: https://gitlab.com/tezos/tezos/-/issues/2603</p><p>This function currently does nothing for non-manager operations (instead, the validity of a non-manager operation is decided by calling <a href="../Apply/index.html#val-apply_operation"><code>Apply.apply_operation</code></a> to check whether it returns an error). We should specify and implement the validation of every kind of operation.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-TMP_for_plugin"><a href="#module-TMP_for_plugin" class="anchor"></a><code><span><span class="keyword">module</span> <a href="TMP_for_plugin/index.html">TMP_for_plugin</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Functions for the plugin.</p></div></div></div></body></html>
