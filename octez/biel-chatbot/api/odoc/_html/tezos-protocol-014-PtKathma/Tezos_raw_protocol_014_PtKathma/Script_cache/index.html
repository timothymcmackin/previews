<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Script_cache (tezos-protocol-014-PtKathma.Tezos_raw_protocol_014_PtKathma.Script_cache)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-014-PtKathma</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_014_PtKathma</a> &#x00BB; Script_cache</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_014_PtKathma.Script_cache</span></code></h1><p>This module manages the cache for smart contracts.</p><p>This cache must be consistent with the on-disk representation of the smart contracts. In particular, <code>update</code> must be called each time a contract storage is updated.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-identifier"><a href="#type-identifier" class="anchor"></a><code><span><span class="keyword">type</span> identifier</span></code></div><div class="spec-doc"><p>Each cached script has a unique identifier in the cache.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-cached_contract"><a href="#type-cached_contract" class="anchor"></a><code><span><span class="keyword">type</span> cached_contract</span><span> = <a href="../Alpha_context/Script/index.html#type-t">Alpha_context.Script.t</a> * <a href="../Script_ir_translator/index.html#type-ex_script">Script_ir_translator.ex_script</a></span></code></div><div class="spec-doc"><p>The cache holds the unparsed and the internal representation of the contract.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find"><a href="#val-find" class="anchor"></a><code><span><span class="keyword">val</span> find : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Contract_hash/index.html#type-t">Contract_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> * <a href="#type-identifier">identifier</a> * <span><a href="#type-cached_contract">cached_contract</a> option</span>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>find ctxt contract</code> returns <code>(ctxt', identifier, script)</code> where:</p><ul><li><code>ctxt'</code> is <code>ctxt</code> with less gas;</li><li><code>identifier</code> is the identifier identifying the <code>contract</code> in the cache;</li><li><code>script = None</code> if there is no such contract in <code>ctxt</code>;</li><li><code>script = Some (unparsed_script, ir_script)</code> where</li><li><code>unparsed_script</code> is the contract source code and storage;</li><li><code>script_ir</code> is a typed internal representation of the contract, i.e., the abstract syntax tree of its code as well as its storage.</li></ul><p>This function consumes gas depending on the cache. If the contract is not in the cache, then the function also consumes the gas of <code>Contract.get_script</code> and <code>Script_ir_translator.parse_script</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update"><a href="#val-update" class="anchor"></a><code><span><span class="keyword">val</span> update : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-identifier">identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-cached_contract">cached_contract</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>update ctxt identifier unparsed_script ir_script size</code> refreshes the cached contract identified by <code>identifier</code> with a new <code>unparsed_script</code>, a new <code>ir_script</code>, and a new size.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-entries"><a href="#val-entries" class="anchor"></a><code><span><span class="keyword">val</span> entries : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Contract_hash/index.html#type-t">Contract_hash.t</a> * int)</span> list</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>entries ctxt</code> returns the contracts in the cache as well as their respective size. The list is sorted by date of last modification: the least recently updated entry comes first.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-contract_rank"><a href="#val-contract_rank" class="anchor"></a><code><span><span class="keyword">val</span> contract_rank : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Contract_hash/index.html#type-t">Contract_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div><div class="spec-doc"><p><code>contract_rank ctxt contract</code> returns the number of contracts older than <code>contract</code> in the cache of <code>ctxt</code>. This function returns <code>None</code> if <code>contract</code> does not exist in the cache of <code>ctxt</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-size"><a href="#val-size" class="anchor"></a><code><span><span class="keyword">val</span> size : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>size ctxt</code> is an overapproximation of the cache size in memory (in bytes).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-size_limit"><a href="#val-size_limit" class="anchor"></a><code><span><span class="keyword">val</span> size_limit : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>size_limit ctxt</code> is the maximal size of the cache (in bytes).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-insert"><a href="#val-insert" class="anchor"></a><code><span><span class="keyword">val</span> insert : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Contract_hash/index.html#type-t">Contract_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-cached_contract">cached_contract</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>insert</code> is a variant of <code>update</code> which identifies the contract to update by its address (of type <code>Contract_hash.t</code>) instead of its cache identifier.</p></div></div></div></body></html>
