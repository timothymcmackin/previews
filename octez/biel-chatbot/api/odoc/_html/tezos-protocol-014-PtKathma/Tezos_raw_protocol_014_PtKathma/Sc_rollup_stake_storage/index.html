<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sc_rollup_stake_storage (tezos-protocol-014-PtKathma.Tezos_raw_protocol_014_PtKathma.Sc_rollup_stake_storage)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-014-PtKathma</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_014_PtKathma</a> &#x00BB; Sc_rollup_stake_storage</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_014_PtKathma.Sc_rollup_stake_storage</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-remove_staker"><a href="#val-remove_staker" class="anchor"></a><code><span><span class="keyword">val</span> remove_staker : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/Staker/index.html#type-t">Sc_rollup_repr.Staker.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Receipt_repr/index.html#type-balance_updates">Receipt_repr.balance_updates</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>remove_staker context rollup staker</code> forcibly removes the given <code>staker</code> and confiscates their frozen deposits.</p><p>Any commitments no longer staked on are removed and storage reclaimed by <code>remove_staker</code>. Because of this there is no need to explicitly reject commitments.</p><p>May fail with:</p><ul><li><code>Sc_rollup_does_not_exist</code> if <code>rollup</code> does not exist</li><li><code>Sc_rollup_not_staked</code> if <code>staker</code> is not staked</li><li><code>Sc_rollup_remove_lcc</code> if <code>staker</code> is staked on a cemented commitment</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-publish_commitment"><a href="#val-publish_commitment" class="anchor"></a><code><span><span class="keyword">val</span> publish_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/Staker/index.html#type-t">Sc_rollup_repr.Staker.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/index.html#type-t">Sc_rollup_commitment_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Sc_rollup_commitment_repr.Hash.t</a>
   * <a href="../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a>
   * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>
   * <a href="../Receipt_repr/index.html#type-balance_updates">Receipt_repr.balance_updates</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>This is a wrapper around <code>deposit_stake</code> and <code>refine_stake</code> that deposits a stake and then refines it to the specified commitment, creating that commitment if necessary. Before calling <code>deposit_stake</code> it checks that the staker is not already staked, and if so will skip that step and go straight to calling <code>refine_stake</code>.</p><p>May fail with:</p><ul><li><code>Sc_rollup_does_not_exist</code> if <code>rollup</code> does not exist</li><li><code>Sc_rollup_too_far_ahead</code> if <code>staker</code> would be more than <code>sc_rollup_max_future_commitments</code> ahead of the Last Cemented Commitment</li><li><code>Sc_rollup_bad_inbox_level</code> if <code>commitment</code>'s predecessor is less than <code>sc_rollup_commitment_period</code> blocks ahead</li><li><code>Sc_rollup_staker_backtracked</code> if <code>staker</code> is not staked on an ancestor of <code>commitment</code></li><li><code>Sc_rollup_unknown_commitment</code> if the parent of the given commitment does not exist</li><li><code>Sc_rollup_staker_funds_too_low</code> if <code>staker</code> is not previously a staker, and does not have enough funds to cover the deposit</li></ul><p>Returns the hash of the given commitment, and the level when the commitment was first published by some staker.</p><p>This function does not authenticate the staker.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cement_commitment"><a href="#val-cement_commitment" class="anchor"></a><code><span><span class="keyword">val</span> cement_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Sc_rollup_commitment_repr.Hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>cement_commitment context rollup commitment</code> cements the given commitment.</p><p>Subsequent calls to <code>refine_stake</code> and <code>cement_commitment</code> must use a <code>context</code> with greater level, or behavior is undefined.</p><p>For cementing to succeed, the following must hold:</p><ol><li>The deadline for <code>commitment</code> must have passed.</li><li>The predecessor of <code>commitment</code> must be the Last Cemented Commitment.</li><li>There must be at least one staker.</li><li>All stakers must be indirectly staked on <code>commitment</code>.</li></ol><p>If successful, <code>last_cemented_commitment</code> is set to the given <code>commitment</code> and the appropriate amount of inbox messages is consumed. The old LCC is also deallocated.</p><p>May fail with:</p><ul><li><code>Sc_rollup_does_not_exist</code> if <code>rollup</code> does not exist</li><li><code>Sc_rollup_unknown_commitment</code> if <code>commitment</code> does not exist</li><li><code>Sc_rollup_parent_not_lcc</code> if <code>commitment</code> is not the child of the last cemented commitment</li><li><code>Sc_rollup_too_recent</code> if <code>commitment</code> has not passed its deadline</li><li><code>Sc_rollup_no_stakers</code> if there are zero stakers</li><li><code>Sc_rollup_disputed</code> if at least one staker is not staked on <code>commitment</code></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_staker"><a href="#val-find_staker" class="anchor"></a><code><span><span class="keyword">val</span> find_staker : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_014_PtKathma.Signature.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Sc_rollup_commitment_repr/Hash/index.html#type-t">Sc_rollup_commitment_repr.Hash.t</a> * <a href="../Raw_context/index.html#type-t">Raw_context.t</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>find_staker ctxt rollup staker</code> returns the branch on which the stake is deposited for the <code>rollup</code>'s <code>staker</code>.</p><p>May fail with <code>Sc_rollup_not_staked</code> if <code>staker</code> is not staked.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-commitment_storage_size_in_bytes"><a href="#val-commitment_storage_size_in_bytes" class="anchor"></a><code><span><span class="keyword">val</span> commitment_storage_size_in_bytes : int</span></code></div><div class="spec-doc"><p>The storage size requirement (in bytes) of a commitment</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-withdraw_stake"><a href="#val-withdraw_stake" class="anchor"></a><code><span><span class="keyword">val</span> withdraw_stake : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Sc_rollup_repr/Staker/index.html#type-t">Sc_rollup_repr.Staker.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Receipt_repr/index.html#type-balance_updates">Receipt_repr.balance_updates</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>withdraw_stake context rollup staker</code> removes <code>staker</code> and returns any deposit previously frozen by <code>deposit_stake</code>.</p><p>May fail with:</p><ul><li><code>Sc_rollup_does_not_exist</code> if <code>rollup</code> does not exist</li><li><code>Sc_rollup_not_staked_on_lcc</code> if <code>staker</code> is not staked on the last cemented commitment</li></ul><p>Note that it is not possible to be staked on a Cemented commitment other than the Last, because of Cementation Rule #4. See <code>cement_commitment</code> for details.</p><p>By design, the operation wrapping this might <i>not</i> be authenticated, as it may be necessary for nodes on the honest branch to refund stakers on the LCC. They must do so by using <code>withdraw_stake</code> as they are implicitly staked on the LCC and can not dispute it.</p></div></div></div></body></html>
