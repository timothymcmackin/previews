<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tx_rollup_commitment_storage (tezos-protocol-014-PtKathma.Tezos_raw_protocol_014_PtKathma.Tx_rollup_commitment_storage)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-014-PtKathma</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_014_PtKathma</a> &#x00BB; Tx_rollup_commitment_storage</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_014_PtKathma.Tx_rollup_commitment_storage</span></code></h1><p>This module introduces various functions to manipulate the storage related to commitments for transaction rollups.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-check_message_result"><a href="#val-check_message_result" class="anchor"></a><code><span><span class="keyword">val</span> check_message_result : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_commitment_repr/Compact/index.html#type-t">Tx_rollup_commitment_repr.Compact.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[ <span>`Hash of <a href="../Tx_rollup_message_result_hash_repr/index.html#type-t">Tx_rollup_message_result_hash_repr.t</a></span>
  <span><span>| `Result</span> of <a href="../Tx_rollup_message_result_repr/index.html#type-t">Tx_rollup_message_result_repr.t</a></span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">path</span>:<a href="../Tx_rollup_commitment_repr/Merkle/index.html#type-path">Tx_rollup_commitment_repr.Merkle.path</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">index</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_commitment"><a href="#val-add_commitment" class="anchor"></a><code><span><span class="keyword">val</span> add_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Signature/Public_key_hash/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Signature.Public_key_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_commitment_repr/Full/index.html#type-t">Tx_rollup_commitment_repr.Full.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a>
   * <a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a>
   * <span><a href="../../Tezos_protocol_environment_014_PtKathma/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_014_PtKathma.Signature.public_key_hash</a> option</span>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>add_commitment context tx_rollup contract commitment</code> adds a commitment to a rollup. It returns the new context, the new state, and the committer of the previous commitment stored for this level if any.</p><p>In case this committer exists, then it means its bond needs to be slashed.</p><p>This function returns the errors</p><ul><li><code>Level_already_has_commitment</code> iff there is already a valid commitment (<i>i.e.</i>, not orphan) at this level.</li><li><code>Invalid_committer</code> iff an orphan commitment from the same committer already is in the storage.</li><li><code>Missing_commitment_predecessor</code> iff the predecessor does not match the already-stored predecessor commitment.</li><li><code>Wrong_commitment_predecessor_level</code> iff there is no predecessor level, but a predecessor commitment is provided (or no predecessor commitment is provided but there is a precessor level)</li><li><code>Wrong_batch_count</code> iff the number of batches does not equal the length of the inbox.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_bond"><a href="#val-remove_bond" class="anchor"></a><code><span><span class="keyword">val</span> remove_bond : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_014_PtKathma.Signature.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>remove_bond context state tx_rollup contract</code> removes the bond for an implicit contract. This will fail if either the bond does not exist, or if the bond is currently in use.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-slash_bond"><a href="#val-slash_bond" class="anchor"></a><code><span><span class="keyword">val</span> slash_bond : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_014_PtKathma.Signature.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * bool)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>slash_bond ctxt tx_rollup contract</code> removes the bond counter for an implicit contract if it exists. Besides, it returns a boolean to determine if this counter was strictly superior to 0.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find"><a href="#val-find" class="anchor"></a><code><span><span class="keyword">val</span> find : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <span><a href="../Tx_rollup_commitment_repr/Submitted_commitment/index.html#type-t">Tx_rollup_commitment_repr.Submitted_commitment.t</a> option</span>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>find context tx_rollup state level</code> returns the commitment for a level, if any exists and is not orphan (that is, one of its ancestors has been rejected). If the rollup does not exist, the error <code>Tx_rollup_does_not_exist</code> is returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get"><a href="#val-get" class="anchor"></a><code><span><span class="keyword">val</span> get : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Tx_rollup_commitment_repr/Submitted_commitment/index.html#type-t">Tx_rollup_commitment_repr.Submitted_commitment.t</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>get context tx_rollup state level</code> returns the commitment for a level, if any exists. If the rollup does not exist, the error <code>Tx_rollup_does_not_exist</code> is returned. If there is no commitment in the storage, or if a commitment exists but it is orphan (that is, one of its ancestors has been rejected), then <code>Commitment_does_not_exist</code> is returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_finalized"><a href="#val-get_finalized" class="anchor"></a><code><span><span class="keyword">val</span> get_finalized : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Tx_rollup_commitment_repr/Submitted_commitment/index.html#type-t">Tx_rollup_commitment_repr.Submitted_commitment.t</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>get_finalized context tx_rollup level</code> returns the commitment for a level, if any exists and is finalized. If the rollup does not exist, the error <code>Tx_rollup_does_not_exist</code> is returned. If the commitment is not finalized the error <code>Tx_rollup_commitment_not_final</code> is returned</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pending_bonded_commitments"><a href="#val-pending_bonded_commitments" class="anchor"></a><code><span><span class="keyword">val</span> pending_bonded_commitments : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_014_PtKathma.Signature.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * int)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>pending_bonded_commitments ctxt tx_rollup contract</code> returns the number of commitments that <code>contract</code> has made that are still in the storage.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-has_bond"><a href="#val-has_bond" class="anchor"></a><code><span><span class="keyword">val</span> has_bond : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_014_PtKathma/Signature/index.html#type-public_key_hash">Tezos_protocol_environment_014_PtKathma.Signature.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * bool)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>has_bond ctxt tx_rollup contract</code> returns true if we have already collected a bond for <code>contract</code> for commitments on <code>tx_rollup</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_commitment"><a href="#val-finalize_commitment" class="anchor"></a><code><span><span class="keyword">val</span> finalize_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> * <a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>finalize_commitment ctxt tx_rollup state</code> marks the commitment of the oldest inbox as final, if the commitment exists and if it is old enough. Otherwise, this function returns the error <code>No_commitment_to_finalize</code>.</p><p>The number of <a href="#val-pending_bonded_commitments"><code>pending_bonded_commitments</code></a> is not updated, it is decremented when the commitment is removed (see <a href="#val-remove_commitment"><code>remove_commitment</code></a>). It is done to force the rollup operators to clean up the commitment storage.</p><p>The state of the rollup is adjusted accordingly, and the finalized level is returned. Besides, the inbox at said level is removed from the context. This function returns the new context, and the new state.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_commitment"><a href="#val-remove_commitment" class="anchor"></a><code><span><span class="keyword">val</span> remove_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> * <a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>remove_commitment ctxt tx_rollup state</code> tries to remove the oldest finalized commitment from the layer-1 storage, if it exists, and if it is old enough. Otherwise, this functions returns the error <code>No_commitment_to_remove</code>.</p><p>The state of the rollup is adjusted accordingly.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reject_commitment"><a href="#val-reject_commitment" class="anchor"></a><code><span><span class="keyword">val</span> reject_commitment : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_level_repr/index.html#type-t">Tx_rollup_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Raw_context/index.html#type-t">Raw_context.t</a> * <a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a>)</span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>reject_commitment context tx_rollup state level</code> removes the commitment at <code>level</code>. It should only be called after a successful rejection operation. The <code>state</code> is updated to reflect the rejection, and returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_agreed_and_disputed_results"><a href="#val-check_agreed_and_disputed_results" class="anchor"></a><code><span><span class="keyword">val</span> check_agreed_and_disputed_results : 
  <span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_repr/index.html#type-t">Tx_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_state_repr/index.html#type-t">Tx_rollup_state_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Tx_rollup_commitment_repr/Submitted_commitment/index.html#type-t">Tx_rollup_commitment_repr.Submitted_commitment.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">agreed_result</span>:<a href="../Tx_rollup_message_result_repr/index.html#type-t">Tx_rollup_message_result_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">agreed_result_path</span>:<a href="../Tx_rollup_commitment_repr/Merkle/index.html#type-path">Tx_rollup_commitment_repr.Merkle.path</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">disputed_result</span>:<a href="../Tx_rollup_message_result_hash_repr/index.html#type-t">Tx_rollup_message_result_hash_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">disputed_position</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">disputed_result_path</span>:<a href="../Tx_rollup_commitment_repr/Merkle/index.html#type-path">Tx_rollup_commitment_repr.Merkle.path</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Raw_context/index.html#type-t">Raw_context.t</a> <a href="../../Tezos_protocol_environment_014_PtKathma/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_014_PtKathma.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_014_PtKathma/Lwt/index.html#type-t">Tezos_protocol_environment_014_PtKathma.Lwt.t</a></span></span></code></div></div></div></body></html>
