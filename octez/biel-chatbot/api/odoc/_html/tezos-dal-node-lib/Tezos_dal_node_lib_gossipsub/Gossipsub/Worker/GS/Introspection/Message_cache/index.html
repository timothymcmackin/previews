<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Message_cache (tezos-dal-node-lib.Tezos_dal_node_lib_gossipsub.Gossipsub.Worker.GS.Introspection.Message_cache)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../../index.html">tezos-dal-node-lib</a> &#x00BB; <a href="../../../../../index.html">Tezos_dal_node_lib_gossipsub</a> &#x00BB; <a href="../../../../index.html">Gossipsub</a> &#x00BB; <a href="../../../index.html">Worker</a> &#x00BB; <a href="../../index.html">GS</a> &#x00BB; <a href="../index.html">Introspection</a> &#x00BB; Message_cache</nav><header class="odoc-preamble"><h1>Module <code><span>Introspection.Message_cache</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Peer"><a href="#module-Peer" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Peer/index.html">Peer</a></span><span> : 
  <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-ITERABLE/index.html">Tezos_gossipsub.Gossipsub_intf.ITERABLE</a>
    <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-ITERABLE/index.html#type-t">t</a> = <a href="../../Peer/index.html#type-t">Peer.t</a></span>
    <span class="keyword">with</span> <span><span class="keyword">type</span> <span>'a <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-ITERABLE/Map/index.html#type-t">Map.t</a></span> = <span><span class="type-var">'a</span> <a href="../../Peer/Map/index.html#type-t">Peer.Map.t</a></span></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Topic"><a href="#module-Topic" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Topic/index.html">Topic</a></span><span> : <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-ITERABLE/index.html">Tezos_gossipsub.Gossipsub_intf.ITERABLE</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-ITERABLE/index.html#type-t">t</a> = <a href="../../Topic/index.html#type-t">Topic.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Message_id"><a href="#module-Message_id" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Message_id/index.html">Message_id</a></span><span> : 
  <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-ITERABLE/index.html">Tezos_gossipsub.Gossipsub_intf.ITERABLE</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-ITERABLE/index.html#type-t">t</a> = <a href="../../Message_id/index.html#type-t">Message_id.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Message"><a href="#module-Message" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Message/index.html">Message</a></span><span> : <a href="../../../../../../../octez-libs/Tezos_base/TzPervasives/module-type-PRINTABLE/index.html">Tezos_base.TzPervasives.PRINTABLE</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../../../../../octez-libs/Tezos_base/TzPervasives/module-type-PRINTABLE/index.html#type-t">t</a> = <a href="../../Message/index.html#type-t">Message.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Time"><a href="#module-Time" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Time/index.html">Time</a></span><span> : <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-TIME/index.html">Tezos_gossipsub.Gossipsub_intf.TIME</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../../../../../octez-libs/Tezos_gossipsub/Gossipsub_intf/module-type-TIME/index.html#type-t">t</a> = <a href="../../Time/index.html#type-t">Time.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>A sliding window cache that stores published messages, their first seen time, and their senders. The module also keeps track of the number of accesses to a message by a peer, thus indirectly tracking the number of IWant requests a peer makes for the same message between two heartbeats.</p><p>The module assumes that no two different messages have the same message id. However, the cache stores duplicates; for instance, if <code>add_message
      peer id msg topic</code> is called exactly twice, then <code>msg</code> will appear twice in <code>get_message_ids_to_gossip</code>'s result (assuming not more than <code>gossip_slots</code> shifts have been executed in the meanwhile).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">history_slots</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gossip_slots</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">seen_message_slots</span>:int <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ~history_slots ~gossip_slots ~seen_message_slots</code> creates two sliding window caches, one with length <code>history_slots</code> for storing message contents and another with length <code>seen_message</code> for storing seen messages and their first seen times.</p><p>When queried for messages to advertise, the cache only returns messages in the last <code>gossip_slots</code>. The <code>gossip_slots</code> must be smaller or equal to <code>history_slots</code>.</p><p>The slack between <code>gossip_slots</code> and <code>history_slots</code> accounts for the reaction time between when a message is advertised via IHave gossip, and when the peer pulls it via an IWant command. To see this, if say <code>gossip_slot = history_slots</code> then the messages inserted in cache <code>history_slots</code> heartbeat ticks ago and advertised now will not be available after the next tick, because they are removed from the cache. This means IWant requests from the remote peer for such messages would be unfulfilled and potentially penalizing.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Assert_failure</code> <p>when <code>gossip_slots &lt;= 0 || gossip_slots &gt; history_slots</code></p><p>TODO: https://gitlab.com/tezos/tezos/-/issues/5129 Error handling.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_message"><a href="#val-add_message" class="anchor"></a><code><span><span class="keyword">val</span> add_message : 
  <span><span class="label">peer</span>:<span><a href="Peer/index.html#type-t">Peer.t</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Message_id/index.html#type-t">Message_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Message/index.html#type-t">Message.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Topic/index.html#type-t">Topic.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Add message to the most recent cache slot. If the message already exists in the cache, the message is not overridden, instead a duplicate message id is stored (the message itself is only stored once). The <code>peer</code> argument represents the message sender. It is <code>None</code> in case the message is produced and not received (thus it has no sender).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_message_for_peer"><a href="#val-get_message_for_peer" class="anchor"></a><code><span><span class="keyword">val</span> get_message_for_peer : 
  <span><a href="Peer/index.html#type-t">Peer.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Message_id/index.html#type-t">Message_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-t">t</a> * <a href="Message/index.html#type-t">Message.t</a> * int)</span> option</span></span></code></div><div class="spec-doc"><p>Get the message associated to the given message id, increase the access counter for the peer requesting the message, and also returns the updated counter.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_message_ids_to_gossip"><a href="#val-get_message_ids_to_gossip" class="anchor"></a><code><span><span class="keyword">val</span> get_message_ids_to_gossip : <span><a href="Topic/index.html#type-t">Topic.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="Message_id/index.html#type-t">Message_id.t</a> list</span></span></code></div><div class="spec-doc"><p>Get the message ids for the given topic in the last <code>gossip_slots</code> slots of the cache. If there were duplicates added in the cache, then there will be duplicates in the output. There is no guarantee about the order of messages in the output.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_first_seen_time_and_senders"><a href="#val-get_first_seen_time_and_senders" class="anchor"></a><code><span><span class="keyword">val</span> get_first_seen_time_and_senders : 
  <span><a href="Message_id/index.html#type-t">Message_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="Time/index.html#type-t">Time.t</a> * <a href="Peer/Set/index.html#type-t">Peer.Set.t</a>)</span> option</span></span></code></div><div class="spec-doc"><p><code>get_first_seen_time_and_senders message_id t</code> returns the time the message with <code>message_id</code> was first seen and the senders of that message during the tracked sliding window. Returns <code>None</code> if the message was not seen during the period covered by the sliding window.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-seen_message"><a href="#val-seen_message" class="anchor"></a><code><span><span class="keyword">val</span> seen_message : <span><a href="Message_id/index.html#type-t">Message_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>seen_message message_id t</code> returns <code>true</code> if the message was seen during the period covered by the sliding window and returns <code>false</code> if otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shift"><a href="#val-shift" class="anchor"></a><code><span><span class="keyword">val</span> shift : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Shift the sliding window by one slot (usually corresponding to one heartbeat tick).</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Introspection"><a href="#module-Introspection" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Introspection/index.html">Introspection</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
