<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chain (octez-shell-libs.Tezos_store.Store.Chain)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">octez-shell-libs</a> &#x00BB; <a href="../../index.html">Tezos_store</a> &#x00BB; <a href="../index.html">Store</a> &#x00BB; Chain</nav><header class="odoc-preamble"><h1>Module <code><span>Store.Chain</span></code></h1><p>The module for handling chain-related operations such as setting the head of the chain, updating the chain state, forking testchains, ...</p></header><nav class="odoc-toc"><ul><li><a href="#chain's-protocols">Chain's protocols</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-chain_store"><a href="#type-chain_store" class="anchor"></a><code><span><span class="keyword">type</span> <span class="keyword">nonrec</span> chain_store</span><span> = <a href="../index.html#type-chain_store">chain_store</a></span></code></div><div class="spec-doc"><p>The abstract type alias of a chain store.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="#type-chain_store">chain_store</a></span></code></div><div class="spec-doc"><p>The type alias of <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-testchain"><a href="#type-testchain" class="anchor"></a><code><span><span class="keyword">type</span> testchain</span></code></div><div class="spec-doc"><p>The abstract type for testchain.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_identifier"><a href="#type-block_identifier" class="anchor"></a><code><span><span class="keyword">type</span> block_identifier</span><span> = <a href="../../../Tezos_shell_services/Block_services/index.html#type-block">Tezos_shell_services.Block_services.block</a></span></code></div><div class="spec-doc"><p>A type alias of a block identifier.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-global_store"><a href="#val-global_store" class="anchor"></a><code><span><span class="keyword">val</span> global_store : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-store">store</a></span></code></div><div class="spec-doc"><p><code>global_store chain_store</code> returns the global store of <code>chain_store</code> allowing to retrieve global infos.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-chain_id"><a href="#val-chain_id" class="anchor"></a><code><span><span class="keyword">val</span> chain_id : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../../octez-libs/Tezos_crypto/Hashed/Chain_id/index.html#type-t">Tezos_base.TzPervasives.Chain_id.t</a></span></code></div><div class="spec-doc"><p><code>chain_id chain_store</code> returns chain id of <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-chain_dir"><a href="#val-chain_dir" class="anchor"></a><code><span><span class="keyword">val</span> chain_dir : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[ `Chain_dir ]</span> <a href="../../../Tezos_store_shared/Naming/index.html#type-directory">Tezos_store_shared.Naming.directory</a></span></span></code></div><div class="spec-doc"><p><code>chain_dir chain_store</code> returns the path of directory of <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-history_mode"><a href="#val-history_mode" class="anchor"></a><code><span><span class="keyword">val</span> history_mode : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a></span></code></div><div class="spec-doc"><p><code>history_mode chain_store</code> returns the history mode of the <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-genesis"><a href="#val-genesis" class="anchor"></a><code><span><span class="keyword">val</span> genesis : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../../octez-libs/Tezos_base/Genesis/index.html#type-t">Tezos_base.TzPervasives.Genesis.t</a></span></code></div><div class="spec-doc"><p><code>genesis chain_store</code> returns the <code>Genesis.t</code> of the <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-genesis_block"><a href="#val-genesis_block" class="anchor"></a><code><span><span class="keyword">val</span> genesis_block : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Block/index.html#type-t">Block.t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>genesis chain_store</code> returns the genesis block of the <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current_head"><a href="#val-current_head" class="anchor"></a><code><span><span class="keyword">val</span> current_head : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Block/index.html#type-t">Block.t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>current_head chain_store</code> returns the current head of the <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-expiration"><a href="#val-expiration" class="anchor"></a><code><span><span class="keyword">val</span> expiration : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../octez-libs/Tezos_base/Time/Protocol/index.html#type-t">Tezos_base.TzPervasives.Time.Protocol.t</a> option</span></span></code></div><div class="spec-doc"><p><code>expiration chain_store</code> returns the expiration date of the testchain's <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-checkpoint"><a href="#val-checkpoint" class="anchor"></a><code><span><span class="keyword">val</span> checkpoint : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>checkpoint chain_store</code> returns the checkpoint associated to the <code>chain_store</code>.</p><p>The checkpoint is a block descriptor (<code>Store_types.block_descriptor</code>) pointing to a block that must be part of the chain. The checkpoint maintains the set of following invariants:</p><ul><li>The store will only accept blocks that are above its checkpoint's level.</li></ul><ul><li>The checkpoint is updated periodically such that the following invariant holds: <code>checkpoint.level &gt;= all_head.last_preserved_block_level</code></li></ul><p>The checkpoint will tend to designate the highest block among all chain head's <code>last_preserved_block_level</code> in a normal mode. This is not always true. i.e. after a snapshot import where the checkpoint will be set as the imported block and when the <code>target</code> block is reached, the checkpoint will be set at this point.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-target"><a href="#val-target" class="anchor"></a><code><span><span class="keyword">val</span> target : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>target chain_store</code> returns the target block associated to the <code>chain_store</code> if there is one or <code>None</code> if it has already been reached.</p><p>The target is a (<code>Store_types.block_descriptor</code>) pointing to a future block that must be reached by the chain. When a block is received, if its level is equal to the target's block level then its hash must be also be the same. Otherwise, the block is considered as invalid and will be discarded.</p><p>The target should only be set manually. Whenever the target block is reached, the checkpoint will be updated to this block and the target will be set to <code>None</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-savepoint"><a href="#val-savepoint" class="anchor"></a><code><span><span class="keyword">val</span> savepoint : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>savepoint chain_store</code> returns the savepoint associated to the <code>chain_store</code>.</p><p>The savepoint is a block descriptor (<code>Store_types.block_descriptor</code>) pointing to the lowest level block that has its metadata and/or context pruned with the following invariant:</p><p><code>is_stored(block) \and has_metadata(block) =&gt; block.level &gt;=
      savepoint.level</code></p><p>For Full and Rolling history modes, the savepoint will be periodically updated at each store merge which happens when:</p><p><code>pred(head).last_preserved_block_level &lt;
      head.last_preserved_block_level</code></p><p>On Archive history mode: <code>savepoint = genesis</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-caboose"><a href="#val-caboose" class="anchor"></a><code><span><span class="keyword">val</span> caboose : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>caboose chain_store</code> returns the caboose associated to the <code>chain_store</code>.</p><p>The caboose is a block descriptor (<code>Store_types.block_descriptor</code>) pointing to the lowest level block that we know present in the chain store, if the history mode is <b>not</b> Archive, it might not contain its metadata depending on the current savepoint:</p><p><code>is_stored(block) =&gt; block.level &gt;= caboose.level</code></p><p>On Archive and Full history mode: <code>caboose = genesis</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mempool"><a href="#val-mempool" class="anchor"></a><code><span><span class="keyword">val</span> mempool : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../octez-libs/Tezos_base/Mempool/index.html#type-t">Tezos_base.TzPervasives.Mempool.t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>mempool chain_store</code> returns the mempool associated to the <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_of_identifier"><a href="#val-block_of_identifier" class="anchor"></a><code><span><span class="keyword">val</span> block_of_identifier : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-block_identifier">block_identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Block/index.html#type-t">Block.t</a> <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>block_of_identifier chain_store identifier</code> tries to return the block of the given <code>identifier</code> inside the given <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_of_identifier_opt"><a href="#val-block_of_identifier_opt" class="anchor"></a><code><span><span class="keyword">val</span> block_of_identifier_opt : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-block_identifier">block_identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Block/index.html#type-t">Block.t</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>block_of_identifier_opt chain_store identifier</code> optional version of <code>block_of_identifier</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_mempool"><a href="#val-set_mempool" class="anchor"></a><code><span><span class="keyword">val</span> set_mempool : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../../octez-libs/Tezos_base/Mempool/index.html#type-t">Tezos_base.TzPervasives.Mempool.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>set_mempool chain_store ~head mempool</code> sets the <code>mempool</code> of the <code>chain_store</code>. Does nothing if <code>head</code> is not current_head which might happen when a new head concurrently arrives just before this operation being called.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-live_blocks"><a href="#val-live_blocks" class="anchor"></a><code><span><span class="keyword">val</span> live_blocks : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../../octez-libs/Tezos_crypto/Hashed/Block_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Block_hash.Set.t</a>
   * <a href="../../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Set.t</a>)</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>live_blocks chain_store</code> returns the set of previously computed live blocks for the current_head's <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compute_live_blocks"><a href="#val-compute_live_blocks" class="anchor"></a><code><span><span class="keyword">val</span> compute_live_blocks : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block</span>:<a href="../Block/index.html#type-t">Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../../octez-libs/Tezos_crypto/Hashed/Block_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Block_hash.Set.t</a>
   * <a href="../../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Set.t</a>)</span>
    <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>compute_live_blocks ~block chain_store</code> computes the set of live blocks and live operations relative to <code>block</code>. Does nothing if <code>block</code> is the <code>chain_store</code>'s current head as it was previously updated in <a href="#val-set_head"><code>set_head</code></a>.</p><p>Note: this operation should not be costly in most cases as recent blocks and operations are expected to be in a cache.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_head"><a href="#val-set_head" class="anchor"></a><code><span><span class="keyword">val</span> set_head : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Block/index.html#type-t">Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Block/index.html#type-t">Block.t</a> <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>set_head chain_store block</code> promotes the <code>block</code> as head of the <code>chain_store</code> and triggers an asynchronous store merge if a cycle is ready to be cemented. Triggering a merge will update the savepoint, checkpoint and caboose consistently with the <code>chain_store</code>'s history mode. This function returns the previous head. Setting a new head will fail when the block is not fit to be promoted as head (i.e. too old or no metadata).</p><p>After a merge:</p><ul><li>The checkpoint is updated to <code>lpbl(new_head)</code> if it was below this level or unchanged otherwise;</li></ul><ul><li>The savepoint will be updated to : min(max_op_ttl(lpbl(new_head)), lpbl(new_head) - &lt;cycle_length&gt; * &lt;history_mode_offset&gt;) or will remain 0 in Archive mode;</li></ul><ul><li>The caboose will be updated to the same value as the savepoint in Rolling mode.</li></ul><p>Note: lpbl(new_head) is the last preserved block level of the new head.</p><p><b>Warnings:</b></p><ul><li>We expect blocks to be sequentially promoted as head using this function;</li></ul><ul><li>If a merge is triggered while another is happening, this function will block until the first merge is resolved.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_ancestor"><a href="#val-is_ancestor" class="anchor"></a><code><span><span class="keyword">val</span> is_ancestor : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ancestor</span>:<a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="arrow">&#45;&gt;</span></span>
  <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>is_ancestor chain_store ~head ~ancestor</code> checks whether the <code>ancestor</code> is a predecessor or <code>head</code> in <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_in_chain"><a href="#val-is_in_chain" class="anchor"></a><code><span><span class="keyword">val</span> is_in_chain : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="arrow">&#45;&gt;</span></span>
  <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>is_in_chain chain_store block_descr</code> checks that <code>block_descr</code> is an ancestor of <code>chain_store</code>'s current head.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_acceptable_block"><a href="#val-is_acceptable_block" class="anchor"></a><code><span><span class="keyword">val</span> is_acceptable_block : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="arrow">&#45;&gt;</span></span>
  <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>is_acceptable_block chain_store block_descr</code> checks if <code>block_descr</code> would be a valid block to be stored in <code>chain_store</code>. Its predecessor is supposed to be already stored.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compute_locator"><a href="#val-compute_locator" class="anchor"></a><code><span><span class="keyword">val</span> compute_locator : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Block/index.html#type-t">Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../../octez-libs/Tezos_base/Block_locator/index.html#type-seed">Tezos_base.TzPervasives.Block_locator.seed</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../../octez-libs/Tezos_base/Block_locator/index.html#type-t">Tezos_base.TzPervasives.Block_locator.t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>compute_locator chain ?max_size head seed</code> computes a locator of the <code>chain</code> from <code>head</code> to the chain's caboose or until the locator contains <code>max_size</code> steps. <code>max_size</code> defaults to 200.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compute_protocol_locator"><a href="#val-compute_protocol_locator" class="anchor"></a><code><span><span class="keyword">val</span> compute_protocol_locator : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">proto_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../../octez-libs/Tezos_base/Block_locator/index.html#type-seed">Tezos_base.TzPervasives.Block_locator.seed</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../../octez-libs/Tezos_base/Block_locator/index.html#type-t">Tezos_base.TzPervasives.Block_locator.t</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>compute_protocol_locator chain ?max_size ~proto_level seed</code> computes a locator for a specific protocol of level <code>proto_level</code> in the <code>chain</code> from the latest block with this protocol to its activation block or until the locator contains <code>max_size</code> steps. <code>max_size</code> defaults to 200.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_target"><a href="#val-set_target" class="anchor"></a><code><span><span class="keyword">val</span> set_target : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>set_target chain_store target_descr</code> sets the target for <code>chain_store</code>. If <code>target_descr</code> is already known, <code>set_checkpoint</code> will be internally called. Fails if the target is below the current checkpoint.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-testchain"><a href="#val-testchain" class="anchor"></a><code><span><span class="keyword">val</span> testchain : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-testchain">testchain</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>testchain chain_store</code> returns the active testchain to the given <code>chain_store</code> if it has been instantiated.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-testchain_forked_block"><a href="#val-testchain_forked_block" class="anchor"></a><code><span><span class="keyword">val</span> testchain_forked_block : <span><a href="#type-testchain">testchain</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a></span></code></div><div class="spec-doc"><p><code>testchain_forked_block testchain</code> returns the hash of the forked block of its parent chain.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-testchain_store"><a href="#val-testchain_store" class="anchor"></a><code><span><span class="keyword">val</span> testchain_store : <span><a href="#type-testchain">testchain</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-chain_store">chain_store</a></span></code></div><div class="spec-doc"><p><code>testchain_store testchain</code> returns the chain store associated to this <code>testchain</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fork_testchain"><a href="#val-fork_testchain" class="anchor"></a><code><span><span class="keyword">val</span> fork_testchain : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">testchain_id</span>:<a href="../../../../octez-libs/Tezos_crypto/Hashed/Chain_id/index.html#type-t">Tezos_base.TzPervasives.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">forked_block</span>:<a href="../Block/index.html#type-t">Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">genesis_hash</span>:<a href="../../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">genesis_header</span>:<a href="../../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.TzPervasives.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">test_protocol</span>:<a href="../../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">expiration</span>:<a href="../../../../octez-libs/Tezos_base/Time/Protocol/index.html#type-t">Tezos_base.TzPervasives.Time.Protocol.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-testchain">testchain</a> <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>fork testchain chain_store ~testchain_id ~forked_block
      ~genesis_hash ~genesis_header ~test_protocol ~expiration</code> forks a testchain and activates it for <code>chain_store</code>. If a testchain with <code>testchain_id</code> already existed, it is then loaded from the store. If it was already activated, does nothing. It also registers this chain in the set of activated testchains.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown_testchain"><a href="#val-shutdown_testchain" class="anchor"></a><code><span><span class="keyword">val</span> shutdown_testchain : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>shutdown_testchain chain_store</code> closes and deactivates the testchain running for <code>chain_store</code>. Does nothing if no testchain is found running for <code>chain_store</code>.</p></div></div><h3 id="chain's-protocols"><a href="#chain's-protocols" class="anchor"></a>Chain's protocols</h3><div class="odoc-spec"><div class="spec value anchored" id="val-protocol_levels"><a href="#val-protocol_levels" class="anchor"></a><code><span><span class="keyword">val</span> protocol_levels : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../Tezos_store_shared/Store_types/Protocol_levels/index.html#type-protocol_info">Tezos_store_shared.Store_types.Protocol_levels.protocol_info</a>
    <a href="../../../Tezos_store_shared/Store_types/Protocol_levels/index.html#type-t">Tezos_store_shared.Store_types.Protocol_levels.t</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>protol_levels chain_store</code> return all protocols with their activation levels.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_protocol_info"><a href="#val-find_protocol_info" class="anchor"></a><code><span><span class="keyword">val</span> find_protocol_info : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">protocol_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../Tezos_store_shared/Store_types/Protocol_levels/index.html#type-protocol_info">Tezos_store_shared.Store_types.Protocol_levels.protocol_info</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>find_protocol_info chain_store ~protocol_level</code> returns the protocol info associated to the given <code>protocol_level</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_activation_block"><a href="#val-find_activation_block" class="anchor"></a><code><span><span class="keyword">val</span> find_activation_block : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">protocol_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../Tezos_store_shared/Store_types/index.html#type-block_descriptor">Tezos_store_shared.Store_types.block_descriptor</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>find_activation_block chain_store ~protocol_level</code> returns the block that activated the protocol of level <code>protocol_level</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_protocol"><a href="#val-find_protocol" class="anchor"></a><code><span><span class="keyword">val</span> find_protocol : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">protocol_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>find_protocol chain_store ~protocol_level</code> returns the protocol with the level <code>protocol_level</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-expect_predecessor_context_hash"><a href="#val-expect_predecessor_context_hash" class="anchor"></a><code><span><span class="keyword">val</span> expect_predecessor_context_hash : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">protocol_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span>bool <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>expects_predecessor_context_hash chain_store ~protocol_level</code> returns whether or not a protocol requires the context hash of a block to target resulting context of it's predecessor. This depends on the environment of each protocol.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-all_protocol_levels"><a href="#val-all_protocol_levels" class="anchor"></a><code><span><span class="keyword">val</span> all_protocol_levels : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../Tezos_store_shared/Store_types/Protocol_levels/index.html#type-protocol_info">Tezos_store_shared.Store_types.Protocol_levels.protocol_info</a>
    <a href="../../../Tezos_store_shared/Store_types/Protocol_levels/index.html#type-t">Tezos_store_shared.Store_types.Protocol_levels.t</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>all_protocol_levels chain_store</code> returns all the protocols registered in <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-may_update_protocol_level"><a href="#val-may_update_protocol_level" class="anchor"></a><code><span><span class="keyword">val</span> may_update_protocol_level : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?pred</span>:<a href="../Block/index.html#type-block">Block.block</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?protocol_level</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">expect_predecessor_context</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Block/index.html#type-block">Block.block</a> * <a href="../../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>may_update_protocol_level chain_store ?pred ?protocol_level
      ~expect_predecessor_context (block, ph)</code> updates the protocol level for the protocol <code>ph</code> in <code>chain_store</code> with the activation <code>block</code>. If <code>pred</code> is not provided, it reads the <code>block</code>'s predecessor and check that the <code>block</code>'s protocol level is increasing compared to its predecessor. If <code>protocol_level</code> is provided, we use this value instead of the protocol level found in <code>block</code>. If a previous entry is found, it overwrites it. The <code>expect_predecessor_context</code> argument specifies which context hash semantics should be used.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-may_update_ancestor_protocol_level"><a href="#val-may_update_ancestor_protocol_level" class="anchor"></a><code><span><span class="keyword">val</span> may_update_ancestor_protocol_level : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../Block/index.html#type-block">Block.block</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>may_update_ancestor_protocol_level chain_store ~head
      ~expect_predecessor_context</code> tries to find the activation block of the <code>head</code>'s protocol, checks that its an ancestor and tries to update it if that's not the case. If the registered activation block is not reachable (already pruned), this function does nothing. The <code>expect_predecessor_context</code> argument specifies which context hash semantics should be used.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validated_watcher"><a href="#val-validated_watcher" class="anchor"></a><code><span><span class="keyword">val</span> validated_watcher : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Block/index.html#type-t">Block.t</a> <span class="xref-unresolved">Lwt_stream</span>.t</span> * <span class="xref-unresolved">Lwt_watcher</span>.stopper</span></code></div><div class="spec-doc"><p><code>validated_watcher chain_store</code> instantiates a new validated block watcher for <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_rpc_directory"><a href="#val-get_rpc_directory" class="anchor"></a><code><span><span class="keyword">val</span> get_rpc_directory : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Block/index.html#type-t">Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<a href="#type-chain_store">chain_store</a> * <a href="../Block/index.html#type-t">Block.t</a>)</span> <a href="../../../../octez-libs/Tezos_rpc/Directory/index.html#type-t">Tezos_rpc.Directory.t</a></span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_rpc_directory chain_store block</code> returns the RPC directory associated to the <code>block</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_rpc_directory"><a href="#val-set_rpc_directory" class="anchor"></a><code><span><span class="keyword">val</span> set_rpc_directory : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">protocol_hash</span>:<a href="../../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">next_protocol_hash</span>:<a href="../../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-chain_store">chain_store</a> * <a href="../Block/index.html#type-t">Block.t</a>)</span> <a href="../../../../octez-libs/Tezos_rpc/Directory/index.html#type-t">Tezos_rpc.Directory.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>set_rpc_directory chain_store ph next_ph rpc_directory</code> sets a <code>rpc_directory</code> for the protocol <code>ph</code> and next protocol <code>next_ph</code> in <code>chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-register_gc_callback"><a href="#val-register_gc_callback" class="anchor"></a><code><span><span class="keyword">val</span> register_gc_callback : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span>
    option</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>register_gc_callback chain_store callback</code> installs a <code>callback</code> that may be triggered during a block store merge in order to garbage-collect old contexts.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-register_split_callback"><a href="#val-register_split_callback" class="anchor"></a><code><span><span class="keyword">val</span> register_split_callback : 
  <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> option</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>register_split_callback chain_store callback</code> installs a <code>callback</code> that may be triggered during a <code>set_head</code> in order to split the context into a new chunk.</p></div></div></div></body></html>
