<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>P2p_fd (octez-shell-libs.Tezos_p2p.P2p_fd)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_p2p</a> &#x00BB; P2p_fd</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_p2p.P2p_fd</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-listening_socket_open_failure"><a href="#type-listening_socket_open_failure" class="anchor"></a><code><span><span class="keyword">type</span> listening_socket_open_failure</span><span> = </span><span>{</span></code><ol><li id="type-listening_socket_open_failure.reason" class="def record field anchored"><a href="#type-listening_socket_open_failure.reason" class="anchor"></a><code><span>reason : <span class="xref-unresolved">Unix</span>.error;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The error we are re-raising</p><span class="comment-delim">*)</span></div></li><li id="type-listening_socket_open_failure.address" class="def record field anchored"><a href="#type-listening_socket_open_failure.address" class="anchor"></a><code><span>address : <a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The interface we are trying to listen to</p><span class="comment-delim">*)</span></div></li><li id="type-listening_socket_open_failure.port" class="def record field anchored"><a href="#type-listening_socket_open_failure.port" class="anchor"></a><code><span>port : int;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The port we are trying to listen to</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Type describing an opening failure for the listening socket.</p></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Failed_to_open_listening_socket"><a href="#extension-decl-Failed_to_open_listening_socket" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> += </span></code><ol><li id="extension-Failed_to_open_listening_socket" class="def variant extension anchored"><a href="#extension-Failed_to_open_listening_socket" class="anchor"></a><code><span>| </span><span><span class="extension">Failed_to_open_listening_socket</span> <span class="keyword">of</span> <a href="#type-listening_socket_open_failure">listening_socket_open_failure</a></span></code></li></ol></div><div class="spec-doc"><p>Type of an error in case of the listening socket fails to open.</p></div></div><p>This module defines a type <code>t</code> which wraps a file descriptor. Most functions simply call the underlying file descriptor function and generate logs with prefix &quot;p2p.fd&quot;.</p><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-unexpected_error"><a href="#type-unexpected_error" class="anchor"></a><code><span><span class="keyword">type</span> unexpected_error</span><span> = </span><span>[ </span></code><ol><li id="type-unexpected_error.Unexpected_error" class="def variant constructor anchored"><a href="#type-unexpected_error.Unexpected_error" class="anchor"></a><code><span>| </span><span>`Unexpected_error <span class="keyword">of</span> exn</span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p><code>`Unexpected_error</code> is a generic case of error that is used by default to represent a raising error that cannot be identified as a known error case.</p><p>Note: This errror is needed in general to address unexpetected exception that could be raised during fd processing. Though, it is not encouraged to use it. It is a better practice to catch exceptions and convert them explicitly to a dedicated (polymorphic) variant type.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-read_write_error"><a href="#type-read_write_error" class="anchor"></a><code><span><span class="keyword">type</span> read_write_error</span><span> = </span><span>[ </span></code><ol><li id="type-read_write_error.Connection_closed_by_peer" class="def variant constructor anchored"><a href="#type-read_write_error.Connection_closed_by_peer" class="anchor"></a><code><span>| </span><span>`Connection_closed_by_peer</span></code></li><li id="type-read_write_error.Connection_lost" class="def variant constructor anchored"><a href="#type-read_write_error.Connection_lost" class="anchor"></a><code><span>| </span><span>`Connection_lost <span class="keyword">of</span> exn</span></code></li><li id="type-read_write_error.Connection_locally_closed" class="def variant constructor anchored"><a href="#type-read_write_error.Connection_locally_closed" class="anchor"></a><code><span>| </span><span>`Connection_locally_closed</span></code></li><li id="type-read_write_error.unexpected_error" class="def variant type anchored"><a href="#type-read_write_error.unexpected_error" class="anchor"></a><code><span>| </span><span><a href="#type-unexpected_error">unexpected_error</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p><code>read_write_error</code> is used by the functions <code>read</code> or <code>write</code> in case of error.</p><p><code>`Connection_closed_by_peer</code> is returned when the socket returns 0 bytes read or written.</p><p><code>`Connection_lost</code> is returned when the connection was closed because of a timeout or another problem related to the remote peer.</p><p><code>`Connection_locally_closed</code> is returned when the connection's socket has been locally closed before we try to access it.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-connect_error"><a href="#type-connect_error" class="anchor"></a><code><span><span class="keyword">type</span> connect_error</span><span> = </span><span>[ </span></code><ol><li id="type-connect_error.Connection_failed" class="def variant constructor anchored"><a href="#type-connect_error.Connection_failed" class="anchor"></a><code><span>| </span><span>`Connection_failed</span></code></li><li id="type-connect_error.unexpected_error" class="def variant type anchored"><a href="#type-connect_error.unexpected_error" class="anchor"></a><code><span>| </span><span><a href="#type-unexpected_error">unexpected_error</a></span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-accept_error"><a href="#type-accept_error" class="anchor"></a><code><span><span class="keyword">type</span> accept_error</span><span> = </span><span>[ </span></code><ol><li id="type-accept_error.System_error" class="def variant constructor anchored"><a href="#type-accept_error.System_error" class="anchor"></a><code><span>| </span><span>`System_error <span class="keyword">of</span> exn</span></code></li><li id="type-accept_error.Socket_error" class="def variant constructor anchored"><a href="#type-accept_error.Socket_error" class="anchor"></a><code><span>| </span><span>`Socket_error <span class="keyword">of</span> exn</span></code></li><li id="type-accept_error.unexpected_error" class="def variant type anchored"><a href="#type-accept_error.unexpected_error" class="anchor"></a><code><span>| </span><span><a href="#type-unexpected_error">unexpected_error</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p><code>accept_error</code> is used in case of error while trying to <code>accept</code> some connection.</p><p><code>`System_error</code> represents system-wide errors which are related to the state of whole process or computer. These are errors that will probably reoccur at next <code>accept</code> and must be treated accordingly (for example by giving some time to the system to recover).</p><p><code>`Socket_error </code> represents socket-specific errors which are related to the one connection that the function attempted to accept. These are usually temporary errors related to network delays or remote host responsiveness . For most socket-errors you can just log them and call accept again to be ready for the next connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_read_write_error"><a href="#val-pp_read_write_error" class="anchor"></a><code><span><span class="keyword">val</span> pp_read_write_error : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-read_write_error">read_write_error</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Pretty printer for read_write_error.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-id"><a href="#val-id" class="anchor"></a><code><span><span class="keyword">val</span> id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>id t</code> returns a unique, positive, identifier for t. Identifiers are generated sequentially at creation time.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_point"><a href="#val-set_point" class="anchor"></a><code><span><span class="keyword">val</span> set_point : <span><span class="label">point</span>:<a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_point ~point t</code> sets the point where <code>fd</code> is or will be connected to.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_peer_id"><a href="#val-set_peer_id" class="anchor"></a><code><span><span class="keyword">val</span> set_peer_id : <span><span class="label">peer_id</span>:<a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_peer_id ~peer_id t</code> sets the peer id where <code>fd</code> is or will be connected to.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><span class="optlabel">?reason</span>:<a href="../P2p_disconnection_reason/index.html#type-t">P2p_disconnection_reason.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close ?reason fd</code> closes the connection and the underlying fd. It is idempotent.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_closing_reason"><a href="#val-add_closing_reason" class="anchor"></a><code><span><span class="keyword">val</span> add_closing_reason : <span><span class="label">reason</span>:<a href="../P2p_disconnection_reason/index.html#type-t">P2p_disconnection_reason.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Stores in the fd a reason for which it will be closed in a near future.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read"><a href="#val-read" class="anchor"></a><code><span><span class="keyword">val</span> read : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/TzPervasives/Bytes/index.html#type-t">Tezos_base.TzPervasives.Bytes.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(int, <a href="#type-read_write_error">read_write_error</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read fd buf ofs len</code> reads up to <code>len</code> bytes from <code>fd</code>, and writes them to <code>buf</code>, starting at offset <code>ofs</code>. If the operation leads to a <code>`Connection_lost</code> error it is guaranteed that the underlying socket has been closed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/TzPervasives/Bytes/index.html#type-t">Tezos_base.TzPervasives.Bytes.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <a href="#type-read_write_error">read_write_error</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>write fd buf</code> writes all bytes from <code>buf</code> to <code>fd</code>. If the operation leads to a <code>`Connection_lost</code> error it is guaranteed that the underlying socket has been closed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-socket"><a href="#val-socket" class="anchor"></a><code><span><span class="keyword">val</span> socket : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Returns a fresh fd. This call always succeed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_listening_socket"><a href="#val-create_listening_socket" class="anchor"></a><code><span><span class="keyword">val</span> create_listening_socket : 
  <span><span class="optlabel">?reuse_port</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">backlog</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?addr</span>:<span class="xref-unresolved">Ipaddr</span>.V6.t <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="xref-unresolved">Lwt_unix</span>.file_descr <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>create_listening_socket ?reuse_port ~backlog ?addr port</code> creates a socket that listens on <code>addr</code> or <code>Ipaddr.V6.unspecified</code> if <code>addr</code> is not provided and on <code>port</code>.</p><p><code>reuse_port</code> is used to set Unix socket option <code>SO_REUSEPORT</code>. If <code>reuse_port</code> is not provided this option is set to false. <code>SO_REUSEADDR</code> is set to true.</p><p><code>backlog</code> set the maximum number of pending connections.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connect"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Lwt_unix</span>.sockaddr <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <a href="#type-connect_error">connect_error</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>connect fd addr</code> connects <code>fd</code> to <code>addr</code>. If there is an error, <code>fd</code> is closed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-accept"><a href="#val-accept" class="anchor"></a><code><span><span class="keyword">val</span> accept : 
  <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-t">t</a> * <span class="xref-unresolved">Lwt_unix</span>.sockaddr, <a href="#type-accept_error">accept_error</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>accept sock</code> accepts connections on socket <code>sock</code>.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Table"><a href="#module-Table" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Table/index.html">Table</a></span><span> : <a href="../../../octez-libs/Tezos_error_monad/TzLwtreslib/Hashtbl/module-type-S/index.html">Tezos_base.TzPervasives.Hashtbl.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_error_monad/TzLwtreslib/Hashtbl/module-type-S/index.html#type-key">key</a> = <a href="#type-t">t</a></span></span></code></div></div></div></body></html>
