<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>P2p (octez-shell-libs.Tezos_p2p.P2p)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_p2p</a> &#x00BB; P2p</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_p2p.P2p</span></code></h1><p>Tezos P2p layer - Dynamic overlay network of authenticated peers.</p><p>The P2P layer implements several mechanisms, notably:</p><ul><li>It maintains pools of known points (P2P servers), peers (authenticated P2P servers), connections,</li><li>it implements an &quot;administrative&quot; protocol for maintaining the network topology,</li><li>it regulates bandwidth usage between connections,</li><li>it implements an authentication / session agreement protocol,</li><li>it can ban or greylist peers or IP addresses who don't behave well,</li><li>it offers the ability to the upper-layer to send, broadcast, or receive messages.</li></ul><p>The protocol sends/receives messages to maintain the network topology, and also &quot;generic&quot; application messages that can be sent and received by the upper-layer. See <code>P2p_message</code>.</p><p>The protocol may operate in *private* mode, in which only user-provided points (a.k.a. *trusted* ) are used. In particular, points advertisements and swap requests messages are ignored.</p><p>The module <code>P2p_pool</code> maintains pools of points, peers and connections.</p><p>Several workers are used:</p><ul><li><code>P2p_maintenance</code> tries to regulate the number of connections</li><li><code>P2p_welcome</code> waits for incoming connections</li><li><code>P2p_discovery</code> looks for points on the local network via UDP messages</li><li>A protocol worker implements the messaging protocol</li></ul><p>Points can be trusted. This is relevant in private mode (see above), but generally peers shouldn't advertise trusted points.</p><p>Addresses and peers can be *banned* (a.k.a. blacklisted). In which case, connections to and from them should be ignored.</p><p>Addresses or peers can be *greylisted*. As for banning, greylisting can be enforced via the API, but also dynamically when the peer isn't able to authenticate. Eventually greylisted peers are whitelisted again.</p><p>Many types used in the P2p layer are parameterized by three type parameters:</p><ul><li><code>'msg</code>: type of messages exchanged between peers</li><li><code>'peer_meta</code>: type of the metadata associated with peers (score, etc.)</li><li><code>'conn_meta</code>: type of the metadata associated with connections</li></ul><p>The concrete types, and functions operating on them, are defined by the calling layer, and passed to <code>P2p.create</code>. See module <code>P2p_params</code>.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-config"><a href="#type-config" class="anchor"></a><code><span><span class="keyword">type</span> config</span><span> = </span><span>{</span></code><ol><li id="type-config.listening_port" class="def record field anchored"><a href="#type-config.listening_port" class="anchor"></a><code><span>listening_port : <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-port">Tezos_base.TzPervasives.P2p_addr.port</a> option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Tells if incoming connections accepted, specifying the TCP port on which the peer can be reached (default: <code>9732</code>)</p><span class="comment-delim">*)</span></div></li><li id="type-config.listening_addr" class="def record field anchored"><a href="#type-config.listening_addr" class="anchor"></a><code><span>listening_addr : <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>When incoming connections are accepted, precise on which IP address the node listen (default: <code>[::]</code>).</p><span class="comment-delim">*)</span></div></li><li id="type-config.advertised_port" class="def record field anchored"><a href="#type-config.advertised_port" class="anchor"></a><code><span>advertised_port : <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-port">Tezos_base.TzPervasives.P2p_addr.port</a> option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If incoming connections accepted, specifying the TCP port other peers should use to connect to this peer (default: listening_port). Can be used when this peer is behind NAT.</p><span class="comment-delim">*)</span></div></li><li id="type-config.discovery_port" class="def record field anchored"><a href="#type-config.discovery_port" class="anchor"></a><code><span>discovery_port : <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-port">Tezos_base.TzPervasives.P2p_addr.port</a> option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Tells if local peer discovery is enabled, specifying the TCP port on which the peer can be reached (default: <code>10732</code>)</p><span class="comment-delim">*)</span></div></li><li id="type-config.discovery_addr" class="def record field anchored"><a href="#type-config.discovery_addr" class="anchor"></a><code><span>discovery_addr : <span><span class="xref-unresolved">Ipaddr</span>.V4.t option</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>When local peer discovery is enabled, precise on which IP address messages are broadcast (default: <code>255.255.255.255</code>).</p><span class="comment-delim">*)</span></div></li><li id="type-config.trusted_points" class="def record field anchored"><a href="#type-config.trusted_points" class="anchor"></a><code><span>trusted_points : <span><span>(<a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a>
                  * <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> option</span>)</span>
                   list</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>List of hard-coded known peers to bootstrap the network from.</p><span class="comment-delim">*)</span></div></li><li id="type-config.peers_file" class="def record field anchored"><a href="#type-config.peers_file" class="anchor"></a><code><span>peers_file : string;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The path to the JSON file where the metadata associated to peer_ids are loaded / stored.</p><span class="comment-delim">*)</span></div></li><li id="type-config.private_mode" class="def record field anchored"><a href="#type-config.private_mode" class="anchor"></a><code><span>private_mode : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, only open outgoing/accept incoming connections to/from peers whose addresses are in <code>trusted_peers</code>, and inform these peers that the identity of this node should not be revealed to the rest of the network.</p><span class="comment-delim">*)</span></div></li><li id="type-config.identity" class="def record field anchored"><a href="#type-config.identity" class="anchor"></a><code><span>identity : <a href="../../../octez-libs/Tezos_base/P2p_identity/index.html#type-t">Tezos_base.TzPervasives.P2p_identity.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Cryptographic identity of the peer.</p><span class="comment-delim">*)</span></div></li><li id="type-config.proof_of_work_target" class="def record field anchored"><a href="#type-config.proof_of_work_target" class="anchor"></a><code><span>proof_of_work_target : <a href="../../../octez-libs/Tezos_crypto/Crypto_box/index.html#type-pow_target">Tezos_crypto.Crypto_box.pow_target</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Expected level of proof of work of peers' identity.</p><span class="comment-delim">*)</span></div></li><li id="type-config.trust_discovered_peers" class="def record field anchored"><a href="#type-config.trust_discovered_peers" class="anchor"></a><code><span>trust_discovered_peers : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, peers discovered on the local network will be trusted.</p><span class="comment-delim">*)</span></div></li><li id="type-config.reconnection_config" class="def record field anchored"><a href="#type-config.reconnection_config" class="anchor"></a><code><span>reconnection_config : <a href="../../../octez-libs/Tezos_p2p_services/Point_reconnection_config/index.html#type-t">Tezos_p2p_services.Point_reconnection_config.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The reconnection delat configuration.</p><span class="comment-delim">*)</span></div></li><li id="type-config.disable_peer_discovery" class="def record field anchored"><a href="#type-config.disable_peer_discovery" class="anchor"></a><code><span>disable_peer_discovery : bool;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>If set to <code>true</code>, the p2p layer will not participate to the peer discovery mechanism. The p2p layer will not be able to find new peers to connect with. For more details, refers to field <code>disable_peer_discovery</code> of <a href="../P2p_connect_handler/index.html#type-config"><code>P2p_connect_handler.config</code></a>.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Network configuration</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>('msg, 'peer_meta, 'conn_meta) t</span></span></code></div><div class="spec-doc"><p>Type of a P2P layer instance</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-net"><a href="#type-net" class="anchor"></a><code><span><span class="keyword">type</span> <span>('msg, 'peer_meta, 'conn_meta) net</span></span><span> = <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-connection"><a href="#type-connection" class="anchor"></a><code><span><span class="keyword">type</span> <span>('msg, 'peer_meta, 'conn_meta) connection</span></span></code></div><div class="spec-doc"><p>A connection to a peer</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-announced_version"><a href="#val-announced_version" class="anchor"></a><code><span><span class="keyword">val</span> announced_version : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../octez-libs/Tezos_version/Network_version/index.html#type-t">Tezos_base.TzPervasives.Network_version.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pool"><a href="#val-pool" class="anchor"></a><code><span><span class="keyword">val</span> pool : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="../P2p_pool/index.html#type-t">P2p_pool.t</a></span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connect_handler"><a href="#val-connect_handler" class="anchor"></a><code><span><span class="keyword">val</span> connect_handler : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="../P2p_connect_handler/index.html#type-t">P2p_connect_handler.t</a></span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-faked_network"><a href="#val-faked_network" class="anchor"></a><code><span><span class="keyword">val</span> faked_network : 
  <span><span><span class="type-var">'msg</span> <a href="../../../octez-libs/Tezos_base/P2p_params/index.html#type-message_config">Tezos_base.TzPervasives.P2p_params.message_config</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'peer_meta</span> <a href="../../../octez-libs/Tezos_base/P2p_params/index.html#type-peer_meta_config">Tezos_base.TzPervasives.P2p_params.peer_meta_config</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'conn_meta</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span></span></code></div><div class="spec-doc"><p>A faked p2p layer, which do not initiate any connection nor open any listening socket</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">config</span>:<a href="#type-config">config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">limits</span>:<a href="../../../octez-libs/Tezos_p2p_services/P2p_limits/index.html#type-t">Tezos_p2p_services.P2p_limits.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?received_msg_hook</span>:
    <span>(<span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?sent_msg_hook</span>:<span>(<span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?broadcasted_msg_hook</span>:
    <span>(<span><span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span>
       <a href="../../../octez-libs/Tezos_base/P2p_peer_id/Table/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Table.t</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="optlabel">?except</span>:<span>(<span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="optlabel">?alt</span>:<span>(<span>(<span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span> bool)</span> * <span class="type-var">'msg</span>)</span> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span>
      unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'peer_meta</span> <a href="../../../octez-libs/Tezos_base/P2p_params/index.html#type-peer_meta_config">Tezos_base.TzPervasives.P2p_params.peer_meta_config</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'conn_meta</span> <a href="../../../octez-libs/Tezos_base/P2p_params/index.html#type-conn_meta_config">Tezos_base.TzPervasives.P2p_params.conn_meta_config</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'msg</span> <a href="../../../octez-libs/Tezos_base/P2p_params/index.html#type-message_config">Tezos_base.TzPervasives.P2p_params.message_config</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Main network initialization function</p><p><code>received_msg_hook</code> is a function that is called every time a message <code>'msg</code> is received. <code>sent_msg_hook</code> is a function that is called every time a message <code>'msg</code> is sent. <code>broadcasted_msg_hook</code> is a function that is called every time a message <code>'msg</code> is broadcasted.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-activate"><a href="#val-activate" class="anchor"></a><code><span><span class="keyword">val</span> activate : <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-peer_id"><a href="#val-peer_id" class="anchor"></a><code><span><span class="keyword">val</span> peer_id : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a></span></code></div><div class="spec-doc"><p>Return one's peer_id</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-maintain"><a href="#val-maintain" class="anchor"></a><code><span><span class="keyword">val</span> maintain : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>A maintenance operation : try and reach the ideal number of peers</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-roll"><a href="#val-roll" class="anchor"></a><code><span><span class="keyword">val</span> roll : <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Voluntarily drop some peers and replace them by new buddies</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Close all connections properly</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connections"><a href="#val-connections" class="anchor"></a><code><span><span class="keyword">val</span> connections : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> list</span></span></code></div><div class="spec-doc"><p>Access the domain of active peers</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_connection_by_peer_id"><a href="#val-find_connection_by_peer_id" class="anchor"></a><code><span><span class="keyword">val</span> find_connection_by_peer_id : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> option</span></span></code></div><div class="spec-doc"><p>Return the active peer with identity <code>peer_id</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_connection_by_point"><a href="#val-find_connection_by_point" class="anchor"></a><code><span><span class="keyword">val</span> find_connection_by_point : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> option</span></span></code></div><div class="spec-doc"><p>Return the active peer corresponding to <code>point</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connection_info"><a href="#val-connection_info" class="anchor"></a><code><span><span class="keyword">val</span> connection_info : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'conn_meta</span> <a href="../../../octez-libs/Tezos_base/P2p_connection/Info/index.html#type-t">Tezos_base.TzPervasives.P2p_connection.Info.t</a></span></span></code></div><div class="spec-doc"><p>Access the info of an active peer, if available</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connection_local_metadata"><a href="#val-connection_local_metadata" class="anchor"></a><code><span><span class="keyword">val</span> connection_local_metadata : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'conn_meta</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connection_remote_metadata"><a href="#val-connection_remote_metadata" class="anchor"></a><code><span><span class="keyword">val</span> connection_remote_metadata : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'conn_meta</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connection_stat"><a href="#val-connection_stat" class="anchor"></a><code><span><span class="keyword">val</span> connection_stat : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../octez-libs/Tezos_base/P2p_stat/index.html#type-t">Tezos_base.TzPervasives.P2p_stat.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-negotiated_version"><a href="#val-negotiated_version" class="anchor"></a><code><span><span class="keyword">val</span> negotiated_version : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../octez-libs/Tezos_version/Network_version/index.html#type-t">Tezos_base.TzPervasives.Network_version.t</a></span></code></div><div class="spec-doc"><p>Returns the network version that will be used for this connection. This network version is the best version compatible with the versions supported by ours and the remote peer.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-disconnect"><a href="#val-disconnect" class="anchor"></a><code><span><span class="keyword">val</span> disconnect : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?wait</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">reason</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Cleanly closes a connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-global_stat"><a href="#val-global_stat" class="anchor"></a><code><span><span class="keyword">val</span> global_stat : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../octez-libs/Tezos_base/P2p_stat/index.html#type-t">Tezos_base.TzPervasives.P2p_stat.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_peer_metadata"><a href="#val-get_peer_metadata" class="anchor"></a><code><span><span class="keyword">val</span> get_peer_metadata : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'peer_meta</span></span></code></div><div class="spec-doc"><p>Accessors for meta information about a global identifier</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_peer_metadata"><a href="#val-set_peer_metadata" class="anchor"></a><code><span><span class="keyword">val</span> set_peer_metadata : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'peer_meta</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connect"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?trusted</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?expected_peer_id</span>:<a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?timeout</span>:<span class="xref-unresolved">Ptime</span>.span <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>connect net ?trusted ?expected_peer_id ?timeout point</code> attempts to establish a connection to <code>point</code> within an optional duration <code>timeout</code>. The optional arguments <code>trusted</code> and <code>expected_peer_id</code> can be used to specify whether the connection should be trusted and to provide the expected remote peer's id, respectively.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-recv"><a href="#val-recv" class="anchor"></a><code><span><span class="keyword">val</span> recv : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'msg</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a message from a given connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-recv_any"><a href="#val-recv_any" class="anchor"></a><code><span><span class="keyword">val</span> recv_any : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> * <span class="type-var">'msg</span>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a message from any active connections.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-send"><a href="#val-send" class="anchor"></a><code><span><span class="keyword">val</span> send : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>send net peer msg</code> is a thread that returns when <code>msg</code> has been successfully enqueued in the send queue.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-try_send"><a href="#val-try_send" class="anchor"></a><code><span><span class="keyword">val</span> try_send : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div><div class="spec-doc"><p><code>try_send net peer msg</code> is <code>true</code> if <code>msg</code> has been added to the send queue for <code>peer</code>, <code>false</code> otherwise</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-broadcast"><a href="#val-broadcast" class="anchor"></a><code><span><span class="keyword">val</span> broadcast : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span>
    <a href="../../../octez-libs/Tezos_base/P2p_peer_id/Table/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Table.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?except</span>:<span>(<span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?alt</span>:<span>(<span>(<span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span> bool)</span> * <span class="type-var">'msg</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'msg</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>broadcast net connections ~except ~(alt:if_conn,then_msg) msg</code> will send messages to all <code>connections</code> that do not satisfy the predicate <code>except</code>. <code>alt</code> can be used to send an alternative message <code>then_msg</code> to connections that do satisfy the <code>if_conn</code> predicate. <code>?except</code> and <code>?alt</code> can be used to selectively transfer messages.</p><p>Broadcasting is best effort and nothing ensures that messages are actually received (https://gitlab.com/tezos/tezos/-/issues/4205).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fold_connections"><a href="#val-fold_connections" class="anchor"></a><code><span><span class="keyword">val</span> fold_connections : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">init</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">f</span>:
    <span>(<span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
      <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-iter_connections"><a href="#val-iter_connections" class="anchor"></a><code><span><span class="keyword">val</span> iter_connections : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
    unit)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-on_new_connection"><a href="#val-on_new_connection" class="anchor"></a><code><span><span class="keyword">val</span> on_new_connection : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-connection">connection</a></span> <span class="arrow">&#45;&gt;</span></span>
    unit)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>on_new_connection p2p f</code> registers a function <code>f</code> that is called everytime we were successfully connected to a peer (after having initialised a secured channel).</p><p>This function will not be called if we started to connect to a peer and the connection was rejected during the initialisation of the connection. For example, if the peer is using a different network version.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-on_disconnection"><a href="#val-on_disconnection" class="anchor"></a><code><span><span class="keyword">val</span> on_disconnection : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>on_disconnection p2p f</code> registers a function <code>f</code> that is called everytime we disconnect from a peer after we were successfully connected to a peer (this call may happen at any moment during the disconnection). The library ensures that anytime <code>f peer</code> is called, then for any callback registered with <code>on_new_connection</code>, those callbacks would have been called with <code>peer</code> in the first place (if the callbacks were registered at that time).</p><p>A direct implication of this is that any callback registered with this function will not be called if we started to connect to a peer and we disconnect from it because the connection was rejected somehow.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-greylist_addr"><a href="#val-greylist_addr" class="anchor"></a><code><span><span class="keyword">val</span> greylist_addr : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-greylist_peer"><a href="#val-greylist_peer" class="anchor"></a><code><span><span class="keyword">val</span> greylist_peer : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.TzPervasives.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-watcher"><a href="#val-watcher" class="anchor"></a><code><span><span class="keyword">val</span> watcher : 
  <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer_meta</span>, <span class="type-var">'conn_meta</span>)</span> <a href="#type-net">net</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_connection/P2p_event/index.html#type-t">Tezos_base.TzPervasives.P2p_connection.P2p_event.t</a> <span class="xref-unresolved">Lwt_stream</span>.t</span>
  * <span class="xref-unresolved">Lwt_watcher</span>.stopper</span></code></div></div></div></body></html>
