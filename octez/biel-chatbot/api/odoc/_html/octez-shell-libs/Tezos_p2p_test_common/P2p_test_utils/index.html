<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>P2p_test_utils (octez-shell-libs.Tezos_p2p_test_common.P2p_test_utils)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_p2p_test_common</a> &#x00BB; P2p_test_utils</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_p2p_test_common.P2p_test_utils</span></code></h1><p>This module provides functions used for tests.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-timeout_t"><a href="#type-timeout_t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a timeout_t</span></span><span> = </span><span>{</span></code><ol><li id="type-timeout_t.time" class="def record field anchored"><a href="#type-timeout_t.time" class="anchor"></a><code><span>time : float;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Duration of the timeout.</p><span class="comment-delim">*)</span></div></li><li id="type-timeout_t.msg" class="def record field anchored"><a href="#type-timeout_t.msg" class="anchor"></a><code><span>msg : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> string;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Create the error message.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Is a timeout used with <code>wait_pred</code> function.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_pred"><a href="#val-wait_pred" class="anchor"></a><code><span><span class="keyword">val</span> wait_pred : 
  <span><span class="optlabel">?timeout</span>:<span><span class="type-var">'a</span> <a href="#type-timeout_t">timeout_t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">pred</span>:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">arg</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>wait_pred</code> wait until <code>pred arg</code> is true. If <code>pred</code> is not satisfy after <code>timeout.time</code> seconds a <code>Timeout (timeout.msg arg)</code> error is raised.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_pred_s"><a href="#val-wait_pred_s" class="anchor"></a><code><span><span class="keyword">val</span> wait_pred_s : 
  <span><span class="optlabel">?timeout</span>:<span><span class="type-var">'a</span> <a href="#type-timeout_t">timeout_t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">pred</span>:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">arg</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <code>wait_pred</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_conns"><a href="#val-wait_conns" class="anchor"></a><code><span><span class="keyword">val</span> wait_conns : 
  <span><span class="optlabel">?timeout</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">pool</span>:<span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'c</span>)</span> <a href="../../Tezos_p2p/P2p_pool/index.html#type-t">Tezos_p2p.P2p_pool.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Based on <code>wait_pred</code>. <code>wait_conns ~pool n</code> waits until at least <code>n</code> connections are actives in <code>~pool</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connect_all"><a href="#val-connect_all" class="anchor"></a><code><span><span class="keyword">val</span> connect_all : 
  <span><span class="optlabel">?timeout</span>:<a href="../../../octez-libs/Tezos_base/Time/System/Span/index.html#type-t">Tezos_base.TzPervasives.Time.System.Span.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'c</span>)</span> <a href="../../Tezos_p2p/P2p_connect_handler/index.html#type-t">Tezos_p2p.P2p_connect_handler.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'c</span>)</span> <a href="../../Tezos_p2p/P2p_conn/index.html#type-t">Tezos_p2p.P2p_conn.t</a></span> list</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>connect_all connect_handler points</code> establishes the connections to <code>points</code> using <code>connect_handler</code> and returns them. If one connection need more than <code>?timeout</code> seconds to be established, the function fails with <code>Timeout</code> error.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close_active_conns"><a href="#val-close_active_conns" class="anchor"></a><code><span><span class="keyword">val</span> close_active_conns : <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'c</span>)</span> <a href="../../Tezos_p2p/P2p_pool/index.html#type-t">Tezos_p2p.P2p_pool.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close_active_conns pool@</code> closes all actives connections of the pool. This function waits until the connections are effectively closed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-version"><a href="#val-version" class="anchor"></a><code><span><span class="keyword">val</span> version : <a href="../../../octez-libs/Tezos_version/Network_version/index.html#type-t">Tezos_base.TzPervasives.Network_version.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-conn_meta_config"><a href="#val-conn_meta_config" class="anchor"></a><code><span><span class="keyword">val</span> conn_meta_config : <span>unit <a href="../../../octez-libs/Tezos_base/P2p_params/index.html#type-conn_meta_config">Tezos_base.TzPervasives.P2p_params.conn_meta_config</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-canceler"><a href="#val-canceler" class="anchor"></a><code><span><span class="keyword">val</span> canceler : <span class="xref-unresolved">Lwt_canceler</span>.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-proof_of_work_target"><a href="#val-proof_of_work_target" class="anchor"></a><code><span><span class="keyword">val</span> proof_of_work_target : <a href="../../../octez-libs/Tezos_crypto/Crypto_box/index.html#type-pow_target">Tezos_crypto.Crypto_box.pow_target</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-id1"><a href="#val-id1" class="anchor"></a><code><span><span class="keyword">val</span> id1 : <span><a href="../../../octez-libs/Tezos_base/P2p_identity/index.html#type-t">Tezos_base.TzPervasives.P2p_identity.t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-id2"><a href="#val-id2" class="anchor"></a><code><span><span class="keyword">val</span> id2 : <span><a href="../../../octez-libs/Tezos_base/P2p_identity/index.html#type-t">Tezos_base.TzPervasives.P2p_identity.t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run_nodes"><a href="#val-run_nodes" class="anchor"></a><code><span><span class="keyword">val</span> run_nodes : 
  <span><span class="label">addr</span>:<a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span>(unit, unit)</span> <a href="../Process/Channel/index.html#type-t">Process.Channel.t</a></span> <span class="arrow">&#45;&gt;</span></span>
    <span><a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-t">Tezos_p2p.P2p_io_scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span class="xref-unresolved">Ipaddr</span>.V6.t <span class="arrow">&#45;&gt;</span></span>
    <span>int <span class="arrow">&#45;&gt;</span></span>
    <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
      <span class="xref-unresolved">Stdlib</span>.result</span>
      <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span>(unit, unit)</span> <a href="../Process/Channel/index.html#type-t">Process.Channel.t</a></span> <span class="arrow">&#45;&gt;</span></span>
    <span><a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-t">Tezos_p2p.P2p_io_scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span>
    <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
      <span class="xref-unresolved">Stdlib</span>.result</span>
      <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run_nodes_fd"><a href="#val-run_nodes_fd" class="anchor"></a><code><span><span class="keyword">val</span> run_nodes_fd : 
  <span><span class="label">addr</span>:<a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?port</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span>(unit, unit)</span> <a href="../Process/Channel/index.html#type-t">Process.Channel.t</a></span> <span class="arrow">&#45;&gt;</span></span>
    <span><span class="xref-unresolved">Ipaddr</span>.V6.t <span class="arrow">&#45;&gt;</span></span>
    <span>int <span class="arrow">&#45;&gt;</span></span>
    <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
      <span class="xref-unresolved">Stdlib</span>.result</span>
      <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span>(unit, unit)</span> <a href="../Process/Channel/index.html#type-t">Process.Channel.t</a></span> <span class="arrow">&#45;&gt;</span></span>
    <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span>
    <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
      <span class="xref-unresolved">Stdlib</span>.result</span>
      <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-raw_accept"><a href="#val-raw_accept" class="anchor"></a><code><span><span class="keyword">val</span> raw_accept : 
  <span><a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-t">Tezos_p2p.P2p_io_scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-connection">Tezos_p2p.P2p_io_scheduler.connection</a>
   * <span>(<a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> * int)</span>,
    <a href="../../Tezos_p2p/P2p_fd/index.html#type-accept_error">Tezos_p2p.P2p_fd.accept_error</a>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-accept"><a href="#val-accept" class="anchor"></a><code><span><span class="keyword">val</span> accept : 
  <span><span class="optlabel">?id</span>:<span><a href="../../../octez-libs/Tezos_base/P2p_identity/index.html#type-t">Tezos_base.TzPervasives.P2p_identity.t</a> <span class="xref-unresolved">Lwt</span>.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?proof_of_work_target</span>:<a href="../../../octez-libs/Tezos_crypto/Crypto_box/index.html#type-pow_target">Tezos_crypto.Crypto_box.pow_target</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-t">Tezos_p2p.P2p_io_scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span>unit <a href="../../../octez-libs/Tezos_base/P2p_connection/Info/index.html#type-t">Tezos_base.TzPervasives.P2p_connection.Info.t</a></span>
   * <span>unit <a href="../../Tezos_p2p/P2p_socket/index.html#type-authenticated_connection">Tezos_p2p.P2p_socket.authenticated_connection</a></span>,
    <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-raw_connect"><a href="#val-raw_connect" class="anchor"></a><code><span><span class="keyword">val</span> raw_connect : 
  <span><a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-t">Tezos_p2p.P2p_io_scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-connection">Tezos_p2p.P2p_io_scheduler.connection</a>, <a href="../../Tezos_p2p/P2p_fd/index.html#type-connect_error">Tezos_p2p.P2p_fd.connect_error</a>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-connect"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : 
  <span><span class="optlabel">?proof_of_work_target</span>:<a href="../../../octez-libs/Tezos_crypto/Crypto_box/index.html#type-pow_target">Tezos_crypto.Crypto_box.pow_target</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_p2p/P2p_io_scheduler/index.html#type-t">Tezos_p2p.P2p_io_scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_identity/index.html#type-t">Tezos_base.TzPervasives.P2p_identity.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span>unit <a href="../../../octez-libs/Tezos_base/P2p_connection/Info/index.html#type-t">Tezos_base.TzPervasives.P2p_connection.Info.t</a></span>
   * <span>unit <a href="../../Tezos_p2p/P2p_socket/index.html#type-authenticated_connection">Tezos_p2p.P2p_socket.authenticated_connection</a></span>,
    <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sync"><a href="#val-sync" class="anchor"></a><code><span><span class="keyword">val</span> sync : 
  <span><span><span>(unit, unit)</span> <a href="../Process/Channel/index.html#type-t">Process.Channel.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></div></body></html>
