<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Node (octez-shell-libs.Tezos_p2p_test_common.Node)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_p2p_test_common</a> &#x00BB; Node</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_p2p_test_common.Node</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-message"><a href="#type-message" class="anchor"></a><code><span><span class="keyword">type</span> message</span><span> = </span></code><ol><li id="type-message.Ping" class="def variant constructor anchored"><a href="#type-message.Ping" class="anchor"></a><code><span>| </span><span><span class="constructor">Ping</span></span></code></li><li id="type-message.BigPing" class="def variant constructor anchored"><a href="#type-message.BigPing" class="anchor"></a><code><span>| </span><span><span class="constructor">BigPing</span> <span class="keyword">of</span> <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> list</span></span></code></li></ol></div><div class="spec-doc"><p>Simple p2p message used by the nodes.</p><ul><li><code>Ping</code> is a none-message used by nodes in simple communication tests.</li><li><code>BigPing</code> is used to add arbitrary long data (similar to mempools sent in the actual network) to test bandwidth and chunks splitting.</li></ul></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-metadata"><a href="#type-metadata" class="anchor"></a><code><span><span class="keyword">type</span> metadata</span><span> = </span></code><ol><li id="type-metadata.Metadata" class="def variant constructor anchored"><a href="#type-metadata.Metadata" class="anchor"></a><code><span>| </span><span><span class="constructor">Metadata</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = </span><span>{</span></code><ol><li id="type-t.iteration" class="def record field anchored"><a href="#type-t.iteration" class="anchor"></a><code><span>iteration : <span>int <span class="xref-unresolved">Stdlib</span>.ref</span>;</span></code></li><li id="type-t.channel" class="def record field anchored"><a href="#type-t.channel" class="anchor"></a><code><span>channel : <span><span>(unit, unit)</span> <a href="../Process/Channel/index.html#type-t">Process.Channel.t</a></span>;</span></code></li><li id="type-t.connect_handler" class="def record field anchored"><a href="#type-t.connect_handler" class="anchor"></a><code><span>connect_handler : <span><span>(<a href="#type-message">message</a>, <a href="#type-metadata">metadata</a>, <a href="#type-metadata">metadata</a>)</span> <a href="../../Tezos_p2p/P2p_connect_handler/index.html#type-t">Tezos_p2p.P2p_connect_handler.t</a></span>;</span></code></li><li id="type-t.pool" class="def record field anchored"><a href="#type-t.pool" class="anchor"></a><code><span>pool : <span><span>(<a href="#type-message">message</a>, <a href="#type-metadata">metadata</a>, <a href="#type-metadata">metadata</a>)</span> <a href="../../Tezos_p2p/P2p_pool/index.html#type-t">Tezos_p2p.P2p_pool.t</a></span>;</span></code></li><li id="type-t.watcher" class="def record field anchored"><a href="#type-t.watcher" class="anchor"></a><code><span>watcher : <span><a href="../../../octez-libs/Tezos_base/P2p_connection/P2p_event/index.html#type-t">Tezos_base.TzPervasives.P2p_connection.P2p_event.t</a> <span class="xref-unresolved">Lwt_watcher</span>.input</span>;</span></code></li><li id="type-t.trigger" class="def record field anchored"><a href="#type-t.trigger" class="anchor"></a><code><span>trigger : <a href="../../Tezos_p2p/P2p_trigger/index.html#type-t">Tezos_p2p.P2p_trigger.t</a>;</span></code></li><li id="type-t.points" class="def record field anchored"><a href="#type-t.points" class="anchor"></a><code><span>points : <span><a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> list</span>;</span></code></li><li id="type-t.trusted_points" class="def record field anchored"><a href="#type-t.trusted_points" class="anchor"></a><code><span>trusted_points : <span><a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> list</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p><code>t</code> is a simple p2p nodes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sync"><a href="#val-sync" class="anchor"></a><code><span><span class="keyword">val</span> sync : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>sync node</code> join <code>node</code> to a synchronization barrier.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_ipv6_addr"><a href="#val-default_ipv6_addr" class="anchor"></a><code><span><span class="keyword">val</span> default_ipv6_addr : <a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-gen_points"><a href="#val-gen_points" class="anchor"></a><code><span><span class="keyword">val</span> gen_points : 
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_addr/index.html#type-t">Tezos_base.TzPervasives.P2p_addr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> * <span class="xref-unresolved">Unix</span>.file_descr)</span> list</span></span></code></div><div class="spec-doc"><p><code>gen_points npoints addr</code> generates <code>npoints</code> points using the given <code>addr</code> and an unused port given by the operating system by binding a fresh socket to the port <code>0</code>.</p><p>These sockets are left open and returned by the function with the generated point, so that the operating system cannot reuse this port while the socket is opened.</p><p>The returned sockets are also configured with option <code>SO_REUSEPORT</code> so that user can bind its own socket using the generated point when desired. When a socket has finally been bounded to the given port, the user must close the socket to avoid file descriptor leaks.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-detach_nodes"><a href="#val-detach_nodes" class="anchor"></a><code><span><span class="keyword">val</span> detach_nodes : 
  <span><span class="optlabel">?timeout</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?prefix</span>:<span>(<span>int <span class="arrow">&#45;&gt;</span></span> string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?min_connections</span>:<span>(<span>int <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_connections</span>:<span>(<span>int <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_incoming_connections</span>:<span>(<span>int <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?p2p_versions</span>:<span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../octez-libs/Tezos_version/P2p_version/index.html#type-t">Tezos_base.TzPervasives.P2p_version.t</a> list</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?msg_config</span>:
    <span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-message">message</a> <a href="../../../octez-libs/Tezos_base/P2p_params/index.html#type-message_config">Tezos_base.TzPervasives.P2p_params.message_config</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?trusted</span>:
    <span>(<span>int <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> list</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../octez-libs/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.TzPervasives.P2p_point.Id.t</a> * <span class="xref-unresolved">Unix</span>.file_descr)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>detach_nodes f points</code> creates a network with one node for each <code>points</code>. <code>f</code> is the behavior of each node. If the network is alive after <code>?timeout</code> seconds, if any is provided, the <code>Timeout</code> error is returned. <code>?prefix</code> associates a prefix used for logs to each <code>nodes</code>. <code>?min_connections</code>, <code>?max_connections</code>, <code>?max_incoming_connections</code>, <code>?p2p_versions</code> and <code>?msg_config</code> are used to configure the connect handler of each nodes. <code>?trusted</code> is used to configure the pool of each nodes.</p><p>With each point of <code>points</code> a file descriptor generated by the system that holds the point should be given. This file descriptor will be properly closed by this function. See <code>gen_points</code> for more details.</p></div></div></div></body></html>
