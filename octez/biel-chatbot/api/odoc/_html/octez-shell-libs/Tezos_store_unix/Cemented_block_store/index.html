<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Cemented_block_store (octez-shell-libs.Tezos_store_unix.Cemented_block_store)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_store_unix</a> &#x00BB; Cemented_block_store</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store_unix.Cemented_block_store</span></code></h1><p>Persistent block store with linear history</p><p>The cemented block store is a store where blocks are stored linearly (by level) in chunks. Blocks in this store should not be reorganized anymore and are thus *cemented*. As these blocks should not be accessed regularly and especially their optionally stored metadata, the later are compressed using a zip format to save disk space. For each chunk of blocks, a dedicated file is used. Moreover, to enable easy access and to prevent too much on-disk reading, two indexed maps are used to retrieve blocks hash from their level and their level from the block hash.</p><p>The cemented block store contains a set of files updated each time a new chunk is added to the store. These files indicate which interval of blocks (w.r.t. their levels) are stored in it.</p></header><nav class="odoc-toc"><ul><li><a href="#invariants">Invariants</a></li><li><a href="#files-format">Files format</a></li></ul></nav><div class="odoc-content"><h2 id="invariants"><a href="#invariants" class="anchor"></a>Invariants</h2><p>This store is expected to respect the following invariants:</p><ul><li>A key/value present in an index is present as well in the other as value/key.</li></ul><ul><li>Every block stored is correctly referenced through its associated indexes.</li></ul><ul><li>A cemented chunk of blocks that is represented by the interval <code> i ; j </code> (with i &lt;= j) contains | j - i + 1 | blocks and are ordered from i to j in the file.</li></ul><ul><li>The set F of cemented chunks is always ordered by block level.</li></ul><ul><li>The cemented store does not contain holes: let F be the cemented chunks, if |F| &gt; 1 then:</li></ul><pre>      ∀f_x=(i,j) ∈ F ∧ x &lt; |F|, ∃f_y =(i', j'), x = y - 1 ∧ j + 1 = j'</pre><p>meaning the concatenation of every chunk must be continuous.</p><ul><li>A metadata zip file is indexed by the same interval as the chunks and, when it is the lowest chunk of metadata stored, is not assured to contain every block's metadata of the chunk.</li></ul><h2 id="files-format"><a href="#files-format" class="anchor"></a>Files format</h2><p>The cemented block store is composed of the following files:</p><ul><li>file: /&lt;i_j&gt;, a chunk of blocks from level i to level j. The format of this file is:</li></ul><p>| &lt;n&gt; × &lt;offset&gt; | &lt;n&gt; × &lt;block&gt; |</p><p>where n is (j - i + 1), &lt;offset&gt; is a 8 bytes integer representing the absolute offset of a block where the k-th (with 0 &lt;= k &lt; n) offset stands for the absolute offset of the k-th block in the file and with &lt;block&gt;, a <code>Block_repr.t</code> value encoded using <code>Block_repr.encoding</code> (thus prefixed by the its size).</p><ul><li>dir: /cemented_block_index_level, the Hash -&gt; Level key/value index ;</li></ul><ul><li>dir: /cemented_block_index_hash, the Level -&gt; Hash key/value index.</li></ul><ul><li>dir: /metadata, the directory containing chunks of compressed metadata (present if relevant).</li></ul><ul><li>files: /metadata/&lt;i_j&gt;.zip, the compressed metadata where every chunk of block's metadata is indexed by their level encoded as string (present if relevant).</li></ul><div class="odoc-spec"><div class="spec module anchored" id="module-Cemented_block_level_index"><a href="#module-Cemented_block_level_index" class="anchor"></a><code><span><span class="keyword">module</span> Cemented_block_level_index</span><span> : 
  <span class="xref-unresolved">Index</span>.S
    <span class="keyword">with</span> <span><span class="keyword">type</span> <span class="xref-unresolved">key</span> = <span class="xref-unresolved">Tezos_store_shared</span>.Block_key.t</span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <span class="xref-unresolved">value</span> = <span class="xref-unresolved">Tezos_store_shared</span>.Block_level.t</span></span></code></div><div class="spec-doc"><p>On-disk index of block's hash to level.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Cemented_block_hash_index"><a href="#module-Cemented_block_hash_index" class="anchor"></a><code><span><span class="keyword">module</span> Cemented_block_hash_index</span><span> : 
  <span class="xref-unresolved">Index</span>.S
    <span class="keyword">with</span> <span><span class="keyword">type</span> <span class="xref-unresolved">key</span> = <span class="xref-unresolved">Tezos_store_shared</span>.Block_level.t</span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <span class="xref-unresolved">value</span> = <span class="xref-unresolved">Tezos_store_shared</span>.Block_key.t</span></span></code></div><div class="spec-doc"><p>On-disk index of block's level to hash.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type of the cemented block store</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-cemented_metadata_file"><a href="#type-cemented_metadata_file" class="anchor"></a><code><span><span class="keyword">type</span> cemented_metadata_file</span><span> = </span><span>{</span></code><ol><li id="type-cemented_metadata_file.start_level" class="def record field anchored"><a href="#type-cemented_metadata_file.start_level" class="anchor"></a><code><span>start_level : int32;</span></code></li><li id="type-cemented_metadata_file.end_level" class="def record field anchored"><a href="#type-cemented_metadata_file.end_level" class="anchor"></a><code><span>end_level : int32;</span></code></li><li id="type-cemented_metadata_file.metadata_file" class="def record field anchored"><a href="#type-cemented_metadata_file.metadata_file" class="anchor"></a><code><span>metadata_file : <span><span>[ `Cemented_blocks_metadata ]</span> <a href="../../Tezos_store_shared/Naming/index.html#type-file">Tezos_store_shared.Naming.file</a></span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-cemented_blocks_file"><a href="#type-cemented_blocks_file" class="anchor"></a><code><span><span class="keyword">type</span> cemented_blocks_file</span><span> = </span><span>{</span></code><ol><li id="type-cemented_blocks_file.start_level" class="def record field anchored"><a href="#type-cemented_blocks_file.start_level" class="anchor"></a><code><span>start_level : int32;</span></code></li><li id="type-cemented_blocks_file.end_level" class="def record field anchored"><a href="#type-cemented_blocks_file.end_level" class="anchor"></a><code><span>end_level : int32;</span></code></li><li id="type-cemented_blocks_file.file" class="def record field anchored"><a href="#type-cemented_blocks_file.file" class="anchor"></a><code><span>file : <span><span>[ `Cemented_blocks_file ]</span> <a href="../../Tezos_store_shared/Naming/index.html#type-file">Tezos_store_shared.Naming.file</a></span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The type for cemented block chunks file description</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><span class="optlabel">?log_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>[&lt; `Chain_dir ]</span> <a href="../../Tezos_store_shared/Naming/index.html#type-directory">Tezos_store_shared.Naming.directory</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">readonly</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-t">t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init ?log_size ~cemented_blocks_dir ~readonly</code> creates or loads an existing cemented block store at path <code>cemented_blocks_dir</code>. <code>cemented_blocks_dir</code> will be created if it does not exists. If <code>readonly</code> is true, cementing blocks will result in an error. <code>log_size</code> determines the index cache size.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>close cemented_store</code> closes the <code>cemented_store</code> opened files: its indexes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cemented_blocks_files"><a href="#val-cemented_blocks_files" class="anchor"></a><code><span><span class="keyword">val</span> cemented_blocks_files : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-cemented_blocks_file">cemented_blocks_file</a> array</span> option</span></span></code></div><div class="spec-doc"><p><code>cemented_blocks_files cemented_store</code> returns the <b>current</b> array of cemented blocks chunks files. The returned array is sorted in ascending order such that the first element of the array is the lowest known cycle of the store.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reload_cemented_blocks_files"><a href="#val-reload_cemented_blocks_files" class="anchor"></a><code><span><span class="keyword">val</span> reload_cemented_blocks_files : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>reload_cemented_blocks_files cemented_store</code> updates the cemented store so the latest cemented files are available. This is particularly useful for RO instances.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cemented_metadata_files"><a href="#val-cemented_metadata_files" class="anchor"></a><code><span><span class="keyword">val</span> cemented_metadata_files : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span><a href="#type-cemented_metadata_file">cemented_metadata_file</a> array</span> option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>cemented_metadata_files cemented_store</code> returns the <b>current</b> array of cemented metadata files. The returned array is sorted in ascending order such that the first element of the array is the lowest known cycle of the store.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cemented_block_level_index"><a href="#val-cemented_block_level_index" class="anchor"></a><code><span><span class="keyword">val</span> cemented_block_level_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Cemented_block_level_index</span>.t</span></code></div><div class="spec-doc"><p><code>cemented_block_level_index block_store</code> returns the hash to level index.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cemented_block_hash_index"><a href="#val-cemented_block_hash_index" class="anchor"></a><code><span><span class="keyword">val</span> cemented_block_hash_index : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Cemented_block_hash_index</span>.t</span></code></div><div class="spec-doc"><p><code>cemented_block_hash_index block_store</code> returns the level to hash index.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-may_synchronize_indexes"><a href="#val-may_synchronize_indexes" class="anchor"></a><code><span><span class="keyword">val</span> may_synchronize_indexes : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>may_synchronize_indexes cemented_store</code> updates a RO index instance to allow concurrent access to the value added by a RW instance. This operation is expected to be cheap (~10us) and has no effect on RW instances.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-load_table"><a href="#val-load_table" class="anchor"></a><code><span><span class="keyword">val</span> load_table : 
  <span><span><span>[ `Cemented_blocks_dir ]</span> <a href="../../Tezos_store_shared/Naming/index.html#type-directory">Tezos_store_shared.Naming.directory</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span><a href="#type-cemented_blocks_file">cemented_blocks_file</a> array</span> option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>load_table ~cemented_blocks_dir</code> reads the <code>cemented_blocks_dir</code> directory and instantiate the cemented blocks chunks files.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-load_metadata_table"><a href="#val-load_metadata_table" class="anchor"></a><code><span><span class="keyword">val</span> load_metadata_table : 
  <span><span><span>[ `Cemented_blocks_dir ]</span> <a href="../../Tezos_store_shared/Naming/index.html#type-directory">Tezos_store_shared.Naming.directory</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span><a href="#type-cemented_metadata_file">cemented_metadata_file</a> array</span> option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>load_metadata_table ~cemented_blocks_dir</code> similar to <code>load_table</code>, but for the cemented metadata files.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_block_file"><a href="#val-find_block_file" class="anchor"></a><code><span><span class="keyword">val</span> find_block_file : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int32 <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-cemented_blocks_file">cemented_blocks_file</a> option</span></span></code></div><div class="spec-doc"><p><code>find_block_file cemented_store block_level</code> lookups the <code>cemented_store</code> to find the cemented block chunk file that contains the block at level <code>block_level</code>. Returns <code>None</code> if the block cannot be found.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_cemented"><a href="#val-is_cemented" class="anchor"></a><code><span><span class="keyword">val</span> is_cemented : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_cemented cemented_store block_hash</code> checks if the <code>block_hash</code> is stored in the <code>cemented_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_cemented_block_level"><a href="#val-get_cemented_block_level" class="anchor"></a><code><span><span class="keyword">val</span> get_cemented_block_level : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int32 option</span></span></code></div><div class="spec-doc"><p><code>get_cemented_block_level cemented_store block_hash</code> returns the level of the <code>block_hash</code> if present in <code>cemented_store</code>. Returns <code>None</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_cemented_block_hash"><a href="#val-get_cemented_block_hash" class="anchor"></a><code><span><span class="keyword">val</span> get_cemented_block_hash : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int32 <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> option</span></span></code></div><div class="spec-doc"><p><code>get_cemented_block_hash cemented_store block_level</code> returns the hash of the block at <code>block_level</code> if present in <code>cemented_store</code>. Returns <code>None</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_block_metadata"><a href="#val-read_block_metadata" class="anchor"></a><code><span><span class="keyword">val</span> read_block_metadata : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int32 <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Tezos_store_shared/Block_repr/index.html#type-metadata">Tezos_store_shared.Block_repr.metadata</a> option</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_block_metadata cemented_store block_level</code> returns the metadata of the block at <code>block_level</code> if present in <code>cemented_store</code>. Returns <code>None</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cement_blocks_metadata"><a href="#val-cement_blocks_metadata" class="anchor"></a><code><span><span class="keyword">val</span> cement_blocks_metadata : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Tezos_store_shared/Block_repr/index.html#type-t">Tezos_store_shared.Block_repr.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>cement_blocks_metadata cemented_store chunk</code> compresses and stores the metadata of blocks present in <code>chunk</code>. If no block of the given <code>chunk</code> contains metadata, nothing is done. Otherwise, for every block containing metadata, an entry is written in the dedicated .zip metadata file.</p><p>We assume that the blocks containing metadata are contiguous and if at least one block has metadata, then the blocks from that block with metadata to the last block of <code>chunk</code> must have metadata. However, we do not check the validity of this assumption.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_lowest_cemented_level"><a href="#val-get_lowest_cemented_level" class="anchor"></a><code><span><span class="keyword">val</span> get_lowest_cemented_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int32 option</span></span></code></div><div class="spec-doc"><p><code>get_lowest_cemented_level cemented_store</code> returns the lowest cemented block in <code>cemented_store</code>, if it exists.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_highest_cemented_level"><a href="#val-get_highest_cemented_level" class="anchor"></a><code><span><span class="keyword">val</span> get_highest_cemented_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int32 option</span></span></code></div><div class="spec-doc"><p><code>get_highest_cemented_level cemented_store</code> returns the highest cemented block in <code>cemented_store</code> if it exists.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_cemented_block_by_level"><a href="#val-get_cemented_block_by_level" class="anchor"></a><code><span><span class="keyword">val</span> get_cemented_block_by_level : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">read_metadata</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span>int32 <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Tezos_store_shared/Block_repr/index.html#type-block">Tezos_store_shared.Block_repr.block</a> option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_cemented_block_by_level cemented_store ~read_metadata level</code> reads the cemented block at <code>level</code> in <code>cemented_store</code>, if it exists. It also tries to retrieves the metadata depending on <code>read_metadata</code> but do not fail if no metadata is available.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_cemented_block_by_hash"><a href="#val-get_cemented_block_by_hash" class="anchor"></a><code><span><span class="keyword">val</span> get_cemented_block_by_hash : 
  <span><span class="label">read_metadata</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Tezos_store_shared/Block_repr/index.html#type-block">Tezos_store_shared.Block_repr.block</a> option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_cemented_block_by_hash cemented_store hash</code> reads the cemented block of <code>hash</code> in <code>cemented_store</code>, if it exists. It also retrieves the metadata depending on <code>read_metadata</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-chunk_iterator"><a href="#type-chunk_iterator" class="anchor"></a><code><span><span class="keyword">type</span> chunk_iterator</span><span> = </span><span>{</span></code><ol><li id="type-chunk_iterator.chunk_length" class="def record field anchored"><a href="#type-chunk_iterator.chunk_length" class="anchor"></a><code><span>chunk_length : int;</span></code></li><li id="type-chunk_iterator.reading_sequence" class="def record field anchored"><a href="#type-chunk_iterator.reading_sequence" class="anchor"></a><code><span>reading_sequence : <span><span><span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int * bytes)</span>
                     <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
                     <span class="xref-unresolved">Lwt</span>.t</span>
                     <a href="../../../octez-libs/Tezos_error_monad/TzLwtreslib/Seq/index.html#type-t">Tezos_base.TzPervasives.Seq.t</a></span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The type used to describe reading sequences used to perform buffered block cementing.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make_chunk_iterator"><a href="#val-make_chunk_iterator" class="anchor"></a><code><span><span class="keyword">val</span> make_chunk_iterator : 
  <span><span><a href="../../Tezos_store_shared/Block_repr/index.html#type-block">Tezos_store_shared.Block_repr.block</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-chunk_iterator">chunk_iterator</a></span></code></div><div class="spec-doc"><p><code>make_chunk_iterator bl</code> is an utility function that transforms a <code>Block_repr.block list</code> into a <code>chunk_iterator</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cement_blocks"><a href="#val-cement_blocks" class="anchor"></a><code><span><span class="keyword">val</span> cement_blocks : 
  <span><span class="optlabel">?check_consistency</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">write_metadata</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-chunk_iterator">chunk_iterator</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>cement_blocks ?check_consistency cemented_store ~write_metadata
    chunk_iterator</code> iterates from the lazy-bufferized <code>chunk_iterator</code> to cement blocks and to write their metadata if the flag <code>write_metadata</code> is set. <code>check_consistency</code> (default is true) ensures that the cycles are contiguous.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-trigger_gc"><a href="#val-trigger_gc" class="anchor"></a><code><span><span class="keyword">val</span> trigger_gc : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>trigger_gc cemented_store history_mode</code> garbage collects metadata chunks and/or chunks from the <code>cemented_store</code> depending on the <code>History_mode.t</code>:</p><ul><li>in <code>Archive</code> mode, nothing is done;</li></ul><ul><li>in <code>Full offset</code> mode, only <code>offset</code> chunks of <b>metadata</b> are kept;</li></ul><ul><li>in <code>Rolling offset</code> mode, only <code>offset</code> chunks of <b>metadata and chunks</b> are kept.</li></ul><p><b>Important:</b> when purging chunks of blocks, it is necessary to rewrite the index to remove garbage collected blocks. Therefore, the higher the offset is, the longest the GC phase will last.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-iter_cemented_file"><a href="#val-iter_cemented_file" class="anchor"></a><code><span><span class="keyword">val</span> iter_cemented_file : 
  <span><span>(<span><a href="../../Tezos_store_shared/Block_repr/index.html#type-block">Tezos_store_shared.Block_repr.block</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-cemented_blocks_file">cemented_blocks_file</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>iter_cemented_file ~cemented_block_dir f block_file</code> reads from the cemented <code>block_file</code> located in <code>cemented_block_dir</code> and applies <code>f</code> on every block.</p><p><b>Warning</b>: in this version, exceptions are caught. Use <code>raw_iter_cemented_file</code> for manual exception management.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-raw_iter_cemented_file"><a href="#val-raw_iter_cemented_file" class="anchor"></a><code><span><span class="keyword">val</span> raw_iter_cemented_file : 
  <span><span>(<span><a href="../../Tezos_store_shared/Block_repr/index.html#type-block">Tezos_store_shared.Block_repr.block</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-cemented_blocks_file">cemented_blocks_file</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Unsafe version of <code>iter_cemented_file</code> where internal exceptions/errors are not caught.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_indexes_consistency"><a href="#val-check_indexes_consistency" class="anchor"></a><code><span><span class="keyword">val</span> check_indexes_consistency : 
  <span><span class="optlabel">?post_step</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?genesis_hash</span>:<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>check_indexes_consistency ?post_step ?genesis_hash cemented_store
    history_mode</code> iterates over a partially initialized <code>cemented_store</code> that contains both chunks of blocks and indexes then check the consistency of each block: (hashes, predecessors and levels). The hash is not checked for <code>genesis_hash</code> and <code>post_step</code> is called after each treated chunk. This is used for snapshot imports.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-stat_metadata_cycles"><a href="#val-stat_metadata_cycles" class="anchor"></a><code><span><span class="keyword">val</span> stat_metadata_cycles : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(string * <span><a href="../../Tezos_store_shared/Store_types/index.html#type-metadata_stat">Tezos_store_shared.Store_types.metadata_stat</a> list</span>)</span> list</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Utility function that aims to give an overview of the shape of the store's metadata.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_and_upgrade_offsets"><a href="#val-get_and_upgrade_offsets" class="anchor"></a><code><span><span class="keyword">val</span> get_and_upgrade_offsets : <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>bytes <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_and_upgrade_offsets fd nb_blocks</code> obtains the list of <code>nb_blocks</code> offsets from the beginning of the file given by file descriptor <code>fd</code> and upgrades their sizes from 32-bits to 64-bits, adjusting their values for the following blocks in the cemented blocks file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-v_3_2_upgrade"><a href="#val-v_3_2_upgrade" class="anchor"></a><code><span><span class="keyword">val</span> v_3_2_upgrade : 
  <span><span><span>[ `Chain_dir ]</span> <a href="../../Tezos_store_shared/Naming/index.html#type-directory">Tezos_store_shared.Naming.directory</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></div></body></html>
