<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Block_repr (octez-shell-libs.Tezos_store_shared.Block_repr)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_store_shared</a> &#x00BB; Block_repr</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store_shared.Block_repr</span></code></h1><p>Block representation effectively stored on disk and its accessors.</p></header><nav class="odoc-toc"><ul><li><a href="#type-definitions-and-encodings">Type definitions and encodings</a></li><li><a href="#genesis">Genesis</a></li><li><a href="#accessors">Accessors</a><ul><li><a href="#block-header-accessors">Block header accessors</a></li><li><a href="#metadata-accessors">Metadata accessors</a></li></ul></li><li><a href="#utility-functions">Utility functions</a></li></ul></nav><div class="odoc-content"><h2 id="type-definitions-and-encodings"><a href="#type-definitions-and-encodings" class="anchor"></a>Type definitions and encodings</h2><div class="odoc-spec"><div class="spec type anchored" id="type-contents"><a href="#type-contents" class="anchor"></a><code><span><span class="keyword">type</span> contents</span><span> = </span><span>{</span></code><ol><li id="type-contents.header" class="def record field anchored"><a href="#type-contents.header" class="anchor"></a><code><span>header : <a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.TzPervasives.Block_header.t</a>;</span></code></li><li id="type-contents.operations" class="def record field anchored"><a href="#type-contents.operations" class="anchor"></a><code><span>operations : <span><span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.TzPervasives.Operation.t</a> list</span> list</span>;</span></code></li><li id="type-contents.block_metadata_hash" class="def record field anchored"><a href="#type-contents.block_metadata_hash" class="anchor"></a><code><span>block_metadata_hash : <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_metadata_hash/index.html#type-t">Tezos_base.TzPervasives.Block_metadata_hash.t</a> option</span>;</span></code></li><li id="type-contents.operations_metadata_hashes" class="def record field anchored"><a href="#type-contents.operations_metadata_hashes" class="anchor"></a><code><span>operations_metadata_hashes : <span><span><span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_metadata_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_metadata_hash.t</a>
                               list</span>
                               list</span>
                               option</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The type for the effective <code>contents</code> of a block is its header and the <code>operations</code> it contains. Their metadata hashes are also present.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-metadata"><a href="#type-metadata" class="anchor"></a><code><span><span class="keyword">type</span> metadata</span><span> = </span><span>{</span></code><ol><li id="type-metadata.message" class="def record field anchored"><a href="#type-metadata.message" class="anchor"></a><code><span>message : <span>string option</span>;</span></code></li><li id="type-metadata.max_operations_ttl" class="def record field anchored"><a href="#type-metadata.max_operations_ttl" class="anchor"></a><code><span>max_operations_ttl : int;</span></code></li><li id="type-metadata.last_preserved_block_level" class="def record field anchored"><a href="#type-metadata.last_preserved_block_level" class="anchor"></a><code><span>last_preserved_block_level : <span class="xref-unresolved">Stdlib</span>.Int32.t;</span></code></li><li id="type-metadata.block_metadata" class="def record field anchored"><a href="#type-metadata.block_metadata" class="anchor"></a><code><span>block_metadata : <a href="../../../octez-libs/Tezos_base/TzPervasives/Bytes/index.html#type-t">Tezos_base.TzPervasives.Bytes.t</a>;</span></code></li><li id="type-metadata.operations_metadata" class="def record field anchored"><a href="#type-metadata.operations_metadata" class="anchor"></a><code><span>operations_metadata : <span><span><a href="../../Tezos_validation/Block_validation/index.html#type-operation_metadata">Tezos_validation.Block_validation.operation_metadata</a> list</span>
                        list</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The type for a block's <code>metadata</code> stored on disk. This representation is tightly linked to <a href="../../Tezos_validation/Block_validation/index.html#type-result"><code>Tezos_validation.Block_validation.result</code></a> which also has a strong dependency to <a href="../../../octez-proto-libs/Tezos_protocol_environment/index.html#type-validation_result"><code>Tezos_protocol_environment.validation_result</code></a>.</p><p>Some fields exposed by <a href="../../Tezos_validation/Block_validation/index.html#type-result"><code>Tezos_validation.Block_validation.result</code></a> are unnecessary hence the lack of direct link.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block"><a href="#type-block" class="anchor"></a><code><span><span class="keyword">type</span> block</span><span> = </span><span>{</span></code><ol><li id="type-block.hash" class="def record field anchored"><a href="#type-block.hash" class="anchor"></a><code><span>hash : <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a>;</span></code></li><li id="type-block.contents" class="def record field anchored"><a href="#type-block.contents" class="anchor"></a><code><span>contents : <a href="#type-contents">contents</a>;</span></code></li><li id="type-block.metadata" class="def record field anchored"><a href="#type-block.metadata" class="anchor"></a><code><span><span class="keyword">mutable</span> metadata : <span><a href="#type-metadata">metadata</a> option</span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The type for a <code>block</code> stored on disk.</p><p>The <code>hash</code> of the block is also stored to improve efficiency by not forcing the user to hash the header. This also allows to store fake hashes (e.g. sandbox's genesis blocks) but should be prevented by the API.</p><p>The <code>metadata</code> might not be present. The mutability flag allows users to re-use the same structure to store freshly loaded metadata.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="#type-block">block</a></span></code></div></div><h2 id="genesis"><a href="#genesis" class="anchor"></a>Genesis</h2><div class="odoc-spec"><div class="spec value anchored" id="val-create_genesis_block"><a href="#val-create_genesis_block" class="anchor"></a><code><span><span class="keyword">val</span> create_genesis_block : 
  <span><span class="label">genesis</span>:<a href="../../../octez-libs/Tezos_base/Genesis/index.html#type-t">Tezos_base.TzPervasives.Genesis.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Context_hash/index.html#type-t">Tezos_base.TzPervasives.Context_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create_genesis_block ~genesis context_hash</code> creates a default genesis block for the given <code>genesis</code> and its <code>context_hash</code> that contains metadata.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-contents_encoding"><a href="#val-contents_encoding" class="anchor"></a><code><span><span class="keyword">val</span> contents_encoding : <span><a href="#type-contents">contents</a> <a href="../../../octez-libs/Data_encoding/index.html#type-t">Tezos_base.TzPervasives.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-contents"><code>contents</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-metadata_encoding"><a href="#val-metadata_encoding" class="anchor"></a><code><span><span class="keyword">val</span> metadata_encoding : <span><a href="#type-metadata">metadata</a> <a href="../../../octez-libs/Data_encoding/index.html#type-t">Tezos_base.TzPervasives.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-metadata"><code>metadata</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Equality on <a href="#type-block"><code>block</code></a></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : <span><a href="#type-t">t</a> <a href="../../../octez-libs/Data_encoding/index.html#type-t">Tezos_base.TzPervasives.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-t"><code>t</code></a> (and <a href="#type-block"><code>block</code></a>).</p><p><b>Important</b> An encoded block is prefixed by 4 bytes which stands for the length of the data. This is the case with <code>Data_encoding.dynamic_size ~kind:`Uint30</code> encodings. This will be expected to be present to improve the store efficiency.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_json"><a href="#val-pp_json" class="anchor"></a><code><span><span class="keyword">val</span> pp_json : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>pp_json</code> pretty-print a block as JSON.</p></div></div><h2 id="accessors"><a href="#accessors" class="anchor"></a>Accessors</h2><div class="odoc-spec"><div class="spec value anchored" id="val-descriptor"><a href="#val-descriptor" class="anchor"></a><code><span><span class="keyword">val</span> descriptor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Store_types/index.html#type-block_descriptor">Store_types.block_descriptor</a></span></code></div><div class="spec-doc"><p><code>descriptor block</code> returns the pair (hash x level) of <code>block</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a></span></code></div><div class="spec-doc"><p><code>hash block</code> returns the stored <code>block</code>'s hash. It is not guaranteed to be the same as <code>Block_header.hash (header block)</code> (e.g. in sandbox, the genesis block might have a fake hash).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operations"><a href="#val-operations" class="anchor"></a><code><span><span class="keyword">val</span> operations : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.TzPervasives.Operation.t</a> list</span> list</span></span></code></div><div class="spec-doc"><p><code>operations block</code> returns the list of list of operations contained in the <code>block</code>.</p></div></div><h3 id="block-header-accessors"><a href="#block-header-accessors" class="anchor"></a>Block header accessors</h3><div class="odoc-spec"><div class="spec value anchored" id="val-header"><a href="#val-header" class="anchor"></a><code><span><span class="keyword">val</span> header : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.TzPervasives.Block_header.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shell_header"><a href="#val-shell_header" class="anchor"></a><code><span><span class="keyword">val</span> shell_header : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.TzPervasives.Block_header.shell_header</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-level"><a href="#val-level" class="anchor"></a><code><span><span class="keyword">val</span> level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Stdlib</span>.Int32.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-proto_level"><a href="#val-proto_level" class="anchor"></a><code><span><span class="keyword">val</span> proto_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-predecessor"><a href="#val-predecessor" class="anchor"></a><code><span><span class="keyword">val</span> predecessor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-timestamp"><a href="#val-timestamp" class="anchor"></a><code><span><span class="keyword">val</span> timestamp : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/Time/Protocol/index.html#type-t">Tezos_base.TzPervasives.Time.Protocol.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validation_passes"><a href="#val-validation_passes" class="anchor"></a><code><span><span class="keyword">val</span> validation_passes : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operations_hash"><a href="#val-operations_hash" class="anchor"></a><code><span><span class="keyword">val</span> operations_hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_list_list_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_list_list_hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fitness"><a href="#val-fitness" class="anchor"></a><code><span><span class="keyword">val</span> fitness : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/Fitness/index.html#type-t">Tezos_base.TzPervasives.Fitness.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-context"><a href="#val-context" class="anchor"></a><code><span><span class="keyword">val</span> context : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Context_hash/index.html#type-t">Tezos_base.TzPervasives.Context_hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-protocol_data"><a href="#val-protocol_data" class="anchor"></a><code><span><span class="keyword">val</span> protocol_data : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/TzPervasives/Bytes/index.html#type-t">Tezos_base.TzPervasives.Bytes.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_metadata_hash"><a href="#val-block_metadata_hash" class="anchor"></a><code><span><span class="keyword">val</span> block_metadata_hash : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_metadata_hash/index.html#type-t">Tezos_base.TzPervasives.Block_metadata_hash.t</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operations_metadata_hashes"><a href="#val-operations_metadata_hashes" class="anchor"></a><code><span><span class="keyword">val</span> operations_metadata_hashes : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_metadata_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_metadata_hash.t</a> list</span> list</span> option</span></span></code></div></div><h3 id="metadata-accessors"><a href="#metadata-accessors" class="anchor"></a>Metadata accessors</h3><div class="odoc-spec"><div class="spec value anchored" id="val-metadata"><a href="#val-metadata" class="anchor"></a><code><span><span class="keyword">val</span> metadata : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-metadata">metadata</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-message"><a href="#val-message" class="anchor"></a><code><span><span class="keyword">val</span> message : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-max_operations_ttl"><a href="#val-max_operations_ttl" class="anchor"></a><code><span><span class="keyword">val</span> max_operations_ttl : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-last_preserved_block_level"><a href="#val-last_preserved_block_level" class="anchor"></a><code><span><span class="keyword">val</span> last_preserved_block_level : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Stdlib</span>.Int32.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_metadata"><a href="#val-block_metadata" class="anchor"></a><code><span><span class="keyword">val</span> block_metadata : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> bytes</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operations_metadata"><a href="#val-operations_metadata" class="anchor"></a><code><span><span class="keyword">val</span> operations_metadata : 
  <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Tezos_validation/Block_validation/index.html#type-operation_metadata">Tezos_validation.Block_validation.operation_metadata</a> list</span> list</span></span></code></div></div><h2 id="utility-functions"><a href="#utility-functions" class="anchor"></a>Utility functions</h2><div class="odoc-spec"><div class="spec value anchored" id="val-check_block_consistency"><a href="#val-check_block_consistency" class="anchor"></a><code><span><span class="keyword">val</span> check_block_consistency : 
  <span><span class="optlabel">?genesis_hash</span>:<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?pred_block</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>check_block_consistency ?genesis_hash ?pred_block block</code> checks that the stored data is consistent:</p><ul><li>Does the <code>hash</code> stored equals the result of <code>Block_header.hash</code> of its header and, if not, is this the stored <code>genesis_hash</code>?</li><li>Is the <code>block</code> a successor of <code>pred_block</code> with regards to its level and its predecessor's hash?</li><li>Are the stored operations hashes consistent regarding the stored operations hashes?</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decode_metadata"><a href="#val-decode_metadata" class="anchor"></a><code><span><span class="keyword">val</span> decode_metadata : <span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-metadata">metadata</a> option</span></span></code></div><div class="spec-doc"><p><code>decode_metadata data</code> decodes metadata from <code>data</code> encoded either with the new encoding or the legacy one.</p></div></div></div></body></html>
