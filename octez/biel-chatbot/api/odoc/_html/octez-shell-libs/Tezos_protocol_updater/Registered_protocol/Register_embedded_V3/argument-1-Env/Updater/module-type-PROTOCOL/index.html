<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>PROTOCOL (octez-shell-libs.Tezos_protocol_updater.Registered_protocol.Register_embedded_V3.Env.Updater.PROTOCOL)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../../index.html">octez-shell-libs</a> &#x00BB; <a href="../../../../../index.html">Tezos_protocol_updater</a> &#x00BB; <a href="../../../../index.html">Registered_protocol</a> &#x00BB; <a href="../../../index.html">Register_embedded_V3</a> &#x00BB; <a href="../../index.html">Env</a> &#x00BB; <a href="../index.html">Updater</a> &#x00BB; PROTOCOL</nav><header class="odoc-preamble"><h1>Module type <code><span>Updater.PROTOCOL</span></code></h1><p>This is the signature of a Tezos protocol implementation. It has access to the standard library and the Environment module.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-max_block_length"><a href="#val-max_block_length" class="anchor"></a><code><span><span class="keyword">val</span> max_block_length : int</span></code></div><div class="spec-doc"><p>The maximum size of a block header in bytes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-max_operation_data_length"><a href="#val-max_operation_data_length" class="anchor"></a><code><span><span class="keyword">val</span> max_operation_data_length : int</span></code></div><div class="spec-doc"><p>The maximum size of an operation in bytes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validation_passes"><a href="#val-validation_passes" class="anchor"></a><code><span><span class="keyword">val</span> validation_passes : <span><a href="../index.html#type-quota">quota</a> list</span></span></code></div><div class="spec-doc"><p>Operations quota for each validation pass. The length of the list denotes the number of validation passes.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_header_data"><a href="#type-block_header_data" class="anchor"></a><code><span><span class="keyword">type</span> block_header_data</span></code></div><div class="spec-doc"><p>The economic protocol-specific type of blocks.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_header_data_encoding"><a href="#val-block_header_data_encoding" class="anchor"></a><code><span><span class="keyword">val</span> block_header_data_encoding : <span><a href="#type-block_header_data">block_header_data</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for economic protocol-specific part of block headers.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_header"><a href="#type-block_header" class="anchor"></a><code><span><span class="keyword">type</span> block_header</span><span> = </span><span>{</span></code><ol><li id="type-block_header.shell" class="def record field anchored"><a href="#type-block_header.shell" class="anchor"></a><code><span>shell : <a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a>;</span></code></li><li id="type-block_header.protocol_data" class="def record field anchored"><a href="#type-block_header.protocol_data" class="anchor"></a><code><span>protocol_data : <a href="#type-block_header_data">block_header_data</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A fully parsed block header.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_header_metadata"><a href="#type-block_header_metadata" class="anchor"></a><code><span><span class="keyword">type</span> block_header_metadata</span></code></div><div class="spec-doc"><p>Economic protocol-specific side information computed by the protocol during the validation of a block. Should not include information about the evaluation of operations which is handled separately by <code>operation_metadata</code>. To be used as an execution trace by tools (client, indexer). Not necessary for validation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block_header_metadata_encoding"><a href="#val-block_header_metadata_encoding" class="anchor"></a><code><span><span class="keyword">val</span> block_header_metadata_encoding : <span><a href="#type-block_header_metadata">block_header_metadata</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for economic protocol-specific block metadata.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-operation_data"><a href="#type-operation_data" class="anchor"></a><code><span><span class="keyword">type</span> operation_data</span></code></div><div class="spec-doc"><p>The economic protocol-specific type of operations.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-operation_receipt"><a href="#type-operation_receipt" class="anchor"></a><code><span><span class="keyword">type</span> operation_receipt</span></code></div><div class="spec-doc"><p>Economic protocol-specific side information computed by the protocol during the validation of each operation, to be used conjointly with <a href="#type-block_header_metadata"><code>block_header_metadata</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-operation"><a href="#type-operation" class="anchor"></a><code><span><span class="keyword">type</span> operation</span><span> = </span><span>{</span></code><ol><li id="type-operation.shell" class="def record field anchored"><a href="#type-operation.shell" class="anchor"></a><code><span>shell : <a href="../../Operation/index.html#type-shell_header">Operation.shell_header</a>;</span></code></li><li id="type-operation.protocol_data" class="def record field anchored"><a href="#type-operation.protocol_data" class="anchor"></a><code><span>protocol_data : <a href="#type-operation_data">operation_data</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A fully parsed operation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_data_encoding"><a href="#val-operation_data_encoding" class="anchor"></a><code><span><span class="keyword">val</span> operation_data_encoding : <span><a href="#type-operation_data">operation_data</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for economoic protocol-specific operation data.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_receipt_encoding"><a href="#val-operation_receipt_encoding" class="anchor"></a><code><span><span class="keyword">val</span> operation_receipt_encoding : <span><a href="#type-operation_receipt">operation_receipt</a> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for eonomic protocol-specific operation receipts.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_data_and_receipt_encoding"><a href="#val-operation_data_and_receipt_encoding" class="anchor"></a><code><span><span class="keyword">val</span> operation_data_and_receipt_encoding : 
  <span><span>(<a href="#type-operation_data">operation_data</a> * <a href="#type-operation_receipt">operation_receipt</a>)</span> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding that mixes an operation data and its receipt.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-acceptable_passes"><a href="#val-acceptable_passes" class="anchor"></a><code><span><span class="keyword">val</span> acceptable_passes : <span><a href="#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span> <span>int list</span></span></code></div><div class="spec-doc"><p><code>acceptable_passes op</code> lists the validation passes in which the input operation <code>op</code> can appear. For instance, it results in <code>[0]</code> if <code>op</code> only belongs to the first pass. An answer of <code>[]</code> means that the <code>op</code> is ill-formed and cannot be included at all in a block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-relative_position_within_block"><a href="#val-relative_position_within_block" class="anchor"></a><code><span><span class="keyword">val</span> relative_position_within_block : <span><a href="#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>relative_position_within_block op1 op2</code> provides a partial and strict order of operations within a block. It is intended to be used as an argument to <a href="../../List/index.html#val-sort"><code>List.sort</code></a> (and other sorting/ordering functions) to arrange a set of operations into a sequence, the order of which is valid for the protocol.</p><p>A negative (respectively, positive) results means that <code>op1</code> should appear before (and, respectively, after) <code>op2</code> in a block. This function does not provide a total ordering on the operations: a result of <code>0</code> entails that the protocol does not impose any preferences to the order in which <code>op1</code> and <code>op2</code> should be included in a block.</p><p><b>Caveat Emptor!</b> <code>relative_position_within_block o1 o2 = 0</code> does NOT imply that <code>o1</code> is equal to <code>o2</code> in any way. Consequently, it <em>MUST NOT</em> be used as a <code>compare</code> component of an <code>Stdlib.Map.OrderedType</code>, or any such collection which relies on a total comparison function.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-validation_state"><a href="#type-validation_state" class="anchor"></a><code><span><span class="keyword">type</span> validation_state</span></code></div><div class="spec-doc"><p>A functional state that is transmitted through the steps of a block validation sequence: it can be created by any of the <code>begin_x</code> functions below, and its final value is produced by <a href="#val-finalize_block"><code>finalize_block</code></a>. It must retain the current state of the store, and it can also contain additional information that must be remembered during the validation process. Said extra content must however be immutable: validator or baker implementations are allowed to pause, replay or backtrack throughout validation steps.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_partial_application"><a href="#val-begin_partial_application" class="anchor"></a><code><span><span class="keyword">val</span> begin_partial_application : 
  <span><span class="label">chain_id</span>:<a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ancestor_context</span>:<a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_fitness</span>:<a href="../../Fitness/index.html#type-t">Fitness.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-block_header">block_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>begin_partial_application cid ctxt</code> checks that a block is well-formed in a given context. This function should run quickly, as its main use is to reject bad blocks from the chain as early as possible. The input <code>ancestor_context</code> is expected to result from the application of an ancestor block of the current head with the same economic protocol. Said ancestor block is also required to be more recent (i.e., it has a greater level), than the current head's &quot;last_allowed_fork_level&quot;.</p><p>The resulting `validation_state` will be used for multi-pass validation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_application"><a href="#val-begin_application" class="anchor"></a><code><span><span class="keyword">val</span> begin_application : 
  <span><span class="label">chain_id</span>:<a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_context</span>:<a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_fitness</span>:<a href="../../Fitness/index.html#type-t">Fitness.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-block_header">block_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>begin_application chain_id ... bh</code> defines the first step in a block validation sequence. It initializes a validation context for validating a block, whose header is <code>bh</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_construction"><a href="#val-begin_construction" class="anchor"></a><code><span><span class="keyword">val</span> begin_construction : 
  <span><span class="label">chain_id</span>:<a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_context</span>:<a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../../Int32/index.html#type-t">Int32.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_fitness</span>:<a href="../../Fitness/index.html#type-t">Fitness.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Block_hash/index.html#type-t">Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?protocol_data</span>:<a href="#type-block_header_data">block_header_data</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>begin_construction</code> initializes a validation context for constructing a new block, as opposed to validating an existing block.</p><p>This function can be used in two modes: with and without the optional <code>protocol_data</code> argument. With the latter, it is used by bakers to start the process for baking a new block. Without it, is used by the Shell's prevalidator to construct a virtual block, which carries the contents of the pre-applied operations of the mempool.</p><p>When <code>protocol_data</code> is provided, it is not expected to be the final value of the field of the same name in the <a href="#type-block_header"><code>block_header</code></a> of the block eventually being baked. Instead, it is expected to construct a protocol-specific, good enough, &quot;prototype&quot; of its final value. For instance, if the economic protocol specifies that its block headers include a signature, <code>protocol_data</code> must include a (faked) signature.</p><p>Moreover, these prototypes should not be distinguishable after the application of <code>begin_construction</code>: the function must produce the exact same context regardless of being passed a prototype, or an &quot;equivalent-but-complete&quot; header.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_operation"><a href="#val-apply_operation" class="anchor"></a><code><span><span class="keyword">val</span> apply_operation : 
  <span><a href="#type-validation_state">validation_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-validation_state">validation_state</a> * <a href="#type-operation_receipt">operation_receipt</a>)</span> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>apply_operation vs op</code> applies the input operation <code>op</code> on top of the given <a href="#type-validation_state"><code>validation_state</code></a> <code>vs</code>. It must be called after <a href="#val-begin_application"><code>begin_application</code></a> or <a href="#val-begin_construction"><code>begin_construction</code></a>, and before <a href="#val-finalize_block"><code>finalize_block</code></a>, for each operation in a block. On a successful application, it returns a pair consisting of the resulting <code>validation_state</code>, and the corresponding <code>operation_receipt</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_block"><a href="#val-finalize_block" class="anchor"></a><code><span><span class="keyword">val</span> finalize_block : 
  <span><a href="#type-validation_state">validation_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../index.html#type-validation_result">validation_result</a> * <a href="#type-block_header_metadata">block_header_metadata</a>)</span> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>finalize_block vs</code> finalizes the context resulting from the application of the contents of the block being validated.</p><p>If there is no protocol migration, i.e., if the block being applied is not the last block of the current economic protocol, the resulting context can be used in the future as input for the validation of its successor blocks.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_services"><a href="#val-rpc_services" class="anchor"></a><code><span><span class="keyword">val</span> rpc_services : <span><a href="../index.html#type-rpc_context">rpc_context</a> <a href="../../RPC_directory/index.html#type-t">RPC_directory.t</a></span></span></code></div><div class="spec-doc"><p><code>rpc_services</code> provides the list of remote procedures exported by this protocol implementation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Block_header/index.html#type-shell_header">Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../index.html#type-validation_result">validation_result</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>init ctxt hd</code> initializes the context, or upgrades the context after a protocol amendment. This function receives as arguments the context <code>ctxt</code> resulting from the application of the block that triggered the amendment, as well as its header <code>hd</code>. This function should fail if the &quot;protocol stitching&quot;, i.e., the transition from a valid previous protocol to the one being activated, has not been implemented.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-value_of_key"><a href="#val-value_of_key" class="anchor"></a><code><span><span class="keyword">val</span> value_of_key : 
  <span><span class="label">chain_id</span>:<a href="../../Chain_id/index.html#type-t">Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_context</span>:<a href="../../Context/index.html#type-t">Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../../Int32/index.html#type-t">Int32.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_fitness</span>:<a href="../../Fitness/index.html#type-t">Fitness.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Block_hash/index.html#type-t">Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timestamp</span>:<a href="../../Time/index.html#type-t">Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../../Context/Cache/index.html#type-key">Context.Cache.key</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span><a href="../../Context/Cache/index.html#type-value">Context.Cache.value</a> <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span> <a href="../../Lwt/index.html#type-t">Lwt.t</a></span>)</span>
    <a href="../../Error_monad/index.html#type-tzresult">Error_monad.tzresult</a></span>
    <a href="../../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>value_of_key chain_id predecessor_context
     predecessor_timestamp predecessor_level predecessor_fitness
     predecessor timestamp</code> returns a function to build one value of the cache from its key.</p><p>This function is used to restore all or part of the cache, for instance when booting a validator to preheat the cache, or when a reorganization happens. This function should never fail, returned errors are fatal.</p><p>The generated function is passed to <code>Context.Cache.load_caches</code> which will use it either immediately a cache-loading time or on-demand, when a given cached value is accessed.</p></div></div></div></body></html>
