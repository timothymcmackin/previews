<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>With_JSON_discriminant (octez-shell-libs.Tezos_protocol_updater.Registered_protocol.Register_embedded_V10.Env.Data_encoding.With_JSON_discriminant)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../../../../../index.html">octez-shell-libs</a> &#x00BB; <a href="../../../../../index.html">Tezos_protocol_updater</a> &#x00BB; <a href="../../../../index.html">Registered_protocol</a> &#x00BB; <a href="../../../index.html">Register_embedded_V10</a> &#x00BB; <a href="../../index.html">Env</a> &#x00BB; <a href="../index.html">Data_encoding</a> &#x00BB; With_JSON_discriminant</nav><header class="odoc-preamble"><h1>Module <code><span>Data_encoding.With_JSON_discriminant</span></code></h1><p><code>With_JSON_discriminant</code> is a subset of <code>Encoding</code> where the union/matching combinators (and associated functions) add discriminant for the JSON backend.</p><p>The following restrictions apply:</p><ul><li>The case encodings must be objects.</li><li>The case encoding objects must not include a &quot;kind&quot; field.</li><li>The case encoding objects must not have duplicate field names.</li><li>The JSON discriminants must all be distinct.</li></ul><pre class="language-ocaml"><code>let e =
  let open Data_encoding in
  let open Data_encoding.With_JSON_discriminant in
  …</code></pre></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-case_tag"><a href="#type-case_tag" class="anchor"></a><code><span><span class="keyword">type</span> case_tag</span><span> = </span></code><ol><li id="type-case_tag.Tag" class="def variant constructor anchored"><a href="#type-case_tag.Tag" class="anchor"></a><code><span>| </span><span><span class="constructor">Tag</span> <span class="keyword">of</span> int * string</span></code></li></ol></div><div class="spec-doc"><p><code>case_tag</code>'s only variant <code>Tag</code> includes both a numeric tag for the binary encoding and a string tag for the JSON encoding.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-case"><a href="#type-case" class="anchor"></a><code><span><span class="keyword">type</span> <span>'t case</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-case"><a href="#val-case" class="anchor"></a><code><span><span class="keyword">val</span> case : 
  <span><span class="label">title</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?description</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-case_tag">case_tag</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../index.html#type-encoding">encoding</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'t</span> <a href="#type-case">case</a></span></span></code></div><div class="spec-doc"><p><code>case</code> is similar to <code>Encoding.case</code> but it takes a <code>SaferEncoding.case_tag</code> parameter. This includes both a numeric tag and a string tag.</p><p>In Binary: This has no impact. The <code>case_tag</code> argument of <code>Encoding</code> already has a numeric tag.</p><p>In JSON: The <code>SaferEncoding</code> adds a field for discriminating the different cases, making these encodings less likely to include accidental bugs. More specifically, when you use <code>case (Tag (_, s)) e _ _</code> then the underlying union uses an encoding based on <code>e</code> and <code>s</code>. Specifically, if <code>e</code> is an object encoding, then it adds the field <code>(req &quot;kind&quot; (constant s))</code> to <code>e</code>.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if <code>e</code> is not an object.</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if <code>e</code> is an object with a <code>&quot;kind&quot;</code> field (this field name is reserved for the discriminating field added by <code>case</code>).</p></li></ul></div></div><p><code>union</code> and <code>matching</code> now check that there are no duplicate <code>&quot;kind&quot;</code> discriminating values. If there is, they raises <code>Invalid_argument</code>.</p><div class="odoc-spec"><div class="spec value anchored" id="val-matched"><a href="#val-matched" class="anchor"></a><code><span><span class="keyword">val</span> matched : 
  <span><span class="optlabel">?tag_size</span>:<a href="../index.html#type-tag_size">tag_size</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(int * string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../index.html#type-encoding">encoding</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../index.html#type-match_result">match_result</a></span></code></div><div class="spec-doc"><p>Similarly to <code>case_tag</code>, <code>matched</code> also takes an additional <code>string</code> parameter. This parameter is used in the same way as <code>case</code> (to add a <code>&quot;kind&quot;</code> field to the JSON encoding) and it fails in the same way as <code>case</code>.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if the encoding is not an object.</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if the encoding is an object with a <code>&quot;kind&quot;</code> field.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-matching"><a href="#val-matching" class="anchor"></a><code><span><span class="keyword">val</span> matching : 
  <span><span class="optlabel">?tag_size</span>:<a href="../index.html#type-tag_size">tag_size</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'t</span> <a href="../index.html#type-matching_function">matching_function</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span class="type-var">'t</span> <a href="#type-case">case</a></span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'t</span> <a href="../index.html#type-encoding">encoding</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-union"><a href="#val-union" class="anchor"></a><code><span><span class="keyword">val</span> union : <span><span class="optlabel">?tag_size</span>:<a href="../index.html#type-tag_size">tag_size</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span><span class="type-var">'t</span> <a href="#type-case">case</a></span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'t</span> <a href="../index.html#type-encoding">encoding</a></span></span></code></div></div></div></body></html>
