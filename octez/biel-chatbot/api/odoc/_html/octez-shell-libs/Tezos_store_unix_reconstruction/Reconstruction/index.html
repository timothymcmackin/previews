<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Reconstruction (octez-shell-libs.Tezos_store_unix_reconstruction.Reconstruction)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_store_unix_reconstruction</a> &#x00BB; Reconstruction</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store_unix_reconstruction.Reconstruction</span></code></h1><p>Storage reconstruction</p><p>The storage reconstruction feature aims to re-compute the contexts (ledger state) and the blocks metadata of a full mode storage, and thus, migrate a storage from a full history mode to an archive one.</p><p>To do so, it is needed to re-validate the whole chain, by applying (using the standard validation method: <a href="../../Tezos_validation/Block_validation/index.html#val-apply"><code>Tezos_validation.Block_validation.apply</code></a>) all the blocks from the genesis on empty context. As a storage running a full history mode will not store all the ledger state but keeps all the blocks (and operations), it is the only mode that can be reconstructed. The operation consist of two major steps:</p><ul><li>Reconstructing the cemented block store: for each cemented cycle, the context of each block along with their associated metadatas are restored.</li><li>Reconstructing the floating block stores: this step is only necessary if the store was recently imported from a snapshot as some metadata will be missing.</li></ul><p>As the reconstruction procedure changes the state of the storage, it cannot be run while a node is running on the storage to reconstruct. If the reconstruction is interrupted, it will be resumed if restarted.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-failure_kind"><a href="#type-failure_kind" class="anchor"></a><code><span><span class="keyword">type</span> failure_kind</span><span> = </span></code><ol><li id="type-failure_kind.Nothing_to_reconstruct" class="def variant constructor anchored"><a href="#type-failure_kind.Nothing_to_reconstruct" class="anchor"></a><code><span>| </span><span><span class="constructor">Nothing_to_reconstruct</span></span></code></li><li id="type-failure_kind.Cannot_read_block_hash" class="def variant constructor anchored"><a href="#type-failure_kind.Cannot_read_block_hash" class="anchor"></a><code><span>| </span><span><span class="constructor">Cannot_read_block_hash</span> <span class="keyword">of</span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a></span></code></li><li id="type-failure_kind.Cannot_read_block_level" class="def variant constructor anchored"><a href="#type-failure_kind.Cannot_read_block_level" class="anchor"></a><code><span>| </span><span><span class="constructor">Cannot_read_block_level</span> <span class="keyword">of</span> <span class="xref-unresolved">Stdlib</span>.Int32.t</span></code></li><li id="type-failure_kind.Cannot_read_resulting_context_hash" class="def variant constructor anchored"><a href="#type-failure_kind.Cannot_read_resulting_context_hash" class="anchor"></a><code><span>| </span><span><span class="constructor">Cannot_read_resulting_context_hash</span> <span class="keyword">of</span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Reconstruction_failure"><a href="#extension-decl-Reconstruction_failure" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> += </span></code><ol><li id="extension-Reconstruction_failure" class="def variant extension anchored"><a href="#extension-Reconstruction_failure" class="anchor"></a><code><span>| </span><span><span class="extension">Reconstruction_failure</span> <span class="keyword">of</span> <a href="#type-failure_kind">failure_kind</a></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Cannot_reconstruct"><a href="#extension-decl-Cannot_reconstruct" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> += </span></code><ol><li id="extension-Cannot_reconstruct" class="def variant extension anchored"><a href="#extension-Cannot_reconstruct" class="anchor"></a><code><span>| </span><span><span class="extension">Cannot_reconstruct</span> <span class="keyword">of</span> <a href="../../Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reconstruct"><a href="#val-reconstruct" class="anchor"></a><code><span><span class="keyword">val</span> reconstruct : 
  <span><span class="optlabel">?patch_context</span>:
    <span>(<span><a href="../../../octez-proto-libs/Tezos_protocol_environment/Context/index.html#type-t">Tezos_protocol_environment.Context.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span><a href="../../../octez-proto-libs/Tezos_protocol_environment/Context/index.html#type-t">Tezos_protocol_environment.Context.t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
        <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">store_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">context_root_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Genesis/index.html#type-t">Tezos_base.TzPervasives.Genesis.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">user_activated_upgrades</span>:<a href="../../../octez-libs/Tezos_base/User_activated/index.html#type-upgrades">Tezos_base.TzPervasives.User_activated.upgrades</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">user_activated_protocol_overrides</span>:
    <a href="../../../octez-libs/Tezos_base/User_activated/index.html#type-protocol_overrides">Tezos_base.TzPervasives.User_activated.protocol_overrides</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">operation_metadata_size_limit</span>:
    <a href="../../Tezos_shell_services/Shell_limits/index.html#type-operation_metadata_size_limit">Tezos_shell_services.Shell_limits.operation_metadata_size_limit</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">progress_display_mode</span>:<a href="../../../octez-libs/Tezos_stdlib_unix/Animation/index.html#type-progress_display_mode">Tezos_stdlib_unix.Animation.progress_display_mode</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>reconstruct ?patch_context ~store_dir ~context_root_dir genesis uau
    uapo omsl</code> reconstructs the storage located in <code>store_dir</code> and <code>context_root_dir</code>. The resulting storage will see its history mode changed to archive.</p></div></div></div></body></html>
