<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Distributed_db (octez-shell-libs.Tezos_shell.Distributed_db)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Distributed_db</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.Distributed_db</span></code></h1><p>Tezos Shell - High-level API for the Gossip network and local storage.</p><p>It provides functions to query *static* resources such as blocks headers, operations, and functions to access dynamic resources such as heads and chains.</p><p>Several chains (mainchain, testchain, ...) can be managed independently. First a chain is activated using <code>activate</code>, which provides a <code>chain_db</code> from which it is possible to access resources. Eventually the chain is deactivated using <code>deactivate</code>.</p><p>Static resources are accessible via &quot;Requester&quot; modules (<code>Block_header</code>, <code>Operation</code>, <code>Operations</code>, <code>Protocol</code>). These modules act as read-through caches in front of the local storage <code>State</code> and the p2p layer. They centralize concurrent requests, and cache results in memory. They don't update <code>State</code> directly.</p><p>For instance, from a block_header hash, one can fetch the actual block header using <code>Block_header.fetch</code>, then the block operations with <code>Operations.fetch</code>.</p></header><nav class="odoc-toc"><ul><li><a href="#network-database">Network database</a></li><li><a href="#sending-messages">Sending messages</a><ul><li><a href="#block-index">Block index</a></li><li><a href="#operations-index">Operations index</a></li><li><a href="#protocol-index">Protocol index</a></li></ul></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Message"><a href="#module-Message" class="anchor"></a><code><span><span class="keyword">module</span> Message</span><span> = <a href="../Distributed_db_message/index.html">Distributed_db_message</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-db"><a href="#type-db" class="anchor"></a><code><span><span class="keyword">type</span> db</span><span> = <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-p2p"><a href="#type-p2p" class="anchor"></a><code><span><span class="keyword">type</span> p2p</span><span> =
  <span><span>(<a href="../Distributed_db_message/index.html#type-t">Message.t</a>,
    <a href="../../../octez-libs/Tezos_p2p_services/Peer_metadata/index.html#type-t">Tezos_p2p_services.Peer_metadata.t</a>,
    <a href="../../../octez-libs/Tezos_p2p_services/Connection_metadata/index.html#type-t">Tezos_p2p_services.Connection_metadata.t</a>)</span>
    <a href="../../Tezos_p2p/P2p/index.html#type-net">Tezos_p2p.P2p.net</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><a href="../../Tezos_store/Store/index.html#type-t">Tezos_store.Store.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-p2p">p2p</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-store"><a href="#val-store" class="anchor"></a><code><span><span class="keyword">val</span> store : <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Tezos_store/Store/index.html#type-t">Tezos_store.Store.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><h2 id="network-database"><a href="#network-database" class="anchor"></a>Network database</h2><div class="odoc-spec"><div class="spec type anchored" id="type-chain_db"><a href="#type-chain_db" class="anchor"></a><code><span><span class="keyword">type</span> chain_db</span></code></div><div class="spec-doc"><p>An instance of the distributed DB for a given chain</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-activate"><a href="#val-activate" class="anchor"></a><code><span><span class="keyword">val</span> activate : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_store/Store/Chain/index.html#type-t">Tezos_store.Store.Chain.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../P2p_reader/index.html#type-callback">P2p_reader.callback</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-chain_db">chain_db</a></span></code></div><div class="spec-doc"><p>The first call to <code>activate t chain callbacks</code> activates <code>chain</code>, creates a <code>chain_db</code> and sends a <code>Get_current_branch chain_id</code> message to all neighbors, where <code>chain_id</code> is the identifier of <code>chain</code>. This informs the neighbors that this node expects notifications for new heads/mempools. The given <code>callbacks</code> are given to the <code>P2p_reader</code> for each <code>peer</code>:</p><ul><li><code>notify_branch peer locator</code> is called when the <code>P2p_reader</code> receives the message <code>Current_branch (chain, locator)</code> from peer <code>peer</code>.</li></ul><ul><li><code>notify_head peer head</code> is called when the <code>P2p_reader</code> receives the message <code>Current_head (chain, head, mempool)</code> from peer <code>peer</code>.</li></ul><ul><li><code>Disconnection peer</code> is called when the <code>P2p_reader</code> receives the message <code>Deactivate chain</code> from peer <code>peer</code> or when the <code>P2p_reader</code> associated to <code>peer</code> is shutdown.</li></ul><p>Subsequent calls simply return the existing <code>chain_db</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_chain"><a href="#val-get_chain" class="anchor"></a><code><span><span class="keyword">val</span> get_chain : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Chain_id/index.html#type-t">Tezos_base.TzPervasives.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-chain_db">chain_db</a> option</span></span></code></div><div class="spec-doc"><p>Look for the database of an active chain.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-deactivate"><a href="#val-deactivate" class="anchor"></a><code><span><span class="keyword">val</span> deactivate : <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>deactivate chain_db</code> sends a <code>Deactivate chain_id</code> message to all active neighbors for this chain. This notifies them that this node isn't interested in messages for this chain</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-disconnect"><a href="#val-disconnect" class="anchor"></a><code><span><span class="keyword">val</span> disconnect : 
  <span><span class="label">reason</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Kick a given peer.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-greylist"><a href="#val-greylist" class="anchor"></a><code><span><span class="keyword">val</span> greylist : <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Greylist a given peer.</p></div></div><p>Various accessors.</p><div class="odoc-spec"><div class="spec value anchored" id="val-chain_store"><a href="#val-chain_store" class="anchor"></a><code><span><span class="keyword">val</span> chain_store : <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Tezos_store/Store/index.html#type-chain_store">Tezos_store.Store.chain_store</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-db"><a href="#val-db" class="anchor"></a><code><span><span class="keyword">val</span> db : <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-db">db</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-information"><a href="#val-information" class="anchor"></a><code><span><span class="keyword">val</span> information : 
  <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../Tezos_shell_services/Chain_validator_worker_state/Distributed_db_state/index.html#type-view">Tezos_shell_services.Chain_validator_worker_state.Distributed_db_state.view</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-my_peer_id"><a href="#val-my_peer_id" class="anchor"></a><code><span><span class="keyword">val</span> my_peer_id : <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a></span></code></div><div class="spec-doc"><p>Return the peer id of the node</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_peer_metadata"><a href="#val-get_peer_metadata" class="anchor"></a><code><span><span class="keyword">val</span> get_peer_metadata : 
  <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../octez-libs/Tezos_p2p_services/Peer_metadata/index.html#type-t">Tezos_p2p_services.Peer_metadata.t</a></span></code></div></div><h2 id="sending-messages"><a href="#sending-messages" class="anchor"></a>Sending messages</h2><div class="odoc-spec"><div class="spec module anchored" id="module-Request"><a href="#module-Request" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Request/index.html">Request</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Advertise"><a href="#module-Advertise" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Advertise/index.html">Advertise</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h3 id="block-index"><a href="#block-index" class="anchor"></a>Block index</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Block_header"><a href="#module-Block_header" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Block_header/index.html">Block_header</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Index of block headers.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Operations"><a href="#module-Operations" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Operations/index.html">Operations</a></span><span> : 
  <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html">Tezos_requester.Requester.REQUESTER</a>
    <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-t">t</a> := <a href="#type-chain_db">chain_db</a></span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-key">key</a> = <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int</span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-value">value</a> = <span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span></span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-param">param</a> := <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_list_list_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_list_list_hash.t</a></span></span></code></div><div class="spec-doc"><p>Index of all the operations of a given block (per validation pass).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-commit_block"><a href="#val-commit_block" class="anchor"></a><code><span><span class="keyword">val</span> commit_block : 
  <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Block_header/index.html#type-t">Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_validation/Block_validation/index.html#type-result">Tezos_validation.Block_validation.result</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Store on disk all the data associated to a valid block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-commit_invalid_block"><a href="#val-commit_invalid_block" class="anchor"></a><code><span><span class="keyword">val</span> commit_invalid_block : 
  <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Block_header/index.html#type-t">Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../octez-libs/Tezos_error_monad/Error_monad/index.html#type-error">Tezos_base.TzPervasives.Error_monad.error</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Store on disk all the data associated to an invalid block.</p></div></div><h3 id="operations-index"><a href="#operations-index" class="anchor"></a>Operations index</h3><div class="odoc-spec"><div class="spec value anchored" id="val-inject_operation"><a href="#val-inject_operation" class="anchor"></a><code><span><span class="keyword">val</span> inject_operation : 
  <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Inject a new operation in the local index (memory only).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inject_validated_block"><a href="#val-inject_validated_block" class="anchor"></a><code><span><span class="keyword">val</span> inject_validated_block : 
  <span><a href="#type-chain_db">chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Block_header/index.html#type-t">Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Inject a validated block in the <code>validated_blocks</code> memory table. This is to ensure the data availability of the operations once the block has been validated and advertised to our peers.</p><p>No need to remove the data explicitely of the <code>validated_blocks</code> memory table. The table is handled as an LRU cache.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Operation"><a href="#module-Operation" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Operation/index.html">Operation</a></span><span> : 
  <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html">Tezos_requester.Requester.REQUESTER</a>
    <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-t">t</a> := <a href="#type-chain_db">chain_db</a></span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-key">key</a> := <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a></span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-value">value</a> := <a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a></span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../Tezos_requester/Requester/module-type-REQUESTER/index.html#type-param">param</a> := unit</span></span></code></div><div class="spec-doc"><p>Index of operations (for the mempool).</p></div></div><h3 id="protocol-index"><a href="#protocol-index" class="anchor"></a>Protocol index</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Protocol"><a href="#module-Protocol" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Protocol/index.html">Protocol</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Index of protocol sources.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-commit_protocol"><a href="#val-commit_protocol" class="anchor"></a><code><span><span class="keyword">val</span> commit_protocol : 
  <span><a href="#type-db">db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Protocol/index.html#type-t">Protocol.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>bool <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Store on disk protocol sources.</p></div></div></div></body></html>
