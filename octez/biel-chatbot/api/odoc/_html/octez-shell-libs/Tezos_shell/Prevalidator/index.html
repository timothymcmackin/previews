<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Prevalidator (octez-shell-libs.Tezos_shell.Prevalidator)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Prevalidator</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.Prevalidator</span></code></h1><p>Tezos Shell - Prevalidation of pending operations (a.k.a Mempool)</p></header><div class="odoc-content"><p>The prevalidator is the worker in charge of the <code>mempool</code>, that is, the operations that are not yet included in a block. It keeps track of which operations are valid (according to the economic protocol), maybe-valid-later, or invalid. The prevalidator is also responsible for deciding which operations are appropriate to broadcast to peers.</p><p>Before including an operation into the mempool, the prevalidator performs a few preliminary checks: <code>unparsable</code> operations are noted down so that they will never be considered again; already handled operations or operations that are not branched on any <code>live_block</code> are simply ignored; operations which do not meet some configurable requirements (e.g. minimal fees) are <code>refused</code> at this point.</p><p>If the operation passes these preliminary checks, the prevalidator then asks the protocol to validate the operation in its maintained mempool context. Only an operation that passes this validation gets added to the mempool context and broadcast. If the operation is flat-out <code>refused</code> by the protocol, it is noted down to be ignored by the node from now on. If the operation is only <code>branch_refused</code> or <code>branch_delayed</code>, it is kept for later: it may be evaluated again in the future when the mempool's head (a.k.a. the last block it is built on) changes, then added to the mempool and broadcast if it passes this new validation.</p><p>See the <span class="xref-unresolved" title="prevalidator">prevalidator implementation overview</span> to learn more.</p><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>An (abstract) prevalidator context. Separate prevalidator contexts should be used for separate chains (e.g., mainchain vs testchain).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><a href="../../Tezos_shell_services/Shell_limits/index.html#type-prevalidator_limits">Tezos_shell_services.Shell_limits.prevalidator_limits</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="../../Tezos_validation/Protocol_plugin/module-type-T/index.html">Tezos_validation.Protocol_plugin.T</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Distributed_db/index.html#type-chain_db">Distributed_db.chain_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-t">t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Creates/tear-down a new prevalidator context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-notify_operations"><a href="#val-notify_operations" class="anchor"></a><code><span><span class="keyword">val</span> notify_operations : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Mempool/index.html#type-t">Tezos_base.Mempool.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Notify the prevalidator that the identified peer has sent a bunch of operations relevant to the specified context.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inject_operation"><a href="#val-inject_operation" class="anchor"></a><code><span><span class="keyword">val</span> inject_operation : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">force</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>inject_operation t ~force op</code> notifies the prevalidator worker of a new injected operation. If <code>force</code> is set to <code>true</code> the operation is injected without any check. <code>force</code> should be used for test purpose only.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_shell_services/Chain_validator_worker_state/index.html#type-update">Tezos_shell_services.Chain_validator_worker_state.update</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Block_hash.Set.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Set.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Notify the prevalidator that a new head has been selected. <code>update</code> is used as an optimisation to know which operations previously classified require to be prevalidated again.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-running_workers"><a href="#val-running_workers" class="anchor"></a><code><span><span class="keyword">val</span> running_workers : 
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Chain_id/index.html#type-t">Tezos_base.TzPervasives.Chain_id.t</a>
   * <a href="../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a>
   * <a href="#type-t">t</a>)</span>
    list</span></span></code></div><div class="spec-doc"><p>Returns the list of prevalidation contexts running and their associated chain</p></div></div><p>Worker status and events</p><div class="odoc-spec"><div class="spec value anchored" id="val-status"><a href="#val-status" class="anchor"></a><code><span><span class="keyword">val</span> status : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/Worker_types/index.html#type-worker_status">Tezos_base.Worker_types.worker_status</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pending_requests"><a href="#val-pending_requests" class="anchor"></a><code><span><span class="keyword">val</span> pending_requests : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a>
   * <a href="../../Tezos_shell_services/Prevalidator_worker_state/Request/index.html#type-view">Tezos_shell_services.Prevalidator_worker_state.Request.view</a>)</span>
    list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current_request"><a href="#val-current_request" class="anchor"></a><code><span><span class="keyword">val</span> current_request : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a>
   * <a href="../../../octez-libs/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a>
   * <a href="../../Tezos_shell_services/Prevalidator_worker_state/Request/index.html#type-view">Tezos_shell_services.Prevalidator_worker_state.Request.view</a>)</span>
    option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-information"><a href="#val-information" class="anchor"></a><code><span><span class="keyword">val</span> information : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_base/Worker_types/index.html#type-worker_information">Tezos_base.Worker_types.worker_information</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pipeline_length"><a href="#val-pipeline_length" class="anchor"></a><code><span><span class="keyword">val</span> pipeline_length : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rpc_directory"><a href="#val-rpc_directory" class="anchor"></a><code><span><span class="keyword">val</span> rpc_directory : <span><span><a href="#type-t">t</a> option</span> <a href="../../../octez-libs/Tezos_rpc/Directory/index.html#type-t">Tezos_rpc.Directory.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
