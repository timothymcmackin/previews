<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>P2p_reader (octez-shell-libs.Tezos_shell.P2p_reader)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; P2p_reader</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.P2p_reader</span></code></h1><p>A <code>P2p_reader.t</code> is a worker that answers the application messages (see <code>Messages</code>) received from a remote peer on a <code>P2p.connection</code>.</p><p>The worker behavior is parameterized by callback functions passed by the caller (see type <code>callback</code>).</p><p>Terminology:</p><ul><li>*this peer* refers to the peer running the worker</li><li>the *remote peer* refers to the peer on the other side of the <code>connection</code></li><li>a chain can be *active* or *inactive*. The activation status can refer to this peer, or to the remote peer. If not specified, active/inactive refers to this peer.</li></ul><p>A chain can only be considered active for the remote peer if it is active for this peer. As a general rule, received messages that refer to a specific <code>chain_id</code> that is not active are ignored.</p><p>The protocol is defined as a message handling loop. We can classify a message in three categories. For each category, we describe the worker behavior when receiving the messages.</p><p>1. Administrative message</p><ul><li><code>Deactivate chain_id</code> marks chain <code>chain_id</code> as inactive for the remote peer. Call <code>callback.disconnection gid</code> where <code>gid</code> is the remote peer id.</li></ul><p>2. Chain-related messages</p><p>These messages are used for peers to get the most recent view of the chains they manage.</p><ul><li><code>Get_current_branch chain_id</code> If <code>chain_id</code> is not active for this peer, simply ignores message and returns.</li></ul><p>Only if <code>chain_id</code> is not active for the remote peer, sends a <code>Get_current_branch chain_id</code> message.</p><p>Then (in any case) sends a <code>Current_branch (chain_id, chain_locator)</code> message.</p><ul><li><code>Current_branch (chain_id, locator)</code> activates <code>chain_id</code> for the remote peer if it is not active yet. If the locator contains any block known to be invalid, the connection is closed and the remote peer is greylisted. If the locator head timestamp is more than 15s ahead of this peer system time, the message is ignored. Otherwise calls <code>callback.notify_branch locator</code>.</li></ul><ul><li><code>Get_protocol_branch chain_id proto_level</code> If <code>chain_id</code> is not active for this peer, or if <code>proto_level</code> is unknown simply ignores message and returns. A <code>proto_level</code> is unknown if it is non-positive or if it is strictly higher than the one of the current head.</li></ul><p>Otherwise, sends a message <code>Protocol_branch (chain_id, protocol_locator)</code> where <code>protocol_locator</code> encodes the longest branch where all the blocks are on <code>proto_level</code>. This branch is a subbranch of the current branch for the requested <code>chain_id</code>.</p><ul><li><code>Protocol_branch chain_id proto_level locator</code> is a no-op</li></ul><ul><li><code>Get_current_head chain_id</code>: message is ignored if the chain <code>chain_id</code> is inactive for the remote peer. Otherwise, replies with <code>Current_head (chain_id, head, mempool)</code> where <code>head</code> is the current head for the requested chain. <code>mempool</code> is the current mempool, or an empty mempool if the remote peer's mempool is disabled.</li></ul><ul><li><code>Current_head (chain_id, header, mempool)</code>: message is ignored if the chain <code>chain_id</code> is inactive for the remote peer. If <code>header</code> is known to be invalid, or if the <code>mempool</code> is non empty while this peer's mempool is disabled, the connection is closed and the remote peer is greylisted. If <code>header</code>'s timestamp is more than 15s ahead of this peer system time, the message is ignored. Otherwise, calls <code>callback.notify_head</code>.</li></ul><ul><li><code>Get_checkpoint chain_id</code>: message is ignored if the chain <code>chain_id</code> is inactive for the remote peer. Otherwise, replies with <code>Checkpoint (chain_id, checkpoint)</code> where <code>checkpoint</code> is the current checkpoint for the requested chain.</li></ul><ul><li><code>Checkpoint chain_id header</code> is a no-op</li></ul><p>3. &quot;Database&quot; messages</p><p>These messages are used for peers to exchange &quot;static&quot; resources such as block headers, operations, protocols. The worker collaborates with the requesters defined in <code>Distributed_db</code>. Resources are requested by the requester, and the requester is notified by a <code>P2p_reader</code> upon reception of the resource.</p><ul><li><code>Get_block_headers hashes</code> Sends a <code>Blocker_header header</code> for each of the requested hash known to this peer.</li></ul><ul><li><code>Block_header block</code> notifies the requester that the value has been received. Ignores message if value wasn't requested.</li></ul><ul><li><code>Get_predecessor_header hash n</code> Sends <code>Predecessor_header hash n header</code> where <code>header</code> is the header of the <code>n</code>th predecessor of the block <code>hash</code>.</li></ul><ul><li><code>Predecessor_header hash n header</code> is a no-op.</li></ul><p>The other database messages work similarly</p><ul><li><code>Get_operations hashes</code>/<code>Operation operation</code></li><li><code>Get_protocols hashes</code>/<code>Protocol</code></li><li><code>Get_operation_hashes_for_blocks</code>/<code>Operation_hashes_for_block</code></li><li><code>Get_operations_for_blocks</code>/<code>Operation_for_block</code></li></ul></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Message"><a href="#module-Message" class="anchor"></a><code><span><span class="keyword">module</span> Message</span><span> = <a href="../Distributed_db_message/index.html">Distributed_db_message</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Block_hash_cache"><a href="#module-Block_hash_cache" class="anchor"></a><code><span><span class="keyword">module</span> Block_hash_cache</span><span> : 
  <span class="xref-unresolved">Aches</span>.Vache.MAP <span class="keyword">with</span> <span><span class="keyword">type</span> <span class="xref-unresolved">key</span> = <span class="xref-unresolved">Tezos_base</span>.TzPervasives.Block_hash.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-p2p"><a href="#type-p2p" class="anchor"></a><code><span><span class="keyword">type</span> p2p</span><span> =
  <span><span>(<a href="../Distributed_db_message/index.html#type-t">Message.t</a>,
    <a href="../../../octez-libs/Tezos_p2p_services/Peer_metadata/index.html#type-t">Tezos_p2p_services.Peer_metadata.t</a>,
    <a href="../../../octez-libs/Tezos_p2p_services/Connection_metadata/index.html#type-t">Tezos_p2p_services.Connection_metadata.t</a>)</span>
    <a href="../../Tezos_p2p/P2p/index.html#type-net">Tezos_p2p.P2p.net</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-connection"><a href="#type-connection" class="anchor"></a><code><span><span class="keyword">type</span> connection</span><span> =
  <span><span>(<a href="../Distributed_db_message/index.html#type-t">Message.t</a>,
    <a href="../../../octez-libs/Tezos_p2p_services/Peer_metadata/index.html#type-t">Tezos_p2p_services.Peer_metadata.t</a>,
    <a href="../../../octez-libs/Tezos_p2p_services/Connection_metadata/index.html#type-t">Tezos_p2p_services.Connection_metadata.t</a>)</span>
    <a href="../../Tezos_p2p/P2p/index.html#type-connection">Tezos_p2p.P2p.connection</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-callback"><a href="#type-callback" class="anchor"></a><code><span><span class="keyword">type</span> callback</span><span> = </span><span>{</span></code><ol><li id="type-callback.notify_branch" class="def record field anchored"><a href="#type-callback.notify_branch" class="anchor"></a><code><span>notify_branch : <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../octez-libs/Tezos_base/Block_locator/index.html#type-t">Tezos_base.Block_locator.t</a> <span class="arrow">&#45;&gt;</span></span> unit;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>callback function called on reception of a <code>Current_branch</code> message</p><span class="comment-delim">*)</span></div></li><li id="type-callback.notify_head" class="def record field anchored"><a href="#type-callback.notify_head" class="anchor"></a><code><span>notify_head : <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Mempool/index.html#type-t">Tezos_base.Mempool.t</a> <span class="arrow">&#45;&gt;</span></span>
  unit;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>callback function called on reception of a <code>Current_head</code> message</p><span class="comment-delim">*)</span></div></li><li id="type-callback.disconnection" class="def record field anchored"><a href="#type-callback.disconnection" class="anchor"></a><code><span>disconnection : <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span> unit;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-chain_db"><a href="#type-chain_db" class="anchor"></a><code><span><span class="keyword">type</span> chain_db</span><span> = </span><span>{</span></code><ol><li id="type-chain_db.chain_store" class="def record field anchored"><a href="#type-chain_db.chain_store" class="anchor"></a><code><span>chain_store : <a href="../../Tezos_store/Store/Chain/index.html#type-t">Tezos_store.Store.Chain.t</a>;</span></code></li><li id="type-chain_db.operation_db" class="def record field anchored"><a href="#type-chain_db.operation_db" class="anchor"></a><code><span>operation_db : <a href="../Distributed_db_requester/Raw_operation/index.html#type-t">Distributed_db_requester.Raw_operation.t</a>;</span></code></li><li id="type-chain_db.block_header_db" class="def record field anchored"><a href="#type-chain_db.block_header_db" class="anchor"></a><code><span>block_header_db : <a href="../Distributed_db_requester/Raw_block_header/index.html#type-t">Distributed_db_requester.Raw_block_header.t</a>;</span></code></li><li id="type-chain_db.operations_db" class="def record field anchored"><a href="#type-chain_db.operations_db" class="anchor"></a><code><span>operations_db : <a href="../Distributed_db_requester/Raw_operations/index.html#type-t">Distributed_db_requester.Raw_operations.t</a>;</span></code></li><li id="type-chain_db.callback" class="def record field anchored"><a href="#type-chain_db.callback" class="anchor"></a><code><span>callback : <a href="#type-callback">callback</a>;</span></code></li><li id="type-chain_db.active_peers" class="def record field anchored"><a href="#type-chain_db.active_peers" class="anchor"></a><code><span>active_peers : <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/Set/index.html#type-t">Tezos_base.P2p_peer.Set.t</a> <span class="xref-unresolved">Stdlib</span>.ref</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Set of remote peers for which this chain is active.</p><span class="comment-delim">*)</span></div></li><li id="type-chain_db.active_connections" class="def record field anchored"><a href="#type-chain_db.active_connections" class="anchor"></a><code><span>active_connections : <span><a href="#type-connection">connection</a> <a href="../../../octez-libs/Tezos_base/P2p_peer_id/Table/index.html#type-t">Tezos_base.P2p_peer.Table.t</a></span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_block_header"><a href="#val-read_block_header" class="anchor"></a><code><span><span class="keyword">val</span> read_block_header : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Chain_id/index.html#type-t">Tezos_base.TzPervasives.Chain_id.t</a> * <a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a>)</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Lookup for block header in any active chains</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : 
  <span><span class="label">register</span>:<span>(<span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">unregister</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-p2p">p2p</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_store/Store/index.html#type-t">Tezos_store.Store.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Distributed_db_requester/Raw_protocol/index.html#type-t">Distributed_db_requester.Raw_protocol.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-chain_db">chain_db</a> <a href="../../../octez-libs/Tezos_crypto/Hashed/Chain_id/Table/index.html#type-t">Tezos_base.TzPervasives.Chain_id.Table.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-connection">connection</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>run ~register ~unregister p2p state protocol_db active_chains peer_id conn</code> runs an answering worker on a p2p connection <code>connection</code>. <code>peer_id</code> is the peer id of the remote peer. <code>register</code> is called once the worker is created, and <code>unregister</code> when the worker stops.</p><p><code>active_chains</code> is the table of active chains (i.e. test chain, main chain...)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></div></body></html>
