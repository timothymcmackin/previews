<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Block_validator_process (octez-shell-libs.Tezos_shell.Block_validator_process)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Block_validator_process</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.Block_validator_process</span></code></h1><p>Block_validator_process is used to validate new blocks. This validation can be</p><ul><li>internal: the same processus is used to run the node and to validate blocks</li><li>external: another processus is used to validate blocks This module also ensures the liveness of the operations (see <code>Block_validation:check_liveness</code>).</li></ul></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-validator_environment"><a href="#type-validator_environment" class="anchor"></a><code><span><span class="keyword">type</span> validator_environment</span><span> = </span><span>{</span></code><ol><li id="type-validator_environment.user_activated_upgrades" class="def record field anchored"><a href="#type-validator_environment.user_activated_upgrades" class="anchor"></a><code><span>user_activated_upgrades : <a href="../../../octez-libs/Tezos_base/User_activated/index.html#type-upgrades">Tezos_base.User_activated.upgrades</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>user activated upgrades</p><span class="comment-delim">*)</span></div></li><li id="type-validator_environment.user_activated_protocol_overrides" class="def record field anchored"><a href="#type-validator_environment.user_activated_protocol_overrides" class="anchor"></a><code><span>user_activated_protocol_overrides : <a href="../../../octez-libs/Tezos_base/User_activated/index.html#type-protocol_overrides">Tezos_base.User_activated.protocol_overrides</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>user activated protocol overrides</p><span class="comment-delim">*)</span></div></li><li id="type-validator_environment.operation_metadata_size_limit" class="def record field anchored"><a href="#type-validator_environment.operation_metadata_size_limit" class="anchor"></a><code><span>operation_metadata_size_limit : <a href="../../Tezos_shell_services/Shell_limits/index.html#type-operation_metadata_size_limit">Tezos_shell_services.Shell_limits.operation_metadata_size_limit</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>size limit for operation metadata that should be written on disk</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-validator_kind"><a href="#type-validator_kind" class="anchor"></a><code><span><span class="keyword">type</span> validator_kind</span><span> = </span></code><ol><li id="type-validator_kind.Internal" class="def variant constructor anchored"><a href="#type-validator_kind.Internal" class="anchor"></a><code><span>| </span><span><span class="constructor">Internal</span> : <a href="#type-validator_environment">validator_environment</a>
  * <a href="../../Tezos_store/Store/Chain/index.html#type-chain_store">Tezos_store.Store.Chain.chain_store</a> <span class="arrow">&#45;&gt;</span> <a href="#type-validator_kind">validator_kind</a></span></code></li><li id="type-validator_kind.External" class="def variant constructor anchored"><a href="#type-validator_kind.External" class="anchor"></a><code><span>| </span><span><span class="constructor">External</span> : </span><span>{</span></code><ol><li id="type-validator_kind.parameters" class="def record field anchored"><a href="#type-validator_kind.parameters" class="anchor"></a><code><span>parameters : <a href="../../Tezos_validation/External_validation/index.html#type-parameters">Tezos_validation.External_validation.parameters</a>;</span></code></li><li id="type-validator_kind.process_path" class="def record field anchored"><a href="#type-validator_kind.process_path" class="anchor"></a><code><span>process_path : string;</span></code></li></ol><code><span>}</span><span> <span class="arrow">&#45;&gt;</span> <a href="#type-validator_kind">validator_kind</a></span></code></li></ol></div><div class="spec-doc"><p>For performances reasons, it may be interesting to use another processus (from the OS) to validate blocks (External). However, in that case, only one processus has a write access to the context. Currently informations are exchanged via the file system.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-simple_kind"><a href="#type-simple_kind" class="anchor"></a><code><span><span class="keyword">type</span> simple_kind</span><span> = </span></code><ol><li id="type-simple_kind.External_process" class="def variant constructor anchored"><a href="#type-simple_kind.External_process" class="anchor"></a><code><span>| </span><span><span class="constructor">External_process</span></span></code></li><li id="type-simple_kind.Single_process" class="def variant constructor anchored"><a href="#type-simple_kind.Single_process" class="anchor"></a><code><span>| </span><span><span class="constructor">Single_process</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Internal representation of the block validator process</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span><a href="#type-validator_kind">validator_kind</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-t">t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-kind"><a href="#val-kind" class="anchor"></a><code><span><span class="keyword">val</span> kind : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-simple_kind">simple_kind</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close vp</code> closes the given <code>vp</code>. In the case of an <code>External</code> validator process, we first ask the validator to shutdown. If it is still running after 5 seconds, we notice that the block validation process is unresponsive and we force its termination (using a registered Lwt_exit.clean_up_callback).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reconfigure_event_logging"><a href="#val-reconfigure_event_logging" class="anchor"></a><code><span><span class="keyword">val</span> reconfigure_event_logging : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base_unix/Internal_event_unix/Configuration/index.html#type-t">Tezos_base_unix.Internal_event_unix.Configuration.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_block"><a href="#val-apply_block" class="anchor"></a><code><span><span class="keyword">val</span> apply_block : 
  <span><span class="optlabel">?simulate</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?should_validate</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_store/Store/index.html#type-chain_store">Tezos_store.Store.chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Tezos_validation/Block_validation/index.html#type-operation">Tezos_validation.Block_validation.operation</a> list</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Tezos_validation/Block_validation/index.html#type-result">Tezos_validation.Block_validation.result</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>apply_block bvp predecessor header ops</code> checks the liveness of the operations and then call <code>Block_validation.apply</code></p><p><code>should_validate</code> when set, triggers the block validation before applying it, see <code>Block_validation.apply</code>.</p><p>If <code>simulate</code> is true, the context resulting from the application will not be committed to disk. Set to false by default.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-preapply_block"><a href="#val-preapply_block" class="anchor"></a><code><span><span class="keyword">val</span> preapply_block : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_store/Store/index.html#type-chain_store">Tezos_store.Store.chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">protocol_data</span>:bytes <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timestamp</span>:<a href="../../../octez-libs/Tezos_base/Time/Protocol/index.html#type-t">Tezos_base.Time.Protocol.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Tezos_validation/Block_validation/index.html#type-operation">Tezos_validation.Block_validation.operation</a> list</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.Block_header.shell_header</a>
   * <span><span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../Tezos_shell_services/Preapply_result/index.html#type-t">Tezos_shell_services.Preapply_result.t</a></span> list</span>)</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>preapply_block bvp chain_store ~predecessor ~protocol_data ~timestamp ops</code> is a wrapper for <code>Block_validation.preapply</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_block"><a href="#val-validate_block" class="anchor"></a><code><span><span class="keyword">val</span> validate_block : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_store/Store/index.html#type-chain_store">Tezos_store.Store.chain_store</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Tezos_validation/Block_validation/index.html#type-operation">Tezos_validation.Block_validation.operation</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>validate_block bvp chain_store ~predecessor header hash ops</code> is a wrapper for <code>Block_validation.validate</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-context_garbage_collection"><a href="#val-context_garbage_collection" class="anchor"></a><code><span><span class="keyword">val</span> context_garbage_collection : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_context_ops/Context_ops/index.html#type-index">Tezos_context_ops.Context_ops.index</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Context_hash/index.html#type-t">Tezos_base.TzPervasives.Context_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">gc_lockfile_path</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>context_garbage_collection bvp context_index context_hash</code> removes contexts that are below <code>context_hash</code> in the context tree.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-context_split"><a href="#val-context_split" class="anchor"></a><code><span><span class="keyword">val</span> context_split : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_context_ops/Context_ops/index.html#type-index">Tezos_context_ops.Context_ops.index</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>context_split bvp context_index</code> splits the context storage layout into a new chunk.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-commit_genesis"><a href="#val-commit_genesis" class="anchor"></a><code><span><span class="keyword">val</span> commit_genesis : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">chain_id</span>:<a href="../../../octez-libs/Tezos_crypto/Hashed/Chain_id/index.html#type-t">Tezos_base.TzPervasives.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../octez-libs/Tezos_crypto/Hashed/Context_hash/index.html#type-t">Tezos_base.TzPervasives.Context_hash.t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init_test_chain"><a href="#val-init_test_chain" class="anchor"></a><code><span><span class="keyword">val</span> init_test_chain : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Chain_id/index.html#type-t">Tezos_base.TzPervasives.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init_test_chain</code> must only be called on a forking block.</p></div></div></div></body></html>
