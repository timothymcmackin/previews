<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Plugin (octez-shell-libs.Tezos_shell.Prevalidation.Make.Proto.Plugin)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../index.html">octez-shell-libs</a> &#x00BB; <a href="../../../../index.html">Tezos_shell</a> &#x00BB; <a href="../../../index.html">Prevalidation</a> &#x00BB; <a href="../../index.html">Make</a> &#x00BB; <a href="../index.html">Proto</a> &#x00BB; Plugin</nav><header class="odoc-preamble"><h1>Module <code><span>Proto.Plugin</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-config"><a href="#type-config" class="anchor"></a><code><span><span class="keyword">type</span> config</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-config_encoding"><a href="#val-config_encoding" class="anchor"></a><code><span><span class="keyword">val</span> config_encoding : <span><a href="#type-config">config</a> <a href="../../../../../../octez-libs/Data_encoding/index.html#type-t">Tezos_base.TzPervasives.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_config"><a href="#val-default_config" class="anchor"></a><code><span><span class="keyword">val</span> default_config : <a href="#type-config">config</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-info"><a href="#type-info" class="anchor"></a><code><span><span class="keyword">type</span> info</span></code></div><div class="spec-doc"><p>Static internal information needed by <a href="#val-pre_filter"><code>pre_filter</code></a>.</p><p>It depends on the <code>head</code> block upon which a mempool is built.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><a href="../../../../../../octez-proto-libs/Tezos_protocol_environment/Context/index.html#type-t">Tezos_protocol_environment.Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-info">info</a> <a href="../../../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Create an <a href="#type-info"><code>info</code></a> based on the <code>head</code> block.</p><p>Should be called only once when a new prevalidator is started for a new protocol. Subsequent <a href="#type-info"><code>info</code></a>s should be created using <a href="#val-flush"><code>flush</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : 
  <span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-info">info</a> <a href="../../../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Create a new <a href="#type-info"><code>info</code></a> based on the <code>head</code> block.</p><p>Parts of the old <a href="#type-info"><code>info</code></a> (which may have been built on a different block) are recycled, so that this function is more efficient than <a href="#val-init"><code>init</code></a> and does not need a <a href="../../../../../../octez-proto-libs/Tezos_protocol_environment/Context/index.html#type-t"><code>Tezos_protocol_environment.Context.t</code></a> argument.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-syntactic_check"><a href="#val-syntactic_check" class="anchor"></a><code><span><span class="keyword">val</span> syntactic_check : <span><a href="../index.html#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[ `Well_formed <span>| `Ill_formed</span> ]</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Perform some syntactic checks on the operation.</p><p>To be used mostly as an exceptional mechanism to prevent ill-formed operations to block block application.</p><p>Note that the functions exposed in the output of <code>proto_with_validation_plugin</code> already call <code>syntactic_check</code> when appropriate.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pre_filter"><a href="#val-pre_filter" class="anchor"></a><code><span><span class="keyword">val</span> pre_filter : 
  <span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-config">config</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[ <span>`Passed_prefilter of <span>[ `High <span>| `Medium</span> <span><span>| `Low</span> of <span><span class="xref-unresolved">Q</span>.t list</span></span> ]</span></span>
  <span><span>| `Branch_delayed</span> of <a href="../../../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span>
  <span><span>| `Branch_refused</span> of <a href="../../../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span>
  <span><span>| `Refused</span> of <a href="../../../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span>
  <span><span>| `Outdated</span> of <a href="../../../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span> ]</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Perform some light preliminary checks on the operation.</p><p>If successful, return <code>`Passed_prefilter</code> with the priority of the operation, based on the operation kind and potentially its fee, gas, and size. If not, return a classification containing the encountered error.</p><p>Should be called on arrival of an operation and after a flush of the prevalidator.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-conflict_handler"><a href="#val-conflict_handler" class="anchor"></a><code><span><span class="keyword">val</span> conflict_handler : <span><a href="#type-config">config</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Mempool/index.html#type-conflict_handler">Mempool.conflict_handler</a></span></code></div><div class="spec-doc"><p>Return a conflict handler for <a href="../Mempool/index.html#val-add_operation"><code>Mempool.add_operation</code></a>.</p><p>See the documentation of type <a href="../Mempool/index.html#type-conflict_handler"><code>Mempool.conflict_handler</code></a> in e.g. <code>lib_protocol_environment/sigs/v8/updater.mli</code>.</p><p>Precondition: both operations must be individually valid (required by the protocol's operation comparison on which the implementation of this function relies).</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Conflict_map"><a href="#module-Conflict_map" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Conflict_map/index.html">Conflict_map</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The purpose of this module is to provide the <code>fee_needed_to_replace_by_fee</code> function. For this function to be correct, the caller must maintain the state of type <code>t</code> by calling <code>update</code> on each successfully validated operation and its induced replacements.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fee_needed_to_overtake"><a href="#val-fee_needed_to_overtake" class="anchor"></a><code><span><span class="keyword">val</span> fee_needed_to_overtake : 
  <span><span class="label">op_to_overtake</span>:<a href="../index.html#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">candidate_op</span>:<a href="../index.html#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int64 option</span></span></code></div><div class="spec-doc"><p>Compute the minimal fee (expressed in mutez) that <code>candidate_op</code> would need to have in order to be strictly greater than <code>op_to_overtake</code> according to <a href="../index.html#val-compare_operations"><code>compare_operations</code></a>.</p><p>Return <code>None</code> when at least one operation is not a manager operation.</p><p>Also return <code>None</code> if both operations are manager operations but there was an error while computing the needed fee. However, note that this cannot happen when both manager operations have been successfully validated by the protocol.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-ctxt"><a href="#type-ctxt" class="anchor"></a><code><span><span class="keyword">type</span> ctxt</span></code></div><div class="spec-doc"><p>Protocol context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_context"><a href="#val-get_context" class="anchor"></a><code><span><span class="keyword">val</span> get_context : 
  <span><a href="../../../../../../octez-proto-libs/Tezos_protocol_environment/Context/index.html#type-t">Tezos_protocol_environment.Context.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">head</span>:<a href="../../../../../../octez-libs/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.TzPervasives.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-ctxt">ctxt</a> <a href="../../../../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Return the protocol context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sources_from_operation"><a href="#val-sources_from_operation" class="anchor"></a><code><span><span class="keyword">val</span> sources_from_operation : 
  <span><a href="#type-ctxt">ctxt</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-operation">operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../../../../octez-libs/Tezos_crypto/Signature/index.html#type-public_key_hash">Tezos_crypto.Signature.public_key_hash</a> list</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Return the sources from the operation</p></div></div></div></body></html>
