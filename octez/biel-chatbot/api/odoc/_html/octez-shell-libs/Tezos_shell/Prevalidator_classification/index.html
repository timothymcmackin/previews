<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Prevalidator_classification (octez-shell-libs.Tezos_shell.Prevalidator_classification)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-shell-libs</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Prevalidator_classification</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.Prevalidator_classification</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-error_classification"><a href="#type-error_classification" class="anchor"></a><code><span><span class="keyword">type</span> error_classification</span><span> = </span><span>[ </span></code><ol><li id="type-error_classification.Branch_delayed" class="def variant constructor anchored"><a href="#type-error_classification.Branch_delayed" class="anchor"></a><code><span>| </span><span>`Branch_delayed <span class="keyword">of</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span></code></li><li id="type-error_classification.Branch_refused" class="def variant constructor anchored"><a href="#type-error_classification.Branch_refused" class="anchor"></a><code><span>| </span><span>`Branch_refused <span class="keyword">of</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span></code></li><li id="type-error_classification.Refused" class="def variant constructor anchored"><a href="#type-error_classification.Refused" class="anchor"></a><code><span>| </span><span>`Refused <span class="keyword">of</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span></code></li><li id="type-error_classification.Outdated" class="def variant constructor anchored"><a href="#type-error_classification.Outdated" class="anchor"></a><code><span>| </span><span>`Outdated <span class="keyword">of</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>Classifications which correspond to errors</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-classification"><a href="#type-classification" class="anchor"></a><code><span><span class="keyword">type</span> classification</span><span> = </span><span>[ </span></code><ol><li id="type-classification.Validated" class="def variant constructor anchored"><a href="#type-classification.Validated" class="anchor"></a><code><span>| </span><span>`Validated</span></code></li><li id="type-classification.error_classification" class="def variant type anchored"><a href="#type-classification.error_classification" class="anchor"></a><code><span>| </span><span><a href="#type-error_classification">error_classification</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>Classification of an operation in the mempool</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-bounded_map"><a href="#type-bounded_map" class="anchor"></a><code><span><span class="keyword">type</span> <span>'protocol_data bounded_map</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-map"><a href="#val-map" class="anchor"></a><code><span><span class="keyword">val</span> map : 
  <span><span><span class="type-var">'protocol_data</span> <a href="#type-bounded_map">bounded_map</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span> * <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span>
    <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Map/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Map.t</a></span></span></code></div><div class="spec-doc"><p><code>map bounded_map</code> gets the underling map of the <code>bounded_map</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cardinal"><a href="#val-cardinal" class="anchor"></a><code><span><span class="keyword">val</span> cardinal : <span><span><span class="type-var">'protocol_data</span> <a href="#type-bounded_map">bounded_map</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>cardinal bounded_map</code> gets the cardinal of the underling map of the <code>bounded_map</code></p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-parameters"><a href="#type-parameters" class="anchor"></a><code><span><span class="keyword">type</span> parameters</span><span> = </span><span>{</span></code><ol><li id="type-parameters.map_size_limit" class="def record field anchored"><a href="#type-parameters.map_size_limit" class="anchor"></a><code><span>map_size_limit : int;</span></code></li><li id="type-parameters.on_discarded_operation" class="def record field anchored"><a href="#type-parameters.on_discarded_operation" class="anchor"></a><code><span>on_discarded_operation : <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span> unit;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Sized_map"><a href="#module-Sized_map" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Sized_map/index.html">Sized_map</a></span><span> : 
  <a href="../../../octez-libs/Tezos_base/Sized/module-type-SizedMap/index.html">Tezos_base.Sized.SizedMap</a>
    <span class="keyword">with</span> <span><span class="keyword">type</span> <span>'a <a href="../../../octez-libs/Tezos_base/Sized/module-type-SizedMap/index.html#type-map">map</a></span> := <span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Map/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Map.t</a></span></span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_base/Sized/module-type-SizedMap/index.html#type-key">key</a> = <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a></span></span></code></div><div class="spec-doc"><p>This module implements a sized-map data-structure.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'protocol_data t</span></span><span> = <span class="keyword">private</span> </span><span>{</span></code><ol><li id="type-t.parameters" class="def record field anchored"><a href="#type-t.parameters" class="anchor"></a><code><span>parameters : <a href="#type-parameters">parameters</a>;</span></code></li><li id="type-t.refused" class="def record field anchored"><a href="#type-t.refused" class="anchor"></a><code><span>refused : <span><span class="type-var">'protocol_data</span> <a href="#type-bounded_map">bounded_map</a></span>;</span></code></li><li id="type-t.outdated" class="def record field anchored"><a href="#type-t.outdated" class="anchor"></a><code><span>outdated : <span><span class="type-var">'protocol_data</span> <a href="#type-bounded_map">bounded_map</a></span>;</span></code></li><li id="type-t.branch_refused" class="def record field anchored"><a href="#type-t.branch_refused" class="anchor"></a><code><span>branch_refused : <span><span class="type-var">'protocol_data</span> <a href="#type-bounded_map">bounded_map</a></span>;</span></code></li><li id="type-t.branch_delayed" class="def record field anchored"><a href="#type-t.branch_delayed" class="anchor"></a><code><span>branch_delayed : <span><span class="type-var">'protocol_data</span> <a href="#type-bounded_map">bounded_map</a></span>;</span></code></li><li id="type-t.validated" class="def record field anchored"><a href="#type-t.validated" class="anchor"></a><code><span><span class="keyword">mutable</span> validated : <span><span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span> <a href="Sized_map/index.html#type-t">Sized_map.t</a></span>;</span></code></li><li id="type-t.unparsable" class="def record field anchored"><a href="#type-t.unparsable" class="anchor"></a><code><span><span class="keyword">mutable</span> unparsable : <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Set.t</a>;</span></code></li><li id="type-t.in_mempool" class="def record field anchored"><a href="#type-t.in_mempool" class="anchor"></a><code><span><span class="keyword">mutable</span> in_mempool : <span><span>(<span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span> * <a href="#type-classification">classification</a>)</span>
                       <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Map/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Map.t</a></span>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Invariants ensured by this module, provided that the caller does not <a href="#val-add"><code>add</code></a> an operation which is already present in <code>t</code>:</p><ul><li>The field <code>in_mempool</code> is the set of all operation hashes present in fields: <code>refused; outdated; branch_refused; branch_delayed; validated</code>.</li></ul><ul><li>An operation cannot be at the same time in two of the fields: <code>refused; outdated; branch_refused; branch_delayed; validated</code>.</li></ul><p>Note: unparsable operations are handled in a different way because they cannot be handled as a <code>operation</code> since this datatype requires an operation to be parsable. Hence, unparsable operations are handled differently. In particular, unparsable operations are removed on flush.</p><p>Note: We could always enforce these invariants by checking in <a href="#val-add"><code>add</code></a> whether the operation is already present. However, this would make the behavior of <a href="#val-add"><code>add</code></a> less predictable, so we do not think this to be an improvement from the point of view of the caller.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><a href="#type-parameters">parameters</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create parameters</code> returns an empty <a href="#type-t"><code>t</code></a> whose bounded maps hold at most <code>parameters.map_size_limit</code> values. The <code>on_discarded_operation</code> is called when a new operation is added and an old one is discarded because the limit was reached.</p><p><code>Invalid_argument</code> is raised if <code>ring_size</code> is <code>0</code> or less.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_empty"><a href="#val-is_empty" class="anchor"></a><code><span><span class="keyword">val</span> is_empty : <span><span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_empty t</code> returns <code>true</code> iff <code>t</code> doesn't contain any operation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_in_mempool"><a href="#val-is_in_mempool" class="anchor"></a><code><span><span class="keyword">val</span> is_in_mempool : 
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span> * <a href="#type-classification">classification</a>)</span> option</span></span></code></div><div class="spec-doc"><p><code>is_in_mempool oph classes</code> indicates whether <code>oph</code> is present in field <code>in_mempool</code> of <code>classes</code>. It returns the corresponding operation and its classification if present, and None otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_known_unparsable"><a href="#val-is_known_unparsable" class="anchor"></a><code><span><span class="keyword">val</span> is_known_unparsable : 
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div><div class="spec-doc"><p><code>is_known_unparsable oph</code> returns <code>true</code> if the <code>oph</code> is associated to an operation which is known to be unparsable. <code>false</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span><span class="keyword">val</span> remove : 
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span> * <a href="#type-classification">classification</a>)</span> option</span></span></code></div><div class="spec-doc"><p><code>remove oph classes</code> removes operation of hash <code>oph</code> from all fields of <code>classes</code>. The function is <code>O(log n)</code> with <code>n</code> the number of operations in the corresponding class.</p><p>If <code>oph</code> was found, its classification as well as the operation it was bound to are returned. If <code>oph</code> was not found, <code>None</code> is returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add"><a href="#val-add" class="anchor"></a><code><span><span class="keyword">val</span> add : 
  <span><a href="#type-classification">classification</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>add ~notify classification op classes</code> adds the operation <code>op</code> classified as <code>classification</code> to the classifier <code>classes</code>. The <code>classes.parameters.on_discarded_operation</code> callback is called for any operation discarded in this process. Currently, an operation is discarded in the following cases:</p><ul><li>the corresponding error class field is full. In that case, the new operation is added to the class, and the removed one is discarded.</li></ul><ul><li>an operation is classified as <code>Refused</code>.</li></ul><p>Note that a <code>Refused</code> operation may thus be passed twice to <code>on_discarded_operation</code>: as soon as it is added, and if it is removed because the <code>classes.refused</code> bounded map is full.</p><p>As a summary:</p><ul><li><code>Validated</code> operations are never discarded</li></ul><ul><li><code>Branch_refused</code> and <code>Branch_delayed</code> are discarded 0 or 1 time (if the corresponding bounded_map is full)</li></ul><ul><li><code>Refused</code> is discarded 1 or 2 times (if the corresponding bounded_map is full)</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_unparsable"><a href="#val-add_unparsable" class="anchor"></a><code><span><span class="keyword">val</span> add_unparsable : 
  <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>add_unparsable oph classes</code> adds <code>oph</code> as an unparsable operation. <code>unparsable</code> operations are removed automatically by the <code>recycle_operations</code> function. <code>on_discard_operation</code> is also called on those operations.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_tools"><a href="#type-block_tools" class="anchor"></a><code><span><span class="keyword">type</span> <span>'block block_tools</span></span><span> = </span><span>{</span></code><ol><li id="type-block_tools.bhash" class="def record field anchored"><a href="#type-block_tools.bhash" class="anchor"></a><code><span>bhash : <span><span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The hash of a block</p><span class="comment-delim">*)</span></div></li><li id="type-block_tools.operations" class="def record field anchored"><a href="#type-block_tools.operations" class="anchor"></a><code><span>operations : <span><span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span> list</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The list of operations of a block ordered by their validation pass</p><span class="comment-delim">*)</span></div></li><li id="type-block_tools.all_operation_hashes" class="def record field anchored"><a href="#type-block_tools.all_operation_hashes" class="anchor"></a><code><span>all_operation_hashes : <span><span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> list</span> list</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The list of hashes of operations of a block ordered by their validation pass. Could be implemented using <a href="#type-block_tools.operations"><code>operations</code></a> but this lets an alternative implementation to be provided.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Functions to query data on a polymorphic block-like type <code>'block</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-chain_tools"><a href="#type-chain_tools" class="anchor"></a><code><span><span class="keyword">type</span> <span>'block chain_tools</span></span><span> = </span><span>{</span></code><ol><li id="type-chain_tools.clear_or_cancel" class="def record field anchored"><a href="#type-chain_tools.clear_or_cancel" class="anchor"></a><code><span>clear_or_cancel : <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span> unit;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Removes the operation from the distributed database.</p><span class="comment-delim">*)</span></div></li><li id="type-chain_tools.inject_operation" class="def record field anchored"><a href="#type-chain_tools.inject_operation" class="anchor"></a><code><span>inject_operation : <span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Puts the operation in the distributed database. Returns <code>false</code> if the <code>hash</code> is already in the distributed database</p><span class="comment-delim">*)</span></div></li><li id="type-chain_tools.new_blocks" class="def record field anchored"><a href="#type-chain_tools.new_blocks" class="anchor"></a><code><span>new_blocks : <span><span class="label">from_block</span>:<span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">to_block</span>:<span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'block</span> * <span><span class="type-var">'block</span> list</span>)</span> <span class="xref-unresolved">Lwt</span>.t</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>new_blocks ~from_block ~to_block</code> returns a pair <code>(ancestor,
      path)</code>, where <code>ancestor</code> is the common ancestor of <code>from_block</code> and <code>to_block</code> and where <code>path</code> is the chain from <code>ancestor</code> (excluded) to <code>to_block</code> (included).</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>assert</code> <p>failure when the two provided blocks do not belong to the same <code>chain</code>.</p></li></ul><span class="comment-delim">*)</span></div></li><li id="type-chain_tools.read_predecessor_opt" class="def record field anchored"><a href="#type-chain_tools.read_predecessor_opt" class="anchor"></a><code><span>read_predecessor_opt : <span><span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'block</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span>;</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>read_predecessor_opt block</code> returns the direct predecessor of <code>block</code> or <code>None</code> if it cannot be found.</p><span class="comment-delim">*)</span></div></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>A wrapper over chain-related modules, to make client code easier to emulate, and hence to test</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-recycle_operations"><a href="#val-recycle_operations" class="anchor"></a><code><span><span class="keyword">val</span> recycle_operations : 
  <span><span class="label">from_branch</span>:<span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">to_branch</span>:<span class="type-var">'block</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">live_blocks</span>:<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/Set/index.html#type-t">Tezos_base.TzPervasives.Block_hash.Set.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">classes</span>:<span><span class="type-var">'protocol_data</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">parse</span>:
    <span>(<span><a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../../../octez-libs/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">pending</span>:
    <span><span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span>
      <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Map/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Map.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">block_store</span>:<span><span class="type-var">'block</span> <a href="#type-block_tools">block_tools</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">chain</span>:<span><span class="type-var">'block</span> <a href="#type-chain_tools">chain_tools</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">handle_branch_refused</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span class="type-var">'protocol_data</span> <a href="../Shell_operation/index.html#type-operation">Shell_operation.operation</a></span>
    <a href="../../../octez-libs/Tezos_crypto/Hashed/Operation_hash/Map/index.html#type-t">Tezos_base.TzPervasives.Operation_hash.Map.t</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>recycle_operations</code> returns the new pending operations when a reorganisation or a head update occurs. Returned operations come from:</p><p>1. operations in <code>from_branch</code> that are NOT in <code>to_branch</code>, 2. operations in the relevant classes of <code>classification</code> 3. operations the <code>pending</code> map</p><p>This function guarantees that the branch of all returned operations is in <code>live_blocks</code> (<code>live_blocks</code> acts as a filter).</p><p>Operation which where included in <code>from_branch</code> and which are NOT in <code>to_branch</code> need to be parsed again using the <code>parse</code> argument. If the parsing fails those operations are just dropped. This may happen if those operations comes from another protocol.</p><p>See also <code>Internal_for_tests.handle_live_operations</code>.</p></div></div></div></body></html>
