<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Layer_1 (octez-crawler.Octez_crawler.Layer_1)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-crawler</a> &#x00BB; <a href="../index.html">Octez_crawler</a> &#x00BB; Layer_1</nav><header class="odoc-preamble"><h1>Module <code><span>Octez_crawler.Layer_1</span></code></h1><p>This module allow to follow the layer 1 chain by subscribing to the head monitoring RPC offered by the Tezos node, reconnecting, etc.</p></header><nav class="odoc-toc"><ul><li><a href="#monitoring-the-layer-1-chain">Monitoring the Layer 1 chain</a></li><li><a href="#helper-functions-for-the-layer-1-chain">Helper functions for the Layer 1 chain</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Cannot_find_predecessor"><a href="#extension-decl-Cannot_find_predecessor" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> += </span></code><ol><li id="extension-Cannot_find_predecessor" class="def variant extension anchored"><a href="#extension-Cannot_find_predecessor" class="anchor"></a><code><span>| </span><span><span class="extension">Cannot_find_predecessor</span> <span class="keyword">of</span> <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a></span></code></li><li id="extension-Http_connection_error" class="def variant extension anchored"><a href="#extension-Http_connection_error" class="anchor"></a><code><span>| </span><span><span class="extension">Http_connection_error</span> <span class="keyword">of</span> <span class="xref-unresolved">Cohttp</span>.Code.status_code * string</span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type of layer 1 followers.</p></div></div><h3 id="monitoring-the-layer-1-chain"><a href="#monitoring-the-layer-1-chain" class="anchor"></a>Monitoring the Layer 1 chain</h3><div class="odoc-spec"><div class="spec value anchored" id="val-start"><a href="#val-start" class="anchor"></a><code><span><span class="keyword">val</span> start : 
  <span><span class="label">name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">chain</span>:<a href="../../../octez-shell-libs/Tezos_shell_services/Chain_services/index.html#type-chain">Tezos_shell_services.Chain_services.chain</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">reconnection_delay</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?protocols</span>:<span><a href="../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_rpc/Context/class-type-generic/index.html">Tezos_rpc.Context.generic</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>start ~name ~reconnection_delay ?protocols cctxt</code> connects to a Tezos node and starts monitoring new heads. One can iterate on the heads by calling <a href="#val-iter_heads"><code>iter_heads</code></a> on its result. <code>reconnection_delay</code> gives an initial delay for the reconnection which is used in an exponential backoff. The <code>name</code> is used to differentiate events. If <code>protocols</code> is provided, only heads of these protocols will be monitored.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">chain</span>:<a href="../../../octez-shell-libs/Tezos_shell_services/Chain_services/index.html#type-chain">Tezos_shell_services.Chain_services.chain</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">reconnection_delay</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?protocols</span>:<span><a href="../../../octez-libs/Tezos_crypto/Hashed/Protocol_hash/index.html#type-t">Tezos_base.TzPervasives.Protocol_hash.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-libs/Tezos_rpc/Context/class-type-generic/index.html">Tezos_rpc.Context.generic</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ~name ~reconnection_delay ?protocols cctxt</code> creates a Layer 1 context without connecting to a Tezos node. Use <code>connect</code> to connect to start monitoring heads. If <code>protocols</code> is provided, only heads of these protocols will be monitored.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>shutdown t</code> properly shuts the layer 1 down. This function is to be used on exit.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-iter_heads"><a href="#val-iter_heads" class="anchor"></a><code><span><span class="keyword">val</span> iter_heads : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * <a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
    <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>iter_heads ?name t f</code> calls <code>f</code> on all new heads appearing in the layer 1 chain. In case of a disconnection with the layer 1 node, it reconnects automatically. If <code>f</code> returns an error (other than a disconnection), <code>iter_heads</code> terminates and returns the error. A <code>name</code> can be provided to differentiate iterations on the same connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_first"><a href="#val-wait_first" class="anchor"></a><code><span><span class="keyword">val</span> wait_first : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * <a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>wait_first t</code> waits for the first head to appear in the stream and returns it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_latest_head"><a href="#val-get_latest_head" class="anchor"></a><code><span><span class="keyword">val</span> get_latest_head : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * <a href="../../../octez-libs/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a>)</span> option</span></span></code></div><div class="spec-doc"><p><code>get_latest_head t</code> returns the latest L1 head if at least one was seen by <code>t</code>. The head is the one sent by the heads monitoring RPC of the L1 node, independently of how they were processed by the current process.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_status"><a href="#val-get_status" class="anchor"></a><code><span><span class="keyword">val</span> get_status : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>[ `Connected <span>| `Disconnected</span> <span>| `Reconnecting</span> ]</span></span></code></div><div class="spec-doc"><p><code>get_status t</code> returns the connection status to the L1 node.</p></div></div><h3 id="helper-functions-for-the-layer-1-chain"><a href="#helper-functions-for-the-layer-1-chain" class="anchor"></a>Helper functions for the Layer 1 chain</h3><div class="odoc-spec"><div class="spec value anchored" id="val-get_predecessor_opt"><a href="#val-get_predecessor_opt" class="anchor"></a><code><span><span class="keyword">val</span> get_predecessor_opt : 
  <span><span class="optlabel">?max_read</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span> option</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_predecessor_opt ?max_read state head</code> returns the predecessor of block <code>head</code>, when <code>head</code> is not the genesis block. <code>max_read</code> (by default <code>8</code>) is used to cache a number of predecessors (including <code>head</code>) to avoid some RPC calls when one need to access multiple predecessors.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_predecessor"><a href="#val-get_predecessor" class="anchor"></a><code><span><span class="keyword">val</span> get_predecessor : 
  <span><span class="optlabel">?max_read</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_predecessor ?max_read state head</code> returns the predecessor block of <code>head</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-nth_predecessor"><a href="#val-nth_predecessor" class="anchor"></a><code><span><span class="keyword">val</span> nth_predecessor : 
  <span><span class="label">get_predecessor</span>:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'a</span> * <span><span class="type-var">'a</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span>)</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>nth_predecessor ~get_predecessor n head</code> returns <code>block, history</code> where <code>block</code> is the nth predecessor of <code>head</code> and <code>history</code> is the list of blocks between <code>block</code> (excluded) and <code>head</code> (included) on the chain. It uses the function <code>get_predecessor</code> to retrieve the predecessor of one block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_tezos_reorg_for_new_head"><a href="#val-get_tezos_reorg_for_new_head" class="anchor"></a><code><span><span class="keyword">val</span> get_tezos_reorg_for_new_head : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?get_old_predecessor</span>:
    <span>(<span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span> <span class="arrow">&#45;&gt;</span></span>
      <span><span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span>
        <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
        <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>[ <span>`Head of <a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32</span> <span><span>| `Level</span> of int32</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> * int32)</span> <a href="../Reorg/index.html#type-t">Reorg.t</a></span>
    <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_tezos_reorg_for_new_head l1_ctxt ?get_old_predecessor old_head
    new_head</code> returns the reorganization of L1 blocks between <code>old_head</code> and <code>new_head</code>. If <code>old_head</code> is <code>`Level l</code>, then it returns the reorganization between <code>new_head</code> and level <code>l</code> on the same chain. <code>get_old_predecessor</code> can be provided to use a different function (than by default <a href="#val-get_predecessor"><code>get_predecessor</code></a>) to retrieve the predecessors of the old head. This is necessary when the old head is not in the L1 chain anymore and forgotten by the L1 node.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-client_context_with_timeout"><a href="#val-client_context_with_timeout" class="anchor"></a><code><span><span class="keyword">val</span> client_context_with_timeout : 
  <span><a href="../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-full/index.html">Tezos_client_base.Client_context.full</a> <span class="arrow">&#45;&gt;</span></span>
  <span>float <span class="arrow">&#45;&gt;</span></span>
  <a href="../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-full/index.html">Tezos_client_base.Client_context.full</a></span></code></div><div class="spec-doc"><p><code>client_context_with_timeout ctxt timeout</code> creates a client context where RPCs will be made with timeout <code>timeout</code> seconds. Calls that timeout will resolve with an error <code>RPC_timeout</code> which will trigger a reconnection in <a href="#val-iter_heads"><code>iter_heads</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_connection_error"><a href="#val-is_connection_error" class="anchor"></a><code><span><span class="keyword">val</span> is_connection_error : 
  <span><span><a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-error">Tezos_base.TzPervasives.error</a> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-trace">Tezos_base.TzPervasives.trace</a></span> <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div><div class="spec-doc"><p>Returns true iff a connection error is present in the given error trace.</p></div></div></div></body></html>
