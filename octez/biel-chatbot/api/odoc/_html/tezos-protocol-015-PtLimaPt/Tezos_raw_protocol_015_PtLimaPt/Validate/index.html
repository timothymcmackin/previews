<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Validate (tezos-protocol-015-PtLimaPt.Tezos_raw_protocol_015_PtLimaPt.Validate)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-015-PtLimaPt</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_015_PtLimaPt</a> &#x00BB; Validate</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_015_PtLimaPt.Validate</span></code></h1><p>The purpose of this module is to provide the <a href="#val-validate_operation"><code>validate_operation</code></a> function, that decides quickly whether an operation may safely be included in a block. See the function's description for further information.</p><p>This module also provide functions to check the validity of a block and the consistency of its block_header.</p><p>Most elements in this module are either used or wrapped in the <a href="../Main/index.html"><code>Main</code></a> module.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-info"><a href="#type-info" class="anchor"></a><code><span><span class="keyword">type</span> info</span></code></div><div class="spec-doc"><p>Static information required to validate blocks and operations.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-operation_conflict_state"><a href="#type-operation_conflict_state" class="anchor"></a><code><span><span class="keyword">type</span> operation_conflict_state</span></code></div><div class="spec-doc"><p>State used to register operations effects used to establish potential conflicts. This state is serializable which allows it to be exchanged with another source. See <code>Mempool_validation</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-operation_conflict_state_encoding"><a href="#val-operation_conflict_state_encoding" class="anchor"></a><code><span><span class="keyword">val</span> operation_conflict_state_encoding : 
  <span><a href="#type-operation_conflict_state">operation_conflict_state</a>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Data_encoding/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>Encoding for the <code>operation_conflict_state</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block_state"><a href="#type-block_state" class="anchor"></a><code><span><span class="keyword">type</span> block_state</span></code></div><div class="spec-doc"><p>State used to register global block validity dependent effects. This state is used and updated by the <code>validate_operation</code> function and will also be used during the <code>finalize_block</code>. For instance, it registers inter-operations checks (e.g. total gas used in the block so far).</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-validation_state"><a href="#type-validation_state" class="anchor"></a><code><span><span class="keyword">type</span> validation_state</span><span> = </span><span>{</span></code><ol><li id="type-validation_state.info" class="def record field anchored"><a href="#type-validation_state.info" class="anchor"></a><code><span>info : <a href="#type-info">info</a>;</span></code></li><li id="type-validation_state.operation_state" class="def record field anchored"><a href="#type-validation_state.operation_state" class="anchor"></a><code><span>operation_state : <a href="#type-operation_conflict_state">operation_conflict_state</a>;</span></code></li><li id="type-validation_state.block_state" class="def record field anchored"><a href="#type-validation_state.block_state" class="anchor"></a><code><span>block_state : <a href="#type-block_state">block_state</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Validation state</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_initial_ctxt"><a href="#val-get_initial_ctxt" class="anchor"></a><code><span><span class="keyword">val</span> get_initial_ctxt : <span><a href="#type-validation_state">validation_state</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Alpha_context/index.html#type-context">Alpha_context.context</a></span></code></div><div class="spec-doc"><p>Return the context stored in the state. Note that this is the context at the beginning of the block / mempool: indeed, it is not modified by <code>validate_operation</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_application"><a href="#val-begin_application" class="anchor"></a><code><span><span class="keyword">val</span> begin_application : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Chain_id/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Tezos_protocol_environment_015_PtLimaPt/Time/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Block_header/index.html#type-t">Alpha_context.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Fitness/index.html#type-t">Alpha_context.Fitness.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialize the <a href="#type-validation_state.info"><code>info</code></a> and <code>state</code> for the validation of an existing block (in preparation for its future application).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_partial_validation"><a href="#val-begin_partial_validation" class="anchor"></a><code><span><span class="keyword">val</span> begin_partial_validation : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Chain_id/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Tezos_protocol_environment_015_PtLimaPt/Time/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Block_header/index.html#type-t">Alpha_context.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Fitness/index.html#type-t">Alpha_context.Fitness.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialize the <a href="#type-validation_state.info"><code>info</code></a> and <code>state</code> for the partial validation of an existing block.</p><p>Note that the given context may be based on an ancestor block. Indeed, we may not have access to the predecessor context when trying to quickly assess a series of blocks in a cousin branch (multipass validation).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_full_construction"><a href="#val-begin_full_construction" class="anchor"></a><code><span><span class="keyword">val</span> begin_full_construction : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Chain_id/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_round</span>:<a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Tezos_protocol_environment_015_PtLimaPt/Time/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_hash</span>:<a href="../../Tezos_protocol_environment_015_PtLimaPt/Block_hash/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Block_header/index.html#type-contents">Alpha_context.Block_header.contents</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialize the <a href="#type-validation_state.info"><code>info</code></a> and <code>state</code> for the full construction of a fresh block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_partial_construction"><a href="#val-begin_partial_construction" class="anchor"></a><code><span><span class="keyword">val</span> begin_partial_construction : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Chain_id/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_round</span>:<a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">grandparent_round</span>:<a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-validation_state">validation_state</a></span></code></div><div class="spec-doc"><p>Initialize the <a href="#type-validation_state.info"><code>info</code></a> and <code>state</code> for the partial construction use mainly to implement the mempool.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_no_predecessor_info"><a href="#val-begin_no_predecessor_info" class="anchor"></a><code><span><span class="keyword">val</span> begin_no_predecessor_info : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Chain_id/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-validation_state">validation_state</a></span></code></div><div class="spec-doc"><p>Initialize the <a href="#type-validation_state.info"><code>info</code></a> and <code>state</code> without providing any predecessor information. This will cause any preendorsement or endorsement operation to fail, since we lack the information needed to validate it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate_operation"><a href="#val-validate_operation" class="anchor"></a><code><span><span class="keyword">val</span> validate_operation : 
  <span><span class="optlabel">?check_signature</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-validation_state">validation_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Operation_hash/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/index.html#type-packed_operation">Alpha_context.packed_operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-validation_state">validation_state</a> <a href="../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Check the validity of the given operation; return an updated <code>state</code>.</p><p>An operation is valid if it may be included in a block without causing the block's application to fail. The purpose of this function is to decide validity quickly, that is, without trying to actually apply the operation (ie. compute modifications to the context: see <a href="../Apply/index.html#val-apply_operation"><code>Apply.apply_operation</code></a>) and see whether it causes an error.</p><p>An operation's validity may be checked in different situations: when we receive a block from a peer or we are constructing a fresh block, we validate each operation in the block right before trying to apply it; when a mempool receives an operation, it validates it to decide whether the operation should be propagated (note that for now, this only holds for manager operations, since <code>validate_operation</code> is not implemented yet for other operations: see below). See <code>mode</code>.</p><p>The <code>info</code> contains every information we need about the status of the chain to validate an operation, notably the context (of type <a href="../Alpha_context/index.html#type-t"><code>Alpha_context.t</code></a>) at the end of the previous block. This context is never updated by the validation of operations, since validation is separate from application. Yet sometimes, the presence of some previous operations in a block or a mempool may render the current operation invalid. E.g. the one-operation-per-manager-per-block restriction (1M) states that a block is invalid if it contains two separate operations from the same manager; therefore the validation of an operation will return <code>Error Manager_restriction</code> if another operation by the same manager has already been validated in the same block or mempool. In order to track this kind of operation incompatibilities, we use a <code>state</code> with minimal information that gets updated during validation.</p><p>For a manager operation, validity is solvability, ie. it must be well-formed, and we need to be able to take its fees. Indeed, this is sufficient for the safe inclusion of the operation in a block: even if there is an error during the subsequent application of the manager operation, this will cause the operation to have no further effects, but won't impact the success of the block's application. The solvability of a manager operation notably includes it being correctly signed: indeed, we can't take anything from a manager without having checked their signature.</p><p>For non-manager operations, any error during the operation application causes the whole block to fail. Therefore, the validation of such an operation must ensure that its application will fully succeed.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">check_signature</span> <p>indicates whether the signature check should happen. It defaults to <code>true</code> because the signature needs to be correct for the operation to be valid. This argument exists for special cases where it is acceptable to bypass this check, e.g.:</p><ul><li>The mempool may keep track of operations whose signatures have already been checked: if such an operation needs to be validated again (typically when the head block changes), then the mempool may call <code>validate_operation</code> with <code>check_signature:false</code>.</li></ul><ul><li>The <code>run_operation</code> RPC provided by the plugin explicitly excludes signature checks: see its documentation in <code>lib_plugin/RPC.Scripts.S.run_operation</code>.</li></ul></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_operation"><a href="#val-check_operation" class="anchor"></a><code><span><span class="keyword">val</span> check_operation : 
  <span><span class="optlabel">?check_signature</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-info">info</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'kind</span> <a href="../Alpha_context/index.html#type-operation">Alpha_context.operation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Check the operation validity, see <a href="#val-validate_operation"><code>validate_operation</code></a> for more information</p><p>Note: Should only be called in mempool mode</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check_operation_conflict"><a href="#val-check_operation_conflict" class="anchor"></a><code><span><span class="keyword">val</span> check_operation_conflict : 
  <span><a href="#type-operation_conflict_state">operation_conflict_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Operation_hash/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'kind</span> <a href="../Alpha_context/index.html#type-operation">Alpha_context.operation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, <a href="../Validate_errors/index.html#type-operation_conflict">Validate_errors.operation_conflict</a>)</span>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Pervasives/index.html#type-result">Tezos_protocol_environment_015_PtLimaPt.Pervasives.result</a></span></span></code></div><div class="spec-doc"><p>Check that the operation does not conflict with other operations already validated and included in the <a href="#type-operation_conflict_state"><code>operation_conflict_state</code></a></p><p>Note: Should only be called in mempool mode</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_valid_operation"><a href="#val-add_valid_operation" class="anchor"></a><code><span><span class="keyword">val</span> add_valid_operation : 
  <span><a href="#type-operation_conflict_state">operation_conflict_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_015_PtLimaPt/Operation_hash/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'kind</span> <a href="../Alpha_context/index.html#type-operation">Alpha_context.operation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-operation_conflict_state">operation_conflict_state</a></span></code></div><div class="spec-doc"><p>Add the operation in the <a href="#type-operation_conflict_state"><code>operation_conflict_state</code></a>. The operation should be validated before being added</p><p>Note: Should only be called in mempool mode</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_operation"><a href="#val-remove_operation" class="anchor"></a><code><span><span class="keyword">val</span> remove_operation : 
  <span><a href="#type-operation_conflict_state">operation_conflict_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'kind</span> <a href="../Alpha_context/index.html#type-operation">Alpha_context.operation</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-operation_conflict_state">operation_conflict_state</a></span></code></div><div class="spec-doc"><p>Remove the operation from the <a href="#type-operation_conflict_state"><code>operation_conflict_state</code></a>.</p><p>Hypothesis:</p><ul><li>the <code>operation</code> has been validated and added to <code>operation_conflict_state</code>;</li><li>this function is only valid for the mempool mode.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_block"><a href="#val-finalize_block" class="anchor"></a><code><span><span class="keyword">val</span> finalize_block : 
  <span><a href="#type-validation_state">validation_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Check the consistency of the block_header information with the one computed (Endorsement power, payload hash, etc) while validating the block operations. Checks vary depending on the mode.</p></div></div></div></body></html>
