<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make_hashing_scheme (tezos-protocol-015-PtLimaPt.Tezos_raw_protocol_015_PtLimaPt.Sc_rollup_inbox_repr.Make_hashing_scheme)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">tezos-protocol-015-PtLimaPt</a> &#x00BB; <a href="../../index.html">Tezos_raw_protocol_015_PtLimaPt</a> &#x00BB; <a href="../index.html">Sc_rollup_inbox_repr</a> &#x00BB; Make_hashing_scheme</nav><header class="odoc-preamble"><h1>Module <code><span>Sc_rollup_inbox_repr.Make_hashing_scheme</span></code></h1><p>This validation is based on a standardized Merkelization scheme. The definition of this scheme is independent from the exact data model of the context but it depends on the <code>Tree</code> arity and internal hashing scheme.</p><p>We provide a functor that takes a <code>Context.TREE</code> module from any context, checks that the assumptions made about tree's arity and hashing scheme are valid, and returns a standard compliant implementation of the <a href="../module-type-Merkelized_operations/index.html"><code>Merkelized_operations</code></a>.</p></header><nav class="odoc-toc"><ul><li><a href="#parameters">Parameters</a></li><li><a href="#signature">Signature</a></li></ul></nav><div class="odoc-content"><h2 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h2><div class="odoc-spec"><div class="spec parameter anchored" id="argument-1-P"><a href="#argument-1-P" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="argument-1-P/index.html">P</a></span><span> : <a href="../module-type-P/index.html">P</a></span></code></div></div><h2 id="signature"><a href="#signature" class="anchor"></a>Signature</h2><div class="odoc-spec"><div class="spec type anchored" id="type-tree"><a href="#type-tree" class="anchor"></a><code><span><span class="keyword">type</span> tree</span><span> = <a href="argument-1-P/index.html#type-tree">P.tree</a></span></code></div><div class="spec-doc"><p>The type for the Merkle trees used in this module.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-inbox_context"><a href="#type-inbox_context" class="anchor"></a><code><span><span class="keyword">type</span> inbox_context</span><span> = <a href="argument-1-P/index.html#type-t">P.t</a></span></code></div><div class="spec-doc"><p>The context used by the trees.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash_level_tree"><a href="#val-hash_level_tree" class="anchor"></a><code><span><span class="keyword">val</span> hash_level_tree : <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Hash/index.html#type-t">Hash.t</a></span></code></div><div class="spec-doc"><p>Standard hashing function used for trees in this module.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-new_level_tree"><a href="#val-new_level_tree" class="anchor"></a><code><span><span class="keyword">val</span> new_level_tree : 
  <span><a href="#type-inbox_context">inbox_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-tree">tree</a> <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialise a new level. <code>new_level_tree ctxt level</code> is a merkle tree with no messages yet, but has the <code>level</code> stored so we can check that in proofs.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_messages"><a href="#val-add_messages" class="anchor"></a><code><span><span class="keyword">val</span> add_messages : 
  <span><a href="#type-inbox_context">inbox_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../History/index.html#type-t">History.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Sc_rollup_inbox_message_repr/index.html#type-serialized">Sc_rollup_inbox_message_repr.serialized</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-tree">tree</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-tree">tree</a> * <a href="../History/index.html#type-t">History.t</a> * <a href="../index.html#type-t">t</a>)</span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>add_messages ctxt history inbox level payloads level_tree</code> inserts a list of <code>payloads</code> as new messages in the <code>level_tree</code> of the current <code>level</code> of the <code>inbox</code>. This function returns the new level tree as well as updated <code>inbox</code> and <code>history</code>.</p><p>If the <code>inbox</code>'s level is older than <code>level</code>, the <code>inbox</code> is updated so that the level trees of the levels older than <code>level</code> are archived. To archive a <code>level_tree</code> for a given <code>level</code>, we push it at the end of the <code>history</code> and update the witness of this history in the <code>inbox</code>. The <code>inbox</code>'s level tree for the current level is emptied to insert the <code>payloads</code> in a fresh <code>level_tree</code> for <code>level</code>.</p><p>This function fails if <code>level</code> is older than <code>inbox</code>'s <code>level</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_messages_no_history"><a href="#val-add_messages_no_history" class="anchor"></a><code><span><span class="keyword">val</span> add_messages_no_history : 
  <span><a href="#type-inbox_context">inbox_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Sc_rollup_inbox_message_repr/index.html#type-serialized">Sc_rollup_inbox_message_repr.serialized</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-tree">tree</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-tree">tree</a> * <a href="../index.html#type-t">t</a>,
    <span><a href="../../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-error">Tezos_protocol_environment_015_PtLimaPt.Error_monad.error</a>
      <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-trace">Tezos_protocol_environment_015_PtLimaPt.Error_monad.trace</a></span>)</span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Pervasives/index.html#type-result">Tezos_protocol_environment_015_PtLimaPt.Pervasives.result</a></span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>add_messages_no_history ctxt inbox level payloads level_tree</code> behaves as <code>add_external_messages</code> except that it does not remember the inbox history.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_message_payload"><a href="#val-get_message_payload" class="anchor"></a><code><span><span class="keyword">val</span> get_message_payload : 
  <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../Tezos_protocol_environment_015_PtLimaPt/Z/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Z.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Sc_rollup_inbox_message_repr/index.html#type-serialized">Sc_rollup_inbox_message_repr.serialized</a> option</span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>get_message_payload level_tree idx</code> returns <code>Some payload</code> if the <code>level_tree</code> has more than <code>idx</code> messages, and <code>payload</code> is at position <code>idx</code>. Returns <code>None</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-form_history_proof"><a href="#val-form_history_proof" class="anchor"></a><code><span><span class="keyword">val</span> form_history_proof : 
  <span><a href="#type-inbox_context">inbox_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../History/index.html#type-t">History.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-tree">tree</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../History/index.html#type-t">History.t</a> * <a href="../index.html#type-history_proof">history_proof</a>)</span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>form_history_proof ctxt history inbox level_tree</code> creates the skip list structure that includes the current inbox level, while also updating the <code>history</code> and making sure the <code>level_tree</code> has been committed to the <code>ctxt</code>.</p><p>This is used in <code>archive_if_needed</code> to produce the <code>old_levels_messages</code> value for the next level of the inbox. It is also needed if you want to produce a fully-up-to-date skip list for proof production. Just taking the skip list stored in the inbox at <code>old_levels_messages</code> will not include the current level (and that current level could be quite far back in terms of blocks if the inbox hasn't been added to for a while).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-take_snapshot"><a href="#val-take_snapshot" class="anchor"></a><code><span><span class="keyword">val</span> take_snapshot : <span><a href="../index.html#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-history_proof">history_proof</a></span></code></div><div class="spec-doc"><p>This is similar to <a href="#val-form_history_proof"><code>form_history_proof</code></a> except that it is just to be used on the protocol side because it doesn't ensure the history is remembered or the trees are committed in the context. Used at the beginning of a refutation game to create the snapshot against which proofs in that game must be valid.</p><p>This will however produce a <code>history_proof</code> with exactly the same hash as the one produced by <code>form_history_proof</code>, run on a node with a complete <code>inbox_context</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-inclusion_proof"><a href="#type-inclusion_proof" class="anchor"></a><code><span><span class="keyword">type</span> inclusion_proof</span></code></div><div class="spec-doc"><p>Given a inbox <code>A</code> at some level <code>L</code> and another inbox <code>B</code> at some level <code>L' &gt;= L</code>, an <code>inclusion_proof</code> guarantees that <code>A</code> is an older version of <code>B</code>.</p><p>To be more precise, an <code>inclusion_proof</code> guarantees that the previous levels <code>level_tree</code>s of <code>A</code> are included in the previous levels <code>level_tree</code>s of <code>B</code>. The current <code>level_tree</code> of <code>A</code> and <code>B</code> are not considered.</p><p>The size of this proof is O(log_basis (L' - L)).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inclusion_proof_encoding"><a href="#val-inclusion_proof_encoding" class="anchor"></a><code><span><span class="keyword">val</span> inclusion_proof_encoding : 
  <span><a href="#type-inclusion_proof">inclusion_proof</a> <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Data_encoding/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Data_encoding.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_inclusion_proof"><a href="#val-pp_inclusion_proof" class="anchor"></a><code><span><span class="keyword">val</span> pp_inclusion_proof : 
  <span><a href="../../../Tezos_protocol_environment_015_PtLimaPt/Format/index.html#type-formatter">Tezos_protocol_environment_015_PtLimaPt.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-inclusion_proof">inclusion_proof</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-number_of_proof_steps"><a href="#val-number_of_proof_steps" class="anchor"></a><code><span><span class="keyword">val</span> number_of_proof_steps : <span><a href="#type-inclusion_proof">inclusion_proof</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>number_of_proof_steps proof</code> returns the length of <code>proof</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-verify_inclusion_proof"><a href="#val-verify_inclusion_proof" class="anchor"></a><code><span><span class="keyword">val</span> verify_inclusion_proof : 
  <span><a href="#type-inclusion_proof">inclusion_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  bool</span></code></div><div class="spec-doc"><p><code>verify_inclusion_proof proof a b</code> returns <code>true</code> iff <code>proof</code> is a minimal and valid proof that <code>a</code> is included in <code>b</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-proof"><a href="#type-proof" class="anchor"></a><code><span><span class="keyword">type</span> proof</span></code></div><div class="spec-doc"><p>An inbox proof has three parameters:</p><ul><li>the <code>starting_point</code>, of type <code>Raw_level_repr.t * Z.t</code>, specifying a location in the inbox ;</li></ul><ul><li>the <code>message</code>, of type <code>Sc_rollup_PVM_sig.input option</code> ;</li></ul><ul><li>and a reference <code>snapshot</code> inbox.</li></ul><p>A valid inbox proof implies the following semantics: beginning at <code>starting_point</code> and reading forward through <code>snapshot</code>, the first message you reach will be <code>message</code>.</p><p>Usually this is fairly simple because there will actually be a message at the location specified by <code>starting_point</code>. But in some cases <code>starting_point</code> is past the last message within a level, and then the inbox proof must prove that and also provide another proof about the message at the beginning of the next non-empty level.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_proof"><a href="#val-pp_proof" class="anchor"></a><code><span><span class="keyword">val</span> pp_proof : 
  <span><a href="../../../Tezos_protocol_environment_015_PtLimaPt/Format/index.html#type-formatter">Tezos_protocol_environment_015_PtLimaPt.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_serialized_proof"><a href="#val-to_serialized_proof" class="anchor"></a><code><span><span class="keyword">val</span> to_serialized_proof : <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-serialized_proof">serialized_proof</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_serialized_proof"><a href="#val-of_serialized_proof" class="anchor"></a><code><span><span class="keyword">val</span> of_serialized_proof : <span><a href="../index.html#type-serialized_proof">serialized_proof</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-proof">proof</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-verify_proof"><a href="#val-verify_proof" class="anchor"></a><code><span><span class="keyword">val</span> verify_proof : 
  <span><span>(<a href="../../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> * <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Z/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Z.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-proof">proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../Sc_rollup_PVM_sig/index.html#type-inbox_message">Sc_rollup_PVM_sig.inbox_message</a> option</span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>See the docstring for the <code>proof</code> type for details of proof semantics.</p><p><code>verify_proof starting_point inbox proof</code> will return the third parameter of the proof, <code>message</code>, iff the proof is valid.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-produce_proof"><a href="#val-produce_proof" class="anchor"></a><code><span><span class="keyword">val</span> produce_proof : 
  <span><a href="#type-inbox_context">inbox_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../History/index.html#type-t">History.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-history_proof">history_proof</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> * <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Z/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Z.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-proof">proof</a> * <span><a href="../../Sc_rollup_PVM_sig/index.html#type-inbox_message">Sc_rollup_PVM_sig.inbox_message</a> option</span>)</span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_015_PtLimaPt.Error_monad.tzresult</a></span>
    <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>produce_proof ctxt history inbox (level, counter)</code> creates an inbox proof proving the first message after the index <code>counter</code> at location <code>level</code>. This will fail if the <code>ctxt</code> given doesn't have sufficient data (it needs to be run on an <code>inbox_context</code> with the full history).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-empty"><a href="#val-empty" class="anchor"></a><code><span><span class="keyword">val</span> empty : 
  <span><a href="#type-inbox_context">inbox_context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Sc_rollup_repr/index.html#type-t">Sc_rollup_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Raw_level_repr/index.html#type-t">Raw_level_repr.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-t">t</a> <a href="../../../Tezos_protocol_environment_015_PtLimaPt/Lwt/index.html#type-t">Tezos_protocol_environment_015_PtLimaPt.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>empty ctxt level</code> is an inbox started at some given <code>level</code> with no message at all.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
