<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Wrapped_error_monad (octez-libs.Tezos_error_monad.Core_maker.Make.Wrapped_error_monad)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../index.html">octez-libs</a> &#x00BB; <a href="../../../index.html">Tezos_error_monad</a> &#x00BB; <a href="../../index.html">Core_maker</a> &#x00BB; <a href="../index.html">Make</a> &#x00BB; Wrapped_error_monad</nav><header class="odoc-preamble"><h1>Module type <code><span>Make.Wrapped_error_monad</span></code></h1><p>The purpose of this module is to wrap a specific error monad <code>E</code> into a more general error monad <code>Eg</code>.</p><p>The user implementing such an interface is responsible to maintain the following assertions</p><ul><li>The <code>Eg</code> error is extended locally with a specific constructor <code>C</code></li><li><code>unwrapped</code> is equal to the <code>error</code> type of <code>E</code></li><li><code>wrap</code> builds an <code>Eg</code> <code>error</code> value from an <code>E</code> <code>error</code> value</li><li><code>unwrap</code> matches on <code>Eg</code> error cases and extracts <code>E</code> error value from <code>C</code></li></ul><p>As a reference implementation, see src/lib_protocol_environment/environment_V3.ml</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-unwrapped"><a href="#type-unwrapped" class="anchor"></a><code><span><span class="keyword">type</span> unwrapped</span><span> = </span><span>..</span></code></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../../Sig/module-type-CORE/index.html">Sig.CORE</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../Sig/module-type-CORE/index.html#type-error">error</a> := <a href="#type-unwrapped">unwrapped</a></span></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-error_category"><a href="#type-error_category" class="anchor"></a><code><span><span class="keyword">type</span> error_category</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-string_of_category"><a href="#val-string_of_category" class="anchor"></a><code><span><span class="keyword">val</span> string_of_category : <span><a href="#type-error_category">error_category</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_encoding"><a href="#val-error_encoding" class="anchor"></a><code><span><span class="keyword">val</span> error_encoding : <span><a href="#type-unwrapped">unwrapped</a> <a href="../../../../Data_encoding/index.html#type-t">Data_encoding.t</a></span></span></code></div><div class="spec-doc"><p>The encoding for errors.</p><p>Note that this encoding has a few peculiarities, some of which may impact your code. These peculiarities are due to the type <code>error</code> being an extensible variant.</p><p>Because the <code>error</code> type is an extensible variant, you must register an encoding for each error constructor you add to <code>error</code>. This is done via <a href="#val-register_error_kind"><code>register_error_kind</code></a>.</p><p>Because the <code>error</code> type is an extensible variant, with dynamically registered errors (see peculiarity above), there are no tags associated with each error. This does not affect the JSON encoding, but it does impose restrictions on the binary encoding. The chosen workaround is to encode errors as JSON and to encode the JSON to binary form. As a result, errors can be somewhat large in binary: they include field names and such.</p><p>Because the <code>error</code> type is an extensible variant, with dynamically registered errors (see peculiarity above), the encoding must be recomputed when a new error is registered. This is achieved by the means of a <a href="../../../../Data_encoding/index.html#val-delayed"><code>Data_encoding.delayed</code></a> combinator: the encoding is recomputed on-demand. There is a caching mechanism so that, in the case where no new errors have been registered since the last use, the last result is used.</p><p>This last peculiarity imposes a limit on the use of <code>error_encoding</code> itself. Specifically, it is invalid to use <code>error_encoding</code> inside the <code>~json</code> argument of a <a href="../../../../Data_encoding/index.html#val-splitted"><code>Data_encoding.splitted</code></a>. This is because <code>splitted</code> evaluates the <code>delayed</code> combinator once-and-for-all to produce a json encoding. (Note that the following data-encoding combinators use <code>splitted</code> internally: <a href="../../../../Data_encoding/V1/Encoding/Compact/index.html#val-make"><code>Data_encoding.Compact.make</code></a>, <a href="../../../../Data_encoding/index.html#val-assoc"><code>Data_encoding.assoc</code></a>, and <a href="../../../../Data_encoding/index.html#val-lazy_encoding"><code>Data_encoding.lazy_encoding</code></a>. As a result, it is invalid to use <code>error_encoding</code> within the arguments of these combinators as well.)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-unwrapped">unwrapped</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-register_error_kind"><a href="#val-register_error_kind" class="anchor"></a><code><span><span class="keyword">val</span> register_error_kind : 
  <span><a href="#type-error_category">error_category</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">id</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">title</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">description</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?pp</span>:<span>(<span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'err</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'err</span> <a href="../../../../Data_encoding/index.html#type-t">Data_encoding.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="#type-unwrapped">unwrapped</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'err</span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'err</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-unwrapped">unwrapped</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>The error data type is extensible. Each module can register specialized error serializers <code>id</code> unique name of this error. Ex.: overflow_time_counter <code>title</code> more readable name. Ex.: Overflow of time counter <code>description</code> human readable description. Ex.: The time counter overflowed while computing delta increase <code>pp</code> formatter used to pretty print additional arguments. Ex.: The time counter overflowed while computing delta increase. Previous value %d. Delta: %d <code>encoder</code> <code>decoder</code> data encoding for this error. If the error has no value, specify Data_encoding.empty</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-classify_error"><a href="#val-classify_error" class="anchor"></a><code><span><span class="keyword">val</span> classify_error : <span><a href="#type-unwrapped">unwrapped</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../Error_classification/index.html#type-t">Error_classification.t</a></span></code></div><div class="spec-doc"><p>Classify an error using the registered kinds</p></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Unclassified"><a href="#extension-decl-Unclassified" class="anchor"></a><code><span><span class="keyword">type</span> <a href="#type-unwrapped">unwrapped</a> += <span class="keyword">private</span> </span></code><ol><li id="extension-Unclassified" class="def variant extension anchored"><a href="#extension-Unclassified" class="anchor"></a><code><span>| </span><span><span class="extension">Unclassified</span> <span class="keyword">of</span> string</span></code></li></ol></div><div class="spec-doc"><p>Catch all error when 'serializing' an error.</p></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Unregistered_error"><a href="#extension-decl-Unregistered_error" class="anchor"></a><code><span><span class="keyword">type</span> <a href="#type-unwrapped">unwrapped</a> += <span class="keyword">private</span> </span></code><ol><li id="extension-Unregistered_error" class="def variant extension anchored"><a href="#extension-Unregistered_error" class="anchor"></a><code><span>| </span><span><span class="extension">Unregistered_error</span> <span class="keyword">of</span> <a href="../../../../Data_encoding/index.html#type-json">Data_encoding.json</a></span></code></li></ol></div><div class="spec-doc"><p>Catch all error when 'deserializing' an error.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-json_of_error"><a href="#val-json_of_error" class="anchor"></a><code><span><span class="keyword">val</span> json_of_error : <span><a href="#type-unwrapped">unwrapped</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../../Data_encoding/index.html#type-json">Data_encoding.json</a></span></code></div><div class="spec-doc"><p>An error serializer</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_of_json"><a href="#val-error_of_json" class="anchor"></a><code><span><span class="keyword">val</span> error_of_json : <span><a href="../../../../Data_encoding/index.html#type-json">Data_encoding.json</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-unwrapped">unwrapped</a></span></code></div></div><h3 id="error-documentation"><a href="#error-documentation" class="anchor"></a>Error documentation</h3><div class="odoc-spec"><div class="spec type anchored" id="type-error_info"><a href="#type-error_info" class="anchor"></a><code><span><span class="keyword">type</span> error_info</span><span> = </span><span>{</span></code><ol><li id="type-error_info.category" class="def record field anchored"><a href="#type-error_info.category" class="anchor"></a><code><span>category : <a href="#type-error_category">error_category</a>;</span></code></li><li id="type-error_info.id" class="def record field anchored"><a href="#type-error_info.id" class="anchor"></a><code><span>id : string;</span></code></li><li id="type-error_info.title" class="def record field anchored"><a href="#type-error_info.title" class="anchor"></a><code><span>title : string;</span></code></li><li id="type-error_info.description" class="def record field anchored"><a href="#type-error_info.description" class="anchor"></a><code><span>description : string;</span></code></li><li id="type-error_info.schema" class="def record field anchored"><a href="#type-error_info.schema" class="anchor"></a><code><span>schema : <a href="../../../../Data_encoding/index.html#type-json_schema">Data_encoding.json_schema</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Error information</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_info"><a href="#val-pp_info" class="anchor"></a><code><span><span class="keyword">val</span> pp_info : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-error_info">error_info</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_info_of_error"><a href="#val-find_info_of_error" class="anchor"></a><code><span><span class="keyword">val</span> find_info_of_error : <span><a href="#type-unwrapped">unwrapped</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-error_info">error_info</a></span></code></div><div class="spec-doc"><p><code>find_info_of_error e</code> retrieves the `error_info` associated with the given error `e`.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if the error is a wrapped error from another monad</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Not_found</code> <p>if the error's constructor has not been registered</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_registered_errors"><a href="#val-get_registered_errors" class="anchor"></a><code><span><span class="keyword">val</span> get_registered_errors : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-error_info">error_info</a> list</span></span></code></div><div class="spec-doc"><p>Retrieves information of registered errors</p></div></div></details></div><div class="odoc-spec"><div class="spec value anchored" id="val-unwrap"><a href="#val-unwrap" class="anchor"></a><code><span><span class="keyword">val</span> unwrap : <span><a href="../index.html#type-error">error</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-unwrapped">unwrapped</a> option</span></span></code></div><div class="spec-doc"><p><code>unwrap e</code> returns <code>Some</code> when <code>e</code> matches variant constructor <code>C</code> and <code>None</code> otherwise</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wrap"><a href="#val-wrap" class="anchor"></a><code><span><span class="keyword">val</span> wrap : <span><a href="#type-unwrapped">unwrapped</a> <span class="arrow">&#45;&gt;</span></span> <a href="../index.html#type-error">error</a></span></code></div><div class="spec-doc"><p><code>wrap e</code> returns a general <code>error</code> from a specific <code>unwrapped</code> error <code>e</code></p></div></div></div></body></html>
