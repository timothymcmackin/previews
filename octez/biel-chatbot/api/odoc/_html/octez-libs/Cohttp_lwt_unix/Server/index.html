<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Server (octez-libs.Cohttp_lwt_unix.Server)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-libs</a> &#x00BB; <a href="../index.html">Cohttp_lwt_unix</a> &#x00BB; Server</nav><header class="odoc-preamble"><h1>Module <code><span>Cohttp_lwt_unix.Server</span></code></h1><p>The <code>Server</code> module implements the full UNIX HTTP server interface, including the UNIX-specific functions defined in <code>S</code>.</p><p>The <code>Logs</code> source name for this module logger is <code>&quot;cohttp.lwt.server&quot;</code>. Refer to the <a href="../Debug/index.html"><code>Debug</code></a> module for further details.</p></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../Cohttp_lwt/S/module-type-Server/index.html">Cohttp_lwt.S.Server</a> <span class="keyword">with</span> <span><span class="keyword">module</span> <a href="../../Cohttp_lwt/S/module-type-Server/IO/index.html">IO</a> = <span class="xref-unresolved">Cohttp_lwt_unix__.Io</span></span></span></code></summary><div class="odoc-spec"><div class="spec module anchored" id="module-IO"><a href="#module-IO" class="anchor"></a><code><span><span class="keyword">module</span> <a href="IO/index.html">IO</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The <code>Io</code> module contains the IO implementation for <code>cohttp-lwt-unix</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-conn"><a href="#type-conn" class="anchor"></a><code><span><span class="keyword">type</span> conn</span><span> = <a href="IO/index.html#type-conn">IO.conn</a> * <span class="xref-unresolved">Cohttp</span>.Connection.t</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-response_action"><a href="#type-response_action" class="anchor"></a><code><span><span class="keyword">type</span> response_action</span><span> = </span><span>[ </span></code><ol><li id="type-response_action.Expert" class="def variant constructor anchored"><a href="#type-response_action.Expert" class="anchor"></a><code><span>| </span><span>`Expert <span class="keyword">of</span> <span class="xref-unresolved">Cohttp</span>.Response.t * <span>(<span><a href="IO/index.html#type-ic">IO.ic</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="IO/index.html#type-oc">IO.oc</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span></span></code></li><li id="type-response_action.Response" class="def variant constructor anchored"><a href="#type-response_action.Response" class="anchor"></a><code><span>| </span><span>`Response <span class="keyword">of</span> <span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>A request handler can respond in two ways:</p><ul><li>Using <code>`Response</code>, with a <a href="../Response/index.html#type-t"><code>Response.t</code></a> and a <code>Body.t</code>.</li><li>Using <code>`Expert</code>, with a <a href="../Response/index.html#type-t"><code>Response.t</code></a> and an IO function that is expected to write the response body. The IO function has access to the underlying <code>!IO.ic</code> and <code>!IO.oc</code>, which allows writing a response body more efficiently, stream a response or to switch protocols entirely (e.g. websockets). Processing of pipelined requests continue after the <code>unitLwt.t</code> is resolved. The connection can be closed by closing the <code>!IO.ic</code>.</li></ul></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make_response_action"><a href="#val-make_response_action" class="anchor"></a><code><span><span class="keyword">val</span> make_response_action : 
  <span><span class="optlabel">?conn_closed</span>:<span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?sleep_fn</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">callback</span>:
    <span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Cohttp</span>.Request.t <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-response_action">response_action</a> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>make_response_action</code> creates a set of callbacks used by Cohttp Server.</p><ul><li><code>callback</code> is called when a new connection is accepted by the server socket.</li><li><code>conn_closed</code> if provided, will be called when the connection is closed, e.g. when an EOF is received.</li><li><code>sleep_fn</code> if provided, will be used for periodic checks for EOF from the client. If this callback is not provided, Cohttp will not detect and notify the client about EOF received from the peer while the client is handling the new connection. This can lead to a resource leak if the <code>callback</code> is designed to never resolve. If the connection is closed locally, Cohttp will stop waiting for EOF and will wait the promise to be cancelled.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make_expert"><a href="#val-make_expert" class="anchor"></a><code><span><span class="keyword">val</span> make_expert : 
  <span><span class="optlabel">?conn_closed</span>:<span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?sleep_fn</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">callback</span>:
    <span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="xref-unresolved">Cohttp</span>.Request.t <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <span>(<span><a href="IO/index.html#type-ic">IO.ic</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="IO/index.html#type-oc">IO.oc</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span>)</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make"><a href="#val-make" class="anchor"></a><code><span><span class="keyword">val</span> make : 
  <span><span class="optlabel">?conn_closed</span>:<span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?sleep_fn</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">callback</span>:
    <span>(<span><a href="#type-conn">conn</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="xref-unresolved">Cohttp</span>.Request.t <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-resolve_local_file"><a href="#val-resolve_local_file" class="anchor"></a><code><span><span class="keyword">val</span> resolve_local_file : <span><span class="label">docroot</span>:string <span class="arrow">&#45;&gt;</span></span> <span><span class="label">uri</span>:<span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Resolve a URI and a docroot into a concrete local filename.</p><p>Deprecated. Please use Cohttp.Path.resolve_local_file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-respond"><a href="#val-respond" class="anchor"></a><code><span><span class="keyword">val</span> respond : 
  <span><span class="optlabel">?headers</span>:<span class="xref-unresolved">Cohttp</span>.Header.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?flush</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">status</span>:<span class="xref-unresolved">Cohttp</span>.Code.status_code <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">body</span>:<a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>respond ?headers ?flush ~status ~body</code> will respond to an HTTP request with the given <code>status</code> code and response <code>body</code>. If <code>flush</code> is true, then every response chunk will be flushed to the network rather than being buffered. <code>flush</code> is true by default. The transfer encoding will be detected from the <code>body</code> value and set to chunked encoding if it cannot be determined immediately. You can override the encoding by supplying an appropriate <code>Content-length</code> or <code>Transfer-encoding</code> in the <code>headers</code> parameter.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-respond_string"><a href="#val-respond_string" class="anchor"></a><code><span><span class="keyword">val</span> respond_string : 
  <span><span class="optlabel">?flush</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?headers</span>:<span class="xref-unresolved">Cohttp</span>.Header.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">status</span>:<span class="xref-unresolved">Cohttp</span>.Code.status_code <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">body</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-respond_error"><a href="#val-respond_error" class="anchor"></a><code><span><span class="keyword">val</span> respond_error : 
  <span><span class="optlabel">?headers</span>:<span class="xref-unresolved">Cohttp</span>.Header.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?status</span>:<span class="xref-unresolved">Cohttp</span>.Code.status_code <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">body</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-respond_redirect"><a href="#val-respond_redirect" class="anchor"></a><code><span><span class="keyword">val</span> respond_redirect : 
  <span><span class="optlabel">?headers</span>:<span class="xref-unresolved">Cohttp</span>.Header.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">uri</span>:<span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-respond_need_auth"><a href="#val-respond_need_auth" class="anchor"></a><code><span><span class="keyword">val</span> respond_need_auth : 
  <span><span class="optlabel">?headers</span>:<span class="xref-unresolved">Cohttp</span>.Header.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">auth</span>:<span class="xref-unresolved">Cohttp</span>.Auth.challenge <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-respond_not_found"><a href="#val-respond_not_found" class="anchor"></a><code><span><span class="keyword">val</span> respond_not_found : 
  <span><span class="optlabel">?uri</span>:<span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-callback"><a href="#val-callback" class="anchor"></a><code><span><span class="keyword">val</span> callback : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="IO/index.html#type-conn">IO.conn</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="IO/index.html#type-ic">IO.ic</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="IO/index.html#type-oc">IO.oc</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></details></div><div class="odoc-spec"><div class="spec value anchored" id="val-resolve_file"><a href="#val-resolve_file" class="anchor"></a><code><span><span class="keyword">val</span> resolve_file : <span><span class="label">docroot</span>:string <span class="arrow">&#45;&gt;</span></span> <span><span class="label">uri</span>:<span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Deprecated. Please use Cohttp.Path.resolve_local_file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-respond_file"><a href="#val-respond_file" class="anchor"></a><code><span><span class="keyword">val</span> respond_file : 
  <span><span class="optlabel">?headers</span>:<span class="xref-unresolved">Cohttp</span>.Header.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">fname</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="xref-unresolved">Cohttp</span>.Response.t * <a href="../../Cohttp_lwt/Body/index.html#type-t">Cohttp_lwt.Body.t</a>)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?timeout</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?backlog</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?stop</span>:<span>unit <span class="xref-unresolved">Lwt</span>.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?on_exn</span>:<span>(<span>exn <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?ctx</span>:<a href="../Net/index.html#type-ctx">Net.ctx</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?mode</span>:<span class="xref-unresolved">Conduit_lwt_unix</span>.server <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>create ?timeout ?backlog ?stop ?on_exn ?mode t</code> is a new HTTP server.</p><p>The user can decide to start a simple HTTP server (without encryption) or one with TLS encryption. It depends on what the user gives as <code>mode</code> and how <code>conduit-unix</code> is configured.</p><p>To create a simple HTTP server listening on port 8089:</p><pre class="language-ocaml"><code>let run = create (`TCP 8080) </code></pre><p>When provided, the <code>stop</code> thread will terminate the server if it ever becomes determined.</p><p>When provided, <code>backlog</code> will limit the number of open connections.</p><p>Every connection will be served in a new lightweight thread that is invoked via the callback defined in <code>t</code>. If the callback raises an exception, it is passed to <code>on_exn</code> (by default, to a function that logs the exception using the <code>Logs</code> library).</p></div></div></div></body></html>
