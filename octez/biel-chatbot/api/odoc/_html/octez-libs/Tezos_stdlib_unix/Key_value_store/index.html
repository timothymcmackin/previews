<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Key_value_store (octez-libs.Tezos_stdlib_unix.Key_value_store)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-libs</a> &#x00BB; <a href="../index.html">Tezos_stdlib_unix</a> &#x00BB; Key_value_store</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_stdlib_unix.Key_value_store</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#key-value-store">Key-value store</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Missing_stored_kvs_data"><a href="#extension-decl-Missing_stored_kvs_data" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_error_monad/Error_monad/index.html#type-error">Tezos_error_monad.Error_monad.error</a> += </span></code><ol><li id="extension-Missing_stored_kvs_data" class="def variant extension anchored"><a href="#extension-Missing_stored_kvs_data" class="anchor"></a><code><span>| </span><span><span class="extension">Missing_stored_kvs_data</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Key_value_store.filepath" class="def record field anchored"><a href="#module-Key_value_store.filepath" class="anchor"></a><code><span>filepath : string;</span></code></li><li id="module-Key_value_store.index" class="def record field anchored"><a href="#module-Key_value_store.index" class="anchor"></a><code><span>index : int;</span></code></li></ol><code><span>}</span></code></li><li id="extension-Wrong_encoded_value_size" class="def variant extension anchored"><a href="#extension-Wrong_encoded_value_size" class="anchor"></a><code><span>| </span><span><span class="extension">Wrong_encoded_value_size</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Key_value_store.file" class="def record field anchored"><a href="#module-Key_value_store.file" class="anchor"></a><code><span>file : string;</span></code></li><li id="module-Key_value_store.index" class="def record field anchored"><a href="#module-Key_value_store.index" class="anchor"></a><code><span>index : int;</span></code></li><li id="module-Key_value_store.expected" class="def record field anchored"><a href="#module-Key_value_store.expected" class="anchor"></a><code><span>expected : int;</span></code></li><li id="module-Key_value_store.got" class="def record field anchored"><a href="#module-Key_value_store.got" class="anchor"></a><code><span>got : int;</span></code></li></ol><code><span>}</span></code></li><li id="extension-Closed" class="def variant extension anchored"><a href="#extension-Closed" class="anchor"></a><code><span>| </span><span><span class="extension">Closed</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Key_value_store.action" class="def record field anchored"><a href="#module-Key_value_store.action" class="anchor"></a><code><span>action : string;</span></code></li></ol><code><span>}</span></code></li><li id="extension-Corrupted_data" class="def variant extension anchored"><a href="#extension-Corrupted_data" class="anchor"></a><code><span>| </span><span><span class="extension">Corrupted_data</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Key_value_store.action" class="def record field anchored"><a href="#module-Key_value_store.action" class="anchor"></a><code><span>action : string;</span></code></li><li id="module-Key_value_store.filepath" class="def record field anchored"><a href="#module-Key_value_store.filepath" class="anchor"></a><code><span>filepath : string;</span></code></li><li id="module-Key_value_store.index" class="def record field anchored"><a href="#module-Key_value_store.index" class="anchor"></a><code><span>index : int;</span></code></li></ol><code><span>}</span></code></li><li id="extension-Encoding_failed" class="def variant extension anchored"><a href="#extension-Encoding_failed" class="anchor"></a><code><span>| </span><span><span class="extension">Encoding_failed</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Key_value_store.filepath" class="def record field anchored"><a href="#module-Key_value_store.filepath" class="anchor"></a><code><span>filepath : string;</span></code></li><li id="module-Key_value_store.index" class="def record field anchored"><a href="#module-Key_value_store.index" class="anchor"></a><code><span>index : int;</span></code></li></ol><code><span>}</span></code></li><li id="extension-Decoding_failed" class="def variant extension anchored"><a href="#extension-Decoding_failed" class="anchor"></a><code><span>| </span><span><span class="extension">Decoding_failed</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="module-Key_value_store.filepath" class="def record field anchored"><a href="#module-Key_value_store.filepath" class="anchor"></a><code><span>filepath : string;</span></code></li><li id="module-Key_value_store.index" class="def record field anchored"><a href="#module-Key_value_store.index" class="anchor"></a><code><span>index : int;</span></code></li></ol><code><span>}</span></code></li></ol></div></div><h2 id="key-value-store"><a href="#key-value-store" class="anchor"></a>Key-value store</h2><p>This module defines a simple key-value store. The design is minimal and aims to be:</p><ul><li>easy to use</li></ul><ul><li>safe when used in a concurrent setting</li></ul><p>Each key-value pair is associated to a virtual file. Each virtual file has a layout, given by the user, which specifies, among other things, an underlying physical file for storing the key-value pairs. It is up to the user to decide which virtual file to use to store a key-value pair. It is recommended that values that will be accessed together frequently should be stored in the same file.</p><p>In a virtual file, all the stored values should the same size. Each key is associated with an index from 0 to some maximum value (see implementation). Different keys should be associated to different indexes.</p><p>A maximum of 4096 values can be stored in a file.</p><p>To avoid I/Os, the store keeps recently used values in memory, as follows. It maintains an LRU (least-recently used) of a given maximum (see <a href="#val-init"><code>init</code></a>) of open files. For each open file, there is an associated cache containing all read/write values since the file was opened (only the most recent value for a given key, of course).</p><div class="odoc-spec"><div class="spec type anchored" id="type-layout"><a href="#type-layout" class="anchor"></a><code><span><span class="keyword">type</span> <span>('key, 'value) layout</span></span></code></div><div class="spec-doc"><p>A <code>layout</code> specifies the layout of a virtual file storing keys of type <code>'key</code> and values of type <code>'value</code>, as well as the path to the underlying physical file.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-file_layout"><a href="#type-file_layout" class="anchor"></a><code><span><span class="keyword">type</span> <span>('file, 'key, 'value) file_layout</span></span><span> =
  <span><span class="label">root_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'file</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-layout">layout</a></span></span></code></div><div class="spec-doc"><p>The type of functions to compute the layout of a given file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-layout"><a href="#val-layout" class="anchor"></a><code><span><span class="keyword">val</span> layout : 
  <span><span class="optlabel">?encoded_value_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">encoding</span>:<span><span class="type-var">'value</span> <a href="../../Data_encoding/index.html#type-t">Data_encoding.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">filepath</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">eq</span>:<span>(<span><span class="type-var">'value</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'value</span> <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">index_of</span>:<span>(<span><span class="type-var">'key</span> <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">number_of_keys_per_file</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-layout">layout</a></span></span></code></div><div class="spec-doc"><p><code>layout ?encoded_value_size value_encoding path eq index_of
    ~number_of_keys_per_file</code> describes a virtual file layout.</p><ul><li><code>encoded_value_size</code> is the size in bytes of any encoded value. If encoded values have different sizes, the behaviour of the store is undefined. If <code>encoded_value_size</code> is not given, then the encoded value size is deduced from <code>value_encoding</code>, which must be of fixed length.</li><li><code>value_encoding</code> is an encoding for values.</li><li><code>path</code> is the path of the physical file.</li><li><code>eq</code> is an equality function on values.</li><li><code>index_of</code> gives the index of a given key.</li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if <code>encoded_value_size=None</code> and <code>value_encoding</code> does not have a fixed length.</p><p>The user should provide the number of keys stored per file, which should not exceed 4096.</p></li></ul></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>('file, 'key, 'value) t</span></span></code></div><div class="spec-doc"><p>An abstract representation of a file-based key-value store.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : 
  <span><span class="label">lru_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">root_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init ~lru_size ~root_dir</code> initialises a file-based key-value store. The <code>root_dir</code> is created on disk if it doesn't exist. All the keys/values associated to a file are stored in a single physical file.</p><p><code>lru_size</code> is a parameter that represents maximum number of open files. It is up to the user of this library to decide this number depending on the sizes of the values.</p><p>Internally creates a lockfile and returns an error if a key value store in the same <code>root_dir</code> is locked by another process. This lockfile does not prevent concurrent opens by the same process and should be completed by a mutex if necessary.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : 
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close kvs</code> waits until all pending reads and writes are completed and closes the key-value store.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-root_dir"><a href="#val-root_dir" class="anchor"></a><code><span><span class="keyword">val</span> root_dir : <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>root_dir t</code> returns the <code>root_dir</code> directory used to create <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_value"><a href="#val-write_value" class="anchor"></a><code><span><span class="keyword">val</span> write_value : 
  <span><span class="optlabel">?override</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'file</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'key</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'value</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>write_value ?(override=false) t file_layout file key value</code> writes a value in the <code>key</code> value store in <code>file</code>. If there is already a written value for this key, then the value will be written if and only if <code>override</code> is <code>true</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_values"><a href="#val-write_values" class="anchor"></a><code><span><span class="keyword">val</span> write_values : 
  <span><span class="optlabel">?override</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span> * <span class="type-var">'key</span> * <span class="type-var">'value</span>)</span> <a href="../../Tezos_error_monad/TzLwtreslib/Seq/index.html#type-t">Tezos_error_monad.TzLwtreslib.Seq.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>write_values ?(override=false) t file_layout seq</code> writes the sequence <code>seq</code> onto the store (see <a href="#val-write_value"><code>write_value</code></a>). If an error occurs, the first error is returned. This function guarantees that up to the data for which the error occured, the values were stored onto the disk.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_value"><a href="#val-read_value" class="anchor"></a><code><span><span class="keyword">val</span> read_value : 
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'file</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'key</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'value</span> <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_value t file_layout file key</code> reads the value associated to <code>key</code> in the <code>file</code> in the store. Fails if no value were attached to this <code>key</code>. The value read is the last one that was produced by a successful write.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_values"><a href="#val-read_values" class="anchor"></a><code><span><span class="keyword">val</span> read_values : 
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span> * <span class="type-var">'key</span>)</span> <a href="../../Tezos_error_monad/TzLwtreslib/Seq/index.html#type-t">Tezos_error_monad.TzLwtreslib.Seq.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'file</span> * <span class="type-var">'key</span> * <span><span class="type-var">'value</span> <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span>)</span>
    <a href="../../Tezos_error_monad/TzLwtreslib/Seq_s/index.html#type-t">Tezos_error_monad.TzLwtreslib.Seq_s.t</a></span></span></code></div><div class="spec-doc"><p><code>read_values t file_layout keys</code> produces a sequence of <code>values</code> associated to the sequence of <code>keys</code>. This function is almost instantaneous since no reads are performed. Reads are done when the caller consumes the values of the sequence returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-value_exists"><a href="#val-value_exists" class="anchor"></a><code><span><span class="keyword">val</span> value_exists : 
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'file</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'key</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>bool <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-read_value"><code>read_value</code></a> expect that this function returns whether the given entry exists without reading it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-values_exist"><a href="#val-values_exist" class="anchor"></a><code><span><span class="keyword">val</span> values_exist : 
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span> * <span class="type-var">'key</span>)</span> <a href="../../Tezos_error_monad/TzLwtreslib/Seq/index.html#type-t">Tezos_error_monad.TzLwtreslib.Seq.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'file</span> * <span class="type-var">'key</span> * <span>bool <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span>)</span>
    <a href="../../Tezos_error_monad/TzLwtreslib/Seq_s/index.html#type-t">Tezos_error_monad.TzLwtreslib.Seq_s.t</a></span></span></code></div><div class="spec-doc"><p>Same as <a href="#val-read_values"><code>read_values</code></a> expect that this function returns whether the given entries exist without reading them.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_file"><a href="#val-remove_file" class="anchor"></a><code><span><span class="keyword">val</span> remove_file : 
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'file</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>remove_file t file_layout</code> removes the corresponding physical file of <code>file</code> from the disk as well as the corresponding keys/values of the store. In case of concurrent read/write, this function should succeed no matter what. The result of <code>read/write</code> depends on which function was issued first. For example if the <code>read</code> was issued before the <code>remove_file</code>, it will return the corresponding value that was stored, and then the file will be removed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-count_values"><a href="#val-count_values" class="anchor"></a><code><span><span class="keyword">val</span> count_values : 
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'file</span>, <span class="type-var">'key</span>, <span class="type-var">'value</span>)</span> <a href="#type-file_layout">file_layout</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'file</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>int <a href="../../Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>This function returns the number of entries for a given file.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-View"><a href="#module-View" class="anchor"></a><code><span><span class="keyword">module</span> <a href="View/index.html">View</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_tests"><a href="#module-Internal_for_tests" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_tests/index.html">Internal_for_tests</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
