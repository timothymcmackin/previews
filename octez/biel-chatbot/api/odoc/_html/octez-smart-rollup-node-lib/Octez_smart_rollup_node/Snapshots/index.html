<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Snapshots (octez-smart-rollup-node-lib.Octez_smart_rollup_node.Snapshots)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-smart-rollup-node-lib</a> &#x00BB; <a href="../index.html">Octez_smart_rollup_node</a> &#x00BB; Snapshots</nav><header class="odoc-preamble"><h1>Module <code><span>Octez_smart_rollup_node.Snapshots</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-compression"><a href="#type-compression" class="anchor"></a><code><span><span class="keyword">type</span> compression</span><span> = </span></code><ol><li id="type-compression.No" class="def variant constructor anchored"><a href="#type-compression.No" class="anchor"></a><code><span>| </span><span><span class="constructor">No</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Produce uncompressed archive. Takes more space.</p><span class="comment-delim">*)</span></div></li><li id="type-compression.On_the_fly" class="def variant constructor anchored"><a href="#type-compression.On_the_fly" class="anchor"></a><code><span>| </span><span><span class="constructor">On_the_fly</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Compress archive on the fly. The rollup node will use less disk space to produce the snapshot but will lock the rollup node (if running) for a longer time.</p><span class="comment-delim">*)</span></div></li><li id="type-compression.After" class="def variant constructor anchored"><a href="#type-compression.After" class="anchor"></a><code><span>| </span><span><span class="constructor">After</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Compress archive after snapshot creation. Uses more disk space temporarily than <a href="#type-compression.On_the_fly"><code>On_the_fly</code></a> but does not lock the rollup node for very long.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>Compression strategy for snapshot archives.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Header"><a href="#module-Header" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Header/index.html">Header</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-export"><a href="#val-export" class="anchor"></a><code><span><span class="keyword">val</span> export : 
  <span><span class="optlabel">?rollup_node_endpoint</span>:<span class="xref-unresolved">Uri</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-full/index.html">Tezos_client_base.Client_context.full</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">no_checks</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">compression</span>:<a href="#type-compression">compression</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dest</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">filename</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>string <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>export ?rollup_node_endpoint cctxt ~no_checks ~compression ~data_dir ~dest
    ~filename</code> creates a tar gzipped archive with name <code>filename</code> (or a generated name) in <code>dest</code> (or the current directory) containing a snapshot of the data of the rollup node with data directory <code>data_dir</code>. The path of the snapshot archive is returned. If <code>no_checks</code> is <code>true</code>, the integrity of the snapshot is not checked at the end. This function will first try to cancel any GC on the target node if <code>rollup_node_endpoint</code> is specified to communicate with it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-export_compact"><a href="#val-export_compact" class="anchor"></a><code><span><span class="keyword">val</span> export_compact : 
  <span><a href="../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-full/index.html">Tezos_client_base.Client_context.full</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">no_checks</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">compression</span>:<a href="#type-compression">compression</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dest</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">filename</span>:<span>string option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>string <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>export_compact cctxt ~no_checks ~compression ~data_dir ~dest ~filename</code> creates a tar gzipped archive with name <code>filename</code> (or a generated name) in <code>dest</code> (or the current directory) containing a snapshot of the data of the rollup node with data directory <code>data_dir</code>. The difference with <a href="#val-export"><code>export</code></a> is that the snapshot contains a single commit for the context (which must be reconstructed on import) but is significantly smaller. If <code>no_checks</code> is <code>true</code>, we don't check if commitments are published on L1 (integrity is not checked because it requires rebuilding the context).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-import"><a href="#val-import" class="anchor"></a><code><span><span class="keyword">val</span> import : 
  <span><span class="label">apply_unsafe_patches</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">no_checks</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">force</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-full/index.html">Tezos_client_base.Client_context.full</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">snapshot_file</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>import ~apply_unsafe_patches ~no_checks ~force cctxt ~data_dir
    ~snapshot_file</code> imports the snapshot at path <code>snapshot_file</code> into the data directory <code>data_dir</code>. If <code>no_checks</code> is <code>true</code>, the integrity of the imported data is not checked at the end. Import will fail if <code>data_dir</code> is already populated unless <code>force</code> is set to <code>true</code>. if <code>apply_unsafe_patches</code> is <code>true</code> and there is <code>unsafe_pvm_patches</code> in the configuration they will be applied.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-info"><a href="#val-info" class="anchor"></a><code><span><span class="keyword">val</span> info : <span><span class="label">snapshot_file</span>:string <span class="arrow">&#45;&gt;</span></span> <a href="Header/index.html#type-t">Header.t</a> * <span>[ `Compressed <span>| `Uncompressed</span> ]</span></span></code></div><div class="spec-doc"><p><code>info ~snapshot_file</code> returns information that can be used to inspect the snapshot file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_modify_data_dir"><a href="#val-with_modify_data_dir" class="anchor"></a><code><span><span class="keyword">val</span> with_modify_data_dir : 
  <span><a href="../../../octez-shell-libs/Tezos_client_base/Client_context/class-type-full/index.html">Tezos_client_base.Client_context.full</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">data_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">apply_unsafe_patches</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?skip_condition</span>:
    <span>(<span><a href="../../../octez-l2-libs/Octez_smart_rollup_node_store/Store/index.html#type-rw">Octez_smart_rollup_node_store.Store.rw</a> <span class="arrow">&#45;&gt;</span></span>
      <span><a href="../../../octez-l2-libs/Tezos_layer2_store/Context/index.html#type-rw">Tezos_layer2_store.Context.rw</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="label">head</span>:<a href="../../../octez-l2-libs/Octez_smart_rollup/Sc_rollup_block/index.html#type-t">Octez_smart_rollup.Sc_rollup_block.t</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span>bool <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../Node_context/index.html#type-rw">Node_context.rw</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span class="label">head</span>:<a href="../../../octez-l2-libs/Octez_smart_rollup/Sc_rollup_block/index.html#type-t">Octez_smart_rollup.Sc_rollup_block.t</a> <span class="arrow">&#45;&gt;</span></span>
    <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_modify_data_dir cctxt ~data_dir ~apply_unsafe_patches ?skip_condition
    f</code> applies <code>f</code> in a read-write context that is created from <code>data-dir</code> (and a potential existing configuration). The node context given to <code>f</code> does not follow the L1 chain and <code>f</code> is only supposed to modify the data of the rollup node. It is used internally by this module to reconstruct contexts from a snapshot but can also be use by the <a href="../Repair/index.html"><code>Repair</code></a> module to apply fixes off-line.</p></div></div></div></body></html>
