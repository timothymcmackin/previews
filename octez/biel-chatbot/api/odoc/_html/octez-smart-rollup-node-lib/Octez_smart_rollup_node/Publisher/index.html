<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Publisher (octez-smart-rollup-node-lib.Octez_smart_rollup_node.Publisher)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">octez-smart-rollup-node-lib</a> &#x00BB; <a href="../index.html">Octez_smart_rollup_node</a> &#x00BB; Publisher</nav><header class="odoc-preamble"><h1>Module <code><span>Octez_smart_rollup_node.Publisher</span></code></h1><p>The rollup node stores and publishes commitments for the PVM every `Commitment.sc_rollup_commitment_period` levels.</p><p>Every time a finalized block is processed by the rollup node, the latter determines whether the last commitment that the node has produced referred to `Commitment.sc_rollup_commitment_period` blocks earlier. In this case, it computes and stores a new commitment in a level-indexed map.</p><p>Stored commitments are signed by the rollup node operator and published on the layer1 chain. To ensure that commitments produced by the rollup node are eventually published, storing and publishing commitments are decoupled. Every time a new head is processed, the node tries to publish the oldest commitment that was not published already.</p></header><nav class="odoc-toc"><ul><li><a href="#helper-module">Helper module</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-process_head"><a href="#val-process_head" class="anchor"></a><code><span><span class="keyword">val</span> process_head : 
  <span><span>(<span class="keyword">module</span> <a href="../Protocol_plugin_sig/module-type-S/index.html">Protocol_plugin_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Node_context/index.html#type-rw">Node_context.rw</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Layer1/index.html#type-header">Layer1.header</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-l2-libs/Tezos_layer2_store/Context/index.html#type-rw">Tezos_layer2_store.Context.rw</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><a href="../../../octez-libs/Tezos_crypto/Hashed/Smart_rollup_commitment_hash/index.html#type-t">Octez_smart_rollup.Commitment.Hash.t</a> option</span> <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>process_head plugin node_ctxt ~predecessor head ctxt</code> builds a new commitment if needed, by looking at the level of <code>head</code> and checking whether it is a multiple of `Commitment.sc_rollup_commitment_period` levels away from <code>node_ctxt.initial_level</code>. It uses the functionalities of <code>PVM</code> to compute the hash of to be included in the commitment.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_commitment_if_necessary"><a href="#val-create_commitment_if_necessary" class="anchor"></a><code><span><span class="keyword">val</span> create_commitment_if_necessary : 
  <span><span>(<span class="keyword">module</span> <a href="../Protocol_plugin_sig/module-type-S/index.html">Protocol_plugin_sig.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../Node_context/index.html#type-t">Node_context.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor</span>:<a href="../../../octez-libs/Tezos_crypto/Hashed/Block_hash/index.html#type-t">Tezos_base.TzPervasives.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>int32 <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="../../../octez-l2-libs/Tezos_layer2_store/Context/index.html#type-t">Tezos_layer2_store.Context.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span><a href="../../../octez-l2-libs/Octez_smart_rollup/Commitment/index.html#type-t">Octez_smart_rollup.Commitment.t</a> option</span>, <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tztrace">Tezos_base.TzPervasives.tztrace</a>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span>
    <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>create_commitment_if_necessary plugin node_ctxt ~predecessor level ctxt</code> returns the commitment for inbox level <code>level</code> if there needs to be one. <code>ctxt</code> should be the context checkouted for <code>level</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-publish_single_commitment"><a href="#val-publish_single_commitment" class="anchor"></a><code><span><span class="keyword">val</span> publish_single_commitment : 
  <span><span><span class="type-var">_</span> <a href="../Node_context/index.html#type-t">Node_context.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../octez-l2-libs/Octez_smart_rollup/Commitment/index.html#type-t">Octez_smart_rollup.Commitment.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>publish_single_commitment node_ctxt commitment</code> publishes a single <code>commitment</code> if it is missing. This function is meant to be used by the <em>accuser</em> mode to sparingly publish commitments when it detects a conflict.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-recover_bond"><a href="#val-recover_bond" class="anchor"></a><code><span><span class="keyword">val</span> recover_bond : 
  <span><span><span class="type-var">_</span> <a href="../Node_context/index.html#type-t">Node_context.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>recover_bond node_ctxt</code> publishes a recover bond operator for the Operating key. The submitter is either the operator or another address depending of the rollup node configuration. This function is intended to be used by the <em>bailout</em> mode.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-init"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span><a href="../Node_context/index.html#type-rw">Node_context.rw</a> <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Initialize worker for publishing and cementing commitments, if the rollup node mode supports it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-publish_commitments"><a href="#val-publish_commitments" class="anchor"></a><code><span><span class="keyword">val</span> publish_commitments : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>publish_commitments</code> publishes the commitments that were not yet published up to the finalized head and which are after the last cemented commitment. This is a no-op if the rollup node is not in the appropriate mode.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cement_commitments"><a href="#val-cement_commitments" class="anchor"></a><code><span><span class="keyword">val</span> cement_commitments : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>cement_commitments</code> cements the commitments that can be cemented, i.e. the commitments that are after the current last cemented commitment and which have <code>sc_rollup_challenge_period</code> levels on top of them since they were originally published. This is a no-op if the rollup node is not in the appropriate mode.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-execute_outbox"><a href="#val-execute_outbox" class="anchor"></a><code><span><span class="keyword">val</span> execute_outbox : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../octez-libs/Tezos_base/TzPervasives/index.html#type-tzresult">Tezos_base.TzPervasives.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>execute_outbox</code> execute pending outbox messages on L1.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Stop worker for publishing and cementing commitments.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-worker_status"><a href="#val-worker_status" class="anchor"></a><code><span><span class="keyword">val</span> worker_status : <span>unit <span class="arrow">&#45;&gt;</span></span> <span>[ `Running <span>| `Not_running</span> <span><span>| `Crashed</span> of exn</span> ]</span></span></code></div><div class="spec-doc"><p>Returns the status of the publisher worker.</p></div></div><h3 id="helper-module"><a href="#helper-module" class="anchor"></a>Helper module</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Helpers"><a href="#module-Helpers" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Helpers/index.html">Helpers</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
