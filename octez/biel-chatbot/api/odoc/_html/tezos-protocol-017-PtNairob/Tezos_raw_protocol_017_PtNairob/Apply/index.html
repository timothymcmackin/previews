<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Apply (tezos-protocol-017-PtNairob.Tezos_raw_protocol_017_PtNairob.Apply)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-protocol-017-PtNairob</a> &#x00BB; <a href="../index.html">Tezos_raw_protocol_017_PtNairob</a> &#x00BB; Apply</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_raw_protocol_017_PtNairob.Apply</span></code></h1><p>This module supports advancing the ledger state by applying <code>operation</code>s.</p><p>Each operation application takes and returns an <code>application_state</code>, representing the old and new state, respectively.</p><p>The <code>Main</code> module provides wrappers for the functionality in this module, satisfying the Protocol signature.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Internal_operation_replay"><a href="#extension-decl-Internal_operation_replay" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../Tezos_protocol_environment_017_PtNairob/Error_monad/index.html#type-error">Tezos_protocol_environment_017_PtNairob.Error_monad.error</a> += </span></code><ol><li id="extension-Internal_operation_replay" class="def variant extension anchored"><a href="#extension-Internal_operation_replay" class="anchor"></a><code><span>| </span><span><span class="extension">Internal_operation_replay</span> <span class="keyword">of</span> <a href="../Apply_internal_results/index.html#type-packed_internal_operation">Apply_internal_results.packed_internal_operation</a></span></code></li><li id="extension-Tx_rollup_feature_disabled" class="def variant extension anchored"><a href="#extension-Tx_rollup_feature_disabled" class="anchor"></a><code><span>| </span><span><span class="extension">Tx_rollup_feature_disabled</span></span></code></li><li id="extension-Tx_rollup_invalid_transaction_ticket_amount" class="def variant extension anchored"><a href="#extension-Tx_rollup_invalid_transaction_ticket_amount" class="anchor"></a><code><span>| </span><span><span class="extension">Tx_rollup_invalid_transaction_ticket_amount</span></span></code></li><li id="extension-Sc_rollup_feature_disabled" class="def variant extension anchored"><a href="#extension-Sc_rollup_feature_disabled" class="anchor"></a><code><span>| </span><span><span class="extension">Sc_rollup_feature_disabled</span></span></code></li><li id="extension-Empty_transaction" class="def variant extension anchored"><a href="#extension-Empty_transaction" class="anchor"></a><code><span>| </span><span><span class="extension">Empty_transaction</span> <span class="keyword">of</span> <a href="../Alpha_context/Contract/index.html#type-t">Alpha_context.Contract.t</a></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-mode"><a href="#type-mode" class="anchor"></a><code><span><span class="keyword">type</span> mode</span><span> = </span></code><ol><li id="type-mode.Application" class="def variant constructor anchored"><a href="#type-mode.Application" class="anchor"></a><code><span>| </span><span><span class="constructor">Application</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-mode.block_header" class="def record field anchored"><a href="#type-mode.block_header" class="anchor"></a><code><span>block_header : <a href="../Alpha_context/Block_header/index.html#type-t">Alpha_context.Block_header.t</a>;</span></code></li><li id="type-mode.fitness" class="def record field anchored"><a href="#type-mode.fitness" class="anchor"></a><code><span>fitness : <a href="../Alpha_context/Fitness/index.html#type-t">Alpha_context.Fitness.t</a>;</span></code></li><li id="type-mode.payload_producer" class="def record field anchored"><a href="#type-mode.payload_producer" class="anchor"></a><code><span>payload_producer : <a href="../Alpha_context/Consensus_key/index.html#type-t">Alpha_context.Consensus_key.t</a>;</span></code></li><li id="type-mode.block_producer" class="def record field anchored"><a href="#type-mode.block_producer" class="anchor"></a><code><span>block_producer : <a href="../Alpha_context/Consensus_key/index.html#type-t">Alpha_context.Consensus_key.t</a>;</span></code></li><li id="type-mode.predecessor_level" class="def record field anchored"><a href="#type-mode.predecessor_level" class="anchor"></a><code><span>predecessor_level : <a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a>;</span></code></li><li id="type-mode.predecessor_round" class="def record field anchored"><a href="#type-mode.predecessor_round" class="anchor"></a><code><span>predecessor_round : <a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-mode.Full_construction" class="def variant constructor anchored"><a href="#type-mode.Full_construction" class="anchor"></a><code><span>| </span><span><span class="constructor">Full_construction</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-mode.block_data_contents" class="def record field anchored"><a href="#type-mode.block_data_contents" class="anchor"></a><code><span>block_data_contents : <a href="../Alpha_context/Block_header/index.html#type-contents">Alpha_context.Block_header.contents</a>;</span></code></li><li id="type-mode.predecessor_hash" class="def record field anchored"><a href="#type-mode.predecessor_hash" class="anchor"></a><code><span>predecessor_hash : <a href="../../Tezos_protocol_environment_017_PtNairob/Block_hash/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Block_hash.t</a>;</span></code></li><li id="type-mode.payload_producer" class="def record field anchored"><a href="#type-mode.payload_producer" class="anchor"></a><code><span>payload_producer : <a href="../Alpha_context/Consensus_key/index.html#type-t">Alpha_context.Consensus_key.t</a>;</span></code></li><li id="type-mode.block_producer" class="def record field anchored"><a href="#type-mode.block_producer" class="anchor"></a><code><span>block_producer : <a href="../Alpha_context/Consensus_key/index.html#type-t">Alpha_context.Consensus_key.t</a>;</span></code></li><li id="type-mode.round" class="def record field anchored"><a href="#type-mode.round" class="anchor"></a><code><span>round : <a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a>;</span></code></li><li id="type-mode.predecessor_level" class="def record field anchored"><a href="#type-mode.predecessor_level" class="anchor"></a><code><span>predecessor_level : <a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a>;</span></code></li><li id="type-mode.predecessor_round" class="def record field anchored"><a href="#type-mode.predecessor_round" class="anchor"></a><code><span>predecessor_round : <a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a>;</span></code></li></ol><code><span>}</span></code></li><li id="type-mode.Partial_construction" class="def variant constructor anchored"><a href="#type-mode.Partial_construction" class="anchor"></a><code><span>| </span><span><span class="constructor">Partial_construction</span> <span class="keyword">of</span> </span><span>{</span></code><ol><li id="type-mode.predecessor_fitness" class="def record field anchored"><a href="#type-mode.predecessor_fitness" class="anchor"></a><code><span>predecessor_fitness : <a href="../Alpha_context/Fitness/index.html#type-raw">Alpha_context.Fitness.raw</a>;</span></code></li></ol><code><span>}</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>This mode is mainly intended to be used by a mempool.</p><span class="comment-delim">*)</span></div></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-application_state"><a href="#type-application_state" class="anchor"></a><code><span><span class="keyword">type</span> application_state</span><span> = </span><span>{</span></code><ol><li id="type-application_state.ctxt" class="def record field anchored"><a href="#type-application_state.ctxt" class="anchor"></a><code><span>ctxt : <a href="../Alpha_context/index.html#type-context">Alpha_context.context</a>;</span></code></li><li id="type-application_state.chain_id" class="def record field anchored"><a href="#type-application_state.chain_id" class="anchor"></a><code><span>chain_id : <a href="../../Tezos_protocol_environment_017_PtNairob/Chain_id/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Chain_id.t</a>;</span></code></li><li id="type-application_state.mode" class="def record field anchored"><a href="#type-application_state.mode" class="anchor"></a><code><span>mode : <a href="#type-mode">mode</a>;</span></code></li><li id="type-application_state.op_count" class="def record field anchored"><a href="#type-application_state.op_count" class="anchor"></a><code><span>op_count : int;</span></code></li><li id="type-application_state.migration_balance_updates" class="def record field anchored"><a href="#type-application_state.migration_balance_updates" class="anchor"></a><code><span>migration_balance_updates : <a href="../Alpha_context/Receipt/index.html#type-balance_updates">Alpha_context.Receipt.balance_updates</a>;</span></code></li><li id="type-application_state.liquidity_baking_toggle_ema" class="def record field anchored"><a href="#type-application_state.liquidity_baking_toggle_ema" class="anchor"></a><code><span>liquidity_baking_toggle_ema : <a href="../Alpha_context/Liquidity_baking/Toggle_EMA/index.html#type-t">Alpha_context.Liquidity_baking.Toggle_EMA.t</a>;</span></code></li><li id="type-application_state.implicit_operations_results" class="def record field anchored"><a href="#type-application_state.implicit_operations_results" class="anchor"></a><code><span>implicit_operations_results : <span><a href="../Apply_results/index.html#type-packed_successful_manager_operation_result">Apply_results.packed_successful_manager_operation_result</a>
                                list</span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_application"><a href="#val-begin_application" class="anchor"></a><code><span><span class="keyword">val</span> begin_application : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_017_PtNairob/Chain_id/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">migration_balance_updates</span>:<a href="../Alpha_context/Receipt/index.html#type-balance_updates">Alpha_context.Receipt.balance_updates</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">migration_operation_results</span>:<span><a href="../Alpha_context/Migration/index.html#type-origination_result">Alpha_context.Migration.origination_result</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_fitness</span>:<a href="../Alpha_context/Fitness/index.html#type-raw">Alpha_context.Fitness.raw</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Block_header/index.html#type-t">Alpha_context.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-application_state">application_state</a>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_017_PtNairob.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Lwt/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialize an <a href="#type-application_state"><code>application_state</code></a> for the application of an existing block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_full_construction"><a href="#val-begin_full_construction" class="anchor"></a><code><span><span class="keyword">val</span> begin_full_construction : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_017_PtNairob/Chain_id/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">migration_balance_updates</span>:<a href="../Alpha_context/Receipt/index.html#type-balance_updates">Alpha_context.Receipt.balance_updates</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">migration_operation_results</span>:<span><a href="../Alpha_context/Migration/index.html#type-origination_result">Alpha_context.Migration.origination_result</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_timestamp</span>:<a href="../../Tezos_protocol_environment_017_PtNairob/Time/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_level</span>:<a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_round</span>:<a href="../Alpha_context/Round/index.html#type-t">Alpha_context.Round.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_hash</span>:<a href="../../Tezos_protocol_environment_017_PtNairob/Block_hash/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timestamp</span>:<a href="../../Tezos_protocol_environment_017_PtNairob/Time/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Time.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/Block_header/index.html#type-contents">Alpha_context.Block_header.contents</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-application_state">application_state</a>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_017_PtNairob.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Lwt/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialize an <a href="#type-application_state"><code>application_state</code></a> for the construction of a fresh block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-begin_partial_construction"><a href="#val-begin_partial_construction" class="anchor"></a><code><span><span class="keyword">val</span> begin_partial_construction : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_017_PtNairob/Chain_id/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">migration_balance_updates</span>:<a href="../Alpha_context/Receipt/index.html#type-balance_updates">Alpha_context.Receipt.balance_updates</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">migration_operation_results</span>:<span><a href="../Alpha_context/Migration/index.html#type-origination_result">Alpha_context.Migration.origination_result</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_hash</span>:<a href="../../Tezos_protocol_environment_017_PtNairob/Block_hash/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">predecessor_fitness</span>:<a href="../Alpha_context/Fitness/index.html#type-raw">Alpha_context.Fitness.raw</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="#type-application_state">application_state</a>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_017_PtNairob.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Lwt/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Initialize an <a href="#type-application_state"><code>application_state</code></a> for the partial construction of a block. This is similar to construction but less information is required as this will not yield a final valid block.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-apply_operation"><a href="#val-apply_operation" class="anchor"></a><code><span><span class="keyword">val</span> apply_operation : 
  <span><a href="#type-application_state">application_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_017_PtNairob/Operation_hash/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Operation_hash.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Alpha_context/index.html#type-packed_operation">Alpha_context.packed_operation</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="#type-application_state">application_state</a> * <a href="../Apply_results/index.html#type-packed_operation_metadata">Apply_results.packed_operation_metadata</a>)</span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_017_PtNairob.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Lwt/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Apply an operation, i.e. update the given context in accordance with the operation's semantic (or return an error if the operation is not applicable).</p><p>For non-manager operations, the application of a validated operation should always fully succeed.</p><p>For manager operations, the application has two stages. The first stage consists in updating the context to:</p><ul><li>take the fees;</li></ul><ul><li>increment the account's counter;</li></ul><ul><li>decrease of the available block gas by operation's <code>gas_limit</code>.</li></ul><p>These updates are mandatory. In particular, taking the fees is critically important. The <a href="../Validate/index.html"><code>Validate</code></a> module is responsible for ensuring that the operation is solvable, i.e. that fees can be taken, i.e. that the first stage of manager operation application cannot fail. If this stage fails nevertheless, the function returns an error.</p><p>The second stage of this function (still in the case of a manager operation) consists in applying all the other effects, in accordance with the semantic of the operation's kind.</p><p>An error may happen during this second phase: in that case, the function returns the context obtained at the end of the first stage, and metadata that contain the error. This means that the operation has no other effects than those described above during the first phase.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_block"><a href="#val-finalize_block" class="anchor"></a><code><span><span class="keyword">val</span> finalize_block : 
  <span><a href="#type-application_state">application_state</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../Alpha_context/Block_header/index.html#type-shell_header">Alpha_context.Block_header.shell_header</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../../Tezos_protocol_environment_017_PtNairob/Updater/index.html#type-validation_result">Tezos_protocol_environment_017_PtNairob.Updater.validation_result</a>
   * <a href="../Apply_results/index.html#type-block_metadata">Apply_results.block_metadata</a>)</span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_017_PtNairob.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Lwt/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Finalize the application of a block depending on its mode.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-value_of_key"><a href="#val-value_of_key" class="anchor"></a><code><span><span class="keyword">val</span> value_of_key : 
  <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Tezos_protocol_environment_017_PtNairob/Context/Cache/index.html#type-key">Tezos_protocol_environment_017_PtNairob.Context.Cache.key</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../Tezos_protocol_environment_017_PtNairob/Context/Cache/index.html#type-value">Tezos_protocol_environment_017_PtNairob.Context.Cache.value</a>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Error_monad/index.html#type-tzresult">Tezos_protocol_environment_017_PtNairob.Error_monad.tzresult</a></span>
    <a href="../../Tezos_protocol_environment_017_PtNairob/Lwt/index.html#type-t">Tezos_protocol_environment_017_PtNairob.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>value_of_key ctxt k</code> builds a value identified by key <code>k</code> so that it can be put into the cache.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Internal_for_benchmark"><a href="#module-Internal_for_benchmark" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Internal_for_benchmark/index.html">Internal_for_benchmark</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
