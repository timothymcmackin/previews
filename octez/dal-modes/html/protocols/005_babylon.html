
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Protocol Babylon &#8212; Octez &amp; Protocol products documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=af8f7b00" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=d85e297f"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KT3Z3X4Y82"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'protocols/005_babylon';</script>
    <script src="../_static/js/custom.js?v=e7f469e6"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Protocol Athens" href="004_Pt24m4xi.html" />
    <link rel="prev" title="Protocol Carthage" href="006_carthage.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="Octez & Protocol products documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.svg" class="logo__image only-dark" alt="Octez & Protocol products documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/tezos.html">Octez &amp; Protocol overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction/howtoget.html">Installing Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/get_troubleshooting.html">Installation troubleshooting</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtouse.html">Getting started with Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtorun.html">Running Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/versioning.html">Octez &amp; Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/breaking_changes.html">BREAKING CHANGES</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez User manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-client.html">Setting up the client</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/client-configuration.html">Client Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/key-management.html">Key Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sandbox.html">Sandboxed mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/mockup.html">Mockup mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy.html">Proxy mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/light.html">Light mode</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-node.html">Setting up the node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/node-configuration.html">Node Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/multinetwork.html">Connecting to a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/history_modes.html">History modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/snapshots.html">Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy-server.html">Proxy server</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../user/node-monitoring.html">Monitoring an Octez Node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/openmetrics.html">Supported Open Metrics</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../user/multisig.html">Built-in multisig contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/fa12.html">FA1.2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/logging.html">Logging features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/exits.html">Exit codes and signals</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez Reference manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../shell/the_big_picture.html">Octez Software Architecture</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/shell.html">The Octez Shell</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/validation.html">The validation subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/prevalidation.html">The Prevalidator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/storage.html">The storage layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/sync.html">Synchronisation heuristic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/p2p.html">The peer-to-peer layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/protocol_environment.html">Protocol Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/micheline.html">Micheline</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/data_availability_committees.html">Data Availability Committees</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/dal.html">Data Availability Layer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_overview.html">DAL overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_node.html">The DAL node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_bakers.html">Bakers &amp; the DAL</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/smart_rollup_node.html">Smart rollup node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/p2p_api.html">P2P message format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/rpc.html">Shell RPCs - Reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Protocol Reference Manuals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../active/index.html">Paris Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../active/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../active/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_issuance.html">Adaptive Issuance and Staking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../active/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/rpc.html">Paris RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../beta/index.html">Beta Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../beta/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../beta/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../beta/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../beta/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../beta/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../beta/rpc.html">Beta RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../alpha/index.html">Alpha Dev Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../alpha/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../alpha/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/rpc.html">Alpha RPCs - Reference</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tezos developer Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../developer/rpc.html">JSON/RPC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/errors.html">RPC Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/openapi.html">RPCs - OpenAPI reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in Octez releases</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../releases/releases.html">Release System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/version-20.html">Version 20.2</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../releases/history.html">Older Versions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-19.html">Version 19.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-18.html">Version 18.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-17.html">Version 17.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-16.html">Version 16.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-15.html">Version 15.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-14.html">Version 14.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-13.html">Version 13.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-12.html">Version 12.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-11.html">Version 11.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-10.html">Version 10.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-9.html">Version 9.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-8.html">Version 8.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-7.html">Version 7.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/january-2020.html">Mainnet January 2020</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/december-2019.html">Mainnet December 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/october-2019.html">Mainnet-Staging October 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/september-2019.html">Mainnet September 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/may-2019.html">Mainnet May 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/april-2019.html">Mainnet April 2019</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in protocol versions</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="naming.html">Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="019_paris.html">Protocol Paris</a></li>
<li class="toctree-l1"><a class="reference internal" href="beta.html">Protocol Beta</a></li>
<li class="toctree-l1"><a class="reference internal" href="alpha.html">Protocol Alpha</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="history.html">Older Protocols</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="018_oxford.html">Protocol Oxford</a></li>
<li class="toctree-l2"><a class="reference internal" href="017_nairobi.html">Protocol Nairobi</a></li>
<li class="toctree-l2"><a class="reference internal" href="016_mumbai.html">Protocol Mumbai</a></li>
<li class="toctree-l2"><a class="reference internal" href="015_lima.html">Protocol Lima</a></li>
<li class="toctree-l2"><a class="reference internal" href="014_kathmandu.html">Protocol Kathmandu</a></li>
<li class="toctree-l2"><a class="reference internal" href="013_jakarta.html">Protocol Jakarta</a></li>
<li class="toctree-l2"><a class="reference internal" href="012_ithaca.html">Protocol Ithaca</a></li>
<li class="toctree-l2"><a class="reference internal" href="011_hangzhou.html">Protocol Hangzhou</a></li>
<li class="toctree-l2"><a class="reference internal" href="010_granada.html">Protocol Granada</a></li>
<li class="toctree-l2"><a class="reference internal" href="009_florence.html">Protocol Florence</a></li>
<li class="toctree-l2"><a class="reference internal" href="008_edo.html">Protocol Edo</a></li>
<li class="toctree-l2"><a class="reference internal" href="007_delphi.html">Protocol Delphi</a></li>
<li class="toctree-l2"><a class="reference internal" href="006_carthage.html">Protocol Carthage</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Protocol Babylon</a></li>
<li class="toctree-l2"><a class="reference internal" href="004_Pt24m4xi.html">Protocol Athens</a></li>
<li class="toctree-l2"><a class="reference internal" href="003_PsddFKi3.html">Protocol 003_PsddFKi3</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/contributing_index.html">How to contribute</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/contributing.html">How to contribute to Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/contributing-adding-a-new-opam-dependency.html">How to add or update opam dependencies</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merge_team.html">Octez Merge Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/guidelines.html">Documentation and coding guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/repository_scope.html">Scope of the Octez repository</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/programming.html">Programming tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/gadt.html">Generalized Algebraic Data Types (GADTs)</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/error_monad.html">The Error Monad</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p1_result.html">Part 1: <code class="docutils literal notranslate"><span class="pre">result</span></code>, Lwt, and Lwt-<code class="docutils literal notranslate"><span class="pre">result</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p2_tzresult.html">Part 2: <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> and Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p3_advanced.html">Part 3: Advanced topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/error_monad_p4_appendices.html">Part 4: Appendices</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/clic.html">The <code class="docutils literal notranslate"><span class="pre">clic</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/data_encoding.html">The <code class="docutils literal notranslate"><span class="pre">data_encoding</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/event_logging_framework.html">Using The Event Logging Framework</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/testing_index.html">Testing in Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/testing.html">Overview of Testing in Octez</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/ppx_expect.html">Ppx_expect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/tezt.html">Tezt: OCaml Tezos Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/long-tezts.html">Tezt: Long Tests and Performance Regression Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/alcotezt.html">Alcotezt: An Alcotest Compatibility Wrapper for Tezt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/unit_testing_legacy_code.html">Making legacy code unit-testable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/proposal_testing.html">How to Test a Protocol Proposal</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/maintaining.html">Maintaining</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/entering_alpha.html">How to start reading protocol Alpha</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/michelson_instructions.html">Adding a new instruction to Michelson language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/protocol_release_checklist.html">Protocol Release Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/howto-freeze-protocols.html">How to Freeze Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/protocol_environment_upgrade.html">Adding a new protocol environment</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Documenting</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/tools.html">Platform Development tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/profiling.html">Profiling the Octez node</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../developer/snoop.html">Benchmarking with Snoop</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_arch.html">Architecture of <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_tutorial.html">Snoop usage tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_example.html">In-depth usage example: more control over your benchmark</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/tezos_micheline_rewriting.html">Rewriting Micheline with <code class="docutils literal notranslate"><span class="pre">tezos-micheline-rewriting</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer/snoop_interpreter.html">Snoop and the Michelson Interpreter</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/time_measurement_ppx.html">Time measurement PPX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/python_environment.html">Python Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/pre_commit_hook.html">Pre-Commit Hook</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/encodings.html">Encodings</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developer/merkle-proof-encoding-formats.html">Merkle Proof Encoding Formats</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v1-tree32.html">V1 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v1-tree2.html">V1 for Tree2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v2-tree32.html">V2 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer/merkle-proof-formats/v2-tree2.html">V2 for Tree2</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api-inline.html">OCaml APIs - Reference</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-gitlab"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-gitlab"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos/-/issues/new?issue[title]=Issue%20on%20page%20%2Fprotocols/005_babylon.html&issue[description]=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Protocol Babylon</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#emmy">Emmy+</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#michelson">Michelson</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#new-instructions-to-facilitate-compilation-to-michelson">New instructions to facilitate compilation to Michelson</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-for-compatibility-with-the-accounts-rehaul">Changes for compatibility with the accounts rehaul</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proposal-quorum">Proposal quorum</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quorum-caps">Quorum caps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-implicit-accounts-delegatable">Make implicit accounts delegatable</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replace-kt1-accounts-with-manager-tz-script">Replace KT1 accounts with <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code> script</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-to-rpcs">Changes to RPCs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequence-of-emmy">Consequence of <code class="docutils literal notranslate"><span class="pre">Emmy</span> <span class="pre">+</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequence-of-quorums">Consequence of <code class="docutils literal notranslate"><span class="pre">quorums</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequences-of-new-instructions-to-facilitate-compilation-to-michelson">Consequences of <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">instructions</span> <span class="pre">to</span> <span class="pre">facilitate</span> <span class="pre">compilation</span> <span class="pre">to</span> <span class="pre">Michelson</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequences-of-entry-point-introduction">Consequences of <code class="docutils literal notranslate"><span class="pre">Entry-point</span> <span class="pre">introduction</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequences-of-other-michelson-changes">Consequences of other <code class="docutils literal notranslate"><span class="pre">Michelson</span></code> changes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#manager-operations-are-incompatible">Manager operations are incompatible</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-to-the-binary-format-of-operations">Changes to the binary format of operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-source-field-of-manager-operations-is-now-a-public-key-hash">The <code class="docutils literal notranslate"><span class="pre">source</span></code> field of manager operations is now a public key hash</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transactions-now-have-an-entrypoint">Transactions now have an entrypoint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-fields-are-dropped-in-originations">Some fields are dropped in originations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-tags-of-all-manager-operations-are-shifted-by-100">The tags of all manager operations are shifted by <code class="docutils literal notranslate"><span class="pre">100</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#migration-from-scriptless-kt1s-to-manager-tz">Migration from scriptless KT1s to <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#origination-script-transformation">Origination script transformation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#template-add-do">Template <code class="docutils literal notranslate"><span class="pre">add_do</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#template-add-set-delegate">Template <code class="docutils literal notranslate"><span class="pre">add_set_delegate</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gas-cost-changes">Gas cost changes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bug-affecting-bigmaps-in-005-psbaby5h">Bug affecting Bigmaps in 005_PsBABY5H</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changelog">Changelog</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Emmy+</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Michelson</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#governance">Governance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#accounts-rehaul">Accounts rehaul</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#migration">Migration</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="protocol-babylon">
<h1><a class="toc-backref" href="#id7" role="doc-backlink">Protocol Babylon</a><a class="headerlink" href="#protocol-babylon" title="Link to this heading">#</a></h1>
<p><strong>Important: revision 005_PsBABY5H of protocol Babylon contains a bug that is corrected in the latest version 005_PsBabyM1</strong>
more details can be found in section <a class="reference internal" href="#bug-affecting-bigmaps-in-005-psbaby5h">Bug affecting Bigmaps in 005_PsBABY5H</a>.</p>
<p>This page contains all the relevant information for protocol 005 Babylon (005_PsBabyM1).
Each of the main changes is briefly described with links to relevant
external documentation and merge requests.
There are two sections dedicated to all the changes to RPCs and
operations.
The changelog section contains the most significant commit messages
and instructions to regenerate the protocol sources from the
Gitlab branch.</p>
<p><strong>This protocol contains several breaking changes with respect to Athens.</strong>
Developers are particularly encouraged to carefully read this page and
to monitor it for updates.</p>
<p>More documentation concerning Emmy+ and Michelson is available <a class="reference internal" href="../index.html"><span class="doc">here</span></a>.</p>
<nav class="contents" id="summary-of-changes">
<p class="topic-title">Summary of changes</p>
<ul class="simple">
<li><p><a class="reference internal" href="#protocol-babylon" id="id7">Protocol Babylon</a></p>
<ul>
<li><p><a class="reference internal" href="#emmy" id="id8">Emmy+</a></p></li>
<li><p><a class="reference internal" href="#michelson" id="id9">Michelson</a></p>
<ul>
<li><p><a class="reference internal" href="#new-instructions-to-facilitate-compilation-to-michelson" id="id10">New instructions to facilitate compilation to Michelson</a></p></li>
<li><p><a class="reference internal" href="#changes-for-compatibility-with-the-accounts-rehaul" id="id11">Changes for compatibility with the accounts rehaul</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#proposal-quorum" id="id12">Proposal quorum</a></p></li>
<li><p><a class="reference internal" href="#quorum-caps" id="id13">Quorum caps</a></p></li>
<li><p><a class="reference internal" href="#make-implicit-accounts-delegatable" id="id14">Make implicit accounts delegatable</a></p></li>
<li><p><a class="reference internal" href="#replace-kt1-accounts-with-manager-tz-script" id="id15">Replace KT1 accounts with <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code> script</a></p></li>
<li><p><a class="reference internal" href="#changes-to-rpcs" id="id16">Changes to RPCs</a></p>
<ul>
<li><p><a class="reference internal" href="#consequence-of-emmy" id="id17">Consequence of <code class="docutils literal notranslate"><span class="pre">Emmy</span> <span class="pre">+</span></code></a></p></li>
<li><p><a class="reference internal" href="#consequence-of-quorums" id="id18">Consequence of <code class="docutils literal notranslate"><span class="pre">quorums</span></code></a></p></li>
<li><p><a class="reference internal" href="#consequences-of-new-instructions-to-facilitate-compilation-to-michelson" id="id19">Consequences of <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">instructions</span> <span class="pre">to</span> <span class="pre">facilitate</span> <span class="pre">compilation</span> <span class="pre">to</span> <span class="pre">Michelson</span></code></a></p></li>
<li><p><a class="reference internal" href="#consequences-of-entry-point-introduction" id="id20">Consequences of <code class="docutils literal notranslate"><span class="pre">Entry-point</span> <span class="pre">introduction</span></code></a></p></li>
<li><p><a class="reference internal" href="#consequences-of-other-michelson-changes" id="id21">Consequences of other <code class="docutils literal notranslate"><span class="pre">Michelson</span></code> changes</a></p></li>
<li><p><a class="reference internal" href="#manager-operations-are-incompatible" id="id22">Manager operations are incompatible</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#changes-to-the-binary-format-of-operations" id="id23">Changes to the binary format of operations</a></p>
<ul>
<li><p><a class="reference internal" href="#the-source-field-of-manager-operations-is-now-a-public-key-hash" id="id24">The <code class="docutils literal notranslate"><span class="pre">source</span></code> field of manager operations is now a public key hash</a></p></li>
<li><p><a class="reference internal" href="#transactions-now-have-an-entrypoint" id="id25">Transactions now have an entrypoint</a></p></li>
<li><p><a class="reference internal" href="#some-fields-are-dropped-in-originations" id="id26">Some fields are dropped in originations</a></p></li>
<li><p><a class="reference internal" href="#the-tags-of-all-manager-operations-are-shifted-by-100" id="id27">The tags of all manager operations are shifted by <code class="docutils literal notranslate"><span class="pre">100</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#migration-from-scriptless-kt1s-to-manager-tz" id="id28">Migration from scriptless KT1s to <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#origination-script-transformation" id="id29">Origination script transformation</a></p>
<ul>
<li><p><a class="reference internal" href="#template-add-do" id="id30">Template <code class="docutils literal notranslate"><span class="pre">add_do</span></code></a></p></li>
<li><p><a class="reference internal" href="#template-add-set-delegate" id="id31">Template <code class="docutils literal notranslate"><span class="pre">add_set_delegate</span></code></a></p></li>
<li><p><a class="reference internal" href="#gas-cost-changes" id="id32">Gas cost changes</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#bug-affecting-bigmaps-in-005-psbaby5h" id="id33">Bug affecting Bigmaps in 005_PsBABY5H</a></p></li>
<li><p><a class="reference internal" href="#changelog" id="id34">Changelog</a></p>
<ul>
<li><p><a class="reference internal" href="#id5" id="id35">Emmy+</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id36">Michelson</a></p></li>
<li><p><a class="reference internal" href="#governance" id="id37">Governance</a></p></li>
<li><p><a class="reference internal" href="#accounts-rehaul" id="id38">Accounts rehaul</a></p></li>
<li><p><a class="reference internal" href="#migration" id="id39">Migration</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="emmy">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Emmy+</a><a class="headerlink" href="#emmy" title="Link to this heading">#</a></h2>
<p>Protocol 004 implements a consensus algorithm nick-named
<code class="docutils literal notranslate"><span class="pre">Emmy</span></code>.
Protocol 005 introduces several improvements to this algorithm,
regrouped under the name <code class="docutils literal notranslate"><span class="pre">Emmy+</span></code>.
In particular:</p>
<ul class="simple">
<li><p>the fewer endorsements a block carries the longer it takes before it
can be considered valid,</p></li>
<li><p>the fitness of a block is simply its height in the chain,</p></li>
<li><p>changes to the rewards for block and endorsement of priority greater
than 0.</p></li>
</ul>
<p>Detailed information can be found in the blog
<a class="reference external" href="https://research-development.nomadic-labs.com/emmy-an-improved-consensus-algorithm.html">announcement</a>
and
<a class="reference external" href="https://research-development.nomadic-labs.com/analysis-of-emmy.html">analysis.</a></p>
<p>Merge requests
<a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/58">(MR58)</a>
and
<a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/72">(MR72)</a></p>
</section>
<section id="michelson">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Michelson</a><a class="headerlink" href="#michelson" title="Link to this heading">#</a></h2>
<p>Protocol 005 contains several improvements to the Michelson smart
contract language.
More details are provided later in the changelog and in the
<a class="reference external" href="https://research-development.nomadic-labs.com/michelson-updates-in-005.html">Michelson update blog post.</a></p>
<p>A summary of the main changes:</p>
<ul class="simple">
<li><p>smart contracts now support entrypoints
<a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/59">(MR59)</a>,</p></li>
<li><p>contracts can now create, store and transmit as many big_maps as
they want
<a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/76">(MR76)</a>,</p></li>
<li><p>comparable types are now closed under products (i.e. the pair
constructor),</p></li>
<li><p>a new instruction, <code class="docutils literal notranslate"><span class="pre">CHAIN_ID</span></code>, allows contracts to differentiate
between the test chain and the main network
<a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/65">(MR65)</a>,</p></li>
<li><p>a gas cost overhaul has been integrated, and <code class="docutils literal notranslate"><span class="pre">STEPS_TO_QUOTA</span></code> has been
disabled until a more robust semantics is found
<a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/73">(MR73)</a>.</p></li>
</ul>
<section id="new-instructions-to-facilitate-compilation-to-michelson">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">New instructions to facilitate compilation to Michelson</a><a class="headerlink" href="#new-instructions-to-facilitate-compilation-to-michelson" title="Link to this heading">#</a></h3>
<p>Some new instructions have been added in order to make Michelson a
better compilation target for high level languages.</p>
<p>The new instructions <code class="docutils literal notranslate"><span class="pre">DIG</span> <span class="pre">n</span></code>, <code class="docutils literal notranslate"><span class="pre">DUG</span> <span class="pre">n</span></code>, <code class="docutils literal notranslate"><span class="pre">DIP</span> <span class="pre">n</span> <span class="pre">{</span> <span class="pre">code</span> <span class="pre">}</span></code>, <code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">n</span></code>
allow to simplify commonly used patterns <a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/81">(MR81).</a></p>
<p>The new instruction <code class="docutils literal notranslate"><span class="pre">APPLY</span></code> allows to perform the partial application of
an argument to a lambda <a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/46">(MR46).</a></p>
</section>
<section id="changes-for-compatibility-with-the-accounts-rehaul">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Changes for compatibility with the accounts rehaul</a><a class="headerlink" href="#changes-for-compatibility-with-the-accounts-rehaul" title="Link to this heading">#</a></h3>
<p>A few changes are needed as a consequence of the accounts simplification.</p>
<ul class="simple">
<li><p>the instruction <code class="docutils literal notranslate"><span class="pre">CREATE_ACCOUNT</span></code> disappears,</p></li>
<li><p>the type of <code class="docutils literal notranslate"><span class="pre">CREATE_CONTRACT</span></code> changes.</p></li>
</ul>
</section>
</section>
<section id="proposal-quorum">
<span id="id1"></span><h2><a class="toc-backref" href="#id12" role="doc-backlink">Proposal quorum</a><a class="headerlink" href="#proposal-quorum" title="Link to this heading">#</a></h2>
<p>During the first period of a voting procedure, proposals can be
submitted and the one with the largest number of upvotes is promoted
to the testing vote period.
In 004 the promoted proposal can have any number of upvotes, even 1,
as long as the others proposals, if any, have less.
Protocol 005 introduces a quorum of 5% (constant
<code class="docutils literal notranslate"><span class="pre">min_proposal_quorum</span></code>) for proposals to be promoted to the testing
vote period, if there is less than 5% of the stake supporting them,
the protocol goes back to a proposal period.</p>
<p><a class="reference external" href="https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-v-3e0ddfd98177">Cryptium’s blog post (proposal quorum).</a></p>
<p><a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/71">(MR71)</a></p>
</section>
<section id="quorum-caps">
<span id="id2"></span><h2><a class="toc-backref" href="#id13" role="doc-backlink">Quorum caps</a><a class="headerlink" href="#quorum-caps" title="Link to this heading">#</a></h2>
<p>During the test phases the participation needs to reach a quorum for a
vote to be successful.
The quorum adapt over time based on the participation of past votes.
In 004 the quorum can reach very high values which would make passing
new proposals very difficult even if there is large acceptance.
On the other hand the quorum could reach very low levels if there is
little participation.
Protocol 005 introduces caps to limit the maximum and minimum value
that the quorum can reach.
The values proposed for minimum quorum cap is set to 20% and the
maximum to 70%, these values can be changed in future updates.
Additionally the formula to update the quorum uses an exponential
moving average of the participation.</p>
<p><a class="reference external" href="https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-ii-607227fc6d65">Cryptium’s blog post (quorum caps).</a></p>
<p><a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/52">MR52.</a></p>
</section>
<section id="make-implicit-accounts-delegatable">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Make implicit accounts delegatable</a><a class="headerlink" href="#make-implicit-accounts-delegatable" title="Link to this heading">#</a></h2>
<p>In protocols 004 only KT1 addresses, representing an account for
delegation or a smart contract, can be delegated and only tz
can register as delegate.
In protocol 005, tz accounts which are not registered as
delegate can be delegated towards a tz account registered as delegate.
This change does not affect existing delegations of KT accounts.</p>
<p>One restriction remains that may be removed in the future: once a tz
account is registered as delegate it cannot be un-registered.
This in turn means that a registered delegate that wants to stop being
one, cannot delegate to somebody else.
The only solution for now is to move the funds to a newly created tz
account and delegate from there.</p>
<p>Cryptium’s blog posts
1. <a class="reference external" href="https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-iii-1c824b760da3">https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-iii-1c824b760da3</a>
2. <a class="reference external" href="https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-vi-540170f46c51">https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-vi-540170f46c51</a></p>
<p>Merge Request : <a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/61">MR61.</a></p>
</section>
<section id="replace-kt1-accounts-with-manager-tz-script">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Replace KT1 accounts with <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code> script</a><a class="headerlink" href="#replace-kt1-accounts-with-manager-tz-script" title="Link to this heading">#</a></h2>
<p>In 004 an address KT1 can refer to a scriptless account used for
delegation or to a smart contract with code.
Given that in 005 it is possible to delegate from tz accounts,
scriptless KT1 accounts are deprecated.
Existing KT1 accounts are replaced with a smart contract
<code class="docutils literal notranslate"><span class="pre">manager.tz</span></code> which implements the same semantics.
The smart contract has been formally verified in Mi-Cho-Coq.</p>
<p>While the migrated accounts preserves all their features, this will
change the way wallets and other applications interact with them.
Detailed instructions for migrating such applications will be provided
in the coming days.</p>
<p>Cryptium’s blog posts
1. <a class="reference external" href="https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-iii-1c824b760da3">https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-iii-1c824b760da3</a>
2. <a class="reference external" href="https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-vi-540170f46c51">https://medium.com/metastatedev/meanwhile-at-cryptium-labs-1-part-vi-540170f46c51</a></p>
<p><a class="reference external" href="https://gitlab.com/nomadic-labs/mi-cho-coq/blob/master/src/contracts/manager.tz">manager.tz script</a>
and
<a class="reference external" href="https://gitlab.com/nomadic-labs/mi-cho-coq/blob/master/src/contracts_coq/manager.v">proof</a>.</p>
<p>Merge requests
- <a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/66">(MR66)</a>
- <a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/merge_requests/74">(MR74)</a></p>
</section>
<section id="changes-to-rpcs">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Changes to RPCs</a><a class="headerlink" href="#changes-to-rpcs" title="Link to this heading">#</a></h2>
<p>This section lists the changes in RPCs to put the spotlight on them.
To stay readable, it cannot provide detailed recipes to adapt to every
one of them. Affected users can get the new formats by using the
command <code class="docutils literal notranslate"><span class="pre">tezos-client</span> <span class="pre">rpc</span> <span class="pre">list</span> <span class="pre">&lt;url&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">tezos-client</span> <span class="pre">rpc</span> <span class="pre">format</span>
<span class="pre">&lt;url&gt;</span></code>.</p>
<section id="consequence-of-emmy">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Consequence of <code class="docutils literal notranslate"><span class="pre">Emmy</span> <span class="pre">+</span></code></a><a class="headerlink" href="#consequence-of-emmy" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/constants</span></code> has
two new required fields “delay_per_missing_endorsement” and
“initial_endorsers”.</p></li>
<li><p>There are three new RPCs <code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/minimal_valid_time</span></code>, <code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/required_endorsements</span></code> and
<code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/endorsing_power</span></code>.</p></li>
</ul>
</section>
<section id="consequence-of-quorums">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Consequence of <code class="docutils literal notranslate"><span class="pre">quorums</span></code></a><a class="headerlink" href="#consequence-of-quorums" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/constants</span></code> has three
new required fields “min_proposal_quorum”, “quorum_max” and “quorum_min”.</p></li>
</ul>
</section>
<section id="consequences-of-new-instructions-to-facilitate-compilation-to-michelson">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Consequences of <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">instructions</span> <span class="pre">to</span> <span class="pre">facilitate</span> <span class="pre">compilation</span> <span class="pre">to</span> <span class="pre">Michelson</span></code></a><a class="headerlink" href="#consequences-of-new-instructions-to-facilitate-compilation-to-michelson" title="Link to this heading">#</a></h3>
<p>Inputs and outputs of</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/big_map_get</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/storage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/typecheck_data</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/typecheck_code</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/pack_data</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/forge/operations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/parse/operations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/preapply/operations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/preapply/block</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/run_code</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/run_operation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/trace_code</span></code></p></li>
</ul>
<p>are affected</p>
</section>
<section id="consequences-of-entry-point-introduction">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Consequences of <code class="docutils literal notranslate"><span class="pre">Entry-point</span> <span class="pre">introduction</span></code></a><a class="headerlink" href="#consequences-of-entry-point-introduction" title="Link to this heading">#</a></h3>
<p>New RPCs</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/entrypoints</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/entrypoints/&lt;string&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/entrypoint</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/entrypoints</span></code></p></li>
</ul>
</section>
<section id="consequences-of-other-michelson-changes">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Consequences of other <code class="docutils literal notranslate"><span class="pre">Michelson</span></code> changes</a><a class="headerlink" href="#consequences-of-other-michelson-changes" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Fields “manager” and “spendable” disappear in <code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;</span></code>
as well as the RPCs <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/manager</span></code>,
<code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/spendable</span></code>
and <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/delegatable</span></code></p></li>
<li><p>Output format of field “delegate” in <code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;</span></code>
and output of <code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;/manager_key</span></code>
are now public key hashes.</p></li>
<li><p>Field “counter” becomes optional in
<code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/contracts/&lt;contract_id&gt;</span></code></p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/delegates/&lt;pkh&gt;</span></code> and
<code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/context/delegates/&lt;pkh&gt;/delegated_contracts</span></code>,
field “Contract_hash” is replaced by “contract_id”.</p></li>
</ul>
</section>
<section id="manager-operations-are-incompatible">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Manager operations are incompatible</a><a class="headerlink" href="#manager-operations-are-incompatible" title="Link to this heading">#</a></h3>
<p>As a consequence, the following RPCs formats are intentionally changed to make explicit the modifications</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/forge/operations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/parse/operations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/preapply/operations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/preapply/block</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/run_code</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/run_operation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/chains/&lt;chain_id&gt;/blocks/&lt;block_id&gt;/helpers/scripts/trace_code</span></code></p></li>
</ul>
</section>
</section>
<section id="changes-to-the-binary-format-of-operations">
<h2><a class="toc-backref" href="#id23" role="doc-backlink">Changes to the binary format of operations</a><a class="headerlink" href="#changes-to-the-binary-format-of-operations" title="Link to this heading">#</a></h2>
<p>This section describes the changes in binary format for operations.
It is possible for readers to compile this list by themselves by
calling <code class="docutils literal notranslate"><span class="pre">describe</span> <span class="pre">unsigned</span> <span class="pre">operation</span></code> on the tezos client with both
protocols Athens and Babylon, and then use a diffing tool.</p>
<section id="the-source-field-of-manager-operations-is-now-a-public-key-hash">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">The <code class="docutils literal notranslate"><span class="pre">source</span></code> field of manager operations is now a public key hash</a><a class="headerlink" href="#the-source-field-of-manager-operations-is-now-a-public-key-hash" title="Link to this heading">#</a></h3>
<p>In Babylon, only tz1, tz2 and tz3 accounts can be the source of
manager operations (transaction, origination, delegation,
reveal). These operations currently contain a source contract, that is
a byte <code class="docutils literal notranslate"><span class="pre">0</span></code> followed by a public key hash for a tz1, tz2 or tz3, or a
byte <code class="docutils literal notranslate"><span class="pre">1</span></code> followed by a contract hash for a KT1. This first byte
disappears since the KT1 case is now impossible.</p>
</section>
<section id="transactions-now-have-an-entrypoint">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Transactions now have an entrypoint</a><a class="headerlink" href="#transactions-now-have-an-entrypoint" title="Link to this heading">#</a></h3>
<p>In Athens, the transaction operation ends in either a byte <code class="docutils literal notranslate"><span class="pre">0</span></code>,
equivalent to sending <code class="docutils literal notranslate"><span class="pre">Unit</span></code>, and sufficient for transaction to tz1,
tz2 or tz3 accounts, or a byte <code class="docutils literal notranslate"><span class="pre">1</span></code>, followed by the smart contract
parameter (four bytes of size followed by the serialized Michelson
data).</p>
<p>In Babylon, the transaction operation ends in either a byte <code class="docutils literal notranslate"><span class="pre">0</span></code>,
equivalent to sending <code class="docutils literal notranslate"><span class="pre">Unit</span></code> to entrypoint <code class="docutils literal notranslate"><span class="pre">%default</span></code>, and
sufficient for transaction to tz1, tz2 or tz3 accounts, or a byte
<code class="docutils literal notranslate"><span class="pre">1</span></code>, followed by the entrypoint, and then the smart contract
parameter (four bytes of size followed by the serialized Michelson
data).</p>
<p>The entrypoint format is as follows:</p>
<ul class="simple">
<li><p>one byte <code class="docutils literal notranslate"><span class="pre">0</span></code> for entrypoint <code class="docutils literal notranslate"><span class="pre">%default</span></code></p></li>
<li><p>one byte <code class="docutils literal notranslate"><span class="pre">1</span></code> for entrypoint <code class="docutils literal notranslate"><span class="pre">%root</span></code></p></li>
<li><p>one byte <code class="docutils literal notranslate"><span class="pre">2</span></code> for entrypoint <code class="docutils literal notranslate"><span class="pre">%do</span></code></p></li>
<li><p>one byte <code class="docutils literal notranslate"><span class="pre">3</span></code> for entrypoint <code class="docutils literal notranslate"><span class="pre">%set_delegate</span></code></p></li>
<li><p>one byte <code class="docutils literal notranslate"><span class="pre">4</span></code> for entrypoint <code class="docutils literal notranslate"><span class="pre">%remove_delegate</span></code></p></li>
<li><p>one byte <code class="docutils literal notranslate"><span class="pre">255</span></code> for a named entrypoint, then one byte of entrypoint
name size (limited to 31), and the name itself</p></li>
</ul>
<p>Bytes <code class="docutils literal notranslate"><span class="pre">5</span></code> to <code class="docutils literal notranslate"><span class="pre">254</span></code> are unused and may be used in future update to
optimize in size frequent calls to common entrypoints.</p>
</section>
<section id="some-fields-are-dropped-in-originations">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Some fields are dropped in originations</a><a class="headerlink" href="#some-fields-are-dropped-in-originations" title="Link to this heading">#</a></h3>
<p>In Babylon, smart contracts do not have a manager anymore, and must have a script.</p>
<p>The following field thus disappear:</p>
<ul class="simple">
<li><p>the manager public key (21 bytes),</p></li>
<li><p>the spendable flag (1 byte),</p></li>
<li><p>the delegatable flag (1 byte),</p></li>
<li><p>the presence flag before the script field (1 byte).</p></li>
</ul>
</section>
<section id="the-tags-of-all-manager-operations-are-shifted-by-100">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">The tags of all manager operations are shifted by <code class="docutils literal notranslate"><span class="pre">100</span></code></a><a class="headerlink" href="#the-tags-of-all-manager-operations-are-shifted-by-100" title="Link to this heading">#</a></h3>
<p>Because of the incompatibilities above, all manager operations see
their tags changed. The transaction format incompatibility between
Athens and Babylon is made explicit by this change.</p>
<ul class="simple">
<li><p>the reveal operation tag goes from <code class="docutils literal notranslate"><span class="pre">7</span></code> to <code class="docutils literal notranslate"><span class="pre">107</span></code>,</p></li>
<li><p>the transaction operation tag goes from <code class="docutils literal notranslate"><span class="pre">8</span></code> to <code class="docutils literal notranslate"><span class="pre">108</span></code>,</p></li>
<li><p>the origination operation tag goes from <code class="docutils literal notranslate"><span class="pre">9</span></code> to <code class="docutils literal notranslate"><span class="pre">109</span></code>,</p></li>
<li><p>the delegation operation tag goes from <code class="docutils literal notranslate"><span class="pre">10</span></code> to <code class="docutils literal notranslate"><span class="pre">110</span></code>.</p></li>
</ul>
<p>Developers who inject transactions in the chain must adapt to this new
tagging policy. The recommended procedure is to make a dynamic test,
and to produce a transaction in a format compatible with the
<code class="docutils literal notranslate"><span class="pre">next_protocol</span></code> announced by the head of the chain.</p>
<p>Transactions that are emitted in the last moments of Athens and that
do not get included in a block because of network latency will not
survive the migration to Babylon. They will have to be emitted again
in the new format.</p>
</section>
</section>
<section id="migration-from-scriptless-kt1s-to-manager-tz">
<h2><a class="toc-backref" href="#id28" role="doc-backlink">Migration from scriptless KT1s to <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code></a><a class="headerlink" href="#migration-from-scriptless-kt1s-to-manager-tz" title="Link to this heading">#</a></h2>
<p>This section explains how to interact with the manager.tz contract that all existing KT1 accounts
will have after the migration. Wallets can either urge their users to migrate to use implicit
accounts or can support implicit accounts as well as scriptful KT1s.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tezos-client</span></code> has been updated to be mostly backwards compatible, and the below explanations
are mostly directed at RPC users and the invocation of the <code class="docutils literal notranslate"><span class="pre">tezos-client</span></code> are given as
examples.</p>
<p>To set delegate using the manager.tz script, one can use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tezos-client<span class="w"> </span>transfer<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span>&lt;src&gt;<span class="w"> </span>to<span class="w"> </span>&lt;dst&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--entrypoint<span class="w"> </span><span class="s1">&#39;do&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--arg<span class="w"> </span><span class="s1">&#39;{ DROP ; NIL operation ; PUSH key_hash &quot;&lt;dlgt&gt;&quot; ; SOME ; SET_DELEGATE ; CONS }&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code>: has to be equal to the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> found in the contract’s storage,
i.e. its manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> is the originated contract</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dlgt</span></code> is the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> of the delegate</p></li>
</ul>
<p>To remove delegate, use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tezos-client<span class="w"> </span>transfer<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span>&lt;src&gt;<span class="w"> </span>to<span class="w"> </span>&lt;dst&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--entrypoint<span class="w"> </span><span class="s1">&#39;do&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--arg<span class="w"> </span><span class="s1">&#39;{ DROP ; NIL operation ; NONE key_hash ; SET_DELEGATE ; CONS }&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code>: has to be equal to the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> found in the contract’s storage,
i.e. its manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> is the originated contract</p></li>
</ul>
<p>To transfer (spend) tezos from originated contract to an implicit account, use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tezos-client<span class="w"> </span>transfer<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span>&lt;src&gt;<span class="w"> </span>to<span class="w"> </span>&lt;dst&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--entrypoint<span class="w"> </span><span class="s1">&#39;do&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--arg<span class="w"> </span><span class="s1">&#39;{ DROP ; NIL operation ; PUSH key_hash &quot;&lt;adr&gt;&quot; ; IMPLICIT_ACCOUNT ; PUSH mutez &lt;val&gt; ; UNIT ; TRANSFER_TOKENS ; CONS }&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code>: has to be equal to the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> found in the contract’s storage,
i.e. its manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code>: is the originated contract</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">adr</span></code>: key_hash of the implicit account receiving the tokens</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">val</span></code>: amount of mutez to transfer</p></li>
</ul>
<p>To transfer tezos from originated contract to another originated contract, use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tezos-client<span class="w"> </span>transfer<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span>&lt;src&gt;<span class="w"> </span>to<span class="w"> </span>&lt;dst&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--entrypoint<span class="w"> </span><span class="s1">&#39;do&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>--arg<span class="w"> </span><span class="s1">&#39;{ DROP ; NIL operation ; PUSH address &lt;adr&gt; ; CONTRACT %&lt;ent&gt; &lt;par&gt; ; ASSERT_SOME ; PUSH mutez &lt;val&gt; ; &lt;ppar&gt; ; TRANSFER_TOKENS ; CONS }&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code>: has to be equal to the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> found in the left part of the
contract’s storage <code class="docutils literal notranslate"><span class="pre">pair</span></code>, i.e. its manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code>: is the originated contract</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">adr</span></code>: addressee to receive the tokens</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ent</span></code>: addressee script’s entrypoint (omit if not used)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">par</span></code>: addressee script’s call parameter type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ppar</span></code>: instruction to push parameter value of call to addressee script</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">val</span></code>: amount of mutez to transfer</p></li>
</ul>
<section id="origination-script-transformation">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">Origination script transformation</a><a class="headerlink" href="#origination-script-transformation" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">spendable</span></code> and <code class="docutils literal notranslate"><span class="pre">delegatable</span></code> flags determine the template, if any:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>spendable</p></th>
<th class="head"><p>delegatable</p></th>
<th class="head"><p>template</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>true</p></td>
<td><p>true</p></td>
<td><p>add_do</p></td>
</tr>
<tr class="row-odd"><td><p>true</p></td>
<td><p>false</p></td>
<td><p>add_do</p></td>
</tr>
<tr class="row-even"><td><p>false</p></td>
<td><p>true</p></td>
<td><p>add_set_delegate</p></td>
</tr>
<tr class="row-odd"><td><p>false</p></td>
<td><p>false</p></td>
<td><p>none</p></td>
</tr>
</tbody>
</table>
</div>
<p>For a complete Michelson pseudo-code showing these transformations, together
with examples of these transformations applied to the <a class="reference external" href="https://gitlab.com/tezos/tezos/blob/794bc16664cbed4057ffbc51631151023af835c0/src/bin_client/test/contracts/attic/id.tz">id.tz script</a>,
please refer to this <a class="reference external" href="https://gitlab.com/nomadic-labs/mi-cho-coq/-/merge_requests/29">Mi-cho-coq merge request</a>.</p>
<p>For both <code class="docutils literal notranslate"><span class="pre">add_do</span></code> and <code class="docutils literal notranslate"><span class="pre">add_set_delegate</span></code> templates, the original script’s
storage gets wrapped in a <code class="docutils literal notranslate"><span class="pre">pair</span></code>, with the manager of the contract being written
into the left part of the pair. The right part of the storage is the original
storage value of the original storage type.</p>
<section id="template-add-do">
<h4><a class="toc-backref" href="#id30" role="doc-backlink">Template <code class="docutils literal notranslate"><span class="pre">add_do</span></code></a><a class="headerlink" href="#template-add-do" title="Link to this heading">#</a></h4>
<p>The original script’s parameter is wrapped in <code class="docutils literal notranslate"><span class="pre">or</span></code> type, with its left part
being the newly added parameter of type <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">unit</span> <span class="pre">(list</span> <span class="pre">operation)</span></code> and
entrypoint annotation <code class="docutils literal notranslate"><span class="pre">%do</span></code>. The right part of the parameter is the original
parameter of the original parameter type with added <code class="docutils literal notranslate"><span class="pre">%default</span></code> entrypoint
annotation.</p>
<p>To spend and set/remove delegate one can use the same calls as for the
[manager.tz script](#manager-tz-script).</p>
<p>There is no change to use original script functionality, as the original
parameter type is given <code class="docutils literal notranslate"><span class="pre">%default</span></code> entrypoint. Any argument you pass in
to the call will get automatically wrapped to match the <code class="docutils literal notranslate"><span class="pre">Right</span></code> part of the
transformed script’s parameter.</p>
</section>
<section id="template-add-set-delegate">
<h4><a class="toc-backref" href="#id31" role="doc-backlink">Template <code class="docutils literal notranslate"><span class="pre">add_set_delegate</span></code></a><a class="headerlink" href="#template-add-set-delegate" title="Link to this heading">#</a></h4>
<p>The original script’s parameter is wrapped in <code class="docutils literal notranslate"><span class="pre">or</span></code> type, with its left part
being the newly added parameter of type:</p>
<div class="highlight-michelson notranslate"><div class="highlight"><pre><span></span><span class="kt">or</span>
<span class="w">  </span><span class="p">(</span><span class="kt">key_hash</span><span class="w"> </span><span class="k k-Name">%set_delegate</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="kt">unit</span><span class="w"> </span><span class="k k-Name">%remove_delegate</span><span class="p">)</span>
</pre></div>
</div>
<p>with two entrypoints - <code class="docutils literal notranslate"><span class="pre">%set_delegate</span></code> and <code class="docutils literal notranslate"><span class="pre">%remove_delegate</span></code>. The right part of
the parameter is the original parameter of the original parameter type with
added <code class="docutils literal notranslate"><span class="pre">%default</span></code> entrypoint annotation.</p>
<p>To set delegate using the added entrypoint, one can use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tezos-client<span class="w"> </span>transfer<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span>&lt;src&gt;<span class="w"> </span>to<span class="w"> </span>&lt;dst&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>--entrypoint<span class="w"> </span><span class="s1">&#39;set_delegate&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">             </span>--arg<span class="w"> </span><span class="s1">&#39;&quot;&lt;dlgt&gt;&quot;&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code>: has to be equal to the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> found in the left part of the
contract’s storage <code class="docutils literal notranslate"><span class="pre">pair</span></code>, i.e. its manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> is the originated contract</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dlgt</span></code> is the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> of the delegate</p></li>
</ul>
<p>To remove delegate, use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tezos-client<span class="w"> </span>transfer<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span>&lt;src&gt;<span class="w"> </span>to<span class="w"> </span>&lt;dst&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">             </span>--entrypoint<span class="w"> </span><span class="s1">&#39;remove_delegate&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">             </span>--arg<span class="w"> </span><span class="s1">&#39;Unit&#39;</span><span class="w"> </span><span class="c1"># arg is optional, it defaults to Unit when omitted</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code>: has to be equal to the <code class="docutils literal notranslate"><span class="pre">key_hash</span></code> found in the left part of the
contract’s storage <code class="docutils literal notranslate"><span class="pre">pair</span></code>, i.e. its manager.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> is the originated contract</p></li>
</ul>
<p>Please note, that you are not allowed to transfer tokens on <code class="docutils literal notranslate"><span class="pre">%do</span></code>,
<code class="docutils literal notranslate"><span class="pre">%set_delegate</span></code>, or <code class="docutils literal notranslate"><span class="pre">%remove_delegate</span></code> entrypoints calls. Invoke these
entrypoints with <code class="docutils literal notranslate"><span class="pre">tezos-client</span> <span class="pre">transfer</span> <span class="pre">0</span></code>.</p>
</section>
<section id="gas-cost-changes">
<h4><a class="toc-backref" href="#id32" role="doc-backlink">Gas cost changes</a><a class="headerlink" href="#gas-cost-changes" title="Link to this heading">#</a></h4>
<p>The cost for managing the delegate of the <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code> script is 25817
gas to set the delegate and 25722 to withdraw the current delegation.</p>
<p>For other contracts with <code class="docutils literal notranslate"><span class="pre">%set_delegate</span></code> and
<code class="docutils literal notranslate"><span class="pre">remove_delegate</span></code>, it varies with the contract as the gas cost for
typechecking depends on the contract’s code.</p>
<p>The gas cost for each kind of transfer operation is as follow:</p>
<ul class="simple">
<li><p>implicit account (tz1|tz2|tz3…) → implicit account :  10207 gas</p></li>
<li><p>implicit account → originated manager.tz : 15285 gas</p></li>
<li><p>originated manager.tz → implicit account : 26183 gas</p></li>
<li><p>originated manager.tz → originated manager.tz : 44625 gas</p></li>
</ul>
</section>
</section>
</section>
<section id="bug-affecting-bigmaps-in-005-psbaby5h">
<span id="bigmap-bug"></span><h2><a class="toc-backref" href="#id33" role="doc-backlink">Bug affecting Bigmaps in 005_PsBABY5H</a><a class="headerlink" href="#bug-affecting-bigmaps-in-005-psbaby5h" title="Link to this heading">#</a></h2>
<p>Protocol 005_PsBABY5H contains a bug affecting Bigmaps.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">has_big_map</span></code> function used to compute whether or not a Michelson
type contains a <code class="docutils literal notranslate"><span class="pre">big_map</span></code> was wrongly implemented and always returned
<code class="docutils literal notranslate"><span class="pre">false</span></code>. This had the following consequences:</p>
<ul class="simple">
<li><p>For newly originated contracts, storing several <code class="docutils literal notranslate"><span class="pre">big_map</span></code>s and
operating on them is possible but regular maps are used under the
hood so the efficiency is much worse than expected. Sending a
<code class="docutils literal notranslate"><span class="pre">big_map</span></code> to another contract is not always possible.</p></li>
<li><p>For migrated contracts storing a <code class="docutils literal notranslate"><span class="pre">big_map</span></code>, updating the
stored <code class="docutils literal notranslate"><span class="pre">big_map</span></code> is not possible anymore; getting the stored values
is possible but less efficient than expected.</p></li>
</ul>
<p>Additionally there is also a small regression affecting the
<code class="docutils literal notranslate"><span class="pre">trace_code</span></code> RPC.
As a result, the tracing functionality of the interpreter was
disabled.</p>
<p>Both issues above are fixed in protocol 005_PsBabyM1.</p>
</section>
<section id="changelog">
<h2><a class="toc-backref" href="#id34" role="doc-backlink">Changelog</a><a class="headerlink" href="#changelog" title="Link to this heading">#</a></h2>
<p>You can see the full git history on the branch <a class="reference external" href="https://gitlab.com/nomadic-labs/tezos/-/commits/proto-005">proto-005</a>.
In order to regenerate a protocol with the same hash as Babylon you
can run from this branch:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./scripts/snapshot_alpha.sh babylon_005 from athens_004
$ ls src/proto_005_PsBabyM1
</pre></div>
</div>
<section id="id5">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">Emmy+</a><a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Baker: adapt baker code for Emmy+</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This is not a patch for the protocol.
It does not affect the hash, but is needed for the baker to work.

 - BREAKING CHANGE: remove the await_endorsement arg as it becomes mandatory.
 - Implement new heuristic to wait for endorsements
 - Adapt local validation to match the new validation semantics.
 - Fix &quot;bake for --minimal-timestamp&quot;.
 - Prevent the creation of block with a timestamp in the future unless --force is given.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: rewards depend on block priority</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

The baking reward is now calculated w.r.t a given priority [p] and a
number [e] of included endorsements as follows:

(block_reward / (p+1)) * (0.8 + 0.2 * e / endorsers_per_block)

Explorers or bakers that recompute the reward by themselves should
implement this new formula. Those who use the block receipts should be
fine.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: freeze endorsement deposits at operation application</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>In Athens and before, endorsement deposits where taken at the end of
the block validation, after the transactions, including transaction
from the endorsers&#39; accounts. This made things more difficult for the
baker, and led to a few mishaps in the past.

This patch changes that behaviour, so that endorsement deposits are
taken before transactions are evaluated.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: add RPCs to query the required endorsement constraints</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch adds the necessary RPCs to implement the baker for Emmy+.

Developers of analytics tools or explorers may also want to use these
new RPCs.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: add a minimum number of endorsements requirement, a.k.a Emmy+</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

A block is now valid only if its timestamp has a minimal delay with
respect to the previous block&#39;s timestamp, and this minimal delay
depends not only on the block&#39;s priority but also on the number of
endorsement operations included in the block.

In Emmy+, blocks&#39; fitness increases by one unit with each level.

In this way, Emmy+ simplifies the optimal baking strategy: The bakers
used to have to choose whether to wait for more endorsements to
include in their block, or to publish the block immediately, without
waiting. The incentive for including more endorsements was to increase
the fitness and win against unknown blocks. However, when a block was
produced too late in the priority period, there was the risk that the
block did not reach endorsers before the block of next priority. In
Emmy+, the baker does not need to take such a decision, because the
baker cannot publish a block too early.

Third party developers should make sure they can parse the new fields
in the `/constants` RPC, or at least ignore them.
</pre></div>
</div>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id36" role="doc-backlink">Michelson</a><a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Proto/Michelson: Deprecate instruction STEPS_TO_QUOTA</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The semantics of the STEPS_TO_QUOTA instruction changes each time the
gas constants are modified to better reflect the real costs.

Moreover, because of STEPS_TO_QUOTA, the interpreter is not monotonic:
it is easy to write a contract that runs successfully at some gas
amount but fails when more gas is given.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: expose internal function of the Michelson interpreter</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch is a refactor that does not change the semantics. It will
allow external tools such as steppers or debuggers to control more
finely the Michelson interpreter from outside the protocol.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: add <code class="docutils literal notranslate"><span class="pre">APPLY</span></code> instruction to partially apply a lambda</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This instruction applies a tuplified function from the stack.  Such a
lambda is storable, and thus values that cannot be stored (values of
type `operation`, `contract _` and `big_map _ _`) cannot be
captured by `APPLY` (cannot appear in `&#39;a`).
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: relax big_map restrictions</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>A contract can now have more than one big_map, they can be placed
anywhere in the storage. Big maps can be transferred from a contract
to another, either as parameter (transactions) or storage
(originations). In this case, they are morally duplicated (as opposed
to shared) from the contract point of view. In the implementation,
sharing happens. Big maps can be created with `EMPTY_BIG_MAP t` and
cleared on the fly.

The big_map type still cannot appear as argument of big_map, PUSH or
UNPACK. When you duplicate a big map, you are charged with the full
storage cost.

This patch moves the big maps outside of the contracts in the context,
in their own prefix path and indexed by integers. Big_map literals in
Michelson expressions are now either the same as maps or their integer
index.

A temporary zone is introduced, necessary to make sure that big_maps
are not spuriously cleared or left dangling during big_map transfers
in internal operations. These are represented by negative indexes, and
don&#39;t persist.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: new gas costs</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The cost functions in Michelson_v1_gas were to a large extent
automatically generated. Please refer to meta_model.ml

The (abstract) cost model makes large use of floating-point
coefficient. These were converted to either integer
multiplication/divisions or to statically generated fixed-point
computations.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: finer-grained cost accounting for the interpreter</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>I. Rescaling step cost
- Rescale step_cost by 2^7 to allow finer cost accounting in the
  interpreter.
- Expose new function atomic_step_cost exposing finer resolution step
  increments.

II. Provide facilities for interpreter-specific cost accounting

Introduce new functions `Gas.incr_interpreter_cost` and
`Gas.bill_interpreter_cost`.

- The context stores a new counter &#39;interpreter_cost&#39; of type
  Gas_limit_repr.cost
- functions are provided to:
  - increment this counter (incr_interpreter_cost) and
  - bill for the gas corresponding to this counter and reset this
  counter. Until bill_interpreter_cost is called, the interpreter_cost
  is _not_ taken into account into the effectively consumed gas.
- Each call to incr_interpreter_cost still checks that we are under
  the operation and block gas limits.
- The interpreter uses these functions instead of the usual
  Gas.consume.

The invariant that has to be respected for this to be transparent to
the rest of the protocol is that all continuations of the `step`
function to other functions should bill and reset the interpreter_cost
beforehand. This concerns calls to interp, calls to the typechecker,
calls to read from a big map, calls to the
serialization/deserialization  mechanism, etc; in short, all calls to
other parts of the protocol should have a context in a state where
this fine-grained gas bookkeeping has been settled and reset.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: add comparable_ty type witness in boxed sets</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Some cost functions require computing the size of keys/elts of
maps/sets. Not being able to dispatch on the element type was making
this impossible outside of the interpreter (where the element type of
the set could be accessed elsewhere). This patch fixes that.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: unshare cost functions of the interpreter &amp; the rest of the protocol</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch is a refactor to prepare for the gas costs rehaul. It
dissociates the gas consumed by the interpreter, which is the part
that is updated according to thorough benchmarking, from other source
of gas consumption in the protocol (typechecking, serialization etc.)
which are left untouched in this update.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: extend comparison to linear pair structures</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Michelson&#39;s `COMPARE` instruction can currently only compare simple
values (`string`\ s, `int`\ s, etc.). This limitation also applies to
`set`, `map` and `big_map` indexes.

This is an issue in particular for `big_map`\ s that cannot be nested,
because it prevents indexing data by a pair of indexes, such as a
`key_hash` and a `string`.

This patch lifts that restriction, allowing to compare `pair`\ s of
values, as long as their left component remains a simple value,
implicitly making comparable values right combs whose leaves are simple
values. The ordering is naturally lexicographic.

This patch also refactors a bit the comparison code to simplify it and
reduce code duplication.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: comparisons return -1, 0, or 1, as per the documentation</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The Michelson documentation states that `COMPARE` pushes -1 (resp. 1)
if the top element of the stack is smaller (resp. greater) than the
second. However, the implementation can actually push a negative
number instead of -1 and a positive number instead of 1 depending on
the type and values.

This semantics should not break any code as the result of `COMPARE` is
almost always consumed by comparison projectors such as `GT` or `LT`
who only care about the sign. However, for the sake of consistency,
this patches makes `COMPARE` return only -1, 0 or 1.

This fixes issue #546
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: add special encoding for <code class="docutils literal notranslate"><span class="pre">do</span></code> and <code class="docutils literal notranslate"><span class="pre">set/remove_delegate</span></code> entrypoints</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch optimises the binary representation of transactions to
usual entrypoints. The `do` entrypoint is used by manager.tz script
and the `set_delegate` and `remove_delegate` by spendable script
transformation.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: handle default entrypoint originated before migration</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch preserves the semantics of `CREATE_CONTRACT` instructions
for contracts deployed before the migration that deploy a contract
with a default entrypoint. This is done by adding a `%root` entrypoint
as detailed in a previous patch.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: Add CHAIN_ID and chain_id</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Add an abstract type and an instruction to obtain the chain id from
Michelson code.

This is to implement replay protection between the main chain and the
test chain spawned in phase 3 of the voting procedure.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: new instructions <code class="docutils literal notranslate"><span class="pre">DIG</span> <span class="pre">n</span></code>, <code class="docutils literal notranslate"><span class="pre">DUG</span> <span class="pre">n</span></code>, <code class="docutils literal notranslate"><span class="pre">DIP</span> <span class="pre">n</span> <span class="pre">{</span> <span class="pre">code</span> <span class="pre">}</span></code>, <code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">n</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> - `DIG n` : get the element at top of the n-th tail of the stack and move it to the top. `DIG 0` is a no-op.
 - `DUG n` : get the element at the top of the stack, and move it downwards n slots. `DUG 0` is a no-op.
 - `DIP n { code }` : execute code after removing the top n elements of the stack, and put these n elements back on top of the resulting stack. `DIP 0 { code }` is equivalent to `{ code }`.
 - `DROP n` : drop the top `n` elements of the stack. `DROP 0` is a no-op.

Smart contract authors should switch to these new instructions in
their developments.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: corrected error message for the contract type</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This is a minor fix for the Michelson typechecker to produce a better
error message on some ill-typed contracts.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: modify semantics of NOW instruction</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The `NOW` instruction now pushes the minimal injection time on the
stack for the current block/priority, instead of the actual timestamp
put in the block by the baker.

This is a change required by the switch to Emmy+, in which a baker
could decide after having forged a block to include a late endorsement
and update the timestamp to an earlier point. With the current
semantics of `NOW`, this would mean reevaluating all operations to
make sure they are still valid every time such a change is
decided. This patch prevents that issue by fixing the timestamp seen
by Michelson independently of the number of endorsements.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: annotation semantics fixes</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

Some instructions were missing consistency checks on the annotations
of their arguments. For instance, it was possible to `CONS` a value of
type `unit :A` on a `list (unit :B)`.

Smart contracts already deployed before the migration will continue to
work even if they present such issues.

However, smart contract authors should already make sure that their
annotations are consistent by using the new typechecker in a sandbox.
This is even more recommended for contracts deployed before the
migration that use the `CREATE_CONTRACT` instruction. If the code they
deploy is ill-annotated according to the new stricter rule, these
contracts will produce failing operations after the migration.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: do not allow annotations inside data anymore</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Some Michelson values could bear type annotations. These were
inconsistent and unspecified. Annotations inside data can now only
appear inside lambdas.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: option cannot bear field annotations anymore</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

Field annotations on `option` types were inconsistent with other field
annotations on other types, interfering with field annotations on
their parent type, and the implementation was buggy.

Smart contract authors should stop putting field annotations on their
option types, or their contract will not be deployable after the
migration. It is enough to erase the annotations.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: add services to list entrypoints</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch adds four new URIs.

 - `/helpers/entrypoint_type`
 - `/helpers/list_entrypoints`
 - `/contracts/index/&lt;KT1&gt;/entrypoints/`
 - `/contracts/index/&lt;KT1&gt;/entrypoints/&lt;name&gt;`
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: add lightweight multiple entrypoints</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

This patch implements a way for a transaction to target a specific
code path of a smart contract using a name. The implementation is
piggy baking on Michelson&#39;s or type and field annotations.

To take advantage of the multiple entrypoint feature, the parameter
type of a contract must have at its toplevel a tree of `or` types. At
each branching point in this tree, a field annotation (the ones with a
%) can appear, providing the name of the entrypoint.

Transactions now have to specify an entrypoint name. When a
transaction is executed, the appropriate `Left` and `Right`
constructors are automatically added to the value that is pushed onto
the input stack, depending on the position of the entrypoint in the
parameter type tree.

This way, two contracts who share an entrypoint of the same type under
the same name can be called exactly the same, even if the entrypoint
is placed at a different point in their parameter type tree. From
inside the smart contract, nothing changes.

From within Michelson, this feature is also available. The `contract
t` type now points to a specific entrypoint (of type `t`) of the
contract. For this, the `CONTRACT` and `SELF` instructions now take an
optional annotation (set to `%default` if not passed). The
`TRANSFER_TOKEN` instruction will then use the entrypoint from the
`contract t` value that it consumes from the stack.

An exception to the semantics is made for the `%default` entrypoint :
if present in the contract, it behaves as any other, however if not
present, default is automatically attributed to the root of the
parameter type.

A special check is made at origination that there is no two
entrypoints with the same name, and that if a default is present
somewhere, then all entrypoints must be named, as otherwise some parts
of the code would be unreachable.

Smart contract developers can already use the feature, and their
contracts will automatically take advantage of entrypoints after the
migration.

Smart contract developers should take great care when deploying
contracts that use the `CREATE_CONTRACT` instruction, as this
instruction will produce a failing operation after the migration if it
tries to deploy a contract with ill formed entrypoints. To prevent
this, contract authors should test their contract in a sandbox with
the new protocol, or simply avoid hardcoding the `CREATE_CONTRACT`
instruction when possible.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: disable storing values of type <code class="docutils literal notranslate"><span class="pre">contract</span> <span class="pre">t</span></code> in newly originated contracts</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

In Athens and before, Michelson contracts could store typed handles to
contracts in their storage or in constants in the code. This meant
that typechecking a contract required accessing other contracts from
the chain context. This extra type safety was not worth the
engineering cost for tooling and high level languages. Contracts will
now have to store values of type `address` and use the `CONTRACT`
instruction to typecheck contract references on demand.

All existing contracts that used the feature will continue to work
as-is. This is done by introducing a `legacy` flag throughout the
typechecking code, with the following trivial semantics:
 - everything already in the chain is considered `legacy` and can
   use deprecated features,
 - everything added to the chain (parameters of transactions and code
   and storage of originations cannot.

Smart contract developers should adapt their code to store `address`\ es
and use instruction `CONTRACT`.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: eliminate useless storage read for parse_contract</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch removes a spurious access to the storage when typechecking a
contract reference. It makes this operation cheaper in gas.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Michelson: peephole optimization of UNPAIR</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This makes the often used `UNPAIR` macro cheaper in terms of gas.
</pre></div>
</div>
</section>
<section id="governance">
<h3><a class="toc-backref" href="#id37" role="doc-backlink">Governance</a><a class="headerlink" href="#governance" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Proto: Require 5% minimum quorum of protocol proposal</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

The protocol will now remain in the initial proposal voting phase
until a protocol gets upvoted by at least 5% of the stake.

Third party developers should make sure they can parse the new fields
in the `/constants` RPC, or at least ignore them.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: participation EMA and min/max quorum caps</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

Change the formula from quorum update on vote period to participation
EMA (exponential moving average). Current quorum storage is removed
and new storage participation EMA is introduced.

Minimum and maximum quorum caps are added to the constants of the
economic protocol. Whenever a voting period would cause the quorum to
go below or above the caps it will be bound to the limit defined in
the constants.

In the future token holders can easily modify the caps by changing the
constants.

Third party developers should make sure they can parse the new fields
in the `/constants` RPC, or at least ignore them.
</pre></div>
</div>
</section>
<section id="accounts-rehaul">
<h3><a class="toc-backref" href="#id38" role="doc-backlink">Accounts rehaul</a><a class="headerlink" href="#accounts-rehaul" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Proto: all KT1s must now be scripted</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains BREAKING CHANGES (see end of message).

It removes the manager, spendable and delegatable flags and counter from all KT1s.

It deprecates CREATE_ACCOUNT from use in new contracts, as well as the
manager, spendable and delegatable arguments from CREATE_CONTRACT.

Already deployed contracts with deprecated instructions will continue
to work by using legacy support scripts (deploying `manager.tz` for
`CREATE_ACCOUNT` and adding entrypoints for `CREATE_CONTRACT`).

This change will impact all users of the RPC API as well as anyone who
forges operations. The source of manager operations is now a tz1, tz2
or tz3, and no longer a KT1. The manager field and the spendable and
delegatable flags disappear from the origination operation format
(JSON and binary) as well as everywhere in the RPC API.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: add code stubs to handle <code class="docutils literal notranslate"><span class="pre">%default</span></code> entrypoints originated before migration</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This code stub adds a `%root` entrypoint to contracts that have a
default entrypoint, and rewrite their calls to `SELF` into `SELF
%root`. This is used to preserve the typing of `SELF` within contracts
with deployed before the migration that have a `%default` entrypoint.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: add Michelson code stubs to replicate manager operations on KT1s</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Spendable, scriptless contracts are simulated by the &#39;manager.tz&#39; script,
which replaces their functionality. It allows for the contract&#39;s manager to set
and withdraw delegate, spend the contract&#39;s funds and to set a new manager,
which is written into script&#39;s storage.

The &#39;manager.tz&#39; script&#39;s parameters have field annotations, which in
combination with script entry-points allows for friendlier commands for
running the script.

Spendable and delegatable flags are simulated by adding entrypoints to
a scripted contract.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto: make implicit accounts delegatable</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains BREAKING CHANGES (see end of message).

Implicit accounts (tz1, tz2, tz3) can directly set their
delegate. Furthermore implicit accounts have the ability to delete
their delegate by sending a &quot;delegate&quot; transaction with an empty
delegate field.  This specific patch does not impact the ability for
originated (KT1) accounts to set or delete their delegate.

The storage type of the &quot;Delegated&quot; accounts changes it&#39;s index from
&quot;Contract_hash&quot; to &quot;Contract_repr.Index&quot;. This change in the type
signature allows that both implicit and originated accounts can be
stored in the set.

Explorers and wallets should handle the delegation from tz1, tz2 and
tz3 accounts. RPC `/context/delegates/&lt;pkh&gt;/delegated_contracts` (and
composite RPC `/context/delegates/&lt;pkh&gt;/`) can now contain tz1, tz2
and tz3 addresses.
</pre></div>
</div>
</section>
<section id="migration">
<h3><a class="toc-backref" href="#id39" role="doc-backlink">Migration</a><a class="headerlink" href="#migration" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Proto/Migration: switch scripted KT1s to new <code class="docutils literal notranslate"><span class="pre">big_map</span></code> storage</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch looks for big_maps in existing smart contracts, and moves
them to their new storage path.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: handle default entrypoint originated before migration</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch updates contracts deployed before the migration with a
`%default` entrypoint. This is done by adding a `%root` entrypoint as
detailed in a previous patch.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: update deployed multisigs to the newest supported version</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

This does not change the behaviour of the multisig. It adds a call to
the newly introduced `CHAIN_ID` instruction in order to add extra
replay protection between the main chain and the test chain.

Smart contract users that do not use the `tezos-client` but a custom
tool to interact with multi-signature contracts deployed with the
`tezos-client` should also include the `CHAIN_ID` in the commands they
sign.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: migrate KT1s with and without script</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Contains a BREAKING CHANGE (see end of message).

All spendable, scriptless contracts are migrated to &#39;manager.tz&#39; script.

Contracts that have a spendable flag set are augmented with a `%do`
entrypoint. Contracts that have a delegatable flag set are augmented
with `%set_delegate` and `%remove_delegate` entrypoints.

Interacting with converted contracts must now be done via smart
contract calls. As an example, here is how `tezos-client` handles
retro-compatibility for the `transfer` and `set delegate` commands.

When crafting a transaction, if the source is a KT1, if checks that
its storage is either of type `key_hash` or `pair key_hash _`, and
retrieve this `key_hash`. Let&#39;s name this `key_hash` &lt;manager&gt;.

To implement `tezos-client set delegate for &lt;contract&gt; to &lt;delegate&gt;`,
it starts by looking for entrypoints.

If `%set_delegate` is present, it does the equivalent of
  &#39;tezos-client transfer 0 from &lt;manager&gt; to &lt;contract&gt; \
                  --entrypoint &#39;set_delegate&#39; --arg &#39;&lt;delegate&gt;&#39;
where &lt;manager&gt; is the key_hash found in the contract&#39;s storage

If `%do` is present, it does the equivalent of
   &#39;tezos-client transfer 0 from &lt;manager&gt; to &lt;contract&gt; \
                 --entrypoint &#39;do&#39; \
                 --arg &#39;{ NIL operation ; \
                          PUSH key_hash &lt;delegate&gt; ; \
                          SOME ; \
                          SET_DELEGATE ; \
                          CONS }&#39;
   where &lt;manager&gt; is the key_hash found in the contract&#39;s storage

To implement `tezos-client transfer &lt;amount&gt; from &lt;contract&gt; to &lt;destination&gt;`,
when the destination is a simple address or a contract of type `unit`,
it does the equivalent of
```
tezos-client transfer 0 from &lt;manager&gt; to &lt;contract&gt; \
             --entrypoint &quot;do&quot; \
             --arg &#39;{ NIL operation ; \
                      PUSH address &lt;destination&gt; ; \
                      CONTRACT unit;
                      AMOUNT ; \
                      UNIT ; \
                      TRANSFER_TOKENS ; \
                      CONS ; \
                      PAIR }&#39;
```

To implement `tezos-client transfer &lt;amount&gt; from &lt;contract&gt; to &lt;destination&gt; \
                [--arg &lt;value&gt;] [--entrypoint &lt;entrypoint&gt;]`,
it starts by checking that the contract has a `%do` entrypoint.

Then it look for type `&lt;entrypoint&gt;` of contract `&lt;destination&gt;` in the chain

And it does the equivalent of
```
tezos-client transfer 0 from &lt;manager&gt; to &lt;contract&gt; \
             --entrypoint &quot;do&quot; \
             --arg &#39;{ NIL operation ; \
                      PUSH address &lt;destination&gt; ; \
                      CONTRACT %&lt;entrypoint&gt; &lt;type&gt;; # Omit &lt;entrypoint&gt; if not given
                      AMOUNT ; \
                      PUSH &lt;type&gt; &lt;value&gt; ; \ # UNIT if &lt;arg&gt; not given
                      TRANSFER_TOKENS ; \
                      CONS ; \
                      PAIR }&#39;
```
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: new constant min_proposal_quorum</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch initializes the newly introduced min_proposal_quorum
protocol parameter to 5%.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: migrate the values of ‘Contract.Delegated’ storage</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch migrates the context according to the previous patch.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: migrate last_block_priority to block_priority</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch migrates the context to include the current block priority
instead of the one of the predecessor. This is needed for the new
block reward schema introduced by the previous patch.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: constants for Emmy+</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patches stores the initial values for the new protocol parameters
introduced by Emmy+.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: participation EMA and min/max quorum caps</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This commit amends the context. It uses the
last value of current quorum for participation EMA and adds
min/max quorum caps to it. Initially the minimum quorum cap
is set to 20% and the maximum to 70%.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: add all constants in the context</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This patch does not change the semantics.

It migrates the stored constants in a way compatible with the new
format defined by the previous patch.

In the previous format, only parameters different from the (now
removed) default values were stored. Now all parameters are stored
explicitly.
</pre></div>
</div>
<ul class="simple">
<li><p>Proto/Migration: add invoicing to multi-sig smart-contract</p></li>
</ul>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="006_carthage.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Protocol Carthage</p>
      </div>
    </a>
    <a class="right-next"
       href="004_Pt24m4xi.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Protocol Athens</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#emmy">Emmy+</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#michelson">Michelson</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#new-instructions-to-facilitate-compilation-to-michelson">New instructions to facilitate compilation to Michelson</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-for-compatibility-with-the-accounts-rehaul">Changes for compatibility with the accounts rehaul</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proposal-quorum">Proposal quorum</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quorum-caps">Quorum caps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-implicit-accounts-delegatable">Make implicit accounts delegatable</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replace-kt1-accounts-with-manager-tz-script">Replace KT1 accounts with <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code> script</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-to-rpcs">Changes to RPCs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequence-of-emmy">Consequence of <code class="docutils literal notranslate"><span class="pre">Emmy</span> <span class="pre">+</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequence-of-quorums">Consequence of <code class="docutils literal notranslate"><span class="pre">quorums</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequences-of-new-instructions-to-facilitate-compilation-to-michelson">Consequences of <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">instructions</span> <span class="pre">to</span> <span class="pre">facilitate</span> <span class="pre">compilation</span> <span class="pre">to</span> <span class="pre">Michelson</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequences-of-entry-point-introduction">Consequences of <code class="docutils literal notranslate"><span class="pre">Entry-point</span> <span class="pre">introduction</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consequences-of-other-michelson-changes">Consequences of other <code class="docutils literal notranslate"><span class="pre">Michelson</span></code> changes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#manager-operations-are-incompatible">Manager operations are incompatible</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-to-the-binary-format-of-operations">Changes to the binary format of operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-source-field-of-manager-operations-is-now-a-public-key-hash">The <code class="docutils literal notranslate"><span class="pre">source</span></code> field of manager operations is now a public key hash</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transactions-now-have-an-entrypoint">Transactions now have an entrypoint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-fields-are-dropped-in-originations">Some fields are dropped in originations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-tags-of-all-manager-operations-are-shifted-by-100">The tags of all manager operations are shifted by <code class="docutils literal notranslate"><span class="pre">100</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#migration-from-scriptless-kt1s-to-manager-tz">Migration from scriptless KT1s to <code class="docutils literal notranslate"><span class="pre">manager.tz</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#origination-script-transformation">Origination script transformation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#template-add-do">Template <code class="docutils literal notranslate"><span class="pre">add_do</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#template-add-set-delegate">Template <code class="docutils literal notranslate"><span class="pre">add_set_delegate</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gas-cost-changes">Gas cost changes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bug-affecting-bigmaps-in-005-psbaby5h">Bug affecting Bigmaps in 005_PsBABY5H</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changelog">Changelog</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Emmy+</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Michelson</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#governance">Governance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#accounts-rehaul">Accounts rehaul</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#migration">Migration</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nomadic Labs <contact@nomadic-labs.com>
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2018-2023, Nomadic Labs &lt;contact@nomadic-labs.com&gt;.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>