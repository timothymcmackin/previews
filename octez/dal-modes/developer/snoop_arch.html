
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Architecture of octez-snoop &#8212; Octez &amp; Protocol products documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=c488f85a" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=c0ed171f"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KT3Z3X4Y82"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KT3Z3X4Y82');
            </script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'developer/snoop_arch';</script>
    <script src="../_static/js/custom.js?v=e7f469e6"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Snoop usage tutorial" href="snoop_tutorial.html" />
    <link rel="prev" title="Benchmarking with Snoop" href="snoop.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="Octez & Protocol products documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.svg" class="logo__image only-dark" alt="Octez & Protocol products documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/tezos.html">Octez &amp; Protocol overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction/howtoget.html">Installing Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/get_troubleshooting.html">Installation troubleshooting</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtouse.html">Getting started with Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/howtorun.html">Running Octez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/versioning.html">Octez &amp; Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/breaking_changes.html">BREAKING CHANGES</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez User manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-client.html">Setting up the client</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/client-configuration.html">Client Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/key-management.html">Key Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/sandbox.html">Sandboxed mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/mockup.html">Mockup mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy.html">Proxy mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/light.html">Light mode</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../user/setup-node.html">Setting up the node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../user/node-configuration.html">Node Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/multinetwork.html">Connecting to a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/history_modes.html">History modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/snapshots.html">Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user/proxy-server.html">Proxy server</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../user/node-monitoring.html">Monitoring an Octez Node</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="openmetrics.html">Supported Open Metrics</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../user/multisig.html">Built-in multisig contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/fa12.html">FA1.2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/logging.html">Logging features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/exits.html">Exit codes and signals</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Octez Reference manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../shell/the_big_picture.html">Octez Software Architecture</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/shell.html">The Octez Shell</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/validation.html">The validation subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/prevalidation.html">The Prevalidator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/storage.html">The storage layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/sync.html">Synchronisation heuristic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/p2p.html">The peer-to-peer layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/protocol_environment.html">Protocol Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/micheline.html">Micheline</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/data_availability_committees.html">Data Availability Committees</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../shell/dal.html">Data Availability Layer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_overview.html">DAL overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_node.html">The DAL node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_run.html">Running a DAL node</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/dal_bakers.html">Bakers &amp; the DAL</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/smart_rollup_node.html">Smart rollup node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/p2p_api.html">P2P message format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/rpc.html">Shell RPCs - Reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Protocol Reference Manuals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../active/index.html">Paris Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../active/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../active/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_issuance.html">Adaptive Issuance and Staking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../active/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../active/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../active/rpc.html">Paris RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../quebec/index.html">Quebec Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../quebec/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../quebec/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quebec/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../quebec/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quebec/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quebec/rpc.html">Quebec RPCs - Reference</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../alpha/index.html">Alpha Dev Protocol Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../alpha/protocol.html">Economic protocol features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../alpha/protocol_overview.html">Overview of the economic protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/proof_of_stake.html">Proof-of-stake</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/randomness_generation.html">Randomness generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/baking_power.html">Baking Power</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/consensus.html">The consensus algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/voting.html">The Amendment (and Voting) Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/accounts.html">Accounts and addresses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson.html">Michelson: the language of Smart Contracts in Tezos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/views.html">On-chain Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/timelock.html">Time-lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/sapling.html">Sapling support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/liquidity_baking.html">Liquidity Baking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/global_constants.html">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/michelson_anti_patterns.html">Michelson Anti-Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/token_management.html">Token transfers and balance updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/precheck.html">Prechecking of manager operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/smart_rollups.html">Smart Optimistic Rollups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/plugins.html">Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/event.html">Contract events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/blocks_ops.html">Blocks and Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/validation.html">Validation and Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/tickets.html">Tickets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_issuance.html">Adaptive Issuance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/staking.html">Staking mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/adaptive_slashing.html">Adaptive Slashing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../alpha/dal_support.html">DAL support</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/cli-commands.html">Command Line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alpha/rpc.html">Alpha RPCs - Reference</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tezos developer Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="rpc.html">JSON/RPC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/errors.html">RPC Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/openapi.html">RPCs - OpenAPI reference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in Octez releases</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../releases/releases.html">Release System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/version-20.html">Version 20.2</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../releases/history.html">Older Versions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-19.html">Version 19.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-18.html">Version 18.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-17.html">Version 17.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-16.html">Version 16.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-15.html">Version 15.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-14.html">Version 14.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-13.html">Version 13.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-12.html">Version 12.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-11.html">Version 11.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-10.html">Version 10.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-9.html">Version 9.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-8.html">Version 8.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/version-7.html">Version 7.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/january-2020.html">Mainnet January 2020</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/december-2019.html">Mainnet December 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/october-2019.html">Mainnet-Staging October 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/september-2019.html">Mainnet September 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/may-2019.html">Mainnet May 2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releases/april-2019.html">Mainnet April 2019</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changes in protocol versions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../protocols/naming.html">Protocol versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/019_paris.html">Protocol Paris</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/021_quebec.html">Protocol Quebec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protocols/alpha.html">Protocol Alpha</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../protocols/history.html">Older Protocols</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../protocols/018_oxford.html">Protocol Oxford</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/017_nairobi.html">Protocol Nairobi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/016_mumbai.html">Protocol Mumbai</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/015_lima.html">Protocol Lima</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/014_kathmandu.html">Protocol Kathmandu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/013_jakarta.html">Protocol Jakarta</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/012_ithaca.html">Protocol Ithaca</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/011_hangzhou.html">Protocol Hangzhou</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/010_granada.html">Protocol Granada</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/009_florence.html">Protocol Florence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/008_edo.html">Protocol Edo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/007_delphi.html">Protocol Delphi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/006_carthage.html">Protocol Carthage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/005_babylon.html">Protocol Babylon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/004_Pt24m4xi.html">Protocol Athens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/003_PsddFKi3.html">Protocol 003_PsddFKi3</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="contributing_index.html">How to contribute</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="contributing.html">How to contribute to Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing-adding-a-new-opam-dependency.html">How to add or update opam dependencies</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="merge_team.html">Octez Merge Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="guidelines.html">Documentation and coding guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="repository_scope.html">Scope of the Octez repository</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="programming.html">Programming tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="gadt.html">Generalized Algebraic Data Types (GADTs)</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="error_monad.html">The Error Monad</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="error_monad_p1_result.html">Part 1: <code class="docutils literal notranslate"><span class="pre">result</span></code>, Lwt, and Lwt-<code class="docutils literal notranslate"><span class="pre">result</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="error_monad_p2_tzresult.html">Part 2: <code class="docutils literal notranslate"><span class="pre">tzresult</span></code> and Lwt-<code class="docutils literal notranslate"><span class="pre">tzresult</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="error_monad_p3_advanced.html">Part 3: Advanced topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="error_monad_p4_appendices.html">Part 4: Appendices</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="clic.html">The <code class="docutils literal notranslate"><span class="pre">clic</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_encoding.html">The <code class="docutils literal notranslate"><span class="pre">data_encoding</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_logging_framework.html">Using The Event Logging Framework</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="testing_index.html">Testing in Octez</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Overview of Testing in Octez</a></li>
<li class="toctree-l2"><a class="reference internal" href="ppx_expect.html">Ppx_expect</a></li>
<li class="toctree-l2"><a class="reference internal" href="tezt.html">Tezt: OCaml Tezos Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="long-tezts.html">Tezt: Long Tests and Performance Regression Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="alcotezt.html">Alcotezt: An Alcotest Compatibility Wrapper for Tezt</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_testing_legacy_code.html">Making legacy code unit-testable</a></li>
<li class="toctree-l2"><a class="reference internal" href="proposal_testing.html">How to Test a Protocol Proposal</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="maintaining.html">Maintaining</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="entering_alpha.html">How to start reading protocol Alpha</a></li>
<li class="toctree-l2"><a class="reference internal" href="michelson_instructions.html">Adding a new instruction to Michelson language</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol_release_checklist.html">Protocol Release Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto-freeze-protocols.html">How to Freeze Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol_environment_upgrade.html">Adding a new protocol environment</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Documenting</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="tools.html">Platform Development tools</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="profiling.html">Profiling the Octez node</a></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="snoop.html">Benchmarking with Snoop</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Architecture of <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="snoop_tutorial.html">Snoop usage tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="snoop_example.html">In-depth usage example: more control over your benchmark</a></li>
<li class="toctree-l3"><a class="reference internal" href="tezos_micheline_rewriting.html">Rewriting Micheline with <code class="docutils literal notranslate"><span class="pre">tezos-micheline-rewriting</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="snoop_interpreter.html">Snoop and the Michelson Interpreter</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="time_measurement_ppx.html">Time measurement PPX</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_environment.html">Python Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="pre_commit_hook.html">Pre-Commit Hook</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="encodings.html">Encodings</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="merkle-proof-encoding-formats.html">Merkle Proof Encoding Formats</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v1-tree32.html">V1 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v1-tree2.html">V1 for Tree2</a></li>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v2-tree32.html">V2 for Tree32</a></li>
<li class="toctree-l2"><a class="reference internal" href="merkle-proof-formats/v2-tree2.html">V2 for Tree2</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api-inline.html">OCaml APIs - Reference</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-gitlab"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-gitlab"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://gitlab.com/tezos/tezos/-/issues/new?issue[title]=Issue%20on%20page%20%2Fdeveloper/snoop_arch.html&issue[description]=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Architecture of octez-snoop</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-description">High-level description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code-organization">Code organization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-benchmarks-the-generator-module">Defining benchmarks: the <code class="docutils literal notranslate"><span class="pre">Generator</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plain-benchmarks">Plain benchmarks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#with-context-benchmarks">With_context benchmarks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#with-probe-benchmarks">With_probe benchmarks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-predictive-model-the-model-module">Defining a predictive model: the <code class="docutils literal notranslate"><span class="pre">Model</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-models-a-primer">Linear models: a primer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-costlang-dsl">The <code class="docutils literal notranslate"><span class="pre">Costlang</span></code> DSL</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definition-of-cost-models-the-model-module">Definition of cost models: the <code class="docutils literal notranslate"><span class="pre">Model</span></code> module</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-measure-module">The <code class="docutils literal notranslate"><span class="pre">Measure</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-execution-time-of-generator-benchmark-values">Measuring execution time of <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-and-saving-benchmark-results">Loading and saving benchmark results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-outliers-from-benchmark-data">Removing outliers from benchmark data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-parameter-fits-the-inference-module">Computing parameter fits: the <code class="docutils literal notranslate"><span class="pre">Inference</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study-constructing-the-matrices">Case study: constructing the matrices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#structure-of-the-inference-module">Structure of the inference module</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#making-regression-problems">Making regression problems</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-the-matrix-equation">Solving the matrix equation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference-for-sets-of-benchmarks">Parameter inference for sets of benchmarks</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="architecture-of-octez-snoop">
<h1>Architecture of <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code><a class="headerlink" href="#architecture-of-octez-snoop" title="Link to this heading">#</a></h1>
<p>The following figure describes the main functionalities and data
processed by <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code>, to be read from top to bottom. The boxed
nodes represents the various kinds of data processed by the tool,
while the unboxed items represent computational steps.</p>
<img alt="../_images/snoop_arch.png" src="../_images/snoop_arch.png" />
<p>The code architecture of <code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code> is itself divided in the following
main packages:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bin_snoop</span></code> is the main binary (you can have a look at the <a class="reference internal" href="../shell/cli-commands.html#benchmark-tool-manual"><span class="std std-ref">manual</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tezos-benchmark</span></code> is a library for performing measurements, writing models
and infering parameters for these models.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tezos-micheline-rewriting</span></code> is used to perform rewriting of Micheline terms
(documentation available <a class="reference internal" href="tezos_micheline_rewriting.html"><span class="doc">here</span></a>).
It is mainly used when writing protocol-specific benchmarks but is independent
from the protocol.</p></li>
</ul>
<p>There are other packages containing shell-specific and protocol-specific benchmarks,
these are not documented here.</p>
<p>Here, we will focus on the <code class="docutils literal notranslate"><span class="pre">tezos-benchmark</span></code> library, which is the core of the
tool.</p>
<section id="high-level-description">
<h2>High-level description<a class="headerlink" href="#high-level-description" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code> is a tool for benchmarking and fitting statistical models which predict the performance of any piece of code of interest.</p>
<p>More concretely, let us consider a piece of code for which we wish to predict its performance. To understand the performance profile of this piece of code, we must execute it with different arguments, varying the size of the problem to be solved. As “the size of the problem to be solved” is a long expression, we will use the shorter term <em>workload</em> for that.</p>
<p>The notion of workload is abstract here, and indeed, it is not necessarily a scalar. Here are a few examples of workloads:</p>
<ul class="simple">
<li><p>Timer benchmarks measure the latency of the timer itself and the associated workloads record nothing.</p></li>
<li><p>IO benchmarks measure the execution time of performing specific read and write patterns to the underlying key-value store and the associated workloads record the size of the storage as well as the parameters (bytes read/written, length of keys, etc) of these accesses.</p></li>
<li><p>Translator benchmarks measure the execution time of various pieces of <code class="docutils literal notranslate"><span class="pre">Script_ir_translator</span></code> (the <em>translator</em> for short, which handles typechecking/unparsing of code and data) as well as Micheline serialization, and corresponding workloads record the size of the typechecked/unparsed/(de)serialized terms.</p></li>
<li><p>Michelson benchmarks measure the execution time of the interpreter on specific programs and the associated workloads record the list of all executed instructions together with, for each instruction, the sizes of the operands as encountered on the stack.</p></li>
</ul>
<p>Once this notion of workload is clear, we can describe Snoop’s user interface.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">tezos-benchmark</span></code> requires to provide, for each benchmark, the following main items:</p>
<ul class="simple">
<li><p>a type of execution <code class="docutils literal notranslate"><span class="pre">workload</span></code>;</p></li>
<li><p>a statistical model, corresponding to a function which to each <code class="docutils literal notranslate"><span class="pre">workload</span></code> associates an expression (possibly with free variables) denoting the predicted execution time for that workload. In simple cases, the model consists in <em>a single</em> expression computing a predicted execution time for any given workload.</p></li>
<li><p>A family of pieces of code (i.e. closures) to be benchmarked, each associated to its <code class="docutils literal notranslate"><span class="pre">workload</span></code>. Thus, each closure contains the application of a piece of a code to arguments instantiating a specific workload. We assume that the execution time of each closure has a well-defined distribution. In most cases, these closures correspond to executing <em>a single</em> piece of code of interest with different inputs.</p></li>
</ul>
<p>From this input, <code class="docutils literal notranslate"><span class="pre">tezos-benchmark</span></code> can perform for you the following tasks:</p>
<ul class="simple">
<li><p>perform the timing measurements;</p></li>
<li><p>infer the free parameters of the statistical model;</p></li>
<li><p>display the results of benchmarking and inference;</p></li>
<li><p>generate code from the model.</p></li>
</ul>
</section>
<section id="code-organization">
<h2>Code organization<a class="headerlink" href="#code-organization" title="Link to this heading">#</a></h2>
<p>The data type that wraps everything up is the module type <code class="docutils literal notranslate"><span class="pre">Benchmark.S</span></code>.
The main items required by this type are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">create_benchmarks</span></code>, a function that must generate closures and their associated workloads (packed together in type <code class="docutils literal notranslate"><span class="pre">'workload</span> <span class="pre">Generator.benchmark</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">models</span></code>, a list of statistical models that we’d like to fit to predict the execution time of the piece of code of interest.</p></li>
</ul>
<p>The library is meant to be used as follows:</p>
<ul class="simple">
<li><p>define a <code class="docutils literal notranslate"><span class="pre">Benchmark.S</span></code>, which requires</p>
<ul>
<li><p>constructing benchmarks</p></li>
<li><p>defining models, either pre-built (via the <code class="docutils literal notranslate"><span class="pre">Model</span></code> module) or from scratch (using the <code class="docutils literal notranslate"><span class="pre">Costlang</span></code> DSL);</p></li>
</ul>
</li>
<li><p>generate empirical timing measurements using <code class="docutils literal notranslate"><span class="pre">Measure.perform_benchmark</span></code>;</p></li>
<li><p>given the data generated, infer parameters of the models
using <code class="docutils literal notranslate"><span class="pre">Inference.make_problem</span></code> and <code class="docutils literal notranslate"><span class="pre">Inference.solve_problem</span></code>;</p></li>
<li><p>exploit the results:</p>
<ul>
<li><p>input back the result of inference in the model to make it predictive</p></li>
<li><p>plot the data (<code class="docutils literal notranslate"><span class="pre">tezos-benchmark</span></code> can generate CSV)</p></li>
<li><p>generate code from the model (<code class="docutils literal notranslate"><span class="pre">Codegen</span></code> module)</p></li>
</ul>
</li>
</ul>
<p>Modules implementing the <code class="docutils literal notranslate"><span class="pre">Benchmark.S</span></code> signature can also be registered
via the <code class="docutils literal notranslate"><span class="pre">Registration.register</span></code> function which makes them available to
<code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code>, a binary that wraps these features under a nice CLI.</p>
</section>
<section id="defining-benchmarks-the-generator-module">
<h2>Defining benchmarks: the <code class="docutils literal notranslate"><span class="pre">Generator</span></code> module<a class="headerlink" href="#defining-benchmarks-the-generator-module" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> type defines the interface that each benchmark
must implement. At the time of writing, this type specifies three ways
to provide a benchmark (but more could easily be added):</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="k">&#39;</span><span class="n">workload</span> <span class="n">benchmark</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Plain</span> <span class="o">:</span> <span class="o">{</span><span class="n">workload</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">workload</span><span class="o">;</span> <span class="n">closure</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">workload</span> <span class="n">benchmark</span>
  <span class="o">|</span> <span class="nc">With_context</span> <span class="o">:</span> <span class="o">{</span>
      <span class="n">workload</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">workload</span><span class="o">;</span>
      <span class="n">closure</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">;</span>
      <span class="n">with_context</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">.</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">context</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">;</span>
    <span class="o">}</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">workload</span> <span class="n">benchmark</span>
  <span class="o">|</span> <span class="nc">With_probe</span> <span class="o">:</span> <span class="o">{</span>
      <span class="n">workload</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">aspect</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">workload</span><span class="o">;</span>
      <span class="n">probe</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">aspect</span> <span class="n">probe</span><span class="o">;</span>
      <span class="n">closure</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">aspect</span> <span class="n">probe</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">;</span>
    <span class="o">}</span>
      <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">workload</span> <span class="n">benchmark</span>
</pre></div>
</div>
<section id="plain-benchmarks">
<h3>Plain benchmarks<a class="headerlink" href="#plain-benchmarks" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Plain</span></code> constructor simply packs a workload and a closure together.
The implied semantics of this benchmark is that the <code class="docutils literal notranslate"><span class="pre">closure</span></code> is
a stateless piece of code, ready to be executed thousands of times
by the measure infrastructure.</p>
</section>
<section id="with-context-benchmarks">
<h3>With_context benchmarks<a class="headerlink" href="#with-context-benchmarks" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">With_context</span></code> constructor allows to define benchmarks we
require to set up and cleanup a <em>context</em>, shared by all executions of
the closure. An example (which prompted the addition of this feature)
is the case of storage benchmarks, where we need to create a directory
and set up some files before executing a closure containing e.g.
a read or write access, after which the directory must be removed.</p>
</section>
<section id="with-probe-benchmarks">
<h3>With_probe benchmarks<a class="headerlink" href="#with-probe-benchmarks" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">With_probe</span></code> constructor allows fine-grained benchmarking by
inverting control: the user is in charge of calling the pieces of code
to be benchmarked using the provided <code class="docutils literal notranslate"><span class="pre">probe</span></code>. The definition of a
probe consists in a small object with three methods:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="k">&#39;</span><span class="n">aspect</span> <span class="n">probe</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">apply</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">.</span> <span class="k">&#39;</span><span class="n">aspect</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">;</span>
  <span class="n">aspects</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">aspect</span> <span class="kt">list</span><span class="o">;</span>
  <span class="n">get</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">aspect</span> <span class="o">-&gt;</span> <span class="kt">float</span> <span class="kt">list</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The intended semantics of each method is as follows:</p>
<ul class="simple">
<li><p>calling <code class="docutils literal notranslate"><span class="pre">probe.apply</span> <span class="pre">aspect</span> <span class="pre">f</span></code> executes <code class="docutils literal notranslate"><span class="pre">f</span></code>, performing e.g. a
timing measurement of <code class="docutils literal notranslate"><span class="pre">f</span></code>’s execution time and returns the result
of the evaluation. The measurement is associated to the specified
<code class="docutils literal notranslate"><span class="pre">aspect</span></code> in a side-effecting way.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">probe.aspects</span></code> returns the list of all aspects.</p></li>
<li><p>Finally, <code class="docutils literal notranslate"><span class="pre">probe.get</span> <span class="pre">aspect</span></code> returns all the measurements associated
to <code class="docutils literal notranslate"><span class="pre">aspect</span></code>.</p></li>
</ul>
<p>Note that <code class="docutils literal notranslate"><span class="pre">With_probe</span></code> benchmarks do not come with a fixed workload,
but rather with an aspect-indexed family of workloads. This reflects
the fact that this kind of benchmark can measure
several different pieces of code in the same run,
each potentially associated to its own cost model.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">Measure.make_timing_probe</span></code> provides a basic probe
implementation. The unit test in <code class="docutils literal notranslate"><span class="pre">src/lib_benchmark/test/test_probe.ml</span></code>
contains an example.</p>
</section>
</section>
<section id="defining-a-predictive-model-the-model-module">
<h2>Defining a predictive model: the <code class="docutils literal notranslate"><span class="pre">Model</span></code> module<a class="headerlink" href="#defining-a-predictive-model-the-model-module" title="Link to this heading">#</a></h2>
<p>As written above, the <code class="docutils literal notranslate"><span class="pre">Benchmark.S</span></code> signature also requires a list
of <em>models</em> (note that users only interested in measures of execution
time can leave this list empty). At the time of writing, <code class="docutils literal notranslate"><span class="pre">tezos-benchmark</span></code>
only handles <em>linear models</em>.</p>
<section id="linear-models-a-primer">
<span id="linear-models-primer"></span><h3>Linear models: a primer<a class="headerlink" href="#linear-models-a-primer" title="Link to this heading">#</a></h3>
<p>We aim at predicting the cost (typically, execution time) for various parts of
the codebase. To do this, we must first come up with a <em>model</em>.
These cost models take as input some notion of “size” (typically a vector
of integers) and output a prediction of execution time (or, up to unit
conversion, a quantity of gas). If <span class="math notranslate nohighlight">\(S\)</span> is the abstract set of sizes,
we’re trying to infer a function of type <span class="math notranslate nohighlight">\(S \rightarrow \mathbb{R}_{\ge 0}\)</span>
from a finite list of examples <span class="math notranslate nohighlight">\((s_n, t_n)_n \in (S \times \mathbb{R}_{\ge 0})^\ast\)</span>
which minimizes some error criterion. This is an example of a <strong>regression</strong>
problem.</p>
<p>Note that since <span class="math notranslate nohighlight">\(S\)</span> is typically not finite, <span class="math notranslate nohighlight">\(S \rightarrow \mathbb{R}_{\ge 0}\)</span>
is an infinite-dimensional vector space. We will restrict our search
to a <span class="math notranslate nohighlight">\(n\)</span>-dimensional subset of functions <span class="math notranslate nohighlight">\(f_\theta\)</span>, with <span class="math notranslate nohighlight">\(\theta \in \mathbb{R}^n\)</span>,
of the form</p>
<div class="math notranslate nohighlight">
\[f_\theta = \sum_{i=1}^n \theta_i g_i\]</div>
<p>where the <span class="math notranslate nohighlight">\((g_i)_{i=1}^n\)</span> is a <strong>fixed</strong> family of
functions <span class="math notranslate nohighlight">\(g_i : S \rightarrow \mathbb{R}_{\ge 0}\)</span>.
An <span class="math notranslate nohighlight">\(n\)</span>-dimensional linear cost model is entirely determined by the <span class="math notranslate nohighlight">\(g_i\)</span>.</p>
<p>Enumerating the currying isomorphisms, a linear model can be considered as:</p>
<ol class="arabic simple">
<li><p>a <strong>linear</strong> function <span class="math notranslate nohighlight">\(\mathbb{R}^n \multimap (S \rightarrow \mathbb{R}_{\ge 0})\)</span>
from “meta” parameters to cost functions;</p></li>
<li><p>a function <span class="math notranslate nohighlight">\(S \rightarrow (\mathbb{R}^n \rightarrow \mathbb{R}_{\ge 0})\)</span>
from sizes to linear forms over “meta” parameters;</p></li>
<li><p>a function <span class="math notranslate nohighlight">\(S \times \mathbb{R}^n \rightarrow \mathbb{R}_{\ge 0}\)</span>.</p></li>
</ol>
<p>The two first forms are the useful ones. The first form is useful in stating
the inference problem: we seek <span class="math notranslate nohighlight">\(\theta\)</span> that minimizes some empirical
error measure over the benchmark results. The second form is useful as it
allows to transform the linear model in vector form, when applying the
size.</p>
</section>
<section id="the-costlang-dsl">
<span id="costlang-dsl"></span><h3>The <code class="docutils literal notranslate"><span class="pre">Costlang</span></code> DSL<a class="headerlink" href="#the-costlang-dsl" title="Link to this heading">#</a></h3>
<p>The module <code class="docutils literal notranslate"><span class="pre">Costlang</span></code> defines a small language in which to define terms
having both free and bound variables. The intended semantics for free
variables is to stand in for variables to be inferred during the inference
process (corresponding to <span class="math notranslate nohighlight">\(\theta_i\)</span> in the previous section).
The language is defined in tagless final style. If this does not
ring a bell, we <strong>strongly</strong> recommend you take a look at
<a class="reference external" href="https://okmij.org/ftp/tagless-final/index.html">https://okmij.org/ftp/tagless-final/index.html</a> in order to make sense of the
rest of this section. The syntax is specified by the <code class="docutils literal notranslate"><span class="pre">Costlang.S</span></code> module
type:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">S</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span>
  <span class="k">type</span> <span class="n">size</span>
  <span class="k">val</span> <span class="bp">true</span><span class="o">_</span> <span class="o">:</span> <span class="kt">bool</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="bp">false</span><span class="o">_</span> <span class="o">:</span> <span class="kt">bool</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="kt">int</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="kt">float</span> <span class="o">:</span> <span class="kt">float</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">max</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">min</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">log2</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">free</span> <span class="o">:</span> <span class="n">name</span><span class="o">:</span><span class="nn">Free_variable</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">lt</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">eq</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">shift_left</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">shift_right</span> <span class="o">:</span> <span class="n">size</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">size</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">lam</span> <span class="o">:</span> <span class="n">name</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">repr</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">)</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">app</span> <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">)</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">let_</span> <span class="o">:</span> <span class="n">name</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">repr</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">repr</span>
  <span class="k">val</span> <span class="n">if_</span> <span class="o">:</span> <span class="kt">bool</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">repr</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In a nutshell, the type of terms is <code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">'a</span> <span class="pre">term</span> <span class="pre">=</span> <span class="pre">\pi</span> <span class="pre">(X</span> <span class="pre">:</span> <span class="pre">S).</span> <span class="pre">'a</span> <span class="pre">X.repr</span></code>,
i.e. terms must be thought of as parametric in their implementation,
provided by a module of type <code class="docutils literal notranslate"><span class="pre">S</span></code>.</p>
<p>It must be noted that this language does not enforce that built
terms are linear (in the usual, not type-theoretic sense) in their
free variables: this invariant must be currently enforced dynamically.
The <code class="docutils literal notranslate"><span class="pre">Costlang</span></code> module defines some useful functions for manipulating
terms and printing terms:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Costlang.Pp_impl</span></code> is a simple pretty printer,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Costang.Eval_impl</span></code> is an evaluator (which fails on terms
having free variables),</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Costlang.Eval_linear_combination_impl</span></code> evaluates terms
which are linear combinations in their free variables to
vectors (corresponding to applying a size parameter to the second
curried form in the previous section),</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Costlang.Subst</span></code> allows to perform substitution of free variables,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Costlang.Hash_cons</span></code> allows to manipulate hash-consed terms,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Costlang.Beta_normalize</span></code> allows to beta-normalize…</p></li>
</ul>
<p>Other implementations are provided elsewhere, e.g. for code or
report generation.</p>
</section>
<section id="definition-of-cost-models-the-model-module">
<h3>Definition of cost models: the <code class="docutils literal notranslate"><span class="pre">Model</span></code> module<a class="headerlink" href="#definition-of-cost-models-the-model-module" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Model</span></code> module provides a higher-level interface over <code class="docutils literal notranslate"><span class="pre">Costlang</span></code>,
and pre-defines widely used models. These pre-defined models are independent
of any specific workload: they need to be packaged together with a conversion
function from the workload of the benchmark of interest to the domain
of the model. The <code class="docutils literal notranslate"><span class="pre">Model.make</span> <span class="pre">~conv</span> <span class="pre">~model</span></code> function does just this.</p>
</section>
</section>
<section id="the-measure-module">
<span id="measure-module"></span><h2>The <code class="docutils literal notranslate"><span class="pre">Measure</span></code> module<a class="headerlink" href="#the-measure-module" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Measure</span></code> module is dedicated to measuring the execution
time of closures held in <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> values and
turn these into timed workloads (i.e. pairs of workload and execution time).
It also contains routines to remove outliers and to save and load
workload data together with extra metadata.</p>
<section id="measuring-execution-time-of-generator-benchmark-values">
<h3>Measuring execution time of <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> values<a class="headerlink" href="#measuring-execution-time-of-generator-benchmark-values" title="Link to this heading">#</a></h3>
<p>The core of the functionality is provided by the <code class="docutils literal notranslate"><span class="pre">Measure.perform_benchmark</span></code>
function.</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">perform_benchmark</span> <span class="o">:</span>
  <span class="nn">Measure</span><span class="p">.</span><span class="n">options</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">c</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">t</span><span class="o">)</span> <span class="nn">Tezos_benchmark</span><span class="p">.</span><span class="nn">Benchmark</span><span class="p">.</span><span class="n">poly</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">t</span> <span class="n">workload_data</span>
</pre></div>
</div>
<p>Before delving into its implementation, let’s examine its type.
A value of type <code class="docutils literal notranslate"><span class="pre">('c,</span> <span class="pre">'t)</span> <span class="pre">Tezos_benchmark.Benchmark.poly</span></code> is a first
class module where <code class="docutils literal notranslate"><span class="pre">'c</span></code> is a type variable corresponding to the configuration
of the benchmark and <code class="docutils literal notranslate"><span class="pre">'t</span></code> is a variable corresponding to the type
of workloads of the benchmark. Hence <code class="docutils literal notranslate"><span class="pre">perform_benchmark</span></code> is parametric
in these types.</p>
<p>Under the hood, this functions calls to the <code class="docutils literal notranslate"><span class="pre">create_benchmarks</span></code>
function provided by the first class module to create a list of
<code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> values. This might involve loading from
benchmark-specific parameters from a JSON file if the benchmark
so requires. After setting up some benchmark parameters
(random seed, GC parameters, CPU affinity), the function iterates over the
list of <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> and calls
<code class="docutils literal notranslate"><span class="pre">Measure.compute_empirical_timing_distribution</span></code> on the closure contained
in the <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> value.  This yields an
empirical distribution of timings which must be determinized: the user
can pick either a percentile or the mean of this distribution. The
function then records the execution time together with the workload
(contained in the <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code>) in its list of results.</p>
</section>
<section id="loading-and-saving-benchmark-results">
<h3>Loading and saving benchmark results<a class="headerlink" href="#loading-and-saving-benchmark-results" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Measure</span></code> module provides functions <code class="docutils literal notranslate"><span class="pre">save</span></code> and <code class="docutils literal notranslate"><span class="pre">load</span></code> for
benchmark results. Concretely, this is implemented by providing
an encoding for the type <code class="docutils literal notranslate"><span class="pre">Measure.measurement</span></code> which corresponds to
a <code class="docutils literal notranslate"><span class="pre">workload_data</span></code> together with some meta-data (CLI options used, benchmark
name, benchmark date).</p>
</section>
<section id="removing-outliers-from-benchmark-data">
<h3>Removing outliers from benchmark data<a class="headerlink" href="#removing-outliers-from-benchmark-data" title="Link to this heading">#</a></h3>
<p>It can happen that some timing measurement is polluted by e.g. another
process running in the same machine, or an unlucky scheduling. In this
case, it is legitimate to remove the tainted data point from the data
set in order to make fitting cost models easier. The function
<code class="docutils literal notranslate"><span class="pre">Measure.cull_outliers</span></code> is dedicated to that:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">cull_outliers</span> <span class="o">:</span> <span class="n">nsigmas</span><span class="o">:</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">workload</span> <span class="n">workload_data</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">workload</span> <span class="n">workload_data</span>
</pre></div>
</div>
<p>As its signature suggests, this function removes the workloads whose
associated execution time is below or above <code class="docutils literal notranslate"><span class="pre">nsigmas</span></code> standard deviations
of the mean. <strong>NB</strong> make a considerate use of this function, do not
remove data just because it doesn’t fit your model.</p>
</section>
</section>
<section id="computing-parameter-fits-the-inference-module">
<h2>Computing parameter fits: the <code class="docutils literal notranslate"><span class="pre">Inference</span></code> module<a class="headerlink" href="#computing-parameter-fits-the-inference-module" title="Link to this heading">#</a></h2>
<p>The inference subsystem takes as input benchmark results and statistical models
and fits the models to the benchmark results. Abstractly, the benchmark results
consist of a list of pairs  <code class="docutils literal notranslate"><span class="pre">(input,</span> <span class="pre">outputs)</span></code> for an unknown function
while the statistical model corresponds to a parameterised family of functions.
The goal of the inference subsystem is to find the parameter corresponding
to the function that best fits the relation between inputs and outputs.</p>
<p>In our case, the <code class="docutils literal notranslate"><span class="pre">inputs</span></code> correspond to workloads and the <code class="docutils literal notranslate"><span class="pre">outputs</span></code> to execution
times, as described in some length in previous sections.</p>
<p>The goal of the <code class="docutils literal notranslate"><span class="pre">Inference</span></code> module is to solve the regression problem
described in the <a class="reference internal" href="#linear-models-primer"><span class="std std-ref">primer on linear models</span></a>.
As inputs, it takes a cost model and some empirical data under the form
of a list of workloads as produced by the <code class="docutils literal notranslate"><span class="pre">Measure</span></code> module (see the related
<a class="reference internal" href="#measure-module"><span class="std std-ref">section</span></a>). Informally, the inference process can be
decomposed in the two following steps:</p>
<ul class="simple">
<li><p>transform the cost model and the empirical data into a
matrix equation <span class="math notranslate nohighlight">\(A x = T\)</span> where the input dimensions of <span class="math notranslate nohighlight">\(A\)</span>
(i.e. the columns) are indexed by free variables (corresponding to
cost coefficients to be inferred), the output dimensions
of <span class="math notranslate nohighlight">\(A\)</span> are indexed by workloads and where <span class="math notranslate nohighlight">\(T\)</span> is the column
vector containing execution times for each workload;</p></li>
<li><p>solve this problem using an off-the-shelf optimization package, yielding
the solution vector <span class="math notranslate nohighlight">\(x\)</span> assigning execution times to the free
variables.</p></li>
</ul>
<p>Before looking at the code of the <code class="docutils literal notranslate"><span class="pre">Inference</span></code> module, we consider
for illustrative purposes a simpler case study.</p>
<section id="case-study-constructing-the-matrices">
<span id="inference-case-study"></span><h3>Case study: constructing the matrices<a class="headerlink" href="#case-study-constructing-the-matrices" title="Link to this heading">#</a></h3>
<p>We’d like to model the execution time of an hypothetical piece of code
sorting an array using merge sort. We <em>know</em> that the time complexity of merge sort
is <span class="math notranslate nohighlight">\(O(n \log{n})\)</span> where <span class="math notranslate nohighlight">\(n\)</span> is the size of the array: we’re
interested in predicting the actual execution time as a function of
<span class="math notranslate nohighlight">\(n\)</span> for practical values of <span class="math notranslate nohighlight">\(n\)</span>.</p>
<p>We pick the following cost model:</p>
<div class="math notranslate nohighlight">
\[\text{cost}(n) = \theta_0 + \theta_1 \times n \log{n}\]</div>
<p>Our goal is to determine the parameters <span class="math notranslate nohighlight">\(\theta_0\)</span>
and <span class="math notranslate nohighlight">\(\theta_1\)</span>. Using the <a class="reference internal" href="#costlang-dsl"><span class="std std-ref">Costlang DSL</span></a>,
this model can be written as follows:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Cost_term</span> <span class="o">=</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">X</span> <span class="o">:</span> <span class="nn">Costlang</span><span class="p">.</span><span class="nc">S</span><span class="o">)</span> <span class="o">-&gt;</span>
<span class="k">struct</span>
  <span class="k">open</span> <span class="nc">X</span>
  <span class="k">let</span> <span class="n">cost_term</span> <span class="o">=</span>
    <span class="n">lam</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;n&quot;</span>
    <span class="o">@@</span> <span class="k">fun</span> <span class="n">n</span> <span class="o">-&gt;</span>
    <span class="n">free</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;theta0&quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">free</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;theta1&quot;</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">log2</span> <span class="n">n</span><span class="o">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Assuming we performed a set of benchmarks, we have a set of
timing measurements corresponding to pairs <span class="math notranslate nohighlight">\((n_i, t_i)_i\)</span>
where <span class="math notranslate nohighlight">\(n_i\)</span> and <span class="math notranslate nohighlight">\(t_i\)</span> correspond respectively to
the size of the array and the measured sorting time for the
<span class="math notranslate nohighlight">\(i\)</span> th benchmark.</p>
<p>By evaluating the model <span class="math notranslate nohighlight">\(cost\)</span> on each <span class="math notranslate nohighlight">\(n_i\)</span>, we get a
family of linear combinations <span class="math notranslate nohighlight">\(\theta_0 + \theta_1 \times n_i \log{n_i}\)</span>.
Each such linear combination is isomorphic to the vector
<span class="math notranslate nohighlight">\((1, n_i \log{n_i})\)</span>. These vectors correspond to the row vectors of
the matrix <span class="math notranslate nohighlight">\(A\)</span> and the durations <span class="math notranslate nohighlight">\(t_i\)</span> form the components of
the column vector <span class="math notranslate nohighlight">\(T\)</span>.</p>
<p>In terms of code, this corresponds to applying <span class="math notranslate nohighlight">\(n_i\)</span> to <code class="docutils literal notranslate"><span class="pre">cost_term</span></code>
and beta-reducing. The <code class="docutils literal notranslate"><span class="pre">Inference</span></code> module defines a hash-consing partial
evaluator <code class="docutils literal notranslate"><span class="pre">Eval_to_vector</span></code>:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Eval_to_vector</span> <span class="o">=</span> <span class="nc">Beta_normalize</span> <span class="o">(</span><span class="nc">Hash_cons</span> <span class="o">(</span><span class="nc">Eval_linear_combination_impl</span><span class="o">))</span>
</pre></div>
</div>
<p>All these operations (implemented in tagless final style) are defined in the
<code class="docutils literal notranslate"><span class="pre">Costlang</span></code> module. <code class="docutils literal notranslate"><span class="pre">Beta_normalize</span></code> beta-normalizes terms, <code class="docutils literal notranslate"><span class="pre">Hash_cons</span></code>
shares identical subterms and <code class="docutils literal notranslate"><span class="pre">Eval_linear_combination_impl</span></code> transforms an
evaluated term of the form
<code class="docutils literal notranslate"><span class="pre">free</span> <span class="pre">~name:&quot;theta0&quot;</span> <span class="pre">+</span> <span class="pre">(free</span> <span class="pre">~name:&quot;theta1&quot;</span> <span class="pre">*</span> <span class="pre">n_i</span> <span class="pre">*</span> <span class="pre">log2</span> <span class="pre">n_i)</span></code> into a vector
mapping <code class="docutils literal notranslate"><span class="pre">&quot;theta0&quot;</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">theta1</span></code> to <code class="docutils literal notranslate"><span class="pre">n_i</span> <span class="pre">*</span> <span class="pre">log2</span> <span class="pre">n_i</span></code>.</p>
<p>Applying <code class="docutils literal notranslate"><span class="pre">cost_term</span></code> to a constant <code class="docutils literal notranslate"><span class="pre">n_i</span></code> in tagless final form
corresponds to the following term:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Applied_cost_term</span> <span class="o">=</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">X</span> <span class="o">:</span> <span class="nn">Costlang</span><span class="p">.</span><span class="nc">S</span><span class="o">)</span> <span class="o">-&gt;</span>
<span class="k">struct</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">X</span><span class="p">.</span><span class="n">app</span> <span class="nc">Cost_term</span><span class="o">(</span><span class="nc">X</span><span class="o">).</span><span class="n">cost_term</span> <span class="o">(</span><span class="nn">X</span><span class="p">.</span><span class="n">int</span> <span class="n">n_i</span><span class="o">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>and performing the partial evaluation is done by applying
<code class="docutils literal notranslate"><span class="pre">Eval_to_vector</span></code>:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Evaluated_cost_term</span> <span class="o">=</span> <span class="nc">Applied_cost_term</span> <span class="o">(</span><span class="nc">Eval_to_vector</span><span class="o">)</span>
</pre></div>
</div>
<p>The value <code class="docutils literal notranslate"><span class="pre">Evaluated_cost_term.result</span></code> corresponds to the row vector
<span class="math notranslate nohighlight">\(i\)</span> of the matrix <span class="math notranslate nohighlight">\(A\)</span>.</p>
</section>
<section id="structure-of-the-inference-module">
<h3>Structure of the inference module<a class="headerlink" href="#structure-of-the-inference-module" title="Link to this heading">#</a></h3>
<p>We now describe in details the two main functionalities of the <code class="docutils literal notranslate"><span class="pre">Inference</span></code> module:</p>
<ul class="simple">
<li><p>making regression problems given a cost model and workload data;</p></li>
<li><p>solving regression problems.</p></li>
</ul>
<section id="making-regression-problems">
<h4>Making regression problems<a class="headerlink" href="#making-regression-problems" title="Link to this heading">#</a></h4>
<p>As explained in the <a class="reference internal" href="#inference-case-study"><span class="std std-ref">previous section</span></a>, a regression
problem corresponds to a pair of matrices <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(T\)</span>. This information
is packed in the <code class="docutils literal notranslate"><span class="pre">Inference.problem</span></code> type.</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">problem</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Non_degenerate</span> <span class="k">of</span> <span class="o">{</span>
      <span class="n">lines</span> <span class="o">:</span> <span class="n">constrnt</span> <span class="kt">list</span><span class="o">;</span>
      <span class="n">input</span> <span class="o">:</span> <span class="nn">Scikit</span><span class="p">.</span><span class="nn">Matrix</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
      <span class="n">output</span> <span class="o">:</span> <span class="nn">Scikit</span><span class="p">.</span><span class="nn">Matrix</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
      <span class="n">nmap</span> <span class="o">:</span> <span class="nn">NMap</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">|</span> <span class="nc">Degenerate</span> <span class="k">of</span> <span class="o">{</span><span class="n">predicted</span> <span class="o">:</span> <span class="nn">Scikit</span><span class="p">.</span><span class="nn">Matrix</span><span class="p">.</span><span class="n">t</span><span class="o">;</span> <span class="n">measured</span> <span class="o">:</span> <span class="nn">Scikit</span><span class="p">.</span><span class="nn">Matrix</span><span class="p">.</span><span class="n">t</span><span class="o">}</span>
</pre></div>
</div>
<p>Let’s look at the non-degenerate case.
The <code class="docutils literal notranslate"><span class="pre">input</span></code> field  corresponds to the <code class="docutils literal notranslate"><span class="pre">A</span></code> matrix while  the <code class="docutils literal notranslate"><span class="pre">output</span></code> field
corresponds to the <code class="docutils literal notranslate"><span class="pre">T</span></code> matrix. The <code class="docutils literal notranslate"><span class="pre">nmap</span></code> field is a bijective mapping
between the dimensions of the matrices and the variables of the original
problem. The <code class="docutils literal notranslate"><span class="pre">lines</span></code> field is an intermediate representation of the
problem, each value of type <code class="docutils literal notranslate"><span class="pre">constrnt</span></code> corresponding to a linear equation
in the variables:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">constrnt</span> <span class="o">=</span> <span class="nc">Full</span> <span class="k">of</span> <span class="o">(</span><span class="nn">Costlang</span><span class="p">.</span><span class="n">affine</span> <span class="o">*</span> <span class="n">quantity</span><span class="o">)</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">make_problem</span></code> converts a model and workload data (as obtained from
the <a class="reference internal" href="#measure-module"><span class="std std-ref">Measure module</span></a>) into an <code class="docutils literal notranslate"><span class="pre">Inference.problem</span></code>.
Let’s look at the signature of this function:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">make_problem</span> <span class="o">:</span>
  <span class="n">data</span><span class="o">:</span><span class="k">&#39;</span><span class="n">workload</span> <span class="nn">Measure</span><span class="p">.</span><span class="n">workload_data</span> <span class="o">-&gt;</span>
  <span class="n">model</span><span class="o">:</span><span class="k">&#39;</span><span class="n">workload</span> <span class="nn">Model</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span>
  <span class="n">overrides</span><span class="o">:(</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">float</span> <span class="n">option</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="n">problem</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">data</span></code> and <code class="docutils literal notranslate"><span class="pre">model</span></code> arguments are self-explanatory. The <code class="docutils literal notranslate"><span class="pre">overrides</span></code>
argument allows to manually set the value of a variable of the <code class="docutils literal notranslate"><span class="pre">model</span></code> to some
fixed value. This is especially useful when the value of a variable can be
determined from a separate set of experiments. The prototypical example is
how the timer latency is set (see the <a class="reference internal" href="snoop_example.html#fitting-the-model"><span class="std std-ref">snoop usage example</span></a>).</p>
<p>The job performed by <code class="docutils literal notranslate"><span class="pre">make_problem</span></code> essentially involves applying the cost model
to the workloads, as described in the previous section.</p>
</section>
<section id="solving-the-matrix-equation">
<h4>Solving the matrix equation<a class="headerlink" href="#solving-the-matrix-equation" title="Link to this heading">#</a></h4>
<p>Once we have a <code class="docutils literal notranslate"><span class="pre">problem</span></code> at hand, we can solve it using
the <code class="docutils literal notranslate"><span class="pre">solve_problem</span></code> function:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">solve_problem</span> <span class="o">:</span> <span class="n">problem</span> <span class="o">-&gt;</span> <span class="n">solver</span> <span class="o">-&gt;</span> <span class="n">solution</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">solver</span></code> describes the available optimization algorithms:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">solver</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Ridge</span> <span class="k">of</span> <span class="o">{</span><span class="n">alpha</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span> <span class="n">normalize</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">}</span>
  <span class="o">|</span> <span class="nc">Lasso</span> <span class="k">of</span> <span class="o">{</span><span class="n">alpha</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span> <span class="n">normalize</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span> <span class="n">positive</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">}</span>
  <span class="o">|</span> <span class="nc">NNLS</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Lasso</span></code> algorithm works well in practice. Setting the positivity
constraint to <code class="docutils literal notranslate"><span class="pre">true</span></code> forces the variables to lie in the positive reals.
At the time of writing, these are implemented as calls to the Python <code class="docutils literal notranslate"><span class="pre">Scikit-learn</span></code>
library. The <code class="docutils literal notranslate"><span class="pre">solution</span></code> type is defined as follows:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">solution</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">mapping</span> <span class="o">:</span> <span class="o">(</span><span class="nn">Free_variable</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="kt">float</span><span class="o">)</span> <span class="kt">list</span><span class="o">;</span>
  <span class="n">weights</span> <span class="o">:</span> <span class="nn">Scikit</span><span class="p">.</span><span class="nn">Matrix</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">weights</span></code> field correspond to the raw solution vector to the matrix
problem outlined earlier. The <code class="docutils literal notranslate"><span class="pre">mapping</span></code> associates the original variables
to their fit.</p>
</section>
</section>
<section id="parameter-inference-for-sets-of-benchmarks">
<h3>Parameter inference for sets of benchmarks<a class="headerlink" href="#parameter-inference-for-sets-of-benchmarks" title="Link to this heading">#</a></h3>
<p>As hinted before, benchmarks are not independent from one another:
one sometimes needs to perform a benchmark for a given piece of code,
estimate the cost of this piece of code using the inference module
and then inject the result into another inference problem. For short
chains of dependencies this is doable by hand, however when dealing with
e.g. more than one hundred Michelson instructions it nice to have an
automated tool figuring out the dependencies and scheduling the inference
automatically.</p>
<p><code class="docutils literal notranslate"><span class="pre">octez-snoop</span></code> features this. The <code class="docutils literal notranslate"><span class="pre">infer</span> <span class="pre">parameters</span></code> command is launched
in “full auto” mode when a <em>directory</em> is passed to it instead of a simple
workload file. The tool then automatically scans this directory for all
workload files, compute a dependency graph from the free variables and performs
a topological run over this dependency graph, computing at each step
the parameter fit and injecting the results in the subsequent inference
problems. The dependency graph computation can be found in the <code class="docutils literal notranslate"><span class="pre">Dep_graph</span></code>
module of <code class="docutils literal notranslate"><span class="pre">bin_snoop</span></code>.</p>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="snoop.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Benchmarking with Snoop</p>
      </div>
    </a>
    <a class="right-next"
       href="snoop_tutorial.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Snoop usage tutorial</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-description">High-level description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code-organization">Code organization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-benchmarks-the-generator-module">Defining benchmarks: the <code class="docutils literal notranslate"><span class="pre">Generator</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plain-benchmarks">Plain benchmarks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#with-context-benchmarks">With_context benchmarks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#with-probe-benchmarks">With_probe benchmarks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-predictive-model-the-model-module">Defining a predictive model: the <code class="docutils literal notranslate"><span class="pre">Model</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-models-a-primer">Linear models: a primer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-costlang-dsl">The <code class="docutils literal notranslate"><span class="pre">Costlang</span></code> DSL</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definition-of-cost-models-the-model-module">Definition of cost models: the <code class="docutils literal notranslate"><span class="pre">Model</span></code> module</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-measure-module">The <code class="docutils literal notranslate"><span class="pre">Measure</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-execution-time-of-generator-benchmark-values">Measuring execution time of <code class="docutils literal notranslate"><span class="pre">Generator.benchmark</span></code> values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-and-saving-benchmark-results">Loading and saving benchmark results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-outliers-from-benchmark-data">Removing outliers from benchmark data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-parameter-fits-the-inference-module">Computing parameter fits: the <code class="docutils literal notranslate"><span class="pre">Inference</span></code> module</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study-constructing-the-matrices">Case study: constructing the matrices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#structure-of-the-inference-module">Structure of the inference module</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#making-regression-problems">Making regression problems</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-the-matrix-equation">Solving the matrix equation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference-for-sets-of-benchmarks">Parameter inference for sets of benchmarks</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nomadic Labs <contact@nomadic-labs.com>
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2018-2023, Nomadic Labs &lt;contact@nomadic-labs.com&gt;.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>