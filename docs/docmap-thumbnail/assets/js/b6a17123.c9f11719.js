"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7620],{67074:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"tutorials/join-dal-baker/run-baker","title":"Step 4: Run an Octez baking daemon","description":"Now that you have a layer 1 node and a DAL node, you can run a baking daemon that can create blocks and attests to DAL data.","source":"@site/docs/tutorials/join-dal-baker/run-baker.md","sourceDirName":"tutorials/join-dal-baker","slug":"/tutorials/join-dal-baker/run-baker","permalink":"/previews/docs/docmap-thumbnail/tutorials/join-dal-baker/run-baker","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1740978000000,"frontMatter":{"title":"Step 4: Run an Octez baking daemon","authors":"Tezos core developers, Tim McMackin","last_update":{"date":"3 March 2025"}},"sidebar":"tutorialsSidebar","previous":{"title":"Step 3: Run an Octez DAL node","permalink":"/previews/docs/docmap-thumbnail/tutorials/join-dal-baker/run-dal-node"},"next":{"title":"Step 5: Verifications","permalink":"/previews/docs/docmap-thumbnail/tutorials/join-dal-baker/verify-rights"}}');var o=n(74848),a=n(28453);const r={title:"Step 4: Run an Octez baking daemon",authors:"Tezos core developers, Tim McMackin",last_update:{date:"3 March 2025"}},i=void 0,c={},l=[{value:"Upgrading the baker",id:"upgrading-the-baker",level:2},{value:"Backing up and restoring the baker",id:"backing-up-and-restoring-the-baker",level:2},{value:"Calculating the delay for attestation rights",id:"calculating-the-delay-for-attestation-rights",level:2},{value:"Optional: Run an accuser",id:"optional-run-an-accuser",level:2}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"Now that you have a layer 1 node and a DAL node, you can run a baking daemon that can create blocks and attests to DAL data.\nIf you already have a baking daemon, you can restart it to connect to the DAL node."}),"\n",(0,o.jsx)(t.admonition,{title:"Run one baker per account",type:"warning",children:(0,o.jsx)(t.p,{children:"Be sure to run only one baking daemon per Tezos account.\nIf you run more than one, you risk double-baking or double-attesting and being slashed.\nHowever, it is safe to run two baking daemons during the protocol upgrade process because one daemon uses the previous protocol and the other daemon uses the new protocol."})}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Optional: Set up a remote signer to secure the keys that the baker uses as described in ",(0,o.jsx)(t.a,{href:"https://octez.tezos.com/docs/user/key-management.html#signer",children:"Signer"})," in the Octez documentation."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Run a baking daemon with the following arguments:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Use the consensus key, not the baker key, if you are using a consensus key"}),"\n",(0,o.jsxs)(t.li,{children:["Pass the URL to your DAL node with the ",(0,o.jsx)(t.code,{children:"--dal-node"})," argument"]}),"\n",(0,o.jsxs)(t.li,{children:["Pass the ",(0,o.jsx)(t.code,{children:"--liquidity-baking-toggle-vote"})," argument; for more information, see ",(0,o.jsx)(t.a,{href:"https://octez.tezos.com/docs/active/liquidity_baking.html",children:"Liquidity baking"})," in the Octez documentation"]}),"\n",(0,o.jsxs)(t.li,{children:["Pass the ",(0,o.jsx)(t.code,{children:"--adaptive-issuance-vote"})," argument; for more information, see ",(0,o.jsx)(t.a,{href:"https://octez.tezos.com/docs/active/adaptive_issuance.html",children:"Adaptive issuance"})," in the Octez documentation"]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"For example:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'octez-baker-PsQuebec run with local node "$HOME/.tezos-node" consensus_key --liquidity-baking-toggle-vote pass --adaptive-issuance-vote on --dal-node http://127.0.0.1:10732\n'})}),"\n",(0,o.jsxs)(t.p,{children:["Note that the command for the baker depends on the protocol version.\nThis example uses the Quebec protocol, so the command starts with ",(0,o.jsx)(t.code,{children:"octez-baker-PsQuebec"}),".\nCheck the current version of the protocol to see what command to run, and change this command when you upgrade to newer versions of the protocol."]}),"\n",(0,o.jsxs)(t.p,{children:["You may append ",(0,o.jsx)(t.code,{children:'>>"$HOME/octez-baker.log" 2>&1'})," to redirect its output in a log file."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Ensure that the baker runs persistently.\nLook up how to run programs persistently in the documentation for your operating system."}),"\n",(0,o.jsxs)(t.p,{children:["For example, if your operating system uses the ",(0,o.jsx)(t.code,{children:"systemd"})," software suite, your service file might look like this example:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-systemd",metastring:'title="/etc/systemd/system/octez-baker-PsQuebec.service"',children:'[Unit]\nDescription=Octez baker PsQuebec\nWants=network-online.target\nAfter=network-online.target\nRequires=octez-node.service\n\n[Install]\nWantedBy=multi-user.target\n\n[Service]\nType=simple\nUser=tezos\nExecStart=octez-baker-PsQuebec run with local node "$HOME/.tezos-node" consensus_key --liquidity-baking-toggle-vote pass --adaptive-issuance-vote on --dal-node http://127.0.0.1:10732\nWorkingDirectory=/opt/octez-baker\nRestart=on-failure\nRestartSec=5\nStandardOutput=append:/opt/octez-baker.log\nStandardError=append:/opt/octez-baker.log\nSyslogIdentifier=%n\n'})}),"\n",(0,o.jsxs)(t.p,{children:["If you name this service file ",(0,o.jsx)(t.code,{children:"/etc/systemd/system/octez-baker-PsQuebec.service"}),", you can start it by running these commands:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"sudo systemctl daemon-reload\nsudo systemctl start octez-baker-PsQuebec.service\n"})}),"\n",(0,o.jsx)(t.p,{children:"You can stop it by running this command:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"sudo systemctl stop octez-baker-PsQuebec.service\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"In the same terminal window, run this command:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"curl http://localhost:10732/p2p/gossipsub/topics\n"})}),"\n",(0,o.jsx)(t.p,{children:"DAL nodes share shards and information about them over a peer-to-peer pub/sub network built on the Gossipsub P2P protocol.\nAs layer 1 assigns shards to the bakers, the Gossipsub network manages topics that DAL nodes can subscribe to.\nFor example, if a user submits data to slot 1, the network has a list of topics: a topic to identify the slot 1 shards assigned to baker A, a topic to identify the slot 1 shards assigned to baker B, and so on for all the bakers that are assigned shards from slot 1."}),"\n",(0,o.jsx)(t.p,{children:"Then, the baker daemon automatically asks the DAL node to subscribe to the topics that provide the shards that it is assigned to."}),"\n",(0,o.jsx)(t.p,{children:"In the results of this command, each topic contains a shard and the address of the baker that is assigned to it.\nThe DAL node and baker are listening to these topics and attesting that the data that they refer to is available."}),"\n",(0,o.jsxs)(t.p,{children:["This command returns all of the topics that the baker is subscribed to in the format ",(0,o.jsx)(t.code,{children:'{"slot_index":<index>,"pkh":"<ADDRESS OF BAKER>"}'})," where ",(0,o.jsx)(t.code,{children:"index"})," varies between ",(0,o.jsx)(t.code,{children:"0"})," included and the number of slot indexes excluded."]}),"\n",(0,o.jsx)(t.p,{children:"You can also look at the baker logs to see if it injects the expected operations. At each level, the baker is expected to do a subset of these operations:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:'Receive a block proposal (log message: "received new proposal ... at level ..., round ...")'}),"\n",(0,o.jsx)(t.li,{children:'Inject a preattestation for it (log message: "injected preattestation ... for my_baker (<address>) for level ..., round ...")'}),"\n",(0,o.jsx)(t.li,{children:'Receive a block (log message: "received new head ... at level ..., round ...")'}),"\n",(0,o.jsx)(t.li,{children:'Inject a consensus attestation for it (log message: "injected attestation ... for my_baker (<address>) for level ..., round ...")'}),"\n",(0,o.jsx)(t.li,{children:'Attach a DAL attestation to it, indicating which of the shards assigned to the baker have been seen on the DAL network (log message: "ready to attach DAL attestation for level ..., round ..., with bitset ... for my_baker (<address>) to attest slots published at level ...")'}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"upgrading-the-baker",children:"Upgrading the baker"}),"\n",(0,o.jsx)(t.p,{children:"The version of the baker program depends on the version of the Tezos protocol.\nTherefore, when a new version of the Tezos protocol becomes active, you must start the baker for the new protocol immediately."}),"\n",(0,o.jsx)(t.p,{children:"To simplify the upgrade process, you can follow these steps when the new protocol is about to be activated:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Check the release pages in the ",(0,o.jsx)(t.a,{href:"https://octez.tezos.com/docs",children:"Octez documentation"})," (section ",(0,o.jsx)(t.code,{children:"Changes in Octez releases"}),") or check the posts on the forum at ",(0,o.jsx)(t.a,{href:"https://forum.tezosagora.org",children:"https://forum.tezosagora.org"})," to see which version of the Octez suite supports the upcoming protocol and upgrade your Octez suite if necessary.\nThe Octez release page gives instructions for upgrading."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Leave the baker for the previous protocol running, such as the ",(0,o.jsx)(t.code,{children:"octez-baker-PsParisC"})," daemon."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Start the baker for the new protocol, such as the ",(0,o.jsx)(t.code,{children:"octez-baker-PsQuebec"})," daemon.\nThis daemon is not yet able to bake because it is using the future version of the protocol, but you can run it early without causing any problems.\nHowever, make sure not to run the baker twice ",(0,o.jsx)(t.strong,{children:"for the same protocol version and the same baker account"}),", to avoid being slashed for double signing."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"When the new version of the protocol becomes active, the previous protocol baker is no longer able to bake and the new protocol baker begins to bake automatically."}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Then you can stop the previous protocol baker."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"You can upgrade accusers with a similar process."}),"\n",(0,o.jsx)(t.h2,{id:"backing-up-and-restoring-the-baker",children:"Backing up and restoring the baker"}),"\n",(0,o.jsxs)(t.p,{children:["The Octez baking daemon stores persistent operational data in the Octez client's data directory, notably consensus high-water marks and ",(0,o.jsx)(t.a,{href:"https://octez.tezos.com/docs/active/randomness_generation.html",children:"random seed nonces"}),".\nIf you want to back up the baker or move it to another machine and restore it, you must copy the nonce file or files from the Octez client's data directory to the equivalent directory on the new machine.\nThese nonce files are named ",(0,o.jsx)(t.code,{children:"net<NETWORK_ID>_stateful_nonces"})," and ",(0,o.jsx)(t.code,{children:"net<NETWORK_ID>_nonces"}),", where ",(0,o.jsx)(t.code,{children:"<NETWORK_ID>"})," is the ID of the network, such as ",(0,o.jsx)(t.code,{children:"netXdQprcVkpaWU_stateful_nonces"})," for Mainnet or ",(0,o.jsx)(t.code,{children:"netXnHfVqm9ie_stateful_nonces"})," for Ghostnet.\nAll deployments have the ",(0,o.jsx)(t.code,{children:"net<NETWORK_ID>_stateful_nonces"})," file but only legacy baking deployments running versions of Octez prior to 20.0rc1 have the ",(0,o.jsx)(t.code,{children:"net<NETWORK_ID>_nonces"})," file."]}),"\n",(0,o.jsxs)(t.p,{children:["After you have moved the nonce files to the new machine and verified that the baker runs normally for one cycle, you can remove the legacy ",(0,o.jsx)(t.code,{children:"net<NETWORK_ID>_nonces"})," file."]}),"\n",(0,o.jsx)(t.h2,{id:"calculating-the-delay-for-attestation-rights",children:"Calculating the delay for attestation rights"}),"\n",(0,o.jsxs)(t.p,{children:["If you are setting up a new baker, you must wait until it receives attestation rights before it can bake blocks or attest to DAL data.\nThe delay to receive attestation rights is a number of cycles determined by the value of the ",(0,o.jsx)(t.code,{children:"consensus_rights_delay"})," constant.\nYou must wait until the end of the current cycle (represented below as ",(0,o.jsx)(t.code,{children:"remaining_current_cycle"}),") and then for this number of cycles to pass before the baker receives attestation rights."]}),"\n",(0,o.jsxs)(t.p,{children:["A cycle is a number of blocks; the ",(0,o.jsx)(t.code,{children:"blocks_per_cycle"})," constant determines how many blocks are in a cycle.\nThe ",(0,o.jsx)(t.code,{children:"minimal_block_delay"})," constant determines the time between blocks in seconds.\nTherefore, you can calculate the approximate time in seconds that it takes a baker to receive attestation rights with this formula:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"remaining_current_cycle + (consensus_rights_delay * blocks_per_cycle * minimal_block_delay)\n"})}),"\n",(0,o.jsx)(t.p,{children:"Follow these steps to calculate the delay to receive attestation rights:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Run these commands to get the values of the network constants:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"octez-client rpc get /chains/main/blocks/head/context/constants | jq | grep consensus_rights_delay\n"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"octez-client rpc get /chains/main/blocks/head/context/constants | jq | grep blocks_per_cycle\n"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"octez-client rpc get /chains/main/blocks/head/context/constants | jq | grep minimal_block_delay\n"})}),"\n",(0,o.jsxs)(t.p,{children:["You may need to install the ",(0,o.jsx)(t.code,{children:"jq"})," program to run these commands."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Using the values from the responses, calculate the attestation rights delay in seconds.\nFor example, if ",(0,o.jsx)(t.code,{children:"consensus_rights_delay"})," is 2, ",(0,o.jsx)(t.code,{children:"blocks_per_cycle"})," is 15,360, and ",(0,o.jsx)(t.code,{children:"minimal_block_delay"})," is 4, a new baker receives attestation rights after a delay of 122,880 seconds."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Divide the number of seconds by 86,400 to get the attestation delay in days.\nFor example, if the delay is 122,880 seconds, that time is about 1.4 days."}),"\n",(0,o.jsxs)(t.p,{children:["The exact time can be slightly longer because the ",(0,o.jsx)(t.code,{children:"minimal_block_delay"})," constant is the minimum time between blocks.\nIf the first baker chosen to bake a block does not bake it after a certain amount of time, other bakers have the opportunity to bake it, which increases the time between blocks."]}),"\n",(0,o.jsx)(t.admonition,{type:"note",children:(0,o.jsx)(t.p,{children:"The amount of tez that the account stakes determines how often it is called on to make attestations, not how quickly it receives rights.\nTherefore, staking more tez brings more rewards but does not reduce the attestation delay."})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Add the time remaining in the current cycle.\nFor example, you can go to ",(0,o.jsx)(t.a,{href:"https://tzkt.io/",children:"https://tzkt.io/"})," and click the network indicator at the top left of the page, as in this picture:"]}),"\n",(0,o.jsx)("img",{src:"/img/tutorials/tzkt-next-cycle.png",alt:"The TZKT block explorer, showing information about the current cycle",style:{width:300}}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["After the delay computed above has passed, ",(0,o.jsx)(t.strong,{children:"the baker log"})," (not the Octez node log, neither the DAL node log) should contain lines that look like this:"]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["Consensus pre-attestations: ",(0,o.jsx)(t.code,{children:"injected preattestation ..."})]}),"\n",(0,o.jsxs)(t.li,{children:["Consensus attestations: ",(0,o.jsx)(t.code,{children:"injected attestation ..."})]}),"\n",(0,o.jsxs)(t.li,{children:["Attach DAL attestations: ",(0,o.jsx)(t.code,{children:"ready to attach DAL attestation ..."})]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"These lines log the attestations that the baker makes."}),"\n",(0,o.jsxs)(t.p,{children:["If the baker does not have attestation rights, the log contains lines that start with ",(0,o.jsx)(t.code,{children:"The following delegates have no attesting rights at level ..."}),"."]}),"\n",(0,o.jsx)(t.p,{children:"Note that even though the baker daemon is using the consensus key, the attestations refer to the baker key.\nThe consensus key makes attestations on behalf of the baker key but the baking daemon does not need access to the baker key."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["After the attestation delay, whether or not you have attestation rights, proceed to ",(0,o.jsx)(t.a,{href:"/tutorials/join-dal-baker/verify-rights",children:"Step 5: Verifications"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"optional-run-an-accuser",children:"Optional: Run an accuser"}),"\n",(0,o.jsx)(t.p,{children:"The accuser is a daemon that monitors blocks and looks for problems, such as bakers who double-sign blocks or inject multiple attestations.\nIf it finds a problem, it posts a denunciation operation, which leads to penalizing the misbehaving baker.\nYou don't have to run an accuser, but if you do, you can receive as a reward part of the penalties of the denounced baker."}),"\n",(0,o.jsxs)(t.p,{children:["Like the baker, the command for the accuser has the protocol name at the end.\nFor example, if your operating system uses the ",(0,o.jsx)(t.code,{children:"systemd"})," software suite, the attester service file might look like this example:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-systemd",metastring:'title="/etc/systemd/system/octez-accuser-PsQuebec.service"',children:"[Unit]\nDescription=Octez accuser PsQuebec\nWants=network-online.target\nAfter=network-online.target\nRequires=octez-node.service\n\n[Install]\nWantedBy=multi-user.target\n\n[Service]\nType=simple\nUser=tezos\nExecStart=octez-accuser-PsQuebec run\nWorkingDirectory=/opt/octez-accuser\nRestart=on-failure\nRestartSec=5\nStandardOutput=append:/opt/octez-accuser.log\nStandardError=append:/opt/octez-accuser.log\nSyslogIdentifier=%n\n"})})]})}function d(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>i});var s=n(96540);const o={},a=s.createContext(o);function r(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);