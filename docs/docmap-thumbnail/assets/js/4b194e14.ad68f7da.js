"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4029],{49848:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>l,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"tutorials/build-files-archive-with-dal/publishing-on-the-dal","title":"Part 4: Publishing on the DAL","description":"Now that you can get information about the DAL, the next step is to publish data to it and verify that the kernel can access it.","source":"@site/docs/tutorials/build-files-archive-with-dal/publishing-on-the-dal.md","sourceDirName":"tutorials/build-files-archive-with-dal","slug":"/tutorials/build-files-archive-with-dal/publishing-on-the-dal","permalink":"/previews/docs/docmap-thumbnail/tutorials/build-files-archive-with-dal/publishing-on-the-dal","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1738645200000,"frontMatter":{"title":"Part 4: Publishing on the DAL","authors":"Tezos core developers, Tim McMackin","last_update":{"date":"4 February 2025"}},"sidebar":"tutorialsSidebar","previous":{"title":"Part 3: Getting slot information","permalink":"/previews/docs/docmap-thumbnail/tutorials/build-files-archive-with-dal/get-slot-info"},"next":{"title":"Part 5: Using the entire slot","permalink":"/previews/docs/docmap-thumbnail/tutorials/build-files-archive-with-dal/using-full-slot"}}');var o=n(74848),i=n(28453);const a={title:"Part 4: Publishing on the DAL",authors:"Tezos core developers, Tim McMackin",last_update:{date:"4 February 2025"}},l=void 0,r={},h=[{value:"Switching slots",id:"switching-slots",level:2},{value:"Publishing messages",id:"publishing-messages",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Publishing files",id:"publishing-files",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"Now that you can get information about the DAL, the next step is to publish data to it and verify that the kernel can access it."}),"\n",(0,o.jsx)(t.admonition,{title:"Planning ahead",type:"note",children:(0,o.jsxs)(t.p,{children:["Before trying to run the code yourself, look at ",(0,o.jsx)(t.a,{href:"https://explorus.io/dal",children:"Explorus"}),", select Ghostnet, and choose a slot that is not currently being used."]})}),"\n",(0,o.jsx)(t.p,{children:"The examples in this tutorial use slot 10.\nThroughout the rest of this tutorial, replace slot 10 with the number of the slot that you choose."}),"\n",(0,o.jsx)(t.h2,{id:"switching-slots",children:"Switching slots"}),"\n",(0,o.jsx)(t.p,{children:"When you have selected a slot that does not appear to be in use, follow these steps to restart the Smart Rollup and DAL node:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Stop the DAL node and restart it with a new ",(0,o.jsx)(t.code,{children:"--observer-profiles"})," argument.\nFor example, this command uses slot 10:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"octez-dal-node run --observer-profiles=10 --data-dir _dal_node\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["In the ",(0,o.jsx)(t.code,{children:"lib.rs"})," file, update the kernel to monitor that slot by updating this line:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-rust",children:"const SLOT_TO_MONITOR: u8 = 0;\n"})}),"\n",(0,o.jsx)(t.p,{children:"For example, to monitor slot 10, change the 0 to a 10, as in this code:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-rust",children:"const SLOT_TO_MONITOR: u8 = 10;\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Stop the Smart Rollup node and run the commands to build and deploy the Smart Rollup and start the node.\nYou can use the script in ",(0,o.jsx)(t.a,{href:"/tutorials/build-files-archive-with-dal/get-dal-params",children:"Part 2: Getting the DAL parameters"})," to simplify the process."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"publishing-messages",children:"Publishing messages"}),"\n",(0,o.jsxs)(t.p,{children:["The DAL node provides an RPC endpoint for clients to send data to be added to a slot: ",(0,o.jsx)(t.code,{children:"POST /slots"}),", whose body is the contents of the slot."]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Run this command to publish a message to the DAL:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"curl localhost:10732/slots --data '\"Hello, world!\"' -H 'Content-Type: application/json'\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Note that the value of the message is in double quotes because it must be a valid JSON string, as hinted by the ",(0,o.jsx)(t.code,{children:"Content-Type"})," header."]}),"\n",(0,o.jsx)(t.p,{children:"This command assumes that you have not changed the default RPC server address."}),"\n",(0,o.jsx)(t.p,{children:"The command returns the certificate from the DAL node, which looks like this example:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-json",children:'{\n  "commitment": "sh1u3tr3YKPDYUp2wWKCfmV5KZb82FREhv8GtDeR3EJccsBerWGwJYKufsDNH8rk4XqGrXdooZ",\n  "commitment_proof":"8229c63b8e858d9a96321c80a204756020dd13243621c11bec61f182a23714cf6e0985675fff45f1164657ad0c7b9418"\n}\n'})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Using the values of the commitment and proof from the previous command, post the certificate to layer 1 with this command, being sure to set the slot number that you are using and replacing ",(0,o.jsx)(t.code,{children:"my_wallet"})," with your Octez client alias of your address:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'commitment="sh1u3tr3YKPDYUp2wWKCfmV5KZb82FREhv8GtDeR3EJccsBerWGwJYKufsDNH8rk4XqGrXdooZ"\nproof="8229c63b8e858d9a96321c80a204756020dd13243621c11bec61f182a23714cf6e0985675fff45f1164657ad0c7b9418"\noctez-client publish dal commitment "${commitment}" from my_wallet for slot 10 with proof "${proof}"\n'})}),"\n",(0,o.jsx)(t.p,{children:"If the Octez client successfully published the commitment, the response to the command shows the slot number and the block (level) that it was published in.\nFor example, this response shows that the commitment is in level 7325485 in slot 10:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"Data availability slot header publishing:\nSlot: slot_index: 13, commitment: sh1u3tr3YKPDYUp2wWKCfmV5KZb82FREhv8GtDeR3EJccsBerWGwJYKufsDNH8rk4XqGrXdooZ\nThis data availability slot header publishing was successfully applied\nid:(published_level: 7325485, index: 10), commitment: sh1u3tr3YKPDYUp2wWKCfmV5KZb82FREhv8GtDeR3EJccsBerWGwJYKufsDNH8rk4XqGrXdooZ\nConsumed gas: 1331.033\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Note the value of the ",(0,o.jsx)(t.code,{children:"published_level"})," field in the response and look for that block number on ",(0,o.jsx)(t.a,{href:"https://explorus.io/dal",children:"Explorus"}),".\nThe slot that you published the message to turns blue, as in this picture:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"The Explorus record of slots in use, showing slot 10 in use",src:n(46279).A+"",width:"716",height:"83"})}),"\n",(0,o.jsx)(t.p,{children:"The blue slot means that data was published to the slot but has not been attested yet."}),"\n",(0,o.jsx)(t.p,{children:"After 8 blocks, the slot turns green if bakers attested to the availability of the data or red if they did not."}),"\n",(0,o.jsx)(t.p,{children:"If the slot turns green, you should see a message in the kernel log that looks like this:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"RollupDalParameters { number_of_slots: 32, attestation_lag: 8, slot_size: 126944, page_size: 3967 }\nAttested slot at index 10 for level 7325485: [72, 101, 108, 108, 111, 44, 32, 119, 111, 114]\nSee you in the next level\n"})}),"\n",(0,o.jsx)(t.p,{children:'You can verify your message by converting the bytes in the message back to the first 10 characters of the string "Hello, World!"'}),"\n",(0,o.jsxs)(t.p,{children:["You can also access the data from the DAL node by running this command, where ",(0,o.jsx)(t.code,{children:"<PUBLISHED_LEVEL>"})," is the level that you published the data in and ",(0,o.jsx)(t.code,{children:"<SLOT_INDEX>"})," is the slot that you used:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"curl localhost:10732/levels/<PUBLISHED_LEVEL>/slots/<SLOT_INDEX>/content | more\n"})}),"\n",(0,o.jsxs)(t.p,{children:["This RPC endpoint returns the full contents of the slot, padded with zeros to the standard size of DAL slots on that network.\nYou can copy the contents, omitting the zeros, and use a hexadecimal to string conversion tool to convert it back to a string.\nOnline tools can convert hex to string, or you can use the ",(0,o.jsx)(t.code,{children:"xxd"})," program, as in this example, which returns ",(0,o.jsx)(t.code,{children:"Hello, world!"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"echo -n '48656c6c6f2c20776f726c6421'  | xxd -r -p\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,o.jsx)(t.p,{children:"If you don't see the message that the slot is attested and contains your data, try these things:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:'If you see a message that says "A slot header for this slot was already proposed," another transaction tried to write to that slot in the same block, so you must try again.'}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Make sure that the Smart Rollup and the DAL node are both using the slot that you published the commitment to:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["In the file ",(0,o.jsx)(t.code,{children:"lib/src.rs"}),", the line ",(0,o.jsx)(t.code,{children:"const SLOT_TO_MONITOR: u8 = 10;"})," should use your slot."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["When you run the command to start the DAL node, make sure that the ",(0,o.jsx)(t.code,{children:"--observer-profiles"})," argument is set to your slot:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"octez-dal-node run --observer-profiles=10 --data-dir _dal_node\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"When you run the command to publish the commitment to the DAL, make sure that you publish it to your slot:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'octez-client publish dal commitment "${commitment}" \\\n  from my_wallet for slot 10 with proof "${proof}"\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"If the slot turned red on Explorus, these things may have happened:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["The attesters could not download the data to attest it.\nThis can happen if your DAL node is misconfigured and did not share the data with other DAL nodes.\nVerify that your DAL node is accessible from outside your local network and that it is running with the correct arguments.\nFor example, DAL nodes can fail to share the data if they are configured with an attester configuration but are not connected to a baker with attestation rights.\nYou can try deleting the DAL node configuration and restarting the node with the correct ",(0,o.jsx)(t.code,{children:"--observer-profiles"})," argument."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["The attesters for the network are offline.\nIn this case, your Smart Rollup cannot use the data on the DAL, but the blue slot in Explorus verifies that you published it successfully.\nWithout active attesters, you cannot continue with this tutorial.\nYou can try running your own attester by getting tez from the faucet and running a baker as described in ",(0,o.jsx)(t.a,{href:"/tutorials/join-dal-baker",children:"Join the DAL as a baker, in 5 steps"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"publishing-files",children:"Publishing files"}),"\n",(0,o.jsxs)(t.p,{children:["You can also send raw bytes to the DAL node with the header ",(0,o.jsx)(t.code,{children:"Content-Type: application/octet-stream"}),".\nIn this case, you must prefix the data with its size due to limitations of the DAL."]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Install the ",(0,o.jsx)(t.code,{children:"jq"})," and ",(0,o.jsx)(t.code,{children:"xxd"})," programs.\nIf you are using the Tezos Docker image, you can run ",(0,o.jsx)(t.code,{children:"sudo apk add jq xxd"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Create a file named ",(0,o.jsx)(t.code,{children:"upload_file.sh"})," and add this code:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'#!/bin/sh\n\npath="${1}"\nalias="${2}"\nindex="${3}"\n\ntarget="$(mktemp)"\necho "storing temporary file at ${target}"\nfile_size="$(cat "${path}" | wc -c)"\nslot_size_bin="$(printf "%08x" "${file_size}")"\nslot_contents="$(cat ${path} | xxd -p)"\n\necho -n "${slot_size_bin}${slot_contents}" | xxd -p -r > "${target}"\n\ncertificate="$(curl localhost:10732/slots --data-binary "@${target}" -H \'Content-Type: application/octet-stream\')"\n\necho "${certificate}"\n\ncommitment="$(echo -n ${certificate} | jq \'.commitment\' -r)"\nproof="$(echo -n ${certificate} | jq \'.commitment_proof\' -r)"\n\noctez-client publish dal commitment "${commitment}" \\\n    from "${alias}" for slot "${index}" with proof "${proof}"\n\nrm "${target}"\n'})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Make the script executable by running this command:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"chmod +x upload_file.sh\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Try uploading a file with the script."}),"\n",(0,o.jsxs)(t.p,{children:["The script accepts three arguments: the file to send, the account alias to use and the slot index to use.\nThis script also assumes that the ",(0,o.jsx)(t.code,{children:"PATH"})," environment variable is correctly set.\nFor example, if you create a file named ",(0,o.jsx)(t.code,{children:"myFile.txt"})," and are using slot 10, you can run this command:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"./upload_file.sh myFile.txt my_wallet 10\n"})}),"\n",(0,o.jsxs)(t.p,{children:["If you run this script and see an error that says that the file was not found, update the first line of the script (the shebang) to the path to your shell interpreter.\nFor example, if you are using the Tezos Docker image, the path is ",(0,o.jsx)(t.code,{children:"/bin/sh"}),"."]}),"\n",(0,o.jsx)(t.p,{children:"In the next section, you see how to get the contents of the file that you published."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["Now you can publish data to the DAL and use it in a Smart Rollup.\nIn the next section, you write to and retrieve the entire slot.\nWhen you are ready, go to ",(0,o.jsx)(t.a,{href:"/tutorials/build-files-archive-with-dal/using-full-slot",children:"Part 5: Using the entire slot"}),"."]})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},46279:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/dal-explorus-blue-slot-bf9ef14af345412da97b9cc187bedec9.png"},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>l});var s=n(96540);const o={},i=s.createContext(o);function a(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);