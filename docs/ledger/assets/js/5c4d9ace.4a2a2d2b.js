"use strict";(self.webpackChunktezos_developer_docs=self.webpackChunktezos_developer_docs||[]).push([[8125],{50510:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>r,default:()=>c,frontMatter:()=>l,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"architecture/data-availability-layer","title":"The Data Availability Layer","description":"The Data Availability Layer (DAL) is a companion peer-to-peer network for the Tezos blockchain, designed to provide additional data bandwidth to Smart Rollups.","source":"@site/docs/architecture/data-availability-layer.md","sourceDirName":"architecture","slug":"/architecture/data-availability-layer","permalink":"/previews/docs/ledger/architecture/data-availability-layer","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1729137600000,"frontMatter":{"title":"The Data Availability Layer","authors":"Tim McMackin","last_update":{"date":"17 October 2024"}},"sidebar":"documentationSidebar","previous":{"title":"Smart Rollups","permalink":"/previews/docs/ledger/architecture/smart-rollups"},"next":{"title":"Governance and self-amendment","permalink":"/previews/docs/ledger/architecture/governance"}}');var s=a(74848),i=a(28453);const l={title:"The Data Availability Layer",authors:"Tim McMackin",last_update:{date:"17 October 2024"}},r=void 0,o={},d=[{value:"Running DAL nodes",id:"running-dal-nodes",level:2},{value:"How the DAL works",id:"how-the-dal-works",level:2},{value:"Data structure",id:"data-structure",level:2},{value:"Getting the DAL parameters",id:"getting-the-dal-parameters",level:2},{value:"Sending data to the DAL",id:"sending-data-to-the-dal",level:2},{value:"Getting data from the DAL",id:"getting-data-from-the-dal",level:2},{value:"Reference",id:"reference",level:2}];function h(e){const t={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"The Data Availability Layer (DAL) is a companion peer-to-peer network for the Tezos blockchain, designed to provide additional data bandwidth to Smart Rollups.\nIt allows users to share large amounts of data in a way that is decentralized and permissionless, because anyone can join the network and post and read data on it."}),"\n",(0,s.jsxs)(t.p,{children:["For a tutorial on how to use the DAL, see ",(0,s.jsx)(t.a,{href:"/tutorials/build-files-archive-with-dal",children:"Implement a file archive with the DAL and a Smart Rollup"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"running-dal-nodes",children:"Running DAL nodes"}),"\n",(0,s.jsx)(t.p,{children:"The DAL depends on individual people running nodes, just like Tezos layer 1."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If you are already a Tezos baker, you can add a DAL node to your setup with the instructions in ",(0,s.jsx)(t.a,{href:"https://tezos.gitlab.io/shell/dal_run.html",children:"Running a DAL attester node"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["For step-by-step instructions on running a DAL node, accessible to anyone, see ",(0,s.jsx)(t.a,{href:"/tutorials/join-dal-baker",children:"Join the DAL as a baker in 5 steps"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"how-the-dal-works",children:"How the DAL works"}),"\n",(0,s.jsx)(t.p,{children:"The DAL relies on a network of DAL nodes that distribute data via a peer-to-peer network.\nLayer 1 bakers verify that the data is available.\nAfter the bakers attest that the data is available, the DAL nodes provide the data to Smart Rollups.\nSmart Rollups that need the data must use it or store it promptly, because it is available only temporarily on the DAL."}),"\n",(0,s.jsx)(t.p,{children:"The DAL works like this:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Users post data to a DAL node."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"The DAL node returns a certificate, which includes two parts:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.em,{children:"commitment"})," is like a hash of the data but has the additional ability to identify individual shards of the data and reconstruct the original data from a certain percentage of the shards.\nThe number of shards needed depends on how the data is spread across shards, which is controlled by a parameter called the ",(0,s.jsx)(t.em,{children:"redundancy factor"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.em,{children:"proof"})," certifies the length of the data to prevent malicious users from overloading the layer with data."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Users post the certificate to Tezos layer 1 via the Octez client."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"When the certificate is confirmed in a block, the DAL splits the data into shards and shares it through the peer-to-peer network."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Layer 1 assigns the shards to bakers."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Bakers verify that they are able to download the shards that they are assigned to."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Bakers attest that the data is available in their usual block attestations to layer 1."}),"\n",(0,s.jsxs)(t.p,{children:["Each Tezos network has a delay of a certain number of blocks known as the ",(0,s.jsx)(t.em,{children:"attestation lag"}),".\nThis number of blocks determines when bakers attest that the data is available, so that the data is made available to Smart Rollups.\nFor example, if a certificate is included in level 100 and the attestation lag is 4, bakers must attest that the data is available in level 104, along with their usual attestations that build on level 103."]}),"\n",(0,s.jsx)(t.p,{children:"If enough shards are attested in that level, the data becomes available to Smart Rollups at the end of layer 104.\nIf not enough shards are attested in that level, the certificate is considered bogus and the related data is dropped."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"The Smart Rollup node monitors the blocks and when it sees attested DAL data, it connects to a DAL node to request the data.\nSmart Rollups must store the data if they need it because it is available on the DAL for only a short time."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"The overall workflow is summarized in the following figure:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Overall diagram of the workflow of the Data Availability Layer",src:a(59490).A+"",width:"1160",height:"777"})}),"\n",(0,s.jsx)(t.h2,{id:"data-structure",children:"Data structure"}),"\n",(0,s.jsxs)(t.p,{children:["Internally, the Data Availability Layer stores information about the available data in layer 1 blocks.\nEach block has several byte-vectors called ",(0,s.jsx)(t.em,{children:"slots"}),", each with a maximum size.\nDAL users can add information about the available data as ",(0,s.jsx)(t.em,{children:"pages"})," in these slots, as shown in this figure:"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Two example blocks with different DAL slots in use in each",src:a(16557).A+"",width:"1820",height:"820"})}),"\n",(0,s.jsx)(t.p,{children:"The data in a slot is broken into pages to ensure that each piece of data can fit in a single Tezos operation.\nThis data must fit in a single operation to allow the Smart Rollup refutation game to work, in which every execution step of the Smart Rollup must be provable to layer 1."}),"\n",(0,s.jsx)(t.p,{children:"When clients publish data, they must specify which slot to add it to.\nNote that because the DAL is permissionless, clients may try to add data to the same slot in the same block.\nIn this case, the first operation in the block takes precedence, which leaves the baker that creates the block in control of which data makes it into the block.\nOther operations that try to add data to the same slot fail."}),"\n",(0,s.jsx)(t.p,{children:"The number and size of these slots can change.\nDifferent networks can have different DAL parameters.\nFuture changes to the protocol may allow the DAL to resize slots dynamically based on usage."}),"\n",(0,s.jsx)(t.h2,{id:"getting-the-dal-parameters",children:"Getting the DAL parameters"}),"\n",(0,s.jsxs)(t.p,{children:["Clients can get information about the current DAL parameters from the RPC endpoint ",(0,s.jsx)(t.code,{children:"GET /chains/main/blocks/head/context/constants"})," or the Smart Rollup kernel SDK function ",(0,s.jsx)(t.code,{children:"reveal_dal_parameters"}),".\nThese parameters include:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"number_of_slots"}),": The maximum number of slots in each block"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"slot_size"}),": The size of each slot in bytes"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"page_size"}),": The size of each page in bytes"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"attestation_lag"}),": The number of blocks after a certificate is published when bakers attest that the data is available; if enough attestations are available in this block, the data becomes available to Smart Rollups"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"redundancy_factor"}),": How much redundancy is used to split the data into shards; for example, a redundancy factor of 2 means that half of all shards are enough to reconstruct the original data and a redundancy factor of 4 means that 25% of all shards are required"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"sending-data-to-the-dal",children:"Sending data to the DAL"}),"\n",(0,s.jsx)(t.p,{children:"Sending data to the DAL is a two-step process:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Send the data to a DAL node by passing it to its ",(0,s.jsx)(t.code,{children:"POST /slot"})," endpoint, as in this example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"curl -X POST http://dal-node.example.com:10732/slot --data '\"Hello, world!\"' -H 'Content-Type: application/json'\n"})}),"\n",(0,s.jsx)(t.p,{children:"The DAL node returns the commitment and proof of the data, as in this abbreviated example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "commitment": "sh1u3tr3YKPDY",\n  "commitment_proof": "8229c63b8e858d9a9"\n}\n'})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Send an operation to include the commitment and proof in a block by running this Octez client command, where ",(0,s.jsx)(t.code,{children:"$ENDPOINT"})," is an RPC endpoint served by a layer 1 node and ",(0,s.jsx)(t.code,{children:"$MY_ACCOUNT"})," is an account alias or address:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'commitment="sh1u3tr3YKPDY"\nproof="8229c63b8e858d9a9"\noctez-client --endpoint ${ENDPOINT} \\\n  publish dal commitment "${commitment}" from ${MY_ACCOUNT} for slot 10 \\\n  with proof "${proof}"\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["For an example of sending larger amounts of data, see ",(0,s.jsx)(t.a,{href:"/tutorials/build-files-archive-with-dal",children:"Implement a file archive with the DAL and a Smart Rollup"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"getting-data-from-the-dal",children:"Getting data from the DAL"}),"\n",(0,s.jsxs)(t.p,{children:["Smart Rollups can use data from the DAL ",(0,s.jsx)(t.strong,{children:"only after it has been attested by the bakers"}),".\nDue to the attestation lag, they cannot access DAL data published in the current level, because not enough blocks have elapsed to allow bakers to attest the data."]}),"\n",(0,s.jsxs)(t.p,{children:["The most recent level in the past that Smart Rollups can access data from is the current level minus the attestation lag.\nThey can access the data in that level with the Smart Rollup kernel SDK function ",(0,s.jsx)(t.code,{children:"reveal_dal_page"}),", which accepts the target level, slot, and page to receive, as in this example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:'let param = host.reveal_dal_parameters();\n\nlet sol = host.read_input()?.unwrap();\n\nlet target_level = sol.level as usize - param.attestation_lag as usize;\n\nlet mut buffer = vec![0u8; param.page_size as usize];\n\nlet bytes_read = host.reveal_dal_page(target_level as i32, slot_index, 0, &mut buffer)?;\n\nif 0 < bytes_read {\n    debug_msg!(\n        host,\n        "Attested slot at index {} for level {}: {:?}\\n",\n        slot_index,\n        target_level,\n        &buffer.as_slice()[0..10]\n    );\n} else {\n    debug_msg!(\n        host,\n        "No attested slot at index {} for level {}\\n",\n        slot_index,\n        target_level\n    );\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"reference",children:"Reference"}),"\n",(0,s.jsxs)(t.p,{children:["For more information about the DAL, see ",(0,s.jsx)(t.a,{href:"https://tezos.gitlab.io/shell/dal_overview.html",children:"DAL overview"})," in the Octez documentation."]})]})}function c(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},16557:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/dal-slots-in-blocks-2e9eb68ec209cd840e938d4aa57eb8c1.png"},59490:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/dal-workflow-4b209de08921bf53644411af3c486093.png"},28453:(e,t,a)=>{a.d(t,{R:()=>l,x:()=>r});var n=a(96540);const s={},i=n.createContext(s);function l(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);