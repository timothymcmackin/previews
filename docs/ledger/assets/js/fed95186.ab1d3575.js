"use strict";(self.webpackChunktezos_developer_docs=self.webpackChunktezos_developer_docs||[]).push([[325],{58769:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>r,default:()=>c,frontMatter:()=>l,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"tutorials/build-files-archive-with-dal/get-slot-info","title":"Part 3: Getting slot information","description":"When clients send data to the DAL, they must choose which slot to put it in.","source":"@site/docs/tutorials/build-files-archive-with-dal/get-slot-info.md","sourceDirName":"tutorials/build-files-archive-with-dal","slug":"/tutorials/build-files-archive-with-dal/get-slot-info","permalink":"/previews/docs/ledger/tutorials/build-files-archive-with-dal/get-slot-info","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1707886800000,"frontMatter":{"title":"Part 3: Getting slot information","authors":"Tezos Core Developers","last_update":{"date":"14 February 2024"}},"sidebar":"tutorialsSidebar","previous":{"title":"Part 2: Getting the DAL parameters","permalink":"/previews/docs/ledger/tutorials/build-files-archive-with-dal/get-dal-params"},"next":{"title":"Part 3: Publishing on the DAL","permalink":"/previews/docs/ledger/tutorials/build-files-archive-with-dal/publishing-on-the-dal"}}');var o=n(74848),a=n(28453);const l={title:"Part 3: Getting slot information",authors:"Tezos Core Developers",last_update:{date:"14 February 2024"}},r=void 0,i={},d=[{value:"Starting a DAL node",id:"starting-a-dal-node",level:2},{value:"Accessing the slot data from a Smart Rollup",id:"accessing-the-slot-data-from-a-smart-rollup",level:2}];function h(e){const t={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"When clients send data to the DAL, they must choose which slot to put it in.\nThis can cause conflicts, because only one client can write data to a given slot in a single block.\nIf more than one client tries to write to the same slot and a baker includes those operations in the same block, only the first operation in the block succeeds in writing data to the slot.\nThe other operations fail and the clients must re-submit the data to be included in a future block."}),"\n",(0,o.jsx)(t.p,{children:"For this reason, clients should check the status of slots to avoid conflicts.\nFor example, slots 0, 30, and 31 are often used for regression tests."}),"\n",(0,o.jsxs)(t.p,{children:["To see which slots are in use, you can use the Explorus indexer at ",(0,o.jsx)(t.a,{href:"https://explorus.io/dal",children:"https://explorus.io/dal"})," and select Weeklynet.\nFor example, this screenshot shows that slots 10 and 25 are in use:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"The Explorus indexer, showing the slots that are in use in each block",src:n(29897).A+"",width:"1458",height:"568"})}),"\n",(0,o.jsx)(t.p,{children:"You can also see the state of the DAL slots by running a DAL node.\nTo reduce the amount of data that they have to manage, DAL nodes can subscribe to certain slots and ignore the data in others.\nSimilarly, the protocol assigns bakers to monitor certain slots."}),"\n",(0,o.jsx)(t.h2,{id:"starting-a-dal-node",children:"Starting a DAL node"}),"\n",(0,o.jsxs)(t.p,{children:["To run a DAL node, use the Octez ",(0,o.jsx)(t.code,{children:"octez-dal-node"})," command and pass the slots to monitor in the ",(0,o.jsx)(t.code,{children:"--producer-profiles"})," argument."]}),"\n",(0,o.jsx)(t.p,{children:"Run this command to start a DAL node and monitor slot 0:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"octez-dal-node run --endpoint ${ENDPOINT} \\\n    --producer-profiles=0 --data-dir _dal_node\n"})}),"\n",(0,o.jsx)(t.p,{children:"Leave this process running in terminal window."}),"\n",(0,o.jsx)(t.h2,{id:"accessing-the-slot-data-from-a-smart-rollup",children:"Accessing the slot data from a Smart Rollup"}),"\n",(0,o.jsx)(t.p,{children:"Follow these steps to update the Smart Rollup to access information about slot 0:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Update the ",(0,o.jsx)(t.code,{children:"src/lib.rs"})," file to have this code:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-rust",children:'use tezos_smart_rollup::{host::RuntimeError, kernel_entry, prelude::*};\nuse tezos_smart_rollup_host::dal_parameters::RollupDalParameters;\n\nconst SLOT_TO_MONITOR: u8 = 0;\n\npub fn run<R: Runtime>(\n    host: &mut R,\n    param: &RollupDalParameters,\n    slot_index: u8,\n) -> Result<(), RuntimeError> {\n    let sol = host.read_input()?.unwrap();\n\n    let target_level = sol.level as usize - param.attestation_lag as usize;\n\n    let mut buffer = vec![0u8; param.page_size as usize];\n\n    let bytes_read = host.reveal_dal_page(target_level as i32, slot_index, 0, &mut buffer)?;\n\n    if 0 < bytes_read {\n        debug_msg!(\n            host,\n            "Attested slot at index {} for level {}: {:?}\\n",\n            slot_index,\n            target_level,\n            &buffer.as_slice()[0..10]\n        );\n    } else {\n        debug_msg!(\n            host,\n            "No attested slot at index {} for level {}\\n",\n            slot_index,\n            target_level\n        );\n    }\n\n    Ok(())\n}\n\npub fn entry<R: Runtime>(host: &mut R) {\n    let param = host.reveal_dal_parameters();\n    debug_msg!(host, "{:?}\\n", param);\n\n    match run(host, &param, SLOT_TO_MONITOR) {\n        Ok(()) => debug_msg!(host, "See you in the next level\\n"),\n        Err(_) => debug_msg!(host, "Something went wrong for some reasons"),\n    }\n}\n\nkernel_entry!(entry);\n'})}),"\n",(0,o.jsxs)(t.p,{children:["The key change is the addition of the function ",(0,o.jsx)(t.code,{children:"run"}),".\nUsing this function allows the code to use the ",(0,o.jsx)(t.code,{children:"?"})," operator of Rust by using a function that returns a ",(0,o.jsx)(t.code,{children:"Result"})," type."]}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.code,{children:"run"})," function proceeds as follows:"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsx)(t.li,{children:"First, it uses the DAL parameters to know the first level where a slot might be used.\nIt subtracts the attestation lag from the current level, which it gets from the Smart Rollup inbox; the result is the most recent block that may have attested data in it."}),"\n",(0,o.jsxs)(t.li,{children:["It allocates ",(0,o.jsx)(t.code,{children:"Vec<u8>"})," buffer of the current page size."]}),"\n",(0,o.jsxs)(t.li,{children:["It attempts to fill the buffer with the ",(0,o.jsx)(t.code,{children:"read_dal_page"})," function provided\nby the SDK."]}),"\n",(0,o.jsx)(t.li,{children:"It checks the value returned by the function, which is the number of bytes\nread.\nZero bytes mean that the slot has no attested data in it.\nOtherwise, it is necessarily the size of the page, because that's the size of the buffer."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Update the ",(0,o.jsx)(t.code,{children:"Cargo.toml"})," file to add this dependency at the end:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-toml",children:'tezos-smart-rollup-host = { version = "0.2.2", features = [ "proto-alpha" ] }\n'})}),"\n",(0,o.jsx)(t.p,{children:"The end of the file looks like this:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-toml",children:'[dependencies]\ntezos-smart-rollup = { version = "0.2.2", features = [ "proto-alpha" ] }\ntezos-smart-rollup-host = { version = "0.2.2", features = [ "proto-alpha" ] }\n'})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Stop the Smart Rollup process."}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Run the commands to build and deploy the Smart Rollup and start the node."}),"\n",(0,o.jsxs)(t.p,{children:["If you set up the deployment script as described in ",(0,o.jsx)(t.a,{href:"/tutorials/build-files-archive-with-dal/get-dal-params",children:"Part 2: Getting the DAL parameters"}),", you can run ",(0,o.jsx)(t.code,{children:"./deploy_smart_rollup.sh $MY_ACCOUNT"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["If not, run these commands, using your account alias for ",(0,o.jsx)(t.code,{children:"MY_ACCOUNT"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'rm -rf _rollup_node\ncargo build --release --target wasm32-unknown-unknown\ncp target/wasm32-unknown-unknown/release/files_archive.wasm .\n\nsmart-rollup-installer get-reveal-installer -P _rollup_node/wasm_2_0_0 \\\n  -u files_archive.wasm -o installer.hex\n\noctez-client --endpoint ${ENDPOINT} \\\n  originate smart rollup files_archive from "${MY_ACCOUNT}" of kind wasm_2_0_0 \\\n  of type unit with kernel "$(cat installer.hex)" --burn-cap 2.0 --force\n\noctez-smart-rollup-node --endpoint ${ENDPOINT} \\\n  run observer for files_archive with operators --data-dir _rollup_node \\\n  --dal-node http://localhost:10732 --log-kernel-debug\n'})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["In another terminal window, view the log with the command ",(0,o.jsx)(t.code,{children:"tail -F _rollup_node/kernel.log"}),"."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"The log shows information about slot 0, as in this example:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"RollupDalParameters { number_of_slots: 32, attestation_lag: 4, slot_size: 65536, page_size: 4096 }\nNo attested slot at index 0 for level 56875\nSee you in the next level\nRollupDalParameters { number_of_slots: 32, attestation_lag: 4, slot_size: 65536, page_size: 4096 }\nAttested slot at index 0 for level 56876: [16, 0, 0, 2, 89, 87, 0, 0, 0, 0]\nSee you in the next level\nRollupDalParameters { number_of_slots: 32, attestation_lag: 4, slot_size: 65536, page_size: 4096 }\nNo attested slot at index 0 for level 56877\nSee you in the next level\n"})}),"\n",(0,o.jsxs)(t.p,{children:["For the first 4 Tezos blocks produced after the origination of the Smart Rollup, the kernel will report that no slot has been attested for the targeted level, ",(0,o.jsx)(t.em,{children:"even if Explorus states the opposite"}),".\nThis is because, as of January, 2024, a Smart Rollup cannot fetch the content of a slot published before it is originated.\nThis is why you must wait for 4 blocks before seeing slot page contents being\nlogged."]}),"\n",(0,o.jsxs)(t.p,{children:["Now that you can see the state of the slots, you can find an unused slot and publish data to it.\nWhen you are ready, continue to ",(0,o.jsx)(t.a,{href:"/tutorials/build-files-archive-with-dal/publishing-on-the-dal",children:"Part 3: Publishing on the DAL"}),"."]})]})}function c(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},29897:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/dal-explorus-slots-4dae5df5469d54358653942b0ec4095c.png"},28453:(e,t,n)=>{n.d(t,{R:()=>l,x:()=>r});var s=n(96540);const o={},a=s.createContext(o);function l(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);