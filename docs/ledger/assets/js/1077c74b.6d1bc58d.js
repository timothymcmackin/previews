"use strict";(self.webpackChunktezos_developer_docs=self.webpackChunktezos_developer_docs||[]).push([[1458],{91106:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"unity/managing-contracts","title":"Managing contracts","description":"Smart contracts are backend programs that run on the Tezos blockchains.","source":"@site/docs/unity/managing-contracts.md","sourceDirName":"unity","slug":"/unity/managing-contracts","permalink":"/previews/docs/ledger/unity/managing-contracts","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1702875600000,"frontMatter":{"title":"Managing contracts","authors":"Tim McMackin","last_update":{"date":"18 December 2023"}},"sidebar":"documentationSidebar","previous":{"title":"Connecting accounts","permalink":"/previews/docs/ledger/unity/connecting-accounts"},"next":{"title":"Managing tokens","permalink":"/previews/docs/ledger/unity/managing-tokens"}}');var a=t(74848),o=t(28453);const s={title:"Managing contracts",authors:"Tim McMackin",last_update:{date:"18 December 2023"}},c=void 0,i={},l=[{value:"The built-in contract",id:"the-built-in-contract",level:2},{value:"Deploying the built-in contract",id:"deploying-the-built-in-contract",level:2},{value:"Getting the contract address",id:"getting-the-contract-address",level:2},{value:"Calling contracts",id:"calling-contracts",level:2},{value:"Encoding parameters",id:"encoding-parameters",level:2},{value:"Deploying other contracts",id:"deploying-other-contracts",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Smart contracts are backend programs that run on the Tezos blockchains.\nSmart contracts can do many tasks, but for gaming they have two main purposes:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"They handle tokens, which are digital assets stored on the blockchain"}),"\n",(0,a.jsx)(n.li,{children:"They provide backend logic that users can trust because it cannot change"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["For more information about contracts, see ",(0,a.jsx)(n.a,{href:"/smart-contracts",children:"Smart contracts"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"You can create your own smart contracts or use the built-in contract that the SDK provides for managing tokens in Unity projects."}),"\n",(0,a.jsx)(n.p,{children:"The Contract tutorial scene shows how to deploy a copy of the built-in contract from a Unity project."}),"\n",(0,a.jsx)(n.h2,{id:"the-built-in-contract",children:"The built-in contract"}),"\n",(0,a.jsx)(n.p,{children:"The SDK includes a built-in contract that you can use to manage tokens for your Unity projects."}),"\n",(0,a.jsxs)(n.p,{children:["The contract has entrypoints that allow you to create and transfer tokens.\nSee ",(0,a.jsx)(n.a,{href:"/unity/managing-tokens",children:"Managing tokens"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["The Michelson source code of the built-in contract is in the ",(0,a.jsx)(n.code,{children:"Resources/Contracts"})," folder of the SDK, but it isn't very human-readable.\nFor a list of the entrypoints in the contract, see ",(0,a.jsx)(n.a,{href:"/unity/reference/TokenContract",children:"TokenContract object"}),".\nFor an example of a deployed contract, see ",(0,a.jsx)(n.a,{href:"https://ghostnet.tzkt.io/KT1Nhr9Bmhy7kcUmezRxbbDybh5buNnrVLTY/entrypoints",children:"https://ghostnet.tzkt.io/KT1Nhr9Bmhy7kcUmezRxbbDybh5buNnrVLTY/entrypoints"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"deploying-the-built-in-contract",children:"Deploying the built-in contract"}),"\n",(0,a.jsxs)(n.p,{children:["To deploy the built-in contract, call the ",(0,a.jsx)(n.a,{href:"/unity/reference/TokenContract#deploy",children:(0,a.jsx)(n.code,{children:"TokenContract.Deploy()"})})," method and pass a callback function:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"public void DeployContract()\n{\n    TezosManager\n        .Instance\n        .Tezos\n        .TokenContract\n        .Deploy(OnContractDeployed);\n}\n\nprivate void OnContractDeployed(string contractAddress)\n{\n    Debug.Log(contractAddress);\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"The project sends the deployment transaction to the connected wallet, which must approve the transaction and pay the related fees.\nThe callback function receives the address of the deployed contract, which the project uses to send requests to the contract.\nIt can take a few minutes for the contract to deploy and be confirmed in multiple blocks on the blockchain."}),"\n",(0,a.jsx)(n.p,{children:"The address that deployed the contract becomes the administrator of the contract and is the only account that can create tokens."}),"\n",(0,a.jsxs)(n.p,{children:["The SDK provides information about the contract such as its address in the ",(0,a.jsx)(n.a,{href:"/unity/reference/TokenContract",children:(0,a.jsx)(n.code,{children:"TokenContract"})})," object.\nYou can use block explorers such as ",(0,a.jsx)(n.a,{href:"https://better-call.dev/",children:"Better Call Dev"})," to see information about the deployed contract."]}),"\n",(0,a.jsxs)(n.p,{children:["For information about using the built-in contract, see ",(0,a.jsx)(n.a,{href:"/unity/managing-tokens",children:"Managing tokens"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"getting-the-contract-address",children:"Getting the contract address"}),"\n",(0,a.jsxs)(n.p,{children:["When you deploy a contract with the ",(0,a.jsx)(n.a,{href:"/unity/reference/TokenContract#deploy",children:(0,a.jsx)(n.code,{children:"TokenContract.Deploy()"})})," method, the SDK saves the contract address by running this code:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'PlayerPrefs.SetString("CurrentContract:" + Tezos.Wallet.GetActiveAddress(), contractAddress);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Then during SDK initialization, the SDK saves the address to the ",(0,a.jsx)(n.a,{href:"/unity/reference/TokenContract",children:(0,a.jsx)(n.code,{children:"TokenContract.Address"})})," property."]}),"\n",(0,a.jsxs)(n.p,{children:["To retrieve the address of contracts that you haven't deployed through the project, you can use the ",(0,a.jsx)(n.a,{href:"/unity/reference/API#getoriginatedcontractsforowner",children:(0,a.jsx)(n.code,{children:"API.GetOriginatedContractsForOwner()"})})," method."]}),"\n",(0,a.jsx)(n.h2,{id:"calling-contracts",children:"Calling contracts"}),"\n",(0,a.jsxs)(n.p,{children:["The built-in contract has convenience methods for minting and transferring tokens; see ",(0,a.jsx)(n.a,{href:"/unity/managing-tokens",children:"Managing tokens"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["To call the contract's other entrypoints, use the ",(0,a.jsx)(n.a,{href:"/unity/reference/Wallet#callcontract",children:(0,a.jsx)(n.code,{children:"Wallet.CallContract()"})})," method.\nFor example, to call the contract's ",(0,a.jsx)(n.code,{children:"set_administrator"})," entrypoint to set a new administrator account, use this code:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'TezosManager.Instance.Tezos.Wallet.CallContract(\n    contractAddress: TezosManager.Instance.Tezos.TokenContract.Address,\n    entryPoint: "set_administrator",\n    input: new MichelineString(newAdminAddress).ToJson()\n);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["For information about the entrypoints in the built-in contract, see ",(0,a.jsx)(n.a,{href:"/unity/reference/TokenContract#entrypoints",children:"Unity SDK TokenContract object"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"You can call any other contract by using its address, entrypoint name, and parameter value, as in this example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"TezosManager.Instance.Tezos.Wallet.CallContract(\n    contractAddress: address,\n    entryPoint: entryPointName,\n    input: new MichelineInt(12).ToJson()\n);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This example passes the value 12 to the entrypoint in the variable ",(0,a.jsx)(n.code,{children:"entryPointName"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Note that the parameter is encoded as a Michelson value.\nFor information about encoding more complex parameters, see ",(0,a.jsx)(n.a,{href:"#encoding-parameters",children:"Encoding parameters"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["To get the hash of the transaction, use the ",(0,a.jsx)(n.code,{children:"ContractCallCompleted"})," event."]}),"\n",(0,a.jsx)(n.h2,{id:"encoding-parameters",children:"Encoding parameters"}),"\n",(0,a.jsxs)(n.p,{children:["When you call contract entrypoints or views with the ",(0,a.jsx)(n.code,{children:"Wallet.CallContract()"})," or ",(0,a.jsx)(n.code,{children:"Wallet.ReadView()"})," methods, you must encode the parameter as a Micheline value.\nFor example, if an entrypoint accepts two integers and one string as parameters, you must pass a list of two ",(0,a.jsx)(n.code,{children:"Netezos.Encoding.MichelineInt"})," values and one ",(0,a.jsx)(n.code,{children:"Netezos.Encoding.MichelineString"})," value:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'var input = new MichelinePrim\n{\n    Prim = PrimType.Pair,\n    Args = new List<IMicheline>\n    {\n        new MichelineInt(1),\n        new MichelineInt(2),\n        new MichelineString("My string value")\n    }\n}.ToJson();\n\nTezosManager.Instance.Tezos.Wallet.CallContract(\n    contractAddress: address,\n    entryPoint: entryPointName,\n    input: input\n);\n'})}),"\n",(0,a.jsx)(n.p,{children:"You can also use the value of the parameters in Michelson JSON.\nThe previous example looks like this with a JSON parameter value:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'var input = @"{\n    ""prim"": ""Pair"",\n    ""args"": [\n        {\n        ""int"": ""1""\n        },\n        {\n        ""prim"": ""Pair"",\n        ""args"": [\n            {\n            ""int"": ""2""\n            },\n            {\n            ""string"": ""My string value""\n            }\n        ]\n      }\n    ]\n}";\n\nTezosManager.Instance.Tezos.Wallet.CallContract(\n    contractAddress: address,\n    entryPoint: entryPointName,\n    input: input\n);\n'})}),"\n",(0,a.jsx)(n.p,{children:"Some block explorers allow you to fill in parameter values for an entrypoint and then download the Michelson JSON to use in your code."}),"\n",(0,a.jsxs)(n.p,{children:["You can build more complex parameters out of ",(0,a.jsx)(n.code,{children:"Netezos.Encoding"})," objects.\nFor example, the built-in contract has an entrypoint named ",(0,a.jsx)(n.code,{children:"update_operators"}),", which is an FA2 standard entrypoint that gives an account control over another account's tokens.\nIt accepts a list of changes to make to token operators, each including these fields in this order:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:'Either "add_operator" or "remove_operator"'}),"\n",(0,a.jsx)(n.li,{children:"The address of the operator, which will be able to control the owner's tokens of the specified ID."}),"\n",(0,a.jsx)(n.li,{children:"The ID of the token"}),"\n",(0,a.jsx)(n.li,{children:"The address of the token owner"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This is the Michelson parameter type for the endpoint:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"(list %update_operators (or\n  (pair %add_operator (address %owner)\n    (pair (address %operator)\n          (nat %token_id)))\n  (pair %remove_operator (address %owner)\n    (pair\n      (address %operator)\n      (nat %token_id)))))\n"})}),"\n",(0,a.jsxs)(n.p,{children:['In this case, you set the "add_operator" value by passing a ',(0,a.jsx)(n.code,{children:"PrimType.Left"}),' Michelson primitive or the "remove_operator" value by passing a ',(0,a.jsx)(n.code,{children:"PrimType.Right"})," primitive.\nThe values in the primitive are a series of nested pairs called a ",(0,a.jsx)(n.a,{href:"/smart-contracts/data-types/complex-data-types#right-combs",children:"right comb"}),", as in this example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "prim": "LEFT",\n  "args": [\n    {\n      "prim": "Pair",\n      "args": [\n        {\n          "string": "tz1QCVQinE8iVj1H2fckqx6oiM85CNJSK9Sx"\n        },\n        {\n          "prim": "Pair",\n          "args": [\n            {\n              "string": "tz1hQKqRPHmxET8du3fNACGyCG8kZRsXm2zD"\n            },\n            {\n              "int": "1"\n            }\n          ]\n        }\n      ]\n    }\n  ]\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"The code to create a list of these elements to pass to the entrypoint looks like this:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'var operatorAddress = "tz1hQKqRPHmxET8du3fNACGyCG8kZRsXm2zD";\nvar ownerAddress = "tz1QCVQinE8iVj1H2fckqx6oiM85CNJSK9Sx";\nint[] tokenIds = {1, 2, 3};\n\nvar operatorArray = new MichelineArray();\nforeach (var tokenId in tokenIds)\n{\n    operatorArray.Add(new MichelinePrim\n    {\n        Prim = PrimType.Left,\n        Args = new List<IMicheline>\n        {\n            new MichelinePrim\n            {\n                Prim = PrimType.Pair,\n                Args = new List<IMicheline>\n                {\n                    new MichelineString(ownerAddress),\n                    new MichelinePrim\n                    {\n                        Prim = PrimType.Pair,\n                        Args = new List<IMicheline>\n                        {\n                            new MichelineString(operatorAddress),\n                            new MichelineInt(tokenId)\n                        }\n                    }\n\n                }\n            }\n        }\n    });\n};\n\nTezosManager.Instance.Tezos.Wallet.CallContract(\n    contractAddress: address,\n    entryPoint: "update_operators",\n    input: operatorArray.ToJson()\n);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"deploying-other-contracts",children:"Deploying other contracts"}),"\n",(0,a.jsx)(n.p,{children:"To deploy a contract from Unity, you must compile the contract to Michelson in JSON format.\nFor example, to compile a contract in LIGO to Michelson JSON, run this code:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ligo compile contract MyContract.jsligo \\\n  -m MyContract -o MyContract.json --michelson-format json\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Then, ensure that the code of the code and initial storage value of the contract are wrapped in ",(0,a.jsx)(n.code,{children:"code"})," and ",(0,a.jsx)(n.code,{children:"storage"})," fields at the root of the file, as in this example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "code": [\n    {\n      "prim": "parameter",\n      "args": [\n        ...\n    },\n  ],\n  "storage": {\n    "int": "0"\n  }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["To deploy the contract from the Unity project, use the ",(0,a.jsx)(n.a,{href:"/unity/reference/Wallet#originatecontract",children:(0,a.jsx)(n.code,{children:"Wallet.OriginateContract()"})})," method, as in this example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'var contractJSON = Resources.Load<TextAsset>("Contracts/MyContract").text;\nTezosManager.Instance.Tezos.Wallet.OriginateContract(contractJSON);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["To get the address of the deployed contract, use the ",(0,a.jsx)(n.code,{children:"ContractCallCompleted"})," event."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>c});var r=t(96540);const a={},o=r.createContext(a);function s(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);