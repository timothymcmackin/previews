"use strict";(self.webpackChunktezos_developer_docs=self.webpackChunktezos_developer_docs||[]).push([[2566],{53466:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"tutorials/smart-rollup/optimize","title":"Part 3: Optimizing the kernel","description":"To originate the kernel on Tezos, it must fit within the maximum size for a layer 1 operation (32KB).","source":"@site/docs/tutorials/smart-rollup/optimize.md","sourceDirName":"tutorials/smart-rollup","slug":"/tutorials/smart-rollup/optimize","permalink":"/previews/docs/biel-chatbot/tutorials/smart-rollup/optimize","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1723003200000,"frontMatter":{"title":"Part 3: Optimizing the kernel","last_update":{"date":"7 August 2024"}},"sidebar":"tutorialsSidebar","previous":{"title":"Part 2: Running the kernel in debug mode","permalink":"/previews/docs/biel-chatbot/tutorials/smart-rollup/debug"},"next":{"title":"Part 4: Deploying (originating) the rollup","permalink":"/previews/docs/biel-chatbot/tutorials/smart-rollup/deploy"}}');var l=r(74848),s=r(28453);const i={title:"Part 3: Optimizing the kernel",last_update:{date:"7 August 2024"}},o=void 0,a={},h=[];function c(e){const n={a:"a",code:"code",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"To originate the kernel on Tezos, it must fit within the maximum size for a layer 1 operation (32KB).\nIn these steps, you reduce the size of the kernel:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Run this command to print the current size of the kernel:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"du -h target/wasm32-unknown-unknown/debug/hello_world_kernel.wasm\n"})}),"\n",(0,l.jsx)(n.p,{children:"You can run this command inside or outside of the Docker container."}),"\n",(0,l.jsx)(n.p,{children:"Because you ran it in debug mode, the size of the compiled kernel and its dependencies may be 18MB or more, which is too large to originate."}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"In a terminal window outside of the Docker container, run this command to create a release build of the kernel:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cargo build --release --target wasm32-unknown-unknown\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Check the size of the release build of the kernel:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"du -h target/wasm32-unknown-unknown/release/hello_world_kernel.wasm\n"})}),"\n",(0,l.jsx)(n.p,{children:"The release build is significantly smaller, but still too large."}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["In a terminal window outside of the Docker container, run the ",(0,l.jsx)(n.code,{children:"wasm-strip"})," command to reduce the size of the kernel:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"wasm-strip target/wasm32-unknown-unknown/release/hello_world_kernel.wasm\n"})}),"\n",(0,l.jsxs)(n.p,{children:["This command removes WebAssembly code that is not necessary to run rollups.\nYou must run this command outside of the Docker container because it does not have the ",(0,l.jsx)(n.code,{children:"wasm-strip"})," command."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Run the ",(0,l.jsx)(n.code,{children:"du"})," command again to see the new size of the kernel:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"du -h target/wasm32-unknown-unknown/release/hello_world_kernel.wasm\n"})}),"\n",(0,l.jsxs)(n.p,{children:["The size of the kernel is smaller now.\nNote that the changes that you make to the kernel outside of the Docker container also appear in the container and vice versa because the folder is mounted with the Docker ",(0,l.jsx)(n.code,{children:"--volume"})," argument."]}),"\n",(0,l.jsx)(n.p,{children:"To get the kernel running with an even smaller size, you can use the installer kernel, which includes only enough information to install your original kernel.\nTo do this, your kernel is split up and stored in separate files called preimages.\nThen you run the installer kernel, it requests these files and reconstructs the original kernel."}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Outside of the Docker container, run this command to install the installer kernel tool:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cargo install tezos-smart-rollup-installer\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Outside of the Docker container, run this command to create an installer kernel:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"smart-rollup-installer get-reveal-installer \\\n  --upgrade-to target/wasm32-unknown-unknown/release/hello_world_kernel.wasm \\\n  --output hello_world_kernel_installer.wasm --preimages-dir preimages/\n"})}),"\n",(0,l.jsx)(n.p,{children:"This command creates the following files:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"hello_world_kernel_installer.wasm"}),": The installer kernel"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"preimages/"}),": A directory that contains the preimages that allow nodes to restore the original kernel code"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["When a node runs the installer kernel, it retrieves the preimages through the reveal data channel, a channel that Smart Rollups use to request data from outside of layer 1.\nFor more information about the reveal data channel, see ",(0,l.jsx)(n.a,{href:"https://octez.tezos.com/docs/active/smart_rollups.html#reveal-data-channel",children:"Reveal data channel"}),"."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Verify the size of the installer kernel by running this command:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"du -h hello_world_kernel_installer.wasm\n"})}),"\n",(0,l.jsx)(n.p,{children:"Now the kernel is small enough to originate on layer 1."}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Inside of the Docker container, run the installer kernel in debug mode by running this command:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"octez-smart-rollup-wasm-debugger --kernel hello_world_kernel_installer.wasm \\\n  --preimage-dir preimages/ --inputs empty_input.json\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Then you can use the ",(0,l.jsx)(n.code,{children:"step inbox"})," command to simulate receiving the inbox from layer 1.\nYou can see the hello world kernel messages in the log, which shows that the upgrade from the installer kernel to the full kernel was successful."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Press Ctrl + C to end the debugging session."}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Create a hexadecimal version of the installer kernel by running this command outside of the Docker container:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"smart-rollup-installer get-reveal-installer \\\n  --upgrade-to target/wasm32-unknown-unknown/release/hello_world_kernel.wasm \\\n  --output hello_world_kernel_installer.hex --preimages-dir preimages/\n"})}),"\n",(0,l.jsx)(n.p,{children:"In the next section, you originate this hex-encoded installer kernel on layer 1."}),"\n"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var t=r(96540);const l={},s=t.createContext(l);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);