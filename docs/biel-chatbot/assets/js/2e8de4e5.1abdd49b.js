"use strict";(self.webpackChunktezos_developer_docs=self.webpackChunktezos_developer_docs||[]).push([[7133],{80368:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"smart-contracts/timelocks","title":"Timelocks","description":"Timelocks are a way to prevent exploits known as front-running, or more properly, extractable value (EV) attacks.","source":"@site/docs/smart-contracts/timelocks.md","sourceDirName":"smart-contracts","slug":"/smart-contracts/timelocks","permalink":"/previews/docs/biel-chatbot/smart-contracts/timelocks","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1715227200000,"frontMatter":{"title":"Timelocks","authors":"Mathias Hiron (Nomadic Labs), Sasha Aldrick (TriliTech), Tim McMackin (TriliTech)","last_update":{"date":"9 May 2024"}},"sidebar":"documentationSidebar","previous":{"title":"Multi-signature contracts","permalink":"/previews/docs/biel-chatbot/smart-contracts/multisig"},"next":{"title":"Oracles","permalink":"/previews/docs/biel-chatbot/smart-contracts/oracles"}}');var i=n(74848),s=n(28453);const r={title:"Timelocks",authors:"Mathias Hiron (Nomadic Labs), Sasha Aldrick (TriliTech), Tim McMackin (TriliTech)",last_update:{date:"9 May 2024"}},o=void 0,c={},l=[{value:"Preventing EV attacks with timelocks",id:"preventing-ev-attacks-with-timelocks",level:2},{value:"Flow of timelocks in a typical commit-and-reveal scheme",id:"flow-of-timelocks-in-a-typical-commit-and-reveal-scheme",level:2},{value:"Example",id:"example",level:2},{value:"References",id:"references",level:2}];function h(e){const t={a:"a",admonition:"admonition",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["Timelocks are a way to prevent exploits known as ",(0,i.jsx)(t.em,{children:"front-running"}),", or more properly, ",(0,i.jsx)(t.em,{children:"extractable value (EV) attacks"}),".\nIn general, these attacks happen when a client uses information about an upcoming transaction to make a profit at its expense."]}),"\n",(0,i.jsxs)(t.admonition,{type:"note",children:[(0,i.jsx)(t.p,{children:'Within decentralized finance, the term "front-running" can be misleading because it implies a relationship between clients and block producers where none may exist.'}),(0,i.jsx)(t.p,{children:"In traditional finance, front-running often relies on malicious brokers profiting from advance, nonpublic information about their clients' trades.\nFor example, a malicious stockbroker may buy a security for themselves before they execute a client's large buy order, knowing that the client's buy order will drive the price of the security up."}),(0,i.jsx)(t.p,{children:"In decentralized finance, anyone can see incoming transactions, so front-running does not always mean that block producers are acting maliciously or sharing private information with clients.\nEV attacks can come from bots that watch for incoming transactions and insert their own transactions before the incoming transaction runs."}),(0,i.jsx)(t.p,{children:"However, block producers may still be able to profit from advance information about transactions.\nFor example, they may craft blocks that include a client's transaction and one of their own in an order that guarantees a gain to the block producer.\nThis type of attack is called a block producer extractable value (BPEV) attack."})]}),"\n",(0,i.jsxs)(t.p,{children:["For more information about this kind of attack, see ",(0,i.jsx)(t.a,{href:"https://medium.com/degate/an-analysis-of-ethereum-front-running-and-its-defense-solutions-34ef81ba8456",children:"An analysis of Ethereum front-running and its defense solutions"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"preventing-ev-attacks-with-timelocks",children:"Preventing EV attacks with timelocks"}),"\n",(0,i.jsx)(t.p,{children:"Tezos developers can prevent EV attacks with timelock encryption, which encrypts a message so it can be decrypted in two ways:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"The author of the encrypted message provides the unencrypted message and proof that it matches the encrypted message."}),"\n",(0,i.jsx)(t.li,{children:"Anyone else can decrypt the message with a certain number of operations."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"With timelocks, an author can encrypt a message in such a way that anyone else can reveal the message, but only after a certain amount of time.\nThis duration is based on the time it takes for a single computer to decrypt the commitments because the decryption algorithm can\u2019t be parallelized.\nThat means that computers can\u2019t easily work together to decrypt it and that adversaries cannot break it even with significant computing power."}),"\n",(0,i.jsx)(t.p,{children:"dApps that use timelocks to prevent EV attacks work in this general way:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"A user sends a timelock-encrypted transaction or operation to the dApp."}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"The dApp adds the transaction to its queue before anyone can see what the transaction is.\nTo everyone else, including bakers, bots, and the dApp itself, the transaction is encrypted and unreadable.\nNo one else can decrypt the transaction quickly, so they can\u2019t take advantage of it in an EV attack."}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"In the background, the dApp begins decrypting the transaction."}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"One of two things happen:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"The user submits the decrypted transaction and the proof that the decryption is accurate to the dApp before the dApp decrypts the transaction."}),"\n",(0,i.jsx)(t.li,{children:"The dApp decrypts the transaction before the user submits the decrypted transaction, such as if prices changed and the user doesn't want to execute the transaction anymore.\nIn this case, the dApp takes a penalty charge from the transaction for making it waste processing power on decrypting it."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"The dApp fulfills the decrypted transactions in its queue in the order that they were submitted."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"In practice, DeFi users nearly always submit their decrypted transactions before anyone else decrypts them.\nThey don\u2019t want to pay the penalty and they know how long it will take the dApp to break the transaction\u2019s encryption."}),"\n",(0,i.jsx)(t.h2,{id:"flow-of-timelocks-in-a-typical-commit-and-reveal-scheme",children:"Flow of timelocks in a typical commit-and-reveal scheme"}),"\n",(0,i.jsxs)(t.p,{children:["Timelocks are often used to ensure that a group of users each submit information while keeping their submissions secret for a certain amount of time.\nSometimes this process is called a ",(0,i.jsx)(t.em,{children:"commit and reveal scheme"})," because all users commit to their choice without seeing the others' choices."]}),"\n",(0,i.jsx)(t.p,{children:"This is the typical usage pattern of a timelock:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"In the first time period, a contract collects timelock encrypted values from users along with some valuable deposit, such as tez."}),"\n",(0,i.jsx)(t.li,{children:"In the second time period, after the values are collected, users submit a decryption of the value they submitted with a proof that the decryption is correct.\nThis prevents users from changing their values."}),"\n",(0,i.jsx)(t.li,{children:"In the third time period, if any value isn't decrypted, anyone can claim some of the deposit by submitting a decryption of the value.\nThis prevents users from profiting by not revealing their decrypted values or blocking the process.\nThis period needs to be long enough so that people have enough time to perform the timelock decryption."}),"\n",(0,i.jsx)(t.li,{children:"Finally, the contract runs some logic based on the decrypted data.\nFor example, it might distribute funds to a winner or run an operation that the majority of the users secretly voted for."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Contracts can assess different penalties for not revealing, depending on whether the user merely failed to submit a decryption for their value or if they also intentionally encrypted invalid data.\nThey can also distribute different rewards for submitting a correct decryption."}),"\n",(0,i.jsx)(t.p,{children:"Because it's possible to reveal the data eventually, all participants have an incentive to reveal because they will eventually lose their deposit when someone else cracks and reveals the data.\nIn this way, timelocks work as a deterrent; in practice, participants nearly always reveal rather than forcing someone else to crack the encryption.\nHowever, the second period needs to be long enough so that bakers cannot easily censor submission of the decryption in a bid to later claim the reward."}),"\n",(0,i.jsx)(t.p,{children:"Also, contracts should burn part of a deposit when another user submits a decryption of someone else's value.\nBurning a part of the deposit limits attacks where a user gets back their whole deposit by providing the decryption, but in a way that delays everyone else."}),"\n",(0,i.jsx)(t.h2,{id:"example",children:"Example"}),"\n",(0,i.jsx)(t.p,{children:"Timelocks make it possible to prove that a certain decision was taken before some information was revealed.\nThis information may be the decision of other participants or some external independent information."}),"\n",(0,i.jsxs)(t.p,{children:["As an example, imagine that two players want to play the game ",(0,i.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Rock_paper_scissors",children:"rock, paper, scissors"})," via a smart contract.\nIf one player can see another player's choice before they choose, they will win every time.\nBecause it is impossible to force and verify that the two players reveal their choice simultaneously, they can use a commit-and-reveal scheme."]}),"\n",(0,i.jsx)(t.p,{children:"During the first step, they pick their choice and put it in a pair with some random data.\nThen they compute a hash of the result to create a timelock and send this value to the contract as a commitment."}),"\n",(0,i.jsx)(t.p,{children:"After both players have sent their commitment, they can reveal by sending the actual data to the contract including the random data.\nThe contract can verify that the hash of this data matches the previous commitment.\nWhen the two players have revealed their data, the smart contract determines the outcome of the game and distributes rewards accordingly."}),"\n",(0,i.jsx)(t.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"http://www.hashcash.org/papers/timelock.pdf",children:"Timelock puzzles and timed release Crypto"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://opentezos.com/smart-contracts/avoiding-flaws/#6-not-protecting-against-bots-bpev-attacks",children:"Not protecting against bots (BPEV attacks)"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://spotlight.tezos.com/timelocks-defi/",children:"How Tezos timelocks help protect DeFi transactions"})}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>o});var a=n(96540);const i={},s=a.createContext(i);function r(e){const t=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);