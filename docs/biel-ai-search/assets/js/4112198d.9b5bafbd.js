"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1769],{73032:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"smart-contracts/multisig","title":"Multi-signature contracts","description":"Multi-signature (or multisig) contracts require multiple accounts to authorize operations before running them.","source":"@site/docs/smart-contracts/multisig.md","sourceDirName":"smart-contracts","slug":"/smart-contracts/multisig","permalink":"/previews/docs/biel-ai-search/smart-contracts/multisig","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1737608400000,"frontMatter":{"title":"Multi-signature contracts","authors":"Tim McMackin","last_update":{"date":"23 January 2025"},"dependencies":{"octez":21.2,"smartpy":"0.20.0"}},"sidebar":"documentationSidebar","previous":{"title":"Delegation","permalink":"/previews/docs/biel-ai-search/smart-contracts/delegation"},"next":{"title":"Timelocks","permalink":"/previews/docs/biel-ai-search/smart-contracts/timelocks"}}');var a=n(74848),o=n(28453);const r={title:"Multi-signature contracts",authors:"Tim McMackin",last_update:{date:"23 January 2025"},dependencies:{octez:21.2,smartpy:"0.20.0"}},i=void 0,c={},l=[{value:"Using proposals",id:"using-proposals",level:2},{value:"Using multi-signature operations",id:"using-multi-signature-operations",level:2},{value:"Setting up multi-signature wallets",id:"setting-up-multi-signature-wallets",level:2},{value:"Securing multisig contracts",id:"securing-multisig-contracts",level:2},{value:"More information",id:"more-information",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"Multi-signature (or multisig) contracts require multiple accounts to authorize operations before running them.\nThey have many applications, including:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Governance: DAOs and other groups can use them to vote on the actions that the organization takes."}),"\n",(0,a.jsx)(t.li,{children:"Funds distribution: Accounts can vote on where funds are sent."}),"\n",(0,a.jsx)(t.li,{children:"Security: Requiring multiple signatures can prevent a single compromised wallet from doing malicious things."}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"As with any contract, a single account must originate multisig contracts, but that account does not necessarily have any special privileges on the contract.\nThe contract originator does not even need to be one of the accounts that can authorize operations."}),"\n",(0,a.jsx)(t.h2,{id:"using-proposals",children:"Using proposals"}),"\n",(0,a.jsx)(t.p,{children:"One common way to create a multisig contract is to allow authorized users to submit a proposal that other authorized users can vote on.\nFor example, this multisig contract stores tez and allows users to propose and vote on the account that should receive the tez:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-smartpy",children:'import smartpy as sp\n\n\n@sp.module\ndef main():\n    proposal_type: type = sp.big_map[\n        sp.int,\n        sp.record(\n            paymentAmt=sp.mutez,\n            receiver=sp.address,\n            voters=sp.set[sp.address],\n            votingComplete=sp.bool,\n        ),\n    ]\n\n    class MultiSigContract(sp.Contract):\n        def __init__(self, members, requiredVotes):\n            # Keep track of all the proposals submitted to the multisig\n            self.data.proposals = sp.cast(sp.big_map(), proposal_type)\n            self.data.activeProposalId = 0\n            self.data.members = sp.cast(members, sp.set[sp.address])\n            self.data.requiredVotes = sp.cast(requiredVotes, sp.nat)\n\n        @sp.entrypoint\n        def deposit(self):\n            assert self.data.members.contains(sp.sender), "Not a Member of MultiSig"\n\n        @sp.entrypoint\n        def submit_proposal(self, params):\n            """\n            Submit a new proposal/lambda for members\n            of the MultiSig to vote for.\n            """\n            assert self.data.members.contains(sp.sender), "Not a Member of MultiSig"\n            assert (\n                params.paymentAmt <= sp.balance\n            ), "The MultiSig does not have enough funds for this proposal"\n            self.data.activeProposalId += (\n                1  # submitting a new proposal inactivates the last one\n            )\n            self.data.proposals[self.data.activeProposalId] = sp.record(\n                paymentAmt=params.paymentAmt,\n                receiver=params.receiver,\n                voters={sp.sender},\n                votingComplete=False,\n            )\n\n        @sp.entrypoint\n        def vote_on_proposal(self):\n            assert self.data.members.contains(sp.sender), "Not a Member of MultiSig"\n            # check if the user has previously voted on the proposal\n            assert not self.data.proposals[self.data.activeProposalId].voters.contains(\n                sp.sender\n            ), "Member has voted on this proposal"\n            self.data.proposals[self.data.activeProposalId].voters.add(sp.sender)\n            if (\n                sp.len(self.data.proposals[self.data.activeProposalId].voters)\n                == self.data.requiredVotes\n            ):\n                sp.send(\n                    self.data.proposals[self.data.activeProposalId].receiver,\n                    self.data.proposals[self.data.activeProposalId].paymentAmt,\n                )\n                self.data.proposals[self.data.activeProposalId].votingComplete = True\n\n\n@sp.add_test()\ndef test():\n    scenario = sp.test_scenario("Multisig test", main)\n    alice = sp.test_account("alice")\n    bob = sp.test_account("bob")\n    charlie = sp.test_account("charlie")\n    dani = sp.test_account("dani")\n    earl = sp.test_account("earl")\n    scenario.h3("MultiSig Proposal Contract")\n    members = sp.set()\n    members.add(alice.address)\n    members.add(bob.address)\n    members.add(charlie.address)\n    members.add(earl.address)\n\n    contract = main.MultiSigContract(members, 3)\n    scenario += contract\n\n    scenario.h3("Members can add funds to the contract")\n    contract.deposit(_sender=alice.address, _amount=sp.tez(50))\n\n    scenario.h3(\n        "Members can submit a proposal for funds to be sent to an address - Proposal 1."\n    )\n    contract.submit_proposal(\n        sp.record(paymentAmt=sp.tez(30), receiver=dani.address),\n        _sender=alice.address\n    )\n\n    scenario.h3("Non-members cannot vote on proposals")\n    contract.vote_on_proposal(_valid=False, _sender=dani.address)\n\n    scenario.h3("Member 2 can vote on proposal")\n    contract.vote_on_proposal(_sender=bob.address)\n\n    scenario.h3("Member 3 can vote on proposal")\n    contract.vote_on_proposal(_sender=charlie.address)\n\n    scenario.h3("Contract balance should drop to 20tez after transfer")\n    scenario.verify(contract.balance == sp.tez(20))\n\n    scenario.h3("A New proposal can be created")\n    contract.submit_proposal(\n        sp.record(paymentAmt=sp.tez(20), receiver=dani.address),\n        _sender=alice.address\n    )\n\n    scenario.h3("New proposal can be voted on")\n    contract.vote_on_proposal(_sender=charlie.address)\n\n'})}),"\n",(0,a.jsx)(t.p,{children:"This contract stores a big-map of proposals, each with an amount to pay, the account to pay, and information about who has voted for the proposal:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-smartpy",children:"proposal_type: type = sp.big_map[\n    sp.int,\n    sp.record(\n        paymentAmt=sp.mutez,\n        receiver=sp.address,\n        voters=sp.set[sp.address],\n        votingComplete=sp.bool,\n    ),\n]\n"})}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.code,{children:"submit_proposal"})," entrypoint allows authorized users to submit a payment amount and an account address, which adds a proposal to the storage:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-smartpy",children:"self.data.proposals[self.data.activeProposalId] = sp.record(\n    paymentAmt=params.paymentAmt,\n    receiver=params.receiver,\n    voters={sp.sender},\n    votingComplete=False,\n)\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Authorized accounts call the ",(0,a.jsx)(t.code,{children:"vote_on_proposal"})," entrypoint to vote for the currently active proposal:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-smartpy",children:'@sp.entrypoint\ndef vote_on_proposal(self):\n    assert self.data.members.contains(sp.sender), "Not a Member of MultiSig"\n    # check if the user has previously voted on the proposal\n    assert not self.data.proposals[self.data.activeProposalId].voters.contains(\n        sp.sender\n    ), "Member has voted on this proposal"\n    self.data.proposals[self.data.activeProposalId].voters.add(sp.sender)\n'})}),"\n",(0,a.jsx)(t.p,{children:"Accounts that don't want to vote for the proposal don't need to do anything."}),"\n",(0,a.jsxs)(t.p,{children:["When the necessary number of votes have been reached, the ",(0,a.jsx)(t.code,{children:"vote_on_proposal"})," entrypoint automatically sends the tez to the account in the proposal:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-smartpy",children:"if (\n    sp.len(self.data.proposals[self.data.activeProposalId].voters)\n    == self.data.requiredVotes\n):\n    sp.send(\n        self.data.proposals[self.data.activeProposalId].receiver,\n        self.data.proposals[self.data.activeProposalId].paymentAmt,\n    )\n    self.data.proposals[self.data.activeProposalId].votingComplete = True\n"})}),"\n",(0,a.jsx)(t.h2,{id:"using-multi-signature-operations",children:"Using multi-signature operations"}),"\n",(0,a.jsxs)(t.p,{children:["You can also require operations to be signed by multiple accounts.\nFor example, the ",(0,a.jsx)(t.a,{href:"/developing/octez-client",children:"Octez client"})," has a built-in multisig contract that you can use.\nThe contract requires signatures from multiple accounts before running transactions such as :"]}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Distributing tez"}),"\n",(0,a.jsx)(t.li,{children:"Changing the threshold"}),"\n",(0,a.jsx)(t.li,{children:"Changing the accounts"}),"\n",(0,a.jsx)(t.li,{children:"Setting the delegate of the contract"}),"\n",(0,a.jsx)(t.li,{children:"Running arbitrary Michelson code"}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"To originate the contract, you specify the accounts to include as authorized signers of the contract and the threshold, which is the number of accounts that are needed to authorize a transaction.\nThis example creates a contract with three members and a threshold of 2:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"octez-client deploy multisig msig transferring 100 from my_account \\\n  with threshold 2 \\\n  on public keys alice bob charlie --burn-cap 1\n"})}),"\n",(0,a.jsxs)(t.p,{children:["To initiate a transaction, use the ",(0,a.jsx)(t.code,{children:"octez-client prepare multisig transaction"})," command.\nFor example, this command initiates a transfer of 10 tez from the contract to Bob's account:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"octez-client prepare multisig transaction on msig transferring 10 to bob\n"})}),"\n",(0,a.jsx)(t.p,{children:"The response includes a string of bytes that the other accounts must sign, as in this example:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{children:"Bytes to sign: '0x05070707070a00000004af1864d90a0000001601af1399f7f3123697929b158b554f5dd697aa7e330007070001050502000000350320053d036d0743035d0a00000015000f2c3d65a941224c35fa05e965386726da7cab32031e0743036a0080dac409034f034d031b'\nBlake 2B Hash: 'CmaXVZ2u7HxNGfSzw1Bu5vFEsoQs7YDPs5q6KH1g7HGG'\nThreshold (number of signatures required): 2\nPublic keys of the signers:\n  edpkuNgk7cbsBbuYCgbow7svichVJsVZ5pZ5DQ6Uv4aFCoA1gv1qaF\n  edpktzDT3t9m2rSkrYbUycCHdvKVcK9MmcMffMRddHZKyxksUcnVXb\n  edpkvGvA6b6KfdwH5Q8fyq9J3494Fw58BKKPgdei3QfvrrnLt5nd58\n"})}),"\n",(0,a.jsxs)(t.p,{children:["To sign the bytes, the other accounts run the ",(0,a.jsx)(t.code,{children:"octez-client sign bytes"})," command.\nFor example, this code assigns the bytes to the ",(0,a.jsx)(t.code,{children:"TO_SIGN"})," variable and signs them with two accounts:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"TO_SIGN=$(octez-client prepare multisig transaction on msig transferring 10 to bob --bytes-only)\nALICE_S_SIGNATURE=$(octez-client sign bytes \"$TO_SIGN\" for alice | cut -d ' ' -f 2)\nCHARLIE_S_SIGNATURE=$(octez-client sign bytes \"$TO_SIGN\" for charlie | cut -d ' ' -f 2)\n"})}),"\n",(0,a.jsx)(t.p,{children:"Then you can use the two accounts' signatures to run the transaction:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:'octez-client run transaction "$TO_SIGN" \\\n  on multisig contract msig \\\n  on behalf of charlie \\\n  with signatures "$ALICE_S_SIGNATURE" "$CHARLIE_S_SIGNATURE"\n'})}),"\n",(0,a.jsx)(t.p,{children:"The contract uses a counter to ensure that the signatures work only once."}),"\n",(0,a.jsxs)(t.p,{children:["For more information, run the command ",(0,a.jsx)(t.code,{children:"octez-client man multisig"})," and see ",(0,a.jsx)(t.a,{href:"https://octez.tezos.com/docs/user/multisig.html",children:"Built-in multisig contracts"})," in the Octez documentation."]}),"\n",(0,a.jsx)(t.h2,{id:"setting-up-multi-signature-wallets",children:"Setting up multi-signature wallets"}),"\n",(0,a.jsx)(t.p,{children:"Some tools create wallets that can store tez and other tokens and manage the process of signing transactions.\nFor example, TzSafe provides a front-end application that lets you:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Create a multisig wallet and store tez, FA1.2 tokens, and FA2 tokens in it"}),"\n",(0,a.jsx)(t.li,{children:"Create proposals to transfer tokens"}),"\n",(0,a.jsx)(t.li,{children:"Sign or reject proposals"}),"\n",(0,a.jsx)(t.li,{children:"Run approved proposals"}),"\n"]}),"\n",(0,a.jsxs)(t.p,{children:["For more information about TzSafe, see ",(0,a.jsx)(t.a,{href:"https://docs.tzsafe.marigold.dev",children:"https://docs.tzsafe.marigold.dev"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"securing-multisig-contracts",children:"Securing multisig contracts"}),"\n",(0,a.jsx)(t.p,{children:"Like all contracts, you must ensure ensure that multisig contracts won't become compromised or permanently blocked."}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Control the list of voters, how accounts can be added or removed, and how many votes are needed to approve a proposal"}),"\n",(0,a.jsx)(t.li,{children:"Prevent users from blocking the contract by setting a time limit for proposals"}),"\n",(0,a.jsx)(t.li,{children:"Prevent users from clogging the contract with too many proposals or submitting a new proposal before other users have time to vote on the current proposal"}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"more-information",children:"More information"}),"\n",(0,a.jsxs)(t.p,{children:["For more information on multisig contracts, see examples in the repository ",(0,a.jsx)(t.a,{href:"https://github.com/onedebos/multisig",children:"https://github.com/onedebos/multisig"})," and an explanation in this video: ",(0,a.jsx)(t.a,{href:"https://www.youtube.com/watch?v=r9QrrSfJuVg",children:"https://www.youtube.com/watch?v=r9QrrSfJuVg"}),"."]})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>i});var s=n(96540);const a={},o=s.createContext(a);function r(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);