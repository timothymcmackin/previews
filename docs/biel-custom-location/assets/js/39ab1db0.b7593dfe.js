"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4187],{44443:(t,n,e)=>{e.r(n),e.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"tutorials/build-your-first-app/sending-transactions","title":"Part 3: Sending transactions","description":"Now that the application can connect to the user\'s wallet, it can get the user\'s approval to send transactions to Tezos with that wallet.","source":"@site/docs/tutorials/build-your-first-app/sending-transactions.md","sourceDirName":"tutorials/build-your-first-app","slug":"/tutorials/build-your-first-app/sending-transactions","permalink":"/previews/docs/biel-custom-location/tutorials/build-your-first-app/sending-transactions","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1700024400000,"frontMatter":{"title":"Part 3: Sending transactions","authors":"Tim McMackin","last_update":{"date":"15 November 2023"}},"sidebar":"tutorialsSidebar","previous":{"title":"Part 2: Accessing wallets","permalink":"/previews/docs/biel-custom-location/tutorials/build-your-first-app/wallets-tokens"},"next":{"title":"Part 4: Getting information","permalink":"/previews/docs/biel-custom-location/tutorials/build-your-first-app/getting-information"}}');var s=e(74848),i=e(28453);const o={title:"Part 3: Sending transactions",authors:"Tim McMackin",last_update:{date:"15 November 2023"}},r=void 0,l={},c=[{value:"The tutorial smart contract",id:"the-tutorial-smart-contract",level:2},{value:"Steps for sending transactions",id:"steps-for-sending-transactions",level:2},{value:"Making a deposit transaction",id:"making-a-deposit-transaction",level:2},{value:"Making a withdrawal transaction",id:"making-a-withdrawal-transaction",level:2}];function d(t){const n={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...t.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Now that the application can connect to the user's wallet, it can get the user's approval to send transactions to Tezos with that wallet."}),"\n",(0,s.jsx)(n.h2,{id:"the-tutorial-smart-contract",children:"The tutorial smart contract"}),"\n",(0,s.jsxs)(n.p,{children:["This decentralized application (or dApp) uses a ",(0,s.jsx)(n.em,{children:"smart contract"})," on Tezos, which is a type of program that runs on a blockchain.\nThis contract behaves like an API, because your application calls its entrypoints to run commands."]}),"\n",(0,s.jsx)(n.p,{children:"In this case, the smart contract was deployed for the purposes of this tutorial, so it is not a full-featured application.\nIt does two things to simulate a bank:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"It accepts deposits of tez tokens that users send and records how many tokens they sent."}),"\n",(0,s.jsx)(n.li,{children:"It accepts a request to withdraw tez and sends them back to the user's wallet."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The contract has two ",(0,s.jsx)(n.em,{children:"entrypoints"}),' for these functions, named "deposit" and "withdraw."\nThese entrypoints are like API endpoints or functions in a program: clients can call them and pass parameters to them.\nHowever, unlike API endpoints and functions, they do not return a value.']}),"\n",(0,s.jsx)(n.h2,{id:"steps-for-sending-transactions",children:"Steps for sending transactions"}),"\n",(0,s.jsx)(n.p,{children:"Sending transactions with Taquito involves these general steps:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Create an object that represents the smart contract to call."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Disable UI elements related to the transaction to prevent the user from sending duplicate transactions."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Create the transaction, including specifying this information:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The entrypoint to call"}),"\n",(0,s.jsx)(n.li,{children:"The parameters to pass"}),"\n",(0,s.jsx)(n.li,{children:"The amount of tez to pass, if any"}),"\n",(0,s.jsx)(n.li,{children:"Maximum amounts for the fees for the transaction"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Send the transaction to the user's wallet for approval."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Wait for the transaction to complete."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Update information about the user's wallet and other details in the UI based on the result of the transaction."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Enable UI elements that were disabled during the transaction."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"making-a-deposit-transaction",children:"Making a deposit transaction"}),"\n",(0,s.jsx)(n.p,{children:"Follow these steps to set up the application to send transactions to the deposit entrypoint:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.code,{children:"App.svelte"})," file, add the address of the contract as a constant with the other constants in the ",(0,s.jsx)(n.code,{children:"<script>"})," section:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'const contractAddress = "KT1R4i4qEaxF7v3zg1M8nTeyrqk8JFmdGLuu";\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The address of the deployed smart contract for this tutorial is ",(0,s.jsx)(n.code,{children:"KT1R4i4qEaxF7v3zg1M8nTeyrqk8JFmdGLuu"}),".\nYou can use this address to look up the status of the contract and see its storage and recent transactions on a block explorer such as ",(0,s.jsx)(n.a,{href:"https://better-call.dev/",children:"https://better-call.dev/"}),".\nFor example, this is a link to information about the tutorial contract: ",(0,s.jsx)(n.a,{href:"https://better-call.dev/ghostnet/KT1R4i4qEaxF7v3zg1M8nTeyrqk8JFmdGLuu/operations",children:"https://better-call.dev/ghostnet/KT1R4i4qEaxF7v3zg1M8nTeyrqk8JFmdGLuu/operations"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Add variables to represent the amount that the user is depositing and the state of the UI button for the deposit:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'let depositAmount = 1;\nlet depositButtonActive = false;\nlet depositButtonLabel = "Deposit";\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Add this function to send the deposit transaction:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'const deposit = async () => {\n  depositButtonActive = false;\n  depositButtonLabel = "Depositing...";\n\n  Tezos.setWalletProvider(wallet);\n  const contract = await Tezos.wallet.at(contractAddress);\n\n  const transactionParams = await contract.methods\n    .deposit()\n    .toTransferParams({\n      amount: depositAmount,\n    });\n  const estimate = await Tezos.estimate.transfer(transactionParams);\n\n  const operation = await Tezos.wallet\n    .transfer({\n      ...transactionParams,\n      ...estimate,\n    })\n    .send();\n\n  console.log(`Waiting for ${operation.opHash} to be confirmed...`);\n\n  await operation.confirmation(2);\n\n  console.log(\n    `Operation injected: https://ghost.tzstats.com/${operation.opHash}`\n  );\n\n  await getWalletBalance(address);\n  depositButtonActive = true;\n  depositButtonLabel = "Deposit";\n};\n'})}),"\n",(0,s.jsx)(n.p,{children:"This function does the general transaction steps from above:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"It changes variables to indicate the status of the transaction in the UI."}),"\n",(0,s.jsx)(n.li,{children:"It creates an object that represents the contract."}),"\n",(0,s.jsxs)(n.li,{children:["It uses the ",(0,s.jsx)(n.code,{children:"Tezos.estimate.transfer"})," method to estimate the fees for the transaction."]}),"\n",(0,s.jsx)(n.li,{children:"It submits the transaction using the fee estimate and the amount of tez to send.\nEstimating the fees is important because the transaction must include the cost to increase the contract's storage in case this is the first time that the account is calling the contract.\nThese fee amounts are only maximums; Tezos automatically takes the actual amount for fees from the account."}),"\n",(0,s.jsx)(n.li,{children:"It waits for the transaction to be confirmed.\nIn this case, it waits for the transaction to appear in at least 2 Tezos blocks, which ensures that the transaction has been recorded permanently on the blockchain."}),"\n",(0,s.jsx)(n.li,{children:"It updates the UI with the new wallet balance."}),"\n",(0,s.jsx)(n.li,{children:"It changes variables to update the UI."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["At the end of the ",(0,s.jsx)(n.code,{children:"connectWallet"})," function, add code to enable the deposit button:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"depositButtonActive = true;\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The updated ",(0,s.jsx)(n.code,{children:"connectWallet"})," function looks like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'const connectWallet = async () => {\n  const newWallet = new BeaconWallet({\n    name: "Simple dApp tutorial",\n    network: {\n     type: NetworkType.GHOSTNET,\n   },\n  });\n  await newWallet.requestPermissions();\n  address = await newWallet.getPKH();\n  await getWalletBalance(address);\n  wallet = newWallet;\n  depositButtonActive = true;\n};\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.code,{children:"<main>"})," section, after the link to the faucet, add this code:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:'<p>\n  Deposit tez:\n  <input type="number" bind:value={depositAmount} min="1" max="100" />\n  <input type="range" bind:value={depositAmount} min="1" max="100" />\n  <button on:click={deposit} disabled={!depositButtonActive}> {depositButtonLabel} </button>\n</p>\n'})}),"\n",(0,s.jsx)(n.p,{children:"This code creates an input field and slider to let the user select an amount from 1 to 100 tez.\nIt also adds a button to start the transaction."}),"\n",(0,s.jsx)(n.p,{children:"The updated application looks like this:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"The updated application with fields to set the amount and a button to send the transaction",src:e(37540).A+"",width:"393",height:"218"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Send a deposit with your wallet using the application:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Make sure the application is still running and open it in your web browser.\nBecause you made changes to the application, it refreshes automatically and you must connect your wallet again."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Connect your wallet."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Note the amount of tez in your wallet currently."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Select an amount of tez to send that is less than your current wallet balance.\nNote that you must select less tez than the total balance of your wallet because the transaction adds fees."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Click ",(0,s.jsx)(n.strong,{children:"Deposit"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"The wallet application prompts you to approve the transaction, including the amount of tez to send and the maximum amounts for the fees.\nFor example, this is how the transaction looks in Temple wallet for sending 9 tez:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"The transaction in the Temple wallet, showing the fees and prompting the user to approve the transaction",src:e(9075).A+"",width:"378",height:"601"})}),"\n",(0,s.jsx)(n.p,{children:'The "Deposit" button changes to "Depositing..." while it waits for the transaction to be completed.\nWhen it changes back to "Deposit," the transaction is complete.'}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Note the new balance of your wallet."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"making-a-withdrawal-transaction",children:"Making a withdrawal transaction"}),"\n",(0,s.jsx)(n.p,{children:"The process for making a withdrawal is simpler because the user does not need to select an amount.\nInstead, the withdrawal entrypoint checks its storage to see how much the user has deposited and sends that amount back to the user's account."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Add variables to represent the state of the UI button for the withdrawal:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'let withdrawButtonActive = true;\nlet withdrawButtonLabel = "Withdraw";\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Add this function to send the withdrawal transaction:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'const withdraw = async () => {\n  withdrawButtonActive = false;\n  withdrawButtonLabel = "Withdrawing...";\n\n  Tezos.setWalletProvider(wallet);\n  const contract = await Tezos.wallet.at(contractAddress);\n\n  const transactionParams = await contract.methods\n    .withdraw()\n    .toTransferParams();\n  const estimate = await Tezos.estimate.transfer(transactionParams);\n\n  const operation = await Tezos.wallet\n    .transfer({\n      ...transactionParams,\n      ...estimate,\n    })\n    .send();\n\n  console.log(`Waiting for ${operation.opHash} to be confirmed...`);\n\n  await operation.confirmation(2);\n\n  console.log(\n    `Operation injected: https://ghost.tzstats.com/${operation.opHash}`\n  );\n\n  await getWalletBalance(address);\n  withdrawButtonActive = true;\n  withdrawButtonLabel = "Withdraw";\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This function is similar to the ",(0,s.jsx)(n.code,{children:"deposit"})," function with these main differences:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Instead of calling the ",(0,s.jsx)(n.code,{children:"deposit"})," endpoint, it calls the ",(0,s.jsx)(n.code,{children:"withdraw"})," endpoint."]}),"\n",(0,s.jsx)(n.li,{children:"It always sends 0 tez with the transaction."}),"\n",(0,s.jsx)(n.li,{children:"It doesn't estimate the fees because this transaction does not result in a storage increase."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.code,{children:"<main>"})," section, after the deposit button, add a button to start the withdrawal transaction:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:"<p>\n  Withdraw tez:\n  <button on:click={withdraw} disabled={!withdrawButtonActive}> {withdrawButtonLabel} </button>\n</p>\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Make a withdrawal by opening the application, connecting your wallet again, and clicking ",(0,s.jsx)(n.strong,{children:"Withdraw"}),".\nThe application sends the withdrawal transaction and your wallet's balance in the app updates."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Now that the application can send transactions, in the next section, you improve the user interface by showing the user's balance in the bank."}),"\n",(0,s.jsxs)(n.p,{children:["Here is the completed code of the ",(0,s.jsx)(n.code,{children:"App.svelte"})," file at the end of this section:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:'<script>\n  import { BeaconWallet } from "@taquito/beacon-wallet";\n  import { NetworkType } from "@airgap/beacon-types";\n  import { TezosToolkit } from "@taquito/taquito";\n\n  const rpcUrl = "https://ghostnet.ecadinfra.com";\n  const Tezos = new TezosToolkit(rpcUrl);\n  const contractAddress = "KT1R4i4qEaxF7v3zg1M8nTeyrqk8JFmdGLuu";\n\n  let wallet;\n  let address;\n  let balance;\n\n  let depositAmount = 1;\n  let depositButtonActive = false;\n  let depositButtonLabel = "Deposit";\n\n  let withdrawButtonActive = true;\n  let withdrawButtonLabel = "Withdraw";\n\n  const connectWallet = async () => {\n    const newWallet = new BeaconWallet({\n      name: "Simple dApp tutorial",\n      network: {\n        type: NetworkType.GHOSTNET,\n      },\n    });\n    await newWallet.requestPermissions();\n    address = await newWallet.getPKH();\n    await getWalletBalance(address);\n    wallet = newWallet;\n    depositButtonActive = true;\n  };\n\n  const disconnectWallet = () => {\n    wallet.client.clearActiveAccount();\n    wallet = undefined;\n  };\n\n  const getWalletBalance = async (walletAddress) => {\n    const balanceMutez = await Tezos.tz.getBalance(walletAddress);\n    balance = balanceMutez.div(1000000).toFormat(2);\n  };\n\n  const deposit = async () => {\n    depositButtonActive = false;\n    depositButtonLabel = "Depositing...";\n\n    Tezos.setWalletProvider(wallet);\n    const contract = await Tezos.wallet.at(contractAddress);\n\n    const transactionParams = await contract.methods\n      .deposit()\n      .toTransferParams({\n        amount: depositAmount,\n      });\n    const estimate = await Tezos.estimate.transfer(transactionParams);\n\n    const operation = await Tezos.wallet\n      .transfer({\n        ...transactionParams,\n        ...estimate,\n      })\n      .send();\n\n    console.log(`Waiting for ${operation.opHash} to be confirmed...`);\n\n    await operation.confirmation(2);\n\n    console.log(\n      `Operation injected: https://ghost.tzstats.com/${operation.opHash}`\n    );\n\n    await getWalletBalance(address);\n    depositButtonActive = true;\n    depositButtonLabel = "Deposit";\n  };\n\n  const withdraw = async () => {\n    withdrawButtonActive = false;\n    withdrawButtonLabel = "Withdrawing...";\n\n    Tezos.setWalletProvider(wallet);\n    const contract = await Tezos.wallet.at(contractAddress);\n\n    const transactionParams = await contract.methods\n      .withdraw()\n      .toTransferParams();\n    const estimate = await Tezos.estimate.transfer(transactionParams);\n\n    const operation = await Tezos.wallet\n      .transfer({\n        ...transactionParams,\n        ...estimate,\n      })\n      .send();\n\n    console.log(`Waiting for ${operation.opHash} to be confirmed...`);\n\n    await operation.confirmation(2);\n\n    console.log(\n      `Operation injected: https://ghost.tzstats.com/${operation.opHash}`\n    );\n\n    await getWalletBalance(address);\n    withdrawButtonActive = true;\n    withdrawButtonLabel = "Withdraw";\n  };\n<\/script>\n\n<main>\n  <h1>Tezos bank dApp</h1>\n\n  <div class="card">\n    {#if wallet}\n      <p>The address of the connected wallet is {address}.</p>\n      <p>Its balance in tez is {balance}.</p>\n      <p>\n        To get tez, go to <a\n          href="https://faucet.ghostnet.teztnets.com/"\n          target="_blank"\n        >\n          https://faucet.ghostnet.teztnets.com/\n        </a>.\n      </p>\n      <p>\n        Deposit tez:\n        <input type="number" bind:value={depositAmount} min="1" max="100" />\n        <input type="range" bind:value={depositAmount} min="1" max="100" />\n        <button on:click={deposit} disabled={!depositButtonActive}>\n          {depositButtonLabel}\n        </button>\n      </p>\n      <p>\n        Withdraw tez:\n        <button on:click={withdraw} disabled={!withdrawButtonActive}>\n          {withdrawButtonLabel}\n        </button>\n      </p>\n      <p>\n        <button on:click={disconnectWallet}> Disconnect wallet </button>\n      </p>\n    {:else}\n      <button on:click={connectWallet}> Connect wallet </button>\n    {/if}\n  </div>\n</main>\n\n<style>\n</style>\n'})})]})}function h(t={}){const{wrapper:n}={...(0,i.R)(),...t.components};return n?(0,s.jsx)(n,{...t,children:(0,s.jsx)(d,{...t})}):d(t)}},9075:(t,n,e)=>{e.d(n,{A:()=>a});const a=e.p+"assets/images/bank-app-deposit-transaction-c6229cee0facfa529992b79272f1b4f6.png"},37540:(t,n,e)=>{e.d(n,{A:()=>a});const a=e.p+"assets/images/bank-app-deposit-05c679df9b1df46b902c47b7be920999.png"},28453:(t,n,e)=>{e.d(n,{R:()=>o,x:()=>r});var a=e(96540);const s={},i=a.createContext(s);function o(t){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof t?t(n):{...n,...t}}),[n,t])}function r(t){let n;return n=t.disableParentContext?"function"==typeof t.components?t.components(s):t.components||s:o(t.components),a.createElement(i.Provider,{value:n},t.children)}}}]);