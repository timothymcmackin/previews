"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4616],{171:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"smart-contracts/serialization","title":"Serialization","description":"Between contract calls, the code of a contract, as well as its storage, are stored as a serialized sequence of bytes, for efficiency purposes.","source":"@site/docs/smart-contracts/serialization.md","sourceDirName":"smart-contracts","slug":"/smart-contracts/serialization","permalink":"/previews/docs/biel-custom-location/smart-contracts/serialization","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1713326400000,"frontMatter":{"title":"Serialization","authors":"Mathias Hiron (Nomadic Labs), Sasha Aldrick (TriliTech), Tim McMackin (TriliTech)","last_update":{"date":"17 April 2024"}},"sidebar":"documentationSidebar","previous":{"title":"Global table of constants","permalink":"/previews/docs/biel-custom-location/smart-contracts/constants"},"next":{"title":"Private transactions (Sapling)","permalink":"/previews/docs/biel-custom-location/smart-contracts/sapling"}}');var i=t(74848),s=t(28453);const o={title:"Serialization",authors:"Mathias Hiron (Nomadic Labs), Sasha Aldrick (TriliTech), Tim McMackin (TriliTech)",last_update:{date:"17 April 2024"}},r=void 0,c={},l=[{value:"PACK and UNPACK",id:"pack-and-unpack",level:2},{value:"Formatting",id:"formatting",level:2},{value:"Implementation details",id:"implementation-details",level:2}];function d(e){const a={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.p,{children:"Between contract calls, the code of a contract, as well as its storage, are stored as a serialized sequence of bytes, for efficiency purposes.\nEvery time the contract is called, the serialized code and storage are deserialized, unless the deserialized version is still cached.\nSimilarly, after the execution of the contract, the storage needs to be serialized to be stored again as a sequence of bytes."}),"\n",(0,i.jsx)(a.p,{children:"This takes CPU time, which means that when you call an entrypoint, on top of paying for the gas for the execution of the code of the entrypoint itself, you also need to pay for this serialization/deserialization.\nThe cost to call a very simple entrypoint may get large if there is a lot of data in its storage."}),"\n",(0,i.jsxs)(a.p,{children:["Remember that unlike the rest of the storage, ",(0,i.jsx)(a.code,{children:"big-maps"})," are not entirely serialized/deserialized for each call.\nInstead, only the values that are read are deserialized, and only the values that are added or updated are serialized.\nThis makes using ",(0,i.jsx)(a.code,{children:"big-maps"})," more efficient in these cases."]}),"\n",(0,i.jsx)(a.h2,{id:"pack-and-unpack",children:"PACK and UNPACK"}),"\n",(0,i.jsx)(a.p,{children:"Tezos provides the ability to serialize and deserialize data or code yourself:"}),"\n",(0,i.jsxs)(a.ul,{children:["\n",(0,i.jsxs)(a.li,{children:["The ",(0,i.jsx)(a.code,{children:"PACK"})," instruction takes a value of (almost) any type, and serializes it into a ",(0,i.jsx)(a.code,{children:"bytes"})," value."]}),"\n",(0,i.jsxs)(a.li,{children:["The ",(0,i.jsx)(a.code,{children:"UNPACK"})," instruction takes a ",(0,i.jsx)(a.code,{children:"bytes"})," value, and deserializes it into its original value.\nAs the deserialization may be impossible if the sequence of bytes doesn't represent valid serialized data, it returns an option type."]}),"\n"]}),"\n",(0,i.jsxs)(a.p,{children:["Serializing your own data in this way may be useful if you want to apply operations that are only available on ",(0,i.jsx)(a.code,{children:"bytes"})," values.\nFor example, you may want to compute the hash of some data.\nYou can do so by packing it first and then applying a hash function such as ",(0,i.jsx)(a.code,{children:"BLAKE2B"})," on the resulting ",(0,i.jsx)(a.code,{children:"bytes"})," value."]}),"\n",(0,i.jsx)(a.h2,{id:"formatting",children:"Formatting"}),"\n",(0,i.jsxs)(a.p,{children:["The Tezos ",(0,i.jsx)(a.code,{children:"PACK"})," instruction prepends this metadata to the serialized value:"]}),"\n",(0,i.jsxs)(a.ol,{children:["\n",(0,i.jsxs)(a.li,{children:["One byte to indicate the data format, usually ",(0,i.jsx)(a.code,{children:"05"})," to indicate a Micheline value."]}),"\n",(0,i.jsx)(a.li,{children:"One byte to indicate the data type, such as string, int, nat, or address."}),"\n",(0,i.jsx)(a.li,{children:"Four bytes to indicate the length of the data in bytes."}),"\n"]}),"\n",(0,i.jsx)(a.p,{children:"The rest of the serialized value is the original value converted to hexadecimal."}),"\n",(0,i.jsxs)(a.p,{children:["This metadata allows Tezos to compress data such as addresses into fewer bytes than ordinary byte-encoded strings.\nFor example, if you pack the address ",(0,i.jsx)(a.code,{children:"tz1QCVQinE8iVj1H2fckqx6oiM85CNJSK9Sx"}),", the resulting bytes are ",(0,i.jsx)(a.code,{children:"0x050a00000016000032041dca76bac940b478aae673e362bd15847ed8"}),", but if you pack the string value ",(0,i.jsx)(a.code,{children:"tz1QCVQinE8iVj1H2fckqx6oiM85CNJSK9Sx"}),", the resulting bytes are longer: ",(0,i.jsx)(a.code,{children:"0x050100000024747a3151435651696e453869566a31483266636b7178366f694d3835434e4a534b395378"}),"."]}),"\n",(0,i.jsx)(a.p,{children:"Because of this metadata, you can't use other byte serialization functions to pack and unpack data on Tezos.\nMany Tezos tools include functions to pack and unpack data, including LIGO, SmartPy, and the Octez client."}),"\n",(0,i.jsxs)(a.p,{children:["For example, to pack the address ",(0,i.jsx)(a.code,{children:"tz1QCVQinE8iVj1H2fckqx6oiM85CNJSK9Sx"})," with the Octez-client, run this command:"]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:'octez-client hash data \'"tz1QCVQinE8iVj1H2fckqx6oiM85CNJSK9Sx"\' of type "address"\n'})}),"\n",(0,i.jsxs)(a.p,{children:["To unpack the resulting bytes, use the ",(0,i.jsx)(a.code,{children:"unpack michelson data"})," command to remove the metadata and then the ",(0,i.jsx)(a.code,{children:"normalize data"})," command to get the original value, as in this example:"]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:'BYTES=$(octez-client unpack michelson data "0x050a00000016000032041dca76bac940b478aae673e362bd15847ed8")\noctez-client normalize data "$BYTES" of type "address"\n'})}),"\n",(0,i.jsxs)(a.p,{children:["For more information about the format that Tezos uses to pack and unpack data, install the ",(0,i.jsx)(a.code,{children:"octez-codec"})," program and run this command:"]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-bash",children:"octez-codec describe alpha.script.expr binary schema\n"})}),"\n",(0,i.jsx)(a.h2,{id:"implementation-details",children:"Implementation details"}),"\n",(0,i.jsxs)(a.ul,{children:["\n",(0,i.jsxs)(a.li,{children:["LIGO: ",(0,i.jsx)(a.a,{href:"https://ligolang.org/docs/next/data-types/bytes#packing-and-unpacking",children:"Pack and Unpack"})]}),"\n",(0,i.jsxs)(a.li,{children:["SmartPy: ",(0,i.jsx)(a.a,{href:"https://smartpy.io/manual/data-types/strings-and-bytes#packing-and-unpacking",children:"Packing and Unpacking"})]}),"\n",(0,i.jsxs)(a.li,{children:["Archetype: ",(0,i.jsx)(a.a,{href:"https://archetype-lang.org/docs/reference/expressions/builtins#pack%28o%20:%20T%29",children:"pack"}),", ",(0,i.jsx)(a.a,{href:"https://archetype-lang.org/docs/reference/expressions/builtins#unpack%3CT%3E%28b%20:%20bytes%29",children:"unpack"})]}),"\n"]})]})}function h(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,i.jsx)(a,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,a,t)=>{t.d(a,{R:()=>o,x:()=>r});var n=t(96540);const i={},s=n.createContext(i);function o(e){const a=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function r(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(s.Provider,{value:a},e.children)}}}]);